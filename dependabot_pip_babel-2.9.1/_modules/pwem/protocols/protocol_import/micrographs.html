

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pwem.protocols.protocol_import.micrographs &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../pwem.html">pwem</a> &raquo;</li>
        
      <li>pwem.protocols.protocol_import.micrographs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pwem.protocols.protocol_import.micrographs</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (jmdelarosa@cnb.csic.es) [1]</span>
<span class="c1"># *              Kevin Savage (kevin.savage@diamond.ac.uk) [2]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># * [2] Diamond Light Source, Ltd</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>

<span class="kn">from</span> <span class="nn">pwem</span> <span class="kn">import</span> <span class="n">Domain</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="kn">import</span> <span class="n">ImageHandler</span>
<span class="kn">import</span> <span class="nn">pwem.constants</span> <span class="k">as</span> <span class="nn">emcts</span>

<span class="kn">from</span> <span class="nn">.images</span> <span class="kn">import</span> <span class="n">ProtImportImages</span>
<span class="kn">from</span> <span class="nn">...objects</span> <span class="kn">import</span> <span class="n">SetOfMicrographs</span><span class="p">,</span> <span class="n">SetOfMovies</span>


<div class="viewcode-block" id="ProtImportMicBase"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase">[docs]</a><span class="k">class</span> <span class="nc">ProtImportMicBase</span><span class="p">(</span><span class="n">ProtImportImages</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Just to have a base class to both </span>
<span class="sd">    ProtImportMicrographs and ProtImportMovies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_checkStacks</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_defineAcquisitionParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">ProtImportImages</span><span class="o">.</span><span class="n">_defineAcquisitionParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;samplingRateMode&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span>
                       <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_SAMP_MODE_1</span><span class="p">,</span>
                                <span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_SAMP_MODE_2</span><span class="p">],</span>
                       <span class="n">default</span><span class="o">=</span><span class="n">emcts</span><span class="o">.</span><span class="n">SAMPLING_FROM_IMAGE</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_SAMP_MODE</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">TEXT_SAMP_MODE</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;samplingRate&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;samplingRateMode==</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emcts</span><span class="o">.</span><span class="n">SAMPLING_FROM_IMAGE</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_SAMP_RATE</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">TEXT_SAMP_RATE</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;scannedPixelSize&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
                       <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;samplingRateMode==</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emcts</span><span class="o">.</span><span class="n">SAMPLING_FROM_SCANNER</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_SCANNED</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group</span>

    <span class="k">def</span> <span class="nf">_defineBlacklistParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Options to blacklist certain items when launching the</span>
<span class="sd">        import protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rejection&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;blacklistSet&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getBlacklistSetClass</span><span class="p">(),</span>
                      <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reject from Set&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Files on this set will not be imported&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;blacklistDateFrom&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reject from&quot;</span><span class="p">,</span>
                      <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Files acquired after this date will not be imported. &quot;</span>
                           <span class="s2">&quot;Must follow format: YYYY-mm-dd HH:MM:SS </span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;e.g: 2019-01-14 14:18:05&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;blacklistDateTo&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reject before&quot;</span><span class="p">,</span>
                      <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Files acquired before this date will not be imported. &quot;</span>
                           <span class="s2">&quot;Must follow format: YYYY-mm-dd HH:MM:SS </span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;e.g: 2019-01-14 14:18:05&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useRegexps&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rejection file has RegExps&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose Yes if the rejection file contains regular expressions. Set to No if &quot;</span>
                           <span class="s2">&quot;the rejection file contains file names. Ignore if not using a rejection file&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;blacklistFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Blacklist File&quot;</span><span class="p">,</span>
                      <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Reject everything included in this file. If Use RegExps is True,&quot;</span>
                           <span class="s2">&quot;lines will be interpreted as regular expressions. E.g: </span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;(.*)GRID_0[1-5](.*)</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;(.*)/GRID_10/Falcon_2019_01_14-16_(.*)</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;If Use RegExps is False, lines will be interpreted as file names. E.g.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;/path/to/GRID_10/Falcon_2019_01_14-16_51_20_0_movie.mrcs</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;/path/to/GRID_10/Falcon_2019_01_14-16_55_40_0_movie.mrcs&quot;</span>
                      <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getBlacklistSetClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the class to be blacklisted by this protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;SetOfImages&quot;</span>

    <span class="k">def</span> <span class="nf">_validateBlacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">blacklistBySet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistSet</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">blacklistBySet</span> <span class="ow">and</span> <span class="n">blacklistBySet</span><span class="o">.</span><span class="n">isStreamOpen</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Can&#39;t blacklist an open set. &quot;</span>
                          <span class="s2">&quot;Please stop streaming or  wait until streaming is done to blacklist this set.&quot;</span><span class="p">)</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">blacklistDateFrom</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistDateTo</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
        <span class="n">parsedDates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsedDates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Bad date formatting in blacklist date </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsedDates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">parsedDates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">parsedDates</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Wrong blacklist dates: date from must be earlier than date to&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">ProtImportImages</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateBlacklist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">errors</span>

<div class="viewcode-block" id="ProtImportMicBase.setSamplingRate"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase.setSamplingRate">[docs]</a>    <span class="k">def</span> <span class="nf">setSamplingRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micSet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the sampling rate to the given set. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateMode</span> <span class="o">==</span> <span class="n">emcts</span><span class="o">.</span><span class="n">SAMPLING_FROM_IMAGE</span><span class="p">:</span>
            <span class="n">micSet</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingRate</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">micSet</span><span class="o">.</span><span class="n">setScannedPixelSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scannedPixelSize</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_acquisitionWizardCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; By default this wizard will appears only when we import from</span>
<span class="sd">        a format that is not from files.</span>
<span class="sd">        But movie-import also can have a wizard to read from FEI xml files. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;True&#39;</span>

<div class="viewcode-block" id="ProtImportMicBase.loadAcquisitionInfo"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase.loadAcquisitionInfo">[docs]</a>    <span class="k">def</span> <span class="nf">loadAcquisitionInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a proper acquisitionInfo (dict)</span>
<span class="sd">        or an error message (str).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_FILES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ProtImportImages</span><span class="o">.</span><span class="n">loadAcquisitionInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Could not find acquisition information&quot;</span>

        <span class="k">for</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">fileId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterFiles</span><span class="p">():</span>
            <span class="n">baseName</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeExt</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">xml1</span> <span class="o">=</span> <span class="n">baseName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_frames&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml1</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseXML</span><span class="p">(</span><span class="n">xml1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xml2</span> <span class="o">=</span> <span class="n">baseName</span> <span class="o">+</span> <span class="s1">&#39;.xml&#39;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseXML</span><span class="p">(</span><span class="n">xml2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">_parseXML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse micrograph XML files from FEI. &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

        <span class="c1"># get context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span>
                                    <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)))</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AccelerationVoltage&#39;</span><span class="p">:</span> <span class="s1">&#39;voltage&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;InstrumentModel&#39;</span><span class="p">:</span> <span class="s1">&#39;InstrumentModel&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;NominalMagnification&#39;</span><span class="p">:</span> <span class="s1">&#39;magnification&#39;</span><span class="p">}</span>

        <span class="c1"># acq[&#39;amplitudeContrast&#39;] = None</span>
        <span class="c1"># acq[&#39;sphericalAberration&#39;] = None</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
            <span class="n">acq</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span>

        <span class="n">pixelSize</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;pixelSize&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;started: pixelSize&quot;</span><span class="p">)</span>
                    <span class="n">pixelSize</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;}</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
                        <span class="n">get</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;}numericValue&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">and</span> <span class="n">pixelSize</span><span class="p">:</span>
                    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;samplingRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10e+09</span>  <span class="c1"># Convert to A</span>
                    <span class="n">pixelSize</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown event type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="p">)</span>

        <span class="c1"># Correct for units conversion</span>
        <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.</span>

        <span class="k">return</span> <span class="n">acq</span>

<div class="viewcode-block" id="ProtImportMicBase.getItemsToBlacklistFromFile"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase.getItemsToBlacklistFromFile">[docs]</a>    <span class="k">def</span> <span class="nf">getItemsToBlacklistFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_fileItemsToBlacklist&#39;</span><span class="p">):</span>
            <span class="n">blacklistfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistFile</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">blacklistItems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">blacklistfile</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blacklistfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">blacklistedItem</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">blacklistedItem</span> <span class="o">=</span> <span class="n">blacklistedItem</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">blacklistItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blacklistedItem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fileItemsToBlacklist</span> <span class="o">=</span> <span class="n">blacklistItems</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileItemsToBlacklist</span></div>

<div class="viewcode-block" id="ProtImportMicBase.getBlacklistedItems"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase.getBlacklistedItems">[docs]</a>    <span class="k">def</span> <span class="nf">getBlacklistedItems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_blacklistedItems&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blacklistedItems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blacklistedItems</span></div>

<div class="viewcode-block" id="ProtImportMicBase.isBlacklisted"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicBase.isBlacklisted">[docs]</a>    <span class="k">def</span> <span class="nf">isBlacklisted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="c1"># check if already blacklisted</span>
        <span class="n">blacklistedItems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlacklistedItems</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">blacklistedItems</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Blacklisted by set</span>
        <span class="n">blacklistSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistSet</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">blacklistSet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">blacklistSet</span><span class="p">:</span>
                <span class="n">blacklistFileName</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">blacklistFileName</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="n">fileName</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">blacklistFileName</span><span class="p">))</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getUniqueFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">blacklistFileName</span><span class="p">))):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> is blacklisted by the input set&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                    <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Blacklisted by date</span>
        <span class="n">blacklistDateFrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistDateFrom</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">blacklistDateTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklistDateTo</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">doDateBlacklist</span> <span class="o">=</span> <span class="n">blacklistDateFrom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">blacklistDateTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">doDateBlacklist</span><span class="p">:</span>
            <span class="n">fileDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">blacklistDateFrom</span><span class="p">:</span>
                <span class="n">parsedDateFrom</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">blacklistDateFrom</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">blacklistDateTo</span><span class="p">:</span>
                    <span class="n">parsedDateTo</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">blacklistDateTo</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parsedDateFrom</span> <span class="o">&lt;=</span> <span class="n">fileDate</span> <span class="o">&lt;=</span> <span class="n">parsedDateTo</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> is blacklisted by date&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                        <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parsedDateFrom</span> <span class="o">&lt;=</span> <span class="n">fileDate</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> is blacklisted by date&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                        <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">blacklistDateTo</span><span class="p">:</span>
                <span class="n">parsedDateTo</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">blacklistDateTo</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fileDate</span> <span class="o">&lt;=</span> <span class="n">parsedDateTo</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> is blacklisted by date&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                    <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Blacklisted by file</span>
        <span class="n">items2blacklist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getItemsToBlacklistFromFile</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item2blacklist</span> <span class="ow">in</span> <span class="n">items2blacklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useRegexps</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item2blacklist</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> matched blacklist regexp </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">item2blacklist</span><span class="p">))</span>
                    <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">item2blacklist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blacklist warning: </span><span class="si">%s</span><span class="s2"> is blacklisted &quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="n">blacklistedItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>

<div class="viewcode-block" id="ImportMicsOutput"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ImportMicsOutput">[docs]</a><span class="k">class</span> <span class="nc">ImportMicsOutput</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">outputMicrographs</span> <span class="o">=</span> <span class="n">SetOfMicrographs</span></div>

<div class="viewcode-block" id="ProtImportMicrographs"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicrographs">[docs]</a><span class="k">class</span> <span class="nc">ProtImportMicrographs</span><span class="p">(</span><span class="n">ProtImportMicBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Protocol to import a set of micrographs to the project&quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;import micrographs&#39;</span>
    <span class="n">_possibleOutputs</span> <span class="o">=</span> <span class="n">ImportMicsOutput</span>
    <span class="n">_outputClassName</span> <span class="o">=</span> <span class="n">ImportMicsOutput</span><span class="o">.</span><span class="n">outputMicrographs</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">IMPORT_FROM_EMX</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IMPORT_FROM_XMIPP3</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">IMPORT_FROM_SCIPION</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">_getImportChoices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of possible choices</span>
<span class="sd">        from which the import can be done.</span>
<span class="sd">        (usually packages formats such as: xmipp3, eman2, relion...etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">ProtImportImages</span><span class="o">.</span><span class="n">_getImportChoices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">choices</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;emx&#39;</span><span class="p">,</span> <span class="s1">&#39;xmipp3&#39;</span><span class="p">,</span> <span class="s1">&#39;scipion&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_getBlacklistSetClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the class to be blacklisted by this protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;SetOfMicrographs&quot;</span>

    <span class="k">def</span> <span class="nf">_defineImportParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Just redefine to put some import parameters</span>
<span class="sd">        before the acquisition related parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;emxFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;(importFrom == </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_EMX</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input EMX file&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the EMX file containing micrographs information.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;See more about [[http://i2pc.cnb.csic.es/emx][EMX format]]&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;mdFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;(importFrom == </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_XMIPP3</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Micrographs metadata file&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the micrographs Xmipp metadata file.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;It is usually a _micrograph.xmd_ file result</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;from import, preprocess or downsample protocols.&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;sqliteFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;(importFrom == </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_SCIPION</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Micrographs sqlite file&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the micrographs sqlite file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------- INSERT functions ----------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">importFrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImportClass</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;importMicrographsStep&#39;</span><span class="p">,</span> <span class="n">importFrom</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span><span class="p">)</span>

    <span class="c1"># --------------------------- STEPS functions -----------------------------</span>
<div class="viewcode-block" id="ProtImportMicrographs.importMicrographsStep"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicrographs.importMicrographsStep">[docs]</a>    <span class="k">def</span> <span class="nf">importMicrographsStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importFrom</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImportClass</span><span class="p">()</span>
        <span class="n">ci</span><span class="o">.</span><span class="n">importMicrographs</span><span class="p">()</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;Import from *</span><span class="si">%s</span><span class="s2">* file:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnumText</span><span class="p">(</span><span class="s1">&#39;importFrom&#39;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;outputParticles&#39;</span><span class="p">):</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParticles</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;   Particles: *</span><span class="si">%d</span><span class="s1">* (ctf=</span><span class="si">%s</span><span class="s1">, alignment=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">getSize</span><span class="p">(),</span>
                                                                        <span class="n">particles</span><span class="o">.</span><span class="n">hasCTF</span><span class="p">(),</span>
                                                                        <span class="n">particles</span><span class="o">.</span><span class="n">getAlignment</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;outputCoordinates&#39;</span><span class="p">):</span>  <span class="c1"># EMX files can contain only Coordinates information</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;   Coordinates: *</span><span class="si">%d</span><span class="s1">* </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputCoordinates</span><span class="o">.</span><span class="n">getSize</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;outputMicrographs&#39;</span><span class="p">):</span>  <span class="c1"># EMX files can contain only Coordinates information</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;   Micrographs: *</span><span class="si">%d</span><span class="s1">* </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputMicrographs</span><span class="o">.</span><span class="n">getSize</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyFiles</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">_WARNING_: Binary files copied into project &#39;</span>
                        <span class="s1">&#39;(extra disk space)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span></div>

    <span class="c1"># --------------------------- INFO functions ------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImportClass</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">micFn</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterFiles</span><span class="p">():</span>
                <span class="n">imgh</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">imgh</span><span class="o">.</span><span class="n">isImageFile</span><span class="p">(</span><span class="n">micFn</span><span class="p">):</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">imgh</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">(</span><span class="n">micFn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The protocol not support micrographs &quot;</span>
                                      <span class="s2">&quot;stored in stacks. If you want to &quot;</span>
                                      <span class="s2">&quot;obtain your micrographs individually, &quot;</span>
                                      <span class="s2">&quot;you can run the following command:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                      <span class="s2">&quot;scipion run scipion_directory/scripts/&quot;</span>
                                      <span class="s2">&quot;split_stacks.py --files *your files* &quot;</span>
                                      <span class="s2">&quot;--ext *extension*&quot;</span><span class="p">)</span>
                <span class="c1"># JMRT: only check the first image, for large dataset</span>
                <span class="c1"># even reading the header can take a while</span>
                <span class="k">break</span>
            <span class="k">return</span> <span class="n">errors</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ci</span><span class="o">.</span><span class="n">validateMicrographs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_FILES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;No summary information.&#39;</span><span class="p">)]</span>

    <span class="c1"># --------------------------- UTILS functions -----------------------------</span>
<div class="viewcode-block" id="ProtImportMicrographs.getImportClass"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMicrographs.getImportClass">[docs]</a>    <span class="k">def</span> <span class="nf">getImportClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the class in charge of importing the files. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_EMX</span><span class="p">:</span>
            <span class="n">EmxImport</span> <span class="o">=</span> <span class="n">Domain</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;emxlib.convert&#39;</span><span class="p">,</span> <span class="s1">&#39;EmxImport&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emxFile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">EmxImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_XMIPP3</span><span class="p">:</span>
            <span class="n">XmippImport</span> <span class="o">=</span> <span class="n">Domain</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;xmipp3.convert&#39;</span><span class="p">,</span> <span class="s1">&#39;XmippImport&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdFile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">XmippImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdFile</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFrom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPORT_FROM_SCIPION</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.dataimport</span> <span class="kn">import</span> <span class="n">ScipionImport</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqliteFile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ScipionImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importFilePath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="ImportMoviesOutput"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ImportMoviesOutput">[docs]</a><span class="k">class</span> <span class="nc">ImportMoviesOutput</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">outputMovies</span> <span class="o">=</span> <span class="n">SetOfMovies</span></div>

<div class="viewcode-block" id="ProtImportMovies"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMovies">[docs]</a><span class="k">class</span> <span class="nc">ProtImportMovies</span><span class="p">(</span><span class="n">ProtImportMicBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Protocol to import a set of movies (from direct detector cameras)</span>
<span class="sd">    to the project.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;import movies&#39;</span>
    <span class="n">_possibleOutputs</span> <span class="o">=</span> <span class="n">ImportMoviesOutput</span>
    <span class="n">_outputClassName</span> <span class="o">=</span> <span class="n">ImportMoviesOutput</span><span class="o">.</span><span class="n">outputMovies</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSocket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectionList</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_getBlacklistSetClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the class to be blacklisted by this protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;SetOfMovies&quot;</span>

    <span class="k">def</span> <span class="nf">_defineAcquisitionParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_defineAcquisitionParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Dose (e/A^2)&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial accumulated dose (usually 0) and &quot;</span>
                                  <span class="s2">&quot;dose per frame. &quot;</span><span class="p">)</span>

        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doseInitial&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial&#39;</span><span class="p">)</span>

        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;dosePerFrame&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Per frame&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;gainFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gain image&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A gain reference related to a set of movies&#39;</span>
                           <span class="s1">&#39; for gain correction&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;darkFile&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Dark image&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A dark image related to a set of movies&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="s1">&#39;Frames&#39;</span><span class="p">)</span>

        <span class="n">streamingConditioned</span> <span class="o">=</span> <span class="s2">&quot;dataStreaming&quot;</span>
        <span class="n">framesCondition</span> <span class="o">=</span> <span class="s2">&quot;inputIndividualFrames&quot;</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputIndividualFrames&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input individual frames?&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select Yes if movies are acquired in individual &quot;</span>
                           <span class="s2">&quot;frame files. &quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfIndividualFrames&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="n">framesCondition</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of frames&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Provide how many frames are per movie. &#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;stackFrames&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">framesCondition</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Create movie stacks?&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select Yes if you want to create a new stack for &quot;</span>
                           <span class="s2">&quot;each movies with its frames. &quot;</span><span class="p">)</span>
        <span class="c1"># This is not working so for now its hidden</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;writeMoviesInProject&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="n">framesCondition</span> <span class="o">+</span> <span class="s2">&quot; and stackFrames&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Write stacks in the project folder?&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If Yes, the created stack files will be written &quot;</span>
                           <span class="s2">&quot;in the project folder. By default the movies will &quot;</span>
                           <span class="s2">&quot;be written in the same place where input frames &quot;</span>
                           <span class="s2">&quot;are.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;movieSuffix&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;_frames.mrcs&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="n">framesCondition</span> <span class="o">+</span> <span class="s2">&quot; and stackFrames&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Movie suffix&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Suffix added to the output movie filename.&quot;</span>
                           <span class="s2">&quot;Use the extension to select the format (&quot;</span>
                           <span class="s2">&quot;e.g., .mrcs, .stk)&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;deleteFrames&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="n">framesCondition</span> <span class="o">+</span> <span class="s2">&quot; and stackFrames&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Delete frame files?&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select Yes if you want to remove the individual &quot;</span>
                           <span class="s2">&quot;frame files after creating the movie stack. &quot;</span><span class="p">)</span>

        <span class="n">streamingSection</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getSection</span><span class="p">(</span><span class="s1">&#39;Streaming&#39;</span><span class="p">)</span>
        <span class="n">streamingSection</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;moviesToExclude&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                                  <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfMovies&#39;</span><span class="p">,</span>
                                  <span class="n">condition</span><span class="o">=</span><span class="n">streamingConditioned</span><span class="p">,</span>
                                  <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                                  <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Previous movies to exclude&quot;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select a setOfMovies that are already &quot;</span>
                                       <span class="s2">&quot;imported that you want to exclude for &quot;</span>
                                       <span class="s2">&quot;this import.&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------- INSERT functions ----------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Only the import movies has property &#39;inputIndividualFrames&#39;</span>
        <span class="c1"># so let&#39;s query in a non-intrusive manner</span>
        <span class="n">inputIndividualFrames</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;inputIndividualFrames&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataStreaming</span> <span class="ow">or</span> <span class="n">inputIndividualFrames</span><span class="p">:</span>
            <span class="n">funcName</span> <span class="o">=</span> <span class="s1">&#39;importImagesStreamStep&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcName</span> <span class="o">=</span> <span class="s1">&#39;importImagesStep&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="n">funcName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPattern</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">sphericalAberration</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">amplitudeContrast</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">magnification</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="c1"># --------------------------- INFO functions -------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overwriting to skip file validation if streaming with socket&quot;&quot;&quot;</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputIndividualFrames</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackFrames</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Scipion does not support individual frames. &quot;</span>
                          <span class="s2">&quot;You must set to Yes *Create movie stacks?* &quot;</span>
                          <span class="s2">&quot;parameter.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gainFile</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gainFile</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Gain file not found in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gainFile</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">darkFile</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darkFile</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Dark file not found in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gainFile</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">errors</span>

    <span class="c1"># --------------------------- UTILS functions ------------------------------</span>
<div class="viewcode-block" id="ProtImportMovies.setSamplingRate"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMovies.setSamplingRate">[docs]</a>    <span class="k">def</span> <span class="nf">setSamplingRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movieSet</span><span class="p">):</span>
        <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movieSet</span><span class="p">)</span>
        <span class="n">movieSet</span><span class="o">.</span><span class="n">setGain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gainFile</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">movieSet</span><span class="o">.</span><span class="n">setDark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">darkFile</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">movieSet</span><span class="o">.</span><span class="n">getAcquisition</span><span class="p">()</span>
        <span class="n">acq</span><span class="o">.</span><span class="n">setDoseInitial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doseInitial</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">acq</span><span class="o">.</span><span class="n">setDosePerFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dosePerFrame</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_setupFirstImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">imgSet</span><span class="p">):</span>
        <span class="c1"># Create a movie object to read dimensions</span>
        <span class="n">dimMovie</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">movieFn</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">nExt</span><span class="p">):</span>
            <span class="n">movieFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTmpPath</span><span class="p">()</span>
            <span class="n">movieName</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
            <span class="n">movieTmpLink</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">movieFolder</span><span class="p">,</span> <span class="n">movieName</span><span class="p">)</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">movieTmpLink</span><span class="p">)</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">createAbsLink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">movieFn</span><span class="p">),</span> <span class="n">movieTmpLink</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span> <span class="o">%</span> <span class="n">movieName</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">movieFolder</span><span class="p">)</span>
            <span class="n">dimMovie</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">movieTmpLink</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">nExt</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">movieFn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;bz2&#39;</span><span class="p">):</span>
            <span class="n">decompress</span><span class="p">(</span><span class="s1">&#39;bzip2&#39;</span><span class="p">,</span> <span class="s1">&#39;-d -f </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">movieFn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tbz&#39;</span><span class="p">):</span>
            <span class="n">decompress</span><span class="p">(</span><span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;jxf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;.tbz&#39;</span><span class="p">,</span> <span class="s1">&#39;.mrc&#39;</span><span class="p">)</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="n">dimMovie</span><span class="o">.</span><span class="n">getDim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dim: (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">dim</span><span class="p">)))</span>
        <span class="nb">range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">movie</span><span class="o">.</span><span class="n">setFramesRange</span><span class="p">(</span><span class="nb">range</span><span class="p">)</span>
        <span class="n">imgSet</span><span class="o">.</span><span class="n">setDim</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">imgSet</span><span class="o">.</span><span class="n">setFramesRange</span><span class="p">(</span><span class="nb">range</span><span class="p">)</span>

<div class="viewcode-block" id="ProtImportMovies.iterNewInputFiles"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMovies.iterNewInputFiles">[docs]</a>    <span class="k">def</span> <span class="nf">iterNewInputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; In the case of importing movies, we want to override this method</span>
<span class="sd">        for the case when input are individual frames and we want to create</span>
<span class="sd">        movie stacks before importing.</span>
<span class="sd">        The frames pattern should contains a part delimited by $.</span>
<span class="sd">        The id expression with # is not supported for simplicity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputIndividualFrames</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackFrames</span><span class="p">):</span>
            <span class="c1"># In this case behave just as</span>
            <span class="n">iterInputFiles</span> <span class="o">=</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">iterNewInputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">uniqueFn</span><span class="p">,</span> <span class="n">fileId</span> <span class="ow">in</span> <span class="n">iterInputFiles</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">uniqueFn</span><span class="p">,</span> <span class="n">fileId</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataStreaming</span><span class="p">:</span>
            <span class="c1"># Consider only the files that are not changed in the fileTime</span>
            <span class="c1"># delta if processing data in streaming</span>
            <span class="n">fileTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fileTimeout</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">filePaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMatchFiles</span><span class="p">()</span>
                         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileModified</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fileTimeout</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filePaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMatchFiles</span><span class="p">()</span>

        <span class="n">frameRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(?P&lt;prefix&gt;.+[^\d]+)(?P&lt;frameid&gt;\d+)&quot;</span><span class="p">)</span>
        <span class="c1"># Group all frames for each movie</span>
        <span class="c1"># Key of the dictionary will be the common prefix and the value</span>
        <span class="c1"># will be a list with all frames in that movie</span>
        <span class="n">frameDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="p">:</span>
            <span class="n">fnNoExt</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeExt</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

            <span class="n">match</span> <span class="o">=</span> <span class="n">frameRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fnNoExt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect match of frame files pattern!&quot;</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
            <span class="n">frameid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;frameid&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frameDict</span><span class="p">:</span>
                <span class="n">frameDict</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">frameDict</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frameid</span><span class="p">,</span> <span class="n">fileName</span><span class="p">))</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">movieSuffix</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">movieFn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">createdStacks</span><span class="p">:</span>
            <span class="n">uniqueFn</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">movieFn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uniqueFn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">importedFiles</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">movieFn</span><span class="p">,</span> <span class="n">uniqueFn</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">checkMovie</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">frameDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">moviePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">movieFn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">moviePath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getUniqueFileName</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span>
                               <span class="n">suffix</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeMoviesInProject</span><span class="p">:</span>
                    <span class="n">movieFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">movieFn</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">movieFn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">importedFiles</span> <span class="ow">and</span>
                        <span class="n">movieFn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">createdStacks</span> <span class="ow">and</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIndividualFrames</span><span class="p">):</span>
                    <span class="n">movieOut</span> <span class="o">=</span> <span class="n">movieFn</span>

                    <span class="k">if</span> <span class="n">movieOut</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mrc&quot;</span><span class="p">):</span>
                        <span class="n">movieOut</span> <span class="o">+=</span> <span class="s2">&quot;:mrcs&quot;</span>

                    <span class="c1"># By default we will write the movie stacks</span>
                    <span class="c1"># unless we are in continue mode and the file exists</span>
                    <span class="n">writeMovie</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isContinued</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">movieFn</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping movie stack: </span><span class="si">%s</span><span class="s2">, seems to be done&quot;</span>
                                  <span class="o">%</span> <span class="n">movieFn</span><span class="p">)</span>
                        <span class="n">writeMovie</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">writeMovie</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing movie stack: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movieFn</span><span class="p">)</span>
                        <span class="c1"># Remove the output file if exists</span>
                        <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">movieFn</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                            <span class="n">frameFn</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Frame name stored previously</span>
                            <span class="n">ih</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">frameFn</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">movieOut</span><span class="p">))</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteFrames</span><span class="p">:</span>
                                <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">frameFn</span><span class="p">)</span>

                    <span class="c1"># Now return the newly created movie file as imported file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">createdStacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">movieFn</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="n">checkMovie</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtImportMovies.ignoreCopy"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMovies.ignoreCopy">[docs]</a>    <span class="k">def</span> <span class="nf">ignoreCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ProtImportMovies.getCopyOrLink"><a class="viewcode-back" href="../../../../api/pwem/pwem.protocols.protocol_import.micrographs.html#pwem.protocols.protocol_import.micrographs.ProtImportMovies.getCopyOrLink">[docs]</a>    <span class="k">def</span> <span class="nf">getCopyOrLink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputIndividualFrames</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackFrames</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeMoviesInProject</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreCopy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ProtImportMicBase</span><span class="o">.</span><span class="n">getCopyOrLink</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: dependabot/pip/babel-2.9.1
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="micrographs.html">dependabot/pip/babel-2.9.1</a></dd>
            <dd><a href="../../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
            <dd><a href="../../../../../tomo_picking_tutorial/index.html">tomo_picking_tutorial</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>