

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>eman2.convert.convert &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../eman2.html">eman2</a> &raquo;</li>
        
      <li>eman2.convert.convert</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for eman2.convert.convert</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se) [1]</span>
<span class="c1"># *              Laura del Cano (ldelcano@cnb.csic.es) [1]</span>
<span class="c1"># *              Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca) [1]</span>
<span class="c1"># *              Grigory Sharov (gsharov@mrc-lmb.cam.ac.uk) [2]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># * [2] MRC Laboratory of Molecular Biology (MRC-LMB)</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pwem.objects.data</span> <span class="kn">import</span> <span class="n">Coordinate</span><span class="p">,</span> <span class="n">Particle</span><span class="p">,</span> <span class="n">Transform</span>
<span class="kn">import</span> <span class="nn">pwem.constants</span> <span class="k">as</span> <span class="nn">emcts</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="kn">import</span> <span class="n">ImageHandler</span>
<span class="kn">import</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">as</span> <span class="nn">md</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">Plugin</span>


<div class="viewcode-block" id="loadJson"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.loadJson">[docs]</a><span class="k">def</span> <span class="nf">loadJson</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function loads the Json dictionary into memory &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
        <span class="n">jsonDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonDict</span></div>


<div class="viewcode-block" id="writeJson"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.writeJson">[docs]</a><span class="k">def</span> <span class="nf">writeJson</span><span class="p">(</span><span class="n">jsonDict</span><span class="p">,</span> <span class="n">jsonFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function write a Json dictionary &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jsonDict</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="readCTFModel"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.readCTFModel">[docs]</a><span class="k">def</span> <span class="nf">readCTFModel</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set values for the ctfModel.</span>
<span class="sd">    :param ctfModel: output CTF model</span>
<span class="sd">    :param filename: input file to parse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jsonDict</span> <span class="o">=</span> <span class="n">loadJson</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">keyPos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="s1">&#39;ctf_frame&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
        <span class="n">keyPos</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s1">&#39;ctf_frame&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;ctf&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
        <span class="n">keyPos</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s1">&#39;ctf&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">setWrongDefocus</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keyPos</span><span class="p">:</span>
        <span class="n">defocus</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;defocus&#39;</span><span class="p">])</span>
        <span class="n">defocusAngle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;dfang&#39;</span><span class="p">])</span>
        <span class="n">dfdiff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;dfdiff&#39;</span><span class="p">])</span>
        <span class="n">ampcont</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;ampcont&#39;</span><span class="p">])</span>
        <span class="n">defocusU</span> <span class="o">=</span> <span class="mf">10000.0</span> <span class="o">*</span> <span class="n">defocus</span> <span class="o">+</span> <span class="mf">5000.0</span> <span class="o">*</span> <span class="n">dfdiff</span>
        <span class="n">defocusV</span> <span class="o">=</span> <span class="mf">20000.0</span> <span class="o">*</span> <span class="n">defocus</span> <span class="o">-</span> <span class="n">defocusU</span>
        <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="n">calculatePhaseShift</span><span class="p">(</span><span class="n">ampcont</span><span class="p">)</span>

        <span class="n">ctfModel</span><span class="o">.</span><span class="n">setStandardDefocus</span><span class="p">(</span><span class="n">defocusU</span><span class="p">,</span> <span class="n">defocusV</span><span class="p">,</span> <span class="n">defocusAngle</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ctf_im2d&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
            <span class="c1"># psdFile = jsonDict[&#39;ctf_im2d&#39;][&#39;__image__&#39;][0]</span>
            <span class="n">fnBase</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeExt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_jsonimg&#39;</span>
            <span class="n">psdFile</span> <span class="o">=</span> <span class="s2">&quot;1@</span><span class="si">%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="n">fnBase</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psdFile</span><span class="p">):</span>
                <span class="n">ctfModel</span><span class="o">.</span><span class="n">setPsdFile</span><span class="p">(</span><span class="n">psdFile</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setPhaseShift</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctfPhaseShift</span><span class="p">))</span></div>


<div class="viewcode-block" id="setWrongDefocus"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.setWrongDefocus">[docs]</a><span class="k">def</span> <span class="nf">setWrongDefocus</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set parameters if results parsing has failed.</span>
<span class="sd">    :param ctfModel: the model to be updated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusU</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusAngle</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeCTFModel"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.writeCTFModel">[docs]</a><span class="k">def</span> <span class="nf">writeCTFModel</span><span class="p">(</span><span class="n">ctfObj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write a CTFModel object as Xmipp .ctfparam&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="jsonToCtfModel"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.jsonToCtfModel">[docs]</a><span class="k">def</span> <span class="nf">jsonToCtfModel</span><span class="p">(</span><span class="n">ctfJsonFn</span><span class="p">,</span> <span class="n">ctfModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a CTFModel from a json file &quot;&quot;&quot;</span>
    <span class="n">mdFn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctfJsonFn</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
    <span class="n">mdFn</span> <span class="o">=</span> <span class="n">mdFn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__ctf_flip&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_info.json&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mdFn</span><span class="p">):</span>
        <span class="n">readCTFModel</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">,</span> <span class="n">mdFn</span><span class="p">)</span></div>


<div class="viewcode-block" id="readSetOfCoordinates"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.readSetOfCoordinates">[docs]</a><span class="k">def</span> <span class="nf">readSetOfCoordinates</span><span class="p">(</span><span class="n">workDir</span><span class="p">,</span> <span class="n">micSet</span><span class="p">,</span> <span class="n">coordSet</span><span class="p">,</span> <span class="n">invertY</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read from Eman .json files.</span>
<span class="sd">    :param workDir: where the Eman boxer output files are located.</span>
<span class="sd">    :param micSet: the SetOfMicrographs to associate the .json, which</span>
<span class="sd">                   name should be the same of the micrographs.</span>
<span class="sd">    :param coordSet: the SetOfCoordinates that will be populated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read boxSize from info/project.json</span>
    <span class="n">jsonFnbase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workDir</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;project.json&#39;</span><span class="p">)</span>
    <span class="n">jsonBoxDict</span> <span class="o">=</span> <span class="n">loadJson</span><span class="p">(</span><span class="n">jsonFnbase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">jsonBoxDict</span><span class="p">[</span><span class="s2">&quot;global.boxsize&quot;</span><span class="p">])</span>
    <span class="n">jsonFninfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workDir</span><span class="p">,</span> <span class="s1">&#39;info/&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mic</span> <span class="ow">in</span> <span class="n">micSet</span><span class="p">:</span>
        <span class="n">micBase</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="n">micPosFn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">jsonFninfo</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">micBase</span> <span class="o">+</span> <span class="s1">&#39;_info.json&#39;</span><span class="p">))</span>
        <span class="n">readCoordinates</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">micPosFn</span><span class="p">,</span> <span class="n">coordSet</span><span class="p">,</span> <span class="n">invertY</span><span class="p">)</span>
    <span class="n">coordSet</span><span class="o">.</span><span class="n">setBoxSize</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="readCoordinates"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.readCoordinates">[docs]</a><span class="k">def</span> <span class="nf">readCoordinates</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">coordsSet</span><span class="p">,</span> <span class="n">invertY</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse coords file and populate coordsSet.</span>
<span class="sd">    :param mic: input micrograph object</span>
<span class="sd">    :param fileName: input file to parse</span>
<span class="sd">    :param coordsSet: output set of coords</span>
<span class="sd">    :param invertY: flip Y axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
        <span class="n">jsonPosDict</span> <span class="o">=</span> <span class="n">loadJson</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;boxes&quot;</span> <span class="ow">in</span> <span class="n">jsonPosDict</span><span class="p">:</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="n">jsonPosDict</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">box</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">invertY</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">mic</span><span class="o">.</span><span class="n">getYDim</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span>

                <span class="n">coord</span> <span class="o">=</span> <span class="n">Coordinate</span><span class="p">()</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">coord</span><span class="o">.</span><span class="n">setMicrograph</span><span class="p">(</span><span class="n">mic</span><span class="p">)</span>
                <span class="n">coordsSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeSetOfMicrographs"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.writeSetOfMicrographs">[docs]</a><span class="k">def</span> <span class="nf">writeSetOfMicrographs</span><span class="p">(</span><span class="n">micSet</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simplified function borrowed from xmipp. &quot;&quot;&quot;</span>
    <span class="n">mdata</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">micSet</span><span class="p">:</span>
        <span class="n">objId</span> <span class="o">=</span> <span class="n">mdata</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
        <span class="n">imgRow</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Row</span><span class="p">()</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ITEM_ID</span><span class="p">,</span> <span class="n">objId</span><span class="p">)</span>

        <span class="n">index</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getLocation</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="o">.</span><span class="n">locationToXmipp</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_MICROGRAPH</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">():</span>
            <span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enabled</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ENABLED</span><span class="p">,</span> <span class="n">enabled</span><span class="p">)</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">writeToMd</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">objId</span><span class="p">)</span>

    <span class="n">mdata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Micrographs@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="readSetOfParticles"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.readSetOfParticles">[docs]</a><span class="k">def</span> <span class="nf">readSetOfParticles</span><span class="p">(</span><span class="n">lstFile</span><span class="p">,</span> <span class="n">partSet</span><span class="p">,</span> <span class="n">copyOrLink</span><span class="p">,</span> <span class="n">direc</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">iterLstFile</span><span class="p">(</span><span class="n">lstFile</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">()</span>
        <span class="c1"># set full path to particles stack file</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">lstFile</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">abspath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sets/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lstFile</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fn</span>
        <span class="n">newFn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newFn</span><span class="p">):</span>
            <span class="n">copyOrLink</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>

        <span class="n">item</span><span class="o">.</span><span class="n">setLocation</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>
        <span class="n">partSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeSetOfParticles"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.writeSetOfParticles">[docs]</a><span class="k">def</span> <span class="nf">writeSetOfParticles</span><span class="p">(</span><span class="n">partSet</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert the imgSet particles to .hdf files as expected by Eman.</span>
<span class="sd">    This function should be called from a current dir where</span>
<span class="sd">    the images in the set are available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">getExt</span><span class="p">(</span><span class="n">partSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;hdf&#39;</span><span class="p">:</span>
        <span class="c1"># create links if input has hdf format</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getFiles</span><span class="p">():</span>
            <span class="n">newFn</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__ctf&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdf&#39;</span>
            <span class="n">newFn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">createLink</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">newFn</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">firstCoord</span> <span class="o">=</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getCoordinate</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">hasMicName</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">firstCoord</span><span class="p">:</span>
            <span class="n">hasMicName</span> <span class="o">=</span> <span class="n">firstCoord</span><span class="o">.</span><span class="n">getMicName</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">iterParticlesByMic</span><span class="p">(</span><span class="n">partSet</span><span class="p">):</span>
            <span class="n">micName</span> <span class="o">=</span> <span class="n">micId</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getMicId</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hasMicName</span><span class="p">:</span>
                <span class="n">micName</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">getCoordinate</span><span class="p">()</span><span class="o">.</span><span class="n">getMicName</span><span class="p">())</span>
            <span class="n">objDict</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">micId</span><span class="p">:</span>
                <span class="n">micId</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hasMicName</span> <span class="ow">and</span> <span class="p">(</span><span class="n">micName</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">micId</span><span class="p">)):</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">micName</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                <span class="s2">&quot;mic_</span><span class="si">%06d%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">micId</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>

            <span class="n">alignType</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alignType&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alignType</span> <span class="o">!=</span> <span class="n">emcts</span><span class="o">.</span><span class="n">ALIGN_NONE</span><span class="p">:</span>
                <span class="n">shift</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">alignmentToRow</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">getTransform</span><span class="p">(),</span> <span class="n">alignType</span><span class="p">)</span>
                <span class="c1"># json cannot encode arrays so I convert them to lists</span>
                <span class="c1"># json fail if has -0 as value</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_angles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_itemId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

            <span class="c1"># the index in EMAN begins with 0</span>
            <span class="k">if</span> <span class="n">fileName</span> <span class="o">!=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># TODO: Index appears to be the problem (when not given it works ok)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
            <span class="c1"># Write the e2converter.py process from where to read the image</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">objDict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>


<div class="viewcode-block" id="getImageDimensions"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.getImageDimensions">[docs]</a><span class="k">def</span> <span class="nf">getImageDimensions</span><span class="p">(</span><span class="n">imageFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function will allow us to use EMAN2 to read some formats</span>
<span class="sd">     not currently supported by the native image library (Xmipp).</span>
<span class="sd">     Underneath, it will call a script to do the job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="s1">&#39;e2ih.py&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">imageFile</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span></div>


<div class="viewcode-block" id="convertImage"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.convertImage">[docs]</a><span class="k">def</span> <span class="nf">convertImage</span><span class="p">(</span><span class="n">inputLoc</span><span class="p">,</span> <span class="n">outputLoc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function will allow us to use EMAN2 to write some formats</span>
<span class="sd">     not currently supported by the native image library (Xmipp).</span>
<span class="sd">     Underneath, it will call an script to do the job.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getFn</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use similar naming convention as in Xmipp.</span>
<span class="sd">        This does not works for EMAN out of here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">emcts</span><span class="o">.</span><span class="n">NO_INDEX</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%06d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">loc</span>
            <span class="k">return</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loc</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="s1">&#39;e2ih.py&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_getFn</span><span class="p">(</span><span class="n">inputLoc</span><span class="p">),</span>
                                                               <span class="n">_getFn</span><span class="p">(</span><span class="n">outputLoc</span><span class="p">)))</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="iterLstFile"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.iterLstFile">[docs]</a><span class="k">def</span> <span class="nf">iterLstFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># Decompose Eman filename</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">index</span><span class="p">,</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="geometryFromMatrix"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.geometryFromMatrix">[docs]</a><span class="k">def</span> <span class="nf">geometryFromMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert the transformation matrix to shifts and angles.</span>
<span class="sd">    :param matrix: input matrix</span>
<span class="sd">    :return: two lists, shifts and angles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pwem.convert.transformations</span> <span class="kn">import</span> <span class="n">translation_from_matrix</span><span class="p">,</span> <span class="n">euler_from_matrix</span>
    <span class="k">if</span> <span class="n">inverseTransform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">translation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">translation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">euler_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;szyz&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span></div>


<div class="viewcode-block" id="matrixFromGeometry"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.matrixFromGeometry">[docs]</a><span class="k">def</span> <span class="nf">matrixFromGeometry</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the transformation matrix from given</span>
<span class="sd">    2D shifts in X and Y and the 3 euler angles.</span>
<span class="sd">    :param shifts: input list of shifts</span>
<span class="sd">    :param angles: input list of angles</span>
<span class="sd">    :return matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pwem.convert.transformations</span> <span class="kn">import</span> <span class="n">euler_matrix</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">deg2rad</span>
    <span class="n">radAngles</span> <span class="o">=</span> <span class="o">-</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">euler_matrix</span><span class="p">(</span><span class="n">radAngles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radAngles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">radAngles</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;szyz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverseTransform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="alignmentToRow"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.alignmentToRow">[docs]</a><span class="k">def</span> <span class="nf">alignmentToRow</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="n">alignType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    is2D == True-&gt; matrix is 2D (2D images alignment)</span>
<span class="sd">            otherwise matrix is 3D (3D volume alignment or projection)</span>
<span class="sd">    invTransform == True  -&gt; for xmipp implies projection</span>
<span class="sd">                          -&gt; for xmipp implies alignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     is2D = alignType == em.ALIGN_2D</span>
    <span class="c1">#     inverseTransform = alignType == em.ALIGN_PROJ</span>

    <span class="c1"># transformation matrix is processed here because</span>
    <span class="c1"># it uses routines available through scipion python</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">getMatrix</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">geometryFromMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="rowToAlignment"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.rowToAlignment">[docs]</a><span class="k">def</span> <span class="nf">rowToAlignment</span><span class="p">(</span><span class="n">alignmentList</span><span class="p">,</span> <span class="n">alignType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    is2D == True-&gt; matrix is 2D (2D images alignment)</span>
<span class="sd">            otherwise matrix is 3D (3D volume alignment or projection)</span>
<span class="sd">    invTransform == True  -&gt; for xmipp implies projection</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># use all angles in 2D since we might have mirrors</span>
    <span class="c1"># is2D = alignType == em.ALIGN_2D</span>
    <span class="n">inverseTransform</span> <span class="o">=</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">emcts</span><span class="o">.</span><span class="n">ALIGN_PROJ</span>

    <span class="n">alignment</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">()</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrixFromGeometry</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">)</span>
    <span class="n">alignment</span><span class="o">.</span><span class="n">setMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alignment</span></div>


<div class="viewcode-block" id="iterParticlesByMic"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.iterParticlesByMic">[docs]</a><span class="k">def</span> <span class="nf">iterParticlesByMic</span><span class="p">(</span><span class="n">partSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Iterate the particles ordered by micrograph &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">partSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_micId&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                               <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span></div>


<div class="viewcode-block" id="convertReferences"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.convertReferences">[docs]</a><span class="k">def</span> <span class="nf">convertReferences</span><span class="p">(</span><span class="n">refSet</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simplified version of writeSetOfParticles function.</span>
<span class="sd">    Writes out an hdf stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">refSet</span><span class="p">:</span>
        <span class="n">objDict</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputFn</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_itemId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

        <span class="c1"># the index in EMAN begins with 0</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="o">!=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>

        <span class="c1"># Write the e2converter.py process from where to read the image</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">objDict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>


<div class="viewcode-block" id="calculatePhaseShift"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.calculatePhaseShift">[docs]</a><span class="k">def</span> <span class="nf">calculatePhaseShift</span><span class="p">(</span><span class="n">ampcont</span><span class="p">):</span>
    <span class="c1"># calculate phase shift as in EMAN2 ctf.cpp</span>
    <span class="k">if</span> <span class="o">-</span><span class="mf">100.0</span> <span class="o">&lt;</span> <span class="n">ampcont</span> <span class="o">&lt;=</span> <span class="mf">100.0</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ampcont</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">PhaseShift</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctfPhaseShift</span></div>


<div class="viewcode-block" id="getLastParticlesParams"><a class="viewcode-back" href="../../../api/eman2/eman2.convert.convert.html#eman2.convert.convert.getLastParticlesParams">[docs]</a><span class="k">def</span> <span class="nf">getLastParticlesParams</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dictionary containing the params values of the last iteration.</span>

<span class="sd">    Key: Particle index (int)</span>
<span class="sd">    Value: Dict[{coverage: float, score: float, alignMatrix: list[float]}]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># JSON files with particles params: path/to/particle_parms_NN.json</span>
    <span class="n">particleParamsPaths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;particle_parms_*.json&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">particleParamsPaths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Particle params files not found&quot;</span><span class="p">)</span>

    <span class="n">lastParticleParamsPath</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">particleParamsPaths</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">particlesParams</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lastParticleParamsPath</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">particlesParams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># key: &#39;(path/to/particles/basename.hdf&#39;, nParticle)&#39;</span>
        <span class="c1"># values: &#39;{&quot;coverage&quot;: 1.0, &quot;score&quot;: 2.0, &quot;xform.align3d&quot;: {&quot;matrix&quot;: [...]}}&#39;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\)$&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">particleIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coverage&quot;</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
        <span class="n">alignMatrix</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xform.align3d&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;matrix&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="ow">and</span> <span class="n">score</span> <span class="ow">and</span> <span class="n">alignMatrix</span><span class="p">:</span>
            <span class="n">customParticleParams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">coverage</span><span class="o">=</span><span class="n">coverage</span><span class="p">,</span>
                <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                <span class="n">alignMatrix</span><span class="o">=</span><span class="n">alignMatrix</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="n">particleIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">customParticleParams</span>

    <span class="k">return</span> <span class="n">output</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: dependabot/pip/babel-2.9.1
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="convert.html">dependabot/pip/babel-2.9.1</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>