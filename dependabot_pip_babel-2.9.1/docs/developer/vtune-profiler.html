

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Intel VTune profiler &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Intel VTune profiler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/docs/developer/vtune-profiler.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="intel-vtune-profiler">
<span id="vtune-profiler"></span><h1>Intel VTune profiler<a class="headerlink" href="#intel-vtune-profiler" title="Permalink to this headline">¶</a></h1>
<p>VTune is a performance analysis tool from Intel for profiling serial and multithreaded applications. The data collector profiles your application using the OS timer, interrupts a process, collects samples of all active instruction addresses with the sampling interval of 10ms, and captures a call sequence (stack) for each sample.
By default, the collector does not gather system-wide performance data but focuses on your application only.
Below we describe a setup for Python code analysis only, but it could be used for many other languages etc.
Compared to other popular Python profilers like cProfile and Line_profiler it can provide code line-level granularity with minimal overhead.
A more detailed comparison can be found <a class="reference external" href="https://software.intel.com/content/www/us/en/develop/articles/profiling-python-with-intel-vtune-amplifier-a-covariance-demonstration.html">here</a></p>
<div class="section" id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://software.intel.com/content/www/us/en/develop/documentation/vtune-help/top.html">Download and install VTune</a></p>
<p>VTune is a part of Intel oneAPI Base Toolkit. During installation, if you are interested only in Python profiling, select the following components:</p>
<div class="figure">
<img alt="Selected components to install" src="../../_images/vtune-install.png" />
</div>
</div>
<div class="section" id="setting-up-vtune">
<h2>Setting Up VTune<a class="headerlink" href="#setting-up-vtune" title="Permalink to this headline">¶</a></h2>
<p>It is assumed that Scipion3 has been previously installed. In the example below we will run “Hotspots” analysis which can show the CPU usage issues.</p>
<ol class="arabic simple">
<li>Activate VTune with e.g. the following script:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> /home/azazello/soft/intel/oneapi/vtune/latest/env/vars.sh
<span class="nb">export</span> <span class="nv">AMPLXE_RUNTOOL_OPTIONS</span><span class="o">=</span>--no-altstack
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Open Vtune (<strong>vtune-gui</strong>) and create a new project. If the <strong>Configure Analysis</strong> tab didn’t open, right click on the project name and select that option.</li>
<li>Setup the analysis configuration as below. You need to specify:<ol class="loweralpha">
<li>full path to scipion3 launcher</li>
<li>application parameters (below we set the config file and the last project to be opened)</li>
<li>extra environment variables (<em>PYTHONUNBUFFERED, SCIPION_HOME and LD_LIBRARY_PATH</em>)</li>
<li>also tick Analyze child processes</li>
</ol>
</li>
</ol>
<div class="figure">
<img alt="configure" src="../../_images/vtune-config.png" />
</div>
<ol class="arabic simple" start="4">
<li>Press big Start button at the bottom. After a while the last Scipion project will open. You are free to chose whether you want to profile project window loading (remove “last” keyword), opening of a project window or running a protocol in the project. Since VTune can analyse child processes it will find the Python and other (e.g. Xmipp etc) processes forked by Scipion.</li>
<li>Once finished, close all Scipion windows. VTune will start processing profiling data.</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You need to close the launched process (Scipion) otherwise the profiler will not complete its job!</p>
</div>
</div>
<div class="section" id="analysing-results">
<h2>Analysing results<a class="headerlink" href="#analysing-results" title="Permalink to this headline">¶</a></h2>
<p>In our example below we have Scipion installed via conda and we have run the analysis on an empty project (which we just closed after its opening). The Scipion launcher we provided in the configuration is a small python script executed by system Python.
This script in turn sets up conda and activate Scipion environment. Inside that environment we launch Scipion itself (python -m scipion …). Subsequently,
Scipion GUI processes and protocol steps execution are run by child processes of the Scipion python. In reality, the situation is even more complicated with more Python and OS threads.</p>
<ol class="arabic simple">
<li>Once the analysis has finished, you will land on the <strong>Summary</strong> tab with some global statistics. You can see that we mostly used two CPU cores in our little test.</li>
<li>Let’s see how the timeline for the process tree looks like. Go to the <strong>Platform</strong> tab, choose <em>Process/Thread/Module</em> in the top right menu then right click on any process and sort them by <em>Row Start Time</em>, <em>Ascending</em>.</li>
</ol>
<div class="figure">
<img alt="process tree options" src="../../_images/vtune-process-tree1.png" />
</div>
<div class="figure">
<img alt="process tree" src="../../_images/vtune-process-tree2.png" />
</div>
<p>The first in the list is <em>scipion3</em> launcher script, followed by python3.9 (our system python). Scroll down and you will see conda’s python getting initialized, followed by python3.8.
The last process is the Scipion python (from Scipion’s conda environment), that has several child threads for GUI etc.</p>
<ol class="arabic simple" start="3">
<li>You can also choose at the bottom which process and/or threads events/calls to show:</li>
</ol>
<div class="figure">
<img alt="filtering results" src="../../_images/vtune-filter.png" />
</div>
<ol class="arabic simple" start="4">
<li>Select the main (most used) Python process, thread and module at the bottom and switch to <strong>Top-down Tree</strong> tab. Choose <em>Grouping: Call Stack</em>. Start unwrapping the list of functions. In the example below you can see how <cite>__main__.py</cite> from scipion-app launches a tree of functions:</li>
</ol>
<div class="figure">
<img alt="top down tree" src="../../_images/vtune-topdown.png" />
</div>
<ol class="arabic simple" start="5">
<li>Another representation of results can be seen in <strong>Caller/Callee</strong> tab. Here you can display parent (Callers) and child (Callees) functions for every element. Example below is for <em>Domain.getProtocols</em> function from <cite>plugin.py</cite>:</li>
</ol>
<div class="figure">
<img alt="parents and childs" src="../../_images/vtune-callers.png" />
</div>
<ol class="arabic simple" start="6">
<li>Go to <strong>Bottom-up</strong> tab and select <em>Grouping: Thread/Function/Call stack</em>. All calls are sorted by CPU time by default. Here every call can be traced down to a source code line. Here we are looking at <em>__findTreeLocation</em> function from <cite>viewprotocols.py</cite>:</li>
</ol>
<div class="figure">
<img alt="bottom-up tree" src="../../_images/vtune-bottomup.png" />
</div>
<ol class="arabic simple" start="7">
<li>If you double click on any call VTune will try to open the source code file in a separate tab and point you to the exact line:</li>
</ol>
<div class="figure">
<img alt="source code analysis" src="../../_images/vtune-sources.png" />
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>VTune provides different analysis types, for Python code you can choose the <em>Hotspots, Threading, or Memory Consumption</em> analysis type in the Configure Analysis tab.
If you do want to attach to a running Python process (e.g. protocol execution), you can change <em>Launch Application</em> to <em>Attach to Process</em> and select the PID for the python process (like <cite>/path/to/pyworkflow/apps/pw_protocol_run.py /path/to/project/Runs/000353_EmpiarDownloader/logs/run.db 353</cite>).</p>
<p>Altogether now you should get familiar with the VTune software and get ready to profile a protocol run. The only difference is that the tree of processes, threads and functions will get more complex and also the time to run the analysis once you close Scipion will increase.
We leave this exercise to the reader.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: dependabot/pip/babel-2.9.1
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="vtune-profiler.html">dependabot/pip/babel-2.9.1</a></dd>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/vtune-profiler.html">release-3.0.0</a></dd>
            <dd><a href="../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
            <dd><a href="../../../tomo_picking_tutorial/docs/developer/vtune-profiler.html">tomo_picking_tutorial</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>