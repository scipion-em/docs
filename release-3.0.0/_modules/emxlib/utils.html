

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>emxlib.utils &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../emxlib.html">emxlib</a> &raquo;</li>
        
      <li>emxlib.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for emxlib.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Roberto Marabini (roberto@cnb.csic.es) [1]</span>
<span class="c1"># *              J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se) [2]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] SciLifeLab, Stockholm University</span>
<span class="c1"># * [2] Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MODIFICATION ADVICE:</span>

<span class="sd">Please, do not generate or distribute</span>
<span class="sd">a modified version of this file under its original name.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">collections</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Could not import OrderedDict. For Python versions &#39;</span>
                     <span class="s1">&#39;earlier than 2.7 this module may be missing. &#39;</span>
                     <span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">NAMING CONVENTIONS:</span>
<span class="sd">1) </span>
<span class="sd"> xxxxx__yy will be written in XML as</span>
<span class="sd">&lt;xxxx&gt;</span>
<span class="sd">   &lt;yy&gt; value &lt;/yy&gt;</span>
<span class="sd">&lt;/xxxx&gt;</span>

<span class="sd">anything starting by the name of a class (i.e. micrographXXXX) </span>
<span class="sd"> is a pointer to that class</span>

<span class="sd">GLOSARY:</span>

<span class="sd"> primary key: A primary key is a set of labels/attributes</span>
<span class="sd"> that uniquely identify an object (i.e: a micrograph)</span>
<span class="sd"> </span>
<span class="sd"> foreign key: Given two objects (i.e one micrograph an one particle) </span>
<span class="sd"> a foreign key is a set of labels/attributes in the first object </span>
<span class="sd"> that uniquely identify the second object </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">EMX_SEP</span> <span class="o">=</span> <span class="s1">&#39;__&#39;</span>
<span class="c1">#classes </span>
<span class="n">MICROGRAPH</span> <span class="o">=</span> <span class="s1">&#39;micrograph&#39;</span>
<span class="n">PARTICLE</span>   <span class="o">=</span> <span class="s1">&#39;particle&#39;</span>
<span class="c1">#order in which items should be read</span>
<span class="n">CLASSLIST</span>  <span class="o">=</span> <span class="p">[</span><span class="n">MICROGRAPH</span><span class="p">,</span> <span class="n">PARTICLE</span><span class="p">]</span>
<span class="c1">#primary keys</span>
<span class="n">FILENAME</span>   <span class="o">=</span> <span class="s1">&#39;fileName&#39;</span>
<span class="n">INDEX</span>      <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
<span class="n">COMMENT</span>    <span class="o">=</span> <span class="s1">&#39;comment&#39;</span>

<div class="viewcode-block" id="EmxLabel"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxLabel">[docs]</a><span class="k">class</span> <span class="nc">EmxLabel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auxiliary class to assign data type (i.e.: int, str, etc)</span>
<span class="sd">    and unit to each attribute/label pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        
<div class="viewcode-block" id="EmxLabel.hasUnit"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxLabel.hasUnit">[docs]</a>    <span class="k">def</span> <span class="nf">hasUnit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="EmxLabel.getUnit"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxLabel.getUnit">[docs]</a>    <span class="k">def</span> <span class="nf">getUnit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span></div>

<div class="viewcode-block" id="EmxLabel.getType"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxLabel.getType">[docs]</a>    <span class="k">def</span> <span class="nf">getType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span></div></div>

<span class="c1">#Dictionary with attribute names, data types and units</span>
<span class="c1">#By default an attribute does not has unit assign to it</span>
<span class="n">emxDataTypes</span><span class="o">=</span><span class="p">{</span>
              <span class="n">FILENAME</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
              <span class="p">,</span><span class="n">INDEX</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
              <span class="p">,</span> <span class="n">COMMENT</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;acceleratingVoltage&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;kV&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;activeFlag&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;amplitudeContrast&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;boxSize__X&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;boxSize__Y&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;boxSize__Z&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;centerCoord__X&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;centerCoord__Y&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;centerCoord__Z&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;cs&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;defocusU&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;defocusV&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;defocusUAngle&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;fom&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;pixelSpacing__X&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;A/px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;pixelSpacing__Y&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;A/px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;pixelSpacing__Z&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;A/px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t11&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t12&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t13&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t14&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t21&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t22&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t23&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t24&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t31&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t32&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t33&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
              <span class="p">,</span><span class="s1">&#39;transformationMatrix__t34&#39;</span><span class="p">:</span><span class="n">EmxLabel</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="EmxObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject">[docs]</a><span class="k">class</span> <span class="nc">EmxObject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all EMX objects/classes</span>
<span class="sd">    name is the class type so far micrograph or particles</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">_foreignKeys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_primaryKey</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span>  <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1">#---------- Public object methods ------------------------------------</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pprint</span><span class="p">()</span>
    
<div class="viewcode-block" id="EmxObject.clear"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generic clean. PK cannot be modified or clean. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterForeignKeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>
            
<div class="viewcode-block" id="EmxObject.get"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given a key (attribute name) returns the value assigned to it.</span>
<span class="sd">        If not present, the default will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default</span></div>
        
<div class="viewcode-block" id="EmxObject.has"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="EmxObject.set"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given a key (attribute name) assigns a value to it. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primaryKey</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primaryKey</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">%s</span><span class="s2"> not allowed in: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="EmxObject.iterAttributes"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.iterAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">iterAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list with valid keys (attribute names) </span>
<span class="sd">           and values for this class. Primary keys are ignored&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

<div class="viewcode-block" id="EmxObject.iterPrimaryKeys"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.iterPrimaryKeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterPrimaryKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list with valid primary keys (attribute names) </span>
<span class="sd">        and values for this class&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

<div class="viewcode-block" id="EmxObject.iterForeignKeys"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.iterForeignKeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterForeignKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list with valid primary keys (attribute names) </span>
<span class="sd">        and values for this class&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If the primary keys of two objects are identical </span>
<span class="sd">        then both objects are identical&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">)</span>

<div class="viewcode-block" id="EmxObject.strongEq"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxObject.strongEq">[docs]</a>    <span class="k">def</span> <span class="nf">strongEq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; true if both objects are truly identical&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dictPrimaryKeys</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dictForeignKeys</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">)</span></div>
                   
    <span class="c1">#---------- Internal object methods----------------------------------</span>
    <span class="k">def</span> <span class="nf">_pprintPK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">printNone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print primary keys .&quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;fileName: </span><span class="si">%(fileName)s</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">INDEX</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">printNone</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;, index:</span><span class="si">%(index)s</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        
    <span class="k">def</span> <span class="nf">_pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">printNone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;print ordered dictionaries, default routine is ugly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#primary key</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Object type: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;Primary key:</span><span class="se">\n</span><span class="s2">  &quot;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pprintPK</span><span class="p">(</span><span class="n">printNone</span><span class="p">)</span>
        <span class="c1">#foreign key</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">)</span> <span class="ow">and</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;Foreign keys:</span><span class="se">\n</span><span class="s2">  &quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">printNone</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; &quot;</span> <span class="o">%</span> <span class="n">key</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;None&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#value is not a EMobject and therefore has no _pprintPK</span>
                        <span class="c1">#out += value._pprintPK(printNone)</span>
                        <span class="n">out</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
        <span class="c1">#other attributes</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;Other Attributes:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterAttributes</span><span class="p">():</span>
            <span class="n">_unit</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_unit</span><span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">_unit</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">printNone</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_unit</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">_initAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private function do not use outside this file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictAttributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">_initPrimaryKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private function do not use outside this file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()(</span><span class="n">value</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_validateForeignKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise an Exception if className is not in foreign keys dict. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">className</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foreignKeys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;class </span><span class="si">%s</span><span class="s2"> does not have FK of type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">className</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">_setForeignKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set another object as foreign key of self for a given className. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validateForeignKey</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">[</span><span class="n">className</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span>
        
    <span class="k">def</span> <span class="nf">_getForeignKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the object assigned as foreign key for a given className. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validateForeignKey</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmxImage"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxImage">[docs]</a><span class="k">class</span> <span class="nc">EmxImage</span><span class="p">(</span><span class="n">EmxObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for EmxMicrograph and EmxParticle.</span>
<span class="sd">    Both share that have FILENAME and INDEX as primary keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_primaryKey</span> <span class="o">=</span> <span class="p">[</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">INDEX</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#init emx object</span>
        <span class="n">EmxObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s2">&quot;cannot be created with fileName=None and index=None&quot;</span><span class="p">)</span>
        <span class="c1">#set primary keys. At least one of this must be different from None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPrimaryKey</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPrimaryKey</span><span class="p">(</span><span class="n">INDEX</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="EmxMicrograph"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxMicrograph">[docs]</a><span class="k">class</span> <span class="nc">EmxMicrograph</span><span class="p">(</span><span class="n">EmxImage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for Micrographs</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">_foreignKey</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="n">MICROGRAPH</span> 
    <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span>
         <span class="n">COMMENT</span>
        <span class="p">,</span><span class="s1">&#39;acceleratingVoltage&#39;</span>
        <span class="p">,</span><span class="s1">&#39;activeFlag&#39;</span>
        <span class="p">,</span><span class="s1">&#39;amplitudeContrast&#39;</span>
        <span class="p">,</span><span class="s1">&#39;cs&#39;</span>
        <span class="p">,</span><span class="s1">&#39;defocusU&#39;</span>
        <span class="p">,</span><span class="s1">&#39;defocusV&#39;</span>
        <span class="p">,</span><span class="s1">&#39;defocusUAngle&#39;</span>
        <span class="p">,</span><span class="s1">&#39;fom&#39;</span>
        <span class="p">,</span><span class="s1">&#39;pixelSpacing__X&#39;</span>
        <span class="p">,</span><span class="s1">&#39;pixelSpacing__Y&#39;</span>
        <span class="p">,</span><span class="s1">&#39;pixelSpacing__Z&#39;</span>
        <span class="p">]</span></div>
            
        
<div class="viewcode-block" id="EmxParticle"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxParticle">[docs]</a><span class="k">class</span> <span class="nc">EmxParticle</span><span class="p">(</span><span class="n">EmxImage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for Particles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_foreignKeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">MICROGRAPH</span><span class="p">]</span>
    <span class="n">_foreignKeysMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">MICROGRAPH</span><span class="p">:</span><span class="n">EmxMicrograph</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="n">PARTICLE</span>
    <span class="n">_attributes</span><span class="o">=</span><span class="p">[</span>
                 <span class="n">COMMENT</span>
                <span class="p">,</span><span class="s1">&#39;activeFlag&#39;</span>
                <span class="p">,</span><span class="s1">&#39;boxSize__X&#39;</span>
                <span class="p">,</span><span class="s1">&#39;boxSize__Y&#39;</span>
                <span class="p">,</span><span class="s1">&#39;boxSize__Z&#39;</span>
                <span class="p">,</span><span class="s1">&#39;centerCoord__X&#39;</span>
                <span class="p">,</span><span class="s1">&#39;centerCoord__Y&#39;</span>
                <span class="p">,</span><span class="s1">&#39;centerCoord__Z&#39;</span>
                <span class="p">,</span><span class="s1">&#39;defocusU&#39;</span>
                <span class="p">,</span><span class="s1">&#39;defocusV&#39;</span>
                <span class="p">,</span><span class="s1">&#39;defocusUAngle&#39;</span>
                <span class="p">,</span><span class="s1">&#39;fom&#39;</span>
                <span class="p">,</span><span class="s1">&#39;pixelSpacing__X&#39;</span>
                <span class="p">,</span><span class="s1">&#39;pixelSpacing__Y&#39;</span>
                <span class="p">,</span><span class="s1">&#39;pixelSpacing__Z&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t11&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t12&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t13&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t14&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t21&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t22&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t23&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t24&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t31&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t32&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t33&#39;</span>
                <span class="p">,</span><span class="s1">&#39;transformationMatrix__t34&#39;</span>
                <span class="p">]</span>
    
<div class="viewcode-block" id="EmxParticle.setMicrograph"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxParticle.setMicrograph">[docs]</a>    <span class="k">def</span> <span class="nf">setMicrograph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micrograph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the micrograph associated with this particle. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setForeignKey</span><span class="p">(</span><span class="n">MICROGRAPH</span><span class="p">,</span> <span class="n">micrograph</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="EmxParticle.getMicrograph"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxParticle.getMicrograph">[docs]</a>    <span class="k">def</span> <span class="nf">getMicrograph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the micrograph associated with this particles. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getForeignKey</span><span class="p">(</span><span class="n">MICROGRAPH</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EmxData"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData">[docs]</a><span class="k">class</span> <span class="nc">EmxData</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Class to group EMX objects&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span> <span class="o">=</span> <span class="p">{</span><span class="n">MICROGRAPH</span> <span class="p">:</span> <span class="p">[],</span> 
                          <span class="n">PARTICLE</span>  <span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapObjectPK</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span> <span class="o">=</span> <span class="n">EmxXmlMapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="EmxData.addObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.addObject">[docs]</a>    <span class="k">def</span> <span class="nf">addObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapObjectPK</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obj</span></div>
        
<div class="viewcode-block" id="EmxData.getObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.getObject">[docs]</a>    <span class="k">def</span> <span class="nf">getObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapPK</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an object given its primary key. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapObjectPK</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mapPK</span><span class="p">)]</span></div>

<div class="viewcode-block" id="EmxData.clear"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">listName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapObjectPK</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="EmxData.size"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapObjectPK</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">nodelist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">subnode</span>

<div class="viewcode-block" id="EmxData.iterClasses"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.iterClasses">[docs]</a>    <span class="k">def</span> <span class="nf">iterClasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through objects of a particular class. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="p">[</span><span class="n">className</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">partStr</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">partStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">****</span><span class="se">\n</span><span class="si">%s</span><span class="s2">S</span><span class="se">\n</span><span class="s2">****</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">partStr</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">partStr</span>

<div class="viewcode-block" id="EmxData.read"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emxFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read data from an emxFile. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="o">.</span><span class="n">readEMXFile</span><span class="p">(</span><span class="n">emxFile</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="EmxData.readFirstObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.readFirstObject">[docs]</a>    <span class="k">def</span> <span class="nf">readFirstObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">emxFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read only the first object of a given className from file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="o">.</span><span class="n">firstObject</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">emxFile</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="EmxData.getFirstObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.getFirstObject">[docs]</a>    <span class="k">def</span> <span class="nf">getFirstObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the first object of a given className.</span>
<span class="sd">        This function should be called after read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objLists</span><span class="p">[</span><span class="n">className</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objList</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">objList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="kc">None</span> </div>
        
<div class="viewcode-block" id="EmxData.write"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxData.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emxFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write data to an emxFile. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapper</span><span class="o">.</span><span class="n">writeEMXFile</span><span class="p">(</span><span class="n">emxFile</span><span class="p">)</span></div></div>

<span class="c1">#------------------- XmlMapper implementation -----------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Following from here there is the implementation of the XmlMapper to store</span>
<span class="sd">EmxData objects in XML files as described in the EMX format.</span>
<span class="sd">This mapper is the default one used by EmxData (and no other make sense at this moment)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
    
<span class="n">ERR_VALIDATION_WRONG</span><span class="o">=</span><span class="mi">1</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">ROOTNAME</span> <span class="o">=</span> <span class="s1">&#39;EMX&#39;</span>
<span class="n">HEADER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;</span><span class="si">%(ROOTNAME)s</span><span class="s2"> version=&quot;</span><span class="si">%(VERSION)s</span><span class="s2">&quot;&gt;</span>
<span class="s2">  &lt;!--</span>
<span class="s2">  ##########################################################################</span>
<span class="s2">  #               EMX Exchange file </span>
<span class="s2">  #               Produced using the emx library </span>
<span class="s2">  #               (http://i2pc.cnb.csic.es/emx/LoadTools.htm?type=Library)</span>
<span class="s2">  # </span>
<span class="s2">  #  Information on this file format is available at </span>
<span class="s2">  #  http://i2pc.cnb.csic.es/emx</span>
<span class="s2">  ##########################################################################</span>
<span class="s2">  #  One of the best ways you can help us to improve this software</span>
<span class="s2">  #  is to let us know about any problems you find with it.</span>
<span class="s2">  #  Please report bugs to: emx@cnb.csic.es</span>
<span class="s2">  ##########################################################################</span>
<span class="s2">  --&gt;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="nb">globals</span><span class="p">()</span>
  
<span class="n">EMXSCHEMA10</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/scipion-em/scipion-em-emxlib/devel/emxlib/emx.xsd&#39;</span>
<span class="n">EMXSCHEMA11</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/scipion-em/scipion-em-emxlib/devel/emxlib/emx_11.xsd&#39;</span>


<div class="viewcode-block" id="ValidateError"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.ValidateError">[docs]</a><span class="k">class</span> <span class="nc">ValidateError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorMessage</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorCode</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Error Code: </span><span class="si">%d</span><span class="s2">. Message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errorCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorMessage</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateError.getCode"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.ValidateError.getCode">[docs]</a>    <span class="k">def</span> <span class="nf">getCode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorCode</span></div>
<div class="viewcode-block" id="ValidateError.getMessage"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.ValidateError.getMessage">[docs]</a>    <span class="k">def</span> <span class="nf">getMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorMessage</span></div></div>
    
    
<div class="viewcode-block" id="EmxXmlMapper"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper">[docs]</a><span class="k">class</span> <span class="nc">EmxXmlMapper</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Mapper for XML&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emxData</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emxData</span> <span class="o">=</span> <span class="n">emxData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classObject</span> <span class="o">=</span> <span class="p">{</span><span class="n">MICROGRAPH</span><span class="p">:</span> <span class="n">EmxMicrograph</span><span class="p">,</span> <span class="n">PARTICLE</span><span class="p">:</span> <span class="n">EmxParticle</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
<div class="viewcode-block" id="EmxXmlMapper.objectToXML"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.objectToXML">[docs]</a>    <span class="k">def</span> <span class="nf">objectToXML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given an object persist it in XML dataBase.</span>
<span class="sd">        Each object goes to a different element. Much much faster...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># write primary key</span>
        <span class="n">xmlString</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;  &lt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">object</span><span class="o">.</span><span class="n">_name</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xmlString</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%(key)s</span><span class="s1">=&quot;</span><span class="si">%(value)s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
        <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># write attributes</span>
        <span class="n">oldParent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="n">iterAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getUnit</span><span class="p">()</span>
            <span class="c1"># is this an special case, that is, </span>
            <span class="c1"># does the label contains &#39;__&#39;?</span>
            <span class="c1"># I asumme there is no grandchild</span>
            <span class="k">if</span> <span class="n">EMX_SEP</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">EMX_SEP</span><span class="p">)</span>
                <span class="c1"># take care of cases like:</span>
                <span class="c1"># &lt;pixelSpacing&gt;</span>
                <span class="c1"># &lt;X&gt;5.6&lt;/X&gt;</span>
                <span class="c1"># &lt;Y&gt;5.7&lt;/Y&gt;</span>
                <span class="c1"># &lt;/pixelSpacing&gt;</span>
                <span class="c1"># second entry</span>
                <span class="k">if</span> <span class="n">oldParent</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">=</span> <span class="n">xmlString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &lt;/</span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># first entry</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;</span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">parent</span>
                <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;</span><span class="si">%(child)s</span><span class="s2">&gt;</span><span class="si">%(value)s</span><span class="s2">&quot;</span>\
                              <span class="s2">&quot;&lt;/</span><span class="si">%(child)s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">  &lt;/</span><span class="si">%(parent)s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span><span class="n">parent</span><span class="p">,</span>
                                                           <span class="s1">&#39;child&#39;</span><span class="p">:</span><span class="n">child</span><span class="p">,</span>
                                                           <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;</span><span class="si">%(child)s</span><span class="s1"> unit=&quot;</span><span class="si">%(unit)s</span><span class="s1">&quot;&gt;</span><span class="si">%(value)s</span><span class="s1">&#39;</span>\
                              <span class="s2">&quot;&lt;/</span><span class="si">%(child)s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">    &lt;/</span><span class="si">%(parent)s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span><span class="n">parent</span><span class="p">,</span>
                                                           <span class="s1">&#39;child&#39;</span><span class="p">:</span><span class="n">child</span><span class="p">,</span>
                                                           <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                                                           <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="n">unit</span><span class="p">})</span>
                <span class="n">oldParent</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="c1"># simple attributes with no child</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;</span><span class="si">%(key)s</span><span class="s2">&gt;</span><span class="si">%(value)s</span><span class="s2">&lt;/</span><span class="si">%(key)s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xmlString</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;</span><span class="si">%(key)s</span><span class="s1"> unit=&quot;</span><span class="si">%(unit)s</span><span class="s1">&quot;&gt;</span><span class="si">%(value)s</span><span class="s1">&lt;/</span><span class="si">%(key)s</span><span class="s1">&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="n">unit</span><span class="p">})</span>
                    
        <span class="c1"># write foreign key</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">)</span> <span class="ow">and</span>\
               <span class="nb">object</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">[</span><span class="nb">object</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="n">pointedObject</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="p">[</span><span class="nb">object</span><span class="o">.</span><span class="n">dictForeignKeys</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;    &lt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pointedObject</span><span class="o">.</span><span class="n">_name</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pointedObject</span><span class="o">.</span><span class="n">dictPrimaryKeys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">xmlString</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%(key)s</span><span class="s1">=&quot;</span><span class="si">%(value)s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
            <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">xmlString</span> <span class="o">+=</span> <span class="s2">&quot;  &lt;/</span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">object</span><span class="o">.</span><span class="n">_name</span>
        <span class="c1"># print xmlString</span>
        <span class="k">return</span> <span class="n">xmlString</span></div>

    <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;acceleratingVoltage&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;activeFlag&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;amplitudeContrast&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;cs&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;defocusU&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;defocusV&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;defocusUAngle&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;fom&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;pixelSpacing__X&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;pixelSpacing__Y&#39;</span>
        <span class="p">,</span> <span class="s1">&#39;pixelSpacing__Z&#39;</span>
        <span class="p">]</span> 
    
<div class="viewcode-block" id="EmxXmlMapper.readEMXFile"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.readEMXFile">[docs]</a>    <span class="k">def</span> <span class="nf">readEMXFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">classElement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create tree from xml file </span>
<span class="sd">        If classElement is not None, the first element of this class</span>
<span class="sd">        will be returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">))</span>
        <span class="c1"># turn it into an iterator</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="c1"># get the root element</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        
        <span class="c1"># self.classObject = globals()[&#39;Emx&#39;+element]</span>
        <span class="n">doItPK</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">skipLabelPK</span> <span class="o">=</span> <span class="s1">&#39;kk&#39;</span>
        
        <span class="n">mergeParent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parentLabel</span> <span class="o">=</span> <span class="s1">&#39;kk&#39;</span>
        
        <span class="n">lastStartTagA</span> <span class="o">=</span> <span class="s1">&#39;kk&#39;</span>
        <span class="n">lastEventStartA</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">listObjectWithForeignKey</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;EMX&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
                <span class="c1"># primary key and FK</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">CLASSLIST</span><span class="p">:</span>
                    <span class="c1"># only primary key</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">doItPK</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">createObject</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                        <span class="n">doItPK</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">skipLabelPK</span> <span class="o">=</span> <span class="n">tag</span>
                    <span class="c1"># foreign key</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># get PF and save the map for the first pass </span>
                        <span class="c1"># since the actual pointed object may not exists</span>
                        <span class="n">FK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readObjectPK</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="o">.</span><span class="n">_setForeignKey</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">FK</span><span class="p">)</span>
                        <span class="n">listObjectWithForeignKey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lastEventStartA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">mergeParent</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">parentLabel</span> <span class="o">=</span> <span class="n">lastStartTagA</span>
                    <span class="n">lastStartTagA</span> <span class="o">=</span> <span class="n">tag</span>
                    <span class="n">lastEventStartA</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="c1"># PK or FG</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">CLASSLIST</span> <span class="ow">and</span> <span class="n">skipLabelPK</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">doItPK</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">classElement</span><span class="p">:</span>
                        <span class="k">return</span>
                <span class="c1"># other attributes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># simple element</span>
                    <span class="k">if</span> <span class="n">lastStartTagA</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;Element: &quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot; is empty&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;ZERO for tag=</span><span class="si">%s</span><span class="s2">, value=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
                        <span class="k">if</span>  <span class="n">mergeParent</span><span class="p">:</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">parentLabel</span> <span class="o">+</span> <span class="n">EMX_SEP</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">parentLabel</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                        <span class="n">mergeParent</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">parentLabel</span> <span class="o">=</span> <span class="s1">&#39;kk&#39;</span>
                    <span class="n">lastEventStartA</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;Unknown event type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="p">)</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Now loop Trough all objects and fix the FK</span>
        <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">listObjectWithForeignKey</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="n">_foreignKeys</span><span class="p">:</span>
                <span class="n">fk</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">_getForeignKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">_setForeignKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emxData</span><span class="o">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">fk</span><span class="p">))</span></div>

<div class="viewcode-block" id="EmxXmlMapper.createObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.createObject">[docs]</a>    <span class="k">def</span> <span class="nf">createObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myClass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classObject</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="c1"># primary key </span>
        <span class="c1"># get PK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readObjectPK</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="c1"># create object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classObject</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">](</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">))</span>
        <span class="c1"># add it to emxData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emxData</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="EmxXmlMapper.readObjectPK"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.readObjectPK">[docs]</a>    <span class="k">def</span> <span class="nf">readObjectPK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; read primary key. So far all entities has the same PK. </span>
<span class="sd">        We may need to specialize or use dictPrimaryKeys in the future</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapPK</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">mapPK</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">emxDataTypes</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()(</span><span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mapPK</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">mapPK</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;readObjectPK: No fileName or index provided&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmxXmlMapper.firstObject"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.firstObject">[docs]</a>    <span class="k">def</span> <span class="nf">firstObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over the tags elements and find the </span>
<span class="sd">        first one of type &#39;classname&#39;, build the object</span>
<span class="sd">        and return it. The foreing keys will be not updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#        context = ET.iterparse(fileName, events=(&#39;start&#39;, &#39;end&#39;))</span>
<span class="c1">#        for event, elem in iter(context):</span>
<span class="c1">#            tag = elem.tag</span>
<span class="c1">#            if event == &#39;start&#39;:</span>
<span class="c1">#                # print &quot;tag: &#39;%s&#39;&quot; % tag, &quot;class: &#39;%s&#39;&quot; % classname</span>
<span class="c1">#                if tag == classname:</span>
<span class="c1">#                    # print &quot;tag==class&quot;</span>
<span class="c1">#                    self.createObject(elem)</span>
<span class="c1">#                    # print &quot;self._object: &quot;, self._object</span>
<span class="c1">#                    return self._object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readEMXFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">classElement</span><span class="o">=</span><span class="n">classname</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object</span></div>
        
<div class="viewcode-block" id="EmxXmlMapper.writeEMXFile"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.EmxXmlMapper.writeEMXFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeEMXFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write xml file and store it in a document</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xmlFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">xmlFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">xmlFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">)</span>

        <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emxData</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectToXML</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>  <span class="c1"># </span>
<span class="c1">#            #implement this with a regular expression</span>
<span class="c1">#            #format matrices properly</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">{</span>
                          <span class="s1">&#39;&lt;/t11&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t11&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t12&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t12&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t13&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t13&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t21&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t21&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t22&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t22&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t23&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t23&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t31&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t31&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t32&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t32&gt; &#39;</span>
                         <span class="p">,</span> <span class="s1">&#39;&lt;/t33&gt;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">:</span><span class="s1">&#39;&lt;/t33&gt; &#39;</span>
                         <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;comment&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">)</span> 
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/comment&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;--&gt;&#39;</span><span class="p">)</span>
            <span class="n">xmlFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">xmlFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/EMX&gt;&quot;</span><span class="p">)</span>
        <span class="n">xmlFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="validateSchema"><a class="viewcode-back" href="../../api/emxlib/emxlib.utils.html#emxlib.utils.validateSchema">[docs]</a><span class="k">def</span> <span class="nf">validateSchema</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">schema_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Code from astropy project released under BSD licence</span>
<span class="sd">    Validates an XML file against a schema or DTD.</span>

<span class="sd">    Functions to do XML schema and DTD validation.  At the moment, this</span>
<span class="sd">    makes a subprocess call first to xerces then to  xmllint. </span>
<span class="sd">    This could use a Python-based</span>
<span class="sd">    library at some point in the future, if something appropriate could be</span>
<span class="sd">    found. lxml is a possibility but has too many dependences if anyone</span>
<span class="sd">    knows about a pure python validator let my know</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path to the XML file to validate</span>

<span class="sd">    schema : str</span>
<span class="sd">        The path to the XML schema or DTD</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    returncode, stdout, stderr : int, str, str</span>
<span class="sd">        Returns the returncode from validator and the stdout and stderr</span>
<span class="sd">        as strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">os</span>
    <span class="c1">###########</span>
    <span class="c1"># try xerces</span>
    <span class="c1">###########</span>
    <span class="n">answerSize</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># avoid overflow in web</span>
    <span class="n">endding</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">schema_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_schema</span> <span class="o">=</span> <span class="n">EMXSCHEMA11</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_schema</span> <span class="o">=</span> <span class="n">schema_file</span>
    <span class="c1"># print &quot;java jaxp.SourceValidator -a %s -i %s -xsd11&quot;% (_schema, filename)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s2">&quot;java jaxp.SourceValidator -a </span><span class="si">%s</span><span class="s2"> -i </span><span class="si">%s</span><span class="s2"> -xsd11&quot;</span> 
                         <span class="o">%</span> <span class="p">(</span><span class="n">_schema</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="c1"># xerces exists but is error</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stderr</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">answerSize</span><span class="p">:</span>
           <span class="n">endding</span> <span class="o">=</span> <span class="s1">&#39;... (too many errors, displayed first </span><span class="si">%d</span><span class="s1"> characters)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">answerSize</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ValidateError</span><span class="p">(</span><span class="n">ERR_VALIDATION_WRONG</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;Error: when validating file </span><span class="si">%s</span><span class="s2"> with schema </span><span class="si">%s</span><span class="s2">.</span>
<span class="s2">        </span><span class="se">\n</span><span class="s2">Error:</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">_schema</span><span class="p">,</span> <span class="n">stderr</span><span class="p">[:</span><span class="n">answerSize</span><span class="p">]</span> <span class="o">+</span> <span class="n">endding</span><span class="p">))</span>
    <span class="c1">#######</span>
    <span class="c1"># no xerces available, let us try xmlint</span>
    <span class="c1">######</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;validating with xmllint&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_schema</span> <span class="o">=</span> <span class="n">EMXSCHEMA10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_schema</span> <span class="o">=</span> <span class="n">schema_file</span>
        <span class="n">schema_part</span> <span class="o">=</span> <span class="s1">&#39;--schema &#39;</span> <span class="o">+</span> <span class="n">_schema</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="s2">&quot;xmllint --noout </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema_part</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidateError</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span>
                <span class="sd">&quot;&quot;&quot;Error: neither xerces-f nor xmllint could be found,  I cannot validate schema. </span>
<span class="sd">    Schema validation is based either on the xmllint program that belongs to the libxml2-tools package.</span>
<span class="sd">    or on the xerces-f project&quot;&quot;&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">answerSize</span><span class="p">:</span>
                 <span class="n">endding</span> <span class="o">=</span> <span class="s1">&#39;... (too many errors, displayed first </span><span class="si">%d</span><span class="s1"> characters)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">answerSize</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Error: when validating file </span><span class="si">%s</span><span class="s2"> with schema </span><span class="si">%s</span><span class="s2">.</span>
<span class="s2">            </span><span class="se">\n</span><span class="s2">Error:</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">_schema</span><span class="p">,</span> <span class="n">stderr</span><span class="p">[:</span><span class="n">answerSize</span><span class="p">]</span> <span class="o">+</span> <span class="n">endding</span><span class="p">)</span>
            <span class="c1"># print &quot;message&quot;, message</span>
            <span class="k">raise</span> <span class="n">ValidateError</span><span class="p">(</span><span class="n">ERR_VALIDATION_WRONG</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">[:</span><span class="n">answerSize</span><span class="p">],</span> <span class="n">stderr</span><span class="p">[:</span><span class="n">answerSize</span><span class="p">]</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../jj_add_practice_day1/index.html">jj_add_practice_day1</a></dd>
            <dd><a href="../../../jj_add_protocol_test_practice/index.html">jj_add_protocol_test_practice</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="utils.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>