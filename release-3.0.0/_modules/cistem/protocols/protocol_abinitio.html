

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cistem.protocols.protocol_abinitio &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/Scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/Plugins-API.html">Plugins API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../cistem.html">cistem</a> &raquo;</li>
        
      <li>cistem.protocols.protocol_abinitio</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cistem.protocols.protocol_abinitio</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Grigory Sharov (gsharov@mrc-lmb.cam.ac.uk) [1]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] MRC Laboratory of Molecular Biology, MRC-LMB</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">from</span> <span class="nn">pyworkflow.protocol</span> <span class="k">import</span> <span class="n">STEPS_PARALLEL</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">import</span> <span class="p">(</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span>
                                        <span class="n">IntParam</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span>
                                        <span class="n">BooleanParam</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtInitialVolume</span>



<div class="viewcode-block" id="CistemProtAbInitio"><a class="viewcode-back" href="../../../api/cistem/cistem.protocols.protocol_abinitio.html#cistem.protocols.protocol_abinitio.CistemProtAbInitio">[docs]</a><span class="k">class</span> <span class="nc">CistemProtAbInitio</span><span class="p">(</span><span class="n">ProtInitialVolume</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Protocol to run ab-initio reconstruction in cisTEM. &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;ab-initio&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ProtInitialVolume</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">=</span> <span class="n">STEPS_PARALLEL</span>

    <span class="c1"># -------------------------- DEFINE param functions -----------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span>
                      <span class="n">pointerCondition</span><span class="o">=</span><span class="s1">&#39;hasCTF&#39;</span><span class="p">,</span>
                      <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input particles&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the input particles.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numOfStarts&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of starts&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The number of times the ab-initio reconstruction &#39;</span>
                           <span class="s1">&#39;is restarted, using the result from the previous &#39;</span>
                           <span class="s1">&#39;run in each restart.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numOfCycles&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of cycles per start&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The number of refinement cycles to run for &#39;</span>
                           <span class="s1">&#39;each start. The percentage of particles and &#39;</span>
                           <span class="s1">&#39;the refinement resolution limit will be &#39;</span>
                           <span class="s1">&#39;adjusted automatically from cycle to cycle &#39;</span>
                           <span class="s1">&#39;using initial and final values specified &#39;</span>
                           <span class="s1">&#39;under Expert Options.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expert options&#39;</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Refinement&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;StartResLimit&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial resolution limit (A)&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The starting resolution limit used to align &#39;</span>
                            <span class="s1">&#39;particles against the current 3D &#39;</span>
                            <span class="s1">&#39;reconstruction. In most cases, this should &#39;</span>
                            <span class="s1">&#39;specify a relatively low resolution to make &#39;</span>
                            <span class="s1">&#39;sure the reconstructions generated in the &#39;</span>
                            <span class="s1">&#39;initial refinement cycles do not develop &#39;</span>
                            <span class="s1">&#39;spurious high-resolution features.&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;EndResLimit&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final resolution limit (A)&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The resolution limit used in the final &#39;</span>
                            <span class="s1">&#39;refinement cycle. In most cases, this &#39;</span>
                            <span class="s1">&#39;should specify a resolution at which &#39;</span>
                            <span class="s1">&#39;expected secondary structure becomes &#39;</span>
                            <span class="s1">&#39;apparent, i.e. around 9 A.&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Mask radius (A):&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The radius of the circular mask applied. &#39;</span>
                                  <span class="s1">&#39;This mask should be sufficiently large to include &#39;</span>
                                  <span class="s1">&#39;the largest dimension of the particle. The mask &#39;</span>
                                  <span class="s1">&#39;helps remove noise outside the area of the &#39;</span>
                                  <span class="s1">&#39;particle.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maskRadInner&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maskRad&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">90.0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Search range (A): &#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The search can be limited in the X and Y &#39;</span>
                                  <span class="s1">&#39;directions (measured from the box center) to &#39;</span>
                                  <span class="s1">&#39;ensure that only particles close to the box &#39;</span>
                                  <span class="s1">&#39;center are used for classification. A &#39;</span>
                                  <span class="s1">&#39;smaller range, for example 20 to 40 A, can &#39;</span>
                                  <span class="s1">&#39;speed up computation. However, the range &#39;</span>
                                  <span class="s1">&#39;should be chosen sufficiently generously to &#39;</span>
                                  <span class="s1">&#39;capture most particles. If the range of &#39;</span>
                                  <span class="s1">&#39;particle displacements from the box center &#39;</span>
                                  <span class="s1">&#39;is unknown, start with a larger value, e.g. &#39;</span>
                                  <span class="s1">&#39;100 A, check the results when the run &#39;</span>
                                  <span class="s1">&#39;finishes and reduce the range appropriately.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;rangeX&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;rangeY&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;autoMask&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use auto-masking?&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Should the 3D reconstructions be masked? &#39;</span>
                            <span class="s1">&#39;Masking is important to suppress weak &#39;</span>
                            <span class="s1">&#39;density features that usually appear in &#39;</span>
                            <span class="s1">&#39;the early stages of ab-initio reconstruction, &#39;</span>
                            <span class="s1">&#39;thus preventing them to get amplified during &#39;</span>
                            <span class="s1">&#39;the iterative refinement. Masking should only &#39;</span>
                            <span class="s1">&#39;be disabled if it appears to interfere with &#39;</span>
                            <span class="s1">&#39;the reconstruction process.&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;autoPerc&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Auto percent used?&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Should the percentage of particles used in &#39;</span>
                            <span class="s1">&#39;each refinement cycle be set automatically? &#39;</span>
                            <span class="s1">&#39;If reconstructions appear very noisy or &#39;</span>
                            <span class="s1">&#39;reconstructions settle into a wrong structure &#39;</span>
                            <span class="s1">&#39;that does not change anymore during iterations, &#39;</span>
                            <span class="s1">&#39;disable this option and specify initial and final &#39;</span>
                            <span class="s1">&#39;percentages manually. To reduce noise, increase &#39;</span>
                            <span class="s1">&#39;the percentage; to make reconstructions more &#39;</span>
                            <span class="s1">&#39;variable, decrease the percentage. By default, &#39;</span>
                            <span class="s1">&#39;the initial percentage is set to include an &#39;</span>
                            <span class="s1">&#39;equivalent of 2500 asymmetric units and the &#39;</span>
                            <span class="s1">&#39;final percentage corresponds to 10,000 asymmetric &#39;</span>
                            <span class="s1">&#39;units used.&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Percent used (%):&#39;</span><span class="p">,</span>
                             <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not autoPerc&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;User-specified percentages of particles &#39;</span>
                                  <span class="s1">&#39;used when Auto Percent Used is disabled.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;percUsed1&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not autoPerc&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;percUsed2&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not autoPerc&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;symmetryGroup&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Symmetry&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;applySym&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Always apply symmetry?&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Reconstruction&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;applyBlur&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Apply likelihood blurring?&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Should the reconstructions be blurred by &#39;</span>
                            <span class="s1">&#39;inserting each particle image at multiple &#39;</span>
                            <span class="s1">&#39;orientations, weighted by a likelihood &#39;</span>
                            <span class="s1">&#39;function? Enable this option if the ab-initio &#39;</span>
                            <span class="s1">&#39;procedure appears to suffer from over-fitting &#39;</span>
                            <span class="s1">&#39;and the appearance of spurious high-resolution &#39;</span>
                            <span class="s1">&#39;features.&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;applyBlur&#39;</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Smoothing factor [0-1]&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A factor that reduces the range of likelihoods &#39;</span>
                            <span class="s1">&#39;used for blurring. A smaller number leads to more &#39;</span>
                            <span class="s1">&#39;blurring. The user should try values between &#39;</span>
                            <span class="s1">&#39;0.1 and 1.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># -------------------------- INSERT steps functions -----------------------</span>

    <span class="c1"># -------------------------- STEPS functions ------------------------------</span>

    <span class="c1"># -------------------------- INFO functions -------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Grigorieff2016&#39;</span><span class="p">]</span></div>

    <span class="c1"># -------------------------- UTILS functions ------------------------------</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">number_of_starts_to_run=2</span>
<span class="sd">number_of_rounds_to_run=40</span>
<span class="sd">active_global_mask_radius=</span>
<span class="sd">active_global_mask_radius = min(active_global_mask_radius, box_size * 0.45f * pixel_size)</span>
<span class="sd">if (active_always_apply_symmetry == true &amp;&amp; symmetry != &quot;C1&quot;) apply_symmetry = true;</span>
<span class="sd">	else apply_symmetry = false</span>

<span class="sd">	// re-randomise the input parameters, and set the default resolution statistics..</span>

<span class="sd">	for (class_counter = 0; class_counter &lt; number_of_classes; class_counter++)</span>
<span class="sd">	{</span>
<span class="sd">		for ( counter = 0; counter &lt; number_of_particles; counter++)</span>
<span class="sd">		{</span>
<span class="sd">			if (number_of_classes == 1) occupancy = 100.0;</span>
<span class="sd">			else occupancy = 100.00 / number_of_classes;</span>

<span class="sd">			/* for a scheme that does not put more views at the top - use :-</span>
<span class="sd">			*/</span>
<span class="sd">			phi = global_random_number_generator.GetUniformRandom() * 180.0;</span>
<span class="sd">			theta = rad_2_deg(acosf(2.0f * fabsf(global_random_number_generator.GetUniformRandom()) - 1.0f));</span>
<span class="sd">			psi = global_random_number_generator.GetUniformRandom() * 180.0;</span>


<span class="sd">			phi = global_random_number_generator.GetUniformRandom() * 180.0;</span>
<span class="sd">			theta = global_random_number_generator.GetUniformRandom() * 180.0;</span>
<span class="sd">			psi = global_random_number_generator.GetUniformRandom() * 180.0;</span>
<span class="sd">			xshift = global_random_number_generator.GetUniformRandom() * 5.0f;</span>
<span class="sd">			yshift = global_random_number_generator.GetUniformRandom() * 5.0f;;</span>
<span class="sd">			score = 0.0;</span>
<span class="sd">			image_is_active = 1;</span>
<span class="sd">			sigma = 1.0;</span>
<span class="sd">		}</span>

<span class="sd">		GenerateDefaultStatistics(estimated_particle_weight_in_kda);</span>
<span class="sd">	}</span>


<span class="sd">---------------</span>
<span class="sd">if (active_auto_set_percent_used == true)</span>
<span class="sd">	{</span>
<span class="sd">		int symmetry_number = ReturnNumberofAsymmetricUnits(active_refinement_package-&gt;symmetry);</span>

<span class="sd">		long number_of_asym_units = number_of_particles;</span>

<span class="sd">		long wanted_start_number_of_asym_units = 2500 * number_of_classes;</span>
<span class="sd">		long wanted_end_number_of_asym_units = 10000 * number_of_classes;</span>

<span class="sd">		// what percentage is this.</span>

<span class="sd">		start_percent_used = (float(wanted_start_number_of_asym_units) / float(number_of_asym_units)) * 100.0;</span>
<span class="sd">		end_percent_used = (float(wanted_end_number_of_asym_units) / float(number_of_asym_units)) * 100.0;</span>

<span class="sd">		symmetry_start_percent_used = (float(wanted_start_number_of_asym_units) / float(number_of_asym_units  * symmetry_number)) * 100.0;</span>
<span class="sd">		symmetry_end_percent_used = (float(wanted_end_number_of_asym_units) / float(number_of_asym_units  * symmetry_number)) * 100.0;</span>

<span class="sd">		if (start_percent_used &gt; 100.0) start_percent_used = 100.0;</span>
<span class="sd">		if (end_percent_used &gt; 100.0) end_percent_used = 100.0;</span>

<span class="sd">		if (symmetry_start_percent_used &gt; 100.0f) symmetry_start_percent_used = 100.0f;</span>
<span class="sd">		if (symmetry_end_percent_used &gt; 100.0) symmetry_end_percent_used = 100.0;</span>

<span class="sd">		//	if (end_percent_used &gt; 25)</span>
<span class="sd">		//	{</span>
<span class="sd">		//		if (number_of_classes &gt; 1) my_parent-&gt;WriteWarningText(wxString::Format(&quot;Warning : Using max %.2f %% of the images per round, this is quite high, you may wish to increase the number of particles or reduce the number of classes&quot;, end_percent_used));</span>
<span class="sd">		//		else my_parent-&gt;WriteWarningText(wxString::Format(&quot;Warning : Using max %.2f %% of the images per round, this is quite high, you may wish to increase the number of particles&quot;, end_percent_used));</span>
<span class="sd">		//	}</span>
<span class="sd">	}</span>
<span class="sd">	else</span>
<span class="sd">	{</span>
<span class="sd">		start_percent_used = active_start_percent_used;</span>
<span class="sd">		end_percent_used = active_end_percent_used;</span>

<span class="sd">		symmetry_start_percent_used = active_start_percent_used;</span>
<span class="sd">		symmetry_end_percent_used = active_start_percent_used;</span>
<span class="sd">	}</span>

<span class="sd">	if (apply_symmetry == false) current_percent_used = start_percent_used;</span>
<span class="sd">	else current_percent_used = symmetry_start_percent_used;</span>
<span class="sd">	</span>
<span class="sd">	current_high_res_limit = active_start_res;</span>
<span class="sd">	next_high_res_limit = current_high_res_limit;</span>

<span class="sd">----------------------</span>
<span class="sd">// are we pre-preparing the stack?</span>

<span class="sd">	if (active_end_res &gt; active_refinement_package-&gt;contained_particles[0].pixel_size * 3.0f )</span>
<span class="sd">	{</span>
<span class="sd">		SetupPrepareStackJob();</span>
<span class="sd">	}</span>
<span class="sd">	else // just start the reconstruction job</span>
<span class="sd">	{</span>
<span class="sd">		stack_has_been_precomputed = false;</span>
<span class="sd">		active_pixel_size = active_refinement_package-&gt;contained_particles[0].pixel_size;</span>
<span class="sd">		active_stack_filename = active_refinement_package-&gt;stack_filename;</span>
<span class="sd">		stack_bin_factor = 1.0f;</span>

<span class="sd">		SetupReconstructionJob();</span>
<span class="sd">	}</span>

<span class="sd">prepare_stack in parallel, but scripted mode only allows 1 job?</span>

<span class="sd">&#39;&#39;&#39;</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dm_facilitiesUpdate/index.html">dm_facilitiesUpdate</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="protocol_abinitio.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>