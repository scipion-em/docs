<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xmipp3.protocols.protocol_compare_reprojections &mdash; Scipion 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Scipion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#image-processing-resources">Image processing resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../xmipp3.html">xmipp3</a> &raquo;</li>
      <li>xmipp3.protocols.protocol_compare_reprojections</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for xmipp3.protocols.protocol_compare_reprojections</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca)</span>
<span class="c1"># *              Estrella Fernandez Gimenez (me.fernandez@cnb.csic.es)</span>
<span class="c1"># *              (produce residuals improved with projection subtraction)</span>
<span class="c1"># *              Daniel Marchan Torres (da.marchan@cnb.csic.es)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="kn">import</span> <span class="n">ProtAnalysis3D</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SetOfClasses2D</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">SetOfAverages</span><span class="p">,</span> <span class="n">SetOfParticles</span><span class="p">,</span>
                          <span class="n">SetOfVolumes</span><span class="p">,</span> <span class="n">SetOfClasses3D</span><span class="p">,</span> <span class="n">Volume</span><span class="p">,</span> <span class="n">EMSet</span><span class="p">,</span> <span class="n">Class3D</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="kn">import</span> <span class="n">ImageHandler</span>
<span class="kn">from</span> <span class="nn">pwem</span> <span class="kn">import</span> <span class="n">emlib</span>

<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="kn">import</span> <span class="n">LEVEL_ADVANCED</span>
<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">UPDATED</span>
<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">VERSION_3_0</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.params</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.path</span> <span class="kn">import</span> <span class="n">cleanPath</span><span class="p">,</span> <span class="n">cleanPattern</span>

<span class="kn">from</span> <span class="nn">xmipp3.base</span> <span class="kn">import</span> <span class="n">ProjMatcher</span>
<span class="kn">from</span> <span class="nn">xmipp3.convert</span> <span class="kn">import</span> <span class="n">setXmippAttributes</span><span class="p">,</span> <span class="n">xmippToLocation</span><span class="p">,</span> <span class="n">getXmippAttribute</span>
<span class="kn">from</span> <span class="nn">..convert</span> <span class="kn">import</span> <span class="n">writeSetOfClasses2D</span><span class="p">,</span> <span class="n">writeSetOfParticles</span>

<span class="n">NEW_SAMPLING_RATE</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">OUTPUTS_FN</span> <span class="o">=</span> <span class="s2">&quot;outputs.txt&quot;</span>

        
<div class="viewcode-block" id="XmippProtCompareReprojections"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections">[docs]</a><span class="k">class</span> <span class="nc">XmippProtCompareReprojections</span><span class="p">(</span><span class="n">ProtAnalysis3D</span><span class="p">,</span> <span class="n">ProjMatcher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compares a set of classes or averages with the corresponding projections of a reference volume.</span>
<span class="sd">    The set of images must have a 3D angular assignment and the protocol computes the residues</span>
<span class="sd">    (the difference between the experimental images and the reprojections). The zscore of the mean</span>
<span class="sd">    and variance of the residues are computed. Large values of these scores may indicate outliers.</span>
<span class="sd">    The protocol also analyze the covariance matrix of the residual and computes the logarithm of</span>
<span class="sd">    its determinant [Cherian2013]. The extremes of this score (called zScoreResCov), that is</span>
<span class="sd">    values particularly low or high, may indicate outliers.&quot;&quot;&quot;</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;compare reprojections&#39;</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">VERSION_3_0</span>
    <span class="n">_devStatus</span> <span class="o">=</span> <span class="n">UPDATED</span>
    <span class="n">_possibleOutputs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">PARTICLES</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">VOLUME</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BOTH</span> <span class="o">=</span> <span class="mi">2</span>
    

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ProtAnalysis3D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classesInfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># --------------------------- DEFINE param functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputSet2D&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input images&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfClasses2D, SetOfClasses3D, SetOfAverages, SetOfParticles&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputSet3D&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Volume to compare images to&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;Volume, SetOfVolumes, SetOfClasses3D&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Volume to be used for class comparison&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useAssignment&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use input angular assignment (if available)&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;optimizeGray&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Optimize gray scale&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;ignoreCTF&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ignore CTF&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;By ignoring the CTF you will create projections more similar to what a person expects, &#39;</span>
                           <span class="s1">&#39;while by using the CTF you will create projections more similar to what the microscope sees&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doDownSample&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Downsample&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If accepted the input volumes and the input 2d classes will be downsample to 3 A/px. &#39;</span>
                           <span class="s1">&#39;This will help to reduce the computation time.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doEvaluateResiduals&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Evaluate residuals&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If this option is chosen, then the residual covariance matrix is calculated and &#39;</span>
                           <span class="s1">&#39;characterized. But this option takes time and disk space&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;symmetryGroup&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Symmetry group&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;See http://xmipp.cnb.uam.es/twiki/bin/view/Xmipp/Symmetry for a description of the symmetry&#39;</span>
                           <span class="s1">&#39; groups format. If no symmetry is present, give c1&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularSampling&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular sampling rate&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;In degrees.&#39;</span>
                      <span class="s1">&#39; This sampling defines how fine the projection gallery from the volume is explored.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;resol&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filter at resolution: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Resolution (A) at which subtraction will be performed, filtering the volume projections.&#39;</span>
                           <span class="s1">&#39;Value 0 implies no filtering.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Decay of the filter (sigma): &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;resol&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Decay of the filter (sigma parameter) to smooth the mask transition&#39;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Output&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doRanking&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rank the set of Volumes/3D Classes&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If accepted please check that you have an input set with several 3D objects &#39;</span>
                           <span class="s1">&#39;(Classes 3D or Volumes). It will rank all the Volume 3D Class/Volume.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doExtraction&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extract best Volume/3D Class&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doRanking&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If accepted please check that you have an input set with several 3D objects &#39;</span>
                           <span class="s1">&#39;(Classes 3D or Volumes). It will extract the Volume and/or the Particles from &#39;</span>
                           <span class="s1">&#39;the best rated 3D Class/Volume.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;extractOption&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Particles&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Both&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doExtraction and doRanking&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Extraction option&quot;</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_COMBO</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select an option to extract from the 3D Classes: </span><span class="se">\n</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;_Particles_: Extract the set of particles from the selected class. </span><span class="se">\n</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;_Volume_: Extract the volume from the selected class. </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;_Both_: Extract the volume and particles from the selected class.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="c1"># --------------------------- INSERT steps functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert input images if necessary &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialStep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convertStep</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doDownSample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downSampleStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsOrigFn</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useProjMatching</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insertProjMatchStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angularSampling</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">galleryDict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmpDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">volId</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span> <span class="k">for</span> <span class="n">volId</span> <span class="ow">in</span> <span class="n">tmpDict</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">produceResiduals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span><span class="p">,</span>
                                 <span class="n">NEW_SAMPLING_RATE</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doDownSample</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doEvaluateResiduals</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluateResiduals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createOutputStep</span><span class="p">)</span>

    <span class="c1"># --------------------------- STEPS functions ---------------------------------------------------</span>
<div class="viewcode-block" id="XmippProtCompareReprojections.initialStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.initialStep">[docs]</a>    <span class="k">def</span> <span class="nf">initialStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgsOrigFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;residuals.xmd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galleryDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputNamesDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">volSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getWorkingDimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doDownSample</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doDownSample</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span> <span class="o">&lt;</span> <span class="n">NEW_SAMPLING_RATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;residuals_downsample.xmd&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsOrigFn</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volSet</span><span class="p">,</span> <span class="n">EMSet</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">volSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">):</span>
                <span class="n">vid</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTmpPath</span><span class="p">(</span><span class="s2">&quot;volume_</span><span class="si">%d</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;angles_</span><span class="si">%d</span><span class="s1">.xmd&#39;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">galleryDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;gallery_</span><span class="si">%d</span><span class="s1">.stk&#39;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputNamesDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reprojections_vol</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">volSet</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTmpPath</span><span class="p">(</span><span class="s2">&quot;volume_</span><span class="si">%d</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;angles_</span><span class="si">%d</span><span class="s1">.xmd&#39;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">galleryDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;gallery_</span><span class="si">%d</span><span class="s1">.stk&#39;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputNamesDict</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reprojections_vol</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vid</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">OUTPUTS_FN</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
            <span class="k">pass</span>  <span class="c1"># Creates output file for visualizations warnings</span></div>


<div class="viewcode-block" id="XmippProtCompareReprojections.convertStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.convertStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Convert input images (SetOfClasses2D, SetOfAverages and SetOfParticles)</span>
        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">imgsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsOrigFn</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfClasses2D</span><span class="p">):</span>
            <span class="n">writeSetOfClasses2D</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">imgsFn</span><span class="p">,</span> <span class="n">writeParticles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">imgsFn</span><span class="p">)</span>
        <span class="c1"># Convert input volumes (SetOfClasses3D, SetOfVolumes and Volume)</span>
        <span class="n">volSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">volId</span><span class="p">,</span> <span class="n">fnVol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volSet</span><span class="p">,</span> <span class="n">Volume</span><span class="p">):</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">volSet</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">volCl</span> <span class="o">=</span> <span class="n">volSet</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">volId</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volCl</span><span class="p">,</span> <span class="n">Class3D</span><span class="p">):</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">volCl</span><span class="o">.</span><span class="n">getRepresentative</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">volCl</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registering volume </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fnVol</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">)</span>

            <span class="c1"># In case input volume does not match 2D references size (If downsample is activated this is not needed)</span>
            <span class="n">xdimVol</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xdimImg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsImages</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">xdimVol</span> <span class="o">!=</span> <span class="n">xdimImg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doDownSample</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span> <span class="o">=</span> <span class="n">xdimImg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.downSampleStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.downSampleStep">[docs]</a>    <span class="k">def</span> <span class="nf">downSampleStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgsOrigFn</span><span class="p">):</span>
        <span class="c1"># Calculate new sampling rate</span>
        <span class="k">if</span> <span class="n">NEW_SAMPLING_RATE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span> <span class="ow">or</span> <span class="n">NEW_SAMPLING_RATE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span><span class="p">:</span>
            <span class="n">newSamplingRate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The target sampling rate is smaller than the inputs sampling rate, new target sampling rate &quot;</span>
                      <span class="s2">&quot;is set to the biggest one of both inputs </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newSamplingRate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newSamplingRate</span> <span class="o">=</span> <span class="n">NEW_SAMPLING_RATE</span>

        <span class="c1"># Downsample the average 2D classes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span> <span class="o">&lt;</span> <span class="n">newSamplingRate</span><span class="p">:</span>
            <span class="n">imgsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;residuals_downsample.mrcs&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downsampling the input images...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">imgsOrigFn</span><span class="p">,</span> <span class="n">imgsFn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The target sampling rate </span><span class="si">%f</span><span class="s1"> &lt;= </span><span class="si">%f</span><span class="s1"> the current one, skipping downsample for the 2D Images.&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">newSamplingRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateAverages</span><span class="p">))</span>

        <span class="c1"># Downsample Volume/s</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span> <span class="o">&lt;</span> <span class="n">newSamplingRate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downsampling the input volumes...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fnVol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span>  <span class="c1"># Should we store somewhere the resized Vol?</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The target sampling rate </span><span class="si">%f</span><span class="s1"> &lt;= </span><span class="si">%f</span><span class="s1"> the current one, skipping downsample for the 3D Volumes.&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">newSamplingRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplingRateVol</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.insertProjMatchStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.insertProjMatchStep">[docs]</a>    <span class="k">def</span> <span class="nf">insertProjMatchStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumesDict</span><span class="p">,</span> <span class="n">angularSampling</span><span class="p">,</span> <span class="n">symmetryGroup</span><span class="p">,</span> <span class="n">fnAnglesDict</span><span class="p">,</span> <span class="n">galleryDict</span><span class="p">):</span>
        <span class="n">xDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span>
        <span class="k">for</span> <span class="n">volId</span><span class="p">,</span> <span class="n">fnVol</span> <span class="ow">in</span> <span class="n">volumesDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating a gallery of projections for volume </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fnVol</span><span class="p">)</span>
            <span class="n">fnAngles</span> <span class="o">=</span> <span class="n">fnAnglesDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span>
            <span class="n">fnGallery</span> <span class="o">=</span> <span class="n">galleryDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projMatchStepAdapted</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="n">angularSampling</span><span class="p">,</span> <span class="n">symmetryGroup</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">,</span> <span class="n">xDim</span><span class="p">,</span> <span class="n">volId</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.projMatchStepAdapted"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.projMatchStepAdapted">[docs]</a>    <span class="k">def</span> <span class="nf">projMatchStepAdapted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">angularSampling</span><span class="p">,</span> <span class="n">symmetryGroup</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">,</span> <span class="n">xDim</span><span class="p">,</span> <span class="n">volId</span><span class="p">):</span>
        <span class="c1"># Generate gallery of projections</span>
        <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mrc&#39;</span><span class="p">):</span>
            <span class="n">volume</span> <span class="o">+=</span> <span class="s2">&quot;:mrc&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_project_library&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --method fourier 1 0.25 bspline &quot;</span>
                    <span class="s2">&quot;--compute_neighbors --angular_distance -1 --experimental_images </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">,</span> <span class="n">angularSampling</span><span class="p">,</span> <span class="n">symmetryGroup</span><span class="p">,</span> <span class="n">images</span><span class="p">))</span>

        <span class="c1"># Assign angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_projection_matching&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --ref </span><span class="si">%s</span><span class="s2"> --Ri 0 --Ro </span><span class="si">%s</span><span class="s2"> --max_shift 1000 &quot;</span>
                    <span class="s2">&quot;--search5d_shift </span><span class="si">%s</span><span class="s2"> --search5d_step  </span><span class="si">%s</span><span class="s2"> --append&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">xDim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xDim</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xDim</span> <span class="o">/</span> <span class="mi">25</span><span class="p">))))</span>

        <span class="n">cleanPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;gallery_</span><span class="si">%d</span><span class="s1">_sampling.xmd&#39;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">))</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;gallery_</span><span class="si">%d</span><span class="s1">_angles.doc&#39;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">))</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;gallery_</span><span class="si">%d</span><span class="s1">.doc&#39;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">))</span>

        <span class="c1"># Write angles in the original file and sort</span>
        <span class="n">MD</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">MD</span><span class="p">:</span>
            <span class="n">galleryReference</span> <span class="o">=</span> <span class="n">MD</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_REF</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">MD</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE_REF</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%05d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">galleryReference</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">),</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">MD</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.produceResiduals"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.produceResiduals">[docs]</a>    <span class="k">def</span> <span class="nf">produceResiduals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anglesDict</span><span class="p">,</span> <span class="n">tS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnResidualsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">volId</span><span class="p">,</span> <span class="n">fnAngles</span> <span class="ow">in</span> <span class="n">anglesDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">anglesOutFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;anglesCont_</span><span class="si">%d</span><span class="s2">.stk&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="n">projectionsOutFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;projections_</span><span class="si">%d</span><span class="s2">.stk&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnVolDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span>
            <span class="n">xDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --ref </span><span class="si">%s</span><span class="s2"> --optimizeAngles --optimizeShift --max_shift </span><span class="si">%d</span><span class="s2"> --oprojections </span><span class="si">%s</span><span class="s2"> --sampling </span><span class="si">%f</span><span class="s2">&quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span> <span class="n">anglesOutFn</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">xDim</span><span class="o">*</span><span class="mf">0.05</span><span class="p">),</span> <span class="n">projectionsOutFn</span><span class="p">,</span> <span class="n">tS</span><span class="p">)</span>

            <span class="n">fnResiduals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;residuals_</span><span class="si">%d</span><span class="s2">.mrcs&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnResidualsDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span> <span class="o">=</span> <span class="n">fnResiduals</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doEvaluateResiduals</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --oresiduals </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fnResiduals</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreCTF</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --ignoreCTF &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizeGray</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot;--optimizeGray --max_gray_scale 0.95 &quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_continuous_assign2&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.evaluateResiduals"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.evaluateResiduals">[docs]</a>    <span class="k">def</span> <span class="nf">evaluateResiduals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">volId</span><span class="p">,</span> <span class="n">fnResiduals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnResidualsDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Evaluate each image</span>
            <span class="n">fnAutoCorrelations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;autocorrelations_</span><span class="si">%d</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="n">stkAutoCorrelations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;autocorrelations_</span><span class="si">%d</span><span class="s2">.mrcs&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="n">stkResiduals</span> <span class="o">=</span> <span class="n">fnResiduals</span>
            <span class="n">anglesOutFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;anglesCont_</span><span class="si">%d</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_residuals&quot;</span><span class="p">,</span> <span class="s2">&quot; -i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --save_metadata_stack </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">stkResiduals</span><span class="p">,</span> <span class="n">stkAutoCorrelations</span><span class="p">,</span> <span class="n">fnAutoCorrelations</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate rename_column &quot;image imageResidual&quot;&#39;</span>
                        <span class="o">%</span> <span class="n">fnAutoCorrelations</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set join </span><span class="si">%s</span><span class="s1"> imageResidual&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">anglesOutFn</span><span class="p">,</span> <span class="n">fnAutoCorrelations</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAutoCorrelations</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.createOutputStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnImgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.stk&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnImgs</span><span class="p">):</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnImgs</span><span class="p">)</span>

        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">volId</span><span class="p">,</span> <span class="n">anglesFn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anglesDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">imgFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;anglesCont_</span><span class="si">%d</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newAssignmentPerformed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">anglesFn</span><span class="p">)</span>
            <span class="c1"># Special case for 2D classes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfClasses2D</span><span class="p">):</span>
                <span class="n">outputSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfClasses2D</span><span class="p">(</span><span class="n">imgSet</span><span class="o">.</span><span class="n">getImages</span><span class="p">(),</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_vol</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">appendFromClasses</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">updateClassCallback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">clazz</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateClass</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">imgFn</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_classesInfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># For every output you need to reset this value so the _updateClass works</span>
            <span class="c1"># Particles or Averages</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfAverages</span><span class="p">):</span>
                    <span class="n">outputSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfAverages</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_vol</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfParticles</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_vol</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">volId</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">newAssignmentPerformed</span><span class="p">:</span>
                        <span class="n">outputSet</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>

                <span class="n">outputSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">setDim</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xDim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xDim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">setObjLabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># To avoid renaming based on the label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">iterRows</span><span class="p">(</span><span class="n">imgFn</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">MDL_ITEM_ID</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span><span class="p">)</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">updateItemCallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processRow</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNamesDict</span><span class="p">[</span><span class="n">volId</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_possibleOutputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputSet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">outputSet</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="p">,</span> <span class="n">outputSet</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRanking</span><span class="p">:</span>
            <span class="n">bestVolId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeRankingVolumes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_possibleOutputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doExtraction</span><span class="p">:</span>
                <span class="n">volCl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">bestVolId</span><span class="p">)</span>  <span class="c1"># It may be a Volume or a 3D Class</span>
                <span class="n">outputParticles</span><span class="p">,</span> <span class="n">outputVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractElementsFrom3D</span><span class="p">(</span><span class="n">volCl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">outputParticles</span><span class="p">:</span>
                    <span class="n">particlesName</span> <span class="o">=</span> <span class="s2">&quot;particles_bestVol&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">particlesName</span><span class="p">:</span> <span class="n">outputParticles</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="p">,</span> <span class="n">outputParticles</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">outputVol</span><span class="p">:</span>
                    <span class="n">volName</span> <span class="o">=</span> <span class="s2">&quot;bestVolume&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">volName</span><span class="p">:</span> <span class="n">outputVol</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">outputVol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="p">,</span> <span class="n">outputVol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeOutputDict</span><span class="p">()</span>  <span class="c1"># For visualization purpose</span></div>

    <span class="k">def</span> <span class="nf">_updateClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">mdFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Callback to update the class&quot;&quot;&quot;</span>

        <span class="n">classId</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">classId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classesInfo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_classesInfo</span><span class="p">[</span><span class="n">classId</span><span class="p">]</span> <span class="o">=</span> <span class="n">clazz</span>
            <span class="c1"># Get the row</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMdRow</span><span class="p">(</span><span class="n">mdFile</span><span class="p">,</span> <span class="n">classId</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMdRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdFile</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To get a row. Maybe there is way to request a specific row.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">iterRows</span><span class="p">(</span><span class="n">mdFile</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ITEM_ID</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing row </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">mdFile</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_processRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="ow">and</span> <span class="n">particle</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ITEM_ID</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">particle</span><span class="o">.</span><span class="n">_appendItem</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_createItemMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_GRAY_A</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_GRAY_B</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_X</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_Y</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_IDX</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_MASK</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_WEIGHT</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMED</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doEvaluateResiduals</span><span class="p">:</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ZSCORE_RESVAR</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ZSCORE_RESMEAN</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ZSCORE_RESCOV</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__setXmippImage</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;_xmipp_&#39;</span> <span class="o">+</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
                <span class="n">img</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">setLocation</span><span class="p">(</span><span class="n">xmippToLocation</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">label</span><span class="p">)))</span>
        
        <span class="n">__setXmippImage</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">)</span>
        <span class="n">__setXmippImage</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE_REF</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doEvaluateResiduals</span><span class="p">:</span>
            <span class="n">__setXmippImage</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE_RESIDUAL</span><span class="p">)</span>
            <span class="n">__setXmippImage</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE_COVARIANCE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_useProjMatching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine if it is necessary to perform projection matching step (because there is not input alignment)&quot;&quot;&quot;</span>
        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAssignment</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfClasses2D</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfAverages</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">imgSet</span><span class="o">.</span><span class="n">hasAlignmentProj</span><span class="p">())</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfParticles</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">imgSet</span><span class="o">.</span><span class="n">hasAlignmentProj</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_computeResiduals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fnVol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mrc&#39;</span><span class="p">):</span>
            <span class="n">fnVol</span> <span class="o">+=</span> <span class="s1">&#39;:mrc&#39;</span>
        <span class="n">program</span> <span class="o">=</span> <span class="s2">&quot;xmipp_subtract_projection&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --ref </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --save </span><span class="si">%s</span><span class="s1"> --max_resolution </span><span class="si">%f</span><span class="s1"> --sigma </span><span class="si">%d</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;residuals.xmd&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;residual_part&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mrcsresiduals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;residuals.xmd&quot;</span><span class="p">)</span>
        <span class="n">args2</span> <span class="o">=</span> <span class="s2">&quot; -i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mrcsresiduals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnResiduals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span> <span class="n">args2</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fnNewParticles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;images.stk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnNewParticles</span><span class="p">):</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnNewParticles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mrcsresiduals</span><span class="p">):</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">mrcsresiduals</span><span class="p">)</span>
        <span class="n">cleanPattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;residual_part*.stk&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="XmippProtCompareReprojections.computeRankingVolumes"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.computeRankingVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">computeRankingVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputSetDict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ranking the best volumes...&#39;</span><span class="p">)</span>
        <span class="n">resultsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meanCostDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">outname</span><span class="p">,</span> <span class="n">outputSet</span> <span class="ow">in</span> <span class="n">outputSetDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mdLabel</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST</span>
            <span class="n">xmippCostValues</span> <span class="o">=</span> <span class="p">{</span><span class="n">avg</span><span class="o">.</span><span class="n">getObjId</span><span class="p">():</span> <span class="n">getXmippAttribute</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">mdLabel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                               <span class="k">for</span> <span class="n">avg</span> <span class="ow">in</span> <span class="n">outputSet</span><span class="p">}</span>
            <span class="n">resultsDict</span><span class="p">[</span><span class="n">outname</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmippCostValues</span>
            <span class="n">meanCostDict</span><span class="p">[</span><span class="n">outname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">xmippCostValues</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="c1"># Find the key-value pair with the maximum value</span>
        <span class="n">bestVolume</span><span class="p">,</span> <span class="n">bestScore</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">meanCostDict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bestVolume</span> <span class="o">=</span> <span class="n">bestVolume</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">volumeId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bestVolume</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">meanCostDict</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The volume with the best score has id </span><span class="si">%d</span><span class="s2"> and score </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeId</span><span class="p">,</span> <span class="n">bestScore</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeSummaryInfo</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">volumeId</span></div>

    <span class="k">def</span> <span class="nf">_extractElementsFrom3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volCl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extract the elements (particles and/or volume) from the 3D class and create the output &quot;&quot;&quot;</span>
        <span class="n">outputParticles</span><span class="p">,</span> <span class="n">outputVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOutputSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volCl</span><span class="p">,</span> <span class="n">Class3D</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The extraction 3D class have id </span><span class="si">%d</span><span class="s1"> with size </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volCl</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span> <span class="n">volCl</span><span class="o">.</span><span class="n">getSize</span><span class="p">()))</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">volCl</span><span class="o">.</span><span class="n">getRepresentative</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">outputParticles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Go through all items and append them</span>
                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">volCl</span><span class="p">:</span>
                    <span class="n">newImage</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="n">outputParticles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newImage</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The extraction 3D Volume have id </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">volCl</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">volCl</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">outputVol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get the corresponding volume from the 3D class</span>
            <span class="n">outputVol</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">volCl</span><span class="p">)</span>
            <span class="n">outputVol</span><span class="o">.</span><span class="n">setLocation</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">getLocation</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">vol</span><span class="o">.</span><span class="n">hasOrigin</span><span class="p">():</span>
                <span class="n">outputVol</span><span class="o">.</span><span class="n">setOrigin</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">getOrigin</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">outputParticles</span><span class="p">,</span> <span class="n">outputVol</span>

    <span class="k">def</span> <span class="nf">_getOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the output sets so they can be filled &quot;&quot;&quot;</span>
        <span class="n">outputParticles</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">outputVol</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractOption</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARTICLES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating set of particles&quot;</span><span class="p">)</span>
            <span class="n">outputParticles</span> <span class="o">=</span> <span class="n">createSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractOption</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">VOLUME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating volume&quot;</span><span class="p">)</span>
            <span class="n">outputVol</span> <span class="o">=</span> <span class="n">createRepresentativeVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Both</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating both the volume and the set of particles&quot;</span><span class="p">)</span>
            <span class="n">outputParticles</span> <span class="o">=</span> <span class="n">createSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">())</span>
            <span class="n">outputVol</span> <span class="o">=</span> <span class="n">createRepresentativeVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">outputParticles</span><span class="p">,</span> <span class="n">outputVol</span>


<div class="viewcode-block" id="XmippProtCompareReprojections.getOutputNamesDict"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.getOutputNamesDict">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputNamesDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNamesDict</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.writeOutputDict"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.writeOutputDict">[docs]</a>    <span class="k">def</span> <span class="nf">writeOutputDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a dictionary to a text file.&quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputNamesDict</span><span class="p">()</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">OUTPUTS_FN</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtCompareReprojections.readOutputDict"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.XmippProtCompareReprojections.readOutputDict">[docs]</a>    <span class="k">def</span> <span class="nf">readOutputDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a dictionary from a text file.&quot;&quot;&quot;</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">OUTPUTS_FN</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dictionary</span></div>

    <span class="c1"># --------------------------- INFO functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Images evaluated: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">())</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Volume: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">getNameId</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_storeSummaryInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rankingMsg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rankingMsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRanking</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">EMSet</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The input 3D must be a Set of Volumes or 3D classes to run the ranking option.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doExtraction</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfVolumes</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extractOption</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARTICLES</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractOption</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)):</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The input 3D must be a Set of Classes 3D in order to extract its particles. &quot;</span>
                                  <span class="s2">&quot;Please change to extract Volume option.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputParticles&#39;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;We evaluated </span><span class="si">%i</span><span class="s2"> input images </span><span class="si">%s</span><span class="s2"> regarding to volume </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputSet2D&#39;</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputSet3D&#39;</span><span class="p">)))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The residuals were evaluated according to their mean, variance and covariance structure &quot;</span>
                           <span class="s2">&quot;[Cherian2013].&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">methods</span>
    
    <span class="c1"># --------------------------- UTILS functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_getDimensionsImages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet2D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">SetOfClasses2D</span><span class="p">):</span>
            <span class="n">xDim</span> <span class="o">=</span> <span class="n">imgSet</span><span class="o">.</span><span class="n">getImages</span><span class="p">()</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xDim</span> <span class="o">=</span> <span class="n">imgSet</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xDim</span>

    <span class="k">def</span> <span class="nf">_getDimensionsVol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">volSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputSet3D</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volSet</span><span class="p">,</span> <span class="n">EMSet</span><span class="p">):</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">volSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">volSet</span>
        <span class="n">xDimVol</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xDimVol</span>

    <span class="k">def</span> <span class="nf">_getWorkingDimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srImages</span><span class="p">,</span> <span class="n">srVol</span><span class="p">,</span> <span class="n">doDownSample</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">doDownSample</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srImages</span> <span class="o">&lt;</span> <span class="n">srVol</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">NEW_SAMPLING_RATE</span> <span class="o">&lt;</span> <span class="n">srVol</span><span class="p">:</span>
                    <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsVol</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">srVol</span> <span class="o">/</span> <span class="n">NEW_SAMPLING_RATE</span>
                    <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsVol</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">NEW_SAMPLING_RATE</span> <span class="o">&lt;</span> <span class="n">srImages</span><span class="p">:</span>
                    <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsImages</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">srImages</span> <span class="o">/</span> <span class="n">NEW_SAMPLING_RATE</span>
                    <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsImages</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srImages</span> <span class="o">&lt;</span> <span class="n">srVol</span><span class="p">:</span>
                <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsVol</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newDim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDimensionsImages</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newDim</span></div>

<span class="c1">#  ---------------------------- HELPERS --------------------------------------</span>
<div class="viewcode-block" id="createRepresentativeVolume"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.createRepresentativeVolume">[docs]</a><span class="k">def</span> <span class="nf">createRepresentativeVolume</span><span class="p">(</span><span class="n">classesSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a Volume from the corresponding set from the representative of a set of classes &quot;&quot;&quot;</span>
    <span class="n">volInput</span> <span class="o">=</span> <span class="n">classesSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">Volume</span><span class="p">()</span>  <span class="c1"># Create an instance of the volume</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">volInput</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vol</span></div>


<div class="viewcode-block" id="createSetOfParticles"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_compare_reprojections.html#xmipp3.protocols.protocol_compare_reprojections.createSetOfParticles">[docs]</a><span class="k">def</span> <span class="nf">createSetOfParticles</span><span class="p">(</span><span class="n">classesSet</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates the corresponding set of particles from the input set of classes &quot;&quot;&quot;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">classesSet</span><span class="o">.</span><span class="n">getImages</span><span class="p">()</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">SetOfParticles</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">outputPath</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="n">particles</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">particles</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scipion team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>