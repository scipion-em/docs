<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xmipp3.protocols.protocol_ctf_consensus &mdash; Scipion 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Scipion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#image-processing-resources">Image processing resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../xmipp3.html">xmipp3</a> &raquo;</li>
      <li>xmipp3.protocols.protocol_ctf_consensus</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for xmipp3.protocols.protocol_ctf_consensus</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (jmdelarosa@cnb.csic.es)</span>
<span class="c1"># *              Roberto Marabini (roberto@cnb.csic.es)</span>
<span class="c1"># *              Tomas Majtner (tmajtner@cnb.csic.es)  -- streaming version</span>
<span class="c1"># *              Amaya Jimenez (ajimenez@cnb.csic.es)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">cmath</span> <span class="kn">import</span> <span class="n">rect</span><span class="p">,</span> <span class="n">phase</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">degrees</span>

<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">VERSION_3_0</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="kn">import</span> <span class="n">SetOfCTF</span><span class="p">,</span> <span class="n">SetOfMicrographs</span>
<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Pointer</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>

<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="kn">import</span> <span class="n">ProtCTFMicrographs</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.metadata</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="kn">import</span> <span class="p">(</span><span class="n">STATUS_NEW</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">BETA</span><span class="p">,</span> <span class="n">UPDATED</span><span class="p">,</span> <span class="n">NEW</span><span class="p">,</span> <span class="n">PROD</span>

<span class="kn">from</span> <span class="nn">pwem</span> <span class="kn">import</span> <span class="n">emlib</span>
<span class="kn">import</span> <span class="nn">xmipp3</span>
<span class="kn">from</span> <span class="nn">xmipp3.convert</span> <span class="kn">import</span> <span class="n">setXmippAttribute</span><span class="p">,</span> <span class="n">getScipionObj</span>

<span class="n">ACCEPTED</span> <span class="o">=</span> <span class="s1">&#39;Accepted&#39;</span>
<span class="n">DISCARDED</span> <span class="o">=</span> <span class="s1">&#39;Discarded&#39;</span>
<span class="n">INPUT1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">INPUT2</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="XmippProtCTFConsensus"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus">[docs]</a><span class="k">class</span> <span class="nc">XmippProtCTFConsensus</span><span class="p">(</span><span class="n">ProtCTFMicrographs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Protocol to make a selection of meaningful CTFs in basis of the defocus</span>
<span class="sd">    values, the astigmatism, the resolution, other Xmipp parameters, and</span>
<span class="sd">    the agreement with a secondary CTF for the same set of micrographs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;ctf consensus&#39;</span>
    <span class="n">_devStatus</span> <span class="o">=</span> <span class="n">UPDATED</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">VERSION_3_0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">ProtCTFMicrographs</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">STEPS_PARALLEL</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputCTF&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfCTF&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input CTF&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the estimated CTF to evaluate&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useDefocus&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use Defocus for selection&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this button to decide if carry out the &#39;</span>
                           <span class="s1">&#39;selection taking into account or not the defocus &#39;</span>
                           <span class="s1">&#39;values.&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Defocus (A)&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useDefocus&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum and maximum values for defocus in &#39;</span>
                                 <span class="s1">&#39;Angstroms.</span><span class="se">\n</span><span class="s1">Micrographs out of this range &#39;</span>
                                 <span class="s1">&#39;will left out of the output.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minDefocus&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maxDefocus&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useAstigmatism&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use Astigmatism for selection&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this button to decide if carry out the &#39;</span>
                           <span class="s1">&#39;selection taking into account or not the &#39;</span>
                           <span class="s1">&#39;astigmatism value.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;astigmatism&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Astigmatism (A)&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useAstigmatism&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum value allowed for astigmatism in &#39;</span>
                           <span class="s1">&#39;Angstroms. If the evaluated CTF has a &#39;</span>
                           <span class="s1">&#39;larger Astigmatism, it will be discarded.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useAstigmatismPercentage&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use Astigmatism percentage for selection&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this button to decide if carry out the &#39;</span>
                           <span class="s1">&#39;selection taking into account or not the &#39;</span>
                           <span class="s1">&#39;astigmatism value.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;astigmatismPer&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Astigmatism percentage&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useAstigmatismPercentage&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum value allowed for astigmatism &#39;</span>
                           <span class="s1">&#39;percentage (|defocus_U-defocus_V|/mean_defocus). If the evaluated CTF has a &#39;</span>
                           <span class="s1">&#39;larger Astigmatism Percentage, it will be discarded.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useResolution&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use Resolution for selection&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this button to decide if carry out the &#39;</span>
                           <span class="s1">&#39;selection taking into account or not the &#39;</span>
                           <span class="s1">&#39;resolution value.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Resolution (A)&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useResolution&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum value for resolution in Angstroms. &#39;</span>
                           <span class="s1">&#39;If the evaluated CTF has not reached that minimum, &#39;</span>
                           <span class="s1">&#39;it will be discarded.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Xmipp criteria&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useCritXmipp&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use Xmipp criteria for selection&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this button to decide if carrying out the &#39;</span>
                           <span class="s1">&#39;selection taking into account the Xmipp parameters.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Only available when Xmipp CTF estimation was used &#39;</span>
                           <span class="s1">&#39;for the _Input CTF_ or for the _Secondary CTF_.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;critFirstZero&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum 1st zero&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimun value of CritFirstZero&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;First zero astigmatism&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum and maximum values for &#39;</span>
                                 <span class="s1">&#39;CritFirstZeroRatio&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minCritFirstZeroRatio&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maxCritFirstZeroRatio&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;critCorr&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Correlation 1st-3rd zero&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum value of correlation between 1st and 3rd zeros&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;critCtfMargin&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;CTF Margin&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum value of CritCtfMargin&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;critIceness&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;CritIceness&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum value of the iceness.&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Non astigmatic validity&#39;</span><span class="p">,</span>
                            <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;useCritXmipp&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum and maximum values for &#39;</span>
                                 <span class="s1">&#39;CritNonAstigmaticValidity&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minCritNonAstigmaticValidity&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maxCritNonAstigmaticValidity&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Consensus&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;calculateConsensus&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Calculate Consensus Resolution&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Option for calculating consensus resolution. &#39;</span>
                           <span class="s1">&#39;The algorithm assumes that two CTF are &#39;</span>
                           <span class="s1">&#39;consistent if the phase (wave aberration function) &#39;</span>
                           <span class="s1">&#39;of the two CTFs are closer than 90 degrees.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;The reported consensusResolution is the resolution &#39;</span>
                           <span class="s1">&#39;at which the two CTF phases differ in 90 degrees.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputCTF2&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfCTF&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;calculateConsensus&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Secondary CTF&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CTF to be compared with reference CTF&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minConsResol&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;calculateConsensus&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum consensus resolution (A).&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum value for the consensus resolution in &quot;</span>
                           <span class="s2">&quot;Angstroms.</span><span class="se">\n</span><span class="s2">If there are noticeable discrepancies &quot;</span>
                           <span class="s2">&quot;between the two estimations below this resolution, &quot;</span>
                           <span class="s2">&quot;it will be discarded.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;averageDefocus&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;calculateConsensus&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Average equivalent metadata?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If *Yes*, making an average of those metadata present &#39;</span>
                           <span class="s1">&#39;in both CTF estimations (defocus, astigmatism angle...)</span><span class="se">\n</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;If *No*, the primary estimation metadata will persist.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;includeSecondary&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;calculateConsensus&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Include all secondary metadata?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If *Yes*, all metadata in the *Secondary CTF* will &#39;</span>
                           <span class="s1">&#39;be included in the resulting CTF.</span><span class="se">\n</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;If *No*, only the primary metadata (plus consensus &#39;</span>
                           <span class="s1">&#39;scores) will be in the resulting CTF.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------- INSERT steps functions -------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializeParams</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctfFn2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF2</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">ctfSteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkNewInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createOutputStep&#39;</span><span class="p">,</span>
                                 <span class="n">prerequisites</span><span class="o">=</span><span class="n">ctfSteps</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="XmippProtCTFConsensus.createOutputStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="XmippProtCTFConsensus.initializeParams"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.initializeParams">[docs]</a>    <span class="k">def</span> <span class="nf">initializeParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializeRejDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSecondaryAttributes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_getFirstJoinStepName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This function will be used for streaming, to check which is</span>
        <span class="c1"># the first function that need to wait for all ctfs</span>
        <span class="c1"># to have completed, this can be overriden in subclasses</span>
        <span class="c1"># (e.g., in Xmipp &#39;sortPSDStep&#39;)</span>
        <span class="k">return</span> <span class="s1">&#39;createOutputStep&#39;</span>

    <span class="k">def</span> <span class="nf">_getFirstJoinStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">funcName</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStepName</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_insertNewCtfsSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newIDs1</span><span class="p">,</span> <span class="n">newIDs2</span><span class="p">,</span> <span class="n">insertedDict</span><span class="p">):</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">newIDs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">newIDs1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">newIDs2</span><span class="p">)))</span>
        <span class="n">md1</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
        <span class="n">md2</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ctfID</span> <span class="ow">in</span> <span class="n">newIDs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ctfID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">insertedDict</span><span class="p">:</span>
                <span class="n">ctf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctfID</span><span class="p">)</span>
                <span class="n">ctf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctfID</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ctfToMd</span><span class="p">(</span><span class="n">ctf1</span><span class="p">,</span> <span class="n">md1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ctfToMd</span><span class="p">(</span><span class="n">ctf2</span><span class="p">,</span> <span class="n">md2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">[</span><span class="n">ctfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">errorMaxFreqCTFs2D</span><span class="p">(</span><span class="n">md1</span><span class="p">,</span> <span class="n">md2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading ctf for id:</span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ctfID</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">[</span><span class="n">ctfID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999</span>

                <span class="n">stepId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;selectCtfStep&#39;</span><span class="p">,</span> <span class="n">ctfID</span><span class="p">,</span>
                                                  <span class="n">prerequisites</span><span class="o">=</span><span class="p">[])</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepId</span><span class="p">)</span>
                <span class="n">insertedDict</span><span class="p">[</span><span class="n">ctfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepId</span>

        <span class="k">return</span> <span class="n">deps</span>

    <span class="k">def</span> <span class="nf">_insertNewSelectionSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insertedDict</span><span class="p">,</span> <span class="n">newIDs</span><span class="p">):</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># For each ctf insert the step to process it</span>
        <span class="k">for</span> <span class="n">ctfID</span> <span class="ow">in</span> <span class="n">newIDs</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">ctfID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">insertedDict</span><span class="p">:</span>
                <span class="n">stepId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;selectCtfStep&#39;</span><span class="p">,</span> <span class="n">ctfID</span><span class="p">,</span>
                                                  <span class="n">prerequisites</span><span class="o">=</span><span class="p">[])</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepId</span><span class="p">)</span>
                <span class="n">insertedDict</span><span class="p">[</span><span class="n">ctfID</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepId</span>
        <span class="k">return</span> <span class="n">deps</span>

    <span class="k">def</span> <span class="nf">_stepsCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkNewInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkNewOutput</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_checkNewInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
            <span class="c1"># Check if there are new ctf to process from the input set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lastCheck&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">mTime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span><span class="p">)),</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn2</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Last check: </span><span class="si">%s</span><span class="s1">, modification: </span><span class="si">%s</span><span class="s1">&#39;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">prettyTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span><span class="p">),</span>
                          <span class="n">pwutils</span><span class="o">.</span><span class="n">prettyTime</span><span class="p">(</span><span class="n">mTime</span><span class="p">)))</span>
            <span class="c1"># If the input movies.sqlite have not changed since our last check,</span>
            <span class="c1"># it does not make sense to check for new input data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">&gt;</span> <span class="n">mTime</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputCTF&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTFDiscarded&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">ctfsSet1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span><span class="p">)</span>
            <span class="n">ctfsSet2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn2</span><span class="p">)</span>

            <span class="n">ctfDict1</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">():</span> <span class="n">ctf</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">ctf</span>
                        <span class="ow">in</span> <span class="n">ctfsSet1</span><span class="o">.</span><span class="n">iterItems</span><span class="p">()}</span>

            <span class="n">ctfDict2</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">():</span> <span class="n">ctf</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">ctf</span>
                        <span class="ow">in</span> <span class="n">ctfsSet2</span><span class="o">.</span><span class="n">iterItems</span><span class="p">()}</span>

            <span class="n">newIds1</span> <span class="o">=</span> <span class="p">[</span><span class="n">idCTF1</span> <span class="k">for</span> <span class="n">idCTF1</span> <span class="ow">in</span> <span class="n">ctfDict1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idCTF1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ctfDict1</span><span class="p">)</span>

            <span class="n">newIds2</span> <span class="o">=</span> <span class="p">[</span><span class="n">idCTF2</span> <span class="k">for</span> <span class="n">idCTF2</span> <span class="ow">in</span> <span class="n">ctfDict2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idCTF2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ctfDict2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isStreamClosed</span> <span class="o">=</span> <span class="n">ctfsSet1</span><span class="o">.</span><span class="n">isStreamClosed</span><span class="p">()</span> <span class="ow">and</span> \
                                  <span class="n">ctfsSet2</span><span class="o">.</span><span class="n">isStreamClosed</span><span class="p">()</span>
            <span class="n">ctfsSet1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">ctfsSet2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">outputStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStep</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">)):</span>
                <span class="n">fDeps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertNewCtfsSteps</span><span class="p">(</span><span class="n">newIds1</span><span class="p">,</span> <span class="n">newIds2</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">outputStep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">outputStep</span><span class="o">.</span><span class="n">addPrerequisites</span><span class="p">(</span><span class="o">*</span><span class="n">fDeps</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateSteps</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lastCheck&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
            <span class="n">mTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Last check: </span><span class="si">%s</span><span class="s1">, modification: </span><span class="si">%s</span><span class="s1">&#39;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">prettyTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span><span class="p">),</span>
                          <span class="n">pwutils</span><span class="o">.</span><span class="n">prettyTime</span><span class="p">(</span><span class="n">mTime</span><span class="p">)))</span>
            <span class="c1"># If the input ctfs.sqlite have not changed since our last check,</span>
            <span class="c1"># it does not make sense to check for new input data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">&gt;</span> <span class="n">mTime</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputCTF&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTFDiscarded&quot;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Open input ctfs.sqlite and close it as soon as possible</span>
            <span class="n">ctfSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span><span class="p">)</span>
            <span class="n">ctfDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">():</span> <span class="n">ctf</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">ctf</span>
                        <span class="ow">in</span> <span class="n">ctfSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">()}</span>

            <span class="n">newIds</span> <span class="o">=</span> <span class="p">[</span><span class="n">idCTF</span> <span class="k">for</span> <span class="n">idCTF</span> <span class="ow">in</span> <span class="n">ctfDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idCTF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ctfDict</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">isStreamClosed</span> <span class="o">=</span> <span class="n">ctfSet</span><span class="o">.</span><span class="n">isStreamClosed</span><span class="p">()</span>
            <span class="n">ctfSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lastCheck</span> <span class="o">=</span> <span class="n">now</span>
            <span class="n">newCtf</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span> <span class="k">for</span> <span class="n">ctf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">outputStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStep</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">newCtf</span><span class="p">:</span>
                <span class="n">fDeps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertNewSelectionSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insertedDict</span><span class="p">,</span>
                                                      <span class="n">newIds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">outputStep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">outputStep</span><span class="o">.</span><span class="n">addPrerequisites</span><span class="p">(</span><span class="o">*</span><span class="n">fDeps</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateSteps</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_checkNewOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check for already selected CTF and update the output set. &quot;&quot;&quot;</span>

        <span class="c1"># Load previously done items (from text file)</span>
        <span class="n">doneListDiscarded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readCertainDoneList</span><span class="p">(</span><span class="n">DISCARDED</span><span class="p">)</span>
        <span class="n">doneListAccepted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readCertainDoneList</span><span class="p">(</span><span class="n">ACCEPTED</span><span class="p">)</span>

        <span class="c1"># Check for newly done items</span>
        <span class="n">ctfListIdAccepted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readtCtfId</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ctfListIdDiscarded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readtCtfId</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">newDoneAccepted</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctfId</span> <span class="k">for</span> <span class="n">ctfId</span> <span class="ow">in</span> <span class="n">ctfListIdAccepted</span>
                           <span class="k">if</span> <span class="n">ctfId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doneListAccepted</span><span class="p">]</span>
        <span class="n">newDoneDiscarded</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctfId</span> <span class="k">for</span> <span class="n">ctfId</span> <span class="ow">in</span> <span class="n">ctfListIdDiscarded</span>
                            <span class="k">if</span> <span class="n">ctfId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doneListDiscarded</span><span class="p">]</span>

        <span class="n">firstTimeAccepted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneListAccepted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">firstTimeDiscarded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneListDiscarded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">allDone</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneListAccepted</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneListDiscarded</span><span class="p">)</span> <span class="o">+</span>\
                  <span class="nb">len</span><span class="p">(</span><span class="n">newDoneAccepted</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDoneDiscarded</span><span class="p">)</span>

        <span class="c1"># We have finished when there is not more input ctf (stream closed)</span>
        <span class="c1"># and the number of processed ctf is equal to the number of inputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
            <span class="n">maxCtfSize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxCtfSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isStreamClosed</span> <span class="ow">and</span> <span class="n">allDone</span> <span class="o">==</span> <span class="n">maxCtfSize</span><span class="p">)</span>

        <span class="n">streamMode</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">STREAM_CLOSED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="k">else</span> <span class="n">Set</span><span class="o">.</span><span class="n">STREAM_OPEN</span>


        <span class="k">def</span> <span class="nf">readOrCreateOutputs</span><span class="p">(</span><span class="n">doneList</span><span class="p">,</span> <span class="n">newDone</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDone</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadOutputSet</span><span class="p">(</span><span class="n">SetOfCTF</span><span class="p">,</span> <span class="s1">&#39;ctfs&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">)</span>
                <span class="n">mSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadOutputSet</span><span class="p">(</span><span class="n">SetOfMicrographs</span><span class="p">,</span>
                                             <span class="s1">&#39;micrographs&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ACCEPTED</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">DISCARDED</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fillOutput</span><span class="p">(</span><span class="n">cSet</span><span class="p">,</span> <span class="n">mSet</span><span class="p">,</span> <span class="n">newDone</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">cSet</span><span class="p">,</span> <span class="n">mSet</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">ctfSet</span><span class="p">,</span> <span class="n">micSet</span> <span class="o">=</span> <span class="n">readOrCreateOutputs</span><span class="p">(</span><span class="n">doneListAccepted</span><span class="p">,</span> <span class="n">newDoneAccepted</span><span class="p">)</span>
        <span class="n">ctfSetDiscarded</span><span class="p">,</span> <span class="n">micSetDiscarded</span> <span class="o">=</span> <span class="n">readOrCreateOutputs</span><span class="p">(</span><span class="n">doneListDiscarded</span><span class="p">,</span>
                                                               <span class="n">newDoneDiscarded</span><span class="p">,</span>
                                                               <span class="n">DISCARDED</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newDoneDiscarded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newDoneAccepted</span><span class="p">:</span>
            <span class="c1"># If we are not finished and no new output have been produced</span>
            <span class="c1"># it does not make sense to proceed and updated the outputs</span>
            <span class="c1"># so we exit from the function here</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">updateRelationsAndClose</span><span class="p">(</span><span class="n">cSet</span><span class="p">,</span> <span class="n">mSet</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;ctfs&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.sqlite&#39;</span><span class="p">)):</span>

                <span class="n">micsAttrName</span> <span class="o">=</span> <span class="s1">&#39;outputMicrographs&#39;</span><span class="o">+</span><span class="n">label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="n">micsAttrName</span><span class="p">,</span> <span class="n">mSet</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>
                <span class="c1"># Set micrograph as pointer to protocol to prevent pointee end up as another attribute (String, Booelan,...)</span>
                <span class="c1"># that happens somewhere while scheduling.</span>
                <span class="n">cSet</span><span class="o">.</span><span class="n">setMicrographs</span><span class="p">(</span><span class="n">Pointer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="n">micsAttrName</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="s1">&#39;outputCTF&#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">cSet</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">(),</span>
                                                  <span class="n">mSet</span><span class="p">)</span>
                    <span class="c1"># self._defineTransformRelation(cSet, mSet)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="p">,</span> <span class="n">cSet</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_defineCtfRelation</span><span class="p">(</span><span class="n">mSet</span><span class="p">,</span> <span class="n">cSet</span><span class="p">)</span>

                <span class="n">mSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">cSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">updateRelationsAndClose</span><span class="p">(</span><span class="n">ctfSet</span><span class="p">,</span> <span class="n">micSet</span><span class="p">,</span> <span class="n">firstTimeAccepted</span><span class="p">)</span>
        <span class="n">updateRelationsAndClose</span><span class="p">(</span><span class="n">ctfSetDiscarded</span><span class="p">,</span> <span class="n">micSetDiscarded</span><span class="p">,</span>
                                <span class="n">firstTimeDiscarded</span><span class="p">,</span> <span class="n">DISCARDED</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>  <span class="c1"># Unlock createOutputStep if finished all jobs</span>
            <span class="n">outputStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStep</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">outputStep</span> <span class="ow">and</span> <span class="n">outputStep</span><span class="o">.</span><span class="n">isWaiting</span><span class="p">():</span>
                <span class="n">outputStep</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">STATUS_NEW</span><span class="p">)</span>


<div class="viewcode-block" id="XmippProtCTFConsensus.fillOutput"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.fillOutput">[docs]</a>    <span class="k">def</span> <span class="nf">fillOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfSet</span><span class="p">,</span> <span class="n">micSet</span><span class="p">,</span> <span class="n">newDone</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">newDone</span><span class="p">:</span>
            <span class="n">inputCtfSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
                <span class="n">inputCtfSet2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctfFn2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ctfId</span> <span class="ow">in</span> <span class="n">newDone</span><span class="p">:</span>
                <span class="n">ctf</span> <span class="o">=</span> <span class="n">inputCtfSet</span><span class="p">[</span><span class="n">ctfId</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">mic</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getMicrograph</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

                <span class="n">ctf</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getEnable</span><span class="p">(</span><span class="n">ctfId</span><span class="p">))</span>
                <span class="n">mic</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getEnable</span><span class="p">(</span><span class="n">ctfId</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
                    <span class="n">ctf2</span> <span class="o">=</span> <span class="n">inputCtfSet2</span><span class="p">[</span><span class="n">ctfId</span><span class="p">]</span>
                    <span class="n">conRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">[</span><span class="n">ctfId</span><span class="p">]</span>
                    <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_consensus_resolution&#39;</span><span class="p">,</span> <span class="n">conRes</span><span class="p">)</span>
                    <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_defocus_diff&#39;</span><span class="p">,</span>
                                 <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span><span class="o">-</span><span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()),</span>
                                     <span class="nb">abs</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()</span><span class="o">-</span><span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">())))</span>
                    <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_defocusAngle_diff&#39;</span><span class="p">,</span>
                                 <span class="n">anglesDifference</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusAngle</span><span class="p">(),</span>
                                                  <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusAngle</span><span class="p">()))</span>
                    <span class="k">if</span> <span class="n">ctf</span><span class="o">.</span><span class="n">hasPhaseShift</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">hasPhaseShift</span><span class="p">():</span>
                        <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_phaseShift_diff&#39;</span><span class="p">,</span>
                                     <span class="n">anglesDifference</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getPhaseShift</span><span class="p">(),</span>
                                                      <span class="n">ctf2</span><span class="o">.</span><span class="n">getPhaseShift</span><span class="p">()))</span>

                    <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_resolution&#39;</span><span class="p">,</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getResolution</span><span class="p">())</span>
                    <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_fitQuality&#39;</span><span class="p">,</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getFitQuality</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfmodel_quadrant&#39;</span><span class="p">):</span>
                        <span class="c1"># To check CTF in Xmipp _quadrant is the best</span>
                        <span class="n">copyAttribute</span><span class="p">(</span><span class="n">ctf2</span><span class="p">,</span> <span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfmodel_quadrant&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_psdFile&#39;</span><span class="p">,</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getPsdFile</span><span class="p">())</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">averageDefocus</span><span class="p">:</span>
                        <span class="n">newDefocusU</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">+</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">())</span>
                        <span class="n">newDefocusV</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()</span> <span class="o">+</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">())</span>
                        <span class="n">newDefocusAngle</span> <span class="o">=</span> <span class="n">averageAngles</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusAngle</span><span class="p">(),</span>
                                                        <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusAngle</span><span class="p">())</span>
                        <span class="n">ctf</span><span class="o">.</span><span class="n">setStandardDefocus</span><span class="p">(</span><span class="n">newDefocusU</span><span class="p">,</span> <span class="n">newDefocusV</span><span class="p">,</span>
                                               <span class="n">newDefocusAngle</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ctf</span><span class="o">.</span><span class="n">hasPhaseShift</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">hasPhaseShift</span><span class="p">():</span>
                            <span class="n">newPhaseShift</span> <span class="o">=</span> <span class="n">averageAngles</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getPhaseShift</span><span class="p">(),</span>
                                                          <span class="n">ctf2</span><span class="o">.</span><span class="n">getPhaseShift</span><span class="p">())</span>
                            <span class="n">ctf</span><span class="o">.</span><span class="n">setPhaseShift</span><span class="p">(</span><span class="n">newPhaseShift</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_defocusRatio&#39;</span><span class="p">,</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusRatio</span><span class="p">())</span>
                        <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_ctf2_astigmatism&#39;</span><span class="p">,</span>
                                     <span class="nb">abs</span><span class="p">(</span><span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctf2</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeSecondary</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondaryAttributes</span><span class="p">:</span>
                            <span class="n">copyAttribute</span><span class="p">(</span><span class="n">ctf2</span><span class="p">,</span> <span class="n">ctf</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

                <span class="c1"># main _astigmatism always but after consensus if so</span>
                <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_astigmatism&#39;</span><span class="p">,</span>
                             <span class="nb">abs</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()))</span>

                <span class="c1"># percentage _astigmatism always but after consensus if so</span>
                <span class="n">astigmatismPer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">+</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()))</span>
                <span class="n">setAttribute</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="s1">&#39;_astigmatismPercentage&#39;</span><span class="p">,</span> <span class="n">astigmatismPer</span><span class="p">)</span>

                <span class="n">ctfSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctf</span><span class="p">)</span>
                <span class="n">micSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mic</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_writeCertainDoneList</span><span class="p">(</span><span class="n">ctfId</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">inputCtfSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
                <span class="n">inputCtfSet2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtCTFConsensus.setSecondaryAttributes"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.setSecondaryAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">setSecondaryAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeSecondary</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span>
            <span class="n">ctf1Attr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF2</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span>
            <span class="n">ctf2Attr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryAttributes</span> <span class="o">=</span> <span class="n">ctf2Attr</span> <span class="o">-</span> <span class="n">ctf1Attr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondaryAttributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_loadOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SetClass</span><span class="p">,</span> <span class="n">baseName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the output set if it exists or create a new one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">baseName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">setFile</span><span class="p">):</span>
            <span class="n">outputSet</span> <span class="o">=</span> <span class="n">SetClass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">setFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outputSet</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pwutils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">setFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">setFile</span><span class="p">):</span>
            <span class="n">outputSet</span> <span class="o">=</span> <span class="n">SetClass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">setFile</span><span class="p">)</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">loadAllProperties</span><span class="p">()</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">enableAppend</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputSet</span> <span class="o">=</span> <span class="n">SetClass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">setFile</span><span class="p">)</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">setStreamState</span><span class="p">(</span><span class="n">outputSet</span><span class="o">.</span><span class="n">STREAM_OPEN</span><span class="p">)</span>

        <span class="n">micSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputSet</span><span class="p">,</span> <span class="n">SetOfMicrographs</span><span class="p">):</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">micSet</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputSet</span><span class="p">,</span> <span class="n">SetOfCTF</span><span class="p">):</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">setMicrographs</span><span class="p">(</span><span class="n">micSet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputSet</span>

    <span class="k">def</span> <span class="nf">_ctfToMd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctf</span><span class="p">,</span> <span class="n">ctfMd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the proper metadata for Xmipp from a given CTF &quot;&quot;&quot;</span>
        <span class="n">ctfMd</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ctfRow</span> <span class="o">=</span> <span class="n">Row</span><span class="p">()</span>
        <span class="n">xmipp3</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">ctfModelToRow</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="n">ctfRow</span><span class="p">)</span>
        <span class="n">xmipp3</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">micrographToRow</span><span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getMicrograph</span><span class="p">(),</span> <span class="n">ctfRow</span><span class="p">,</span>
                                       <span class="n">alignType</span><span class="o">=</span><span class="n">xmipp3</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">ALIGN_NONE</span><span class="p">)</span>
        <span class="n">ctfRow</span><span class="o">.</span><span class="n">addToMd</span><span class="p">(</span><span class="n">ctfMd</span><span class="p">)</span>

<div class="viewcode-block" id="XmippProtCTFConsensus.initializeRejDict"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.initializeRejDict">[docs]</a>    <span class="k">def</span> <span class="nf">initializeRejDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;defocus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;astigmatism&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;astigmatismPer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;singleResolution&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritFirstZero&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritfirstZeroRatio&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritCorr13&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritIceness&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritCtfMargin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;_xmipp_ctfCritNonAstigmaticValidty&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;consensusResolution&#39;</span><span class="p">:</span> <span class="mi">0</span>
                         <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rejBy&quot;</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtCTFConsensus.selectCtfStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.selectCtfStep">[docs]</a>    <span class="k">def</span> <span class="nf">selectCtfStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfId</span><span class="p">):</span>
        <span class="c1"># Depending on the flags selected by the user, we set the values of</span>
        <span class="c1"># the params to compare with</span>

        <span class="n">doneFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCTFDone</span><span class="p">(</span><span class="n">ctfId</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isContinued</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isCTFDone</span><span class="p">(</span><span class="n">ctfId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping CTF with ID: </span><span class="si">%s</span><span class="s2">, seems to be done&quot;</span> <span class="o">%</span> <span class="n">ctfId</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Clean old finished files</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">doneFn</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compareValue</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">crit</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Returns True if the ctf.label NOT complain the crit by comp</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
                    <span class="n">discard</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">crit</span>
                <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s1">&#39;bt&#39;</span><span class="p">:</span>
                    <span class="n">discard</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctf</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">crit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;comp&#39; must be either &#39;lt&#39; or &#39;bt&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found. Skipping evaluation on that.&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">discard</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">discard</span>

        <span class="n">minDef</span><span class="p">,</span> <span class="n">maxDef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDefociValues</span><span class="p">()</span>
        <span class="n">maxAstig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMaxAstisgmatism</span><span class="p">()</span>
        <span class="n">maxAstigPer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMaxAstigmatismPer</span><span class="p">()</span>
        <span class="n">minResol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMinResol</span><span class="p">()</span>

        <span class="n">ctf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allCtf1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctfId</span><span class="p">)</span>

        <span class="n">defocusU</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span>
        <span class="n">defocusV</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">()</span>
        <span class="n">astigm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">defocusU</span> <span class="o">-</span> <span class="n">defocusV</span><span class="p">)</span>
        <span class="n">astigmPer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">defocusU</span> <span class="o">-</span> <span class="n">defocusV</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">defocusU</span><span class="o">+</span><span class="n">defocusV</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">resol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfResol</span><span class="p">(</span><span class="n">ctf</span><span class="p">)</span>

        <span class="n">defRangeCrit</span> <span class="o">=</span> <span class="p">(</span><span class="n">defocusU</span> <span class="o">&lt;</span> <span class="n">minDef</span> <span class="ow">or</span> <span class="n">defocusU</span> <span class="o">&gt;</span> <span class="n">maxDef</span> <span class="ow">or</span>
                        <span class="n">defocusV</span> <span class="o">&lt;</span> <span class="n">minDef</span> <span class="ow">or</span> <span class="n">defocusV</span> <span class="o">&gt;</span> <span class="n">maxDef</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defRangeCrit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;defocus&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">astigCrit</span> <span class="o">=</span> <span class="n">astigm</span> <span class="o">&gt;</span> <span class="n">maxAstig</span>
        <span class="k">if</span> <span class="n">astigCrit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;astigmatism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">astigPer</span> <span class="o">=</span> <span class="p">(</span><span class="n">astigmPer</span> <span class="o">&gt;</span> <span class="n">maxAstigPer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">astigPer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;astigmatismPer&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">singleResolCrit</span> <span class="o">=</span> <span class="n">resol</span> <span class="o">&gt;</span> <span class="n">minResol</span>
        <span class="k">if</span> <span class="n">singleResolCrit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;singleResolution&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">firstCondition</span> <span class="o">=</span> <span class="n">defRangeCrit</span> <span class="ow">or</span> <span class="n">astigCrit</span> <span class="ow">or</span> <span class="n">singleResolCrit</span> <span class="ow">or</span> <span class="n">astigPer</span>

        <span class="n">consResolCrit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
            <span class="c1"># FIXME: this conditional is to avoid an error, but it shouldn&#39;t happen!!!</span>
            <span class="k">if</span> <span class="n">ctfId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">:</span>
                <span class="n">consResolCrit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minConsResol</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">[</span><span class="n">ctfId</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">consResolCrit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;consensusResolution&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consResolCrit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="p">[</span><span class="s1">&#39;consensusResolution&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_freqResol</span><span class="p">[</span><span class="n">ctfId</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999</span>

        <span class="n">secondCondition</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useCritXmipp</span><span class="p">:</span>
            <span class="n">firstZero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCritFirstZero</span><span class="p">()</span>
            <span class="n">minFirstZero</span><span class="p">,</span> <span class="n">maxFirstZero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCritFirstZeroRatio</span><span class="p">()</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCritCorr</span><span class="p">()</span>
            <span class="n">iceness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getIceness</span><span class="p">()</span>
            <span class="n">ctfMargin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCritCtfMargin</span><span class="p">()</span>
            <span class="n">minNonAstigmatic</span><span class="p">,</span> <span class="n">maxNonAstigmatic</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_getCritNonAstigmaticValidity</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmippCTF</span> <span class="o">==</span> <span class="n">INPUT1</span><span class="p">:</span>
                <span class="n">ctfX</span> <span class="o">=</span> <span class="n">ctf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctfX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allCtf2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ctfId</span><span class="p">)</span>


            <span class="n">secondCondition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritFirstZero&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="n">firstZero</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritfirstZeroRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="n">minFirstZero</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritfirstZeroRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="n">maxFirstZero</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritCorr13&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritIceness&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="n">iceness</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritCtfMargin&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="n">ctfMargin</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritNonAstigmaticValidty&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="n">minNonAstigmatic</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">compareValue</span><span class="p">(</span><span class="n">ctfX</span><span class="p">,</span> <span class="s1">&#39;_xmipp_ctfCritNonAstigmaticValidty&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="n">maxNonAstigmatic</span><span class="p">))</span>

        <span class="sd">&quot;&quot;&quot; Write to a text file the items that have been done. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">firstCondition</span> <span class="ow">or</span> <span class="n">consResolCrit</span> <span class="ow">or</span> <span class="n">secondCondition</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileDiscarded</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> F</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileAccepted</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> T</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileAccepted</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> F</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rejBy&quot;</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>
        <span class="c1"># Mark this ctf as finished</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">doneFn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_readDoneList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read from a file the id&#39;s of the items that have been done. &quot;&quot;&quot;</span>
        <span class="n">doneFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getAllDone</span><span class="p">()</span>
        <span class="n">doneList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check what items have been previously done</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">doneFile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doneFile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">doneList</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">doneList</span>

    <span class="k">def</span> <span class="nf">_getAllDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;DONE_all.TXT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_writeDoneList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write to a text file the items that have been done. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getAllDone</span><span class="p">(),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isCTFDone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A mic is done if the marker file exists. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getCTFDone</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_getCTFDone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the file that is used as a flag of termination. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">,</span> <span class="s1">&#39;ctf_</span><span class="si">%06d</span><span class="s1">.TXT&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Marabini2014a&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTF&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTFDiscarded&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;No CTF processed, yet.&#39;</span><span class="p">]</span>

        <span class="n">acceptedSize</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputCTF</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTF&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">discardedSize</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputCTFDiscarded</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
                         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;outputCTFDiscarded&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> CTF processed (</span><span class="si">%d</span><span class="s2"> accepted and </span><span class="si">%d</span><span class="s2"> discarded).&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">acceptedSize</span><span class="o">+</span><span class="n">discardedSize</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">(),</span>
                      <span class="n">acceptedSize</span><span class="p">,</span> <span class="n">discardedSize</span><span class="p">)]</span>

        <span class="k">def</span> <span class="nf">addDiscardedStr</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rejBy</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  (</span><span class="si">%d</span><span class="s2"> discarded)&quot;</span> <span class="o">%</span> <span class="n">number</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">useDefocus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatism</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">useResolution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatismPercentage</span><span class="p">]):</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*General Criteria*:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useDefocus</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Defocus_. Range: </span><span class="si">%.0f</span><span class="s2"> - </span><span class="si">%.0f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minDefocus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDefocus</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;defocus&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatism</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Astigmatism_. Threshold: </span><span class="si">%.0f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astigmatism</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;astigmatism&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatismPercentage</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _AstigmatismPer_. Threshold: </span><span class="si">%.3f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astigmatismPer</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;astigmatismPer&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useResolution</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Resolution_. Threshold: </span><span class="si">%.0f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;singleResolution&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useCritXmipp</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*Xmipp criteria*:&quot;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _First zero_. Threshold: </span><span class="si">%.0f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critFirstZero</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritFirstZero&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _First zero astigmatism_. Range: </span><span class="si">%.2f</span><span class="s2"> - </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minCritFirstZeroRatio</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">maxCritFirstZeroRatio</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritfirstZeroRatio&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Correlation Experimental-Estimated_. Threshold: &quot;</span>
                           <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critCorr</span><span class="p">,</span>
                                        <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritCorr13&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _CTF margin_. Threshold: </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critCtfMargin</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritCtfMargin&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Iceness_. Threshold: </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critIceness</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritIceness&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Non Astigmatic validation range_: </span><span class="si">%.2f</span><span class="s2"> - </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minCritNonAstigmaticValidity</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">maxCritNonAstigmaticValidity</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritNonAstigmaticValidty&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">getProtocolInfo</span><span class="p">(</span><span class="n">inCtf</span><span class="p">):</span>
                <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMapper</span><span class="p">()</span><span class="o">.</span><span class="n">getParent</span><span class="p">(</span><span class="n">inCtf</span><span class="p">)</span>
                <span class="n">runName</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getRunName</span><span class="p">()</span>
                <span class="n">classLabel</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getClassLabel</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">runName</span> <span class="o">==</span> <span class="n">classLabel</span><span class="p">:</span>
                    <span class="n">infoStr</span> <span class="o">=</span> <span class="n">runName</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">infoStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">runName</span><span class="p">,</span> <span class="n">classLabel</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">infoStr</span>

            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*CTF consensus*:&quot;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; - _Consensus resolution. Threshold_: </span><span class="si">%.0f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minConsResol</span><span class="p">,</span>
                              <span class="n">addDiscardedStr</span><span class="p">(</span><span class="s1">&#39;consensusResolution&#39;</span><span class="p">)))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   &gt; _Primary CTF_: </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="n">getProtocolInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   &gt; _Reference CTF_: </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="n">getProtocolInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF2</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function of this hook is to add some validation before the</span>
<span class="sd">        protocol is launched to be executed. It should return a list of</span>
<span class="sd">        errors. If the list is empty the protocol can be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># same micrographs in both CTF??</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useCritXmipp</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingXmipp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xmippCTF</span> <span class="o">=</span> <span class="n">INPUT1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The primary CTF input ( _Input CTF_ ) must be &quot;</span>
                              <span class="s2">&quot;estimated using the _Xmipp - CTF estimation_ &quot;</span>
                              <span class="s2">&quot;protocol.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useCritXmipp</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateConsensus</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingXmipp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xmippCTF</span> <span class="o">=</span> <span class="n">INPUT1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingXmipp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCTF2</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xmippCTF</span> <span class="o">=</span> <span class="n">INPUT2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;One of the CTF inputs ( _Input CTF_ or &quot;</span>
                              <span class="s2">&quot;_Secundary CTF_) must be estimated using the &quot;</span>
                              <span class="s2">&quot;_Xmipp - CTF estimation_ protocol.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>

<div class="viewcode-block" id="XmippProtCTFConsensus.usingXmipp"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.XmippProtCTFConsensus.usingXmipp">[docs]</a>    <span class="k">def</span> <span class="nf">usingXmipp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctf</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctf</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="s1">&#39;_xmipp_ctfCritFirstZero&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_getCtfResol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctf</span><span class="p">):</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getResolution</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_readCertainDoneList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read from a text file the id&#39;s of the items</span>
<span class="sd">        that have been done. &quot;&quot;&quot;</span>
        <span class="n">doneFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCertainDone</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">doneList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check what items have been previously done</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">doneFile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doneFile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">doneList</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">doneList</span>

    <span class="k">def</span> <span class="nf">_writeCertainDoneList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfId</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write to a text file the items that have been done. &quot;&quot;&quot;</span>
        <span class="n">doneFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCertainDone</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doneFile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ctfId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCertainDone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;DONE_&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.TXT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCtfSelecFileAccepted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;selection-ctf-accepted.txt&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCtfSelecFileDiscarded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;selection-ctf-discarded.txt&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_readtCtfId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accepted</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileAccepted</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileDiscarded</span><span class="p">()</span>
        <span class="n">ctfList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check what items have been previously done</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ctfList</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ctfList</span>

    <span class="k">def</span> <span class="nf">_getEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfId</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCtfSelecFileAccepted</span><span class="p">()</span>
        <span class="c1"># Check what items have been previously done</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ctfId</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_loadInputCtfSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfFn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading input db: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ctfFn</span><span class="p">)</span>
        <span class="n">ctfSet</span> <span class="o">=</span> <span class="n">SetOfCTF</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">ctfFn</span><span class="p">)</span>
        <span class="n">ctfSet</span><span class="o">.</span><span class="n">loadAllProperties</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ctfSet</span>

    <span class="k">def</span> <span class="nf">_getDefociValues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useDefocus</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minDefocus</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDefocus</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getMaxAstigmatismPer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatismPercentage</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astigmatismPer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getMaxAstisgmatism</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useAstigmatism</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10000000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astigmatism</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getMinResol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useResolution</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1000000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getIceness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">critIceness</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getCritFirstZero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">critFirstZero</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getCritFirstZeroRatio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minCritFirstZeroRatio</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">maxCritFirstZeroRatio</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getCritCorr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">critCorr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getCritCtfMargin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">critCtfMargin</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getCritNonAstigmaticValidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minCritNonAstigmaticValidity</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxCritNonAstigmaticValidity</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>


<div class="viewcode-block" id="averageAngles"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.averageAngles">[docs]</a><span class="k">def</span> <span class="nf">averageAngles</span><span class="p">(</span><span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">):</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">rect</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle1</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">rect</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle2</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">phase</span><span class="p">((</span><span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span></div>


<div class="viewcode-block" id="anglesDifference"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.anglesDifference">[docs]</a><span class="k">def</span> <span class="nf">anglesDifference</span><span class="p">(</span><span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">angle1</span> <span class="o">&gt;</span> <span class="n">angle2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">angle2</span> <span class="o">-</span> <span class="n">angle1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">):</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">angle1</span>
        <span class="n">angle1</span> <span class="o">=</span> <span class="n">angle2</span>
        <span class="n">angle2</span> <span class="o">=</span> <span class="n">aux</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">angle1</span> <span class="o">-</span> <span class="n">angle2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">180</span></div>


<div class="viewcode-block" id="setAttribute"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.setAttribute">[docs]</a><span class="k">def</span> <span class="nf">setAttribute</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">getScipionObj</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>


<div class="viewcode-block" id="copyAttribute"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_ctf_consensus.html#xmipp3.protocols.protocol_ctf_consensus.copyAttribute">[docs]</a><span class="k">def</span> <span class="nf">copyAttribute</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">setAttribute</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scipion team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>