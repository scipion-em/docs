

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xmipp3.protocols.protocol_deep_micrograph_screen &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/appion/appion.html">appion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atomstructutils/atomstructutils.html">atomstructutils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atsas/atsas.html">atsas package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bamfordlab/bamfordlab.html">bamfordlab package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bsoft/bsoft.html">bsoft package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/ccp4/ccp4.html">ccp4 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/chimera/chimera.html">chimera package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cistem/cistem.html">cistem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryoef/cryoef.html">cryoef package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryosparc2/cryosparc2.html">cryosparc2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dynamo/dynamo.html">dynamo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/eman2/eman2.html">eman2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/emxlib/emxlib.html">emxlib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/fsc3d/fsc3d.html">fsc3d package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gautomatch/gautomatch.html">gautomatch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gctf/gctf.html">gctf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imod/imod.html">imod package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/localrec/localrec.html">localrec package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/locscale/locscale.html">locscale package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/motioncorr/motioncorr.html">motioncorr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/novactf/novactf.html">novactf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/phenix/phenix.html">phenix package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyworkflow/pyworkflow.html">pyworkflow package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pwem/pwem.html">pwem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/relion/relion.html">relion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/resmap/resmap.html">resmap package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/scipion/scipion.html">scipion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/sphire/sphire.html">sphire package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/spider/spider.html">spider package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/tomo/tomo.html">tomo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/topaz/topaz.html">topaz package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/xmipp3/xmipp3.html">xmipp3 package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../xmipp3.html">xmipp3</a> &raquo;</li>
        
      <li>xmipp3.protocols.protocol_deep_micrograph_screen</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xmipp3.protocols.protocol_deep_micrograph_screen</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Ruben Sanchez Garcia (rsanchez@cnb.csic.es)</span>
<span class="c1"># *              David Maluenda (dmaluenda@cnb.csic.es)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="k">import</span> <span class="p">(</span><span class="n">STEPS_PARALLEL</span><span class="p">,</span> <span class="n">STATUS_NEW</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtExtractParticles</span>
<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="k">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Pointer</span>

<span class="kn">from</span> <span class="nn">xmipp3.base</span> <span class="k">import</span> <span class="n">XmippProtocol</span>
<span class="kn">from</span> <span class="nn">xmipp_base</span> <span class="k">import</span> <span class="n">createMetaDataFromPattern</span>
<span class="kn">from</span> <span class="nn">xmipp3.convert</span> <span class="k">import</span> <span class="p">(</span><span class="n">writeMicCoordinates</span><span class="p">,</span> <span class="n">readSetOfCoordinates</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">xmipp3.constants</span> <span class="k">import</span> <span class="n">SAME_AS_PICKING</span><span class="p">,</span> <span class="n">OTHER</span>


<div class="viewcode-block" id="XmippProtDeepMicrographScreen"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen">[docs]</a><span class="k">class</span> <span class="nc">XmippProtDeepMicrographScreen</span><span class="p">(</span><span class="n">ProtExtractParticles</span><span class="p">,</span> <span class="n">XmippProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Protocol to remove coordinates in carbon zones or large impurities&quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;deep micrograph cleaner&#39;</span>
    <span class="n">_conda_env</span><span class="o">=</span> <span class="s2">&quot;xmipp_MicCleaner&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ProtExtractParticles</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">=</span> <span class="n">STEPS_PARALLEL</span>

    <span class="c1">#--------------------------- DEFINE param functions ------------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputCoordinates&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfCoordinates&#39;</span><span class="p">,</span>
                      <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input coordinates&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the SetOfCoordinates &#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;micsSource&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;same as coordinates&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_HLIST</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Micrographs source&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;By default, the micrographs from which the computation &#39;</span>
                           <span class="s1">&#39;will be performed will be the ones used in the picking &#39;</span>
                           <span class="s1">&#39;step ( _same as coordinates_ option ). </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;If you select other option, you must provide &#39;</span>
                           <span class="s1">&#39;a different set of micrographs to evaluate its regions. </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;*Note*: In the _other_ case, ensure that provided &#39;</span>
                           <span class="s1">&#39;micrographs and coordinates are related &#39;</span>
                           <span class="s1">&#39;by micName or by micId. Difference in pixel size &#39;</span>
                           <span class="s1">&#39;will be handled automatically.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;*Note2*: *Particles must be dark* over a bright &#39;</span>
                           <span class="s1">&#39;background. If not, use the _other_ option to provide &#39;</span>
                           <span class="s1">&#39;an inverted setOfMicrograph.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputMicrographs&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfMicrographs&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;micsSource != </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">SAME_AS_PICKING</span><span class="p">,</span>
                      <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input micrographs&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the SetOfMicrographs from which to extract.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useOtherScale&#39;</span><span class="p">,</span><span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;same as coordinates&#39;</span><span class="p">,</span> <span class="s1">&#39;scale to micrographs&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;micsSource != </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">SAME_AS_PICKING</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_HLIST</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Coordinates scale&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If you select _same as coordinates_ option output coordinates &#39;</span>
                           <span class="s1">&#39;will be mapped to the original micrographs and thus, they will preserve &#39;</span>
                           <span class="s1">&#39;the scale.</span><span class="se">\n</span><span class="s1">If you select _scale to micrographs_ option, output coordinates &#39;</span>
                           <span class="s1">&#39;will be mapped to the new micrographs and rescaled accordingly.&#39;</span><span class="p">)</span>


        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Threshold&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Deep learning goodness score to select/discard coordinates. The bigger the threshold &quot;</span><span class="o">+</span>
                           <span class="s2">&quot;the more coordiantes will be ruled out. Ranges from 0 to 1. Use -1 to skip thresholding. &quot;</span><span class="o">+</span>
                           <span class="s2">&quot;Manual thresholding can be performed after execution through analyze results button. &quot;</span><span class="o">+</span>
                           <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">0.75 &lt;= Recommended threshold &lt;= 0.9&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;streamingBatchSize&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Batch size&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This value allows to group several items to be &quot;</span>
                           <span class="s2">&quot;processed inside the same protocol step. You can &quot;</span>
                           <span class="s2">&quot;use the following values: </span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;*0*    Put in the same step all the items  available.</span><span class="se">\n</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;*&gt;1*   The number of items that will be grouped into &quot;</span>
                           <span class="s2">&quot;a step. -1, automatic decission&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;saveMasks&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;saveMasks&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save predicted masks?&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">USE_GPU</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Use GPU for execution&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This protocol has both CPU and GPU implementation. &quot;</span>
                            <span class="s2">&quot;Select the one you want to use. CPU may become &quot;</span>
                            <span class="s2">&quot;quite slow.&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">GPU_LIST</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Choose GPU IDs&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add a list of GPU devices that can be used.&quot;</span><span class="p">)</span>

        <span class="c1"># form.addParallelSection(threads=4, mpi=1)</span>
    
    <span class="c1">#--------------------------- INSERT steps functions ------------------------</span>
    <span class="k">def</span> <span class="nf">_insertInitialSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Just overwrite this function to load some info</span>
        <span class="c1"># before the actual processing</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;inputCoords&#39;</span><span class="p">))</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;outputCoords&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveMasks</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
          <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;predictedMasks&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setupBasicProperties</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_insertNewMicsSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputMics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert steps to process new mics (from streaming)</span>
<span class="sd">        Params:</span>
<span class="sd">            inputMics: input mics set to be check</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertNewMics</span><span class="p">(</span><span class="n">inputMics</span><span class="p">,</span>
                                   <span class="k">lambda</span> <span class="n">mic</span><span class="p">:</span> <span class="n">mic</span><span class="o">.</span><span class="n">getMicName</span><span class="p">(),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_insertExtractMicrographStepOwn</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_insertExtractMicrographListStepOwn</span><span class="p">,</span>
                                   <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtractArgs</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">_insertExtractMicrographStepOwn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mic</span><span class="p">,</span> <span class="n">prerequisites</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Batch size must be &gt;1&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_insertExtractMicrographListStepOwn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micList</span><span class="p">,</span> <span class="n">prerequisites</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Basic method to insert a picking step for a given micrograph. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;extractMicrographListStepOwn&#39;</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">mic</span><span class="o">.</span><span class="n">getMicName</span><span class="p">()</span> <span class="k">for</span> <span class="n">mic</span> <span class="ow">in</span> <span class="n">micList</span><span class="p">],</span>
                                        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">prerequisites</span><span class="o">=</span><span class="n">prerequisites</span><span class="p">)</span>


<div class="viewcode-block" id="XmippProtDeepMicrographScreen.extractMicrographListStepOwn"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.extractMicrographListStepOwn">[docs]</a>    <span class="k">def</span> <span class="nf">extractMicrographListStepOwn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micKeyList</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">micList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">micName</span> <span class="ow">in</span> <span class="n">micKeyList</span><span class="p">:</span>
            <span class="n">mic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">micDict</span><span class="p">[</span><span class="n">micName</span><span class="p">]</span>
            <span class="n">micDoneFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMicDone</span><span class="p">(</span><span class="n">mic</span><span class="p">)</span>
            <span class="n">micFn</span> <span class="o">=</span> <span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>
            <span class="n">coordList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordDict</span><span class="p">[</span><span class="n">mic</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convertCoordinates</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">coordList</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isContinued</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">micDoneFn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping micrograph: </span><span class="si">%s</span><span class="s2">, seems to be done&quot;</span> <span class="o">%</span> <span class="n">micFn</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Clean old finished files</span>
                <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">micDoneFn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting micrograph: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">micFn</span><span class="p">)</span>
                <span class="n">micList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mic</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_computeMaskForMicrographList</span><span class="p">(</span><span class="n">micList</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mic</span> <span class="ow">in</span> <span class="n">micList</span><span class="p">:</span>
            <span class="c1"># Mark this mic as finished</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getMicDone</span><span class="p">(</span><span class="n">mic</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_computeMaskForMicrographList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Functional Step. Overrided in general protExtracParticle &quot;&quot;&quot;</span>

        <span class="n">micsFnDone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoneMics</span><span class="p">()</span>
        <span class="n">micLisfFn</span> <span class="o">=</span> <span class="p">[</span><span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span> <span class="k">for</span> <span class="n">mic</span> <span class="ow">in</span> <span class="n">micList</span>
                     <span class="k">if</span> <span class="ow">not</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span> <span class="ow">in</span> <span class="n">micsFnDone</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">micLisfFn</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
          <span class="n">inputMicsPathMetadataFname</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTmpPath</span><span class="p">(</span><span class="s2">&quot;inputMics&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">micLisfFn</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span><span class="p">)</span>
          <span class="n">mics_md</span><span class="o">=</span> <span class="n">createMetaDataFromPattern</span><span class="p">(</span> <span class="n">micLisfFn</span> <span class="p">)</span>
          <span class="n">mics_md</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputMicsPathMetadataFname</span><span class="p">)</span>
          <span class="n">args</span>  <span class="o">=</span>  <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">inputMicsPathMetadataFname</span>
          <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -c </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;inputCoords&#39;</span><span class="p">)</span>
          <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -o </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;outputCoords&#39;</span><span class="p">)</span>
          <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -b </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoxSize</span><span class="p">()</span>
          <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -s 1&#39;</span> <span class="c1">#Downsampling is automatically managed by scipion</span>
          <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -d </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getModel</span><span class="p">(</span><span class="s1">&#39;deepMicrographCleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;defaultModel.keras&#39;</span><span class="p">)</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --deepThr </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveMasks</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
              <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --predictedMaskDir </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;predictedMasks&quot;</span><span class="p">))</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                  <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -g all &#39;</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -g </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">()]))</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -g -1&#39;</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_deep_micrograph_cleaner&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_checkNewOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Load previously done items (from text file)</span>
        <span class="n">doneList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readDoneList</span><span class="p">()</span>
        <span class="c1"># Check for newly done items</span>
        <span class="n">newDone</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">micDict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                   <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doneList</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isMicDone</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>

        <span class="c1"># Update the file with the newly done mics</span>
        <span class="c1"># or exit from the function if no new done mics</span>
        <span class="n">inputLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">micDict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;_checkNewOutput: &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   input: </span><span class="si">%s</span><span class="s1">, doneList: </span><span class="si">%s</span><span class="s1">, newDone: </span><span class="si">%s</span><span class="s1">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">inputLen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDone</span><span class="p">)))</span>

        <span class="n">firstTime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">allDone</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDone</span><span class="p">)</span>
        <span class="c1"># We have finished when there is not more input mics (stream closed)</span>
        <span class="c1"># and the number of processed mics is equal to the number of inputs</span>
        <span class="n">streamClosed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isStreamClosed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="n">streamClosed</span> <span class="ow">and</span> <span class="n">allDone</span> <span class="o">==</span> <span class="n">inputLen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; is finished? </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; is stream closed? </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">streamClosed</span><span class="p">)</span>
        <span class="n">streamMode</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">STREAM_CLOSED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="k">else</span> <span class="n">Set</span><span class="o">.</span><span class="n">STREAM_OPEN</span>

        <span class="k">if</span> <span class="n">newDone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputCoordSet</span><span class="p">(</span><span class="n">newDone</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_writeDoneList</span><span class="p">(</span><span class="n">newDone</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="c1"># If we are not finished and no new output have been produced</span>
            <span class="c1"># it does not make sense to proceed and updated the outputs</span>
            <span class="c1"># so we exit from the function here</span>

            <span class="c1"># Maybe it would be good idea to take a snap to avoid</span>
            <span class="c1"># so much IO if this protocol does not have much to do now</span>
            <span class="k">if</span> <span class="n">allDone</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">micDict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_streamingSleepOnWait</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   finished: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        self.streamClosed (</span><span class="si">%s</span><span class="s1">) AND&#39;</span> <span class="o">%</span> <span class="n">streamClosed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        allDone (</span><span class="si">%s</span><span class="s1">) == len(self.listOfMics (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">allDone</span><span class="p">,</span> <span class="n">inputLen</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   streamMode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">streamMode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>  <span class="c1"># Unlock createOutputStep if finished all jobs</span>

            <span class="c1"># Close the output set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputCoordSet</span><span class="p">([],</span> <span class="n">Set</span><span class="o">.</span><span class="n">STREAM_CLOSED</span><span class="p">)</span>
            <span class="n">outputStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStep</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">outputStep</span> <span class="ow">and</span> <span class="n">outputStep</span><span class="o">.</span><span class="n">isWaiting</span><span class="p">():</span>
                <span class="n">outputStep</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">STATUS_NEW</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getScale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">micsSource</span><span class="o">==</span><span class="n">SAME_AS_PICKING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useOtherScale</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">scale</span><span class="o">=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">getBoxScale</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">scale</span>

    <span class="k">def</span> <span class="nf">_updateOutputCoordSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micList</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">):</span>

        <span class="c1"># Do no proceed if there is not micrograph ready</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">micList</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">outputDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;outputCoords&#39;</span><span class="p">)</span>
        <span class="n">outputCoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutput</span><span class="p">()</span>

        <span class="c1"># If there are not outputCoordinates yet, it means that is the first</span>
        <span class="c1"># time we are updating output coordinates, so we need to first create</span>
        <span class="c1"># the output set</span>
        <span class="n">firstTime</span> <span class="o">=</span> <span class="n">outputCoords</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">firstTime</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">micsSource</span><span class="o">==</span><span class="n">SAME_AS_PICKING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useOtherScale</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
              <span class="n">boxSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoxSize</span><span class="p">()</span>
              <span class="n">micSetPtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputMicrographs</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">boxSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getBoxSize</span><span class="p">()</span>
              <span class="n">micSetPtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span>
              
            <span class="n">outputCoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfCoordinates</span><span class="p">(</span><span class="n">micSetPtr</span><span class="p">,</span>
                                                        <span class="n">suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getAutoSuffix</span><span class="p">())</span>
            <span class="n">outputCoords</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">outputCoords</span><span class="o">.</span><span class="n">setBoxSize</span><span class="p">(</span><span class="n">boxSize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputCoords</span><span class="o">.</span><span class="n">enableAppend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading coordinates from mics: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mic</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span> <span class="k">for</span> <span class="n">mic</span> <span class="ow">in</span> <span class="n">micList</span><span class="p">]))</span>
        <span class="n">readSetOfCoordinates</span><span class="p">(</span><span class="n">outputDir</span><span class="p">,</span> <span class="n">micList</span><span class="p">,</span> <span class="n">outputCoords</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getScale</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; _updateOutputCoordSet Stream Mode: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">streamMode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOutputName</span><span class="p">(),</span> <span class="n">outputCoords</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">firstTime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="n">micSetPtr</span><span class="p">,</span>
                                       <span class="n">outputCoords</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">micList</span>


    <span class="c1">#--------------------------- INFO functions --------------------------------</span>

    <span class="k">def</span> <span class="nf">_getStreamingBatchSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">firstBatch</span><span class="o">=</span><span class="kc">True</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamingBatchSize</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;actualBatchSize&quot;</span><span class="p">):</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInStreaming</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actualBatchSize</span><span class="o">=</span> <span class="mi">16</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstBatch</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">firstBatch</span><span class="o">=</span><span class="kc">False</span>
              <span class="n">batchSize</span><span class="o">=</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">nPickMics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumPickedMics</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">actualBatchSize</span><span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">nPickMics</span><span class="p">)</span>
              <span class="n">batchSize</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actualBatchSize</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">batchSize</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamingBatchSize</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">batchSize</span>

    <span class="k">def</span> <span class="nf">_getNumPickedMics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">nPickMics</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">lastId</span><span class="o">=</span><span class="kc">None</span>
      <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="n">curId</span><span class="o">=</span><span class="n">coord</span><span class="o">.</span><span class="n">getMicId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lastId</span><span class="o">!=</span><span class="n">curId</span><span class="p">:</span>
          <span class="n">lastId</span><span class="o">=</span><span class="n">curId</span>
          <span class="n">nPickMics</span><span class="o">+=</span><span class="mi">1</span>
      <span class="k">return</span> <span class="n">nPickMics</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateDLtoolkit</span><span class="p">(</span><span class="n">assertModel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;deepMicrographCleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;defaultModel.keras&#39;</span><span class="p">))</span>

        <span class="n">batchSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamingBatchSize</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">batchSize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Batch size must be 0 (all at once) or larger than 1.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInStreaming</span><span class="p">()</span> <span class="ow">and</span> <span class="n">batchSize</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Batch size (</span><span class="si">%d</span><span class="s1">) must be &lt;= that the number of micrographs &#39;</span>
                          <span class="s1">&#39;(</span><span class="si">%d</span><span class="s1">) in static mode. Set it to 0 to use only one batch&#39;</span>
                          <span class="o">%</span><span class="p">(</span><span class="n">batchSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumPickedMics</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">errors</span>

    
    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;***&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Micrographs source: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnumText</span><span class="p">(</span><span class="s2">&quot;micsSource&quot;</span><span class="p">))</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Coordinates scale: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">getBoxScale</span><span class="p">())</span> <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">methodsMsgs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">methodsMsgs</span>

    <span class="c1"># --------------------------- UTILS functions ------------------------------</span>
    <span class="k">def</span> <span class="nf">_convertCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mic</span><span class="p">,</span> <span class="n">coordList</span><span class="p">):</span>
        <span class="n">writeMicCoordinates</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">coordList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMicPos</span><span class="p">(</span><span class="n">mic</span><span class="p">),</span>
                            <span class="n">getPosFunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPos</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_micsOther</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if other micrographs are used for extract. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">micsSource</span> <span class="o">==</span> <span class="n">OTHER</span>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.notOne"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.notOne">[docs]</a>    <span class="k">def</span> <span class="nf">notOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0001</span></div>

    <span class="k">def</span> <span class="nf">_setupBasicProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set sampling rate (before and after doDownsample) and inputMics</span>
        <span class="c1"># according to micsSource type</span>
        <span class="n">inputCoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoords</span><span class="p">()</span>
        <span class="n">mics</span> <span class="o">=</span> <span class="n">inputCoords</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingInput</span> <span class="o">=</span> <span class="n">inputCoords</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingMics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputMicrographs</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplingFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingMics</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplingInput</span><span class="p">))</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoxScale</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scale: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notOne</span><span class="p">(</span><span class="n">scale</span><span class="p">):</span>
            <span class="c1"># If we need to scale the box, then we need to scale the coordinates</span>
            <span class="n">getPos</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">coord</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">getX</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">getY</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">getPos</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">coord</span><span class="p">:</span> <span class="n">coord</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
        <span class="c1"># Store the function to be used for scaling coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getPos</span> <span class="o">=</span> <span class="n">getPos</span>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getInputMicrographs"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getInputMicrographs">[docs]</a>    <span class="k">def</span> <span class="nf">getInputMicrographs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the micrographs associated to the SetOfCoordinates or</span>
<span class="sd">        Other micrographs. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_micsOther</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputMicrographs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getCoords"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getCoords">[docs]</a>    <span class="k">def</span> <span class="nf">getCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getAutoSuffix"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getAutoSuffix">[docs]</a>    <span class="k">def</span> <span class="nf">getAutoSuffix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;_Full&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;_Auto_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getOutputName"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getOutputName">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;outputCoordinates&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAutoSuffix</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getOutput"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getOutput">[docs]</a>    <span class="k">def</span> <span class="nf">getOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOutputName</span><span class="p">())</span> <span class="ow">and</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputName</span><span class="p">())</span><span class="o">.</span><span class="n">hasValue</span><span class="p">()):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputName</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getCoordSampling"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getCoordSampling">[docs]</a>    <span class="k">def</span> <span class="nf">getCoordSampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoords</span><span class="p">()</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getMicSampling"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getMicSampling">[docs]</a>    <span class="k">def</span> <span class="nf">getMicSampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputMicrographs</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getBoxScale"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getBoxScale">[docs]</a>    <span class="k">def</span> <span class="nf">getBoxScale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computing the sampling factor between input and output.</span>
<span class="sd">        We should take into account the differences in sampling rate between</span>
<span class="sd">        micrographs used for picking and the ones used for extraction.</span>
<span class="sd">        The downsampling factor could also affect the resulting scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samplingPicking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCoordSampling</span><span class="p">()</span>
        <span class="n">samplingExtract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMicSampling</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">samplingPicking</span><span class="p">)</span> <span class="o">/</span> <span class="n">samplingExtract</span>
        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getBoxSize"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getBoxSize">[docs]</a>    <span class="k">def</span> <span class="nf">getBoxSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This function is needed by the wizard</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCoords</span><span class="p">()</span><span class="o">.</span><span class="n">getBoxSize</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoxScale</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_getOutputImgMd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMicPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the corresponding .pos file for a given micrograph. &quot;&quot;&quot;</span>
        <span class="n">micBase</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;inputCoords&#39;</span><span class="p">,</span> <span class="n">micBase</span> <span class="o">+</span> <span class="s2">&quot;.pos&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMicXmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the corresponding .xmd with extracted particles</span>
<span class="sd">        for this micrograph. &quot;&quot;&quot;</span>
        <span class="n">micBase</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">mic</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">micBase</span> <span class="o">+</span> <span class="s2">&quot;.xmd&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.getDoneMics"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.getDoneMics">[docs]</a>    <span class="k">def</span> <span class="nf">getDoneMics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">fName</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;outputCoords&#39;</span><span class="p">)):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">fName</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="XmippProtDeepMicrographScreen.registerCoords"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_deep_micrograph_screen.html#xmipp3.protocols.protocol_deep_micrograph_screen.XmippProtDeepMicrographScreen.registerCoords">[docs]</a>    <span class="k">def</span> <span class="nf">registerCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordsDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method is usually inherited by all Pickers</span>
<span class="sd">        and it is used from the Java picking GUI to register</span>
<span class="sd">        a new SetOfCoordinates when the user click on +Particles button.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">inputset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputMicrographs</span><span class="p">()</span>
        
        <span class="n">mySuffix</span> <span class="o">=</span> <span class="s1">&#39;_Manual_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">coordsDir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;manualThresholding_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">outputName</span> <span class="o">=</span> <span class="s1">&#39;outputCoordinates&#39;</span> <span class="o">+</span> <span class="n">mySuffix</span>

        <span class="n">outputset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfCoordinates</span><span class="p">(</span><span class="n">inputset</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">mySuffix</span><span class="p">)</span>
        <span class="n">readSetOfCoordinates</span><span class="p">(</span><span class="n">coordsDir</span><span class="p">,</span> <span class="n">outputset</span><span class="o">.</span><span class="n">getMicrographs</span><span class="p">(),</span> <span class="n">outputset</span><span class="p">)</span>
        <span class="c1"># summary = self.getSummary(outputset)</span>
        <span class="c1"># outputset.setObjComment(summary)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">outputName</span><span class="p">:</span> <span class="n">outputset</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="n">outputs</span><span class="p">)</span>

        <span class="c1"># Using a pointer to define the relations is more robust to scheduling</span>
        <span class="c1"># and id changes between the protocol run.db and the main project</span>
        <span class="c1"># database. The pointer defined below points to the outputset object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputMicrographs</span><span class="p">(),</span>
                                   <span class="n">Pointer</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="n">outputName</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dm_facilitiesUpdate/index.html">dm_facilitiesUpdate</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="protocol_deep_micrograph_screen.html">release-3.0.0</a></dd>
            <dd><a href="../../../../scipion3_instalation/index.html">scipion3_instalation</a></dd>
            <dd><a href="../../../../update_scipion_modes/index.html">update_scipion_modes</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>