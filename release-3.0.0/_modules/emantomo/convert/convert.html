

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>emantomo.convert.convert &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../emantomo.html">emantomo</a> &raquo;</li>
        
      <li>emantomo.convert.convert</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for emantomo.convert.convert</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se) [1]</span>
<span class="c1"># *              Laura del Cano (ldelcano@cnb.csic.es) [1]</span>
<span class="c1"># *              Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca) [1]</span>
<span class="c1"># *              Grigory Sharov (gsharov@mrc-lmb.cam.ac.uk) [2]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># * [2] MRC Laboratory of Molecular Biology (MRC-LMB)</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pwem.constants</span> <span class="k">as</span> <span class="nn">emcts</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pwem.objects.data</span> <span class="k">import</span> <span class="n">Coordinate</span><span class="p">,</span> <span class="n">Particle</span><span class="p">,</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="k">import</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="k">import</span> <span class="n">ImageHandler</span>
<span class="kn">import</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">as</span> <span class="nn">md</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">Plugin</span>


<div class="viewcode-block" id="loadJson"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.loadJson">[docs]</a><span class="k">def</span> <span class="nf">loadJson</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function loads the Json dictionary into memory &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
        <span class="n">jsonDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonDict</span></div>


<div class="viewcode-block" id="writeJson"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.writeJson">[docs]</a><span class="k">def</span> <span class="nf">writeJson</span><span class="p">(</span><span class="n">jsonDict</span><span class="p">,</span> <span class="n">jsonFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function write a Json dictionary &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonFn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jsonDict</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="readCTFModel"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.readCTFModel">[docs]</a><span class="k">def</span> <span class="nf">readCTFModel</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">jsonDict</span> <span class="o">=</span> <span class="n">loadJson</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">keyPos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="s1">&#39;ctf_frame&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
        <span class="n">keyPos</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s1">&#39;ctf_frame&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;ctf&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
        <span class="n">keyPos</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s1">&#39;ctf&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">setWrongDefocus</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keyPos</span><span class="p">:</span>
        <span class="n">defocus</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;defocus&#39;</span><span class="p">])</span>
        <span class="n">defocusAngle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;dfang&#39;</span><span class="p">])</span>
        <span class="n">dfdiff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;dfdiff&#39;</span><span class="p">])</span>
        <span class="n">ampcont</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyPos</span><span class="p">[</span><span class="s1">&#39;ampcont&#39;</span><span class="p">])</span>
        <span class="n">defocusU</span> <span class="o">=</span> <span class="mf">10000.0</span> <span class="o">*</span> <span class="n">defocus</span> <span class="o">+</span> <span class="mf">5000.0</span> <span class="o">*</span> <span class="n">dfdiff</span>
        <span class="n">defocusV</span> <span class="o">=</span> <span class="mf">20000.0</span> <span class="o">*</span> <span class="n">defocus</span> <span class="o">-</span> <span class="n">defocusU</span>
        <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="n">calculatePhaseShift</span><span class="p">(</span><span class="n">ampcont</span><span class="p">)</span>

        <span class="n">ctfModel</span><span class="o">.</span><span class="n">setStandardDefocus</span><span class="p">(</span><span class="n">defocusU</span><span class="p">,</span> <span class="n">defocusV</span><span class="p">,</span> <span class="n">defocusAngle</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ctf_im2d&#39;</span> <span class="ow">in</span> <span class="n">jsonDict</span><span class="p">:</span>
            <span class="c1"># psdFile = jsonDict[&#39;ctf_im2d&#39;][&#39;__image__&#39;][0]</span>
            <span class="n">fnBase</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeExt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_jsonimg&#39;</span>
            <span class="n">psdFile</span> <span class="o">=</span> <span class="s2">&quot;1@</span><span class="si">%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="n">fnBase</span>
            <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psdFile</span><span class="p">):</span>
                <span class="n">ctfModel</span><span class="o">.</span><span class="n">setPsdFile</span><span class="p">(</span><span class="n">psdFile</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setPhaseShift</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ctfPhaseShift</span><span class="p">))</span></div>


<div class="viewcode-block" id="setWrongDefocus"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.setWrongDefocus">[docs]</a><span class="k">def</span> <span class="nf">setWrongDefocus</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">):</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusU</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ctfModel</span><span class="o">.</span><span class="n">setDefocusAngle</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeCTFModel"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.writeCTFModel">[docs]</a><span class="k">def</span> <span class="nf">writeCTFModel</span><span class="p">(</span><span class="n">ctfObj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write a CTFModel object as Xmipp .ctfparam&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="jsonToCtfModel"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.jsonToCtfModel">[docs]</a><span class="k">def</span> <span class="nf">jsonToCtfModel</span><span class="p">(</span><span class="n">ctfJsonFn</span><span class="p">,</span> <span class="n">ctfModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a CTFModel from a json file &quot;&quot;&quot;</span>
    <span class="n">mdFn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctfJsonFn</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
    <span class="n">mdFn</span> <span class="o">=</span> <span class="n">mdFn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__ctf_flip&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_info.json&#39;</span>
    <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mdFn</span><span class="p">):</span>
        <span class="n">readCTFModel</span><span class="p">(</span><span class="n">ctfModel</span><span class="p">,</span> <span class="n">mdFn</span><span class="p">)</span></div>


<span class="c1"># def readSetOfCoordinates(workDir, micSet, coordSet, invertY=False, newBoxer=False):</span>
<span class="c1">#     &quot;&quot;&quot; Read from Eman .json files.</span>
<span class="c1">#     Params:</span>
<span class="c1">#         workDir: where the Eman boxer output files are located.</span>
<span class="c1">#         micSet: the SetOfMicrographs to associate the .json, which</span>
<span class="c1">#             name should be the same of the micrographs.</span>
<span class="c1">#         coordSet: the SetOfCoordinates that will be populated.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if newBoxer:</span>
<span class="c1">#         # read boxSize from info/project.json</span>
<span class="c1">#         jsonFnbase = pwutils.join(workDir, &#39;info&#39;, &#39;project.json&#39;)</span>
<span class="c1">#         jsonBoxDict = loadJson(jsonFnbase)</span>
<span class="c1">#         size = int(jsonBoxDict[&quot;global.boxsize&quot;])</span>
<span class="c1">#     else:</span>
<span class="c1">#         # read boxSize from e2boxercache/base.json</span>
<span class="c1">#         jsonFnbase = pwutils.join(workDir, &#39;e2boxercache&#39;, &#39;base.json&#39;)</span>
<span class="c1">#         jsonBoxDict = loadJson(jsonFnbase)</span>
<span class="c1">#         size = int(jsonBoxDict[&quot;box_size&quot;])</span>
<span class="c1">#</span>
<span class="c1">#     jsonFninfo = pwutils.join(workDir, &#39;info/&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     for mic in micSet:</span>
<span class="c1">#         micBase = pwutils.removeBaseExt(mic.getFileName())</span>
<span class="c1">#         micPosFn = &#39;&#39;.join(glob.glob(jsonFninfo + &#39;*&#39; + micBase + &#39;_info.json&#39;))</span>
<span class="c1">#         readCoordinates(mic, micPosFn, coordSet, invertY)</span>
<span class="c1">#     coordSet.setBoxSize(size)</span>


<div class="viewcode-block" id="readSetOfCoordinates3D"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.readSetOfCoordinates3D">[docs]</a><span class="k">def</span> <span class="nf">readSetOfCoordinates3D</span><span class="p">(</span><span class="n">jsonBoxDict</span><span class="p">,</span> <span class="n">coord3DSetDict</span><span class="p">,</span> <span class="n">inputTomo</span><span class="p">,</span> <span class="n">updateItem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;boxes_3d&quot;</span> <span class="ow">in</span> <span class="n">jsonBoxDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">jsonBoxDict</span><span class="p">[</span><span class="s2">&quot;boxes_3d&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="n">classKey</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">coord3DSet</span> <span class="o">=</span> <span class="n">coord3DSetDict</span><span class="p">[</span><span class="n">classKey</span><span class="p">]</span>
            <span class="n">coord3DSet</span><span class="o">.</span><span class="n">enableAppend</span><span class="p">()</span>

            <span class="n">newCoord</span> <span class="o">=</span> <span class="n">readCoordinate3D</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">inputTomo</span><span class="p">)</span>

            <span class="c1"># Execute Callback</span>
            <span class="k">if</span> <span class="n">updateItem</span><span class="p">:</span>
                <span class="n">updateItem</span><span class="p">(</span><span class="n">newCoord</span><span class="p">)</span>

            <span class="n">coord3DSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newCoord</span><span class="p">)</span></div>


<span class="c1"># def readCoordinates(mic, fileName, coordsSet, invertY=False):</span>
<span class="c1">#     if pwutils.exists(fileName):</span>
<span class="c1">#         jsonPosDict = loadJson(fileName)</span>
<span class="c1">#</span>
<span class="c1">#         if &quot;boxes&quot; in jsonPosDict:</span>
<span class="c1">#             boxes = jsonPosDict[&quot;boxes&quot;]</span>
<span class="c1">#</span>
<span class="c1">#             for box in boxes:</span>
<span class="c1">#                 x, y = box[:2]</span>
<span class="c1">#</span>
<span class="c1">#                 if invertY:</span>
<span class="c1">#                     y = mic.getYDim() - y</span>
<span class="c1">#</span>
<span class="c1">#                 coord = Coordinate()</span>
<span class="c1">#                 coord.setPosition(x, y)</span>
<span class="c1">#                 coord.setMicrograph(mic)</span>
<span class="c1">#                 coordsSet.append(coord)</span>


<div class="viewcode-block" id="readCoordinate3D"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.readCoordinate3D">[docs]</a><span class="k">def</span> <span class="nf">readCoordinate3D</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">inputTomo</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">tomo.objects</span> <span class="k">import</span> <span class="n">Coordinate3D</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">box</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">Coordinate3D</span><span class="p">()</span>
    <span class="n">coord</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">coord</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">inputTomo</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord</span></div>


<div class="viewcode-block" id="writeSetOfSubTomograms"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.writeSetOfSubTomograms">[docs]</a><span class="k">def</span> <span class="nf">writeSetOfSubTomograms</span><span class="p">(</span><span class="n">subtomogramSet</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert the imgSet particles to .hdf files as expected by Eman.</span>
<span class="sd">        This function should be called from a current dir where</span>
<span class="sd">        the images in the set are available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">getExt</span><span class="p">(</span><span class="n">subtomogramSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;hdf&#39;</span><span class="p">:</span>
        <span class="c1"># create links if input has hdf format</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">subtomogramSet</span><span class="o">.</span><span class="n">getFiles</span><span class="p">():</span>
            <span class="n">newFn</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__ctf&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdf&#39;</span>
            <span class="n">newFn</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">createLink</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">newFn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">newFn</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">firstCoord</span> <span class="o">=</span> <span class="n">subtomogramSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getCoordinate3D</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">hasVolName</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">firstCoord</span><span class="p">:</span>
            <span class="n">hasVolName</span> <span class="o">=</span> <span class="n">subtomogramSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getVolName</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subtomo</span> <span class="ow">in</span> <span class="n">iterSubtomogramsByVol</span><span class="p">(</span><span class="n">subtomogramSet</span><span class="p">):</span>
            <span class="n">volName</span> <span class="o">=</span> <span class="n">volId</span> <span class="o">=</span> <span class="n">subtomo</span><span class="o">.</span><span class="n">getVolId</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hasVolName</span><span class="p">:</span>
                <span class="n">volName</span> <span class="o">=</span> <span class="n">subtomogramSet</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span><span class="o">.</span><span class="n">getVolName</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">volName</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">volName</span><span class="p">)</span>
            <span class="n">objDict</span> <span class="o">=</span> <span class="n">subtomo</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">volId</span><span class="p">:</span>
                <span class="n">volId</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hasVolName</span> <span class="ow">and</span> <span class="p">(</span><span class="n">volName</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">volId</span><span class="p">)):</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volName</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                <span class="s2">&quot;subtomo_</span><span class="si">%06d%s</span><span class="s2">.hdf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volId</span><span class="p">,</span> <span class="n">suffix</span><span class="p">))</span>

            <span class="n">alignType</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alignType&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alignType</span> <span class="o">!=</span> <span class="n">emcts</span><span class="o">.</span><span class="n">ALIGN_NONE</span><span class="p">:</span>
                <span class="n">shift</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">alignmentToRow</span><span class="p">(</span><span class="n">subtomo</span><span class="o">.</span><span class="n">getTransform</span><span class="p">(),</span> <span class="n">alignType</span><span class="p">)</span>
                <span class="c1"># json cannot encode arrays so I convert them to lists</span>
                <span class="c1"># json fail if has -0 as value</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_angles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_itemId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtomo</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

            <span class="c1"># the index in EMAN begins with 0</span>
            <span class="k">if</span> <span class="n">fileName</span> <span class="o">!=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileName</span>
                <span class="k">if</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
            <span class="c1"># Write the e2converter.py process from where to read the image</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">objDict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>


<span class="c1"># def writeSetOfMicrographs(micSet, filename):</span>
<span class="c1">#     &quot;&quot;&quot; Simplified function borrowed from xmipp. &quot;&quot;&quot;</span>
<span class="c1">#     mdata = md.MetaData()</span>
<span class="c1">#</span>
<span class="c1">#     for img in micSet:</span>
<span class="c1">#         objId = mdata.addObject()</span>
<span class="c1">#         imgRow = md.Row()</span>
<span class="c1">#         imgRow.setValue(md.MDL_ITEM_ID, objId)</span>
<span class="c1">#</span>
<span class="c1">#         index, fname = img.getLocation()</span>
<span class="c1">#         fn = ImageHandler.locationToXmipp((index, fname))</span>
<span class="c1">#         imgRow.setValue(md.MDL_MICROGRAPH, fn)</span>
<span class="c1">#</span>
<span class="c1">#         if img.isEnabled():</span>
<span class="c1">#             enabled = 1</span>
<span class="c1">#         else:</span>
<span class="c1">#             enabled = -1</span>
<span class="c1">#         imgRow.setValue(md.MDL_ENABLED, enabled)</span>
<span class="c1">#         imgRow.writeToMd(mdata, objId)</span>
<span class="c1">#</span>
<span class="c1">#     mdata.write(&#39;Micrographs@%s&#39; % filename)</span>


<span class="c1"># def readSetOfParticles(lstFile, partSet, copyOrLink, direc):</span>
<span class="c1">#     for index, fn in iterLstFile(lstFile):</span>
<span class="c1">#         item = Particle()</span>
<span class="c1">#         # set full path to particles stack file</span>
<span class="c1">#         abspath = os.path.abspath(lstFile)</span>
<span class="c1">#         fn = abspath.replace(&#39;sets/%s&#39; % os.path.basename(lstFile), &#39;&#39;) + fn</span>
<span class="c1">#         newFn = pwutils.join(direc, os.path.basename(fn))</span>
<span class="c1">#         if not pwutils.exists(newFn):</span>
<span class="c1">#             copyOrLink(fn, newFn)</span>
<span class="c1">#</span>
<span class="c1">#         item.setLocation(index, newFn)</span>
<span class="c1">#         partSet.append(item)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def writeSetOfParticles(partSet, path, **kwargs):</span>
<span class="c1">#     &quot;&quot;&quot; Convert the imgSet particles to .hdf files as expected by Eman.</span>
<span class="c1">#     This function should be called from a current dir where</span>
<span class="c1">#     the images in the set are available.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     ext = pwutils.getExt(partSet.getFirstItem().getFileName())[1:]</span>
<span class="c1">#     if ext == &#39;hdf&#39;:</span>
<span class="c1">#         # create links if input has hdf format</span>
<span class="c1">#         for fn in partSet.getFiles():</span>
<span class="c1">#             newFn = pwutils.removeBaseExt(fn).split(&#39;__ctf&#39;)[0] + &#39;.hdf&#39;</span>
<span class="c1">#             newFn = pwutils.join(path, newFn)</span>
<span class="c1">#             pwutils.createLink(fn, newFn)</span>
<span class="c1">#             print(&quot;   %s -&gt; %s&quot; % (fn, newFn))</span>
<span class="c1">#     else:</span>
<span class="c1">#         firstCoord = partSet.getFirstItem().getCoordinate() or None</span>
<span class="c1">#         hasMicName = False</span>
<span class="c1">#         if firstCoord:</span>
<span class="c1">#             hasMicName = firstCoord.getMicName() or False</span>
<span class="c1">#</span>
<span class="c1">#         fileName = &quot;&quot;</span>
<span class="c1">#         a = 0</span>
<span class="c1">#         proc = Plugin.createEmanProcess(args=&#39;write&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         for i, part in iterParticlesByMic(partSet):</span>
<span class="c1">#             micName = micId = part.getMicId()</span>
<span class="c1">#             if hasMicName:</span>
<span class="c1">#                 micName = pwutils.removeBaseExt(part.getCoordinate().getMicName())</span>
<span class="c1">#             objDict = part.getObjDict()</span>
<span class="c1">#</span>
<span class="c1">#             if not micId:</span>
<span class="c1">#                 micId = 0</span>
<span class="c1">#</span>
<span class="c1">#             suffix = kwargs.get(&#39;suffix&#39;, &#39;&#39;)</span>
<span class="c1">#             if hasMicName and (micName != str(micId)):</span>
<span class="c1">#                 objDict[&#39;hdfFn&#39;] = pwutils.join(path,</span>
<span class="c1">#                                                 &quot;%s%s.hdf&quot; % (micName, suffix))</span>
<span class="c1">#             else:</span>
<span class="c1">#                 objDict[&#39;hdfFn&#39;] = pwutils.join(path,</span>
<span class="c1">#                                                 &quot;mic_%06d%s.hdf&quot; % (micId, suffix))</span>
<span class="c1">#</span>
<span class="c1">#             alignType = kwargs.get(&#39;alignType&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             if alignType != emcts.ALIGN_NONE:</span>
<span class="c1">#                 shift, angles = alignmentToRow(part.getTransform(), alignType)</span>
<span class="c1">#                 # json cannot encode arrays so I convert them to lists</span>
<span class="c1">#                 # json fail if has -0 as value</span>
<span class="c1">#                 objDict[&#39;_shifts&#39;] = shift.tolist()</span>
<span class="c1">#                 objDict[&#39;_angles&#39;] = angles.tolist()</span>
<span class="c1">#             objDict[&#39;_itemId&#39;] = part.getObjId()</span>
<span class="c1">#</span>
<span class="c1">#             # the index in EMAN begins with 0</span>
<span class="c1">#             if fileName != objDict[&#39;_filename&#39;]:</span>
<span class="c1">#                 fileName = objDict[&#39;_filename&#39;]</span>
<span class="c1">#                 if objDict[&#39;_index&#39;] == 0:  # TODO: Index appears to be the problem (when not given it works ok)</span>
<span class="c1">#                     a = 0</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     a = 1</span>
<span class="c1">#             objDict[&#39;_index&#39;] = int(objDict[&#39;_index&#39;] - a)</span>
<span class="c1">#             # Write the e2converter.py process from where to read the image</span>
<span class="c1">#             print(json.dumps(objDict), file=proc.stdin, flush=True)</span>
<span class="c1">#             proc.stdout.readline()</span>
<span class="c1">#         proc.kill()</span>


<div class="viewcode-block" id="getImageDimensions"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.getImageDimensions">[docs]</a><span class="k">def</span> <span class="nf">getImageDimensions</span><span class="p">(</span><span class="n">imageFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function will allow us to use EMAN2 to read some formats</span>
<span class="sd">     not currently supported by the native image library (Xmipp).</span>
<span class="sd">     Underneath, it will call a script to do the job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="s1">&#39;e2ih.py&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">imageFile</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span></div>


<div class="viewcode-block" id="convertImage"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.convertImage">[docs]</a><span class="k">def</span> <span class="nf">convertImage</span><span class="p">(</span><span class="n">inputLoc</span><span class="p">,</span> <span class="n">outputLoc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function will allow us to use EMAN2 to write some formats</span>
<span class="sd">     not currently supported by the native image library (Xmipp).</span>
<span class="sd">     Underneath, it will call an script to do the job.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getFn</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use similar naming convention as in Xmipp.</span>
<span class="sd">        This does not works for EMAN out of here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">emcts</span><span class="o">.</span><span class="n">NO_INDEX</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%06d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">loc</span>
            <span class="k">return</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loc</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="s1">&#39;e2ih.py&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_getFn</span><span class="p">(</span><span class="n">inputLoc</span><span class="p">),</span>
                                                               <span class="n">_getFn</span><span class="p">(</span><span class="n">outputLoc</span><span class="p">)))</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="iterLstFile"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.iterLstFile">[docs]</a><span class="k">def</span> <span class="nf">iterLstFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># Decompose Eman filename</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">index</span><span class="p">,</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="geometryFromMatrix"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.geometryFromMatrix">[docs]</a><span class="k">def</span> <span class="nf">geometryFromMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pwem.convert.transformations</span> <span class="k">import</span> <span class="n">translation_from_matrix</span><span class="p">,</span> <span class="n">euler_from_matrix</span>
    <span class="k">if</span> <span class="n">inverseTransform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">inv</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="o">-</span><span class="n">translation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">translation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">euler_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;szyz&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span></div>


<div class="viewcode-block" id="matrixFromGeometry"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.matrixFromGeometry">[docs]</a><span class="k">def</span> <span class="nf">matrixFromGeometry</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the transformation matrix from a given</span>
<span class="sd">    2D shifts in X and Y...and the 3 euler angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pwem.convert.transformations</span> <span class="k">import</span> <span class="n">euler_matrix</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">deg2rad</span>
    <span class="n">radAngles</span> <span class="o">=</span> <span class="o">-</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">euler_matrix</span><span class="p">(</span><span class="n">radAngles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radAngles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">radAngles</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;szyz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverseTransform</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">inv</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="alignmentToRow"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.alignmentToRow">[docs]</a><span class="k">def</span> <span class="nf">alignmentToRow</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="n">alignType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    is2D == True-&gt; matrix is 2D (2D images alignment)</span>
<span class="sd">            otherwise matrix is 3D (3D volume alignment or projection)</span>
<span class="sd">    invTransform == True  -&gt; for xmipp implies projection</span>
<span class="sd">                          -&gt; for xmipp implies alignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     is2D = alignType == em.ALIGN_2D</span>
    <span class="c1">#     inverseTransform = alignType == em.ALIGN_PROJ</span>

    <span class="c1"># transformation matrix is processed here because</span>
    <span class="c1"># it uses routines available through scipion python</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">getMatrix</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">geometryFromMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="rowToAlignment"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.rowToAlignment">[docs]</a><span class="k">def</span> <span class="nf">rowToAlignment</span><span class="p">(</span><span class="n">alignmentList</span><span class="p">,</span> <span class="n">alignType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    is2D == True-&gt; matrix is 2D (2D images alignment)</span>
<span class="sd">            otherwise matrix is 3D (3D volume alignment or projection)</span>
<span class="sd">    invTransform == True  -&gt; for xmipp implies projection</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># use all angles in 2D since we might have mirrors</span>
    <span class="c1"># is2D = alignType == em.ALIGN_2D</span>
    <span class="n">inverseTransform</span> <span class="o">=</span> <span class="n">alignType</span> <span class="o">==</span> <span class="n">emcts</span><span class="o">.</span><span class="n">ALIGN_PROJ</span>

    <span class="n">alignment</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">()</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">shifts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">alignmentList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrixFromGeometry</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">inverseTransform</span><span class="p">)</span>
    <span class="n">alignment</span><span class="o">.</span><span class="n">setMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alignment</span></div>


<span class="c1"># def iterParticlesByMic(partSet):</span>
<span class="c1">#     &quot;&quot;&quot; Iterate the particles ordered by micrograph &quot;&quot;&quot;</span>
<span class="c1">#     for i, part in enumerate(partSet.iterItems(orderBy=[&#39;_micId&#39;, &#39;id&#39;],</span>
<span class="c1">#                                                direction=&#39;ASC&#39;)):</span>
<span class="c1">#         yield i, part</span>


<div class="viewcode-block" id="iterSubtomogramsByVol"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.iterSubtomogramsByVol">[docs]</a><span class="k">def</span> <span class="nf">iterSubtomogramsByVol</span><span class="p">(</span><span class="n">subtomogramSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Iterate subtomograms ordered by tomogram &quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">subtomo</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">subtomo</span> <span class="ow">in</span> <span class="n">subtomogramSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_volId&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span></div>


<div class="viewcode-block" id="convertReferences"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.convertReferences">[docs]</a><span class="k">def</span> <span class="nf">convertReferences</span><span class="p">(</span><span class="n">refSet</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simplified version of writeSetOfParticles function.</span>
<span class="sd">    Writes out an hdf stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">refSet</span><span class="p">:</span>
        <span class="n">objDict</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;hdfFn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputFn</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_itemId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

        <span class="c1"># the index in EMAN begins with 0</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="o">!=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_filename&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objDict</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>

        <span class="c1"># Write the e2converter.py process from where to read the image</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">objDict</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>


<div class="viewcode-block" id="calculatePhaseShift"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.calculatePhaseShift">[docs]</a><span class="k">def</span> <span class="nf">calculatePhaseShift</span><span class="p">(</span><span class="n">ampcont</span><span class="p">):</span>
    <span class="c1"># calculate phase shift as in EMAN2 ctf.cpp</span>
    <span class="k">if</span> <span class="o">-</span><span class="mf">100.0</span> <span class="o">&lt;</span> <span class="n">ampcont</span> <span class="o">&lt;=</span> <span class="mf">100.0</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ampcont</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PhaseShift</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">ampcont</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="n">ctfPhaseShift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">PhaseShift</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctfPhaseShift</span></div>


<div class="viewcode-block" id="getLastParticlesParams"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.getLastParticlesParams">[docs]</a><span class="k">def</span> <span class="nf">getLastParticlesParams</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dictionary containing the params values of the last iteration.</span>

<span class="sd">    Key: Particle index (int)</span>
<span class="sd">    Value: Dict[{coverage: float, score: float, alignMatrix: list[float]}]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># JSON files with particles params: path/to/particle_parms_NN.json</span>
    <span class="n">particleParamsPaths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;particle_parms_*.json&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">particleParamsPaths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Particle params files not found&quot;</span><span class="p">)</span>

    <span class="n">lastParticleParamsPath</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">particleParamsPaths</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">particlesParams</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lastParticleParamsPath</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">particlesParams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># key: &#39;(path/to/particles/basename.hdf&#39;, nParticle)&#39;</span>
        <span class="c1"># values: &#39;{&quot;coverage&quot;: 1.0, &quot;score&quot;: 2.0, &quot;xform.align3d&quot;: {&quot;matrix&quot;: [...]}}&#39;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\)$&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">particleIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coverage&quot;</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
        <span class="n">alignMatrix</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xform.align3d&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;matrix&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="ow">and</span> <span class="n">score</span> <span class="ow">and</span> <span class="n">alignMatrix</span><span class="p">:</span>
            <span class="n">customParticleParams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">coverage</span><span class="o">=</span><span class="n">coverage</span><span class="p">,</span>
                <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                <span class="n">alignMatrix</span><span class="o">=</span><span class="n">alignMatrix</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="n">particleIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">customParticleParams</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="updateSetOfSubTomograms"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.updateSetOfSubTomograms">[docs]</a><span class="k">def</span> <span class="nf">updateSetOfSubTomograms</span><span class="p">(</span><span class="n">inputSetOfSubTomograms</span><span class="p">,</span> <span class="n">outputSetOfSubTomograms</span><span class="p">,</span> <span class="n">particlesParams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update a set of subtomograms from a template and copy attributes coverage/score/transform&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">updateSubTomogram</span><span class="p">(</span><span class="n">subTomogram</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">particleParams</span> <span class="o">=</span> <span class="n">particlesParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">particleParams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not get params for particle </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">subTomogram</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="n">particleParams</span><span class="p">[</span><span class="s2">&quot;coverage&quot;</span><span class="p">]))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">subTomogram</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="n">particleParams</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]))</span>
        <span class="c1"># Create 4x4 matrix from 4x3 e2spt_sgd align matrix and append row [0,0,0,1]</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">particleParams</span><span class="p">[</span><span class="s2">&quot;alignMatrix&quot;</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">am</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">am</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="n">am</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">samplingRate</span> <span class="o">=</span> <span class="n">outputSetOfSubTomograms</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">am</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">samplingRate</span><span class="p">,</span> <span class="n">am</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">samplingRate</span><span class="p">,</span> <span class="n">am</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="n">samplingRate</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">angles</span><span class="p">,</span> <span class="n">shift</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">subTomogram</span><span class="o">.</span><span class="n">setTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>

    <span class="n">outputSetOfSubTomograms</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">inputSetOfSubTomograms</span><span class="p">,</span>
                                      <span class="n">updateItemCallback</span><span class="o">=</span><span class="n">updateSubTomogram</span><span class="p">,</span>
                                      <span class="n">itemDataIterator</span><span class="o">=</span><span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="setCoords3D2Jsons"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.setCoords3D2Jsons">[docs]</a><span class="k">def</span> <span class="nf">setCoords3D2Jsons</span><span class="p">(</span><span class="n">setTomograms</span><span class="p">,</span> <span class="n">setCoords</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tomo</span> <span class="ow">in</span> <span class="n">setTomograms</span><span class="o">.</span><span class="n">getFiles</span><span class="p">():</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coor</span> <span class="ow">in</span> <span class="n">setCoords</span><span class="o">.</span><span class="n">iterCoordinates</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">tomo</span><span class="p">)</span> <span class="o">==</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">coor</span><span class="o">.</span><span class="n">getVolName</span><span class="p">()):</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">coor</span><span class="o">.</span><span class="n">getX</span><span class="p">(),</span> <span class="n">coor</span><span class="o">.</span><span class="n">getY</span><span class="p">(),</span> <span class="n">coor</span><span class="o">.</span><span class="n">getZ</span><span class="p">(),</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">coordDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;boxes_3d&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span>
                     <span class="s2">&quot;class_list&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;boxsize&quot;</span><span class="p">:</span> <span class="n">setCoords</span><span class="o">.</span><span class="n">getBoxSize</span><span class="p">(),</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;particles_00&quot;</span><span class="p">}}</span>
                     <span class="p">}</span>
        <span class="n">tomoBasename</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">tomo</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">tomoBasename</span><span class="p">:</span>
            <span class="n">fnInputCoor</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_info.json&#39;</span> <span class="o">%</span> <span class="n">tomoBasename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parentFolder</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tomo</span><span class="p">))</span>
            <span class="n">fnInputCoor</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">_info.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentFolder</span><span class="p">,</span> <span class="n">tomoBasename</span><span class="p">)</span>
        <span class="n">pathInputCoor</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fnInputCoor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">writeJson</span><span class="p">(</span><span class="n">coordDict</span><span class="p">,</span> <span class="n">pathInputCoor</span><span class="p">)</span></div>


<div class="viewcode-block" id="jsons2SetCoords3D"><a class="viewcode-back" href="../../../api/emantomo/emantomo.convert.convert.html#emantomo.convert.convert.jsons2SetCoords3D">[docs]</a><span class="k">def</span> <span class="nf">jsons2SetCoords3D</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">setTomograms</span><span class="p">,</span> <span class="n">outPath</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">tomo.objects</span> <span class="k">import</span> <span class="n">SetOfCoordinates3D</span>
    <span class="n">coord3DSetDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">_getOutputSuffix</span><span class="p">(</span><span class="n">SetOfCoordinates3D</span><span class="p">)</span>
    <span class="n">coord3DSet</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">_createSetOfCoordinates3D</span><span class="p">(</span><span class="n">setTomograms</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="n">coord3DSet</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;tomoCoord&quot;</span><span class="p">)</span>
    <span class="n">coord3DSet</span><span class="o">.</span><span class="n">setPrecedents</span><span class="p">(</span><span class="n">setTomograms</span><span class="p">)</span>
    <span class="n">coord3DSet</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">setTomograms</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
    <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">tomo</span> <span class="ow">in</span> <span class="n">setTomograms</span><span class="o">.</span><span class="n">iterItems</span><span class="p">():</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">_info.json&#39;</span> <span class="o">%</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">tomo</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span> <span class="n">outFile</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">continue</span>

        <span class="n">jsonFnbase</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jsonBoxDict</span> <span class="o">=</span> <span class="n">loadJson</span><span class="p">(</span><span class="n">jsonFnbase</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">coord3DSet</span><span class="o">.</span><span class="n">setBoxSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">jsonBoxDict</span><span class="p">[</span><span class="s2">&quot;class_list&quot;</span><span class="p">][</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;boxsize&quot;</span><span class="p">]))</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">jsonBoxDict</span><span class="p">[</span><span class="s2">&quot;class_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">coord3DSetDict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord3DSet</span>

        <span class="c1"># Populate Set of 3D Coordinates with 3D Coordinates</span>
        <span class="n">readSetOfCoordinates3D</span><span class="p">(</span><span class="n">jsonBoxDict</span><span class="p">,</span> <span class="n">coord3DSetDict</span><span class="p">,</span> <span class="n">tomo</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">jsonFnbase</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">OUTPUT_PREFIX</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord3DSet</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="n">setTomograms</span><span class="p">,</span> <span class="n">coord3DSet</span><span class="p">)</span>

    <span class="c1"># Update Outputs</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">coord3DSet</span> <span class="ow">in</span> <span class="n">coord3DSetDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">coord3DSet</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">coord3DSet</span><span class="o">.</span><span class="n">STREAM_CLOSED</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dependabot_pip_jinja2-2.11.3/index.html">dependabot/pip/jinja2-2.11.3</a></dd>
            <dd><a href="../../../../dependabot_pip_pygments-2.7.4/index.html">dependabot/pip/pygments-2.7.4</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="convert.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>