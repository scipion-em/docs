<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyworkflow.gui.project.viewprotocols_extra &mdash; Scipion 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Scipion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#image-processing-resources">Image processing resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Scipion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>pyworkflow.gui.project.viewprotocols_extra</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyworkflow.gui.project.viewprotocols_extra</h1><div class="highlight"><pre>
<span></span>    <span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Pablo Conesa [1]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="sd">&quot;&quot;&quot; This modules hosts most of the accessory code that is used in view protocols&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>

<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">import</span>  <span class="nn">pyworkflow.gui</span> <span class="k">as</span> <span class="nn">pwgui</span>
<span class="kn">import</span> <span class="nn">pyworkflow.object</span> <span class="k">as</span> <span class="nn">pwobj</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pyworkflow.gui.project.utils</span> <span class="kn">import</span> <span class="n">isAFinalProtocol</span>
<span class="kn">from</span> <span class="nn">pyworkflow.project</span> <span class="kn">import</span> <span class="n">MenuConfig</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Icon</span>
<span class="kn">from</span> <span class="nn">pyworkflow.viewer</span> <span class="kn">import</span> <span class="n">DESKTOP_TKINTER</span>



<div class="viewcode-block" id="RunIOTreeProvider"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider">[docs]</a><span class="k">class</span> <span class="nc">RunIOTreeProvider</span><span class="p">(</span><span class="n">pwgui</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">TreeProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the tree elements from a Protocol Run input/output children&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">loggerCallback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param parent:</span>
<span class="sd">        :param protocol:</span>
<span class="sd">        :param mapper:</span>
<span class="sd">        :param loggerCallback: method to call to log events in the gui.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggerCallback</span> <span class="o">=</span> <span class="n">loggerCallback</span>

<div class="viewcode-block" id="RunIOTreeProvider.getColumns"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getColumns">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getColumns</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;Attribute&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Info&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span></div>

<div class="viewcode-block" id="RunIOTreeProvider.getObjects"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getObjects">[docs]</a>    <span class="k">def</span> <span class="nf">getObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Store a dict with input parents (input, PointerList)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span> <span class="o">=</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">inputObj</span> <span class="o">=</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_INPUT</span><span class="p">)</span>
            <span class="n">inputObj</span><span class="o">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_IN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="s1">&#39;_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputObj</span>
            <span class="n">inputParents</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputObj</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">iterInputAttributes</span><span class="p">():</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">_parentKey</span> <span class="o">=</span> <span class="n">key</span>
                <span class="c1"># Repeated keys means there are inside a pointerList</span>
                <span class="c1"># since the same key is yielded for all items inside</span>
                <span class="c1"># so update the parent dict with a new object</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">inputObj</span><span class="p">:</span>
                        <span class="n">parentObj</span> <span class="o">=</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">parentObj</span><span class="o">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_IN</span>
                        <span class="n">parentObj</span><span class="o">.</span><span class="n">_parentKey</span> <span class="o">=</span> <span class="s1">&#39;_input&#39;</span>
                        <span class="n">inputParents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parentObj</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parentObj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputObj</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputStr</span> <span class="o">=</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_OUTPUT</span><span class="p">)</span>
            <span class="n">objs</span> <span class="o">=</span> <span class="n">inputParents</span> <span class="o">+</span> <span class="n">inputs</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputStr</span><span class="p">]</span> <span class="o">+</span> <span class="n">outputs</span>
        <span class="k">return</span> <span class="n">objs</span></div>

    <span class="k">def</span> <span class="nf">_visualizeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ViewerClass</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="n">ViewerClass</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">getProject</span><span class="p">(),</span>
                             <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                             <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_editObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the Edit GUI Form given an instance&quot;&quot;&quot;</span>
        <span class="n">pwgui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">EditObjectDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Message</span><span class="o">.</span><span class="n">TITLE_EDIT_OBJECT</span><span class="p">,</span>
                                      <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_deleteObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove unnecessary output, specially for Coordinates. &quot;&quot;&quot;</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">objLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectLabel</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">prot</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s2">&quot;Delete object&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;Are you sure to delete *</span><span class="si">%s</span><span class="s2">* object?&quot;</span>
                                            <span class="o">%</span> <span class="n">objLabel</span><span class="p">):</span>
                <span class="n">prot</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">deleteProtocolOutput</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_fillSummary</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showInfo</span><span class="p">(</span><span class="s2">&quot;Object *</span><span class="si">%s</span><span class="s2">* successfully deleted.&quot;</span>
                                             <span class="o">%</span> <span class="n">objLabel</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

<div class="viewcode-block" id="RunIOTreeProvider.getObjectPreview"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getObjectPreview">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getObjectPreview</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;&lt;name&gt;: &quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">desc</span></div>

<div class="viewcode-block" id="RunIOTreeProvider.getObjectActions"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getObjectActions">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectActions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">Pointer</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">isPointer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isPointer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If viewers not loaded yet (firstime)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">viewersLoaded</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loggerCallback</span><span class="p">(</span><span class="s2">&quot;Discovering viewers for the first time across all the plugins.&quot;</span><span class="p">)</span>


        <span class="n">viewers</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">()</span><span class="o">.</span><span class="n">findViewers</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span> <span class="n">DESKTOP_TKINTER</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">viewerCallback</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visualizeObject</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">viewers</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                            <span class="n">viewerCallback</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
                            <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_VISUALIZE</span><span class="p">))</span>
        <span class="c1"># EDIT</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_EDIT</span><span class="p">,</span>
                        <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editObject</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                        <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_EDIT</span><span class="p">))</span>
        <span class="c1"># DELETE</span>
        <span class="c1"># Special case to allow delete outputCoordinates</span>
        <span class="c1"># since we can end up with several outputs and</span>
        <span class="c1"># we may want to clean up</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">allowsDelete</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isPointer</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Message</span><span class="o">.</span><span class="n">LABEL_DELETE</span><span class="p">,</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleteObject</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                            <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_DELETE</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">actions</span></div>

<div class="viewcode-block" id="RunIOTreeProvider.getObjectLabel"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getObjectLabel">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getObjectLabel</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; We will try to show in the list the string representation</span>
<span class="sd">        that is more readable for the user to pick the desired object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                <span class="n">parentLabel</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">()</span> <span class="k">if</span> <span class="n">parent</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentLabel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">getLastName</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">label</span></div>

<div class="viewcode-block" id="RunIOTreeProvider.getObjectInfo"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.RunIOTreeProvider.getObjectInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">stringToInfo</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; String objects converted to info dictionary for the tree&quot;&quot;&quot;</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">infoStr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_parentKey&#39;</span><span class="p">):</span>
                <span class="n">infoStr</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_parentKey</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">infoStr</span>

        <span class="k">def</span> <span class="nf">labelToValue</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; To tolerate str(labelObj) in case xmippLib is missing, but</span>
<span class="sd">            still being able to open a project.&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not convert object </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2"> to string.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">pointerToInfo</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Converts a Pointer into an info dictionary for the tree&quot;&quot;&quot;</span>

            <span class="n">namePtr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getLastName</span><span class="p">()</span>
            <span class="c1"># Remove ugly item notations inside lists</span>
            <span class="n">namePtr</span> <span class="o">=</span> <span class="n">namePtr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__item__000&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Consider Pointer as inputs</span>
            <span class="n">imagePtr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_icon&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">parentPtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParentDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_parentKey</span><span class="p">]</span>

            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">hasExtended</span><span class="p">():</span>
                <span class="c1"># getExtended method remove old attributes conventions.</span>
                <span class="n">extendedValue</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getExtended</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">hasExtended</span><span class="p">():</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">extendedValue</span>
                <span class="c1"># else:</span>
                <span class="c1">#     suffix = &#39;[Item %s]&#39; % extendedValue</span>

                <span class="c1"># Tolerate loading projects:</span>
                <span class="c1"># When having only the project sqlite..an obj.get() will</span>
                <span class="c1"># the load of the set...and if it is missing this whole</span>
                <span class="c1"># &quot;thread&quot; fails.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelObjPtr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">labelObjPtr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">labelObjPtr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>
                        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">parentPtr</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">imagePtr</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">namePtr</span><span class="p">,</span>
                            <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Couldn&#39;t read object attributes.&quot;</span><span class="p">,)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labelObjPtr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="n">objKeyPtr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_parentKey</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">labelObjPtr</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="n">labelPtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectLabel</span><span class="p">(</span><span class="n">labelObjPtr</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">getParent</span><span class="p">(</span><span class="n">labelObjPtr</span><span class="p">))</span>
            <span class="n">namePtr</span> <span class="o">+=</span> <span class="s1">&#39;   (from </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labelPtr</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
            <span class="n">valuePtr</span> <span class="o">=</span> <span class="n">labelToValue</span><span class="p">(</span><span class="n">labelObjPtr</span><span class="p">,</span> <span class="n">objKeyPtr</span><span class="p">,</span> <span class="n">namePtr</span><span class="p">)</span>
            <span class="n">infoPtr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">objKeyPtr</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">parentPtr</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">imagePtr</span><span class="p">,</span>
                    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">namePtr</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">valuePtr</span><span class="p">,)}</span>

            <span class="k">return</span> <span class="n">infoPtr</span>


        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">String</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">stringToInfo</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All attributes are considered output, unless they are pointers</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">ACTION_OUT</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputStr</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">Pointer</span><span class="p">):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">pointerToInfo</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectLabel</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
                <span class="n">objKey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
                <span class="n">labelObj</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">labelToValue</span><span class="p">(</span><span class="n">labelObj</span><span class="p">,</span> <span class="n">objKey</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">objKey</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
                        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">value</span><span class="p">,)}</span>
        <span class="k">return</span> <span class="n">info</span></div></div>

<div class="viewcode-block" id="ProtocolTreeConfig"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.ProtocolTreeConfig">[docs]</a><span class="k">class</span> <span class="nc">ProtocolTreeConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Handler class that groups functions and constants</span>
<span class="sd">    related to the protocols tree configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ALL_PROTOCOLS</span> <span class="o">=</span> <span class="s2">&quot;All&quot;</span>
    <span class="n">TAG_PROTOCOL_DISABLED</span> <span class="o">=</span> <span class="s1">&#39;protocol-disabled&#39;</span>
    <span class="n">TAG_PROTOCOL</span> <span class="o">=</span> <span class="s1">&#39;protocol&#39;</span>
    <span class="n">TAG_SECTION</span> <span class="o">=</span> <span class="s1">&#39;section&#39;</span>
    <span class="n">TAG_PROTOCOL_GROUP</span> <span class="o">=</span> <span class="s1">&#39;protocol_group&#39;</span>
    <span class="n">TAG_PROTOCOL_BETA</span> <span class="o">=</span> <span class="s1">&#39;protocol_beta&#39;</span>
    <span class="n">TAG_PROTOCOL_NEW</span> <span class="o">=</span> <span class="s1">&#39;protocol_new&#39;</span>
    <span class="n">TAG_PROTOCOL_UPDATED</span> <span class="o">=</span> <span class="s1">&#39;protocol_updated&#39;</span>
    <span class="n">PLUGIN_CONFIG_PROTOCOLS</span> <span class="o">=</span> <span class="s1">&#39;protocols.conf&#39;</span>

<div class="viewcode-block" id="ProtocolTreeConfig.getProtocolTag"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.ProtocolTreeConfig.getProtocolTag">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getProtocolTag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">isInstalled</span><span class="p">,</span> <span class="n">isBeta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">isNew</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">isUpdated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the proper tag depending if the protocol is installed or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isInstalled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isBeta</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL_BETA</span>
            <span class="k">elif</span> <span class="n">isNew</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL_NEW</span>
            <span class="k">elif</span> <span class="n">isUpdated</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL_UPDATED</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL_DISABLED</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__addToTree</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">menu</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">checkFunction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper function to recursively add items to a menu.</span>
<span class="sd">        Add item (a dictionary that can contain more dictionaries) to menu</span>
<span class="sd">        If check function is added will use it to check if the value must be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">checkFunction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">checkFunction</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">add</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">subMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addSubMenu</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># we expect item={&#39;text&#39;: ...}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__addToTree</span><span class="p">(</span><span class="n">subMenu</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">checkFunction</span><span class="p">)</span>  <span class="c1"># add recursively to sub-menu</span>

        <span class="k">return</span> <span class="n">subMenu</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__inSubMenu</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">subMenu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if child belongs to subMenu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">subMenu</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__isProtocol</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ch</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">ch</span>
            <span class="k">elif</span> <span class="n">ch</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_orderSubMenu</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort all children of a given section:</span>
<span class="sd">        The protocols first, then the sections (the &#39;more&#39; section at the end)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">sortWhenLastIsAProtocol</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Sorts children when the last is a protocol&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lastChildPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">childs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="k">def</span> <span class="nf">sortWhenLastIsNotAProtocol</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Sorts children when the last is NOT a protocol&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lastChildPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;more&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">childs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="n">lengthSession</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">childs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lengthSession</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">childs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">childs</span>
            <span class="n">lastChildPos</span> <span class="o">=</span> <span class="n">lengthSession</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">childs</span><span class="p">[</span><span class="n">lastChildPos</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span><span class="p">:</span>
                <span class="n">sortWhenLastIsAProtocol</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sortWhenLastIsNotAProtocol</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__findTreeLocation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subMenu</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Locate the protocol position in the given view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__inSubMenu</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">subMenu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__addToTree</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__checkItem</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_orderSubMenu</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL_GROUP</span> <span class="ow">or</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_SECTION</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__findTreeLocation</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">childs</span><span class="p">,</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span> <span class="n">sm</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__isProtocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; True inf the item has a key named tag with protocol as value&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__isProtocolNode</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; True if tag attribute is protocol&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TAG_PROTOCOL</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__checkItem</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to check if the protocol has to be added or not.</span>
<span class="sd">        Params:</span>
<span class="sd">            item: {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtImportMovies&quot;,</span>
<span class="sd">                   &quot;text&quot;: &quot;import movies&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__isProtocol</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># It is a protocol as this point, get the class name and</span>
        <span class="c1"># check if it is disabled</span>
        <span class="n">protClassName</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">protClass</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">()</span><span class="o">.</span><span class="n">getProtocols</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protClassName</span><span class="p">)</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">PRODUCTION</span>
        <span class="k">if</span> <span class="n">protClass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">protClass</span><span class="o">.</span><span class="n">isBeta</span><span class="p">():</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">BETA</span>
            <span class="k">elif</span> <span class="n">protClass</span><span class="o">.</span><span class="n">isNewDev</span><span class="p">():</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">NEW</span>
            <span class="k">elif</span> <span class="n">protClass</span><span class="o">.</span><span class="n">isUpdated</span><span class="p">():</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">UPDATED</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">icon</span>
        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">protClass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="ow">not</span> <span class="n">protClass</span><span class="o">.</span><span class="n">isDisabled</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__addAllProtocols</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">protocols</span><span class="p">):</span>
        <span class="c1"># Add all protocols</span>
        <span class="n">allProts</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">getProtocols</span><span class="p">()</span>

        <span class="c1"># Sort the list</span>
        <span class="n">allProtsSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allProts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getClassLabel</span><span class="p">())</span>

        <span class="n">allProtMenu</span> <span class="o">=</span> <span class="n">ProtocolConfig</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ALL_PROTOCOLS</span><span class="p">)</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Group protocols by package name</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allProtsSorted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isAFinalProtocol</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="n">packageName</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>

                <span class="c1"># Get the package submenu</span>
                <span class="n">packageMenu</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span>

                <span class="c1"># If no package menu available</span>
                <span class="k">if</span> <span class="n">packageMenu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Add it to the menu ...</span>
                    <span class="n">packageLine</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">packageName</span><span class="p">,</span>
                                   <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">packageName</span><span class="p">}</span>
                    <span class="n">packageMenu</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__addToTree</span><span class="p">(</span><span class="n">allProtMenu</span><span class="p">,</span> <span class="n">packageLine</span><span class="p">)</span>

                    <span class="c1"># Store it in the dict</span>
                    <span class="n">packages</span><span class="p">[</span><span class="n">packageName</span><span class="p">]</span> <span class="o">=</span> <span class="n">packageMenu</span>

                <span class="c1"># Add the protocol</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getProtocolTag</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">isBeta</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">isNewDev</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">isUpdated</span><span class="p">())</span>

                <span class="n">protLine</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">getClassLabel</span><span class="p">(</span><span class="n">prependPackageName</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>

                <span class="bp">cls</span><span class="o">.</span><span class="n">__addToTree</span><span class="p">(</span><span class="n">packageMenu</span><span class="p">,</span> <span class="n">protLine</span><span class="p">)</span>

        <span class="n">protocols</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ALL_PROTOCOLS</span><span class="p">]</span> <span class="o">=</span> <span class="n">allProtMenu</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__addProtocolsFromConf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">protocolsConfPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the protocols in the tree from a given protocols.conf file,</span>
<span class="sd">        either the global one in Scipion or defined in a plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">addProtocols</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Adds protocols defined in the &quot;PROTOCOLS&quot; section of the config file. &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">menuName</span> <span class="ow">in</span> <span class="n">cp</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s1">&#39;PROTOCOLS&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">menuName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>  <span class="c1"># The view has not been inserted</span>
                    <span class="n">menu</span> <span class="o">=</span> <span class="n">ProtocolConfig</span><span class="p">(</span><span class="n">menuName</span><span class="p">)</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROTOCOLS&#39;</span><span class="p">,</span> <span class="n">menuName</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">__addToTree</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__checkItem</span><span class="p">)</span>
                    <span class="n">protocols</span><span class="p">[</span><span class="n">menuName</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># The view has been inserted</span>
                    <span class="n">menu</span> <span class="o">=</span> <span class="n">protocols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">menuName</span><span class="p">)</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROTOCOLS&#39;</span><span class="p">,</span>
                                                 <span class="n">menuName</span><span class="p">))</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">__findTreeLocation</span><span class="p">(</span><span class="n">menu</span><span class="o">.</span><span class="n">childs</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>

        <span class="c1"># Populate the protocols menu from the plugin config file.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">protocolsConfPath</span><span class="p">):</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>  <span class="c1"># keep case</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">protocolsConfPath</span><span class="p">)</span>
            <span class="c1">#  Ensure that the protocols section exists</span>
            <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;PROTOCOLS&#39;</span><span class="p">):</span>
                <span class="n">addProtocols</span><span class="p">()</span>

<div class="viewcode-block" id="ProtocolTreeConfig.load"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.ProtocolTreeConfig.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">protocolsConf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read the protocol configuration from a .conf file similar to the</span>
<span class="sd">        one in scipion/config/protocols.conf,</span>
<span class="sd">        which is the default one when no file is passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># Read the protocols.conf from Scipion (base) and create an initial</span>
        <span class="c1"># tree view</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__addProtocolsFromConf</span><span class="p">(</span><span class="n">protocols</span><span class="p">,</span> <span class="n">protocolsConf</span><span class="p">)</span>

        <span class="c1"># Read the protocols.conf of any installed plugin</span>
        <span class="n">pluginDict</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">getPlugins</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pluginName</span> <span class="ow">in</span> <span class="n">pluginDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="c1"># if the plugin has a path</span>
                <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">isModuleLoaded</span><span class="p">(</span><span class="n">pluginName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">isModuleAFolder</span><span class="p">(</span><span class="n">pluginName</span><span class="p">):</span>
                    <span class="c1"># Locate the plugin protocols.conf file</span>
                    <span class="n">protocolsConfPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">pluginDict</span><span class="p">[</span><span class="n">pluginName</span><span class="p">]</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">PLUGIN_CONFIG_PROTOCOLS</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">__addProtocolsFromConf</span><span class="p">(</span><span class="n">protocols</span><span class="p">,</span> <span class="n">protocolsConfPath</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to read settings. The reported error was:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                      <span class="s1">&#39;To solve it, fix </span><span class="si">%s</span><span class="s1"> and run again.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">protocolsConfPath</span><span class="p">)))</span>

        <span class="c1"># Clean empty sections</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_hideEmptySections</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span>

        <span class="c1"># Add all protocols to All view</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__addAllProtocols</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">protocols</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">protocols</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hideEmptySections</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">protocols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Cleans all empty sections in the tree&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">protConf</span> <span class="ow">in</span> <span class="n">protocols</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_setVisibility</span><span class="p">(</span><span class="n">protConf</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_setVisibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the visibility of a node based on the presence of a leaf hanging form it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__isProtocolNode</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="c1"># Default visibility value is true. No need to set it again</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">anyLeaf</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">childs</span><span class="p">:</span>
            <span class="c1"># NOTE: since python short circuits this, _setVisibility must be called always. So not swap!!</span>
            <span class="n">anyLeaf</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_setVisibility</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="ow">or</span> <span class="n">anyLeaf</span>

        <span class="n">node</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="n">anyLeaf</span>

        <span class="k">return</span> <span class="n">anyLeaf</span></div>


<div class="viewcode-block" id="ProtocolConfig"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.ProtocolConfig">[docs]</a><span class="k">class</span> <span class="nc">ProtocolConfig</span><span class="p">(</span><span class="n">MenuConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store protocols configuration &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">MenuConfig</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;openItem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;protocol_base&#39;</span>

<div class="viewcode-block" id="ProtocolConfig.addSubMenu"><a class="viewcode-back" href="../../../../api/pyworkflow/pyworkflow.gui.project.viewprotocols_extra.html#pyworkflow.gui.project.viewprotocols_extra.ProtocolConfig.addSubMenu">[docs]</a>    <span class="k">def</span> <span class="nf">addSubMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shortCut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;icon&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;protocol_base&#39;</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Icon</span><span class="o">.</span><span class="n">GROUP</span>

        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;shortCut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shortCut</span>
        <span class="k">return</span> <span class="n">MenuConfig</span><span class="o">.</span><span class="n">addSubMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scipion team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>