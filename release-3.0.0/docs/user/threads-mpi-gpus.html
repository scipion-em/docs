<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; Scipion 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Scipion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-documentation.html#image-processing-resources">Image processing resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/user/threads-mpi-gpus.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="figure align-default">
<a class="reference internal image-reference" href="../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="introduction">
<span id="threadsmpigpus"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h1>
<p>Scipion integrates many different software. Additionally, it has some internal protocols like “import” protocols or
generic tools like various sub-setting protocols. Any protocol defines a specific execution plan that may or
may not allow to run its internal steps in parallel. The execution plan is a list of <strong>steps</strong> that may have
dependencies.</p>
<div class="section" id="simplest-execution-plan">
<h2>Simplest execution plan<a class="headerlink" href="#simplest-execution-plan" title="Permalink to this heading"></a></h2>
<p>The simplest protocols in terms of execution plan might be the “import” ones. They usually define a single-step execution plan and do not have any dependencies.
These protocols do not show the parallelization section/parameters as we will show later.</p>
<div class="figure align-default" id="id1">
<img alt="Import particles protocol" src="../../_images/executed_import_particles.png" />
<p class="caption"><span class="caption-text">The “import particles” protocol is a single-step protocol. There is no chance to parallelize nor an opportunity to
define dependencies.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</div>
<p>The execution plan is the first thing that happens when a protocol is executed and therefore can only be seen for
running, failed or finished protocols. To show the execution plan of a protocol you can press “Shift + s” in the project.</p>
<div class="figure align-default" id="id2">
<img alt="Execution plan of the Import particles protocol" src="../../_images/simplest-exec-plan.png" />
<p class="caption"><span class="caption-text">Simplest execution plan. Just one step defined.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</div>
<div class="section" id="serial-execution-plan">
<h3>Serial execution plan<a class="headerlink" href="#serial-execution-plan" title="Permalink to this heading"></a></h3>
<p>A serial execution plan is a set of steps that run one after another. They are usually linear but there could
be cases where there are branches. But in any case, 2 steps are NEVER running simultaneously.</p>
<div class="figure align-default" id="id3">
<img alt="Serial execution plan: in this case, steps 1 and 2 could run in parallel but the protocol does NOT offer threads to do so." src="../../_images/serial-exec-plan.png" />
<p class="caption"><span class="caption-text">Serial execution plan: in this case, steps 1 and 2 could be run in parallel but the protocol does NOT offer threads to do so.</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="parallelization">
<h3>Parallelization<a class="headerlink" href="#parallelization" title="Permalink to this heading"></a></h3>
<p>Parallelization is a technique that allows to run code concurrently. There are 2 different ways
to parallelize a protocol in Scipion which is decided by the developer: Scipion parallelization or 3rd party
parallelization. Parallelization is typically done using “Threads” or “MPIs” or both. Scipion parallelization is
only done by Threads.</p>
<div class="section" id="rd-party-parallelization">
<h4>3rd party parallelization<a class="headerlink" href="#rd-party-parallelization" title="Permalink to this heading"></a></h4>
<p>In this case, the software Scipion integrates is already parallelized and typically it just needs to know how many
threads or MPI you want to use. The protocol window in Scipion shows the “parallel section” parameters
with thread and/or MPIs but the execution plan (steps) are serial. The only difference is that a certain step will
call the “3rd party program” with some arguments that will tell that program to create
threads or MPIs. It is the external software the one that deals with parallelization, not Scipion.</p>
<div class="figure align-default" id="id4">
<img alt="Relion refine form and execution plan showing a serial step layout." src="../../_images/external-parallelization.png" />
<p class="caption"><span class="caption-text">Relion refine protocol form and execution plan showing a serial step layout. Nevertheless, the form displays a parallel section with threads
and MPIs that are handled by Relion</span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="scipion-parallelization">
<h4>Scipion parallelization<a class="headerlink" href="#scipion-parallelization" title="Permalink to this heading"></a></h4>
<p>In this case, Scipion is doing the parallelization. The execution plan (steps) can run in parallel providing the
dependencies are met. These protocols show “Scipion threads” in the form and the execution plan should show 2 or more
branches where steps could be running at the same time.</p>
<div class="figure align-default" id="id5">
<img alt="Screenshots of Aretomo form and execution plan." src="../../_images/scipion-exec-plan.png" />
<p class="caption"><span class="caption-text">Aretomo (cryo-electron tomography method) is parallelized using Scipion threads. The execution plan shows the step
1 is independent from step 2 and could run in parallel at the same time. When step 2 finishes, step 3 can start while
step 1 is still active.</span><a class="headerlink" href="#id5" title="Permalink to this image"></a></p>
</div>
<div class="section" id="gpus">
<h5>GPUs<a class="headerlink" href="#gpus" title="Permalink to this heading"></a></h5>
<p>Some of the programs can use GPU acceleration. A machine/node could have GPUs installed and you may want to use one,
two or more of them. The way to specify GPU/s to use is by GPU ID: a number starting from 0.
If the protocol supports GPU acceleration, then you should see a corresponding field in the form.
See “Aretomo” image above has 0 in the <em>GPU IDs</em> field. This means that aretomo will use GPU 0 for any of its steps
that may require a GPU.</p>
<p>Now, depending on the execution plan of the protocol, same GPU could be used in parallel at the same time. This could
be what you actually want, or maybe you want to prevent this in case the program “needs” a dedicated
GPU and does not like sharing it with “other” GPUs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can specify more than 1 GPUs separating them by either commas or spaces: “0 1 2” or “0,1,2”</p>
</div>
</div>
</div>
<div class="section" id="serial-execution-and-gpus">
<h4>Serial execution and GPUs<a class="headerlink" href="#serial-execution-and-gpus" title="Permalink to this heading"></a></h4>
<p>This is probably the simplest case. In a serial execution plan there is NO parallelization, so whichever value you enter
in the “GPUs ID” field will be used in any step.</p>
</div>
<div class="section" id="rd-party-parallelization-and-gpus">
<h4>3rd party parallelization and GPUs<a class="headerlink" href="#rd-party-parallelization-and-gpus" title="Permalink to this heading"></a></h4>
<p>This case is very much like the previous one. Since Scipion is not doing the parallelization whatever is entered in
the GPU field is passed to the software.</p>
</div>
<div class="section" id="scipion-parallelization-ans-gpus">
<h4>Scipion parallelization ans GPUs<a class="headerlink" href="#scipion-parallelization-ans-gpus" title="Permalink to this heading"></a></h4>
<p>This case can be used in multiple scenarios. Let’s start with the simplest example. You want all steps that can run in parallel
to use the same GPU (GPU ID 0). Let’s assume we have specified 3 threads in the “Scipion threads” field. One thread is required
for the main process and 2 threads are for the processing steps. 2 processing threads need 2 “slots” for GPUs. This can be done by setting GPU IDs to “0,0” or “0 0”.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you just set GPU IDs = 0 then Scipion will interpret this as only 1 available slot for GPU processing and parallelization will not happen.</p>
</div>
<p>If you have 2 GPUs (GPU IDs 0 and 3) and 2 processing threads available and you want/need to assign one GPU per thread you can just
set GPU IDs to “0,3”.</p>
<p>If you have 4 GPUs (GPU IDs 0,1,2,3) and 2 processing threads you could specify all GPU IDs (0,1,2,3), and then Scipion will spread the GPUs evenly
among the processing threads: 0,1 for one thread and 2,3 for the other.</p>
<p>Here is table summarizing some common cases:</p>
<table class="colwidths-given docutils align-default" id="id6">
<caption><span class="caption-text">Threads and GPUs cases</span><a class="headerlink" href="#id6" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Scipion threads</p></th>
<th class="head"><p>Processing threads</p></th>
<th class="head"><p>GPUs Id</p></th>
<th class="head"><p>GPU slots</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4</p></td>
<td><p>3</p></td>
<td><p>0</p></td>
<td><p>1 (0)</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>2</p></td>
<td><p>2,4</p></td>
<td><p>2 (2 and 4)</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>1</p></td>
<td><p>3,4,5</p></td>
<td><p>1 (3,4,5)</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>2</p></td>
<td><p>2,4,2,4</p></td>
<td><p>2 (2,4 and 2,4)</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>4</p></td>
<td><p>0,1,2,3</p></td>
<td><p>4 (each GPU gets one thread)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="void-gpus">
<h4>Void GPUs<a class="headerlink" href="#void-gpus" title="Permalink to this heading"></a></h4>
<p>To provide more flexibility in the GPU definition we have created a “void” GPU. This GPU has ID 99 (hope you
don’t have a machine with that amount of GPUs) ;-).</p>
<p>If you enter that value as a GPU ID, the corresponding GPU slot will have one less GPU.</p>
<p>If you enter “Scipion threads” = 3 (2 processing threads) and GPU IDs = “0 1 2 99”, then the first thread will use GPUs 0 and 1, and
the second thread will use just GPU 2.</p>
<p>This method allows to utilise 3 GPUs (2 + 1) in a program that could use one or two GPUs but you have 3 GPUs available</p>
</div>
<div class="section" id="gpus-in-clusters">
<h4>GPUs in clusters<a class="headerlink" href="#gpus-in-clusters" title="Permalink to this heading"></a></h4>
<p>When submitting jobs to a queuing system, Scipion is unaware of the GPU resources available in the queue. In this case, GPU IDs entered
in the protocol form are always renumbered to start from 0. It does not matter if you enter “2 4 7” etc., it will always end up as “0 1 2”.
The queue manager takes responsibility for “remapping” GPUs to the correct IDs.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scipion team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>