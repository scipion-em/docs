

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating a Streaming Protocol &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Creating a Streaming Protocol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/docs/developer/tutorials/creating-streaming-protocol.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="creating-a-streaming-protocol">
<span id="creating-streaming-protocol"></span><h1>Creating a Streaming Protocol<a class="headerlink" href="#creating-a-streaming-protocol" title="Permalink to this headline">¶</a></h1>
<div class="section" id="associated-resources">
<h2>Associated resources<a class="headerlink" href="#associated-resources" title="Permalink to this headline">¶</a></h2>
<p>Here you can find resources associated with this content, like videos or presentations used in courses:</p>
<p><a class="reference external" href="https://docs.google.com/presentation/d/1S7o-9dq6BjGUN7K_w5GjsOO0W5vmCV-q2U2xgDRBiAM/present?usp=sharing">Course presentation</a></p>
</div>
<div class="section" id="practice">
<h2>Practice<a class="headerlink" href="#practice" title="Permalink to this headline">¶</a></h2>
<p>Let’s go to our template plugin folder and setup everything ready for the practice session:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion-em-template
git checkout master
</pre></div>
</div>
<p>We define a <code class="docutils literal notranslate"><span class="pre">streaming</span> <span class="pre">protocol</span></code>  as a processing task that involves
execution of several steps like any other <a class="reference external" href="../creating-a-protocol">Scipion protocol</a>,
but which input might change during the protocol execution. It is thus impossible to
plan all the steps ahead (difference between streaming and non streaming protocols).
The list of steps in a streaming protocol is dynamic, that is, they are added
as the input grows. These steps can even be parallelized. You can read more
about defining steps to be executed in parallel in <a class="reference external" href="../parallelization">Parallelization</a>.</p>
<p>Here we will create a simple streaming protocol that connects to
<a class="reference external" href="https://www.ebi.ac.uk/pdbe/emdb/empiar/">EMPIAR</a> (Electron Microscopy
Public Image Archive), downloads a set of movies and registers them as outputs in parallel.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This protocol is artificially streamified and will have problems with concurrency
or in case of resuming after a failure. But for the sake of simplicity we are
ignoring these problems.</p>
</div>
<p>The general idea of this protocol is as follows:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/streaming_idea.png"><img alt="Streaming Idea" src="../../../_images/streaming_idea.png" style="width: 750px;" /></a>
</div>
<p>In that sense, we need to implement the following steps:</p>
<ol class="arabic">
<li><p class="first">Create a protocol GUI that takes as a parameter the ID of the EMPIAR dataset
as well as a stopping criterion (in our case the number of movies to download).</p>
<p>1.1. Create a protocol and specify that the steps are to be executed in parallel.</p>
<p>1.2. Define the “parallel” section.</p>
</li>
<li><p class="first">Create the steps to download and register the movies.</p>
<p>2.1. Read the xml file corresponding to a specific EMPIAR dataset which contains important metadata (sampling rate, dimensions, …).</p>
<p>2.2. Download the movies until the stopping criteria is met (number of downloaded movies).</p>
<p>2.3. Register the downloaded movies. This step is in streaming. We need to constantly check if new movies have been downloaded.</p>
</li>
</ol>
<div class="section" id="defining-the-protocol-class-and-the-gui">
<h3>Defining the protocol class and the GUI<a class="headerlink" href="#defining-the-protocol-class-and-the-gui" title="Permalink to this headline">¶</a></h3>
<p>The GUI would be as the following figure shows:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/streaming_protocol.png"><img alt="Streaming Protocol" src="../../../_images/streaming_protocol.png" style="width: 550px;" /></a>
</div>
<p>The following code contain the class definition and the protocol GUI implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="kn">import</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">SetOfMovies</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="kn">import</span> <span class="n">EMProtocol</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol</span> <span class="kn">import</span> <span class="n">params</span><span class="p">,</span> <span class="n">Positive</span><span class="p">,</span> <span class="n">STATUS_NEW</span><span class="p">,</span> <span class="n">STEPS_PARALLEL</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>

<span class="k">class</span> <span class="nc">EmpiarDownloader</span><span class="p">(</span><span class="n">EMProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a movie set from EMPIAR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;empiar downloader&#39;</span>
    <span class="n">_outputClassName</span> <span class="o">=</span> <span class="s1">&#39;SetOfMovies&#39;</span> <span class="c1"># Defining the output class</span>
    <span class="n">registeredFiles</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># saves the name of the movies that have been already registered</span>
    <span class="n">_stepsCheckSecs</span> <span class="o">=</span> <span class="mi">3</span>              <span class="c1"># time in seconds to check the steps</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMProtocol</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">=</span> <span class="n">STEPS_PARALLEL</span> <span class="c1"># Defining that the protocol contain parallel steps</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c1"># 1) add a section</span>

        <span class="c1"># 2) add a parameter to capture the EMPIAR entry ID:</span>
        <span class="c1"># name --&gt; entryId, String param, default value 10200, you choose the label</span>
        <span class="c1"># Ideally we want it in bold so it is &quot;Important&quot;. Fill in the help.</span>

        <span class="c1"># 3) add another parameter to set a limit of downloaded files:</span>
        <span class="c1"># name--&gt;amountOfImages, Integer param, default to 1, choose the label and the help</span>
        <span class="c1"># It has to be positive (use &quot;validators&quot; argument, it expects a list of</span>
        <span class="c1"># pyworkflow.protocol.params.Validator, look for the Positive Validator)</span>

        <span class="c1"># 3) Add the parallel section defining the default number of threads and mpi to use</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, we are specifying
<strong>stepsExecutionMode</strong> parameter, and in the <code class="docutils literal notranslate"><span class="pre">_defineParams</span></code> we are invoking
<strong>addParallelSection</strong> method. This tells Scipion that the steps can be
run in parallel (via threads or MPI)</p>
</div>
<p>At this point you should be able to find the protocol using <strong>Ctrl+F</strong>, open it and see the input parameters.</p>
</div>
<div class="section" id="create-the-steps-to-download-and-register-the-movie-set">
<h3>Create the steps to download and register the movie set<a class="headerlink" href="#create-the-steps-to-download-and-register-the-movie-set" title="Permalink to this headline">¶</a></h3>
<p>First, we will implement the <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code> method to define the different steps.
The first step reads the dataset xml file from EMPIAR.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># insert a functionStep (readXmlFileStep) to read the xml file from EMPIAR entry</span>

<span class="k">def</span> <span class="nf">readXmlFileStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Call the method provided below to get some data from the empiar xml</span>

    <span class="c1"># Store returned values as &quot;persistent&quot; attributes: String, Integer, Float</span>

    <span class="c1"># Use _store method to write them</span>

<span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Check if we have the any summary attribute (if readXmlStep has happened) (HINT: hasattr will do)</span>
    <span class="c1"># Add items to the summary list like:</span>
    <span class="c1"># &quot;Title: %s&quot; % ??</span>
    <span class="c1"># &quot;Sampling rate: %s&quot; % ??</span>
    <span class="c1"># How would you have more values in the summary? (HINT: return more values in readXmlFromEmpiar)</span>

    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
<p>We provide you the code that reads EMPIAR’s xml:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">readXmlFromEmpiar</span><span class="p">(</span><span class="n">entryId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the xml file of a specific dataset from EMPIAR repository</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">empiarXmlUrl</span> <span class="o">=</span> <span class="s1">&#39;https://www.ebi.ac.uk/pdbe/emdb/empiar/api/entry/&#39;</span> <span class="o">+</span> <span class="n">entryId</span>  <span class="c1"># URL of EMPIAR API</span>

        <span class="n">xmlFile</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">empiarXmlUrl</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>               <span class="c1"># getting the xml file</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">xmlFile</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>                  <span class="c1"># extract the xml content</span>
        <span class="n">empiarName</span> <span class="o">=</span> <span class="s1">&#39;EMPIAR-&#39;</span> <span class="o">+</span> <span class="n">entryId</span>                                         <span class="c1"># dataset name</span>

        <span class="n">correspondingAuthor</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;corresponding_author&#39;</span><span class="p">]</span>        <span class="c1"># dataset authors</span>
        <span class="n">organization</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">correspondingAuthor</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">][</span><span class="s1">&#39;organization&#39;</span><span class="p">])</span>     <span class="c1"># authors organization</span>
        <span class="n">depositionDate</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;deposition_date&#39;</span><span class="p">])</span>          <span class="c1"># dataset deposition date</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>                             <span class="c1"># dataset title</span>
        <span class="n">imageSets</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;imagesets&#39;</span><span class="p">]</span>                             <span class="c1"># dataset images information</span>
        <span class="n">releaseDate</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;release_date&#39;</span><span class="p">])</span>                <span class="c1"># dataset release date</span>
        <span class="n">datasetSize</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">empiarName</span><span class="p">][</span><span class="s1">&#39;dataset_size&#39;</span><span class="p">])</span>                <span class="c1"># dataset size</span>
        <span class="n">empiarName</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">empiarName</span><span class="p">)</span>
        <span class="n">samplingRate</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">imageSets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_width&#39;</span><span class="p">])</span>                   <span class="c1"># images sampling rate</span>
        <span class="n">dataFormat</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">imageSets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data_format&#39;</span><span class="p">])</span>                    <span class="c1"># images format</span>

        <span class="c1"># You may want to return more elements</span>
        <span class="k">return</span> <span class="n">title</span><span class="p">,</span> <span class="n">samplingRate</span>
</pre></div>
</div>
<p>Now your protocol should be able to run. Try it now and get some information from the empiar entry <strong>10200.</strong>
Check that the summary looks good.</p>
<p>After the execution, the <strong>Summary</strong> panel could show the following information if you managed to store all values:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/summary.png"><img alt="Summary" src="../../../_images/summary.png" style="width: 450px;" /></a>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">All the values that we want to have in the summary (title, samplingRate, …)
have to be Scipion objects (String, Integer, …) that automatically get persisted.</p>
</div>
<p>After that, we’ll add into <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code> method the second step. This step
will download the movies from the entry (<code class="docutils literal notranslate"><span class="pre">entryId</span></code>) ftp until the maximum number
specified (<code class="docutils literal notranslate"><span class="pre">amountOfImages</span></code>) is reached.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;readXmlFileStep&#39;</span><span class="p">)</span>     <span class="c1"># read the dataset xml file from EMPIAR</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;downloadImagesStep&#39;</span><span class="p">)</span>  <span class="c1"># download the movies and register them in parallel</span>

<span class="k">def</span> <span class="nf">downloadImagesStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Call the method provided below.</span>
    <span class="c1"># Make the download happen into the tmp folder of the protocol,</span>
    <span class="c1"># and the final folder has to be the extra folder.</span>
</pre></div>
</div>
<p>The code below should download the files from empiar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">downloadImagesFromEmpiar</span><span class="p">(</span><span class="n">entryId</span><span class="p">,</span> <span class="n">downloadFolder</span><span class="p">,</span> <span class="n">finalFolder</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method connects to EMPIAR&#39;s ftp and downloads a set of images</span>
<span class="sd">    into a specific directory. Once image is downloaded it is moved to the final folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Connection information</span>
    <span class="n">server</span> <span class="o">=</span> <span class="s1">&#39;ftp.ebi.ac.uk&#39;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Directory information</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;/empiar/world_availability/&#39;</span> <span class="o">+</span> <span class="n">entryId</span> <span class="o">+</span> <span class="s1">&#39;/data/Movies&#39;</span>

    <span class="c1"># Establish the connection</span>
    <span class="n">ftp</span> <span class="o">=</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="c1"># Change to the proper directory</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="c1"># Loop through the files and download each one individually into a specific</span>
    <span class="c1"># directory until the stopping criteria is met</span>
    <span class="n">imagesCount</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">ftp</span><span class="o">.</span><span class="n">nlst</span><span class="p">():</span>
        <span class="n">fileAbsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">downloadFolder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileAbsPath</span><span class="p">):</span>
            <span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileAbsPath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">yellowStr</span><span class="p">(</span><span class="s1">&#39;Getting: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="s1">&#39;RETR &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fileAbsPath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalFolder</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">imagesCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">imagesCount</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We are aware that the code above will only work with entries having the files under a “data/Movies” folder.
This works at least for 10200 entry and smarter ftp navigation is needed to work with all EMPIAR entries.</p>
</div>
<p>When the stopping criteria is not met, the file will go into the <code class="docutils literal notranslate"><span class="pre">downloadFolder</span></code> folder.
Once the download is finished the file is moved to the <code class="docutils literal notranslate"><span class="pre">finalFolder</span></code> folder.</p>
<p>Try to run the protocol now and check that the files are being downloaded and end up in the extra folder.
Check as well that the limit is taken into account.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">At this point, there isn’t any code registering the movies in Scipion.</p>
</div>
<p>Let’s add the third step that will be used later to close the set, but for now we will leave it empty.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">closeSetStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Close the registered set. &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Also add it to the <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">readXmlFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;readXmlFileStep&#39;</span><span class="p">)</span>        <span class="c1"># read the dataset xml file from EMPIAR</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">downloadImages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;downloadImagesStep&#39;</span><span class="p">)</span>  <span class="c1"># download the movies and register them in parallel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">closeSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;closeSetStep&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># close the registered set</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">We need to set the <code class="docutils literal notranslate"><span class="pre">wait</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">True</span></code> in order to
wait until all previous steps are finished.</p>
</div>
<p>Up to this point, we have only defined the “static” steps of the protocol, but
we have not yet been registering each of the downloaded movies. Now comes the “dynamic part”.</p>
<p>Let’s add a new step method to register a single movie file in scipion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">registerImageStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Register an image taking into account a file path &quot;&quot;&quot;</span>
    <span class="c1"># 1) create a Movie object with file as the location argument: see pwem.objects.data.Movie()</span>

    <span class="c1"># 2) set the movie sampling rate using the value obtained in the readXmlFromEmpiar step</span>

    <span class="c1"># 3) pass the movie to _addMovieToOutput</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_addMovieToOutput</span><span class="p">(</span><span class="n">newImage</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_addMovieToOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates the output set if it does not exists.</span>
<span class="sd">    Adds a movie to the set. &quot;&quot;&quot;</span>

    <span class="c1"># Does the protocol have the attribute &quot;outputMovies&quot;?</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputMovies&#39;</span><span class="p">):</span>
        <span class="c1"># Append the movie object to the already existing output</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># we do not have output yet. Probably first movie reported</span>

        <span class="c1"># 1) create a SetOfMovies using its create(path) method:</span>
        <span class="c1"># pass the path of the current protocol (hint: self._getPath())</span>

        <span class="c1"># 2) set the sampling rate same way as for individual movies: set.setSamplingRate()</span>
        <span class="c1"># NOTE: Scipion objects are wrappers to the actual python types. To get the python value use .get() method</span>

        <span class="c1"># 3) set the state of the movie set to &quot;open&quot; (set.setStreamState). Constant for the state is Set.STREAM_OPEN.</span>

        <span class="c1"># 4) append the movie to the new set</span>

        <span class="c1"># 5) define the outputs for the protocol (_defineOutputs). Be sure you use outputMovies as the name of the output</span>

    <span class="c1"># In both cases, write the movie set to the disk. set.write() --&gt; set.sqlite</span>

    <span class="c1"># Save the protocol with the new status: protocol._store() --&gt; run.db</span>
</pre></div>
</div>
<p>So far we have added 2 new methods: <code class="docutils literal notranslate"><span class="pre">_addMovieToOutput</span></code> to add a movie object to a set (creating the set if it is missing) and
the <code class="docutils literal notranslate"><span class="pre">registerImageStep</span></code> that is creating a specific Movie object from a file and calling the first method.
But the <code class="docutils literal notranslate"><span class="pre">registerImageStep</span></code> is not being invoked by the protocol yet. Furthermore, somewhere, the missing yet code should be generating
one step per downloaded file.</p>
<div class="section" id="the-stepscheck-method">
<h4>The <code class="docutils literal notranslate"><span class="pre">_stepsCheck</span></code> method<a class="headerlink" href="#the-stepscheck-method" title="Permalink to this headline">¶</a></h4>
<p>All protocols have a method called <code class="docutils literal notranslate"><span class="pre">_stepsCheck</span></code>. The default implementation doesn’t do anything.
Scipion executes the steps in a loop until all the steps are completed. During the execution of the steps
every 3 seconds (default value for <code class="docutils literal notranslate"><span class="pre">Protocol._stepsCheckSecs</span></code>) <code class="docutils literal notranslate"><span class="pre">_stepsCheck</span></code> is invoked and therefore
has the chance to do some checks to see if more steps are needed.</p>
<p>In our case, we have to overwrite the empty <code class="docutils literal notranslate"><span class="pre">_stepsCheck</span></code> method, and insert as
many <code class="docutils literal notranslate"><span class="pre">registerImageStep</span></code> as new files appears in the extra folder.</p>
<p>Let’s get our hands dirty..</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_stepsCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds as many registerImageStep steps as new files appears in the extra folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1) Create a list to keep all new steps to be added (newSteps)</span>

    <span class="c1"># 2) If the size of registeredFiles (protocol level attribute) is &lt; amountOfImages (parameter)</span>

        <span class="c1"># loop through the files in the extra path (HINT: os.listdir())</span>

            <span class="c1"># if the file is not in our registeredFiles list</span>

                <span class="c1"># append it to registeredFiles list</span>

                <span class="c1"># create a new step to register the new file</span>
                <span class="c1"># use _insertFunctionStep with registerImageStep, file, and</span>
                <span class="c1"># self.readXmlFile as a prerequisite parameter</span>
                <span class="c1"># and store the returned value in a variable (newStep)</span>

                <span class="c1"># append the newStep to the newSteps list declared at the beginning</span>

    <span class="c1"># 3) Let&#39;s update the closeSetStep</span>
    <span class="c1"># 3a) get the closeSetStep from the protocol</span>
    <span class="c1"># Hint: any step is accessible with self._steps[stepId-1] --&gt; what we stored in insertAllSteps</span>

    <span class="c1"># 3b) add the newSteps list as prerequisites for the closeSetStep</span>
    <span class="c1"># Hint: use the addPrerequisites method of the closeSetStep.</span>
    <span class="c1"># Be sure you pass the list as *newSteps</span>

    <span class="c1"># 4) If the number of registered files is  &gt;= amountOfImages</span>

        <span class="c1"># Launch the waiting closeSet step by setting the Step.setStatus(STATUS_NEW)</span>

    <span class="c1"># 5) Update the protocol steps using updateSteps()</span>
</pre></div>
</div>
<p>Note that the new generated steps have to be added as a dependency (<code class="docutils literal notranslate"><span class="pre">prerequisites</span></code>
parameter) for the <code class="docutils literal notranslate"><span class="pre">closeSetStep</span></code> step.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">prerequisites</span></code> parameter specifies a list of stepIDs (integers) that
a step needs to wait for before it is launched. Any <code class="docutils literal notranslate"><span class="pre">_insertFunctionStep</span></code> method returns a stepID.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">In order for these steps to be launched in parallel, the <code class="docutils literal notranslate"><span class="pre">prerequisites</span></code>
parameter for each of them must be specified.</p>
</div>
<p>At this point all is in place and output should be created. Run the protocol and verify that everything is fine.</p>
<p>Finally, we can implement the <code class="docutils literal notranslate"><span class="pre">closeSetStep</span></code> which should wait for all the
movies to be registered before it is executed. Here the only thing we will do is close the
set of the movies and save the protocol changes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">closeSetStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Close the registered set. &quot;&quot;&quot;</span>
    <span class="c1"># 1) set the outputMovies streamState to the value SetOfMovies.STREAM_CLOSED using setStreamState method</span>

    <span class="c1"># 2) save the outputMovies using the write() method</span>

    <span class="c1"># 3) save the protocol: Hint: _store()</span>
</pre></div>
</div>
<p>Now if you run the protocol again in debug mode (click Project -&gt; Debug mode in the top left menu) and
click on <strong>Steps</strong> then the <strong>Tree</strong> button, the steps graph should look like this:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/graph_steps.png"><img alt="Graph Steps" src="../../../_images/graph_steps.png" style="width: 650px;" /></a>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../jj_denoise_segmentation_dirPicking_workshop/docs/developer/tutorials/creating-streaming-protocol.html">jj_denoise_segmentation_dirPicking_workshop</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="creating-streaming-protocol.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/docs/developer/tutorials/creating-streaming-protocol.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>