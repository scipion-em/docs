.. _`app:localDeblurSharpening`:

Local Deblur Sharpening protocol
================================

Protocol designed to apply :math:`LocalDeblur`, the automatic local
resolution-based method that increases map signal at medium/high
resolution :cite:p:`ramirez2018`, in *Scipion*. Unlike similar
approaches, :math:`LocalDeblur` does not need any prior atomic model,
avoiding artificial structure factor corrections. Since the map gets
much more interpretability, the modeling process results much easier.
This type of sharpening is recommended for maps showing a broad range of
resolutions, as it is usually common with membrane proteins or
macromolecules highly flexible. In all those cases, applying a global
sharpening method, like :math:`Relion` *postprocess*, does not optimize
the result when you have very different local resolution values because
a global operation cannot improve all parts of the map. However, when
changes in resolution are small there isn’t almost difference between
applying a global or a local sharpening method. For example, in maps
with high symmetry, like viruses, resolution is quite homogenous. The
absence of high differences in resolution determines that at high
resolution the results of global or local sharpening methods are almost
the same.

-  | Requirements to run this protocol and visualize results:

   -  | *Scipion* plugin: **scipion-em**

   -  | *Scipion* plugin: **scipion-em-xmipp**

   -  | *Scipion* plugin: **scipion-em-chimera**

-  | *Scipion* menu:
   | *Model building -> Preprocess map* (:numref:`model_building_app_localdeblur_1` (A))

   .. figure:: Images_appendix/Fig208.svg
      :alt: Protocol **xmipp3-localdeblur sharpening**. A: Protocol location in *Scipion* menu. B: Protocol form.
      :name: model_building_app_localdeblur_1
      :align: center
      :width: 90.0%

      Protocol **xmipp3-localdeblur sharpening**. A: Protocol location in *Scipion* menu. B: Protocol form.

-  | Protocol form parameters (:numref:`model_building_app_localdeblur_1` (B)):

   -  | *Input map*: Unfiltered electron density map previously downloaded or generated in *Scipion*.

   -  | *Resolution Map*: Resolution map generated by protocols like **xmipp3-local MonoRes**. The resolution value in the corresponding voxel of the *Input map* is assigned to each voxel of the *Resolution Map*.

   -  | *lambda*: Since :math:`LocalDeblur` is based on an iterative formula repeated until a convergence criterion is reached, :math:`\lambda` is the step size advanced parameter that modulates the speed of convergence. The default value, :math:`\lambda` = 1, indicates that the method itself establishes automatically the value of :math:`\lambda`. Although the default value is small enough to guarantee the convergence and large enough to speed it up, :math:`\lambda` value can be increased by the user to accelerate the convergence process. Unlike the default value, that grows along the convergence process, :math:`\lambda` value selected by the user will be maintained constant. Falling into a local minimum is a risk derived of increasing the convergence speed.

   -  | *K*: Weight assigned to the difference between the local resolution and the spatial frequency of the center of each bandpass filter. This difference weighted by *K* is the base to compute the local weight of each channel in the filter bank, that correlates the input map with the sharpened map. The bigger the value of *K*, the lower the weight of each channel in the filter bank. Maximum weights are obtained when local resolution and spatial frequency of the center of each bandpass filter show identical values. As it has been empirically observed K=0.025 produces good results for most of tests performed. No big differences have been detected with K values ranging between 0.01 and 0.05. In the particular case of low resolution maps (lower than 6 Å), 0.01 seems to be a good choice.

-  | Protocol execution:

   | Adding specific map/structure label is recommended in *Run name*
     section, at the form top. To add the label, open the protocol form,
     press the pencil symbol at the right side of *Run name* box,
     complete the label in the new opened window, press OK and, finally,
     close the protocol. This label will be shown in the output summary
     content (see below). If you want to run again this protocol, do not
     forget to set to *Restart* the *Run mode*.

   | Press the *Execute* red button at the form bottom.

-  Visualization of protocol results:

   | To visualize the total number of sharpened maps generated according
     to the number of iterations until convergence, press with the right
     mouse the black arrow placed in the lower part of the *Scipion* framework
     (Protocol output: *xmipp3 - localdeblur sharpening -> ouputVolumes*). The option
     *Open with DataViewer* will appear, select it. The sharpened map
     epochs will be detailed. The sharpening algorithm stops when the
     difference between two successive iterations is lower than 1%, thus
     generating a variable number of maps before stopping. You can
     select any of them and visualize the slices with `ShowJ <../../../showJ>`_, the default *Scipion* viewer.
     To visualize the slices press the symbol that appears below *File*
     in the main menu. The *ShowJ* window menu (*File -> Open with
     Chimera*) allows to open the selected map in *ChimeraX*
     graphics window.

   | Nevertheless, *ChimeraX* graphics window can also be opened to compare the input and the last iteration sharpened map. After executing the protocol, press *Analyze Results* and *ChimeraX* graphics window will be opened. Volumes are referred to the origin of coordinates in *ChimeraX*. To show the relative position of the volumes, the three coordinate axes are represented; X axis (red), Y axis (yellow), and Z axis (blue) (:numref:`model_building_app_protocol_volume_3`). Coordinate axes, the imported volume and the last sharpened one (*sharpenedMap_last.mrc*) are model numbers *#1*, *#2* and *#3*, respectively, in *ChimeraX Models* panel. Volume coordinates and pixel size can be checked in *ChimeraX* main menu *Tools -> Volume Data -> Map coordinates: Origin index/ Voxel size*.

-  | Summary content:

   -  | Protocol output (below *Scipion* framework):
      | *xmipp3 - localdeblur sharpening -> ouputVolumes*;
      | SetOfVolumes (number of items, x, y, and z dimensions, sampling
        rate).

   -  | *SUMMARY* box:
      | *LocalDeblur Map*.
