

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spider.protocols.protocol_projmatch &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../spider.html">spider</a> &raquo;</li>
        
      <li>spider.protocols.protocol_projmatch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spider.protocols.protocol_projmatch</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se)</span>
<span class="c1">#                Tapu Shaikh            (shaikh@ceitec.muni.cz)</span>
<span class="c1"># *              Grigory Sharov         (gsharov@mrc-lmb.cam.ac.uk)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtRefine3D</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="k">import</span> <span class="n">ImageHandler</span>
<span class="kn">from</span> <span class="nn">pwem.constants</span> <span class="k">import</span> <span class="n">ALIGN_PROJ</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="k">import</span> <span class="n">Volume</span><span class="p">,</span> <span class="n">FSC</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">Plugin</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">SpiderDocFile</span><span class="p">,</span> <span class="n">SpiderDocAliFile</span><span class="p">,</span>
                     <span class="n">writeScript</span><span class="p">,</span> <span class="n">runScript</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..convert</span> <span class="k">import</span> <span class="n">convertEndian</span><span class="p">,</span> <span class="n">alignmentToRow</span>
<span class="kn">from</span> <span class="nn">..constants</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.protocol_base</span> <span class="k">import</span> <span class="n">SpiderProtocol</span>


<div class="viewcode-block" id="SpiderProtRefinement"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.SpiderProtRefinement">[docs]</a><span class="k">class</span> <span class="nc">SpiderProtRefinement</span><span class="p">(</span><span class="n">ProtRefine3D</span><span class="p">,</span> <span class="n">SpiderProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reference-based refinement using SPIDER AP SHC and AP REF commands.</span>

<span class="sd">    Iterative refinement improves the accuracy in the determination of orientations.</span>
<span class="sd">    This improvement is accomplished by successive use of</span>
<span class="sd">    more finely-sampled reference projections.</span>
<span class="sd">    </span>
<span class="sd">    Two different workflows are suggested: with defocus groups or</span>
<span class="sd">    without (gold-standard refinement).</span>
<span class="sd">    </span>
<span class="sd">    For more information, see:</span>
<span class="sd">    [[http://spider.wadsworth.org/spider_doc/spider/docs/techs/recon/mr.html][SPIDER documentation on projection-matching]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;refine 3D&#39;</span>

    <span class="c1"># --------------------------- DEFINE param functions ----------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;protType&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;with defocus groups&#39;</span><span class="p">,</span> <span class="s1">&#39;gold-standard&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">GOLD_STD</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_HLIST</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Choose refinement type&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;In the first method (with defocus groups), &#39;</span>
                           <span class="s1">&#39;ensembles of particles with similar defocus &#39;</span>
                           <span class="s1">&#39;values are grouped together. A separate 3D &#39;</span>
                           <span class="s1">&#39;reconstruction is computed for each &quot;defocus group.&quot; &#39;</span>
                           <span class="s1">&#39;CTF-correction is performed when these reconstructions &#39;</span>
                           <span class="s1">&#39;are merged into a final reconstruction.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;In the second, gold-standard method, the CTF-correction &#39;</span>
                           <span class="s1">&#39;is applied at the level of windowed particle images. &#39;</span>
                           <span class="s1">&#39;More information on Spider &#39;</span>
                           <span class="s1">&#39;[[https://spider.wadsworth.org/spider_doc/spider/docs/techs/recon1a/Docs/mr1.html][web-site]]&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span> 
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span>
                      <span class="n">pointerCondition</span><span class="o">=</span><span class="s1">&#39;hasCTF&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input particles&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the input particles.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;input3DReference&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial 3D reference volume:&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input 3D reference reconstruction.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfIterations&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of iterations:&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the number of iterations. </span><span class="se">\n\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Multi-reference alignment is computationally intensive, &#39;</span>
                           <span class="s1">&#39;so rather than use the finest-spaced reference projections immediately, &#39;</span>
                           <span class="s1">&#39;we start out with a coarse spacing, and &#39;</span>
                           <span class="s1">&#39;then search a restricted range of orientations &#39;</span>
                           <span class="s1">&#39;a set of gradually more finely-spaced reference projections.&#39;</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;alignmentShift&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Shift range&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Alignments are tested in the range +- this value&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Particle radius (px)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Radius of the structure (px) used in alignment search</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;(Default is for ribosome. EDIT as needed.)</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;This value is used to find radius for last alignment radius.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;winFrac&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Projection diameter&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fraction of window diameter used in projection</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot; (.95= use 95% window size)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;sphDeconAngle&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;protType == 1&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spherical deconvolution angle (deg)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Spherical deconvolution angle in degreees (0 == Do not deconvolve)&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;bpType&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;protType == 1&#39;</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BP CG&#39;</span><span class="p">,</span> <span class="s1">&#39;BP 3F&#39;</span><span class="p">,</span> <span class="s1">&#39;BP RP&#39;</span><span class="p">,</span> <span class="s1">&#39;BP 3N&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">BP_3F</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_HLIST</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Backprojection method&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose backprojection method (BP CG, BP 3F, BP RP or BP 3N). &quot;</span>
                           <span class="s2">&quot;More information on Spider &quot;</span>
                           <span class="s2">&quot;[[https://spider.wadsworth.org/spider_doc/spider/docs/bp_overview.html][web-site]]&quot;</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;smallAngle&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use small angle refinement?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In regular, non-small-angle refinement, &quot;</span>
                           <span class="s2">&quot;a set of reference projections is computed for all experimental images. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;In small-angle refinement, &quot;</span>
                           <span class="s2">&quot;a set of reference projections is computed for each particle on the fly, &quot;</span>
                           <span class="s2">&quot;using the SPIDER command &quot;</span>
                           <span class="s2">&quot;[[http://spider.wadsworth.org/spider_doc/spider/docs/man/voras.html][VO RAS]]. &quot;</span><span class="p">)</span>        
        <span class="c1"># GLO [ang-steps]  = &#39;3.3,3.,2.,2.,2.,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5&#39;  ; Angular degree steps</span>
        <span class="c1"># GLO [ang-limits] = &#39;0.,0.,15.,8.,6.,5.,5.,5.,5.,5.,5.,5.,5.,5.,5.,5.&#39;            ; Angular limits</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angSteps&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;3.3 3 3x2 1.5&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not smallAngle&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular increment&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This parameter determines how finely spaced the reference will be projected. &quot;</span>
                           <span class="s2">&quot;Each value in the list corresponds to the value for a given iteration. &quot;</span>
                           <span class="s2">&quot;A value *V* can be repeated *N* times by using the notation *NxV*. &quot;</span>
                           <span class="s2">&quot;If more iterations are requested than the number of values specified here, &quot;</span>
                           <span class="s2">&quot;the last value will be repeated. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;For example, in the default *3.3 3 3x2 1.5*, &quot;</span>
                           <span class="s2">&quot;the increment will be: iter 1 - 3.3 degrees, iter 2 - 3 degrees, iter 3,4,5 - 2 degrees, &quot;</span>
                           <span class="s2">&quot;and iterations from the sixth onward will use 1.5 degrees.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angLimits&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;2x0 15 8 6 5&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not smallAngle&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular range&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This parameter determines the range of reference projections that will be searched. &quot;</span>
                           <span class="s2">&quot;A value of *0* corresponds to an unrestricted search. &quot;</span>
                           <span class="s2">&quot;A small value will result in a faster alignment, but may not find the correct orientation. &quot;</span>
                           <span class="s2">&quot;A value *V* can be repeated *N* times by using the notation *NxV*. &quot;</span>
                           <span class="s2">&quot;If more iterations are requested than the number of values specified here, &quot;</span>
                           <span class="s2">&quot;the last value will be repeated. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;For example, in the default *2x0 15 8 6 5*, &quot;</span>
                           <span class="s2">&quot;the increment will be: iter 1,2 - unrestricted, iter 3 - 15 degrees, iter 4 - 8 degrees, &quot;</span>
                           <span class="s2">&quot;iter 5 - 6 degrees and iterations from the sixth onward will use 5 degrees.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angStepSm&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;smallAngle&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular increment&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This parameter determines how finely spaced the reference will be projected.&quot;</span><span class="p">)</span>          
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;thetaRange&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;smallAngle&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular range &#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This parameter determines the range of reference projections that will be searched.&quot;</span><span class="p">)</span>          

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># --------------------------- INSERT steps functions ----------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="c1"># Create new stacks and selfiles per groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;runScriptStep&#39;</span><span class="p">,</span> <span class="s1">&#39;refine.pam&#39;</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createOutputStep&#39;</span><span class="p">)</span>
    
    <span class="c1"># --------------------------- STEPS functions -----------------------------</span>
    
<div class="viewcode-block" id="SpiderProtRefinement.convertInputStep"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.SpiderProtRefinement.convertInputStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particlesId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert all needed inputs before running the refinement script. &quot;&quot;&quot;</span>
        <span class="n">partSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">protType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_writeParamsFile</span><span class="p">(</span><span class="n">partSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeGroupFiles</span><span class="p">(</span><span class="n">partSet</span><span class="p">,</span> <span class="n">protType</span><span class="p">)</span>
        
        <span class="c1"># Convert the input volume</span>
        <span class="n">volPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;ref_vol.vol&#39;</span><span class="p">)</span>
        <span class="n">ImageHandler</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input3DReference</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">volPath</span><span class="p">)</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">moveFile</span><span class="p">(</span><span class="n">volPath</span><span class="p">,</span> <span class="n">volPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.vol&#39;</span><span class="p">,</span> <span class="s1">&#39;.stk&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeRefinementScripts</span><span class="p">(</span><span class="n">protType</span><span class="p">)</span></div>
                
    <span class="k">def</span> <span class="nf">_writeRefinementScripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the needed scripts to run refinement</span>
<span class="sd">        and substitute some values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement&#39;</span><span class="p">)</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="n">refPath</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Escape path with &#39;&#39; and add ../ &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">paramsDict</span><span class="o">=</span><span class="p">{},</span> <span class="n">protType</span><span class="o">=</span><span class="n">protType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">protType</span> <span class="o">==</span> <span class="n">DEF_GROUPS</span><span class="p">:</span>
                <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;defocus-groups&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;no-defocus-groups&#39;</span>

            <span class="n">outputScript</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">refPath</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">writeScript</span><span class="p">(</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="s1">&#39;projmatch&#39;</span><span class="p">,</span> <span class="s1">&#39;Refinement&#39;</span><span class="p">,</span> <span class="n">dirName</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="n">outputScript</span><span class="p">,</span> <span class="n">paramsDict</span><span class="p">)</span>
            
        <span class="n">nIter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">getListStr</span><span class="p">(</span><span class="n">valueStr</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">getListFromValues</span><span class="p">(</span><span class="n">valueStr</span><span class="p">,</span> <span class="n">nIter</span><span class="p">))</span>

        <span class="n">diam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;[alignsh]&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentShift</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="c1"># shrange was renamed to alignsh in new versions</span>
                  <span class="s1">&#39;[shrange]&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentShift</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;[iter-end]&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;[diam]&#39;</span><span class="p">:</span> <span class="n">diam</span><span class="p">,</span>
                  <span class="s1">&#39;[win-frac]&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">winFrac</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="c1"># &#39;[converg]&#39;: self.convergence.get(),</span>
                  <span class="s1">&#39;[small-ang]&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallAngle</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;[ang-steps]&#39;</span><span class="p">:</span> <span class="n">getListStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angSteps</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span>
                  <span class="s1">&#39;[ang-limits]&#39;</span><span class="p">:</span> <span class="n">getListStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angLimits</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span>
                  <span class="s1">&#39;[ang-step-sm]&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;(</span><span class="si">%0.2f</span><span class="s2">)&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">angStepSm</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;[theta-range]&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;(</span><span class="si">%0.2f</span><span class="s2">)&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">thetaRange</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  
                  <span class="s1">&#39;[vol_orig]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;ref_vol&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;[sel_group_orig]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;sel_group&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;[sel_particles_orig]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;group{***[grp]}_selfile&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;[group_align_orig]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;group{***[grp]}_align&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;[unaligned_images_orig]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;group{***[grp]}_stack&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;[out_align]&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;stack_alignment&#39;</span><span class="p">)</span>
                  <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span> <span class="o">==</span> <span class="n">GOLD_STD</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sphdecon&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphDeconAngle</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                           <span class="s1">&#39;bp-type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

        <span class="n">script</span><span class="p">(</span><span class="s1">&#39;refine_settings.pam&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protType</span> <span class="o">==</span> <span class="n">DEF_GROUPS</span><span class="p">:</span>
            <span class="n">scriptList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;refine&#39;</span><span class="p">,</span> <span class="s1">&#39;prepare&#39;</span><span class="p">,</span> <span class="s1">&#39;grploop&#39;</span><span class="p">,</span> <span class="s1">&#39;mergegroups&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;enhance&#39;</span><span class="p">,</span> <span class="s1">&#39;endmerge&#39;</span><span class="p">,</span> <span class="s1">&#39;smangloop&#39;</span><span class="p">,</span> <span class="s1">&#39;endrefine&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scriptList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;refine&#39;</span><span class="p">,</span> <span class="s1">&#39;refine-setrefangles&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;refine-prjrefs&#39;</span><span class="p">,</span> <span class="s1">&#39;refine-loop&#39;</span><span class="p">,</span> <span class="s1">&#39;refine-smangloop&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;refine-bp&#39;</span><span class="p">,</span> <span class="s1">&#39;merge-fsc-filt&#39;</span><span class="p">,</span> <span class="s1">&#39;sphdecon&#39;</span><span class="p">,</span> <span class="s1">&#39;enhance&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;show-r2&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scriptList</span><span class="p">:</span>
            <span class="n">script</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pam&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_writeParamsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partSet</span><span class="p">):</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getAcquisition</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="s1">&#39;now&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;pixelSize&#39;</span><span class="p">:</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">(),</span>
                  <span class="s1">&#39;voltage&#39;</span><span class="p">:</span> <span class="n">acq</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">(),</span>
                  <span class="s1">&#39;sphericalAberration&#39;</span><span class="p">:</span> <span class="n">acq</span><span class="o">.</span><span class="n">getSphericalAberration</span><span class="p">(),</span>
                  <span class="s1">&#39;windowSize&#39;</span><span class="p">:</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="s1">&#39;nummps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                  <span class="p">}</span>
        
        <span class="n">paramFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;params.stk&#39;</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="n">paramFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"> ;spi/dat  Generated by Scipion on </span><span class="si">%(datetime)s</span><span class="s2">  params.stk</span>
<span class="s2">    5 1    </span><span class="si">%(pixelSize)f</span><span class="s2">           ; pixel size (A)</span>
<span class="s2">    6 1    </span><span class="si">%(voltage)f</span><span class="s2">             ; electron energy (kV)</span>
<span class="s2">    7 1    </span><span class="si">%(sphericalAberration)f</span><span class="s2"> ; spherical aberration (mm)</span>
<span class="s2">   17 1    </span><span class="si">%(windowSize)f</span><span class="s2">          ; window size (pixels)</span>
<span class="s2">   18 1    </span><span class="si">%(nummps)d</span><span class="s2">              ; number of threads to use</span>
<span class="s2">                        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">paramFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>        
        
    <span class="k">def</span> <span class="nf">_writeGroupFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partSet</span><span class="p">,</span> <span class="n">protType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write files that are needed by each group:</span>
<span class="sd">        - stack</span>
<span class="sd">        - selfile</span>
<span class="sd">        - docfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>
        <span class="c1"># Keep a dict with all groups found in particles</span>
        <span class="n">groupDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;group</span><span class="si">%03d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.stk&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">protType</span> <span class="o">==</span> <span class="n">DEF_GROUPS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">partSet</span><span class="p">:</span>
                <span class="n">defocusGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDefocusGroup</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">defocusGroup</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupDict</span><span class="p">:</span>
                    <span class="n">groupInfo</span> <span class="o">=</span> <span class="n">DefocusGroupInfo</span><span class="p">(</span><span class="n">defocusGroup</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">ih</span><span class="p">)</span>
                    <span class="n">groupDict</span><span class="p">[</span><span class="n">defocusGroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupInfo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groupInfo</span> <span class="o">=</span> <span class="n">groupDict</span><span class="p">[</span><span class="n">defocusGroup</span><span class="p">]</span>

                <span class="n">groupInfo</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numProcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c1"># explicitly set a minimum of 2 groups</span>
            <span class="c1"># GS: maybe not necessary?</span>
            <span class="n">numGroups</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">numProcs</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">numProcs</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partSet</span><span class="p">),</span> <span class="n">numGroups</span><span class="p">)</span>
            <span class="n">numParts</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">d</span>
            <span class="n">groupId</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">partSet</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">groupId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupDict</span><span class="p">:</span>
                    <span class="n">groupInfo</span> <span class="o">=</span> <span class="n">DefocusGroupInfo</span><span class="p">(</span><span class="n">groupId</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">ih</span><span class="p">)</span>
                    <span class="n">groupDict</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupInfo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groupInfo</span> <span class="o">=</span> <span class="n">groupDict</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span>
                    <span class="n">groupSize</span> <span class="o">=</span> <span class="n">groupDict</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span><span class="o">.</span><span class="n">counter</span>
                    <span class="k">if</span> <span class="n">groupSize</span> <span class="o">&gt;</span> <span class="n">numParts</span><span class="p">:</span>
                        <span class="n">groupId</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">groupInfo</span> <span class="o">=</span> <span class="n">DefocusGroupInfo</span><span class="p">(</span><span class="n">groupId</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">ih</span><span class="p">)</span>
                        <span class="n">groupDict</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupInfo</span>

                <span class="n">groupInfo</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="c1"># Write the docfile with the group information</span>
        <span class="c1"># like the number of particles (and the defocus)</span>
        <span class="n">groupsDoc</span> <span class="o">=</span> <span class="n">SpiderDocFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;sel_group.stk&#39;</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">groupDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">protType</span> <span class="o">==</span> <span class="n">DEF_GROUPS</span><span class="p">:</span>
                <span class="n">groupsDoc</span><span class="o">.</span><span class="n">writeValues</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">gi</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">gi</span><span class="o">.</span><span class="n">defocus</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">groupsDoc</span><span class="o">.</span><span class="n">writeValues</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">gi</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
            <span class="c1"># Convert the endianness of the stack</span>
            <span class="n">convertEndian</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">stackfile</span><span class="p">,</span> <span class="n">gi</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
            <span class="c1"># Close each group docfile</span>
            <span class="n">gi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">groupsDoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<div class="viewcode-block" id="SpiderProtRefinement.runScriptStep"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.SpiderProtRefinement.runScriptStep">[docs]</a>    <span class="k">def</span> <span class="nf">runScriptStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Just run the script that was generated in convertInputStep. &quot;&quot;&quot;</span>
        <span class="n">refPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement&#39;</span><span class="p">)</span>
        <span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s1">&#39;pam/stk&#39;</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(),</span>
                  <span class="n">nummpis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">refPath</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpiderProtRefinement.createOutputStep"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.SpiderProtRefinement.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">Volume</span><span class="p">()</span>
        <span class="n">lastIter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLastIterNumber</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span> <span class="o">==</span> <span class="n">GOLD_STD</span><span class="p">:</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/vol_</span><span class="si">%02d</span><span class="s1">.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">))</span>
            <span class="n">half1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/vol_</span><span class="si">%02d</span><span class="s1">_s1.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">)</span>
            <span class="n">half2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/vol_</span><span class="si">%02d</span><span class="s1">_s2.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/bpr</span><span class="si">%02d</span><span class="s1">.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">))</span>
            <span class="n">half1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/bpr</span><span class="si">%02d</span><span class="s1">_sub1.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">)</span>
            <span class="n">half2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/bpr</span><span class="si">%02d</span><span class="s1">_sub2.stk&#39;</span> <span class="o">%</span> <span class="n">lastIter</span><span class="p">)</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">imgSet</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">setHalfMaps</span><span class="p">([</span><span class="n">half1</span><span class="p">,</span> <span class="n">half2</span><span class="p">])</span>

        <span class="n">outImgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfParticles</span><span class="p">()</span>
        <span class="n">outImgSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fillDataFromDoc</span><span class="p">(</span><span class="n">outImgSet</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputVolume</span><span class="o">=</span><span class="n">vol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputParticles</span><span class="o">=</span><span class="n">outImgSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="p">,</span> <span class="n">outImgSet</span><span class="p">)</span>

        <span class="n">fsc</span> <span class="o">=</span> <span class="n">FSC</span><span class="p">(</span><span class="n">objLabel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getRunName</span><span class="p">())</span>
        <span class="n">resolution</span><span class="p">,</span> <span class="n">fscData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFscData</span><span class="p">(</span><span class="n">it</span><span class="o">=</span><span class="n">lastIter</span><span class="p">)</span>
        <span class="n">fsc</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">fscData</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputFSC</span><span class="o">=</span><span class="n">fsc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">fsc</span><span class="p">)</span></div>
    
    <span class="c1"># --------------------------- INFO functions ------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallAngle</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hasAlignmentProj</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*Small angle* option can only be used if &#39;</span>
                          <span class="s1">&#39;the particles have angular assignment.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>
        
    <span class="k">def</span> <span class="nf">_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallAngle</span><span class="p">:</span>
            <span class="n">niter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">niter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">getListFromValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angSteps</span><span class="o">.</span><span class="n">get</span><span class="p">())):</span>
                <span class="n">warns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*Angular steps* have more values than iterations&#39;</span><span class="p">)</span>           
    
        <span class="k">return</span> <span class="n">warns</span>
    
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Number of iterations: *</span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallAngle</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Small-angle refinement: &#39;</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    Angular increment: *</span><span class="si">%s</span><span class="s1">* degrees&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">angStepSm</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    Angular range: *</span><span class="si">%s</span><span class="s1">* degrees&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">thetaRange</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Angular increments: *</span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">angSteps</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Angular range: *</span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">angLimits</span><span class="p">)</span>

        <span class="n">diam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Particle diameter: *</span><span class="si">%d</span><span class="s1">* Angstroms&#39;</span> <span class="o">%</span> <span class="n">diam</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Shift range: *</span><span class="si">%s</span><span class="s1">* pixels&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentShift</span><span class="p">)</span>
        <span class="c1"># summary.append(&#39;Projection diameter: *%s* of window size&#39; % self.winFrac)</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Penczek1992&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Input particles </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;were subjected to 3D refinement by projection matching ([Penczek1992]) &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;for </span><span class="si">%s</span><span class="s2"> iterations &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;using </span><span class="si">%s</span><span class="s2"> as an initial reference. &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;input3DReference&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span> <span class="o">==</span> <span class="n">GOLD_STD</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using gold-standard refinement procedure.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using defocus group-based procedure.&quot;</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
        
    <span class="c1"># --------------------------- UTILS functions -----------------------------</span>
    <span class="k">def</span> <span class="nf">_getDefocusGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">getMicId</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getLastIterNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of iteration files, give the iterTemplate. &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span> <span class="o">==</span> <span class="n">DEF_GROUPS</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/bpr??.stk&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Refinement/final/vol_??.stk&#39;</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">template</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(\d</span><span class="si">{2}</span><span class="s1">).stk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_fillDataFromDoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgSet</span><span class="p">):</span>
        <span class="n">outDocFn</span> <span class="o">=</span> <span class="n">SpiderDocAliFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;stack_alignment.stk&#39;</span><span class="p">))</span>
        <span class="n">imgSet</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>
        <span class="n">initPartSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">partIter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">initPartSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">))</span>
        <span class="n">imgSet</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">partIter</span><span class="p">,</span>
                         <span class="n">updateItemCallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">,</span>
                         <span class="n">itemDataIterator</span><span class="o">=</span><span class="nb">iter</span><span class="p">(</span><span class="n">outDocFn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_createItemMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..convert</span> <span class="k">import</span> <span class="n">createItemMatrix</span>
        <span class="kn">from</span> <span class="nn">pwem.constants</span> <span class="k">import</span> <span class="n">ALIGN_PROJ</span>
        <span class="n">createItemMatrix</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">ALIGN_PROJ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getFscData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protType</span> <span class="o">==</span> <span class="n">GOLD_STD</span><span class="p">:</span>  <span class="c1"># gold std</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Refinement/final/fscdoc_m_</span><span class="si">%02d</span><span class="s2">.stk&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># def groups</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Refinement/final/ofscdoc_</span><span class="si">%02d</span><span class="s2">.stk&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>

        <span class="n">resolution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fscData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fscDoc</span> <span class="o">=</span> <span class="n">SpiderDocFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">fscDoc</span><span class="p">:</span>
            <span class="n">resolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fscData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">fscData</span></div>


<div class="viewcode-block" id="DefocusGroupInfo"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.DefocusGroupInfo">[docs]</a><span class="k">class</span> <span class="nc">DefocusGroupInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Helper class to store some information about </span>
<span class="sd">    defocus groups like the number of particles</span>
<span class="sd">    or the docfile to be generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defocusGroup</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">ih</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ih</span> <span class="o">=</span> <span class="n">ih</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">defocusGroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selfile</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">defocusGroup</span><span class="p">,</span> <span class="s1">&#39;selfile&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docfile</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">defocusGroup</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackfile</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">defocusGroup</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of particles in this group</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span> <span class="o">=</span> <span class="n">SpiderDocFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">SpiderDocFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">writeComment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docfile</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;PSI&#39;</span><span class="p">,</span> <span class="s1">&#39;THE&#39;</span><span class="p">,</span> <span class="s1">&#39;PHI&#39;</span><span class="p">,</span> <span class="s1">&#39;REF#&#39;</span><span class="p">,</span> <span class="s1">&#39;EXP#&#39;</span><span class="p">,</span> <span class="s1">&#39;CUM.{ROT&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;SX&#39;</span><span class="p">,</span> <span class="s1">&#39;SY}&#39;</span><span class="p">,</span> <span class="s1">&#39;NPROJ&#39;</span><span class="p">,</span> <span class="s1">&#39;DIFF&#39;</span><span class="p">,</span> <span class="s1">&#39;CCROT&#39;</span><span class="p">,</span> <span class="s1">&#39;ROT&#39;</span><span class="p">,</span> <span class="s1">&#39;SX&#39;</span><span class="p">,</span> <span class="s1">&#39;SY&#39;</span><span class="p">,</span> <span class="s1">&#39;MIR-CC&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">writeHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

<div class="viewcode-block" id="DefocusGroupInfo.addParticle"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.DefocusGroupInfo.addParticle">[docs]</a>    <span class="k">def</span> <span class="nf">addParticle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ctf</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getCTF</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defocus</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusU</span><span class="p">()</span> <span class="o">+</span> <span class="n">ctf</span><span class="o">.</span><span class="n">getDefocusV</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ih</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackfile</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">writeValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
        <span class="n">alignRow</span> <span class="o">=</span> <span class="p">{</span><span class="n">ANGLE_PSI</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="n">ANGLE_THE</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="n">ANGLE_PHI</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="n">SHIFTX</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="n">SHIFTY</span><span class="p">:</span> <span class="mf">0.</span><span class="p">}</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getTransform</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alignmentToRow</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="n">alignRow</span><span class="p">,</span> <span class="n">ALIGN_PROJ</span><span class="p">)</span>
            
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">alignRow</span><span class="p">[</span><span class="n">ANGLE_THE</span><span class="p">],</span> <span class="n">alignRow</span><span class="p">[</span><span class="n">ANGLE_PHI</span><span class="p">],</span> 
                  <span class="mf">0.00</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> 
                  <span class="n">alignRow</span><span class="p">[</span><span class="n">ANGLE_PSI</span><span class="p">],</span> <span class="n">alignRow</span><span class="p">[</span><span class="n">SHIFTX</span><span class="p">],</span> <span class="n">alignRow</span><span class="p">[</span><span class="n">SHIFTY</span><span class="p">],</span> 
                  <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">writeValues</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="DefocusGroupInfo.close"><a class="viewcode-back" href="../../../api/spider/spider.protocols.protocol_projmatch.html#spider.protocols.protocol_projmatch.DefocusGroupInfo.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: vtune
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dependabot_pip_jinja2-2.10.1/index.html">dependabot/pip/jinja2-2.10.1</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
            <dd><a href="protocol_projmatch.html">vtune</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>