

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xmipp3.protocols.protocol_projmatch.protocol_projmatch &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/appion/appion.html">appion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/atomstructutils/atomstructutils.html">atomstructutils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/atsas/atsas.html">atsas package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/bamfordlab/bamfordlab.html">bamfordlab package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/bsoft/bsoft.html">bsoft package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/ccp4/ccp4.html">ccp4 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/chimera/chimera.html">chimera package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/cistem/cistem.html">cistem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/cryoef/cryoef.html">cryoef package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/cryosparc2/cryosparc2.html">cryosparc2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/dynamo/dynamo.html">dynamo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/eman2/eman2.html">eman2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/emxlib/emxlib.html">emxlib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/fsc3d/fsc3d.html">fsc3d package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gautomatch/gautomatch.html">gautomatch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gctf/gctf.html">gctf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/imod/imod.html">imod package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/localrec/localrec.html">localrec package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/locscale/locscale.html">locscale package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/motioncorr/motioncorr.html">motioncorr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/novactf/novactf.html">novactf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/phenix/phenix.html">phenix package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/pyworkflow/pyworkflow.html">pyworkflow package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/pwem/pwem.html">pwem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/relion/relion.html">relion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/resmap/resmap.html">resmap package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/scipion/scipion.html">scipion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/sphire/sphire.html">sphire package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/spider/spider.html">spider package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/tomo/tomo.html">tomo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/topaz/topaz.html">topaz package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/xmipp3/xmipp3.html">xmipp3 package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../xmipp3.html">xmipp3</a> &raquo;</li>
        
      <li>xmipp3.protocols.protocol_projmatch.protocol_projmatch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xmipp3.protocols.protocol_projmatch.protocol_projmatch</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Roberto Marabini (roberto@cnb.csic.es)</span>
<span class="c1"># *              J.M. De la Rosa Trevin (jmdelarosa@cnb.csic.es)</span>
<span class="c1"># *              Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="k">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">getFloatListFromValues</span><span class="p">,</span> <span class="n">getBoolListFromValues</span><span class="p">,</span>
                              <span class="n">getStringListFromValues</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtRefine3D</span><span class="p">,</span> <span class="n">ProtClassify3D</span>
<span class="kn">from</span> <span class="nn">pwem</span> <span class="k">import</span> <span class="n">emlib</span>
<span class="kn">from</span> <span class="nn">.projmatch_initialize</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.projmatch_form</span> <span class="k">import</span> <span class="n">_defineProjectionMatchingParams</span>
<span class="kn">from</span> <span class="nn">.projmatch_steps</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">xmipp3.base</span> <span class="k">import</span> <span class="n">isXmippCudaPresent</span>


<div class="viewcode-block" id="XmippProtProjMatch"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch">[docs]</a><span class="k">class</span> <span class="nc">XmippProtProjMatch</span><span class="p">(</span><span class="n">ProtRefine3D</span><span class="p">,</span> <span class="n">ProtClassify3D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 3D reconstruction and classification using multireference projection matching&quot;&quot;&quot;</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;projection matching&#39;</span>
    
    <span class="n">FILENAMENUMBERLENGTH</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>        
        <span class="n">ProtRefine3D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">ProtClassify3D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCtfGroups</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastIter</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function is mean to be called after the </span>
<span class="sd">        working dir for the protocol have been set. (maybe after recovery from mapper)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputInfo</span><span class="p">()</span>
        <span class="c1"># Setup the dictionary with filenames templates to </span>
        <span class="c1"># be used by _getFileName</span>
        <span class="n">createFilenameTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Load the values from several params generating a list</span>
        <span class="c1"># of values per iteration or references</span>
        <span class="n">initializeLists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadInputInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">...convert</span> <span class="k">import</span> <span class="n">getImageLocation</span>
        
        <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input3DReferences</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="c1"># Input can be either a single volume or a set of volumes.</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">Volume</span><span class="p">):</span> <span class="c1"># Treat the case of a single volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenceFileNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">getImageLocation</span><span class="p">(</span><span class="n">reference</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenceFileNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">getImageLocation</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span> <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">reference</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfReferences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">referenceFileNames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolSam</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>

        
    <span class="c1">#--------------------------- DEFINE param functions --------------------------------------------   </span>
        
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Since the form definition is very very large,</span>
<span class="sd">        we have do it in a separated function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_defineProjectionMatchingParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
         
         
    <span class="c1">#--------------------------- INSERT steps functions --------------------------------------------  </span>
    
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">()</span>
        <span class="c1"># Insert initial steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;executeCtfGroupsStep&#39;</span><span class="p">)</span>
<span class="c1">#         insertExecuteCtfGroupsStep(self)</span>
<span class="c1">#         insertInitAngularReferenceFileStep(self)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;initAngularReferenceFileStep&#39;</span><span class="p">)</span>
        <span class="c1"># Steps per iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertItersSteps</span><span class="p">()</span>
        <span class="c1"># Final steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createOutputStep&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_insertItersSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert several steps needed per iteration. &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">iterN</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allIters</span><span class="p">():</span>
            <span class="n">dirsStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createIterDirsStep&#39;</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span>
            <span class="c1"># Insert some steps per reference volume</span>
            <span class="n">projMatchSteps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">refN</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allRefs</span><span class="p">():</span>
                <span class="c1"># Mask the references in the iteration</span>
                <span class="n">insertMaskReferenceStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">prerequisites</span><span class="o">=</span><span class="p">[</span><span class="n">dirsStep</span><span class="p">])</span>
                <span class="c1"># Create the library of projections</span>
                <span class="n">insertAngularProjectLibraryStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>
                <span class="c1"># Projection matching steps</span>
                <span class="n">projMatchStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertProjectionMatchingStep</span><span class="p">(</span><span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>
                <span class="n">projMatchSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projMatchStep</span><span class="p">)</span>
                
            <span class="c1"># Select the reference that best fits each image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;assignImagesToReferencesStep&#39;</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">prerequisites</span><span class="o">=</span><span class="n">projMatchSteps</span><span class="p">)</span>
            
            <span class="n">insertAngularClassAverageStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>
    
            <span class="c1"># Reconstruct each reference with new averages</span>
            <span class="k">for</span> <span class="n">refN</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allRefs</span><span class="p">():</span>
                <span class="c1"># Create new class averages with images assigned</span>
                <span class="n">insertReconstructionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doComputeResolution</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doSplitReferenceImages</span><span class="p">[</span><span class="n">iterN</span><span class="p">]:</span>
                    <span class="c1"># Reconstruct two halves of the data</span>
                    <span class="n">insertReconstructionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="s1">&#39;Split1&#39;</span><span class="p">)</span>
                    <span class="n">insertReconstructionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="s1">&#39;Split2&#39;</span><span class="p">)</span>
                    <span class="c1"># Compute the resolution</span>
                    <span class="n">insertComputeResolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>
                    
                <span class="n">insertFilterVolumeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">)</span>

            <span class="c1"># Calculate both angles and shifts devitations for this iteration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;calculateDeviationsStep&#39;</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">_insertProjectionMatchingStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">getProjectionMatchingArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;projectionMatchingStep&#39;</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    
    <span class="c1">#--------------------------- STEPS functions --------------------------------------------       </span>

<div class="viewcode-block" id="XmippProtProjMatch.convertInputStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.convertInputStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generated the input particles metadata expected </span>
<span class="sd">        by projection matching. And copy the generated file to be</span>
<span class="sd">        used as initial docfile for further iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">...convert</span> <span class="k">import</span> <span class="n">writeSetOfParticles</span>
        <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">selFileName</span><span class="p">,</span> 
                            <span class="n">blockName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blockWithAllExpImages</span><span class="p">)</span></div>
        <span class="c1">#copyFile(self.selFileName, self._getFileName(&#39;inputParticlesDoc&#39;))</span>
        
<div class="viewcode-block" id="XmippProtProjMatch.createIterDirsStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.createIterDirsStep">[docs]</a>    <span class="k">def</span> <span class="nf">createIterDirsStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the necessary directory for a given iteration. &quot;&quot;&quot;</span>
        <span class="n">iterDirs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;iterDir&#39;</span><span class="p">,</span> <span class="s1">&#39;projMatchDirs&#39;</span><span class="p">,</span> <span class="s1">&#39;libraryDirs&#39;</span><span class="p">]]</span>
    
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iterDirs</span><span class="p">:</span>
            <span class="n">makePath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">iterDirs</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.volumeConvertStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.volumeConvertStep">[docs]</a>    <span class="k">def</span> <span class="nf">volumeConvertStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconstructedFilteredVolume</span><span class="p">,</span> <span class="n">maskedFileName</span><span class="p">):</span>
        <span class="n">runVolumeConvertStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconstructedFilteredVolume</span><span class="p">,</span> <span class="n">maskedFileName</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.executeCtfGroupsStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.executeCtfGroupsStep">[docs]</a>    <span class="k">def</span> <span class="nf">executeCtfGroupsStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runExecuteCtfGroupsStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.transformMaskStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.transformMaskStep">[docs]</a>    <span class="k">def</span> <span class="nf">transformMaskStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runTransformMaskStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.angularProjectLibraryStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.angularProjectLibraryStep">[docs]</a>    <span class="k">def</span> <span class="nf">angularProjectLibraryStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stepParams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runAngularProjectLibraryStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stepParams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="XmippProtProjMatch.initAngularReferenceFileStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.initAngularReferenceFileStep">[docs]</a>    <span class="k">def</span> <span class="nf">initAngularReferenceFileStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">runInitAngularReferenceFileStep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="XmippProtProjMatch.projectionMatchingStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.projectionMatchingStep">[docs]</a>    <span class="k">def</span> <span class="nf">projectionMatchingStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">runProjectionMatching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.assignImagesToReferencesStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.assignImagesToReferencesStep">[docs]</a>    <span class="k">def</span> <span class="nf">assignImagesToReferencesStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="n">runAssignImagesToReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="XmippProtProjMatch.cleanVolumeStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.cleanVolumeStep">[docs]</a>    <span class="k">def</span> <span class="nf">cleanVolumeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol1</span><span class="p">,</span> <span class="n">vol2</span><span class="p">):</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">vol1</span><span class="p">,</span> <span class="n">vol2</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.reconstructionStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.reconstructionStep">[docs]</a>    <span class="k">def</span> <span class="nf">reconstructionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runReconstructionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.storeResolutionStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.storeResolutionStep">[docs]</a>    <span class="k">def</span> <span class="nf">storeResolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolIterMd</span><span class="p">,</span> <span class="n">resolIterMaxMd</span><span class="p">,</span> <span class="n">sampling</span><span class="p">):</span>
        <span class="n">runStoreResolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolIterMd</span><span class="p">,</span> <span class="n">resolIterMaxMd</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.calculateFscStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.calculateFscStep">[docs]</a>    <span class="k">def</span> <span class="nf">calculateFscStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">constantToAdd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runCalculateFscStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">constantToAdd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.filterVolumeStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.filterVolumeStep">[docs]</a>    <span class="k">def</span> <span class="nf">filterVolumeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">constantToAddToFiltration</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">runFilterVolumeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">,</span> <span class="n">constantToAddToFiltration</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.createOutputStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">runCreateOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1">#--------------------------- INFO functions -------------------------------------------- </span>
    
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCTFCorrection</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doAutoCTFGroup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setOfDefocus</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Error: for non-automated ctf grouping, &quot;</span>
                              <span class="s2">&quot;please provide a docfile!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hasCTF</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Error: for doing CTF correction the input &quot;</span>
                              <span class="s2">&quot;particles should have CTF information.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The number of MPI processes has to be larger than 1&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_validateDim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">input3DReferences</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                          <span class="n">errors</span><span class="p">,</span> <span class="s1">&#39;Input particles&#39;</span><span class="p">,</span> <span class="s1">&#39;Reference volume&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isXmippCudaPresent</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;You have asked to use GPU, but I cannot find Xmipp GPU programs in the path&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
    
    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">cites</span>
    
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">()</span>  <span class="c1"># summary is quite explicit and serve as methods</span>
    
    <span class="c1">#--------------------------- UTILS functions --------------------------------------------</span>
    
<div class="viewcode-block" id="XmippProtProjMatch.allIters"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.allIters">[docs]</a>    <span class="k">def</span> <span class="nf">allIters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all iterations. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span></div>
            
<div class="viewcode-block" id="XmippProtProjMatch.allRefs"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.allRefs">[docs]</a>    <span class="k">def</span> <span class="nf">allRefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all references. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfReferences</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span></div>
            
<div class="viewcode-block" id="XmippProtProjMatch.allCtfGroups"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.allCtfGroups">[docs]</a>    <span class="k">def</span> <span class="nf">allCtfGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all CTF groups. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfCtfGroups</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span></div>
            
<div class="viewcode-block" id="XmippProtProjMatch.itersFloatValues"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.itersFloatValues">[docs]</a>    <span class="k">def</span> <span class="nf">itersFloatValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributeName</span><span class="p">,</span> <span class="n">firstValue</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Take the string of a given attribute and</span>
<span class="sd">        create a list of floats that will be used by </span>
<span class="sd">        the iteratioins. An special first value will be</span>
<span class="sd">        added to the list for iteration 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valuesStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">attributeName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valuesStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;None value for attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attributeName</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">firstValue</span><span class="p">]</span> <span class="o">+</span> <span class="n">getFloatListFromValues</span><span class="p">(</span><span class="n">valuesStr</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>
    
<div class="viewcode-block" id="XmippProtProjMatch.itersBoolValues"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.itersBoolValues">[docs]</a>    <span class="k">def</span> <span class="nf">itersBoolValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributeName</span><span class="p">,</span> <span class="n">firstValue</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Take the string of a given attribute and</span>
<span class="sd">        create a list of booleans that will be used by </span>
<span class="sd">        the iteratioins. An special first value will be</span>
<span class="sd">        added to the list for iteration 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valuesStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">attributeName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valuesStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;None value for attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attributeName</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">firstValue</span><span class="p">]</span> <span class="o">+</span> <span class="n">getBoolListFromValues</span><span class="p">(</span><span class="n">valuesStr</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>
        
<div class="viewcode-block" id="XmippProtProjMatch.itersStringValues"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.itersStringValues">[docs]</a>    <span class="k">def</span> <span class="nf">itersStringValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributeName</span><span class="p">,</span> <span class="n">firstValue</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Take the string of a given attribute and</span>
<span class="sd">        create a list of strings that will be used by </span>
<span class="sd">        the iteratioins. An special first value will be</span>
<span class="sd">        added to the list for iteration 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valuesStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">attributeName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valuesStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;None value for attribute: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attributeName</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">firstValue</span><span class="p">]</span> <span class="o">+</span> <span class="n">getStringListFromValues</span><span class="p">(</span><span class="n">valuesStr</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>
        
    <span class="k">def</span> <span class="nf">_getBlockFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blockName</span><span class="p">,</span> <span class="n">blockNumber</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">length</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILENAMENUMBERLENGTH</span>
        
        <span class="k">return</span> <span class="n">blockName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">blockNumber</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">filename</span>
    
    <span class="k">def</span> <span class="nf">_getExpImagesFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockWithAllExpImages</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">filename</span>
    
    <span class="k">def</span> <span class="nf">_getRefBlockFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctfBlName</span><span class="p">,</span> <span class="n">ctfBlNumber</span><span class="p">,</span> <span class="n">refBlName</span><span class="p">,</span> <span class="n">refBlNumber</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">length</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILENAMENUMBERLENGTH</span>
        
        <span class="k">return</span> <span class="n">ctfBlName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctfBlNumber</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">refBlName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">refBlNumber</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_getFourierMaxFrequencyOfInterest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">,</span> <span class="n">refN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read the corresponding resolution metadata and return the</span>
<span class="sd">        desired resolution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;resolutionXmdMax&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">refN</span><span class="p">))</span>
        <span class="n">resol</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">firstObject</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">resol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resol</span>
        <span class="n">sampling</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">firstObject</span><span class="p">())</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">sampling</span>
    
<div class="viewcode-block" id="XmippProtProjMatch.calculateDeviationsStep"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.calculateDeviationsStep">[docs]</a>    <span class="k">def</span> <span class="nf">calculateDeviationsStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate both angles and shifts devitations for all iterations</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">SL</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">SymList</span><span class="p">()</span>
        <span class="n">mdIter</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
        <span class="c1">#for it in self.allIters():</span>
        <span class="n">mdIter</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">SL</span><span class="o">.</span><span class="n">readSymmetryFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symmetry</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
        <span class="n">md1</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docFileInputAngles</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
        <span class="n">md2</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docFileInputAngles</span><span class="p">[</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#ignore disabled,</span>
        <span class="n">md1</span><span class="o">.</span><span class="n">removeDisabled</span><span class="p">()</span>
        <span class="n">md2</span><span class="o">.</span><span class="n">removeDisabled</span><span class="p">()</span>

        <span class="c1">#first metadata file may not have shiftx and shifty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">md2</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">):</span>
            <span class="n">md2</span><span class="o">.</span><span class="n">addLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">)</span>
            <span class="n">md2</span><span class="o">.</span><span class="n">addLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">)</span>
            <span class="n">md2</span><span class="o">.</span><span class="n">fillConstant</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">md2</span><span class="o">.</span><span class="n">fillConstant</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">oldLabels</span><span class="o">=</span><span class="p">[</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_ROT</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TILT</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_PSI</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">]</span>
        <span class="n">newLabels</span><span class="o">=</span><span class="p">[</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_ROT2</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TILT2</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_PSI2</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X2</span><span class="p">,</span>
                   <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y2</span><span class="p">]</span>
        <span class="n">md2</span><span class="o">.</span><span class="n">renameColumn</span><span class="p">(</span><span class="n">oldLabels</span><span class="p">,</span><span class="n">newLabels</span><span class="p">)</span>
        <span class="n">md2</span><span class="o">.</span><span class="n">addLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X_DIFF</span><span class="p">)</span>
        <span class="n">md2</span><span class="o">.</span><span class="n">addLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y_DIFF</span><span class="p">)</span>
        <span class="n">md2</span><span class="o">.</span><span class="n">addLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF</span><span class="p">)</span>
        <span class="n">mdIter</span><span class="o">.</span><span class="n">join1</span><span class="p">(</span><span class="n">md1</span><span class="p">,</span> <span class="n">md2</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">INNER_JOIN</span><span class="p">)</span>
        <span class="n">SL</span><span class="o">.</span><span class="n">computeDistance</span><span class="p">(</span><span class="n">mdIter</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">emlib</span><span class="o">.</span><span class="n">activateMathExtensions</span><span class="p">()</span>
        <span class="c1">#operate in sqlite</span>
        <span class="n">shiftXLabel</span>     <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">)</span>
        <span class="n">shiftX2Label</span>    <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X2</span><span class="p">)</span>
        <span class="n">shiftXDiff</span>      <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X_DIFF</span><span class="p">)</span>
        <span class="n">shiftYLabel</span>     <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">)</span>
        <span class="n">shiftY2Label</span>    <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y2</span><span class="p">)</span>
        <span class="n">shiftYDiff</span>      <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y_DIFF</span><span class="p">)</span>
        <span class="n">shiftDiff</span>       <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">label2Str</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF</span><span class="p">)</span>
        <span class="c1">#timeStr = str(dtBegin)</span>
        <span class="n">operateString</span>   <span class="o">=</span>       <span class="n">shiftXDiff</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="n">shiftXLabel</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">shiftX2Label</span>
        <span class="n">operateString</span>  <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">shiftYDiff</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="n">shiftYLabel</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">shiftY2Label</span>
        <span class="n">mdIter</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">operateString</span><span class="p">)</span>
        <span class="n">operateString</span>  <span class="o">=</span>  <span class="n">shiftDiff</span><span class="o">+</span><span class="s2">&quot;=sqrt(&quot;</span> \
                          <span class="o">+</span><span class="n">shiftXDiff</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="o">+</span><span class="n">shiftXDiff</span><span class="o">+</span><span class="s2">&quot;+&quot;</span> \
                          <span class="o">+</span><span class="n">shiftYDiff</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="o">+</span><span class="n">shiftYDiff</span><span class="o">+</span><span class="s2">&quot;);&quot;</span>
        <span class="n">mdIter</span><span class="o">.</span><span class="n">operate</span><span class="p">(</span><span class="n">operateString</span><span class="p">)</span>
        <span class="n">iterFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdDevitationsFn</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="n">mdIter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iterFile</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setLastIter</span><span class="p">(</span><span class="n">it</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_mdDevitationsFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="n">mdFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;deviations.xmd&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;iter_</span><span class="si">%03d</span><span class="s2">@&quot;</span> <span class="o">%</span> <span class="n">it</span> <span class="o">+</span> <span class="n">mdFn</span>

    <span class="k">def</span> <span class="nf">_setLastIter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastIter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">iterN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastIter</span><span class="p">)</span>

<div class="viewcode-block" id="XmippProtProjMatch.getLastIter"><a class="viewcode-back" href="../../../../api/xmipp3/xmipp3.protocols.protocol_projmatch.protocol_projmatch.html#xmipp3.protocols.protocol_projmatch.protocol_projmatch.XmippProtProjMatch.getLastIter">[docs]</a>    <span class="k">def</span> <span class="nf">getLastIter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lastIter</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>
    
    <span class="k">def</span> <span class="nf">_fillParticlesFromIter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partSet</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_fillParticlesFromIter&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">as</span> <span class="nn">md</span>
        
        <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">imgFn</span> <span class="o">=</span> <span class="s2">&quot;all_exp_images@&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;docfileInputAnglesIters&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">partSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
        <span class="n">partSet</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>
        
        <span class="n">partSet</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span>
                            <span class="n">updateItemCallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">,</span>
                            <span class="n">itemDataIterator</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">iterRows</span><span class="p">(</span><span class="n">imgFn</span><span class="p">,</span> <span class="n">sortByLabel</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ITEM_ID</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_createItemMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">...convert</span> <span class="k">import</span> <span class="n">createItemMatrix</span>
        <span class="kn">from</span> <span class="nn">pwem.constants</span> <span class="k">import</span> <span class="n">ALIGN_PROJ</span>
        
        <span class="n">createItemMatrix</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">ALIGN_PROJ</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_getIterParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pwem.objects</span> <span class="k">as</span> <span class="nn">em</span>
        <span class="sd">&quot;&quot;&quot; Return a classes .sqlite file for this iteration.</span>
<span class="sd">        If the file doesn&#39;t exists, it will be created by </span>
<span class="sd">        converting from this iteration data.star file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">dataParticles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;particlesScipion&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">it</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">dataParticles</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">dataParticles</span><span class="p">):</span>
            <span class="n">partSet</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">SetOfParticles</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">dataParticles</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fillParticlesFromIter</span><span class="p">(</span><span class="n">partSet</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
            <span class="n">partSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">partSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">partSet</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">SetOfParticles</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">dataParticles</span><span class="p">)</span>
            <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">partSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
            <span class="n">partSet</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">partSet</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: dependabot/pip/urllib3-1.24.2
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="protocol_projmatch.html">dependabot/pip/urllib3-1.24.2</a></dd>
            <dd><a href="../../../../../dm_facilitiesUpdate/index.html">dm_facilitiesUpdate</a></dd>
            <dd><a href="../../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../../update_scipion_modes/index.html">update_scipion_modes</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>