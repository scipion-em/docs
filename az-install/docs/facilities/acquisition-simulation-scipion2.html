

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>API scripting demo (Scipion2) &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>API scripting demo (Scipion2)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/docs/facilities/acquisition-simulation-scipion2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="api-scripting-demo-scipion2">
<span id="acquisition-simulation-scipion2"></span><h1>API scripting demo (Scipion2)<a class="headerlink" href="#api-scripting-demo-scipion2" title="Permalink to this headline">¶</a></h1>
<p>This tutorial try to put into practice the previous facilities sections
by means of a demo which simulates a whole cryo-EM acquisition session.</p>
<p>This tutorial is intended to be follow using Scipion2</p>
<p>The demo is made of the following 5 logical steps:</p>
<ol class="arabic simple">
<li><a class="reference external" href="acquisition-simulation#id1">Simulating a cryo-EM acquisition</a>
by taking movies from a data set to deposit it in a simulated deposition
directory, one by one every a certain time step.</li>
<li><a class="reference external" href="acquisition-simulation#wizard-for-user-parameters">Launching a wizard</a>
asking for some parameters that the user can set.</li>
<li><a class="reference external" href="acquisition-simulation#creating-custom-workflows">Creating the workflow</a>
according to that user and config parameters.</li>
<li><a class="reference external" href="acquisition-simulation#launch-and-open-projects">Launching and opening that workflow</a>.</li>
<li><a class="reference external" href="customize-html-report">Customizing the HTML report</a>.</li>
</ol>
<p>Notice that these 5 steps are independent one each other. Moreover,
each of them can be done in different ways and, this demo wants to be just an
example of how to do them. However, we will give some hints of alternative
procedures.</p>
<p>This demo uses a set of scripts from our <a class="reference external" href="https://github.com/I2PC/em-facilities">em-facilities script-sharing repository</a>, thus clone the repository to be able
to run this demo</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/I2PC/em-facilities
</pre></div>
</div>
<div class="section" id="config-file">
<h2>0. Config file<a class="headerlink" href="#config-file" title="Permalink to this headline">¶</a></h2>
<p>First of all, it is very useful to have a file where to store some parameters
which usually remains constant for a certain configuration/system/PC/facility.
We call this file <strong>config file</strong>.</p>
<p>For instance, the <a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/scipionbox.conf">usingAPI-demo/scipionbox.conf</a> file contains
some constant parameters useful for this demo</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>GLOBAL<span class="o">]</span>
<span class="nv">DEPOSITION_PATH</span> <span class="o">=</span> ~/microDepositions
<span class="nv">PATTERN</span> <span class="o">=</span> *.mrcs
<span class="nv">GAIN_PAT</span> <span class="o">=</span> gain.mrc
<span class="nv">SCIPION_PROJECT</span> <span class="o">=</span> ~/ScipionUserData/projects
<span class="nv">SIMULATION</span> <span class="o">=</span> True
<span class="nv">RAWDATA_SIM</span> <span class="o">=</span> ~/ScipionUserData/testData/betagalMovies
<span class="nv">NUM_CPU</span> <span class="o">=</span> <span class="m">64</span>

<span class="o">[</span>MICROSCOPE<span class="o">]</span>
<span class="nv">AMP_CONTR</span> <span class="o">=</span> <span class="m">0</span>.1
<span class="nv">SPH_AB</span> <span class="o">=</span> <span class="m">2</span>.7
<span class="nv">VOL_KV</span> <span class="o">=</span> <span class="m">300</span>
<span class="nv">SAMPLING</span> <span class="o">=</span> <span class="m">0</span>.637
<span class="nv">TIMEOUT</span> <span class="o">=</span> <span class="m">1</span>*60
<span class="nv">INV_CONTR</span> <span class="o">=</span> True
<span class="nv">PARTS2CLASS</span> <span class="o">=</span> <span class="m">3000</span>
</pre></div>
</div>
<p>We can see two sections <em>Global</em> and <em>Microscope</em> getting the following parameters.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><em>Global</em>:</dt>
<dd><ul class="first last">
<li><em>DEPOSITION_PATH</em>: Where Scipion will look for movies.</li>
<li><em>PATTERN</em>: The bash pattern that all movies have to match to be imported.</li>
<li><em>GAIN_PAT</em>: The bash pattern that the gain must match to be used (it must
also be at the <em>deposition path</em> in this case).</li>
<li><em>SCIPION_PROJECT</em>: Where to store the Scipion project.</li>
<li><em>SIMULATION</em>: If <code class="docutils literal notranslate"><span class="pre">True</span></code>, a <a class="reference external" href="acquisition-simulation#id1">simulation</a> is
performed by means of linking files from <em>RAWDATA_SIM</em> to
<em>DEPOSITION_PATH</em> every certain time. If <code class="docutils literal notranslate"><span class="pre">False</span></code>, no simulation is done
and <em>DEPOSITION_PATH</em> is expected to be automatically full.</li>
<li><em>RAWDATA_SIM</em>: Where to find a data set to be used for the simulation
(ignored if <code class="docutils literal notranslate"><span class="pre">False</span></code> in the previous point).</li>
<li><em>NUM_CPU</em>: Number of system CPUs to optimize the workflow.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><em>MICROSCOPE</em>:</dt>
<dd><ul class="first last">
<li><em>AMP_CONTR</em>: Amplitude contrast of the microscope.</li>
<li><em>SPH_AB</em>: Spherical aberration of the microscope (in <em>mm</em>).</li>
<li><em>VOL_KV</em>: Working microscope voltage (in <em>kV</em>).</li>
<li><em>SAMPLING</em>: Sampling rate (in <em>A/px</em>).</li>
<li><em>TIMEOUT</em>: General <a class="reference external" href="https://scipion-em.github.io/docs/docs/facilities/facilities-workflows.html#streaming-workflows">timeout</a> for the streaming mode and,
if <em>SIMULATION</em> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, the simulated acquisition rate (in <em>s</em>).</li>
<li><em>INV_CONTR</em>: If <code class="docutils literal notranslate"><span class="pre">True</span></code> a contrast inversion is done before picking.
If <code class="docutils literal notranslate"><span class="pre">False</span></code>, no inversion of contrast is done.</li>
<li><em>PARTS2CLASS</em>: Number of particles to wait before to perform a 2D
classification of a first batch.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>If you think that some of these parameters are not so constant, you could not
include it and, then ask for it <a class="reference external" href="acquisition-simulation#wizard-for-user-parameters">using a wizard</a> or the option you consider.
Also, here we have included some workflow dependent parameter such as
the <em>PART2CLASS</em>. You are free to put more or less parameters here, just have
in mind that they are parameters that rarely change from one acquisition to the
next.</p>
</div>
<div class="section" id="acquisition-simulation">
<h2>1. Acquisition simulation<a class="headerlink" href="#acquisition-simulation" title="Permalink to this headline">¶</a></h2>
<p>This point is just to simulate a periodically getting of movies. Nothing else.
If you intend to run in a real acquisition, you can skip this point.</p>
<p>The script <a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/simulate_acquisition.py">usingAPI-demo/simulate_acquisition.py</a>
in the cloned repository</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Usage: simulate_acquisition.py INPUT_PATTERN OUTPUT_FOLDER <span class="o">[</span>GAIN_FILE<span class="o">]</span> <span class="o">[</span>DELAY<span class="o">]</span>

        INPUT_PATTERN: input pattern matching input files.
        OUTPUT_FOLDER: where to create the output links.
        <span class="o">[</span>GAIN_FILE, default None<span class="o">]</span>: gain file will be linked at the beginning
        <span class="o">[</span>DELAY, default <span class="m">30</span><span class="o">]</span>: delay in seconds between file appearance
</pre></div>
</div>
<p>makes symbolic links of those files matching <em>INPUT_PATTERN</em> to <em>OUTPUT_FOLDER</em>
every <em>DELAY</em> seconds. If a <em>GAIN_FILE</em> is found, it is linked first.</p>
</div>
<div class="section" id="wizard-for-user-parameters">
<h2>2. Wizard for user parameters<a class="headerlink" href="#wizard-for-user-parameters" title="Permalink to this headline">¶</a></h2>
<p>Every acquisition have singularities from the others. That singularities can be
from the sample type, from the user preferences, from the EM operator preferences,
from the resources availability or, even, from the microscope status.
Then, we should have some flexibility to process the sample, but first of all,
we need to know this singularities.</p>
<p>In this demo, we have re-used the GUI code in Scipion for creating a wizard in
order to ask for all these parameters that can be different from one acquisition
to the other. However, every facility can develop its own way to retrieve these
(or others) parameters, such as a web form, using the facilities booking system…
We refer to that parameters as <em>user parameters</em>.</p>
<p>The code of this wizard can be found in
<a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/form_launcher.py">usingAPI-demo/form_launcher.py</a>
in the cloned repository.
We have design this script in four logical steps:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/I2PC/em-facilities/blob/8a31f7f5eed3dc73443266272c40b1da6432135d/usingAPI_demo/form_launcher.py#L470-L510">Reading the config file</a>.</li>
<li><a class="reference external" href="https://github.com/I2PC/em-facilities/blob/8a31f7f5eed3dc73443266272c40b1da6432135d/usingAPI_demo/form_launcher.py#L49-L133">Creating the wizard window using some Scipion-tkinter classes as base</a>.</li>
<li><a class="reference external" href="https://github.com/I2PC/em-facilities/blob/8a31f7f5eed3dc73443266272c40b1da6432135d/usingAPI_demo/form_launcher.py#L135-L230">Filling the wizard with the fields</a>.</li>
<li><a class="reference external" href="https://github.com/I2PC/em-facilities/blob/8a31f7f5eed3dc73443266272c40b1da6432135d/usingAPI_demo/form_launcher.py#L235-L394">Retrieving the parameters</a>.</li>
</ul>
<p>The wizard can be launched by running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion python em-facilities/usingAPI-demo/form_launcher.py
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/facilities-API-wizard.png"><img alt="facilities API wizard" src="../../_images/facilities-API-wizard.png" style="width: 800px;" /></a>
</div>
<p>All the default values in the <strong>Pre-processing</strong> section
(also in the <a class="reference external" href="acquisition-simulation.html#config-file">scipionbox.conf</a>)
are thought to be used with the beta-galactosidase sample (<a class="reference external" href="https://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10061">EMPIAR 10061</a> dataset).
However, you can play setting the parameters in some way or adjusting them
to your single data.</p>
<p>For instance:</p>
<ul class="simple">
<li>We know that this sample belongs to the <code class="docutils literal notranslate"><span class="pre">d2</span></code> <strong>symmetry group</strong> and
this will be used to estimate the initial model, however one can introduce any
other symmetry group.</li>
<li>This movies have 16 frames, thus you cat skip some of them by indicating a
certain <strong>Frames range</strong>.</li>
<li>If a certain <strong>Number of mics to manual pick</strong> is set, the workflow will wait
until this number is reached before launching the manual picker. If 0 is set,
only automatic picking is done and the particle size is estimated by <em>Xmipp</em>.</li>
<li>We can add optional protocols, such as <em>Optical flow</em> to do a high order local
movie alignment, <em>Eman2-Sparx</em> to automatic picking, or adding more initial
volume reconstruction methods to the <em>Xmipp swarm init. vol. consensus</em> protocol,
such as <em>Xmipp Ransac</em> and/or <em>Eman Initial Volume</em>.
Note that <em>Xmipp Significance</em> is always used to estimate the initial model.</li>
</ul>
<p>For the <strong>GPU usage</strong> section, note that all the protocols in the workflow will
be running in parallel at the same time, then only one GPU id can be attached
to one single protocol to prevent GPU concurrence crashes.</p>
<p>Now, we are able to start the processing over the simulation acquisition
by clicking on <strong>Create New Session</strong>.</p>
</div>
<div class="section" id="creating-custom-workflows">
<h2>3. Creating custom workflows<a class="headerlink" href="#creating-custom-workflows" title="Permalink to this headline">¶</a></h2>
<p>Once we know all the parameters that will be used, we must create the workflow
accordingly. At this point there are two options:</p>
<ul class="simple">
<li>Fill a <em>JSON</em> file with all the protocols parameters accordingly with the
previous section.</li>
<li>Use the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.html">Scipion’s API</a>
to create a new project and adding every protocol accordingly to the previous
section.</li>
</ul>
<p>You can code a script to fill a <em>JSON</em> file according to all what Scipion expect.
Although, a good option to go with the <em>JSON</em> way is to choose a certain
<em>JSON</em> file from a stored set of templates, according to the user answers.</p>
<p>However, in this tutorial we have choose to develop a Python script using the
Scipion’s API to create the project and to add all the protocols according to
the wizard described in the previous section.</p>
<p>See <a class="reference external" href="facilities-API-demo">how to create workflows with the API</a> to continue.</p>
</div>
<div class="section" id="launch-and-open-projects">
<h2>4. Launch and open projects<a class="headerlink" href="#launch-and-open-projects" title="Permalink to this headline">¶</a></h2>
<div class="section" id="launch-a-project">
<h3>Launch a project<a class="headerlink" href="#launch-a-project" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="facilities-workflows#static-templates">launching JSON workflows</a> if
you crated a JSON file.</p>
<p>In case of API workflows, if the protocols included in the workflow made in the
previous section are <a class="reference external" href="facilities-API-demo#registering-protocols">saved instead of launched</a>, we must to launch the whole
workflow at once by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion python <span class="nv">$SCIPION_HOME</span>/pyworkflow/project/scripts/schedule.py projectName
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">projectName</span></code> is the name of the project made in the previous section.
Alternatively, the whole workflow can also be launch from the GUI by selecting
the <em>Import Movies &gt; right-click &gt; Restart workflow</em>.</p>
<p>Note that if the protocols have been launched during the workflow creation, this
step must be skipped.</p>
</div>
<div class="section" id="open-a-project">
<h3>Open a project<a class="headerlink" href="#open-a-project" title="Permalink to this headline">¶</a></h3>
<p>To open a project you can either open the Scipion GUI and choose the project
from the project window or just run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion project projectName
</pre></div>
</div>
</div>
</div>
<div class="section" id="customize-the-html-report">
<h2>5. Customize the HTML report<a class="headerlink" href="#customize-the-html-report" title="Permalink to this headline">¶</a></h2>
<p>The <em>HTML</em> report can be customized to the facilities’ needs. It haven’t be
customized every acquisition but just once. However, we include here
<a class="reference external" href="customize-html-report">how to customize the HTML report</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: az-install
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="acquisition-simulation-scipion2.html">az-install</a></dd>
            <dd><a href="../../../dependabot_pip_jinja2-2.11.3/docs/facilities/acquisition-simulation-scipion2.html">dependabot/pip/jinja2-2.11.3</a></dd>
            <dd><a href="../../../dependabot_pip_pygments-2.7.4/docs/facilities/acquisition-simulation-scipion2.html">dependabot/pip/pygments-2.7.4</a></dd>
            <dd><a href="../../../dependabot_pip_urllib3-1.26.5/docs/facilities/acquisition-simulation-scipion2.html">dependabot/pip/urllib3-1.26.5</a></dd>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/facilities/acquisition-simulation-scipion2.html">release-3.0.0</a></dd>
            <dd><a href="../../../rsanchezgarc-patch-1/docs/facilities/acquisition-simulation-scipion2.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>