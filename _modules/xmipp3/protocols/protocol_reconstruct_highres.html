

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xmipp3.protocols.protocol_reconstruct_highres &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/appion/appion.html">appion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atomstructutils/atomstructutils.html">atomstructutils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atsas/atsas.html">atsas package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bamfordlab/bamfordlab.html">bamfordlab package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bsoft/bsoft.html">bsoft package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/ccp4/ccp4.html">ccp4 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/chimera/chimera.html">chimera package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cistem/cistem.html">cistem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryoef/cryoef.html">cryoef package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryosparc2/cryosparc2.html">cryosparc2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dynamo/dynamo.html">dynamo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/eman2/eman2.html">eman2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/emxlib/emxlib.html">emxlib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/fsc3d/fsc3d.html">fsc3d package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gautomatch/gautomatch.html">gautomatch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gctf/gctf.html">gctf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imod/imod.html">imod package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/localrec/localrec.html">localrec package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/locscale/locscale.html">locscale package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/motioncorr/motioncorr.html">motioncorr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/novactf/novactf.html">novactf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/phenix/phenix.html">phenix package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyworkflow/pyworkflow.html">pyworkflow package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pwem/pwem.html">pwem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/relion/relion.html">relion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/resmap/resmap.html">resmap package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/scipion/scipion.html">scipion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/sphire/sphire.html">sphire package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/spider/spider.html">spider package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/tomo/tomo.html">tomo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/topaz/topaz.html">topaz package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/xmipp3/xmipp3.html">xmipp3 package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../xmipp3.html">xmipp3</a> &raquo;</li>
        
      <li>xmipp3.protocols.protocol_reconstruct_highres</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xmipp3.protocols.protocol_reconstruct_highres</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Carlos Oscar Sorzano (coss@cnb.csic.es)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Protocol to perform high-resolution reconstructions</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">izip</span> <span class="o">=</span> <span class="nb">zip</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">split</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="k">import</span> <span class="n">VERSION_1_1</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="k">import</span> <span class="n">LEVEL_ADVANCED</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">import</span> <span class="p">(</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span>
                                        <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span>
                                        <span class="n">NumericListParam</span><span class="p">,</span> <span class="n">USE_GPU</span><span class="p">,</span> <span class="n">GPU_LIST</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.path</span> <span class="k">import</span> <span class="p">(</span><span class="n">cleanPath</span><span class="p">,</span> <span class="n">makePath</span><span class="p">,</span> <span class="n">copyFile</span><span class="p">,</span> <span class="n">moveFile</span><span class="p">,</span>
                                   <span class="n">createLink</span><span class="p">,</span> <span class="n">cleanPattern</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtRefine3D</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="k">import</span> <span class="n">SetOfVolumes</span><span class="p">,</span> <span class="n">Volume</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">import</span> <span class="n">getFirstRow</span><span class="p">,</span> <span class="n">getSize</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.utils</span> <span class="k">import</span> <span class="n">getFloatListFromValues</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="k">import</span> <span class="n">ImageHandler</span>
<span class="kn">import</span> <span class="nn">pwem.emlib.metadata</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">from</span> <span class="nn">pwem.constants</span> <span class="k">import</span> <span class="n">ALIGN_PROJ</span>

<span class="kn">from</span> <span class="nn">pwem</span> <span class="k">import</span> <span class="n">emlib</span>
<span class="kn">from</span> <span class="nn">xmipp3.base</span> <span class="k">import</span> <span class="n">HelicalFinder</span><span class="p">,</span> <span class="n">isXmippCudaPresent</span>
<span class="kn">from</span> <span class="nn">xmipp3.convert</span> <span class="k">import</span> <span class="n">createItemMatrix</span><span class="p">,</span> <span class="n">setXmippAttributes</span><span class="p">,</span> <span class="n">writeSetOfParticles</span>

<div class="viewcode-block" id="getPreviousQuality"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.getPreviousQuality">[docs]</a><span class="k">def</span> <span class="nf">getPreviousQuality</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imgRow</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;_xmipp_cost&quot;</span><span class="p">):</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_COST</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">_xmipp_cost</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;_xmipp_maxCC&quot;</span><span class="p">):</span>
        <span class="n">imgRow</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_MAXCC</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">_xmipp_maxCC</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes">[docs]</a><span class="k">class</span> <span class="nc">XmippProtReconstructHighRes</span><span class="p">(</span><span class="n">ProtRefine3D</span><span class="p">,</span> <span class="n">HelicalFinder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a 3D refinement protocol whose main input is a volume and a set of particles.</span>
<span class="sd">       The set of particles has to be at full size (the finer sampling rate available), but</span>
<span class="sd">       the rest of inputs (reference volume and masks) can be at any downsampling factor.</span>
<span class="sd">       The protocol scales the input images and volumes to a reasonable size depending on</span>
<span class="sd">       the resolution of the previous iteration.</span>
<span class="sd">       </span>
<span class="sd">       The protocol works with any input volume, whichever its resolution, as long as it</span>
<span class="sd">       is a reasonable initial volume for the set of particles. The protocol does not</span>
<span class="sd">       resolve the heterogeneous problem (it assumes an homogeneous population),</span>
<span class="sd">       although it is somewhat tolerant through the use of particle weights in the</span>
<span class="sd">       reconstruction process.</span>
<span class="sd">       </span>
<span class="sd">       It is recommended to perform several global alignment iterations before entering</span>
<span class="sd">       into the local iterations. The switch from global to local should be performed when</span>
<span class="sd">       a substantial percentage of the particles do not move from one iteration to the next.</span>
<span class="sd">       </span>
<span class="sd">       The algorithm reports the cross correlation (global alignment) or cost (local) function</span>
<span class="sd">       per defocus group, so that we can see which was the percentile of each particle in its</span>
<span class="sd">       defocus group. You may want to perform iterations one by one, and remove from one</span>
<span class="sd">       iteration to the next, those particles that worse fit the model.&quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;highres&#39;</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">VERSION_1_1</span>
    
    <span class="n">SPLIT_STOCHASTIC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SPLIT_FIXED</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">GLOBAL_ALIGNMENT</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">LOCAL_ALIGNMENT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">AUTOMATIC_ALIGNMENT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">STOCHASTIC_ALIGNMENT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">NO_ALIGNMENT</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># --------------------------- DEFINE param functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">USE_GPU</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Use GPU for execution&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This protocol has both CPU and GPU implementation.</span><span class="se">\</span>
<span class="s2">                       Select the one you want to use.&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">GPU_LIST</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                       <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Choose GPU IDs&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add a list of GPU devices that can be used&quot;</span><span class="p">)</span>


        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doContinue&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Continue from a previous run?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If you set to *Yes*, you should select a previous&#39;</span>
                      <span class="s1">&#39;run of type *</span><span class="si">%s</span><span class="s1">* class and some of the input parameters&#39;</span>
                      <span class="s1">&#39;will be taken from it.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">())</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Full-size Images&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a set of images at full resolution&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputVolumes&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Initial volumes&quot;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doContinue&#39;</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;Volume, SetOfVolumes&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a set of volumes with 2 volumes or a single volume. &#39;</span>
                           <span class="s1">&#39;If the input particles have an angular assignment, then you may &#39;</span>
                           <span class="s1">&#39;leave empty this field and a 3D reconstruction of the input images is &#39;</span>
                           <span class="s1">&#39;performed using reconstruct_fourier.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;particleRadius&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doContinue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Radius of particle (px)&#39;</span><span class="p">,</span>
                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This is the radius (in pixels) of the spherical mask covering the particle in the input images&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;continueRun&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doContinue&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Select previous run&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a previous run to continue from.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;symmetryGroup&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Symmetry group&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If no symmetry is present, give c1&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;saveSpace&quot;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Remove intermediate files&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Next Reference&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextLowPass&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Low pass filter?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply a low pass filter to the previous iteration whose maximum frequency is &#39;</span>\
                           <span class="s1">&#39;the current resolution(A) + resolutionOffset(A). If resolutionOffset&gt;0, then fewer information&#39;</span> \
                           <span class="s1">&#39;is used (meant to avoid overfitting). If resolutionOffset&lt;0, then more information is allowed &#39;</span>\
                           <span class="s1">&#39;(meant for a greedy convergence).&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextResolutionCriterion&#39;</span><span class="p">,</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FSC criterion&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The resolution of the reconstruction is defined as the inverse of the frequency at which &#39;</span>\
                      <span class="s1">&#39;the FSC drops below this value. Typical values are 0.143 and 0.5&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextResolutionOffset&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Resolution offset (A)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;nextLowPass&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextSpherical&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spherical mask?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply a spherical mask of the size of the particle. If the postprocessing indicates that it has helical symmetry,&#39;</span>
                           <span class="s1">&#39;then a cylindrical mask is applied&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextPositivity&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Positivity?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Remove from the next reference all negative values&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextMask&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;VolumeMask&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The mask values must be between 0 (remove these pixels) and 1 (let them pass). Smooth masks are recommended.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextDropout&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dropout&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This is the probability with which voxels are dropped (set to 0.0) inside the binary mask&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextReferenceScript&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Next reference command&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A command template that is used to generate next reference. The following variables can be used &#39;</span> 
                           <span class="s1">&#39;</span><span class="si">%(sampling)s</span><span class="s1"> </span><span class="si">%(dim)s</span><span class="s1"> </span><span class="si">%(volume)s</span><span class="s1"> </span><span class="si">%(iterDir)s</span><span class="s1">. The command should read Spider volumes and modify the input volume.&#39;</span>
                           <span class="s1">&#39;the command should be accessible either from the PATH or provide the absolute path.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Examples: </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;xmipp_transform_filter -i </span><span class="si">%(volume)s</span><span class="s1"> --fourier low_pass 15 --sampling </span><span class="si">%(sampling)s</span><span class="se">\n</span><span class="s1">&#39;</span> 
                           <span class="s1">&#39;/home/joe/myScript </span><span class="si">%(volume)s</span><span class="s1"> sampling=</span><span class="si">%(sampling)s</span><span class="s1"> dim=</span><span class="si">%(dim)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextRemove&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Remove reference to save space?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Remove reference volumes once they are not needed any more.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angular assignment&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="s1">&#39;splitMethod&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Image split method&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Stochastic&#39;</span><span class="p">,</span><span class="s1">&#39;Fixed&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_FIXED</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;multiresolution&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Multiresolution approach&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In the multiresolution approach the sampling rate of the images is adapted to the current resolution&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularMaxShift&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. shift (%)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum shift as a percentage of the image size&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Tilt angle:&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;0 degrees represent top views, 90 degrees represent side views&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularMinTilt&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Min.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Side views are around 90 degrees, top views around 0&quot;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularMaxTilt&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;You may generate redudant galleries by setting this angle to 180, this may help if c1 symmetry is considered&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;alignmentMethod&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Image alignment&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span><span class="s1">&#39;Automatic&#39;</span><span class="p">,</span><span class="s1">&#39;Stochastic&#39;</span><span class="p">,</span><span class="s1">&#39;No alignment&#39;</span><span class="p">],</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfIterations&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of iterations&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod!=2 and alignmentMethod!=4&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;NimgsSGD&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random subset size&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==3&#39;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stochastic alignment is performed by taking random subsets of images of this size&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;alphaSGD&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Step size&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==3&#39;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The update is performed as V(k+1)=(1-alpha)*V(k)+alpha*R(k+1), that is, the previous &quot;</span>
                                                       <span class="s2">&quot;volume weights 1-alpha, while the new one weights alpha&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s2">&quot;restrictReconstructionAngles&quot;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Restrict reconstruction angles&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;You may reconstruct only with those images falling on a certain range. This is particularly useful for helices where &quot;</span>\
                         <span class="s2">&quot;you may want to use projections very close to 90 degrees&quot;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Tilt angle restriction:&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;0 degrees represent top views, 90 degrees represent side views&#39;</span><span class="p">,</span>
                          <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;restrictReconstructionAngles&quot;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularMinTiltReconstruct&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Min.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;restrictReconstructionAngles&quot;</span><span class="p">,</span>
                      <span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Perform an angular assignment and only use those images whose angles are within these limits&quot;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;angularMaxTiltReconstruct&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">92</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;restrictReconstructionAngles&quot;</span><span class="p">,</span>
                      <span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Perform an angular assignment and only use those images whose angles are within these limits&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maximumTargetResolution&#39;</span><span class="p">,</span> <span class="n">NumericListParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. Target Resolution&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;15 8 4&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;multiresolution&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In Angstroms. The actual maximum resolution will be the maximum between this number of 0.5 * previousResolution, meaning that&quot;</span>
                      <span class="s2">&quot;in a single step you cannot increase the resolution more than 1/2&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="s1">&#39;numberOfPerturbations&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Number of Perturbations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod!=1&#39;</span><span class="p">,</span>
                  <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The gallery of reprojections is randomly perturbed this number of times&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="s1">&#39;numberOfReplicates&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. Number of Replicates&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod!=1&#39;</span><span class="p">,</span>
                  <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Significant alignment is allowed to replicate each image up to this number of times&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contShift&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimize shifts?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optimize shifts within a limit&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contMaxShiftVariation&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. shift variation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Percentage of the image size&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contScale&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimize scale?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optimize scale within a limit&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contMaxScale&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. scale variation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contAngles&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimize angles?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optimize angles within a limit&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contGrayValues&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimize gray values?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optimize gray values. Do not perform this unless the reconstructed volume is gray-compatible with the projections,&#39;</span>\
                      <span class="s1">&#39; i.e., the volumes haven been produced from projections&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contMaxGrayScale&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. gray scale variation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contMaxGrayShift&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. gray shift variation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s1">&#39;As a factor of the image standard deviation&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contDefocus&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimize defocus?&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contMaxDefocus&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. defocus variation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In Angstroms&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;contPadding&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fourier padding factor&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The volume is zero padded by this factor to produce projections&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weights&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;weightSSNR&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weight by SSNR?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight input images by SSNR&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;weightContinuous&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weight by Continuous cost?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;alignmentMethod==1&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight input images by angular assignment cost&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;weightJumper&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weight by angular stability?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight input images by angular stability between iterations&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;weightCC&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weight by CC percentile?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weight input images by their fitness (cross correlation) percentile in their defocus group&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;weightCCmin&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Minimum CC weight&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Weights are between this value and 1. If most of the particles are good, this value should be high (e.g., 0.9)&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Post-processing&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postAdHocMask&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;VolumeMask&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The mask values must be between 0 (remove these pixels) and 1 (let them pass). Smooth masks are recommended.&#39;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Symmetry&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryWithinMask&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Symmetrize volume within mask?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryWithinMaskType&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mask symmetry&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;i1&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;postSymmetryWithinMask&quot;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If no symmetry is present, give c1&#39;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryWithinMaskMask&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;VolumeMask&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;postSymmetryWithinMask&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The mask values must be between 0 (remove these pixels) and 1 (let them pass). Smooth masks are recommended.&#39;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Apply helical symmetry?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalRadius&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Radius&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In Angstroms&quot;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalDihedral&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dihedral symmetry&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalMinRot&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Min. Rotation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In degrees&quot;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalMaxRot&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. Rotation&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">360</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In degrees&quot;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalMinZ&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Min. Z shift&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In angstroms&quot;</span><span class="p">)</span>
        <span class="n">groupSymmetry</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSymmetryHelicalMaxZ&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. Z shift&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;postSymmetryHelical&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In angstroms&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postScript&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Post-processing command&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A command template that is used to post-process the reconstruction. The following variables can be used &#39;</span> 
                           <span class="s1">&#39;</span><span class="si">%(sampling)s</span><span class="s1"> </span><span class="si">%(dim)s</span><span class="s1"> </span><span class="si">%(volume)s</span><span class="s1"> </span><span class="si">%(iterDir)s</span><span class="s1">. The command should read Spider volumes and modify the input volume.&#39;</span>
                           <span class="s1">&#39;the command should be accessible either from the PATH or provide the absolute path.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Examples: </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;xmipp_transform_filter -i </span><span class="si">%(volume)s</span><span class="s1"> --fourier low_pass 15 --sampling </span><span class="si">%(sampling)s</span><span class="se">\n</span><span class="s1">&#39;</span> 
                           <span class="s1">&#39;/home/joe/myScript </span><span class="si">%(volume)s</span><span class="s1"> sampling=</span><span class="si">%(sampling)s</span><span class="s1"> dim=</span><span class="si">%(dim)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSignificantDenoise&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Significant denoising Real space&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postFilterBank&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Significant denoising Fourier space&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postLaplacian&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Laplacian denoising&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;It can only be used if there is a mask&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postDeconvolve&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Blind deconvolution&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSoftNeg&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Attenuate undershooting&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postSoftNegK&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Attenuate undershooting (K)&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Values below avg-K*sigma are attenuated&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;postDifference&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Evaluate difference&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="c1">#--------------------------- INSERT steps functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="s1">&#39;particleRadius&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="s1">&#39;inputVolumes&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copyAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="s1">&#39;inputParticles&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;copyBasicInformation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfPreviousIterations</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;doWeightSSNR&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;doIteration000&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">numberOfIterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="k">else</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_ALIGNMENT</span><span class="p">:</span>
            <span class="n">numberOfIterations</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maximumTargetResolution</span> <span class="o">=</span> <span class="n">getFloatListFromValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximumTargetResolution</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="o">+</span><span class="n">numberOfIterations</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="o">+</span><span class="n">numberOfIterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insertIteration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;createOutput&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="XmippProtReconstructHighRes.insertIteration"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.insertIteration">[docs]</a>    <span class="k">def</span> <span class="nf">insertIteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span> <span class="ow">or</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;globalAssignment&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_ALIGNMENT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;noAssignment&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;localAssignment&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;weightParticles&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;qualifyParticles&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;reconstruct&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;postProcessing&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;evaluateReconstructions&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;cleanDirectory&#39;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span></div>

    <span class="c1">#--------------------------- STEPS functions ---------------------------------------------------</span>
<div class="viewcode-block" id="XmippProtReconstructHighRes.convertInputStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.convertInputStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputParticlesId</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_ALIGNMENT</span><span class="p">:</span>
            <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span> <span class="n">postprocessImageRow</span><span class="o">=</span><span class="n">getPreviousQuality</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --fill image1 constant noImage&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;image1=image&quot;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --fill particleId constant 1&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;particleId=itemId&quot;&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imgsFnId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;imagesId.xmd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column particleId -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">imgsFnId</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.createOutput"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.createOutput">[docs]</a>    <span class="k">def</span> <span class="nf">createOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get last iteration</span>
        <span class="n">fnIterDir</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter*&quot;</span><span class="p">))</span>
        <span class="n">lastIter</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fnIterDir</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">fnLastDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">lastIter</span><span class="p">)</span>
        <span class="n">fnLastVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnLastDir</span><span class="p">,</span><span class="s2">&quot;volumeAvg.mrc&quot;</span><span class="p">)</span>
        <span class="n">Ts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnLastDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnLastVol</span><span class="p">):</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">Volume</span><span class="p">()</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">fnLastVol</span><span class="p">)</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">Ts</span><span class="p">)</span>
            <span class="n">halfMap1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnLastDir</span><span class="p">,</span><span class="s2">&quot;volume01.vol&quot;</span><span class="p">)</span>
            <span class="n">halfMap2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnLastDir</span><span class="p">,</span><span class="s2">&quot;volume02.vol&quot;</span><span class="p">)</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">setHalfMaps</span><span class="p">([</span><span class="n">halfMap1</span><span class="p">,</span> <span class="n">halfMap2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputVolume</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volume</span><span class="p">)</span>

        <span class="n">fnLastAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnLastDir</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnLastAngles</span><span class="p">):</span>
            <span class="n">fnAngles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;image=image1&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnLastAngles</span><span class="p">,</span><span class="n">fnAngles</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate sort particleId&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate drop_column image1&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;itemId=particleId&quot;&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaleFactor</span><span class="o">=</span><span class="n">Ts</span><span class="o">/</span><span class="n">imgSet</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
            <span class="n">imgSetOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfParticles</span><span class="p">()</span>
            <span class="n">imgSetOut</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
            <span class="n">imgSetOut</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>
            <span class="n">imgSetOut</span><span class="o">.</span><span class="n">setIsPhaseFlipped</span><span class="p">(</span> <span class="n">imgSet</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">iterRows</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">MDL_PARTICLE_ID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span><span class="p">)</span>
            <span class="n">imgSetOut</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span>
                                <span class="n">updateItemCallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_updateItem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputParticles</span><span class="o">=</span><span class="n">imgSetOut</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="p">,</span> <span class="n">imgSetOut</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_updateItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="ow">and</span> <span class="n">particle</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_PARTICLE_ID</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterMd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastRow</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">particle</span><span class="o">.</span><span class="n">_appendItem</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_createItemMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_X</span><span class="p">):</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_X</span><span class="p">))</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_Y</span><span class="p">))</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_FLIP</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_FLIP</span><span class="p">))</span>
        <span class="n">row</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleFactor</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scaleFactor</span><span class="p">)</span>
        <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TILT</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_ROT</span><span class="p">,</span>
                           <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SCALE</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_MAXCC</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_MAXCC_PERCENTILE</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_X</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_CONTINUOUS2</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST_PERCENTILE</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_IDX</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_MASK</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CORRELATION_WEIGHT</span><span class="p">,</span>
                               <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMED</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_SCALE_X</span><span class="p">):</span>
                <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_SCALE_X</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_SCALE_Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_GRAY_A</span><span class="p">):</span>
                <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_GRAY_A</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_GRAY_B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF2</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TEMPERATURE</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TEMPERATURE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_SSNR</span><span class="p">):</span>
            <span class="n">setXmippAttributes</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_SSNR</span><span class="p">)</span>
        <span class="n">createItemMatrix</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="n">ALIGN_PROJ</span><span class="p">)</span>

<div class="viewcode-block" id="XmippProtReconstructHighRes.getLastFinishedIter"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.getLastFinishedIter">[docs]</a>    <span class="k">def</span> <span class="nf">getLastFinishedIter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnFscs</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter???/fsc.xmd&quot;</span><span class="p">)))</span>
        <span class="n">lastDir</span><span class="o">=</span><span class="n">split</span><span class="p">(</span><span class="n">fnFscs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastDir</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.getNumberOfPreviousIterations"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.getNumberOfPreviousIterations">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberOfPreviousIterations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnDirs</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter???&quot;</span><span class="p">)))</span>
        <span class="n">lastDir</span><span class="o">=</span><span class="n">fnDirs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastDir</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.copyBasicInformation"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.copyBasicInformation">[docs]</a>    <span class="k">def</span> <span class="nf">copyBasicInformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previousRun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="n">previousRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">))</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="n">previousRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;imagesId.xmd&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;imagesId.xmd&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">previousRun</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="n">previousRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;ssnrWeights.xmd&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;ssnrWeights.xmd&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doWeightSSNR</span><span class="p">()</span>

        <span class="n">lastIter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfPreviousIterations</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">lastIter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">createLink</span><span class="p">(</span><span class="n">previousRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">),</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.doWeightSSNR"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.doWeightSSNR">[docs]</a>    <span class="k">def</span> <span class="nf">doWeightSSNR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_ssnr&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -R </span><span class="si">%d</span><span class="s2"> --sampling </span><span class="si">%f</span><span class="s2"> --normalizessnr&quot;</span><span class="o">%</span>\
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;particleId weightSSNR&quot; &#39;</span><span class="o">%</span>\
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;ssnrWeights.xmd&quot;</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.doIteration000"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.doIteration000">[docs]</a>    <span class="k">def</span> <span class="nf">doIteration000</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;Iter000&#39;</span><span class="p">)</span>
        <span class="n">makePath</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">)</span>

        <span class="c1"># Split data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_FIXED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_split&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --oroot </span><span class="si">%s</span><span class="s2">/images -n 2&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">fnDirCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images</span><span class="si">%06d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># Get volume sampling rate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>

        <span class="c1"># Copy reference volumes and window if necessary</span>
        <span class="n">Xdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newXdim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">Xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">,</span><span class="n">newXdim</span><span class="p">)</span>
        
        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">SetOfVolumes</span><span class="p">):</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="n">fnVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newXdim</span><span class="o">!=</span><span class="n">vol</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_window&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --size </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnVol1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fnVol2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --max_resolution 0.3 --sampling </span><span class="si">%f</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span> <span class="n">fnVol1</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="c1">#AJ to make it work with and without queue system</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">N_GPUs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -gpusPerNode </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">N_GPUs</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -threadsPerGPU </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">GpuListCuda</span><span class="p">)</span>

                    <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --thr </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_reconstruct_fourier_accel&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                                <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">volXdim</span> <span class="o">=</span> <span class="n">Xdim</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">fnVol1</span><span class="p">)</span>
                <span class="n">volXdim</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">getDim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">newXdim</span><span class="o">!=</span><span class="n">volXdim</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_window&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --size </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
               <span class="n">maxFreq</span><span class="o">=</span><span class="mf">0.25</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">maxFreq</span><span class="o">=</span><span class="mf">0.45</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_randomize_phases&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --freq discrete </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">maxFreq</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compare both reconstructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluateReconstructions</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get the angles and shifts from images into this directory as if this directory</span>
        <span class="c1"># had been the result of a global alignment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.evaluateReconstructions"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.evaluateReconstructions">[docs]</a>    <span class="k">def</span> <span class="nf">evaluateReconstructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">fnVol1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fnVol2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fnVolFSC1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeFSC</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fnVolFSC2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeFSC</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnVolFSC1</span><span class="p">):</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVolFSC1</span><span class="p">)</span>
            <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnVolFSC2</span><span class="p">)</span>

        <span class="c1"># Apply mask if available</span>
        <span class="n">fnMask</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="n">volXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postAdHocMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnMask</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepareMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postAdHocMask</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">fnMask</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">volXdim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolFSC1</span><span class="p">,</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolFSC2</span><span class="p">,</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_threshold&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --select below 0 --substitute value 0 &#39;</span><span class="o">%</span><span class="n">fnVolFSC1</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_threshold&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --select below 0 --substitute value 0 &#39;</span><span class="o">%</span><span class="n">fnVolFSC2</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Estimate resolution</span>
        <span class="n">fnFsc</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;fsc.xmd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_resolution_fsc&#39;</span><span class="p">,</span><span class="s1">&#39;--ref </span><span class="si">%s</span><span class="s1"> -i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --sampling_rate </span><span class="si">%f</span><span class="s1">&#39;</span>\
                    <span class="o">%</span><span class="p">(</span><span class="n">fnVolFSC1</span><span class="p">,</span><span class="n">fnVolFSC2</span><span class="p">,</span><span class="n">fnFsc</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnVolFSC1</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnVolFSC2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnMask</span><span class="p">)</span>

        <span class="c1"># Estimate resolution before postprocessing</span>
        <span class="n">fnBeforeVol1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeBeforePostProcessing</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fnBeforeVol2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeBeforePostProcessing</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnBeforeVol1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnBeforeVol2</span><span class="p">):</span>
            <span class="n">fnBeforeFsc</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;fscBeforePostProcessing.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_resolution_fsc&#39;</span><span class="p">,</span><span class="s1">&#39;--ref </span><span class="si">%s</span><span class="s1"> -i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --sampling_rate </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnBeforeVol1</span><span class="p">,</span><span class="n">fnBeforeVol2</span><span class="p">,</span><span class="n">fnBeforeFsc</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mdFSC</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnFsc</span><span class="p">)</span>
        <span class="n">resolution</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">TsCurrent</span>
        <span class="k">for</span> <span class="n">objId</span> <span class="ow">in</span> <span class="n">mdFSC</span><span class="p">:</span>
            <span class="n">fsc</span> <span class="o">=</span> <span class="n">mdFSC</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FRC</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fsc</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nextResolutionCriterion</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">mdFSC</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">TsCurrent</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mf">0.25</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">TsCurrent</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mf">0.45</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span>

        <span class="c1"># Produce a filtered volume</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_filter&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --fourier low_pass </span><span class="si">%f</span><span class="s1"> --sampling </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span>\
                        <span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeAvg.mrc&quot;</span><span class="p">),</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeAvgFiltered.mrc&quot;</span><span class="p">),</span><span class="n">resolution</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># A little bit of statistics (accepted and rejected particles, number of directions, ...)</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fnAnglesi</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mdAngles</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAnglesi</span><span class="p">)</span>
                <span class="n">mdUnique</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
                <span class="n">mdUnique</span><span class="o">.</span><span class="n">aggregateMdGroupBy</span><span class="p">(</span><span class="n">mdAngles</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">AGGR_MAX</span><span class="p">,</span> <span class="p">[</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_PARTICLE_ID</span><span class="p">],</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">)</span>
                <span class="n">mdUnique</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_PARTICLE_ID</span><span class="p">)</span>
                <span class="n">fnAnglesUnique</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesUsed</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mdUnique</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnAnglesUnique</span><span class="p">)</span>

            <span class="n">fnUsed</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesUsed.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnUsed1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesUsed01.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnUsed2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesUsed02.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set union_all </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnUsed1</span><span class="p">,</span><span class="n">fnUsed2</span><span class="p">,</span><span class="n">fnUsed</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnUsed1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnUsed2</span><span class="p">)</span>
            <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnUsedId</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesUsedId.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate keep_column particleId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnUsed</span><span class="p">,</span><span class="n">fnUsedId</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set natural_join </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnUsedId</span><span class="p">,</span><span class="n">fnAngles</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">fnImages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnImagesId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;imagesId.xmd&#39;</span><span class="p">)</span>
            <span class="n">fnImagesRejected</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;imagesRejected.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set subtraction </span><span class="si">%s</span><span class="s2"> particleId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnImagesId</span><span class="p">,</span><span class="n">fnUsedId</span><span class="p">,</span><span class="n">fnImagesRejected</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set natural_join </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnImagesRejected</span><span class="p">,</span><span class="n">fnImages</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnUsedId</span><span class="p">)</span>

            <span class="n">Nimages</span><span class="o">=</span><span class="n">getSize</span><span class="p">(</span><span class="n">fnImages</span><span class="p">)</span>
            <span class="n">Nrepeated</span><span class="o">=</span><span class="n">getSize</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">))</span>
            <span class="n">Nunique</span><span class="o">=</span><span class="n">getSize</span><span class="p">(</span><span class="n">fnUsed</span><span class="p">)</span>
            <span class="n">Nrejected</span><span class="o">=</span><span class="n">getSize</span><span class="p">(</span><span class="n">fnImagesRejected</span><span class="p">)</span>

            <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;statistics.txt&quot;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Number of input    images: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">Nimages</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Number of used     images: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">Nunique</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Number of rejected images: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">Nrejected</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Nunique</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Average number of directions per used image: </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Nrepeated</span><span class="p">)</span><span class="o">/</span><span class="n">Nunique</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.checkInfoField"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.checkInfoField">[docs]</a>    <span class="k">def</span> <span class="nf">checkInfoField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">block</span><span class="p">):</span>
        <span class="n">fnInfo</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;iterInfo.xmd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnInfo</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">getBlocksInMetaDataFile</span><span class="p">(</span><span class="n">fnInfo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.readInfoField"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.readInfoField">[docs]</a>    <span class="k">def</span> <span class="nf">readInfoField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
        <span class="n">mdInfo</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;iterInfo.xmd&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">mdInfo</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">firstObject</span><span class="p">())</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.writeInfoField"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.writeInfoField">[docs]</a>    <span class="k">def</span> <span class="nf">writeInfoField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">mdInfo</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
        <span class="n">objId</span><span class="o">=</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
        <span class="n">mdInfo</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
        <span class="n">mdInfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;iterInfo.xmd&quot;</span><span class="p">)),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.prepareImages"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.prepareImages">[docs]</a>    <span class="k">def</span> <span class="nf">prepareImages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">getShiftsFrom</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing images to sampling rate=&quot;</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
        <span class="n">Xdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newXdim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">Xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newXdim</span><span class="o">&lt;</span><span class="mi">40</span><span class="p">:</span>
            <span class="n">newXdim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="n">Xdim</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">newXdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">newXdim</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">newXdim</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="n">Xdim</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">newXdim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">,</span><span class="n">newXdim</span><span class="p">)</span>
        
        <span class="c1"># Prepare particles</span>
        <span class="n">fnDir0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter000&quot;</span><span class="p">)</span>
        <span class="n">fnNewParticles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.stk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newXdim</span><span class="o">!=</span><span class="n">Xdim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --fourier </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --save_metadata_stack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">R</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxShift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)),</span><span class="n">newXdim</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_mask&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mask circular -</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">R</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
        <span class="n">fnSource</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_ctf_correct_phase&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fnSource</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">24</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_STOCHASTIC</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set intersection </span><span class="si">%s</span><span class="s1"> particleId particleId -o </span><span class="si">%s</span><span class="s1">/all_images.xmd&#39;</span><span class="o">%</span>\
                        <span class="p">(</span><span class="n">fnSource</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">),</span><span class="n">fnDir</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_split&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2">/all_images.xmd --oroot </span><span class="si">%s</span><span class="s2">/images -n 2&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="n">fnDir</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/all_images.xmd&quot;</span><span class="o">%</span><span class="n">fnDir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images</span><span class="si">%06d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fnImagesi</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set intersection </span><span class="si">%s</span><span class="s1">/images</span><span class="si">%02d</span><span class="s1">.xmd particleId particleId -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnSource</span><span class="p">,</span><span class="n">fnDir0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">fnImagesi</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnSource</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fnImagesi</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate random_subset </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnImagesi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NimgsSGD</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">getShiftsFrom</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fnPreviousAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">getShiftsFrom</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
            <span class="n">TsPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">getShiftsFrom</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
            <span class="n">fnAux</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;aux.xmd&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fnImagesi</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set join </span><span class="si">%s</span><span class="s1"> particleId particleId -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnImagesi</span><span class="p">,</span><span class="n">fnPreviousAngles</span><span class="p">,</span><span class="n">fnAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adaptShifts</span><span class="p">(</span><span class="n">fnAux</span><span class="p">,</span> <span class="n">TsPrevious</span><span class="p">,</span> <span class="n">fnImagesi</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAux</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.prepareReferences"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.prepareReferences">[docs]</a>    <span class="k">def</span> <span class="nf">prepareReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">targetResolution</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing references to sampling rate=&quot;</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
        <span class="n">fnMask</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">newXdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepareMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">fnMask</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">newXdim</span><span class="p">)</span>
        <span class="n">oldXdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">fnPreviousVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnReferenceVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">oldXdim</span><span class="o">!=</span><span class="n">newXdim</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnPreviousVol</span><span class="p">,</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">copyFile</span><span class="p">(</span><span class="n">fnPreviousVol</span><span class="p">,</span> <span class="n">fnReferenceVol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_filter&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --fourier fsc </span><span class="si">%s</span><span class="s1"> --sampling </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;fsc.xmd&quot;</span><span class="p">),</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextLowPass</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_filter&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --fourier low_pass </span><span class="si">%f</span><span class="s1"> --sampling </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="n">targetResolution</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nextResolutionOffset</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextSpherical</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelical</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_mask&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --mask cylinder -</span><span class="si">%d</span><span class="s1"> -</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_mask&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --mask circular -</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextPositivity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_threshold&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --select below 0 --substitute value 0&#39;</span><span class="o">%</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --mult </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextDropout</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --dropout </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nextDropout</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextReferenceScript</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">scriptArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">fnReferenceVol</span><span class="p">,</span>
                              <span class="s1">&#39;sampling&#39;</span><span class="p">:</span> <span class="n">TsCurrent</span><span class="p">,</span>
                              <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">newXdim</span><span class="p">,</span>
                              <span class="s1">&#39;iterDir&#39;</span><span class="p">:</span> <span class="n">fnDir</span><span class="p">}</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextReferenceScript</span> <span class="o">%</span> <span class="n">scriptArgs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnMask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.prepareMask"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.prepareMask">[docs]</a>    <span class="k">def</span> <span class="nf">prepareMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maskObject</span><span class="p">,</span><span class="n">fnMask</span><span class="p">,</span><span class="n">TsMaskOut</span><span class="p">,</span><span class="n">XdimOut</span><span class="p">):</span>
        <span class="n">img</span><span class="o">=</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">maskObject</span><span class="p">,</span> <span class="n">fnMask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_resize&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --factor </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnMask</span><span class="p">,</span><span class="n">maskObject</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span><span class="o">/</span><span class="n">TsMaskOut</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">maskXdim</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">fnMask</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">XdimOut</span><span class="o">!=</span><span class="n">maskXdim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_window&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --size </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnMask</span><span class="p">,</span><span class="n">XdimOut</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.calculateAngStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.calculateAngStep">[docs]</a>    <span class="k">def</span> <span class="nf">calculateAngStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newXdim</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">ResolutionAlignment</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="n">newXdim</span><span class="o">*</span><span class="n">TsCurrent</span><span class="o">/</span><span class="n">ResolutionAlignment</span> <span class="c1"># Freq. index</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="c1"># Corresponding angular step</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.globalAssignment"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.globalAssignment">[docs]</a>    <span class="k">def</span> <span class="nf">globalAssignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">makePath</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">)</span>
        <span class="n">previousResolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">or</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span><span class="p">:</span>
            <span class="n">fnGlobal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;globalAssignment&quot;</span><span class="p">)</span>
            <span class="n">makePath</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">)</span>

            <span class="n">targetResolution</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">previousResolution</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_maximumTargetResolution</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiresolution</span><span class="p">:</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="p">,</span><span class="n">targetResolution</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span>
            <span class="n">getShiftsFrom</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="c1"># if iteration&gt;1: # This causes images to be replicated</span>
            <span class="c1">#    getShiftsFrom=fnDirPrevious</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepareImages</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnGlobal</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">getShiftsFrom</span><span class="p">)</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span> <span class="c1"># Prepare images may have changed it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepareReferences</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnGlobal</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">targetResolution</span><span class="p">)</span>

            <span class="c1"># Calculate angular step at this resolution</span>
            <span class="n">ResolutionAlignment</span><span class="o">=</span><span class="n">previousResolution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextLowPass</span><span class="p">:</span>
                <span class="n">ResolutionAlignment</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">nextResolutionOffset</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">newXdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
            <span class="n">angleStep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculateAngStep</span><span class="p">(</span><span class="n">newXdim</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">ResolutionAlignment</span><span class="p">)</span>
            <span class="n">angleStep</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">angleStep</span><span class="p">,</span><span class="mf">3.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;angleStep&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">angleStep</span><span class="p">))</span>
            
            <span class="c1"># Global alignment</span>
            <span class="n">perturbationList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfPerturbations</span><span class="o">.</span><span class="n">get</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fnDirSignificant</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;significant</span><span class="si">%02d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fnImgs</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">makePath</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">)</span>

                <span class="c1"># Create defocus groups</span>
                <span class="n">row</span><span class="o">=</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnImgs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_MODEL</span><span class="p">)</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_DEFOCUSU</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_ctf_group&quot;</span><span class="p">,</span><span class="s2">&quot;--ctfdat </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">/ctf:stk --pad 1.0 --sampling_rate </span><span class="si">%f</span><span class="s2"> --phase_flipped  --error 0.1 --resol </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">fnImgs</span><span class="p">,</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">targetResolution</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_images.sel&quot;</span><span class="o">%</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_groups.xmd&quot;</span><span class="o">%</span><span class="n">fnDirSignificant</span><span class="p">)</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_split.doc&quot;</span><span class="o">%</span><span class="n">fnDirSignificant</span><span class="p">)</span>
                    <span class="n">mdInfo</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="s2">&quot;numberGroups@</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;ctfInfo.xmd&quot;</span><span class="p">))</span>
                    <span class="n">fnCTFs</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_ctf.stk&quot;</span><span class="o">%</span><span class="n">fnDirSignificant</span>
                    <span class="n">numberGroups</span><span class="o">=</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">,</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">firstObject</span><span class="p">())</span>
                    <span class="n">ctfPresent</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">numberGroups</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">ctfPresent</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">fnCTFs</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

                <span class="c1"># Generate projections</span>
                <span class="n">fnReferenceVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">perturbationList</span><span class="p">:</span>
                    <span class="n">fnGallery</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d%s</span><span class="s2">.stk&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">subset</span><span class="p">))</span>
                    <span class="n">fnGalleryMd</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d%s</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">subset</span><span class="p">))</span>

                    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --min_tilt_angle </span><span class="si">%f</span><span class="s2"> --max_tilt_angle </span><span class="si">%f</span><span class="s2"> --perturb </span><span class="si">%f</span><span class="s2"> &quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">fnReferenceVol</span><span class="p">,</span> <span class="n">fnGallery</span><span class="p">,</span> <span class="n">angleStep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angularMinTilt</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxTilt</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angleStep</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --compute_neighbors --angular_distance -1 --experimental_images </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_project_library&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">24</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span> <span class="s2">&quot;gallery_angles</span><span class="si">%02d%s</span><span class="s2">.doc&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">subset</span><span class="p">)))</span>
                    <span class="n">moveFile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d%s</span><span class="s2">.doc&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">subset</span><span class="p">)),</span> <span class="n">fnGalleryMd</span><span class="p">)</span>
                    <span class="n">fnAngles</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span> <span class="s2">&quot;anglesDisc</span><span class="si">%02d%s</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">subset</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberGroups</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">fnAnglesGroup</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;angles_group</span><span class="si">%03d%s</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">subset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">ctfPresent</span><span class="p">:</span>
                                <span class="n">fnGroup</span><span class="o">=</span><span class="s2">&quot;ctfGroup</span><span class="si">%06d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">/ctf_groups.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">fnDirSignificant</span><span class="p">)</span>
                                <span class="n">fnCTF</span> <span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">/ctf_ctf.stk&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">fnDirSignificant</span><span class="p">)</span>
                                <span class="n">fnGalleryGroup</span><span class="o">=</span><span class="n">fnGallery</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d%s</span><span class="s2">_</span><span class="si">%06d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">subset</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
                                <span class="n">fnGalleryGroupMd</span><span class="o">=</span><span class="n">fnGallery</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d%s</span><span class="s2">_</span><span class="si">%06d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">subset</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_filter&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --fourier binary_file </span><span class="si">%s</span><span class="s2"> --save_metadata_stack </span><span class="si">%s</span><span class="s2"> --keep_input_columns&quot;</span><span class="o">%</span>\
                                            <span class="p">(</span><span class="n">fnGalleryMd</span><span class="p">,</span><span class="n">fnGalleryGroup</span><span class="p">,</span><span class="n">fnCTF</span><span class="p">,</span><span class="n">fnGalleryGroupMd</span><span class="p">),</span>
                                            <span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fnGroup</span><span class="o">=</span><span class="n">fnImgs</span>
                                <span class="n">fnGalleryGroup</span><span class="o">=</span><span class="n">fnGallery</span>
                                <span class="n">fnGalleryGroupMd</span><span class="o">=</span><span class="n">fnGalleryMd</span>
                            <span class="k">if</span> <span class="n">getSize</span><span class="p">(</span><span class="n">fnGroup</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># If the group is empty</span>
                                <span class="k">continue</span>
                            <span class="n">maxShift</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxShift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="n">newXdim</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
                            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">R</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span> <span class="o">/</span> <span class="n">TsCurrent</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --initgallery </span><span class="si">%s</span><span class="s1"> --maxShift </span><span class="si">%d</span><span class="s1"> --odir </span><span class="si">%s</span><span class="s1"> --dontReconstruct --useForValidation </span><span class="si">%d</span><span class="s1"> --dontCheckMirrors &#39;</span> <span class="o">%</span> \
                                       <span class="p">(</span><span class="n">fnGroup</span><span class="p">,</span> <span class="n">fnGalleryGroupMd</span><span class="p">,</span> <span class="n">maxShift</span><span class="p">,</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfReplicates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_reconstruct_significant&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                                <span class="c1"># moveFile(join(fnDirSignificant,&quot;images_significant_iter001_00.xmd&quot;),join(fnDirSignificant,&quot;angles_group%03d%s.xmd&quot;%(j,subset)))</span>
                                <span class="n">fnAnglesSignificant</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;angles_iter001_00.xmd&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesSignificant</span><span class="p">):</span>
                                    <span class="n">moveFile</span><span class="p">(</span><span class="n">fnAnglesSignificant</span><span class="p">,</span> <span class="n">fnAnglesGroup</span><span class="p">)</span>
                                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;images_iter001_00.xmd&quot;</span><span class="p">))</span>
                                    <span class="c1"># cleanPath(join(fnDirSignificant,&quot;angles_iter001_00.xmd&quot;))</span>
                                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirSignificant</span><span class="p">,</span><span class="s2">&quot;images_significant_iter001_00.xmd&quot;</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                                <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">GpuList</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">()])</span>
                                    <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>
                                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -r </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --keepBestN </span><span class="si">%f</span><span class="s1"> --dev </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
                                       <span class="p">(</span><span class="n">fnGroup</span><span class="p">,</span> <span class="n">fnGalleryGroupMd</span><span class="p">,</span> <span class="n">fnAnglesGroup</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfReplicates</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">GpuListCuda</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_cuda_align_significant&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">):</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">):</span>
                                    <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set union_all </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnAnglesGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnImgs</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set join </span><span class="si">%s</span><span class="s2"> image&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnImgs</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveSpace</span> <span class="ow">and</span> <span class="n">ctfPresent</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;rm -f&quot;</span><span class="p">,</span><span class="n">fnDirSignificant</span><span class="o">+</span><span class="s2">&quot;/gallery*&quot;</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Evaluate the stability of the alignment</span>
                <span class="n">fnOut</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">subset1</span> <span class="ow">in</span> <span class="n">perturbationList</span><span class="p">:</span>
                    <span class="n">fnOut1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">subset1</span><span class="p">))</span>
                    <span class="n">fnAngles1</span><span class="o">=</span><span class="n">fnOut1</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span>
                    <span class="n">counter2</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">subset2</span> <span class="ow">in</span> <span class="n">perturbationList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">subset1</span><span class="o">==</span><span class="n">subset2</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">fnAngles2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d%s</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">subset2</span><span class="p">))</span>
                        <span class="n">fnOut12</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d%s%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">subset1</span><span class="p">,</span><span class="n">subset2</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_distance&quot;</span><span class="p">,</span><span class="s2">&quot;--ang1 </span><span class="si">%s</span><span class="s2"> --ang2 </span><span class="si">%s</span><span class="s2"> --oroot </span><span class="si">%s</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --compute_weights 1 particleId 0.5 --check_mirrors --set 0&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles2</span><span class="p">,</span><span class="n">fnAngles1</span><span class="p">,</span><span class="n">fnOut12</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;angleDiff0 shiftDiff0 weightJumper0&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnOut12</span><span class="o">+</span><span class="s2">&quot;_weights.xmd&quot;</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">counter2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mdWeightsAll</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnOut12</span><span class="o">+</span><span class="s2">&quot;_weights.xmd&quot;</span><span class="p">)</span>
                            <span class="n">counter2</span><span class="o">=</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mdWeights</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnOut12</span><span class="o">+</span><span class="s2">&quot;_weights.xmd&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">mdWeights</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
                                <span class="n">counter2</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">mdWeights</span><span class="p">,</span><span class="n">mdWeightsAll</span><span class="p">):</span>
                                    <span class="n">angleDiff0</span> <span class="o">=</span> <span class="n">mdWeights</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="n">id1</span><span class="p">)</span>
                                    <span class="n">shiftDiff0</span> <span class="o">=</span> <span class="n">mdWeights</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF0</span><span class="p">,</span> <span class="n">id1</span><span class="p">)</span>
                                    <span class="n">weightJumper0</span> <span class="o">=</span> <span class="n">mdWeights</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span> <span class="n">id1</span><span class="p">)</span>

                                    <span class="n">angleDiff0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                                    <span class="n">shiftDiff0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF0</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                                    <span class="n">weightJumper0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

                                    <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="n">angleDiff0</span><span class="o">+</span><span class="n">angleDiff0All</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                                    <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF0</span><span class="p">,</span> <span class="n">shiftDiff0</span><span class="o">+</span><span class="n">shiftDiff0All</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                                    <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span> <span class="n">weightJumper0</span><span class="o">+</span><span class="n">weightJumper0All</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">counter2</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">iCounter2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">counter2</span>
                        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">mdWeightsAll</span><span class="p">:</span>
                            <span class="n">angleDiff0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                            <span class="n">shiftDiff0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF0</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                            <span class="n">weightJumper0All</span> <span class="o">=</span> <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

                            <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span> <span class="n">angleDiff0All</span><span class="o">*</span><span class="n">iCounter2</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                            <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_DIFF0</span><span class="p">,</span> <span class="n">shiftDiff0All</span><span class="o">*</span><span class="n">iCounter2</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                            <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span> <span class="n">weightJumper0All</span><span class="o">*</span><span class="n">iCounter2</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">counter2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">mdWeightsAll</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnOut1</span><span class="o">+</span><span class="s2">&quot;_weights.xmd&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set merge </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">,</span><span class="n">fnOut1</span><span class="o">+</span><span class="s2">&quot;_weights.xmd&quot;</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnOut</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">):</span>
                        <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">,</span><span class="n">fnOut</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnOut</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set union_all </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnOut</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span><span class="p">,</span><span class="n">fnAngles1</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc*_weights.xmd&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.adaptShifts"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.adaptShifts">[docs]</a>    <span class="k">def</span> <span class="nf">adaptShifts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnSource</span><span class="p">,</span> <span class="n">TsSource</span><span class="p">,</span> <span class="n">fnDest</span><span class="p">,</span> <span class="n">TsDest</span><span class="p">):</span>
        <span class="n">K</span><span class="o">=</span><span class="n">TsSource</span><span class="o">/</span><span class="n">TsDest</span>
        <span class="n">copyFile</span><span class="p">(</span><span class="n">fnSource</span><span class="p">,</span><span class="n">fnDest</span><span class="p">)</span>
        <span class="n">row</span><span class="o">=</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnDest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;shiftX=</span><span class="si">%f</span><span class="s1">*shiftX&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDest</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;shiftY=</span><span class="si">%f</span><span class="s1">*shiftY&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDest</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CONTINUOUS_X</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;continuousX=</span><span class="si">%f</span><span class="s1">*continuousX&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDest</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate modify_values &quot;continuousY=</span><span class="si">%f</span><span class="s1">*continuousY&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnDest</span><span class="p">,</span><span class="n">K</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.localAssignment"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.localAssignment">[docs]</a>    <span class="k">def</span> <span class="nf">localAssignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
            <span class="n">fnDirLocal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;localAssignment&quot;</span><span class="p">)</span>
            <span class="n">makePath</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">)</span>

            <span class="n">previousResolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">)</span>
            <span class="n">targetResolution</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">previousResolution</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_maximumTargetResolution</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiresolution</span><span class="p">:</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="p">,</span><span class="n">targetResolution</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span> <span class="c1"># Write and read to guarantee consistency with previous directories</span>
            
            <span class="c1"># Prepare images and references</span>
            <span class="n">produceNewReferences</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">fnDirGlobal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;globalAssignment&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">):</span>
                <span class="n">TsGlobal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TsGlobal</span><span class="o">==</span><span class="n">TsCurrent</span><span class="p">:</span>
                    <span class="n">produceNewReferences</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">produceNewReferences</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepareImages</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">fnDirPrevious</span><span class="p">)</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span> <span class="c1"># Prepare images may have changed it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepareReferences</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">targetResolution</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newXdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">,</span><span class="n">newXdim</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">createLink</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">),</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">createLink</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">),</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># Compute maximum angular deviation</span>
            <span class="n">ResolutionAlignment</span><span class="o">=</span><span class="n">previousResolution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextLowPass</span><span class="p">:</span>
                <span class="n">ResolutionAlignment</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">nextResolutionOffset</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">newXdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
            <span class="n">maxAngle</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calculateAngStep</span><span class="p">(</span><span class="n">newXdim</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">ResolutionAlignment</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">&gt;=</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">fnLocalImages</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fnLocalImagesIdx</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">_idx.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>

                <span class="c1"># Starting angles</span>
                <span class="n">fnLocalAssignment</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">):</span>
                    <span class="n">fnGlobalAssignment</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">TsGlobal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">TsGlobal</span><span class="o">==</span><span class="n">TsCurrent</span><span class="p">:</span>
                        <span class="n">copyFile</span><span class="p">(</span><span class="n">fnGlobalAssignment</span><span class="p">,</span><span class="n">fnLocalAssignment</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adaptShifts</span><span class="p">(</span><span class="n">fnGlobalAssignment</span><span class="p">,</span><span class="n">TsGlobal</span><span class="p">,</span><span class="n">fnLocalAssignment</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">TsPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                    <span class="n">fnAux</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;aux.xmd&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set intersection </span><span class="si">%s</span><span class="s2"> particleId particleId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">),</span><span class="n">fnLocalImages</span><span class="p">,</span><span class="n">fnAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adaptShifts</span><span class="p">(</span><span class="n">fnAux</span><span class="p">,</span><span class="n">TsPrevious</span><span class="p">,</span><span class="n">fnLocalAssignment</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAux</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate drop_column image&quot;</span><span class="o">%</span><span class="n">fnLocalAssignment</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;particleId image&quot; -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnLocalImages</span><span class="p">,</span><span class="n">fnLocalImagesIdx</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate remove_duplicates particleId&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnLocalImagesIdx</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set join </span><span class="si">%s</span><span class="s2"> particleId&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnLocalAssignment</span><span class="p">,</span><span class="n">fnLocalImagesIdx</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnLocalImagesIdx</span><span class="p">)</span>

                <span class="n">fnVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fnLocalStk</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;anglesCont</span><span class="si">%02d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>

                <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">R</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">)</span>
                <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sampling </span><span class="si">%f</span><span class="s2"> --Rmax </span><span class="si">%d</span><span class="s2"> --padding </span><span class="si">%d</span><span class="s2"> --ref </span><span class="si">%s</span><span class="s2"> --max_resolution </span><span class="si">%f</span><span class="s2"> --applyTo image1&quot;</span><span class="o">%</span>\
                   <span class="p">(</span><span class="n">fnLocalAssignment</span><span class="p">,</span><span class="n">fnLocalStk</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contPadding</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">fnVol</span><span class="p">,</span><span class="n">previousResolution</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contShift</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --optimizeShift --max_shift </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contMaxShiftVariation</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="n">newXdim</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contScale</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --optimizeScale --max_scale </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">contMaxScale</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contAngles</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --optimizeAngles --max_angular_change </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">maxAngle</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contDefocus</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --optimizeDefocus --max_defocus_change </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">contMaxDefocus</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">():</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --phaseFlipped&quot;</span>
                <span class="c1">#if self.weightResiduals:</span>
                <span class="c1">#    args+=&quot; --oresiduals %s&quot;%join(fnDirLocal,&quot;residuals%02i.stk&quot;%i)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_continuous_assign2&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_mask&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mask circular -</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnLocalStk</span><span class="p">,</span><span class="n">R</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COUNT</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">))</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.noAssignment"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.noAssignment">[docs]</a>    <span class="k">def</span> <span class="nf">noAssignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirPrevious</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">fnDirCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">fnDirLocal</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span> <span class="s2">&quot;noAssignment&quot;</span><span class="p">)</span>
        <span class="n">makePath</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">)</span>

        <span class="n">previousResolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span> <span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">)</span>
        <span class="n">targetResolution</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">previousResolution</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maximumTargetResolution</span><span class="p">[</span><span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiresolution</span><span class="p">:</span>
            <span class="n">TsCurrent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span><span class="p">,</span> <span class="n">targetResolution</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TsCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TsOrig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span> <span class="s2">&quot;sampling&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>
        <span class="n">TsCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span> <span class="s2">&quot;sampling&quot;</span><span class="p">,</span>
                                       <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>  <span class="c1"># Write and read to guarantee consistency with previous directories</span>

        <span class="c1"># Prepare images and references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareImages</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span> <span class="n">fnDirLocal</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">fnLocalImages</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span> <span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">fnAssignment</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span> <span class="s2">&quot;anglesNoAssignment</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">TsPrevious</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span> <span class="s2">&quot;sampling&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adaptShifts</span><span class="p">(</span><span class="n">fnLocalImages</span><span class="p">,</span> <span class="n">TsPrevious</span><span class="p">,</span> <span class="n">fnAssignment</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnAssignment</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">hasLabel</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_MAXCC</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">hasLabel</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_COST</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --fill maxCC constant 1&quot;</span><span class="o">%</span> <span class="n">fnAssignment</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.weightParticles"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.weightParticles">[docs]</a>    <span class="k">def</span> <span class="nf">weightParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">exp</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># Grab file</span>
            <span class="n">fnDirGlobal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;globalAssignment&quot;</span><span class="p">)</span>
            <span class="n">fnDirLocal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;localAssignment&quot;</span><span class="p">)</span>
            <span class="n">fnDirNo</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;noAssignment&quot;</span><span class="p">)</span>

            <span class="n">fnAnglesCont</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;anglesCont</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnAnglesDisc</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnAnglesNo</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirNo</span><span class="p">,</span><span class="s2">&quot;anglesNoAssignment</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>

            <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesCont</span><span class="p">):</span>
                <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAnglesCont</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                <span class="n">Xdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirLocal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesNo</span><span class="p">):</span>
                <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAnglesNo</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                <span class="n">TsCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirNo</span><span class="p">,</span> <span class="s2">&quot;sampling&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                <span class="n">Xdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirNo</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesDisc</span><span class="p">):</span>
                    <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAnglesDisc</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                    <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
                    <span class="n">Xdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirGlobal</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Angles for iteration &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; not found&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">,</span><span class="n">Xdim</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
                <span class="n">row</span><span class="o">=</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_SSNR</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate drop_column weightSSNR&quot;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set join </span><span class="si">%s</span><span class="s2"> particleId&quot;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;ssnrWeights.xmd&quot;</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span><span class="p">:</span>
                <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_FIXED</span><span class="p">:</span>
                    <span class="n">fnPreviousAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fnPreviousAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;aux.xmd&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set intersection </span><span class="si">%s</span><span class="s2"> particleId particleId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">),</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnPreviousAngles</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_distance&quot;</span><span class="p">,</span><span class="s2">&quot;--ang1 </span><span class="si">%s</span><span class="s2"> --ang2 </span><span class="si">%s</span><span class="s2"> --compute_weights --check_mirrors --oroot </span><span class="si">%s</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">fnPreviousAngles</span><span class="p">,</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnDirCurrent</span><span class="o">+</span><span class="s2">&quot;/jumper&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">moveFile</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="o">+</span><span class="s2">&quot;/jumper_weights.xmd&quot;</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_STOCHASTIC</span><span class="p">:</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnPreviousAngles</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_FIXED</span><span class="p">:</span>
                        <span class="n">fnPreviousAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fnPreviousAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;aux.xmd&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set intersection </span><span class="si">%s</span><span class="s2"> particleId particleId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                                    <span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">),</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnPreviousAngles</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_distance&quot;</span><span class="p">,</span><span class="s2">&quot;--ang1 </span><span class="si">%s</span><span class="s2"> --ang2 </span><span class="si">%s</span><span class="s2"> --compute_weights --check_mirrors --oroot </span><span class="si">%s</span><span class="s2"> --set 2 --sym </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">fnPreviousAngles</span><span class="p">,</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnDirCurrent</span><span class="o">+</span><span class="s2">&quot;/jumper&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">moveFile</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="o">+</span><span class="s2">&quot;/jumper_weights.xmd&quot;</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitMethod</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPLIT_STOCHASTIC</span><span class="p">:</span>
                        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnPreviousAngles</span><span class="p">)</span>

            <span class="c1">#if self.weightResiduals and exists(fnAnglesCont):</span>
            <span class="c1">#    fnCovariance=join(fnDirLocal,&quot;covariance%02d.stk&quot;%i)</span>
            <span class="c1">#    self.runJob(&quot;xmipp_image_residuals&quot;,&quot;-i %s -o %s --normalizeDivergence&quot;%(fnAngles,fnCovariance),numberOfMpi=1)</span>
            <span class="c1">#    moveFile(join(fnDirLocal,&quot;covariance%02d.xmd&quot;%i),fnAngles)</span>
            
            <span class="n">mdAngles</span><span class="o">=</span><span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
            <span class="n">weightCCmin</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weightCCmin</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">objId</span> <span class="ow">in</span> <span class="n">mdAngles</span><span class="p">:</span>
                <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightJumper</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfPerturbations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">aux</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER0</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">weight</span><span class="o">*=</span><span class="n">aux</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
                    <span class="n">aux</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_SSNR</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">weight</span><span class="o">*=</span><span class="n">aux</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightContinuous</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesCont</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
                    <span class="n">aux</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_CONTINUOUS2</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">weight</span><span class="o">*=</span><span class="n">aux</span>
                <span class="c1">#if self.weightResiduals and exists(fnAnglesCont):</span>
                <span class="c1">#    aux=mdAngles.getValue(emlib.MDL_ZSCORE_RESCOV,objId)</span>
                <span class="c1">#    aux/=3</span>
                <span class="c1">#    weight*=exp(-0.5*aux*aux)</span>
                <span class="c1">#    aux=mdAngles.getValue(emlib.MDL_ZSCORE_RESMEAN,objId)</span>
                <span class="c1">#    aux/=3</span>
                <span class="c1">#    weight*=exp(-0.5*aux*aux)</span>
                <span class="c1">#    aux=mdAngles.getValue(emlib.MDL_ZSCORE_RESVAR,objId)</span>
                <span class="c1">#    aux/=3</span>
                <span class="c1">#    weight*=exp(-0.5*aux*aux)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightJumper</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">w1</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">w2</span><span class="o">=</span><span class="mf">1.0</span>
                    <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">w2</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT_JUMPER2</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">weight</span><span class="o">*=</span><span class="n">w1</span><span class="o">*</span><span class="n">w2</span>

                <span class="n">mdAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">weight</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
            <span class="n">mdAngles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>

        <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
        <span class="n">fnAngles1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles01.xmd&quot;</span><span class="p">)</span>
        <span class="n">fnAngles2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles02.xmd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set union </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">,</span><span class="n">fnAngles2</span><span class="p">,</span><span class="n">fnAngles</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.qualifyParticles"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.qualifyParticles">[docs]</a>    <span class="k">def</span> <span class="nf">qualifyParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
        <span class="n">fnAnglesQualified</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles_qualified.xmd&quot;</span><span class="p">)</span>

        <span class="c1"># Qualify according to CC and COST by defocus groups</span>
        <span class="n">row</span><span class="o">=</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_MODEL</span><span class="p">)</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_DEFOCUSU</span><span class="p">):</span>
            <span class="n">previousResolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">)</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
            <span class="n">numberGroups</span><span class="o">=</span><span class="mi">50</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_ctf_group&quot;</span><span class="p">,</span><span class="s2">&quot;--ctfdat </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">/ctf:stk --simple </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span>\
                        <span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="n">numberGroups</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_images.sel&quot;</span><span class="o">%</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_groups.xmd&quot;</span><span class="o">%</span><span class="n">fnDirCurrent</span><span class="p">)</span>
            <span class="n">ctfPresent</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numberGroups</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">ctfPresent</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">numberGroups</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fnAnglesGroup</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles_group</span><span class="si">%03d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ctfPresent</span><span class="p">:</span>
                <span class="n">fnGroup</span><span class="o">=</span><span class="s2">&quot;ctfGroup</span><span class="si">%06d</span><span class="s2">@</span><span class="si">%s</span><span class="s2">/ctf_groups.xmd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">fnDirCurrent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fnGroup</span><span class="o">=</span><span class="n">fnAngles</span>
            <span class="k">if</span> <span class="n">getSize</span><span class="p">(</span><span class="n">fnGroup</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_MAXCC</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate percentile maxCC maxCCPerc -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnGroup</span><span class="p">,</span><span class="n">fnAnglesGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">fnGroup</span><span class="o">=</span><span class="n">fnAnglesGroup</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate percentile cost costPerc -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnGroup</span><span class="p">,</span><span class="n">fnAnglesGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>          
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAnglesQualified</span><span class="p">):</span>
                    <span class="n">copyFile</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">,</span> <span class="n">fnAnglesQualified</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set union </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAnglesQualified</span><span class="p">,</span><span class="n">fnAnglesGroup</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAnglesGroup</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctfPresent</span><span class="p">:</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ctf_groups.xmd&quot;</span><span class="o">%</span><span class="n">fnDirCurrent</span><span class="p">)</span>
        <span class="n">moveFile</span><span class="p">(</span><span class="n">fnAnglesQualified</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightCC</span><span class="p">:</span>
            <span class="n">mdAngles</span><span class="o">=</span><span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
            <span class="n">weightCCmin</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weightCCmin</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">hasCost</span> <span class="o">=</span> <span class="n">mdAngles</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_COST_PERCENTILE</span><span class="p">)</span>
            <span class="n">hasCC</span> <span class="o">=</span> <span class="n">mdAngles</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_MAXCC_PERCENTILE</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">objId</span> <span class="ow">in</span> <span class="n">mdAngles</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">NO_ALIGNMENT</span> <span class="ow">and</span> <span class="n">hasCost</span><span class="p">):</span>
                    <span class="n">w</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_COST_PERCENTILE</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">hasCC</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_MAXCC_PERCENTILE</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">weight</span><span class="o">*=</span><span class="n">weightCCmin</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weightCCmin</span><span class="p">)</span>
                <span class="n">mdAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">weight</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
            <span class="n">mdAngles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>

        <span class="c1"># Qualify according to angular temperature</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --fill angleTemp constant 0&quot;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnAngles_1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnTemp</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;previousAngleTemp.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;particleId angleTemp&quot; -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles_1</span><span class="p">,</span><span class="n">fnTemp</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate remove_duplicates particleId&#39;</span><span class="o">%</span><span class="n">fnTemp</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set join </span><span class="si">%s</span><span class="s1"> particleId&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnTemp</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnTemp</span><span class="p">)</span>
            
        <span class="n">hasDiff0</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">)</span>
        <span class="n">hasDiff1</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF</span><span class="p">)</span>
        <span class="n">hasDiff2</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hasDiff0</span> <span class="ow">or</span> <span class="n">hasDiff1</span> <span class="ow">or</span> <span class="n">hasDiff2</span><span class="p">:</span>
            <span class="n">mdAngles</span><span class="o">=</span><span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
            <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span>
            <span class="n">iNorm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">hasDiff0</span> <span class="o">+</span> <span class="n">hasDiff1</span> <span class="o">+</span> <span class="n">hasDiff2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">objId</span> <span class="ow">in</span> <span class="n">mdAngles</span><span class="p">:</span>
                <span class="n">perturbation</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">if</span> <span class="n">hasDiff0</span><span class="p">:</span>
                    <span class="n">perturbation</span><span class="o">+=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF0</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hasDiff1</span><span class="p">:</span>
                    <span class="n">perturbation</span><span class="o">+=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hasDiff2</span><span class="p">:</span>
                    <span class="n">perturbation</span><span class="o">+=</span><span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_DIFF2</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">perturbation</span><span class="o">*=</span><span class="n">iNorm</span>

                <span class="n">previousTemp</span> <span class="o">=</span> <span class="n">mdAngles</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TEMPERATURE</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">currentTemp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">K</span><span class="p">)</span><span class="o">*</span><span class="n">previousTemp</span> <span class="o">+</span> <span class="n">K</span><span class="o">*</span><span class="n">perturbation</span>
                <span class="n">mdAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ANGLE_TEMPERATURE</span><span class="p">,</span><span class="n">currentTemp</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
            <span class="n">mdAngles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.reconstruct"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.reconstruct">[docs]</a>    <span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>

        <span class="c1"># Delete previous image files, they exist in case that the last iteration</span>
        <span class="c1"># was performed as a single iteration</span>
        <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">fnCorrectedImages1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;images_corrected01.stk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnCorrectedImages1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveSpace</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnCorrectedImages1</span><span class="p">)</span>
        <span class="n">fnCorrectedImages2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;images_corrected02.stk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnCorrectedImages2</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveSpace</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnCorrectedImages2</span><span class="p">)</span>

        <span class="n">grayAdjusted</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnVol</span><span class="p">):</span>
                <span class="c1"># Correct for the CTF</span>
                <span class="n">fnAnglesToUse</span> <span class="o">=</span> <span class="n">fnAngles</span>
                <span class="n">row</span><span class="o">=</span><span class="n">getFirstRow</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
                <span class="n">hasCTF</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_DEFOCUSU</span><span class="p">)</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">containsLabel</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_CTF_MODEL</span><span class="p">)</span>
                <span class="n">fnCorrectedImagesRoot</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;images_corrected</span><span class="si">%02d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">deleteStack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">hasCTF</span><span class="p">:</span>
                    <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">.stk --save_metadata_stack </span><span class="si">%s</span><span class="s2">.xmd --keep_input_columns&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnCorrectedImagesRoot</span><span class="p">,</span><span class="n">fnCorrectedImagesRoot</span><span class="p">)</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --sampling_rate </span><span class="si">%f</span><span class="s2"> --correct_envelope&quot;</span><span class="o">%</span><span class="n">TsCurrent</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">():</span>
                        <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --phase_flipped&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_ctf_correct_wiener2d&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">24</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_eliminate_byEnergy&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2">.xmd --sigma2 9 --minSigma2 0.01&quot;</span><span class="o">%</span>\
                                <span class="n">fnCorrectedImagesRoot</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">12</span><span class="p">))</span>
                    <span class="n">fnAnglesToUse</span> <span class="o">=</span> <span class="n">fnCorrectedImagesRoot</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span>
                    <span class="n">deleteStack</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">deletePattern</span> <span class="o">=</span> <span class="n">fnCorrectedImagesRoot</span><span class="o">+</span><span class="s2">&quot;.*&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set intersection </span><span class="si">%s</span><span class="s1"> particleId particleId&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnAnglesToUse</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                        <span class="c1"># This is because eliminate_byEnergy may have reduced the number of images in fnAngles</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contGrayValues</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATIC_ALIGNMENT</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">grayAdjusted</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">fnGrayRoot</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;images_gray</span><span class="si">%02d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">fnRefVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;localAssignment&quot;</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">fnDirPrevious</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">previousResolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_RESOLUTION_FREQREAL</span><span class="p">)</span>
                    <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">.stk --sampling </span><span class="si">%f</span><span class="s2"> --Rmax </span><span class="si">%d</span><span class="s2"> --padding </span><span class="si">%d</span><span class="s2"> --ref </span><span class="si">%s</span><span class="s2"> --max_resolution </span><span class="si">%f</span><span class="s2"> --save_metadata_stack </span><span class="si">%s</span><span class="s2">.xmd&quot;</span><span class="o">%</span>\
                         <span class="p">(</span><span class="n">fnAnglesToUse</span><span class="p">,</span><span class="n">fnGrayRoot</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contPadding</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">fnRefVol</span><span class="p">,</span><span class="n">previousResolution</span><span class="p">,</span><span class="n">fnGrayRoot</span><span class="p">)</span>
                    <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --max_gray_scale </span><span class="si">%f</span><span class="s2"> --max_gray_shift </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span>\
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contMaxGrayScale</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">contMaxGrayShift</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_adjust_image_grey_levels&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                    <span class="n">fnAnglesToUse</span> <span class="o">=</span> <span class="n">fnGrayRoot</span><span class="o">+</span><span class="s2">&quot;.xmd&quot;</span>
                    <span class="k">if</span> <span class="n">deleteStack</span><span class="p">:</span>
                        <span class="n">cleanPattern</span><span class="p">(</span><span class="n">deletePattern</span><span class="p">)</span>
                    <span class="n">deleteStack</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">deletePattern</span> <span class="o">=</span> <span class="n">fnGrayRoot</span><span class="o">+</span><span class="s2">&quot;.*&quot;</span>

                    <span class="c1"># Save the gray transformation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate drop_column &quot;continuousA continuousB&quot;&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">fnAux</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;gray_transformation</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;continuousA continuousB&quot; -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAnglesToUse</span><span class="p">,</span><span class="n">fnAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set merge </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAux</span><span class="p">)</span>

                <span class="c1"># Restrict the angles</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrictReconstructionAngles</span><span class="p">:</span>
                    <span class="n">fnRestricted</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;images_restricted</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --query select &quot;angleRot &gt; </span><span class="si">%f</span><span class="s1"> AND anglePsi &lt; </span><span class="si">%f</span><span class="s1">&quot; -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                           <span class="p">(</span><span class="n">fnAnglesToUse</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMinTiltReconstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxTiltReconstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">fnRestricted</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">fnAnglesToUse</span> <span class="o">=</span> <span class="n">fnRestricted</span>

                <span class="c1"># Reconstruct Fourier</span>
                <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --weight&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAnglesToUse</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="c1">#AJ to make it work with and without queue system</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">N_GPUs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -gpusPerNode </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">N_GPUs</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -threadsPerGPU </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">GpuListCuda</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --thr </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_reconstruct_fourier_accel&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

                <span class="c1"># If stochastic gradient descent</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">STOCHASTIC_ALIGNMENT</span><span class="p">:</span>
                    <span class="n">newXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
                    <span class="n">fnAuxVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">_aux.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">fnPreviousVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirPrevious</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnPreviousVol</span><span class="p">,</span><span class="n">fnAuxVol</span><span class="p">,</span><span class="n">newXdim</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaSGD</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAuxVol</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaSGD</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnAuxVol</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAuxVol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deleteStack</span><span class="p">:</span>
                    <span class="n">cleanPattern</span><span class="p">(</span><span class="n">deletePattern</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">grayAdjusted</span><span class="p">:</span>
            <span class="n">fnAngles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnAnglesAux</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;anglesAux.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnAnglesAuxId</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;anglesAuxId.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnAngles1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles01.xmd&quot;</span><span class="p">)</span>
            <span class="n">fnAngles2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;angles02.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate drop_column &quot;continuousA continuousB&quot;&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set union </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles1</span><span class="p">,</span><span class="n">fnAngles2</span><span class="p">,</span><span class="n">fnAnglesAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate keep_column itemId -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                                                   <span class="p">(</span><span class="n">fnAnglesAux</span><span class="p">,</span><span class="n">fnAnglesAuxId</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_metadata_utilities&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --set intersection </span><span class="si">%s</span><span class="s2"> itemId itemId&quot;</span><span class="o">%</span>\
                                                   <span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnAnglesAuxId</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate sort itemId&#39;</span><span class="o">%</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate sort itemId&#39;</span><span class="o">%</span><span class="n">fnAnglesAux</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --operate keep_column &quot;continuousA continuousB&quot;&#39;</span><span class="o">%</span><span class="n">fnAnglesAux</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --set merge </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">,</span><span class="n">fnAnglesAux</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAnglesAux</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAnglesAuxId</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.postProcessing"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.postProcessing">[docs]</a>    <span class="k">def</span> <span class="nf">postProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">TsCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">fnVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnBeforeVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeBeforePostProcessing</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">volXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMask</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postMaskSymmetry</span><span class="o">!=</span><span class="s2">&quot;c1&quot;</span><span class="p">:</span>
                    <span class="n">fnMask</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepareMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMaskMask</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">fnMask</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="n">volXdim</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_symmetrize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --mask_in </span><span class="si">%s</span><span class="s2"> --dont_wrap&quot;</span><span class="o">%</span>\
                                <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMaskType</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnMask</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelical</span><span class="p">:</span>
                <span class="n">z0</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalMinZ</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">zF</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalMaxZ</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">zStep</span><span class="o">=</span><span class="p">(</span><span class="n">zF</span><span class="o">-</span><span class="n">z0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
                <span class="n">rot0</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalMinRot</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">rotF</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalMaxRot</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">rotStep</span><span class="o">=</span><span class="p">(</span><span class="n">rotF</span><span class="o">-</span><span class="n">rot0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
                <span class="n">fnCoarse</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;coarseHelical</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fnFine</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;fineHelical</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">radius</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">)</span>
                <span class="n">height</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">volXdim</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runCoarseSearch</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalDihedral</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">zF</span><span class="p">,</span> <span class="n">zStep</span><span class="p">,</span> <span class="n">rot0</span><span class="p">,</span> <span class="n">rotF</span><span class="p">,</span> <span class="n">rotStep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fnCoarse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runFineSearch</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalDihedral</span><span class="p">,</span> <span class="n">fnCoarse</span><span class="p">,</span> <span class="n">fnFine</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">zF</span><span class="p">,</span> <span class="n">rot0</span><span class="p">,</span> <span class="n">rotF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>
                <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnCoarse</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runSymmetrize</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelicalDihedral</span><span class="p">,</span> <span class="n">fnFine</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postScript</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">ImageHandler</span><span class="p">()</span>
                <span class="n">volXdim</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">fnVol</span><span class="p">))</span>
                <span class="n">scriptArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">fnVol</span><span class="p">,</span>
                              <span class="s1">&#39;sampling&#39;</span><span class="p">:</span> <span class="n">TsCurrent</span><span class="p">,</span>
                              <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">volXdim</span><span class="p">,</span>
                              <span class="s1">&#39;iterDir&#39;</span><span class="p">:</span> <span class="n">fnDirCurrent</span><span class="p">}</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postScript</span> <span class="o">%</span> <span class="n">scriptArgs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Align volumes</span>
        <span class="n">fnVol1</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fnVol2</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fnVolAvg</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeAvg.mrc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --plus </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnVolAvg</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --mult 0.5&#39;</span><span class="o">%</span><span class="n">fnVolAvg</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_align&#39;</span><span class="p">,</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --local --apply&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolAvg</span><span class="p">,</span><span class="n">fnVol1</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_align&#39;</span><span class="p">,</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --local --apply&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolAvg</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Generate mask if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postAdHocMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnMask</span><span class="p">):</span>
                <span class="n">volXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepareMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postAdHocMask</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">fnMask</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">volXdim</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_threshold&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --select below 0.5 --substitute binarize&quot;</span><span class="o">%</span><span class="n">fnMask</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># Remove untrusted background voxels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSignificantDenoise</span><span class="p">:</span>
            <span class="n">fnRootRestored</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --denoising 1&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">)</span>

        <span class="c1"># Filter bank denoising</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postFilterBank</span><span class="p">:</span>
            <span class="n">fnRootRestored</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --filterBank 0.01&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_filterBank.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>

        <span class="c1"># Laplacian Denoising</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postLaplacian</span><span class="p">:</span>
            <span class="n">fnRootRestored</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --retinex 0.95 &quot;</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">+=</span><span class="n">fnMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_filter&#39;</span><span class="p">,</span><span class="n">args</span><span class="o">%</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_filter&#39;</span><span class="p">,</span><span class="n">args</span><span class="o">%</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Blind deconvolution</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postDeconvolve</span><span class="p">:</span>
            <span class="n">fnRootRestored</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --deconvolution 1&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol1</span><span class="p">)</span>
            <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2">_convolved.vol -o </span><span class="si">%s</span><span class="s2"> -t vol&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVolAvg</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_convolved.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_deconvolved.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>

        <span class="n">fnForFSC</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeFSC</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
        <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnForFSC</span><span class="p">)</span> <span class="c1"># From this point, the two half volumes may be modified</span>

        <span class="c1"># Attenuate undershooting</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSoftNeg</span><span class="p">:</span>
            <span class="n">removeMask</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">fnMask</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_mask&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mask circular </span><span class="si">%d</span><span class="s2"> --create_mask </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="o">-</span><span class="n">volXdim</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">removeMask</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">fnFsc</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;fscSoft.xmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_resolution_fsc&#39;</span><span class="p">,</span><span class="s1">&#39;--ref </span><span class="si">%s</span><span class="s1"> -i </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --sampling_rate </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnFsc</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_filter&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --softnegative </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnMask</span><span class="p">,</span><span class="n">fnFsc</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">postSoftNegK</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_filter&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --softnegative </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnMask</span><span class="p">,</span><span class="n">fnFsc</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">postSoftNegK</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnFsc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removeMask</span><span class="p">:</span>
                <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnMask</span><span class="p">)</span>
                <span class="n">fnMask</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># Difference evaluation and production of a consensus average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postDifference</span><span class="p">:</span>
            <span class="n">fnRootRestored</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --difference 2 2&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2">_avgDiff.vol -o </span><span class="si">%s</span><span class="s2"> -t vol&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVolAvg</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_avgDiff.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>

        <span class="c1"># Recalculate the average after alignment and denoising</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnVolAvg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --plus </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol1</span><span class="p">,</span><span class="n">fnVol2</span><span class="p">,</span><span class="n">fnVolAvg</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_operate&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --mult 0.5&#39;</span><span class="o">%</span><span class="n">fnVolAvg</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#         if fnMask!=&quot;&quot;:</span>
<span class="c1">#             self.runJob(&quot;xmipp_image_operate&quot;,&quot;-i %s --mult %s&quot;%(fnVolAvg,fnMask),numberOfMpi=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_header&#39;</span><span class="p">,</span><span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --sampling_rate </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolAvg</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructHighRes.cleanDirectory"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_highres.html#xmipp3.protocols.protocol_reconstruct_highres.XmippProtReconstructHighRes.cleanDirectory">[docs]</a>    <span class="k">def</span> <span class="nf">cleanDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDirCurrent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;Iter</span><span class="si">%03d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveSpace</span><span class="p">:</span>
            <span class="n">fnGlobal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;globalAssignment&quot;</span><span class="p">)</span>
            <span class="n">fnLocal</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;localAssignment&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">):</span>
                <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;images.stk&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">):</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnGlobal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">):</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">,</span><span class="s2">&quot;images</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">,</span><span class="s2">&quot;images.stk&quot;</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">,</span><span class="s2">&quot;anglesCont</span><span class="si">%02d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">,</span><span class="s2">&quot;anglesDisc</span><span class="si">%02d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnLocal</span><span class="p">,</span><span class="s2">&quot;volumeRef</span><span class="si">%02d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                <span class="n">fnCorrectedImages</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDirCurrent</span><span class="p">,</span><span class="s2">&quot;images_corrected</span><span class="si">%02d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnCorrectedImages</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iteration</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">firstIteration</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnCorrectedImages</span><span class="p">)</span> <span class="c1"># Delete corrected images except for the last iteration</span></div>
                    <span class="c1">#if self.weightResiduals:</span>
                    <span class="c1">#    cleanPath(join(fnLocal,&quot;covariance%02d.stk&quot;%i))</span>
                    <span class="c1">#    cleanPath(join(fnLocal,&quot;residuals%02i.stk&quot;%i))</span>

    <span class="c1">#--------------------------- INFO functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">SetOfVolumes</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The set of input volumes should have exactly 2 volumes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMaskMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Symmetrize within mask requires a mask&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;You must provide input particles&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">hasValue</span><span class="p">()</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hasAlignmentProj</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;If the first iteration is local, then the input particles must have an alignment&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isXmippCudaPresent</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;You have asked to use GPU, but I cannot find the Xmipp GPU programs in the path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>
    
    <span class="k">def</span> <span class="nf">_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">warnings</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Symmetry: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Number of iterations: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Global alignment, max shift=</span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxShift</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auxStr</span><span class="o">=</span><span class="s2">&quot;Local alignment, refining: &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contShift</span><span class="p">:</span>
                <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;shifts &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contScale</span><span class="p">:</span>
                <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;scale &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contAngles</span><span class="p">:</span>
                <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;angles &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contGrayValues</span><span class="p">:</span>
                <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;gray &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contDefocus</span><span class="p">:</span>
                <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;defocus&quot;</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxStr</span><span class="p">)</span>
        <span class="n">auxStr</span><span class="o">=</span><span class="s2">&quot;Weights: &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
            <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;SSNR &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightContinuous</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
            <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;Continuous &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightJumper</span><span class="p">:</span>
            <span class="n">auxStr</span><span class="o">+=</span><span class="s2">&quot;Jumper&quot;</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxStr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMask</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Symmetrizing within mask: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">postMaskSymmetry</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelical</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Looking for helical symmetry&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">strline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputVolume&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">strline</span> <span class="o">+=</span> <span class="s1">&#39;We processed </span><span class="si">%d</span><span class="s1"> particles from </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">(),</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">strline</span> <span class="o">+=</span> <span class="s1">&#39;using </span><span class="si">%s</span><span class="s1"> as reference and Xmipp highres procedure. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputVolumes&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">!=</span><span class="s2">&quot;c1&quot;</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;We imposed </span><span class="si">%s</span><span class="s2"> symmetry. &quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span>
            <span class="n">strline</span> <span class="o">+=</span> <span class="s2">&quot;We performed </span><span class="si">%d</span><span class="s2"> iterations of &quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">GLOBAL_ALIGNMENT</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot; global alignment (max. shift=</span><span class="si">%f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMaxShift</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot; local alignment, refining &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contShift</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;shifts &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contScale</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;scale &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contAngles</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;angles &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contGrayValues</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;gray &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contDefocus</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;defocus&quot;</span>
            <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;. &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weightContinuous</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightJumper</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;For reconstruction, we weighted the images according to &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightSSNR</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;their SSNR &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightContinuous</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignmentMethod</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_ALIGNMENT</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;, their correlation in the continuous alignment &quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightJumper</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;, and their angular stability&quot;</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;. &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postAdHocMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;We masked the reconstruction with </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;postAdHocMask&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMask</span><span class="p">:</span>
                    <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;We imposed </span><span class="si">%s</span><span class="s2"> symmetry within the mask </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryWithinMaskType</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;postSymmetryWithinMaskMask&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSymmetryHelical</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;Finally, we imposed helical symmetry. &quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">strline</span><span class="p">]</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../dm_facilitiesUpdate/index.html">dm_facilitiesUpdate</a></dd>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/_modules/xmipp3/protocols/protocol_reconstruct_highres.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>