

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xmipp3.protocols.protocol_reconstruct_swarm &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../xmipp3.html">xmipp3</a> &raquo;</li>
        
      <li>xmipp3.protocols.protocol_reconstruct_swarm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xmipp3.protocols.protocol_reconstruct_swarm</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Carlos Oscar Sorzano (coss@cnb.csic.es)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">xmipp3.constants</span> <span class="kn">import</span> <span class="n">CUDA_ALIGN_SIGNIFICANT</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">izip</span> <span class="o">=</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">pyworkflow</span> <span class="kn">import</span> <span class="n">VERSION_2_0</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="kn">import</span> <span class="n">LEVEL_ADVANCED</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.params</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span>
                                        <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span> <span class="n">NumericListParam</span><span class="p">,</span>
                                        <span class="n">USE_GPU</span><span class="p">,</span> <span class="n">GPU_LIST</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.path</span> <span class="kn">import</span> <span class="n">cleanPath</span><span class="p">,</span> <span class="n">copyFile</span><span class="p">,</span> <span class="n">moveFile</span><span class="p">,</span> <span class="n">makePath</span><span class="p">,</span> <span class="n">createLink</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="kn">import</span> <span class="n">ProtRefine3D</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="kn">import</span> <span class="n">Volume</span><span class="p">,</span> <span class="n">SetOfVolumes</span>
<span class="kn">from</span> <span class="nn">pwem.emlib.image</span> <span class="kn">import</span> <span class="n">ImageHandler</span>


<span class="kn">from</span> <span class="nn">pwem</span> <span class="kn">import</span> <span class="n">emlib</span>
<span class="kn">from</span> <span class="nn">xmipp3.base</span> <span class="kn">import</span> <span class="n">isXmippCudaPresent</span>
<span class="kn">from</span> <span class="nn">xmipp3.convert</span> <span class="kn">import</span> <span class="p">(</span><span class="n">writeSetOfParticles</span><span class="p">,</span> <span class="n">getImageLocation</span><span class="p">)</span>


<div class="viewcode-block" id="XmippProtReconstructSwarm"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm">[docs]</a><span class="k">class</span> <span class="nc">XmippProtReconstructSwarm</span><span class="p">(</span><span class="n">ProtRefine3D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a 3D refinement protocol whose main input is a set of volumes and a set of particles.</span>
<span class="sd">       The set of particles has to be at full size (the finer sampling rate available), but</span>
<span class="sd">       the rest of inputs (reference volume and masks) can be at any downsampling factor.</span>
<span class="sd">       The protocol scales the input images and volumes to a size that depends on the target resolution.</span>

<span class="sd">       The input set of volumes is considered to be a swarm of volumes and they try to optimize</span>
<span class="sd">       the correlation between the volumes and the set of particles. This is an stochastic maximization</span>
<span class="sd">       and only a fraction of the particles are used to update the volumes and evaluate them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;swarm consensus&#39;</span>
    <span class="n">_version</span> <span class="o">=</span> <span class="n">VERSION_2_0</span>

    <span class="c1"># --------------------------- DEFINE param functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">USE_GPU</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Use GPU for execution&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This protocol has both CPU and GPU implementation.</span><span class="se">\</span>
<span class="s2">                       Select the one you want to use.&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addHidden</span><span class="p">(</span><span class="n">GPU_LIST</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                       <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Choose GPU IDs&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add a list of GPU devices that can be used&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Full-size Images&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a set of images at full resolution&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputVolumes&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Initial volumes&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfVolumes&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a set of volumes with 2 volumes or a single volume&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;particleRadius&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Radius of particle (px)&#39;</span><span class="p">,</span>
                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This is the radius (in pixels) of the spherical mask covering the particle in the input images&#39;</span><span class="p">)</span>       

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;symmetryGroup&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Symmetry group&#39;</span><span class="p">,</span> 
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;See http://xmipp.cnb.uam.es/twiki/bin/view/Xmipp/Symmetry for a description of the symmetry groups format&#39;</span>
                        <span class="s1">&#39;If no symmetry is present, give c1&#39;</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nextMask&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;VolumeMask&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The mask values must be between 0 (remove these pixels) and 1 (let them pass). Smooth masks are recommended.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfIterations&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of iterations&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;targetResolution&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Max. Target Resolution&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In Angstroms.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;minAngle&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Min. Angle&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The angular search is limited by this parametr (in degrees).&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;NimgTrain&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;# Images to update&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;NimgTest&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;# Images to evaluate&#39;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        
        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="c1">#--------------------------- INSERT steps functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;images.xmd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;evaluateIndividuals&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;reconstructNewVolumes&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;postProcessing&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;evaluateIndividuals&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;updateVolumes&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;calculateAverage&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;cleanVolume&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeAvg.vol&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;createOutput&quot;</span><span class="p">)</span>
    
    <span class="c1">#--------------------------- STEPS functions ---------------------------------------------------</span>
<div class="viewcode-block" id="XmippProtReconstructSwarm.readInfoField"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.readInfoField">[docs]</a>    <span class="k">def</span> <span class="nf">readInfoField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
        <span class="n">mdInfo</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;info.xmd&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">mdInfo</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">firstObject</span><span class="p">())</span></div>

<div class="viewcode-block" id="XmippProtReconstructSwarm.writeInfoField"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.writeInfoField">[docs]</a>    <span class="k">def</span> <span class="nf">writeInfoField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnDir</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">mdInfo</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
        <span class="n">objId</span><span class="o">=</span><span class="n">mdInfo</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
        <span class="n">mdInfo</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
        <span class="n">mdInfo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;info.xmd&quot;</span><span class="p">)),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructSwarm.convertInputVolume"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.convertInputVolume">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputVolume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgHandler</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">fnIn</span><span class="p">,</span> <span class="n">fnOut</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">newXdim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_image_resize&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --factor </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnIn</span><span class="p">,</span><span class="n">fnOut</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">objXdim</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span><span class="n">imgHandler</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">fnOut</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newXdim</span><span class="o">!=</span><span class="n">objXdim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_transform_window&#39;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --size </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnOut</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructSwarm.convertInputStep"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.convertInputStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputParticlesId</span><span class="p">):</span>
        <span class="n">fnDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">()</span>
        <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">)</span>

        <span class="c1"># Choose the target sampling rate        </span>
        <span class="n">TsOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">TsCurrent</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">TsOrig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetResolution</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Xdim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newXdim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">Xdim</span><span class="o">*</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newXdim</span><span class="o">&lt;</span><span class="mi">40</span><span class="p">:</span>
            <span class="n">newXdim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">TsCurrent</span><span class="o">=</span><span class="n">Xdim</span><span class="o">*</span><span class="p">(</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">newXdim</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing images to sampling rate=&quot;</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">,</span><span class="n">newXdim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">)</span>
        
        <span class="c1"># Prepare particles</span>
        <span class="n">fnNewParticles</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.stk&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newXdim</span><span class="o">!=</span><span class="n">Xdim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --fourier </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">newXdim</span><span class="p">),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --save_metadata_stack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgsFn</span><span class="p">,</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">R</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span><span class="o">*</span><span class="mf">1.1</span><span class="p">),</span><span class="n">newXdim</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_mask&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mask circular -</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnNewParticles</span><span class="p">,</span><span class="n">R</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        
        <span class="c1"># Prepare mask</span>
        <span class="n">imgHandler</span><span class="o">=</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convertInputVolume</span><span class="p">(</span><span class="n">imgHandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">getImageLocation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">),</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">newXdim</span><span class="p">)</span>
        
        <span class="c1"># Prepare references</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">fnVol</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convertInputVolume</span><span class="p">(</span><span class="n">imgHandler</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">getImageLocation</span><span class="p">(</span><span class="n">vol</span><span class="p">),</span> <span class="n">fnVol</span><span class="p">,</span> <span class="n">TsCurrent</span><span class="p">,</span> <span class="n">newXdim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult 0 -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_speed.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;best@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">))</span> <span class="c1"># Empty write to guarantee this block is the first one</span>
        <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;bestByVolume@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span> <span class="c1"># Empty write to guarantee this block is the second one</span></div>
    
<div class="viewcode-block" id="XmippProtReconstructSwarm.evaluateIndividuals"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.evaluateIndividuals">[docs]</a>    <span class="k">def</span> <span class="nf">evaluateIndividuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">()</span>
        <span class="n">newXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
        <span class="n">angleStep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">newXdim</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">minAngle</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">TsOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">TsCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
        <span class="n">fnMask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
        <span class="n">fnImages</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;images.xmd&quot;</span><span class="p">)</span>

        <span class="n">maxShift</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">newXdim</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">R</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">TsOrig</span> <span class="o">/</span> <span class="n">TsCurrent</span>

        <span class="n">bestWeightVol</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">bestIterVol</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">mdPrevious</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="s2">&quot;bestByVolume@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">objId</span> <span class="ow">in</span> <span class="n">mdPrevious</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mdPrevious</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IDX</span><span class="p">,</span><span class="n">objId</span><span class="p">))</span>
                <span class="n">bestWeightVol</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">mdPrevious</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">bestIterVol</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">mdPrevious</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ITER</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>

        <span class="c1"># Global alignment</span>
        <span class="n">md</span><span class="o">=</span><span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">mdBest</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="s2">&quot;best@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">))</span>
            <span class="n">objId</span> <span class="o">=</span> <span class="n">mdBest</span><span class="o">.</span><span class="n">firstObject</span><span class="p">()</span>
            <span class="n">bestWeight</span> <span class="o">=</span> <span class="n">mdBest</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bestWeight</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e38</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="c1"># Filter and mask volumes</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_filter&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --fourier low_pass </span><span class="si">%f</span><span class="s2"> --sampling </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetResolution</span><span class="p">,</span><span class="n">TsCurrent</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnMask</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnMask</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Prepare subset of experimental images</span>
            <span class="n">fnTest</span> <span class="o">=</span>  <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;imgs_</span><span class="si">%03d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate random_subset </span><span class="si">%d</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnImages</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NimgTest</span><span class="p">,</span><span class="n">fnTest</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Generate projections</span>
            <span class="n">fnGallery</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnGalleryMd</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d</span><span class="s2">.doc&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
<span class="c1">#             args=&quot;-i %s -o %s --sampling_rate %f --perturb %f --sym %s&quot;%\</span>
<span class="c1">#                  (fnVol,fnGallery,angleStep,math.sin(angleStep*math.pi/180.0)/4,self.symmetryGroup)</span>
            <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                 <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnGallery</span><span class="p">,</span><span class="n">angleStep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">)</span>
            <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --compute_neighbors --angular_distance -1 --experimental_images </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnTest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_project_library&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            
            <span class="c1"># Assign angles</span>
            <span class="n">fnAngles</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;angles_iter001_00.xmd&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --initgallery </span><span class="si">%s</span><span class="s1"> --maxShift </span><span class="si">%d</span><span class="s1"> --odir </span><span class="si">%s</span><span class="s1"> --dontReconstruct --useForValidation 1&#39;</span> <span class="o">%</span> \
                       <span class="p">(</span><span class="n">fnTest</span><span class="p">,</span> <span class="n">fnGalleryMd</span><span class="p">,</span> <span class="n">maxShift</span><span class="p">,</span> <span class="n">fnDir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_reconstruct_significant&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                            <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">()])</span>
                    <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>

                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -r </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --keepBestN 1 --dev </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">fnTest</span><span class="p">,</span> <span class="n">fnGalleryMd</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">,</span> <span class="n">GpuListCuda</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">CUDA_ALIGN_SIGNIFICANT</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Evaluate</span>
            <span class="n">fnAngles</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;angles_iter001_00.xmd&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">):</span>
                <span class="c1"># Significant may decide not to write it if it is not significant</span>
                <span class="n">mdAngles</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">)</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">mdAngles</span><span class="o">.</span><span class="n">getColumnValues</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_MAXCC</span><span class="p">)</span>
                <span class="n">avgWeight</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average weight for &quot;</span><span class="o">+</span><span class="n">fnVol</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">avgWeight</span><span class="p">))</span>
                <span class="n">objId</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IDX</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">avgWeight</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ITER</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                
                <span class="c1"># Is global best</span>
                <span class="k">if</span> <span class="n">avgWeight</span><span class="o">&gt;</span><span class="n">bestWeight</span><span class="p">:</span>
                    <span class="n">bestWeight</span> <span class="o">=</span> <span class="n">avgWeight</span>
                    <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># None of the input volumes can be the best volume in the first iteration since their gray values may significantly</span>
                        <span class="c1"># differ from those in the projections</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult 0 -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeBest.vol&quot;</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeBest.vol&quot;</span><span class="p">))</span>
                    <span class="n">mdBest</span><span class="o">=</span><span class="n">emlib</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
                    <span class="n">objId</span><span class="o">=</span><span class="n">mdBest</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
                    <span class="n">mdBest</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">mdBest</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">bestWeight</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">mdBest</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ITER</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">objId</span><span class="p">)</span>
                    <span class="n">mdBest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;best@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span>
                
                <span class="c1"># Is local best</span>
                <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult 0 -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">avgWeight</span><span class="o">&gt;</span><span class="n">bestWeightVol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">bestWeightVol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">avgWeight</span>
                    <span class="n">bestIterVol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">iteration</span>
                    <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># Clean</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnTest</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;rm -f&quot;</span><span class="p">,</span><span class="n">fnDir</span><span class="o">+</span><span class="s2">&quot;/*iter00?_00.xmd&quot;</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;rm -f&quot;</span><span class="p">,</span><span class="n">fnDir</span><span class="o">+</span><span class="s2">&quot;/gallery*&quot;</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">md</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;evaluations_</span><span class="si">%03d</span><span class="s2">@&quot;</span><span class="o">%</span><span class="n">iteration</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span>
        
        <span class="c1"># Update best by volume</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">md</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;bestByVolume@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">md</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
                <span class="n">objId</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">addObject</span><span class="p">()</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IDX</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">),</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_WEIGHT</span><span class="p">,</span><span class="n">bestWeightVol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">objId</span><span class="p">)</span>
                <span class="n">md</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_ITER</span><span class="p">,</span><span class="n">bestIterVol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">objId</span><span class="p">)</span>
            <span class="n">md</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;bestByVolume@&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;swarm.xmd&quot;</span><span class="p">),</span><span class="n">emlib</span><span class="o">.</span><span class="n">MD_APPEND</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="XmippProtReconstructSwarm.createOutput"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.createOutput">[docs]</a>    <span class="k">def</span> <span class="nf">createOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">()</span>
        <span class="n">Ts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>

        <span class="c1"># Remove files that will not be used any longer</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.stk&quot;</span><span class="p">))</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">))</span>

        <span class="c1"># Final average</span>
        <span class="n">TsOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">XdimOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fnAvg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeAvg.vol&quot;</span><span class="p">)</span>
        <span class="n">fnAvgMrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeAvg.mrc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_resize&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --dim </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">XdimOrig</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> -t vol&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">fnAvgMrc</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_header&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvgMrc</span><span class="p">,</span><span class="n">TsOrig</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">volume</span><span class="o">=</span><span class="n">Volume</span><span class="p">()</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">fnAvgMrc</span><span class="p">)</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">TsOrig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputVolume</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volume</span><span class="p">)</span>
        
        <span class="c1"># Swarm of volumes</span>
        <span class="n">volSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfVolumes</span><span class="p">()</span>
        <span class="n">volSet</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">Ts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnMrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.mrc&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="n">fnMrc</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_header&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fnMrc</span><span class="p">,</span> <span class="n">TsOrig</span><span class="p">),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnVol</span><span class="p">)</span>

            <span class="n">vol</span><span class="o">=</span><span class="n">Volume</span><span class="p">()</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">fnMrc</span><span class="p">)</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">Ts</span><span class="p">)</span>
            <span class="n">volSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputVolumes</span><span class="o">=</span><span class="n">volSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="n">volSet</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="XmippProtReconstructSwarm.reconstructNewVolumes"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.reconstructNewVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">reconstructNewVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">()</span>
        <span class="n">newXdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_XSIZE</span><span class="p">)</span>
        <span class="n">angleStep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">newXdim</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">minAngle</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">TsOrig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">TsCurrent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readInfoField</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;sampling&quot;</span><span class="p">,</span><span class="n">emlib</span><span class="o">.</span><span class="n">MDL_SAMPLINGRATE</span><span class="p">)</span>
        <span class="n">fnImages</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;images.xmd&quot;</span><span class="p">)</span>
        
        <span class="n">maxShift</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">newXdim</span><span class="p">)</span>
        <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">particleRadius</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">R</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="o">*</span><span class="n">TsOrig</span><span class="o">/</span><span class="n">TsCurrent</span>

        <span class="c1"># Global alignment</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Prepare subset of experimental images</span>
            <span class="n">fnTrain</span> <span class="o">=</span>  <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;imgs_</span><span class="si">%03d</span><span class="s2">.xmd&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_metadata_utilities&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --operate random_subset </span><span class="si">%d</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnImages</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NimgTrain</span><span class="p">,</span><span class="n">fnTrain</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Generate projections</span>
            <span class="n">fnGallery</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d</span><span class="s2">.stk&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnGalleryMd</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span><span class="s2">&quot;gallery</span><span class="si">%02d</span><span class="s2">.doc&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
<span class="c1">#             args=&quot;-i %s -o %s --sampling_rate %f --perturb %f --sym %s&quot;%\</span>
<span class="c1">#                  (fnVol,fnGallery,angleStep,math.sin(angleStep*math.pi/180.0)/4,self.symmetryGroup)</span>
            <span class="n">args</span><span class="o">=</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sampling_rate </span><span class="si">%f</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>\
                 <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnGallery</span><span class="p">,</span><span class="n">angleStep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">)</span>
            <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --compute_neighbors --angular_distance -1 --experimental_images </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnTrain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_angular_project_library&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            
            <span class="c1"># Assign angles</span>
            <span class="n">fnAngles</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">fnDir</span><span class="p">,</span> <span class="s2">&quot;angles_iter001_00.xmd&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> --initgallery </span><span class="si">%s</span><span class="s1"> --maxShift </span><span class="si">%d</span><span class="s1"> --odir </span><span class="si">%s</span><span class="s1"> --dontReconstruct --useForValidation 1&#39;</span> <span class="o">%</span> \
                       <span class="p">(</span><span class="n">fnTrain</span><span class="p">,</span> <span class="n">fnGalleryMd</span><span class="p">,</span> <span class="n">maxShift</span><span class="p">,</span> <span class="n">fnDir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_reconstruct_significant&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                            <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">GpuList</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">()])</span>
                    <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                        <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>

                <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> -r </span><span class="si">%s</span><span class="s1"> -o </span><span class="si">%s</span><span class="s1"> --keepBestN 1 --dev </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">fnTrain</span><span class="p">,</span> <span class="n">fnGalleryMd</span><span class="p">,</span> <span class="n">fnAngles</span><span class="p">,</span> <span class="n">GpuListCuda</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">CUDA_ALIGN_SIGNIFICANT</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Reconstruct</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fnAngles</span><span class="p">):</span>
                <span class="c1"># Significant may decide not to write it if no image is significant</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2"> --sym </span><span class="si">%s</span><span class="s2"> --weight --fast&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">fnAngles</span><span class="p">,</span> <span class="n">fnVol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="c1">#AJ to make it work with and without queue system</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">N_GPUs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -gpusPerNode </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">N_GPUs</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; -threadsPerGPU </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">GpuListCuda</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">():</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span>
                        <span class="n">GpuList</span> <span class="o">=</span> <span class="n">GpuList</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">GpuList</span><span class="p">:</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GpuListAux</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">():</span>
                            <span class="n">GpuListCuda</span> <span class="o">=</span> <span class="n">GpuListCuda</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
                            <span class="n">GpuListAux</span> <span class="o">=</span> <span class="n">GpuListAux</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
                            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GpuListAux</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --thr </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --device </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">GpuListCuda</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="nb">len</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_cuda_reconstruct_fourier&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_reconstruct_fourier_accel&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mask circular </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fnVol</span><span class="p">,</span> <span class="o">-</span><span class="n">R</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_mask&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --select below 0 --substitute value 0&quot;</span> <span class="o">%</span> <span class="n">fnVol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_transform_threshold&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Clean</span>
            <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnTrain</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;rm -f&quot;</span><span class="p">,</span><span class="n">fnDir</span><span class="o">+</span><span class="s2">&quot;/*iter00?_00.xmd&quot;</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;rm -f&quot;</span><span class="p">,</span><span class="n">fnDir</span><span class="o">+</span><span class="s2">&quot;/gallery*&quot;</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtReconstructSwarm.cleanVolume"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.cleanVolume">[docs]</a>    <span class="k">def</span> <span class="nf">cleanVolume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnVol</span><span class="p">):</span>
        <span class="c1"># Generate mask if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextMask</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;mask.vol&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnMask</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="n">fnRootRestored</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeRestored&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --denoising 1&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>
 
        <span class="n">args</span><span class="o">=</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1"> --filterBank 0.01&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnRootRestored</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnMask</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="o">+=</span><span class="s2">&quot; --mask binary_file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">fnMask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_halves_restoration&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">moveFile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored1.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">,</span><span class="n">fnVol</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_restored2.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_filterBank.vol&quot;</span><span class="o">%</span><span class="n">fnRootRestored</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="XmippProtReconstructSwarm.postProcessing"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.postProcessing">[docs]</a>    <span class="k">def</span> <span class="nf">postProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="c1"># Calculate average</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculateAverage</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

        <span class="c1"># Align volumes</span>
        <span class="n">fnAvg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeAvg.vol&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_align&#39;</span><span class="p">,</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --local --apply&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">fnVol</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s1">&#39;xmipp_volume_align&#39;</span><span class="p">,</span><span class="s1">&#39;--i1 </span><span class="si">%s</span><span class="s1"> --i2 </span><span class="si">%s</span><span class="s1"> --local --apply&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">fnVol</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Remove untrusted background voxels</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanVolume</span><span class="p">(</span><span class="n">fnVol</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructSwarm.updateVolumes"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.updateVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">updateVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnBest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeBest.vol&quot;</span><span class="p">)</span>
        <span class="n">fnInternal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;internalBest.vol&quot;</span><span class="p">)</span>
        <span class="n">fnExternal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;externalBest.vol&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnVolBest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            <span class="n">fnSpeed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_speed.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
            
            <span class="n">u1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --minus </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVolBest</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnInternal</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --minus </span><span class="si">%s</span><span class="s2"> -o </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnBest</span><span class="p">,</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnExternal</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnInternal</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">u1</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --mult </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnExternal</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnSpeed</span><span class="p">,</span><span class="n">fnInternal</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnSpeed</span><span class="p">,</span><span class="n">fnExternal</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnSpeed</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnInternal</span><span class="p">)</span>
        <span class="n">cleanPath</span><span class="p">(</span><span class="n">fnExternal</span><span class="p">)</span></div>

<div class="viewcode-block" id="XmippProtReconstructSwarm.calculateAverage"><a class="viewcode-back" href="../../../api/xmipp3/xmipp3.protocols.protocol_reconstruct_swarm.html#xmipp3.protocols.protocol_reconstruct_swarm.XmippProtReconstructSwarm.calculateAverage">[docs]</a>    <span class="k">def</span> <span class="nf">calculateAverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="n">fnAvg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeAvg.vol&quot;</span><span class="p">)</span>
        <span class="n">N</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolumes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">iteration</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">copyFile</span><span class="p">(</span><span class="n">fnVol</span><span class="p">,</span><span class="n">fnAvg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">fnVol</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fnVol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volume</span><span class="si">%03d</span><span class="s2">_best.vol&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">fnVol</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">N</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">iteration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --plus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;volumeBest.vol&quot;</span><span class="p">)),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">N</span><span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="s2">&quot;xmipp_image_operate&quot;</span><span class="p">,</span><span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --divide </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fnAvg</span><span class="p">,</span><span class="n">N</span><span class="p">),</span><span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="c1">#--------------------------- INFO functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Symmetry: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Number of iterations: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">strline</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputVolume&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">strline</span> <span class="o">+=</span> <span class="s1">&#39;We processed </span><span class="si">%d</span><span class="s1"> particles from </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">(),</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">))</span>
            <span class="n">strline</span> <span class="o">+=</span> <span class="s1">&#39;using </span><span class="si">%s</span><span class="s1"> as starting swarm and Xmipp swarm procedure. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getObjectTag</span><span class="p">(</span><span class="s1">&#39;inputVolumes&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span><span class="o">!=</span><span class="s2">&quot;c1&quot;</span><span class="p">:</span>
                <span class="n">strline</span><span class="o">+=</span><span class="s2">&quot;We imposed </span><span class="si">%s</span><span class="s2"> symmetry. &quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetryGroup</span>
            <span class="n">strline</span> <span class="o">+=</span> <span class="s2">&quot;We performed </span><span class="si">%d</span><span class="s2"> iterations of &quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">strline</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGpu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isXmippCudaPresent</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;You have asked to use GPU, but I cannot find the Xmipp GPU programs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../dependabot_pip_babel-2.9.1/index.html">dependabot/pip/babel-2.9.1</a></dd>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/_modules/xmipp3/protocols/protocol_reconstruct_swarm.html">release-3.0.0</a></dd>
            <dd><a href="../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>