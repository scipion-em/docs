

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pkpd.inhalation &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../pkpd.html">pkpd</a> &raquo;</li>
        
      <li>pkpd.inhalation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pkpd.inhalation</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Carlos Oscar Sorzano (info@kinestat.com)</span>
<span class="c1"># *</span>
<span class="c1"># * Kinestat Pharma</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;info@kinestat.com&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes for inhalation PK simulations.</span>

<span class="sd">See Hartung and Borghardt. A mechanistic framework for a priori pharmacokinetic</span>
<span class="sd">predictions of orally inhaled drugs. PLOS Computational Biology, 16: e1008466 (2020)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">interp2d</span>
<span class="kn">from</span> <span class="nn">pwem.objects</span> <span class="kn">import</span> <span class="n">EMObject</span>
<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">int_dx</span><span class="p">,</span> <span class="n">int_dx1dx2</span>

<div class="viewcode-block" id="diam2vol"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.diam2vol">[docs]</a><span class="k">def</span> <span class="nf">diam2vol</span><span class="p">(</span><span class="n">diameters</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/diam2vol.m</span>
    <span class="c1"># Convert diameter to volume, assuming spherical shape</span>
    <span class="c1"># Units: [um] for diameters, [cm^3] for V</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1e-4</span> <span class="o">*</span> <span class="n">diameters</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKPhysiologyLungParameters"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters">[docs]</a><span class="k">class</span> <span class="nc">PKPhysiologyLungParameters</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnPhys</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span>

<div class="viewcode-block" id="PKPhysiologyLungParameters.write"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnOut</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fnOut</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # cardiac output [mL/min]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">Qco</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # lung tissue weight, without blood [g]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">OWlun</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # alveolar fraction of cardiac output</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">falvCO</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # alveolar ELF volume [mL]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">Velf_alv</span><span class="p">)</span>
            <span class="c1"># ELF = Epithelial Lining Fluid</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # alveolar surface area [cm2]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">Surf_alv</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # bronchial fraction of cardiac output</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">fbrCO</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # bronchial fraction of lung tissue volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">fbrVlun</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # bronchial ELF heights for interpolation, trachea [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">helf_trach</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> # bronchial ELF heights for interpolation, terminal bronchioles [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">helf_termbr</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # trachea length [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracheaLength</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # trachea diameter [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracheaDiameter</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # main bronchi length [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Length</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # main bronchi diameter [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Diameter</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # bronchi length [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Length</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # bronchi diameter [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Diameter</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # bronchiole length [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Length</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # bronchiole diameter [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Diameter</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # terminal bronchiole length [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Length</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # terminal bronchiole diameter [cm]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Diameter</span><span class="p">)</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnPhys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnOut</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKPhysiologyLungParameters.read"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnIn</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fnIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qco</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OWlun</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">falvCO</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Velf_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Surf_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbrCO</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbrVlun</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helf_trach</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helf_termbr</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracheaLength</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracheaDiameter</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Length</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Diameter</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Length</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Diameter</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Length</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Diameter</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Length</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Diameter</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnPhys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnIn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKPhysiologyLungParameters.getSystemic"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters.getSystemic">[docs]</a>    <span class="k">def</span> <span class="nf">getSystemic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Hartung2020_MATLAB/physiol_subst/physiology_systemic.m</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Qco&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qco</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;OWlung&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OWlun</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="PKPhysiologyLungParameters.getBronchial"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters.getBronchial">[docs]</a>    <span class="k">def</span> <span class="nf">getBronchial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Hartung2020_MATLAB/physiol_subst/physiology_bronchial.m</span>
        <span class="k">def</span> <span class="nf">listSplit</span><span class="p">(</span><span class="n">valuesStr</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">valuesStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="n">tracheaLength</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracheaLength</span><span class="p">)</span>
        <span class="n">tracheaDiameter</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracheaDiameter</span><span class="p">)</span>
        <span class="n">bronchi1Length</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Length</span><span class="p">)</span>
        <span class="n">bronchi1Diameter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi1Diameter</span><span class="p">)</span>
        <span class="n">bronchi2Length</span>   <span class="o">=</span> <span class="n">listSplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Length</span><span class="p">)</span>
        <span class="n">bronchi2Diameter</span> <span class="o">=</span> <span class="n">listSplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi2Diameter</span><span class="p">)</span>
        <span class="n">bronchi3Length</span>   <span class="o">=</span> <span class="n">listSplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Length</span><span class="p">)</span>
        <span class="n">bronchi3Diameter</span> <span class="o">=</span> <span class="n">listSplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi3Diameter</span><span class="p">)</span>
        <span class="n">bronchi4Length</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Length</span><span class="p">)</span>
        <span class="n">bronchi4Diameter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchi4Diameter</span><span class="p">)</span>

        <span class="n">segmentLengths</span>   <span class="o">=</span> <span class="p">[</span><span class="n">tracheaLength</span><span class="p">,</span>   <span class="n">bronchi1Length</span><span class="p">]</span>  <span class="o">+</span><span class="n">bronchi2Length</span>  <span class="o">+</span><span class="n">bronchi3Length</span>  <span class="o">+</span><span class="p">[</span><span class="n">bronchi4Length</span><span class="p">]</span>
        <span class="n">segmentDiameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">tracheaDiameter</span><span class="p">,</span> <span class="n">bronchi1Diameter</span><span class="p">]</span><span class="o">+</span><span class="n">bronchi2Diameter</span><span class="o">+</span><span class="n">bronchi3Diameter</span><span class="o">+</span><span class="p">[</span><span class="n">bronchi4Diameter</span><span class="p">]</span>
        <span class="n">segmentType</span>      <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bronchi2Length</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;B3&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bronchi3Length</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;B4&#39;</span><span class="p">]</span>

        <span class="n">length_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">segmentLengths</span><span class="p">)</span>
        <span class="n">diam_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">segmentDiameters</span><span class="p">)</span>
        <span class="n">generation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">segmentLengths</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="n">generation</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">xArea_cm2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">diam_cm</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.0</span><span class="p">),</span><span class="n">number</span><span class="p">)</span> <span class="c1"># cm2</span>
        <span class="n">vol_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xArea_cm2</span><span class="p">,</span><span class="n">length_cm</span><span class="p">)</span> <span class="c1"># cm3</span>
        <span class="n">start_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">segmentLengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">end_cm</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">segmentLengths</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span>  <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">start_cm</span><span class="o">+</span><span class="n">end_cm</span><span class="p">)</span>
        <span class="n">surf_cm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">length_cm</span><span class="p">,(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">diam_cm</span><span class="p">)),</span><span class="n">number</span><span class="p">)</span>
        <span class="n">h_elf_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">length_cm</span><span class="p">)],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">helf_trach</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helf_termbr</span><span class="p">])</span>
        <span class="n">elf_cm3</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">diam_cm</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">diam_cm</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">h_elf_cm</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">elf_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">elf_cm3</span><span class="p">,</span><span class="n">length_cm</span><span class="p">),</span><span class="n">number</span><span class="p">)</span>

        <span class="n">Vtis_ctr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OWlun</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fbrVlun</span><span class="p">;</span> <span class="c1"># central lung tissue volume</span>
        <span class="n">voltis_cm3</span> <span class="o">=</span> <span class="n">elf_cm3</span> <span class="o">*</span> <span class="n">Vtis_ctr</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">elf_cm3</span><span class="p">);</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;generation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">generation</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">segmentType</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">number</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;length_cm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">length_cm</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;diam_cm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">diam_cm</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;xArea_cm2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">xArea_cm2</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vol_cm3&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">vol_cm3</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;start_cm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">start_cm</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">end_cm</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pos</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;surf_cm2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">surf_cm2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;h_elf_trach&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helf_trach</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;h_elf_termbr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helf_termbr</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;h_elf_cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_elf_cm</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;elf_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elf_cm3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;voltis_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltis_cm3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fVol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbrVlun</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fQco&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbrCO</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="PKPhysiologyLungParameters.getAlveolar"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKPhysiologyLungParameters.getAlveolar">[docs]</a>    <span class="k">def</span> <span class="nf">getAlveolar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Hartung2020_MATLAB/physiol_subst/physiology_alveolar.m</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fQco&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">falvCO</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fVol&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fbrVlun</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ELF_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Velf_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Vol_cm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OWlun</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fVol&#39;</span><span class="p">]</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># density = 1 [g/cm^3]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Surf_cm2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surf_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span></div></div>

<div class="viewcode-block" id="PKSubstanceLungParameters"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKSubstanceLungParameters">[docs]</a><span class="k">class</span> <span class="nc">PKSubstanceLungParameters</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnSubst</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span>

<div class="viewcode-block" id="PKSubstanceLungParameters.write"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKSubstanceLungParameters.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnOut</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fnOut</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> # name</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # maximum dissolution rate in alveolar space in units [nmol/(cm*min)]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">kdiss_alv</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # maximum dissolution rate in conducting airways in units [nmol/(cm*min)]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">kdiss_br</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # steady-state permeability in alveolar space in [cm/min]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">kp_alv</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # steady-state permeability in conducting airways in [cm/min]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">kp_br</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # solubility in alveolar space in [nmol/cm3]=[uM]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs_alv</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # solubility in conducting airways in [nmol/cm3]=[uM]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs_br</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # density in [nmol/cm3] = [uM]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # molecular weight [g/mol]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">MW</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # plasma to lung partition coefficient in alveolar space [unitless]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_alv</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # plasma to lung partition coefficient in conducting airways [unitless]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_br</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # fraction unbound in plasma [unitless]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fu</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.60g</span><span class="s2"> # blood to plasma ratio [unitless]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnSubst</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnOut</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKSubstanceLungParameters.read"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKSubstanceLungParameters.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnIn</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fnIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kdiss_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kdiss_br</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kp_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kp_br</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cs_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cs_br</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MW</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_alv</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_br</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnSubst</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnIn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKSubstanceLungParameters.getData"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKSubstanceLungParameters.getData">[docs]</a>    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kdiss_alv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdiss_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kdiss_br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdiss_br</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kp_alv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kp_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kp_br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kp_br</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cs_alv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cs_br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs_br</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MW</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Kpl_alv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_alv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Kpl_br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kpl_br</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fu</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
        <span class="k">return</span> <span class="n">data</span></div></div>

<div class="viewcode-block" id="PKDepositionParameters"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKDepositionParameters">[docs]</a><span class="k">class</span> <span class="nc">PKDepositionParameters</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnSubstance</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnLung</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnDeposition</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doseMultiplier</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="PKDepositionParameters.setFiles"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKDepositionParameters.setFiles">[docs]</a>    <span class="k">def</span> <span class="nf">setFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnSubstance</span><span class="p">,</span> <span class="n">fnLung</span><span class="p">,</span> <span class="n">fnDeposition</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnSubstance</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnSubstance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnLung</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnLung</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnDeposition</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">fnDeposition</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKDepositionParameters.readDepositionFile"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKDepositionParameters.readDepositionFile">[docs]</a>    <span class="k">def</span> <span class="nf">readDepositionFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alvlim</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnDeposition</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Header</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Total dose [ug]&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">doseMultiplier</span>
                <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Diameter [um]&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">diameterMode</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="s1">&#39;FractionDeposited&#39;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">diameters</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">oldGeneration</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">fractionMatrix</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">fractionRow</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># table of numbers</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="n">diam</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">generation</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fractionDeposited</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">diam</span> <span class="ow">in</span> <span class="n">diameters</span><span class="p">:</span>
                    <span class="n">diameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diam</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oldGeneration</span><span class="o">!=</span><span class="n">generation</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">oldGeneration</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">fractionMatrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractionRow</span><span class="p">)</span>
                    <span class="n">fractionRow</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">oldGeneration</span><span class="o">=</span><span class="n">generation</span>
                <span class="n">fractionRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractionDeposited</span><span class="p">)</span>
        <span class="n">fractionMatrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractionRow</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">diameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diameters</span><span class="p">)</span> <span class="c1"># [um] for D</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diameterMode</span><span class="o">==</span><span class="s2">&quot;aerodynamic&quot;</span><span class="p">:</span>
            <span class="c1"># Hartung2020_MATLAB/functions/aero2geom.m</span>
            <span class="n">lambdaVar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># spherical shape</span>
            <span class="n">rho_water</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># [g / mL]</span>
            <span class="n">rho_subst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substance</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">substance</span><span class="o">.</span><span class="n">MW</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">;</span> <span class="c1"># [nmol / mL] *[g / mol] -&gt;[g / mL]</span>
            <span class="n">diameters</span> <span class="o">=</span> <span class="n">diameters</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">lambdaVar</span> <span class="o">*</span> <span class="n">rho_water</span> <span class="o">/</span> <span class="n">rho_subst</span><span class="p">);</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dose_nmol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">substance</span><span class="o">.</span><span class="n">MW</span> <span class="c1"># % [ug] *1e3 / ([g/mol]) = [nmol]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchiDose_nmol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fractionMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">alvlim</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_nmol</span>
           <span class="c1"># This is a matrix with as many rows as generations and as many columns as diameters</span>
           <span class="c1"># The content is what is the dose deposited at that generation in nmol</span>
        <span class="n">alveolarMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fractionMatrix</span><span class="p">[</span><span class="n">alvlim</span><span class="o">-</span><span class="mi">1</span><span class="p">:],(</span><span class="nb">len</span><span class="p">(</span><span class="n">fractionMatrix</span><span class="p">)</span><span class="o">-</span><span class="n">alvlim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">diameters</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alveolarDose_nmol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">alveolarMatrix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dose_nmol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
           <span class="c1"># This is a matrix with as many rows as generations in the alveoli and as many columns as diameters</span>
           <span class="c1"># The content is what is the dose deposited at that generation in nmol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">throatDose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose_nmol</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronchiDose_nmol</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alveolarDose_nmol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particleSize</span> <span class="o">=</span> <span class="n">diam2vol</span><span class="p">(</span><span class="n">diameters</span><span class="p">)</span> <span class="c1"># cm3</span></div>

<div class="viewcode-block" id="PKDepositionParameters.read"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKDepositionParameters.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substance</span> <span class="o">=</span> <span class="n">PKSubstanceLungParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substance</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnSubstance</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lung</span> <span class="o">=</span> <span class="n">PKPhysiologyLungParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lung</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnLung</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">alveolarGeneration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lung</span><span class="o">.</span><span class="n">getBronchial</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readDepositionFile</span><span class="p">(</span><span class="n">alveolarGeneration</span><span class="p">)</span></div>

<div class="viewcode-block" id="PKDepositionParameters.getData"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKDepositionParameters.getData">[docs]</a>    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bronchial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronchiDose_nmol</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alveolar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alveolarDose_nmol</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;throat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">throatDose</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particleSize</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dose_nmol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose_nmol</span>
        <span class="k">return</span> <span class="n">data</span></div></div>

<div class="viewcode-block" id="PKCiliarySpeed"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKCiliarySpeed">[docs]</a><span class="k">class</span> <span class="nc">PKCiliarySpeed</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/get_cilspeed.m</span>
    <span class="c1"># Only &#39;interp&#39; model is implemented here</span>

    <span class="n">EXPON</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">FIT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">INTERP</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INTERP</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lungParams</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PKCiliarySpeed.prepare"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKCiliarySpeed.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lungParams</span><span class="p">,</span> <span class="n">ciliarySpeedType</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ciliarySpeedType</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lungParams</span> <span class="o">=</span> <span class="n">lungParams</span>
        <span class="n">lungData</span> <span class="o">=</span> <span class="n">lungParams</span><span class="o">.</span><span class="n">getBronchial</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;length_cm&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diam_cm</span> <span class="o">=</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;diam_cm&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ciliary speed ================&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total length of the lung [cm]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location of branches [cm]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Diameter of the branches [cm]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">diam_cm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPON</span><span class="p">:</span>
            <span class="c1"># Exponentially increasing ciliary speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cilspeed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">4e-3</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">4e-3</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">FIT</span><span class="p">:</span>
            <span class="c1"># Simple fitted empirical ciliary transport model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cilspeed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">-</span><span class="n">x</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="mf">0.92</span><span class="p">)))</span><span class="o">/</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">INTERP</span><span class="p">:</span>
            <span class="c1"># Hofmann - Sturm model for mucociliary transport velocity</span>
            <span class="c1"># Reference: Hofmann / Sturm (2004) J Aerosol Med, Vol 17(1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="mf">1.2553</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;diam_cm&#39;</span><span class="p">],</span><span class="mf">2.808</span><span class="p">)</span> <span class="c1"># in [cm / min]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cilspeed</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div></div>

<div class="viewcode-block" id="PKInhalationDissolution"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKInhalationDissolution">[docs]</a><span class="k">class</span> <span class="nc">PKInhalationDissolution</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/get_disol.m</span>
    <span class="c1"># All implemented dissolution models are based on an adapted version of</span>
    <span class="c1"># the Noyes - Whitney equation, but differ in whether they</span>
    <span class="c1"># 1) describe saturable or unsaturable dissolution</span>
    <span class="c1"># 2) truncate or not the dissolution speed for small particles (for  numeric stability)</span>
    <span class="c1"># 3) truncate or not the dissolution speed for large particles</span>
    <span class="c1">#    (based on the assumption that only a part of the particle surface</span>
    <span class="c1">#    is in contact with the dissolution medium)</span>

    <span class="n">UNSAT</span>       <span class="o">=</span> <span class="mi">0</span>
    <span class="n">TRUNC_UNSAT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">SAT</span>         <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Only this one is implemented</span>
    <span class="n">TRUNC_SAT</span>   <span class="o">=</span> <span class="mi">3</span>
    <span class="n">TRUNC2_SAT</span>  <span class="o">=</span> <span class="mi">4</span>
    <span class="n">CAP</span>         <span class="o">=</span> <span class="mi">5</span>
    <span class="n">XCAP</span>        <span class="o">=</span> <span class="mi">6</span>
    <span class="n">UNSOL</span>       <span class="o">=</span> <span class="mi">7</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substanceParams</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PKInhalationDissolution.prepare"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKInhalationDissolution.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substanceParams</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substanceParams</span> <span class="o">=</span> <span class="n">substanceParams</span>
        <span class="n">substanceData</span> <span class="o">=</span> <span class="n">substanceParams</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">part</span><span class="o">==</span><span class="s2">&quot;bronchi&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kdiss</span> <span class="o">=</span> <span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;kdiss_br&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span> <span class="o">=</span> <span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;Cs_br&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kdiss</span> <span class="o">=</span> <span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;kdiss_alv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span> <span class="o">=</span> <span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;Cs_alv&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Substance in </span><span class="si">%s</span><span class="s2"> ===================&quot;</span><span class="o">%</span><span class="n">part</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum dissolution rate [nmol/(cm*min)]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">kdiss</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solubility in [nmol/cm3]=[uM]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Density in [nmol/cm3]&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdiss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span>
        <span class="n">K</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">D</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">SAT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dissol</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">Cf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="o">-</span><span class="n">Cf</span><span class="p">),(</span><span class="n">Cf</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span></div>
                          <span class="c1"># [cm^3/min]</span>

<div class="viewcode-block" id="PKInhalationDissolution.getDissolution"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKInhalationDissolution.getDissolution">[docs]</a>    <span class="k">def</span> <span class="nf">getDissolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Cf</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dissol</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Cf</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PKLung"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKLung">[docs]</a><span class="k">class</span> <span class="nc">PKLung</span><span class="p">(</span><span class="n">EMObject</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/get_bronchial_kinetics.m</span>
    <span class="c1"># Hartung2020_MATLAB/functions/get_alveolar_kinetics.m</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="n">EMObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substanceParams</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lungParams</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ciliarySpeed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionBronchi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionAlveoli</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PKLung.prepare"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKLung.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substanceParams</span><span class="p">,</span> <span class="n">lungParams</span><span class="p">,</span> <span class="n">pkParams</span><span class="p">,</span> <span class="n">pkMultiplier</span><span class="p">,</span> <span class="n">ciliarySpeedType</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substanceParams</span> <span class="o">=</span> <span class="n">substanceParams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lungParams</span> <span class="o">=</span> <span class="n">lungParams</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ciliarySpeed</span> <span class="o">=</span> <span class="n">PKCiliarySpeed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ciliarySpeed</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">lungParams</span><span class="p">,</span> <span class="n">ciliarySpeedType</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionBronchi</span> <span class="o">=</span> <span class="n">PKInhalationDissolution</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionBronchi</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">substanceParams</span><span class="p">,</span><span class="s2">&quot;bronchi&quot;</span><span class="p">)</span>

        <span class="c1"># Hartung2020_MATLAB/functions/get_bronchial_kinetics.m</span>
        <span class="n">bronchialData</span> <span class="o">=</span> <span class="n">lungParams</span><span class="o">.</span><span class="n">getBronchial</span><span class="p">()</span>
        <span class="c1"># Code just to show the equivalence between the .m and .py</span>
        <span class="c1"># bronchialData[&#39;elf_cm3&#39;] = bronchialData[&#39;elf_cm3&#39;]</span>
        <span class="c1"># bronchialData[&#39;voltis_cm3&#39;] = bronchialData[&#39;voltis_cm3&#39;]</span>
        <span class="c1"># bronchialData[&#39;surf_cm2&#39;] = bronchialData[&#39;surf_cm2&#39;]</span>
        <span class="c1"># bronchialData[&#39;fQco&#39;] = bronchialData[&#39;fQco&#39;]</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">bronchialData</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        <span class="n">diam_cm</span> <span class="o">=</span> <span class="n">bronchialData</span><span class="p">[</span><span class="s1">&#39;diam_cm&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">substanceData</span> <span class="o">=</span> <span class="n">substanceParams</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>

        <span class="c1"># Code just to show the equivalence between the .m and .py</span>
        <span class="c1"># self.substanceData[&#39;Cs_br&#39;] = self.substanceData[&#39;Cs_br&#39;]</span>
        <span class="c1"># self.substanceData[&#39;Cs_alv&#39;] = self.substanceData[&#39;Cs_alv&#39;]</span>
        <span class="c1"># self.substanceData[&#39;kdiss_br&#39;] = self.substanceData[&#39;kdiss_br&#39;]</span>
        <span class="c1"># self.substanceData[&#39;kdiss_alv&#39;] = self.substanceData[&#39;kdiss_alv&#39;]</span>
        <span class="c1"># self.substanceData[&#39;kp_br&#39;] = self.substanceData[&#39;kp_br&#39;]</span>
        <span class="c1"># self.substanceData[&#39;kp_alv&#39;] = self.substanceData[&#39;kp_alv&#39;]</span>
        <span class="c1"># self.substanceData[&#39;Kpl_br&#39;] = self.substanceData[&#39;Kpl_br&#39;]</span>
        <span class="c1"># self.substanceData[&#39;Kpl_alv&#39;] = self.substanceData[&#39;Kpl_alv&#39;]</span>

        <span class="n">kp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;kp_br&#39;</span><span class="p">]</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">kp</span> <span class="o">*</span> <span class="n">diam_cm</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Absorption rate per bronchial segment [1/min]&quot;</span><span class="p">,</span><span class="n">ka</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronchialAbsorb</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">ka</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ka</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Hartung2020_MATLAB/functions/get_alveolar_kinetics.m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionAlveoli</span> <span class="o">=</span> <span class="n">PKInhalationDissolution</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inhalationDissolutionAlveoli</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">substanceParams</span><span class="p">,</span><span class="s2">&quot;alveoli&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">pkParams</span><span class="o">.</span><span class="n">getFirstSample</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Vp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;Vp&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;k01&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;k01&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">getDescriptorValue</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">pkMultiplier</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span></div>

<div class="viewcode-block" id="PKLung.cilspeed"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.PKLung.cilspeed">[docs]</a>    <span class="k">def</span> <span class="nf">cilspeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lungParams</span><span class="o">.</span><span class="n">multiplier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ciliarySpeed</span><span class="o">.</span><span class="n">cilspeed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="conserving_projection"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.conserving_projection">[docs]</a><span class="k">def</span> <span class="nf">conserving_projection</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">X2</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/conserving_projection.m</span>
    <span class="c1">#   V2 = CONSERVING_PROJECTION(X1,V1,X2) projects quantity V1 from location</span>
    <span class="c1">#   grid X1 to grid X2, ensuring int_x^y(v2(z)dz) = int_x^y(v1(z)dz) holds</span>
    <span class="c1">#   for any x,y, where vI(z) := vI(j) for Xi(j) &lt; z &lt; Xi(j+1) (i=1,2)</span>
    <span class="c1">#   (constant between grid cells)</span>
    <span class="n">cumV1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">V1</span><span class="p">)));</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">cumV1</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">cumV1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cumV1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">interpolator</span><span class="p">(</span><span class="n">X2</span><span class="p">))</span></div>

<div class="viewcode-block" id="P_aELF"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.P_aELF">[docs]</a><span class="k">def</span> <span class="nf">P_aELF</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/P_aELF.m</span>
    <span class="c1">#   Aim: locally and globally conserve ELF volumes</span>
    <span class="c1">#   Input:  boundary gridpoints of computational location grid</span>
    <span class="c1">#   Output: cross-sectional areas at (ctr) grid points (a_Xctr), satisfying</span>
    <span class="c1">#           int_dx(Xbnd, a_Xctr) == sum(aw.elf_cm3) (and local volume conservation)</span>
    <span class="n">V_Xctr</span> <span class="o">=</span> <span class="n">conserving_projection</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">])),</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;elf_cm3&#39;</span><span class="p">],</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">V_Xctr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">))</span></div>

<div class="viewcode-block" id="P_aTis"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.P_aTis">[docs]</a><span class="k">def</span> <span class="nf">P_aTis</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/P_aTis.m</span>
    <span class="c1">#   Aim: locally and globally conserve tissue volumes</span>
    <span class="c1">#   Input:  boundary gridpoints of computational location grid</span>
    <span class="c1">#   Output: cross-sectional areas at (ctr) grid points (a_Xctr), satisfying</span>
    <span class="c1">#           int_dx(Xbnd, a_Xctr) == sum(aw.voltis_cm3) (and local volume conservation)</span>
    <span class="n">V_Xctr</span> <span class="o">=</span> <span class="n">conserving_projection</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">])),</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;voltis_cm3&#39;</span><span class="p">],</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">V_Xctr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">))</span></div>

<div class="viewcode-block" id="P_hELF"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.P_hELF">[docs]</a><span class="k">def</span> <span class="nf">P_hELF</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xctr</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/P_hELF.m</span>
    <span class="c1">#   Input:  center gridpoints of computational location grid</span>
    <span class="c1">#   Output: ELF heights at (ctr) grid points (h_Xctr), in cm.</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;h_elf_cm&#39;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">Xctr</span><span class="p">)</span></div>

<div class="viewcode-block" id="P_Qbr"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.P_Qbr">[docs]</a><span class="k">def</span> <span class="nf">P_Qbr</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">systemicData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/functions/P_Qbr.m</span>
    <span class="c1">#   Project bronchial (central lung) blood flow onto computational grid</span>
    <span class="c1">#   Total blood flow is conserved</span>
    <span class="n">Qcl</span> <span class="o">=</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;fQco&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">systemicData</span><span class="p">[</span><span class="s1">&#39;Qco&#39;</span><span class="p">]</span>

    <span class="c1"># Modelling assumption: blood flow proportional to tissue volume</span>
    <span class="n">Qgen</span> <span class="o">=</span> <span class="n">Qcl</span> <span class="o">*</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;voltis_cm3&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;voltis_cm3&#39;</span><span class="p">])</span>
    <span class="n">Q_Xctr</span> <span class="o">=</span> <span class="n">conserving_projection</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">])),</span> <span class="n">Qgen</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Q_Xctr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">));</span></div>

<div class="viewcode-block" id="project_deposition_2D"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.project_deposition_2D">[docs]</a><span class="k">def</span> <span class="nf">project_deposition_2D</span><span class="p">(</span><span class="n">depositionData</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">lungData</span><span class="p">):</span>
    <span class="c1">#   Project deposition data on 2D computational grid</span>
    <span class="c1">#   Strategy for projection on 2D grid:</span>
    <span class="c1">#     - Uniform distribution of dose in data location-size gridcells</span>
    <span class="c1">#       (per generation and per size category) --&gt; f(x,s)</span>
    <span class="c1">#     - rho0 at solver location-size gridcell C = average of f(x,s) in C</span>
    <span class="n">xbnddat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">]))</span>

    <span class="n">smax</span> <span class="o">=</span> <span class="n">diam2vol</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sdil_default</span> <span class="o">=</span> <span class="n">diam2vol</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Projection onto bronchi</span>
    <span class="c1"># step 1: distribute delta peaks in size over short size intervals</span>
    <span class="n">sdattmp</span> <span class="o">=</span> <span class="n">depositionData</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
    <span class="n">sdil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">sdil_default</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sdattmp</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">sdattmp</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">sdil</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">sdil</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sdattmp</span><span class="p">))])</span>
    <span class="n">sbnddat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sdattmp</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">sdil</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sdattmp</span><span class="o">.</span><span class="n">shape</span><span class="p">),[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="n">smax</span><span class="p">]))</span>

    <span class="n">amtxs_br</span> <span class="o">=</span> <span class="n">depositionData</span><span class="p">[</span><span class="s1">&#39;bronchial&#39;</span><span class="p">]</span>
    <span class="n">amtxs_br_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">amtxs_br</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">amtxs_br</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">amtxs_br_ext</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">amtxs_br</span>

    <span class="c1"># step 2: compute cumulative amount matrix per data location-size grid</span>
    <span class="n">camtdat_br_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">amtxs_br_ext</span><span class="p">,((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">camtdat_br_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">camtdat_br_x</span><span class="p">,((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># step 3: linear interpolation projects onto solver location-size grid</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">sbnddat</span><span class="p">,</span> <span class="n">xbnddat</span><span class="p">,</span> <span class="n">camtdat_br_xs</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">camtbnd_br_xs</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

    <span class="n">amtgrd_br_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">camtbnd_br_xs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">amtgrd_br_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">amtgrd_br_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">amtgrd_br_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amtgrd_br_xs</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">amtgrd_br_xs</span><span class="p">)</span> <span class="c1"># Make sure that everything is positive</span>

    <span class="c1"># step 4: for each grid cell: amount -&gt; location-resolved amount per size</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">rho0br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">amtgrd_br_xs</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dx</span><span class="p">,(</span><span class="n">dx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ds</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

    <span class="c1"># Alveolar</span>
    <span class="n">amt_alv</span> <span class="o">=</span> <span class="n">depositionData</span><span class="p">[</span><span class="s1">&#39;alveolar&#39;</span><span class="p">]</span>
    <span class="n">amt_alv_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">amt_alv</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">amt_alv_ext</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">amt_alv</span>
    <span class="n">camtdat_alv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">amt_alv_ext</span><span class="p">)))</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sbnddat</span><span class="p">,</span> <span class="n">camtdat_alv</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">camtbnd_alv</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

    <span class="n">amtgrd_alv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">camtbnd_alv</span><span class="p">);</span>
    <span class="n">rho0alv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">amtgrd_alv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ds</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rho0br</span><span class="p">,</span> <span class="n">rho0alv</span><span class="p">)</span></div>

<div class="viewcode-block" id="saturable_2D_upwind_IE"><a class="viewcode-back" href="../../api/pkpd/pkpd.inhalation.html#pkpd.inhalation.saturable_2D_upwind_IE">[docs]</a><span class="k">def</span> <span class="nf">saturable_2D_upwind_IE</span><span class="p">(</span><span class="n">lungParams</span><span class="p">,</span> <span class="n">pkLung</span><span class="p">,</span> <span class="n">depositionParams</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">Sbnd</span><span class="p">):</span>
    <span class="c1"># Hartung2020_MATLAB/models/saturable_2D_upwind_IE.m</span>
    <span class="c1">#   Algorithm features:</span>
    <span class="c1">#   - Conducting airways, peripheral airways and systemic circulation fully coupled</span>
    <span class="c1">#   - Upwind discretisation of PDE and compatible integration rules for mass conservation</span>
    <span class="c1">#   - implicit Euler discretisation of linear processes</span>
    <span class="c1">#   - saturable dissolution model</span>
    <span class="c1">#   - initial particle size treated as a delta distribution; particle size is treat followed over time.</span>
    <span class="c1">#   - along the location axis, an arbitrary grid can be used</span>
    <span class="c1">#</span>
    <span class="c1">#   Since dissolution is saturable, particle sizes at different airway</span>
    <span class="c1">#   positions may differ from each other for t &gt; 0.</span>
    <span class="c1">#</span>
    <span class="c1">#   The idea of this approach is that the size resolution in the data may</span>
    <span class="c1">#   be much coarser than that the location grid</span>
    <span class="c1">#   (extreme case: monodisperse particle distribution)</span>
    <span class="c1"># print(Sbnd.shape)</span>
    <span class="c1"># print(np.mean(Sbnd)); aaaa</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>

    <span class="n">lungData</span> <span class="o">=</span> <span class="n">lungParams</span><span class="o">.</span><span class="n">getBronchial</span><span class="p">()</span>
    <span class="n">alveolarData</span> <span class="o">=</span> <span class="n">lungParams</span><span class="o">.</span><span class="n">getAlveolar</span><span class="p">()</span>
    <span class="n">systemicData</span> <span class="o">=</span> <span class="n">lungParams</span><span class="o">.</span><span class="n">getSystemic</span><span class="p">()</span>
    <span class="n">depositionData</span> <span class="o">=</span> <span class="n">depositionParams</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>

    <span class="n">Xbnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;end_cm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">lungData</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="n">Xbnd</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">Ns</span> <span class="o">=</span> <span class="n">Sbnd</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># midpoints in discretisation cell (where rho, Cflu, Ctis are modelled)</span>
    <span class="n">Xctr</span> <span class="o">=</span> <span class="n">Xbnd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Sctr</span> <span class="o">=</span> <span class="n">Sbnd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># transport velocity</span>
    <span class="n">lambdaX</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">cilspeed</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">)</span>
    <span class="c1"># print(&quot;Xbnd&quot;,np.mean(Xbnd))</span>
    <span class="c1"># print(&quot;lambdaX&quot;,np.mean(lambdaX)); aaaaa</span>

    <span class="c1"># location/size discretisation steps</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">)</span>

    <span class="c1"># absorption into tissue</span>
    <span class="n">kaX</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">bronchialAbsorb</span><span class="p">(</span><span class="n">Xctr</span><span class="p">)</span>
    <span class="c1"># print(&quot;kaX&quot;,np.mean(kaX)); aaaaa</span>

    <span class="c1"># cross-sectional areas</span>
    <span class="n">aFluX</span> <span class="o">=</span> <span class="n">P_aELF</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="n">aTisX</span> <span class="o">=</span> <span class="n">P_aTis</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="c1"># print(&quot;aFluX&quot;,np.mean(aFluX));</span>
    <span class="c1"># print(&quot;aTisX&quot;,np.mean(aTisX)); aaaaa</span>

    <span class="c1"># ELF heights in bronchi / alveolar space</span>
    <span class="n">hFluX</span> <span class="o">=</span> <span class="n">P_hELF</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">Xctr</span><span class="p">)</span>
    <span class="n">hFlualv</span> <span class="o">=</span> <span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;ELF_cm3&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;Surf_cm2&#39;</span><span class="p">]</span>
    <span class="c1"># print(&quot;hFluX&quot;,np.mean(hFluX));</span>
    <span class="c1"># print(&quot;hFlualv&quot;,np.mean(hFlualv)); aaaaa</span>

    <span class="c1"># blood flow</span>
    <span class="n">Qalv</span> <span class="o">=</span> <span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;fQco&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">systemicData</span><span class="p">[</span><span class="s1">&#39;Qco&#39;</span><span class="p">]</span> <span class="c1"># Alveolar</span>
    <span class="n">qX</span> <span class="o">=</span> <span class="n">P_Qbr</span><span class="p">(</span><span class="n">lungData</span><span class="p">,</span> <span class="n">systemicData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">)</span>
    <span class="n">QbrX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">qX</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="c1"># bronchial (location-resolved)</span>
    <span class="c1"># print(&quot;Qalv&quot;,np.mean(Qalv));</span>
    <span class="c1"># print(&quot;QbrX&quot;,np.mean(QbrX)); aaaaa</span>

    <span class="c1"># plasma to lung partition coefficients</span>
    <span class="n">Kpl_br</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;Kpl_br&#39;</span><span class="p">]</span>
    <span class="n">Kpl_alv</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;Kpl_alv&#39;</span><span class="p">]</span>
    <span class="n">Kpl_u_br</span> <span class="o">=</span> <span class="n">Kpl_br</span> <span class="o">/</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;fu&#39;</span><span class="p">]</span>
    <span class="n">Kpl_u_alv</span> <span class="o">=</span> <span class="n">Kpl_alv</span> <span class="o">/</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;fu&#39;</span><span class="p">]</span>
    <span class="c1"># print(&quot;Kpl_br&quot;,np.mean(Kpl_br));</span>
    <span class="c1"># print(&quot;Kpl_alv&quot;,np.mean(Kpl_alv));</span>
    <span class="c1"># print(&quot;Kpl_u_br&quot;,np.mean(Kpl_u_br));</span>
    <span class="c1"># print(&quot;Kpl_u_alv&quot;,np.mean(Kpl_u_alv)); aaaaa</span>

    <span class="c1"># permeability-surface area products [cm3/min]</span>
    <span class="n">PS_alv</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;kp_alv&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;Surf_cm2&#39;</span><span class="p">];</span>  <span class="c1"># alveolar</span>
    <span class="n">PS_br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">kaX</span> <span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="c1"># bronchial</span>
    <span class="c1"># print(&quot;PS_alv&quot;,np.mean(PS_alv));</span>
    <span class="c1"># print(&quot;PS_br&quot;,np.mean(PS_br)); aaaaa</span>

    <span class="c1"># assign volumes to variables</span>
    <span class="n">alvELF</span> <span class="o">=</span> <span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;ELF_cm3&#39;</span><span class="p">]</span>  <span class="c1"># alveolar fluid</span>
    <span class="n">alvTis</span> <span class="o">=</span> <span class="n">alveolarData</span><span class="p">[</span><span class="s1">&#39;Vol_cm3&#39;</span><span class="p">]</span>  <span class="c1"># alveolar tissue</span>
    <span class="n">brELF</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">aFluX</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span>    <span class="c1"># bronchial fluid</span>
    <span class="n">brTis</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">aTisX</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span>    <span class="c1"># bronchial tissue</span>
    <span class="c1"># print(&quot;alvELF&quot;,np.mean(alvELF));</span>
    <span class="c1"># print(&quot;alvTis&quot;,np.mean(alvTis));</span>
    <span class="c1"># print(&quot;brELF&quot;,np.mean(brELF));</span>
    <span class="c1"># print(&quot;brTis&quot;,np.mean(brTis)); aaaaa</span>

    <span class="c1"># Allocate lung amounts: A_flu(alv/br), A_tis(alv/br)</span>
    <span class="n">Nt</span><span class="o">=</span><span class="n">tt</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">Aalvflu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">Aalvtis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

    <span class="n">Abrflu</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="p">));</span>
    <span class="n">Abrtis</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="p">));</span>

    <span class="c1"># Allocate systemic amounts: Asysgut, Asysctr, Asysper</span>
    <span class="n">Asysgut</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">Asysctr</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">Asysper</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

    <span class="c1"># Allocate amount cleared:</span>
    <span class="n">Aclear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>     <span class="c1"># for mass balance</span>
    <span class="n">Amcc</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>     <span class="c1"># to track cumulative amount cleared by MCC (not in mass balance)</span>

    <span class="c1"># Initialize PSPM densities (br/alv) and gut compartment with dosing</span>
    <span class="n">rhobr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ns</span><span class="p">));</span>
    <span class="n">rhoalv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">Ns</span><span class="p">));</span>

    <span class="n">rho0br</span><span class="p">,</span> <span class="n">rho0alv</span> <span class="o">=</span> <span class="n">project_deposition_2D</span><span class="p">(</span><span class="n">depositionData</span><span class="p">,</span> <span class="n">Xbnd</span><span class="p">,</span> <span class="n">Sbnd</span><span class="p">,</span> <span class="n">lungData</span><span class="p">)</span>
    <span class="c1"># print(&quot;rho0br&quot;,np.mean(rho0br));</span>
    <span class="c1"># print(&quot;rho0alv&quot;,np.mean(rho0alv)); aaaaa</span>

    <span class="n">rhobr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">rho0br</span>
    <span class="n">rhoalv</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">rho0alv</span>
    <span class="n">Asysgut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">depositionData</span><span class="p">[</span><span class="s1">&#39;throat&#39;</span><span class="p">]</span>
    <span class="n">CFL_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># print(&quot;depositionData[&#39;throat&#39;]&quot;,depositionData[&#39;throat&#39;]); aaaa</span>

    <span class="c1"># Time iteration</span>
    <span class="c1"># pre-compute expressions constant in time</span>
    <span class="c1"># row vectors (expandable to a 1-by-Nx-by-Ns array)</span>
    <span class="n">l_dx_post</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">lambdaX</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">l_dx_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">lambdaX</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">dSctr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Sctr</span><span class="p">)</span> <span class="c1"># from discrete integration by parts</span>
    <span class="n">ds3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="c1"># print(&quot;l_dx_post&quot;,np.mean(l_dx_post));</span>
    <span class="c1"># print(&quot;l_dx_pre&quot;,np.mean(l_dx_pre));</span>
    <span class="c1"># print(&quot;dSctr&quot;,np.mean(dSctr));</span>
    <span class="c1"># print(&quot;ds3D&quot;,np.mean(ds3D)); aaaaa</span>

    <span class="c1"># PK parameters</span>
    <span class="n">Vc</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">];</span>
    <span class="n">k10</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vc</span>
    <span class="n">k12</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vc</span>
    <span class="n">k21</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;Vp&#39;</span><span class="p">]</span>
    <span class="n">k01</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;k01&#39;</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">pkData</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span>
    <span class="c1"># print(&quot;Vc&quot;,Vc);</span>
    <span class="c1"># print(&quot;k10&quot;,k10);</span>
    <span class="c1"># print(&quot;k12&quot;,k12);</span>
    <span class="c1"># print(&quot;k21&quot;,k21);</span>
    <span class="c1"># print(&quot;k01&quot;,k01);</span>
    <span class="c1"># print(&quot;F&quot;,F); aaaaa</span>

    <span class="n">Qbrtot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">QbrX</span><span class="p">)</span> <span class="c1"># total bronchial blood flow</span>
    <span class="n">R</span> <span class="o">=</span>  <span class="n">pkLung</span><span class="o">.</span><span class="n">substanceData</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="c1"># print(&quot;Qbrtot&quot;,Qbrtot);</span>
    <span class="c1"># print(&quot;R&quot;,R); aaaaa</span>

    <span class="c1"># Time loop</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span> <span class="c1"># (semi - explicit Euler; implicit absorption into tissue)</span>
        <span class="n">dtn</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">Calvflun</span> <span class="o">=</span> <span class="n">Aalvflu</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/</span> <span class="n">alvELF</span><span class="p">;</span>
        <span class="n">Cbrflun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Abrflu</span><span class="p">[</span><span class="n">n</span><span class="p">,:],</span> <span class="n">brELF</span><span class="p">)</span>

        <span class="n">d_Sbnd_Cflualv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pkLung</span><span class="o">.</span><span class="n">inhalationDissolutionAlveoli</span><span class="o">.</span><span class="n">getDissolution</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">,</span> <span class="n">Calvflun</span><span class="p">,</span> <span class="n">hFlualv</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">Sbnd</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="c1"># print(&quot;d_Sbnd_Cflualv&quot;,np.mean(d_Sbnd_Cflualv)); aaaaa</span>

        <span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> \
                 <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d_Sbnd_Cflualv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ds3D</span><span class="p">),</span> <span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span><span class="p">,:,:])</span><span class="o">+</span>\
                 <span class="n">dtn</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d_Sbnd_Cflualv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ds3D</span><span class="p">),</span>\
                                    <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span><span class="p">,:,</span><span class="mi">1</span><span class="p">:],((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># aaa=rhoalv[n + 1,:,:]; print(&quot;rhoalv[n + 1,:,:]&quot;,np.mean(aaa)); aaaaa</span>
        <span class="n">dissolved_alv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dSctr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">d_Sbnd_Cflualv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span><span class="p">,:,</span><span class="mi">1</span><span class="p">:]),(</span><span class="n">dSctr</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
        <span class="c1"># print(&quot;dissolved_alv&quot;,np.mean(dissolved_alv)); aaaaa</span>

        <span class="n">d_Sbnd_Cflubr</span> <span class="o">=</span> <span class="n">pkLung</span><span class="o">.</span><span class="n">inhalationDissolutionBronchi</span><span class="o">.</span><span class="n">getDissolution</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">,</span> <span class="n">Cbrflun</span><span class="p">,</span> <span class="n">hFluX</span><span class="p">)</span>
        <span class="c1"># print(&quot;d_Sbnd_Cflubr&quot;,np.mean(d_Sbnd_Cflubr)); aaaaa</span>

        <span class="n">aux</span> <span class="o">=</span> <span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">rhobr</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dtn</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">l_dx_pre</span><span class="p">,(</span><span class="n">l_dx_pre</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d_Sbnd_Cflubr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ds3D</span><span class="p">),</span><span class="n">aux</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
                        <span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> \
            <span class="n">dtn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">l_dx_post</span><span class="p">,(</span><span class="n">l_dx_post</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">:,:],((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span>\
            <span class="n">dtn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d_Sbnd_Cflubr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ds3D</span><span class="p">),</span> \
                              <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># aaa=rhobr[n + 1,:,:]; print(&quot;rhobr[n + 1,:,:]&quot;,np.mean(aaa)); aaaaa</span>

        <span class="n">dissolved_br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dSctr</span><span class="p">,</span>
                                                      <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">d_Sbnd_Cflubr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,:,</span> <span class="mi">1</span><span class="p">:])),</span>
                                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># print(&quot;dissolved_br&quot;,np.mean(dissolved_br)); aaaaa</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dtn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">PS_br</span><span class="p">,</span><span class="n">brELF</span><span class="p">))</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">dtn</span><span class="o">/</span><span class="n">Kpl_u_br</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">PS_br</span><span class="p">,</span><span class="n">brTis</span><span class="p">))</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">PS_br</span><span class="p">,</span><span class="n">brELF</span><span class="p">))</span>
        <span class="n">A4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dtn</span><span class="p">,</span><span class="n">brTis</span><span class="p">),</span><span class="n">PS_br</span><span class="o">/</span><span class="n">Kpl_u_br</span> <span class="o">+</span> <span class="n">QbrX</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">Kpl_br</span><span class="p">)))</span>
        <span class="n">Mbr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">A1</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">A2</span><span class="p">,[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">A3</span><span class="p">,[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">A4</span><span class="p">,[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="c1"># print(&quot;Mbr&quot;,np.mean(Mbr))</span>


        <span class="n">Malv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dtn</span><span class="o">/</span><span class="n">alvELF</span><span class="o">*</span><span class="n">PS_alv</span><span class="p">,</span>  <span class="o">-</span><span class="n">dtn</span><span class="o">/</span><span class="n">alvTis</span> <span class="o">*</span> <span class="n">PS_alv</span><span class="o">/</span><span class="n">Kpl_u_alv</span><span class="p">],</span>
                           <span class="p">[</span><span class="o">-</span><span class="n">dtn</span><span class="o">/</span><span class="n">alvELF</span><span class="o">*</span><span class="n">PS_alv</span>   <span class="p">,</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">dtn</span><span class="o">/</span><span class="n">alvTis</span><span class="o">*</span><span class="p">(</span><span class="n">PS_alv</span><span class="o">/</span><span class="n">Kpl_u_alv</span> <span class="o">+</span> <span class="n">Qalv</span><span class="o">*</span><span class="n">R</span><span class="o">/</span><span class="n">Kpl_alv</span><span class="p">)]])</span>
        <span class="c1"># print(&quot;Malv&quot;,np.mean(Malv))</span>

        <span class="n">Msys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span> <span class="c1"># gut        per       clear      ctr  &lt;- X_i&#39; %f(X_j)</span>
                           <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">dtn</span><span class="o">*</span><span class="n">k01</span>     <span class="p">,</span>      <span class="mi">0</span>  <span class="p">,</span>      <span class="mi">0</span>   <span class="p">,</span>           <span class="mi">0</span><span class="p">],</span>           <span class="c1"># gut</span>
                           <span class="p">[</span><span class="mi">0</span>             <span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">dtn</span><span class="o">*</span><span class="n">k21</span><span class="p">,</span>      <span class="mi">0</span>   <span class="p">,</span>    <span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">k12</span><span class="p">],</span>           <span class="c1"># per</span>
                           <span class="p">[</span><span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">F</span><span class="p">)</span><span class="o">*</span><span class="n">k01</span><span class="p">,</span>      <span class="mi">0</span>  <span class="p">,</span>      <span class="mi">1</span>   <span class="p">,</span>    <span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">k10</span><span class="p">],</span>           <span class="c1"># clear</span>
                           <span class="p">[</span><span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">F</span><span class="o">*</span><span class="n">k01</span><span class="p">,</span>     <span class="o">-</span><span class="n">dtn</span><span class="o">*</span><span class="n">k21</span><span class="p">,</span>      <span class="mi">0</span>   <span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">dtn</span><span class="o">*</span><span class="p">(</span><span class="n">k10</span><span class="o">+</span><span class="n">k12</span><span class="o">+</span><span class="p">(</span><span class="n">Qalv</span><span class="o">+</span><span class="n">Qbrtot</span><span class="p">)</span><span class="o">/</span><span class="n">Vc</span><span class="p">)]])</span> <span class="c1"># ctr</span>
        <span class="c1"># print(&quot;Msys&quot;,np.mean(Msys)); aaaa</span>

        <span class="n">Mbrctr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">((</span><span class="n">dtn</span> <span class="o">/</span> <span class="n">Vc</span><span class="p">)</span> <span class="o">*</span> <span class="n">QbrX</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">Malvctr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dtn</span> <span class="o">/</span> <span class="n">Vc</span><span class="p">)</span> <span class="o">*</span> <span class="n">Qalv</span><span class="p">])</span>
        <span class="n">Mbralvctr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Mbrctr</span><span class="p">,</span> <span class="n">Malvctr</span><span class="p">))</span>
        <span class="n">Mctrbr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">dtn</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">QbrX</span><span class="p">,</span> <span class="n">brTis</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">Kpl_br</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">Mctralv</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtn</span> <span class="o">*</span> <span class="p">(</span><span class="n">Qalv</span> <span class="o">/</span> <span class="n">alvTis</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">Kpl_alv</span><span class="p">)])</span>
        <span class="n">Mctrbralv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Mctrbr</span><span class="p">,</span><span class="n">Mctralv</span><span class="p">))</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">Mbr</span><span class="p">,</span><span class="n">Malv</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Mbralvctr</span><span class="p">,(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))],</span>
                     <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="o">+</span><span class="mi">2</span><span class="p">))],[</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Mctrbralv</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="o">+</span><span class="mi">2</span><span class="p">))]]),</span>
                      <span class="n">Msys</span><span class="p">]])</span>
        <span class="c1"># print(&quot;M&quot;,np.mean(M)); aaaa</span>
        <span class="n">rhsbr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Abrflu</span><span class="p">[</span><span class="n">n</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">dtn</span> <span class="o">*</span> <span class="n">dissolved_br</span><span class="p">],[</span><span class="n">Abrtis</span><span class="p">[</span><span class="n">n</span><span class="p">,:]]])</span>
        <span class="c1"># print(&quot;rhsbr&quot;,np.mean(rhsbr)); aaaa</span>

        <span class="n">mcc</span> <span class="o">=</span> <span class="n">dtn</span> <span class="o">*</span> <span class="n">lambdaX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">int_dx</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Sctr</span><span class="p">,</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]))</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rhsbr</span><span class="p">,(</span><span class="n">rhsbr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>
                              <span class="p">[</span><span class="n">Aalvflu</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtn</span> <span class="o">*</span> <span class="n">dissolved_alv</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">Aalvtis</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span>
                              <span class="p">[</span><span class="n">Asysgut</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">mcc</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">Asysper</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span>
                              <span class="p">[</span><span class="n">Aclear</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span>
                              <span class="p">[</span><span class="n">Asysctr</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
        <span class="c1"># print(&quot;rhs&quot;,np.mean(rhs)); aaaa</span>
        <span class="n">Ynext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
        <span class="c1"># print(&quot;Ynext&quot;,np.mean(Ynext)); aaaa</span>

        <span class="n">Abrflu</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Ynext</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="p">):</span><span class="mi">2</span><span class="p">],(</span><span class="n">Nx</span><span class="p">,))</span>
        <span class="n">Abrtis</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Ynext</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span><span class="p">):</span><span class="mi">2</span><span class="p">],(</span><span class="n">Nx</span><span class="p">,))</span>
        <span class="n">Aalvflu</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span><span class="p">]</span>
        <span class="n">Aalvtis</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Asysgut</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">Asysper</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">Aclear</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">Asysctr</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ynext</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>

        <span class="n">Amcc</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amcc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">mcc</span>

        <span class="c1"># Quality control: detect a violation of CFL condition</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d_Sbnd_Cflubr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ds3D</span><span class="p">),(</span><span class="n">d_Sbnd_Cflubr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">d_Sbnd_Cflubr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>\
              <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">l_dx_pre</span><span class="p">,(</span><span class="n">l_dx_pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">d_Sbnd_Cflubr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">CFL_factor</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtn</span> <span class="o">*</span> <span class="n">aux</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">CFL_factor</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CFL condition not satisfied at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Quality control: detect a negative quantity</span>
        <span class="k">if</span> <span class="n">Asysgut</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Asysgut not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Asysctr</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Asysctr not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Asysper</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Asysper not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rho (br) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Abrflu</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_flu (br) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Abrtis</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_tis (br) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rho (alv) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Aalvflu</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_flu (alv) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Aalvtis</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,:])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_tis (alv) not positive at t=</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Amount of undissolved drug in alveolar space</span>
    <span class="n">Aalvsol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rhoalv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rhoalv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">Aalvsol</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">int_dx</span><span class="p">(</span><span class="n">Sbnd</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Sctr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rhoalv</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">,:],(</span><span class="n">rhoalv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))))</span>
    <span class="c1"># print(&quot;Aalvsol&quot;,np.mean(Aalvsol)); aaaa</span>

    <span class="c1"># Concentration of drug dissolved in alveolar epithelial lining fluid</span>
    <span class="n">Calvflu</span> <span class="o">=</span> <span class="n">Aalvflu</span> <span class="o">/</span> <span class="n">alvELF</span>

    <span class="c1"># Concentration of drug in alveolar lung tissue</span>
    <span class="n">Calvtis</span> <span class="o">=</span>  <span class="n">Aalvtis</span><span class="o">/</span><span class="n">alvTis</span><span class="p">;</span>
    <span class="c1"># print(&quot;Calvflu&quot;,np.mean(Calvflu));</span>
    <span class="c1"># print(&quot;Calvtis&quot;,np.mean(Calvtis)); aaaa</span>

    <span class="c1"># Amount of undissolved drug in conducting airways (bronchial)</span>
    <span class="n">Abrsol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rhobr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rhobr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">Abrsol</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">int_dx1dx2</span><span class="p">(</span><span class="n">Xbnd</span><span class="p">,</span><span class="n">Sbnd</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Sctr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rhobr</span><span class="p">[</span><span class="n">n</span><span class="p">,:,:],(</span><span class="n">rhobr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rhobr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))))</span>
    <span class="c1"># print(&quot;Abrsol&quot;,np.mean(Abrsol));</span>

    <span class="c1"># Concentration of drug dissolved in bronchial epithelial lining fluid</span>
    <span class="n">Cbrflu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Abrflu</span><span class="p">,</span> <span class="n">brELF</span><span class="p">)</span>
    <span class="c1"># print(&quot;Cbrflu&quot;,np.mean(Cbrflu));</span>

    <span class="c1"># Concentration of drug in bronchial lung tissue</span>
    <span class="n">Cbrtis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Abrtis</span><span class="p">,</span> <span class="n">brTis</span><span class="p">)</span>
    <span class="c1"># print(&quot;Cbrtis&quot;,np.mean(Cbrtis)); aaaa</span>

    <span class="c1"># Amounts</span>
    <span class="n">Aalv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;solid&#39;</span><span class="p">:</span> <span class="n">Aalvsol</span><span class="p">,</span>
            <span class="s1">&#39;fluid&#39;</span><span class="p">:</span> <span class="n">Aalvflu</span><span class="p">,</span>
            <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">Aalvtis</span><span class="p">}</span>
    <span class="n">Abr</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;solid&#39;</span><span class="p">:</span> <span class="n">Abrsol</span><span class="p">,</span>
            <span class="s1">&#39;fluid&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Abrflu</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Abrtis</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;clear&#39;</span><span class="p">:</span>  <span class="n">Amcc</span><span class="p">}</span>
    <span class="n">Asys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gut&#39;</span><span class="p">:</span> <span class="n">Asysgut</span><span class="p">,</span>
            <span class="s1">&#39;ctr&#39;</span><span class="p">:</span> <span class="n">Asysctr</span><span class="p">,</span>
            <span class="s1">&#39;per&#39;</span><span class="p">:</span> <span class="n">Asysper</span><span class="p">,</span>
            <span class="s1">&#39;clear&#39;</span><span class="p">:</span>  <span class="n">Aclear</span><span class="p">}</span>

    <span class="n">A</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alv&#39;</span><span class="p">:</span><span class="n">Aalv</span><span class="p">,</span>
         <span class="s1">&#39;br&#39;</span><span class="p">:</span> <span class="n">Abr</span><span class="p">,</span>
         <span class="s1">&#39;sys&#39;</span><span class="p">:</span><span class="n">Asys</span><span class="p">}</span>

    <span class="c1"># Concentrations</span>
    <span class="n">Calv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fluid&#39;</span><span class="p">:</span> <span class="n">Calvflu</span><span class="p">,</span>
            <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">Calvtis</span><span class="p">}</span>
    <span class="n">Cbr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fluid&#39;</span><span class="p">:</span> <span class="n">Cbrflu</span><span class="p">,</span>
           <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">Cbrtis</span><span class="p">}</span>
    <span class="n">Csys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ctr&#39;</span><span class="p">:</span> <span class="n">Asysctr</span> <span class="o">/</span> <span class="n">Vc</span><span class="p">}</span>

    <span class="n">C</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alv&#39;</span><span class="p">:</span> <span class="n">Calv</span><span class="p">,</span>
         <span class="s1">&#39;br&#39;</span><span class="p">:</span> <span class="n">Cbr</span><span class="p">,</span>
         <span class="s1">&#39;sys&#39;</span><span class="p">:</span> <span class="n">Csys</span><span class="p">}</span>

    <span class="c1"># Geometry</span>
    <span class="n">alvgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flu&#39;</span><span class="p">:</span> <span class="n">alvELF</span><span class="p">,</span> <span class="s1">&#39;tis&#39;</span><span class="p">:</span> <span class="n">alvTis</span><span class="p">}}</span>    <span class="c1"># pooled</span>
    <span class="n">brgeom</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flu&#39;</span><span class="p">:</span> <span class="n">aFluX</span><span class="p">,</span>  <span class="s1">&#39;tis&#39;</span><span class="p">:</span> <span class="n">aTisX</span><span class="p">}}</span>     <span class="c1"># location-resolved</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alv&#39;</span><span class="p">:</span> <span class="n">alvgeom</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span><span class="n">brgeom</span><span class="p">}</span>

    <span class="c1"># Discretisation</span>
    <span class="n">grd</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tt</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">Xctr</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">Sctr</span><span class="p">,</span><span class="s1">&#39;dX&#39;</span><span class="p">:</span><span class="n">dx</span><span class="p">,</span><span class="s1">&#39;dS&#39;</span><span class="p">:</span><span class="n">ds</span><span class="p">}</span>
    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Nt&#39;</span><span class="p">:</span><span class="n">Nt</span><span class="p">,</span><span class="s1">&#39;Nx&#39;</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span><span class="s1">&#39;Ns&#39;</span><span class="p">:</span><span class="n">Ns</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">}</span>
    <span class="n">discr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;grid&#39;</span><span class="p">:</span><span class="n">grd</span><span class="p">,</span><span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="n">param</span><span class="p">}</span>

    <span class="c1"># Input</span>
    <span class="n">inpt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lungParams&#39;</span><span class="p">:</span><span class="n">lungParams</span><span class="p">,</span> <span class="s1">&#39;pkLung&#39;</span><span class="p">:</span><span class="n">pkLung</span><span class="p">,</span> <span class="s1">&#39;depositionParams&#39;</span><span class="p">:</span><span class="n">depositionParams</span><span class="p">}</span>

    <span class="c1"># Units (for use e.g. in plotting)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;[nmol]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span>  <span class="s1">&#39;[min]&#39;</span><span class="p">,</span>              <span class="c1"># These units are used con-</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span><span class="s1">&#39;[cm]&#39;</span><span class="p">,</span>               <span class="c1"># sistently across substance /</span>
        <span class="s1">&#39;area&#39;</span><span class="p">:</span>  <span class="s1">&#39;[cm2]&#39;</span><span class="p">,</span>              <span class="c1"># physiological databases,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span><span class="s1">&#39;[cm3]&#39;</span><span class="p">,</span>              <span class="c1"># read_deposition() and systemic</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="s1">&#39;[g]&#39;</span><span class="p">}</span>                <span class="c1"># PK models</span>

    <span class="c1"># complete model output</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;A&#39;</span><span class="p">:</span>    <span class="n">A</span><span class="p">,</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span>    <span class="n">C</span><span class="p">,</span>
        <span class="s1">&#39;geom&#39;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span>
        <span class="s1">&#39;discr&#39;</span><span class="p">:</span><span class="n">discr</span><span class="p">,</span>
        <span class="s1">&#39;input&#39;</span><span class="p">:</span><span class="n">inpt</span><span class="p">,</span>
        <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sol</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../jj_denoise_segmentation_dirPicking_workshop/index.html">jj_denoise_segmentation_dirPicking_workshop</a></dd>
            <dd><a href="../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../release-3.0.0/_modules/pkpd/inhalation.html">release-3.0.0</a></dd>
            <dd><a href="../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
            <dd><a href="../../tomo_picking_tutorial/index.html">tomo_picking_tutorial</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>