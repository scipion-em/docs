

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pwem.protocols.protocol_align_movies &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/appion/appion.html">appion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atomstructutils/atomstructutils.html">atomstructutils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/atsas/atsas.html">atsas package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bamfordlab/bamfordlab.html">bamfordlab package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/bsoft/bsoft.html">bsoft package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/ccp4/ccp4.html">ccp4 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/chimera/chimera.html">chimera package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cistem/cistem.html">cistem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryoef/cryoef.html">cryoef package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cryosparc2/cryosparc2.html">cryosparc2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/dynamo/dynamo.html">dynamo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/eman2/eman2.html">eman2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/emxlib/emxlib.html">emxlib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/fsc3d/fsc3d.html">fsc3d package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gautomatch/gautomatch.html">gautomatch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gctf/gctf.html">gctf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/imod/imod.html">imod package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/localrec/localrec.html">localrec package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/locscale/locscale.html">locscale package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/motioncorr/motioncorr.html">motioncorr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/novactf/novactf.html">novactf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/phenix/phenix.html">phenix package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyworkflow/pyworkflow.html">pyworkflow package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pwem/pwem.html">pwem package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/relion/relion.html">relion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/resmap/resmap.html">resmap package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/scipion/scipion.html">scipion package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/sphire/sphire.html">sphire package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/spider/spider.html">spider package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/tomo/tomo.html">tomo package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/topaz/topaz.html">topaz package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/xmipp3/xmipp3.html">xmipp3 package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../pwem.html">pwem</a> &raquo;</li>
        
      <li>pwem.protocols.protocol_align_movies</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pwem.protocols.protocol_align_movies</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (jmdelarosa@cnb.csic.es)</span>
<span class="c1"># *              Vahid Abrishami (vabrishami@cnb.csic.es)</span>
<span class="c1"># *              Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">izip</span> <span class="o">=</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">ceil</span>

<span class="kn">import</span> <span class="nn">pyworkflow.object</span> <span class="k">as</span> <span class="nn">pwobj</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pyworkflow.gui.plotter</span> <span class="k">import</span> <span class="n">Plotter</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>
<span class="kn">import</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="k">as</span> <span class="nn">pwcts</span>

<span class="kn">import</span> <span class="nn">pwem.objects</span> <span class="k">as</span> <span class="nn">emobj</span>
<span class="kn">from</span> <span class="nn">pwem</span> <span class="k">import</span> <span class="n">emlib</span>

<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtProcessMovies</span>


<div class="viewcode-block" id="ProtAlignMovies"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies">[docs]</a><span class="k">class</span> <span class="nc">ProtAlignMovies</span><span class="p">(</span><span class="n">ProtProcessMovies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for movie alignment protocols such as:</span>
<span class="sd">    motioncorr, crosscorrelation and optical flow</span>

<span class="sd">    Alignment parameters are defined in common. For example,</span>
<span class="sd">    the frames range used for alignment and final sum, the binning factor</span>
<span class="sd">    or the cropping options (region of interest)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -------------------------- DEFINE param functions -----------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">ProtProcessMovies</span><span class="o">.</span><span class="n">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineAlignmentParams</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defineAlignmentParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Alignment&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Frames to ALIGN&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Frames range to ALIGN on each movie. The &#39;</span>
                                  <span class="s1">&#39;first frame is 1. If you set 0 in the final &#39;</span>
                                  <span class="s1">&#39;frame to align, it means that you will &#39;</span>
                                  <span class="s1">&#39;align until the last frame of the movie.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;alignFrame0&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;alignFrameN&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;to&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useAlignToSum&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use ALIGN frames range to SUM?&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If *Yes*, the same frame range will be used to &quot;</span>
                            <span class="s2">&quot;ALIGN and to SUM. If *No*, you can selected a &quot;</span>
                            <span class="s2">&quot;different range for SUM (must be a subset).&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Frames to SUM&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;not useAlignToSum&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Frames range to SUM on each movie. The &#39;</span>
                                  <span class="s1">&#39;first frame is 1. If you set 0 in the final &#39;</span>
                                  <span class="s1">&#39;frame to sum, it means that you will sum &#39;</span>
                                  <span class="s1">&#39;until the last frame of the movie.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;sumFrame0&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;sumFrameN&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;to&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;binFactor&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binning factor&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;1x or 2x. Bin stack before processing.&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Crop offsets (px)&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;cropOffsetX&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;cropOffsetY&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="s1">&#39;Crop dimensions (px)&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;How many pixels to crop from offset</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;If equal to 0, use maximum size.&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;cropDimX&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;cropDimY&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doSaveAveMic&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save aligned micrograph&quot;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">pwcts</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doSaveMovie&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save movie&quot;</span><span class="p">,</span> <span class="n">expertLevel</span><span class="o">=</span><span class="n">pwcts</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save Aligned movie&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------- STEPS functions ----------------------------</span>
<div class="viewcode-block" id="ProtAlignMovies.createOutputStep"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># validate that we have some output movies</span>
        <span class="k">for</span> <span class="n">outName</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">out</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">redStr</span><span class="p">(</span><span class="s2">&quot;All movies failed, didn&#39;t create outputMicrographs.&quot;</span>
                                           <span class="s2">&quot;Please review movie processing steps above.&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">yellowStr</span><span class="p">(</span><span class="s2">&quot;WARNING - Failed to align </span><span class="si">%d</span><span class="s2"> movies.&quot;</span>
                                           <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">)</span> <span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">getSize</span><span class="p">())))</span></div>

    <span class="k">def</span> <span class="nf">_loadOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SetClass</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">fixSampling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the output set if it exists or create a new one.</span>
<span class="sd">        fixSampling: correct the output sampling rate if binning was used,</span>
<span class="sd">        except for the case when the original movies are kept and shifts</span>
<span class="sd">        refers to that one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">baseName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">setFile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">setFile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outputSet</span> <span class="o">=</span> <span class="n">SetClass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">setFile</span><span class="p">)</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">loadAllProperties</span><span class="p">()</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">enableAppend</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputSet</span> <span class="o">=</span> <span class="n">SetClass</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">setFile</span><span class="p">)</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">setStreamState</span><span class="p">(</span><span class="n">outputSet</span><span class="o">.</span><span class="n">STREAM_OPEN</span><span class="p">)</span>

            <span class="n">inputMovies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">inputMovies</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fixSampling</span><span class="p">:</span>
                <span class="n">newSampling</span> <span class="o">=</span> <span class="n">inputMovies</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getBinFactor</span><span class="p">()</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="n">newSampling</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outputSet</span>

    <span class="k">def</span> <span class="nf">_checkNewOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Load previously done items (from text file)</span>
        <span class="n">doneList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readDoneList</span><span class="p">()</span>
        <span class="c1"># Check for newly done items</span>
        <span class="n">newDone</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span>
                   <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doneList</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isMovieDone</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>

        <span class="c1"># Update the file with the newly done movies</span>
        <span class="c1"># or exit from the function if no new done movies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;_checkNewOutput: &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   listOfMovies: </span><span class="si">%s</span><span class="s1">, doneList: </span><span class="si">%s</span><span class="s1">, newDone: </span><span class="si">%s</span><span class="s1">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDone</span><span class="p">)))</span>

        <span class="n">firstTime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">allDone</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doneList</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">newDone</span><span class="p">)</span>
        <span class="c1"># We have finished when there is not more input movies (stream closed)</span>
        <span class="c1"># and the number of processed movies is equal to the number of inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamClosed</span> <span class="ow">and</span> <span class="n">allDone</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">)</span>
        <span class="n">streamMode</span> <span class="o">=</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">Set</span><span class="o">.</span><span class="n">STREAM_CLOSED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="k">else</span> <span class="n">pwobj</span><span class="o">.</span><span class="n">Set</span><span class="o">.</span><span class="n">STREAM_OPEN</span>

        <span class="k">if</span> <span class="n">newDone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_writeDoneList</span><span class="p">(</span><span class="n">newDone</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="c1"># If we are not finished and no new output have been produced</span>
            <span class="c1"># it does not make sense to proceed and updated the outputs</span>
            <span class="c1"># so we exit from the function here</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   finished: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        self.streamClosed (</span><span class="si">%s</span><span class="s1">) AND&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamClosed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        allDone (</span><span class="si">%s</span><span class="s1">) == len(self.listOfMovies (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">allDone</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   streamMode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">streamMode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createOutputMovies</span><span class="p">():</span>
            <span class="n">saveMovie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;doSaveMovie&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">movieSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadOutputSet</span><span class="p">(</span><span class="n">emobj</span><span class="o">.</span><span class="n">SetOfMovies</span><span class="p">,</span> <span class="s1">&#39;movies.sqlite&#39;</span><span class="p">,</span>
                                           <span class="n">fixSampling</span><span class="o">=</span><span class="n">saveMovie</span><span class="p">)</span>

            <span class="c1"># If need to save the movie</span>
            <span class="k">if</span> <span class="n">saveMovie</span><span class="p">:</span>
                <span class="n">movieSet</span><span class="o">.</span><span class="n">setGain</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">movieSet</span><span class="o">.</span><span class="n">setDark</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">newDone</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newMovie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createOutputMovie</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">newMovie</span><span class="o">.</span><span class="n">getAlignment</span><span class="p">()</span><span class="o">.</span><span class="n">getShifts</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">movieSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newMovie</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">yellowStr</span><span class="p">(</span><span class="s2">&quot;WARNING: Movie </span><span class="si">%s</span><span class="s2"> has empty alignment &quot;</span>
                                                <span class="s2">&quot;data, can&#39;t add it to output set.&quot;</span>
                                                <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()))</span>

                <span class="c1"># Warn about any exception creating the movie</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">redStr</span><span class="p">(</span><span class="s2">&quot;ERROR: Movie </span><span class="si">%s</span><span class="s2"> couldn&#39;t be &quot;</span>
                                         <span class="s2">&quot;added to the output set.</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">(),</span> <span class="n">e</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="s1">&#39;outputMovies&#39;</span><span class="p">,</span> <span class="n">movieSet</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">firstTime</span><span class="p">:</span>
                <span class="c1"># Probably is a good idea to store a cached summary for the</span>
                <span class="c1"># first resulting movie of the processing.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_storeSummary</span><span class="p">(</span><span class="n">newDone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># If the movies are not written out, then dimensions can be</span>
                <span class="c1"># copied from the input movies</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">saveMovie</span><span class="p">:</span>
                    <span class="n">movieSet</span><span class="o">.</span><span class="n">setDim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getDim</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="p">,</span> <span class="n">movieSet</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_updateOutputMicSet</span><span class="p">(</span><span class="n">sqliteFn</span><span class="p">,</span> <span class="n">getOutputMicName</span><span class="p">,</span> <span class="n">outputName</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Updated the output micrographs set with new items found. &quot;&quot;&quot;</span>
            <span class="n">micSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadOutputSet</span><span class="p">(</span><span class="n">emobj</span><span class="o">.</span><span class="n">SetOfMicrographs</span><span class="p">,</span> <span class="n">sqliteFn</span><span class="p">)</span>
            <span class="n">doneFailed</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">newDone</span><span class="p">:</span>
                <span class="n">mic</span> <span class="o">=</span> <span class="n">micSet</span><span class="o">.</span><span class="n">ITEM_TYPE</span><span class="p">()</span>
                <span class="n">mic</span><span class="o">.</span><span class="n">copyObjId</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
                <span class="n">mic</span><span class="o">.</span><span class="n">setMicName</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">getMicName</span><span class="p">())</span>
                <span class="c1"># The subclass protocol is responsible of generating the output</span>
                <span class="c1"># micrograph file in the extra path with the required name</span>
                <span class="n">extraMicFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="n">getOutputMicName</span><span class="p">(</span><span class="n">movie</span><span class="p">))</span>
                <span class="n">mic</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">extraMicFn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extraMicFn</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">yellowStr</span><span class="p">(</span><span class="s2">&quot;WARNING: Micrograph </span><span class="si">%s</span><span class="s2"> was not generated, &quot;</span>
                                            <span class="s2">&quot;can&#39;t add it to output set.&quot;</span> <span class="o">%</span> <span class="n">extraMicFn</span><span class="p">))</span>
                    <span class="n">doneFailed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessOutputMicrograph</span><span class="p">(</span><span class="n">mic</span><span class="p">,</span> <span class="n">movie</span><span class="p">)</span>
                <span class="n">micSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mic</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_updateOutputSet</span><span class="p">(</span><span class="n">outputName</span><span class="p">,</span> <span class="n">micSet</span><span class="p">,</span> <span class="n">streamMode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">doneFailed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_writeFailedList</span><span class="p">(</span><span class="n">doneFailed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">firstTime</span><span class="p">:</span>
                <span class="c1"># We consider that Movies are &#39;transformed&#39; into the Micrographs</span>
                <span class="c1"># This will allow to extend the CTF associated to a set of</span>
                <span class="c1"># micrographs to another set of micrographs generated from a</span>
                <span class="c1"># different movie alignment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="p">,</span> <span class="n">micSet</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createOutputMicrographs</span><span class="p">():</span>
            <span class="n">_updateOutputMicSet</span><span class="p">(</span><span class="s1">&#39;micrographs.sqlite&#39;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_getOutputMicName</span><span class="p">,</span>
                                <span class="s1">&#39;outputMicrographs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createOutputWeightedMicrographs</span><span class="p">():</span>
            <span class="n">_updateOutputMicSet</span><span class="p">(</span><span class="s1">&#39;micrographs_dose-weighted.sqlite&#39;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_getOutputMicWtName</span><span class="p">,</span>
                                <span class="s1">&#39;outputMicrographsDoseWeighted&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>  <span class="c1"># Unlock createOutputStep if finished all jobs</span>
            <span class="n">outputStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFirstJoinStep</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">outputStep</span> <span class="ow">and</span> <span class="n">outputStep</span><span class="o">.</span><span class="n">isWaiting</span><span class="p">():</span>
                <span class="n">outputStep</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">pwcts</span><span class="o">.</span><span class="n">STATUS_NEW</span><span class="p">)</span>

    <span class="c1"># --------------------------- INFO functions ------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Only validate about cropDimensions if the protocol supports them</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cropDimX&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cropDimY&#39;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cropDimX</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cropDimY</span>
                 <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cropDimX</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cropDimY</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;If you give cropDimX, you should also give &quot;</span>
                          <span class="s2">&quot;cropDimY and vice versa&quot;</span><span class="p">)</span>

        <span class="n">inputMovies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Do not continue if there ar no movies. Validation message will</span>
        <span class="c1"># take place since attribute is a Pointer.</span>
        <span class="k">if</span> <span class="n">inputMovies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">errors</span>

        <span class="n">firstItem</span> <span class="o">=</span> <span class="n">inputMovies</span><span class="o">.</span><span class="n">getFirstItem</span><span class="p">()</span>

        <span class="n">firstFrame</span><span class="p">,</span> <span class="n">lastFrame</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inputMovies</span><span class="o">.</span><span class="n">getFramesRange</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lastFrame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Although getFirstItem is not recommended in general, here it is</span>
            <span class="c1"># used only once, for validation purposes, so performance</span>
            <span class="c1"># problems should not appear.</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="n">firstItem</span><span class="o">.</span><span class="n">getNumberOfFrames</span><span class="p">()</span>
            <span class="n">lastFrame</span> <span class="o">=</span> <span class="n">frames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="n">lastFrame</span> <span class="o">-</span> <span class="n">firstFrame</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">frames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_validateRange</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="c1"># Avoid validation when the range is not defined</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Frame0&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">):</span>
                    <span class="k">return</span>

                <span class="n">f0</span><span class="p">,</span> <span class="n">fN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFrameRange</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fN</span> <span class="o">&lt;</span> <span class="n">firstFrame</span> <span class="ow">or</span> <span class="n">fN</span> <span class="o">&gt;</span> <span class="n">lastFrame</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Check the selected last frame to *</span><span class="si">%s</span><span class="s2">*. &quot;</span>
                                  <span class="s2">&quot;Last frame (</span><span class="si">%d</span><span class="s2">) should be in range: </span><span class="si">%s</span><span class="s2"> &quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">fN</span><span class="p">,</span> <span class="p">(</span><span class="n">firstFrame</span><span class="p">,</span>
                                                          <span class="n">lastFrame</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">f0</span> <span class="o">&lt;</span> <span class="n">firstFrame</span> <span class="ow">or</span> <span class="n">f0</span> <span class="o">&gt;</span> <span class="n">lastFrame</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Check the selected first frame to *</span><span class="si">%s</span><span class="s2">*. &quot;</span>
                                  <span class="s2">&quot;First frame (</span><span class="si">%d</span><span class="s2">) should be in range: </span><span class="si">%s</span><span class="s2"> &quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">f0</span><span class="p">,</span> <span class="p">(</span><span class="n">firstFrame</span><span class="p">,</span>
                                                          <span class="n">lastFrame</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">fN</span> <span class="o">&lt;</span> <span class="n">f0</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Check the selected frames range to *</span><span class="si">%s</span><span class="s2">*. &quot;</span>
                                  <span class="s2">&quot;Last frame (</span><span class="si">%d</span><span class="s2">) should be greater or equal &quot;</span>
                                  <span class="s2">&quot;than first frame (</span><span class="si">%d</span><span class="s2">)&quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">fN</span><span class="p">,</span> <span class="n">f0</span><span class="p">))</span>

            <span class="n">_validateRange</span><span class="p">(</span><span class="s2">&quot;align&quot;</span><span class="p">)</span>
            <span class="n">_validateRange</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span><span class="o">.</span><span class="n">existsLocation</span><span class="p">(</span><span class="n">firstItem</span><span class="o">.</span><span class="n">getLocation</span><span class="p">()):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The input movie files do not exist!!! &quot;</span>
                          <span class="s2">&quot;Since usually input movie files are symbolic links, &quot;</span>
                          <span class="s2">&quot;please check that links are not broken if you &quot;</span>
                          <span class="s2">&quot;moved the project folder. &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>

    <span class="c1"># --------------------------- INFO functions -------------------------------</span>
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>

    <span class="c1"># --------------------------- UTILS functions ----------------------------</span>
    <span class="k">def</span> <span class="nf">_useAlignToSum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;useAlignToSum&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getFrameRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Params:</span>
<span class="sd">        :param n: Number of frames of the movies</span>
<span class="sd">        :param prefix: what range we want to consider, either &#39;align&#39; or &#39;sum&#39;</span>
<span class="sd">        :return: (i, f) initial and last frame range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In case that the user select the same range for ALIGN and SUM</span>
        <span class="c1"># we also use the &#39;align&#39; prefix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useAlignToSum</span><span class="p">():</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;align&#39;</span>

        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Frame0&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">FrameN&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">last</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span>

    <span class="k">def</span> <span class="nf">_createOutputMovie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="n">movieId</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

        <span class="c1"># Parse the alignment parameters and store the log files</span>
        <span class="n">alignedMovie</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getNumberOfFrames</span><span class="p">()</span>
        <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFrameRange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;align&#39;</span><span class="p">)</span>
        <span class="n">framesRange</span> <span class="o">=</span> <span class="n">alignedMovie</span><span class="o">.</span><span class="n">getFramesRange</span><span class="p">()</span>
        <span class="n">framesRange</span><span class="o">.</span><span class="n">setFirstFrame</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">framesRange</span><span class="o">.</span><span class="n">setLastFrame</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="c1"># Check if user selected to save movie, use the getAttributeValue</span>
        <span class="c1"># function for allow the protocol to not define this flag</span>
        <span class="c1"># and use False as default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;doSaveMovie&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># The subclass protocol is responsible of generating the output</span>
            <span class="c1"># movie file in the extra path with the required name</span>
            <span class="n">extraMovieFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getOutputMovieName</span><span class="p">(</span><span class="n">movie</span><span class="p">))</span>
            <span class="n">alignedMovie</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">extraMovieFn</span><span class="p">)</span>
            <span class="c1"># When the output movies are saved, the shifts</span>
            <span class="c1"># will be set to zero since they are aligned</span>
            <span class="n">totalFrames</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">xshifts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">totalFrames</span>
            <span class="n">yshifts</span> <span class="o">=</span> <span class="n">xshifts</span>
            <span class="c1"># If we save the movies, we need to modify which are the index</span>
            <span class="c1"># of the first frame in the stack, now is 1 since the stack is</span>
            <span class="c1"># written only with the given frames</span>
            <span class="n">firstFrameIndex</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xshifts</span><span class="p">,</span> <span class="n">yshifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMovieShifts</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
            <span class="n">firstFrameIndex</span> <span class="o">=</span> <span class="n">first</span>

        <span class="n">framesRange</span><span class="o">.</span><span class="n">setFirstFrameIndex</span><span class="p">(</span><span class="n">firstFrameIndex</span><span class="p">)</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="n">emobj</span><span class="o">.</span><span class="n">MovieAlignment</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">,</span> <span class="n">xshifts</span><span class="o">=</span><span class="n">xshifts</span><span class="p">,</span>
                                         <span class="n">yshifts</span><span class="o">=</span><span class="n">yshifts</span><span class="p">)</span>

        <span class="n">roiList</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span>
                   <span class="p">[</span><span class="s1">&#39;cropOffsetX&#39;</span><span class="p">,</span> <span class="s1">&#39;cropOffsetY&#39;</span><span class="p">,</span> <span class="s1">&#39;cropDimX&#39;</span><span class="p">,</span> <span class="s1">&#39;cropDimY&#39;</span><span class="p">]]</span>
        <span class="n">alignment</span><span class="o">.</span><span class="n">setRoi</span><span class="p">(</span><span class="n">roiList</span><span class="p">)</span>
        <span class="n">alignedMovie</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">alignment</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">alignedMovie</span>

    <span class="c1"># ---------- Hook functions that need to be implemented in subclasses ------</span>
    <span class="k">def</span> <span class="nf">_getBinFactor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;binFactor&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMovieRoot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="c1"># Try to use the &#39;original&#39; fileName in case it is present</span>
        <span class="c1"># the original could be different from the current filename if</span>
        <span class="c1"># we are dealing with compressed movies (e.g., movie.mrc.bz2)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;_originalFileName&#39;</span><span class="p">,</span>
                                     <span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="c1"># Remove the first extension</span>
        <span class="n">fnRoot</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeBaseExt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="c1"># Check if there is a second extension</span>
        <span class="c1"># (Assuming is is only a dot and 3 or 4 characters after it</span>
        <span class="c1"># Do not perform this check if the file name is short</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnRoot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnRoot</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span> <span class="ow">or</span> <span class="n">fnRoot</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">fnRoot</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">removeExt</span><span class="p">(</span><span class="n">fnRoot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fnRoot</span>

    <span class="k">def</span> <span class="nf">_getOutputMovieName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the output movie.</span>
<span class="sd">        (relative to micFolder)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMovieRoot</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_aligned_movie.mrcs&#39;</span>

    <span class="k">def</span> <span class="nf">_getOutputMicName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the output micrograph</span>
<span class="sd">        (relative to micFolder)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMovieRoot</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_aligned_mic.mrc&#39;</span>

    <span class="k">def</span> <span class="nf">_getOutputMicWtName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the output dose-weighted micrograph</span>
<span class="sd">        (relative to micFolder)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMovieRoot</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_aligned_mic_DW.mrc&#39;</span>

    <span class="k">def</span> <span class="nf">_getOutputMicThumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getMovieRoot</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_thumbnail.png&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getMovieShifts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the x and y shifts for the alignment of this movie.</span>
<span class="sd">         The shifts should refer to the original micrograph without any binning.</span>
<span class="sd">         In case of a binning greater than 1, the shifts should be scaled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_createOutputMovies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if an output set of movies will be generated.</span>
<span class="sd">        The most common case is to always generate output movies,</span>
<span class="sd">        either with alignment only or the binary aligned movie files.</span>
<span class="sd">        Subclasses can override this function to change this behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_createOutputMicrographs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; By default check if the user have selected &#39;doSaveAveMic&#39;</span>
<span class="sd">        property. Subclasses can override this method to implement different</span>
<span class="sd">        behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="s1">&#39;doSaveAveMic&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_createOutputWeightedMicrographs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_preprocessOutputMicrograph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mic</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Hook function that will be call before adding the micrograph</span>
<span class="sd">        to the output set of micrographs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_doComputeMicThumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Should be implemented in sub-classes if want to check</span>
<span class="sd">        the generation of thumbnails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_storeSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement this method if you want to store the summary. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_getCorrectedDose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movieSet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get and correct the pre-exposure dose. It is important for cases</span>
<span class="sd">        in which the first frame is different of one. The method support both</span>
<span class="sd">        movie and sets of movies&quot;&quot;&quot;</span>
        
        <span class="n">firstFrame</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">movieSet</span><span class="o">.</span><span class="n">getFramesRange</span><span class="p">()</span>
        <span class="n">preExp</span> <span class="o">=</span> <span class="n">movieSet</span><span class="o">.</span><span class="n">getAcquisition</span><span class="p">()</span><span class="o">.</span><span class="n">getDoseInitial</span><span class="p">()</span>
        <span class="n">dose</span> <span class="o">=</span> <span class="n">movieSet</span><span class="o">.</span><span class="n">getAcquisition</span><span class="p">()</span><span class="o">.</span><span class="n">getDosePerFrame</span><span class="p">()</span>
        <span class="n">preExp</span> <span class="o">+=</span> <span class="n">dose</span> <span class="o">*</span> <span class="p">(</span><span class="n">firstFrame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">preExp</span><span class="p">,</span> <span class="n">dose</span>
        
    <span class="k">def</span> <span class="nf">__runXmippProgram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal shortcut function to launch a Xmipp program. &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pwem</span> <span class="k">import</span> <span class="n">Domain</span>
        <span class="n">xmipp3</span> <span class="o">=</span> <span class="n">Domain</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;xmipp3&#39;</span><span class="p">)</span>
        <span class="n">xmipp3</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">runXmippProgram</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__runEman2Program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal workaround to launch an EMAN2 program. &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pwem</span> <span class="k">import</span> <span class="n">Domain</span>
        <span class="n">eman2</span> <span class="o">=</span> <span class="n">Domain</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;eman2&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">pyworkflow.utils.process</span> <span class="k">import</span> <span class="n">runJob</span>
        <span class="n">runJob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">,</span> <span class="n">eman2</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(</span><span class="n">program</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span>
               <span class="n">env</span><span class="o">=</span><span class="n">eman2</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getEnviron</span><span class="p">())</span>

<div class="viewcode-block" id="ProtAlignMovies.averageMovie"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.averageMovie">[docs]</a>    <span class="k">def</span> <span class="nf">averageMovie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">inputFn</span><span class="p">,</span> <span class="n">outputMicFn</span><span class="p">,</span> <span class="n">binFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">dark</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">splineOrder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Average a movie (using xmipp) taking into account the</span>
<span class="sd">         possible shifts and other alignment parameters.</span>
<span class="sd">         Params:</span>
<span class="sd">            inputFn: input filename, either the movie file or a metadata</span>
<span class="sd">                with the shifts and other info.</span>
<span class="sd">            dark: dark file</span>
<span class="sd">            gain: gain correction file.</span>

<span class="sd">         The output will be the averaged micrograph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-i </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">inputFn</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;--sampling </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;--useInputShifts &#39;</span>

        <span class="k">if</span> <span class="n">binFactor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;--bin </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">binFactor</span>

        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getDim</span><span class="p">()</span>
            <span class="n">offsetX</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">,</span> <span class="n">cropDimX</span><span class="p">,</span> <span class="n">cropDimY</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="c1"># cropDim value is &lt;= 0 we should take the whole size</span>
            <span class="k">if</span> <span class="n">cropDimX</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dimX</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dimX</span> <span class="o">=</span> <span class="n">offsetX</span> <span class="o">+</span> <span class="n">cropDimX</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">cropDimY</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dimY</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dimY</span> <span class="o">=</span> <span class="n">offsetY</span> <span class="o">+</span> <span class="n">cropDimY</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;--cropULCorner </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;--cropDRCorner </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimX</span><span class="p">,</span> <span class="n">dimY</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --oavg </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">outputMicFn</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --Bspline </span><span class="si">%d</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">splineOrder</span> <span class="k">if</span> <span class="n">splineOrder</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --dark &#39;</span> <span class="o">+</span> <span class="n">dark</span>

        <span class="k">if</span> <span class="n">gain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; --gain &#39;</span> <span class="o">+</span> <span class="n">gain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__runXmippProgram</span><span class="p">(</span><span class="s1">&#39;xmipp_movie_alignment_correlation&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.computePSD"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.computePSD">[docs]</a>    <span class="k">def</span> <span class="nf">computePSD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputMic</span><span class="p">,</span> <span class="n">oroot</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span>  <span class="c1"># 384 = 128 + 256, which should be fast for any Fourier Transformer</span>
                   <span class="n">overlap</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use psd = image.computePSD(overlap=0.4, xdim=384, ydim=384, fftthreads=1) instead&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="n">psdImg1</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inputMic</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">psdImg1</span><span class="o">.</span><span class="n">computePSD</span><span class="p">(</span><span class="n">overlap</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">oroot</span><span class="o">+</span><span class="s2">&quot;.psd&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.composePSDImages"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.composePSDImages">[docs]</a>    <span class="k">def</span> <span class="nf">composePSDImages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psdImg1</span><span class="p">,</span> <span class="n">psdImg2</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">,</span>
                         <span class="n">outputFnUncorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compose a single PSD image:</span>
<span class="sd">         left part from psd1 (uncorrected PSD),</span>
<span class="sd">         right-part from psd2 (corrected PSD)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">psdImg1</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>  <span class="c1"># get the data now, as conversion would change them</span>
        <span class="k">if</span> <span class="n">outputFnUncorrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psdImg1</span><span class="o">.</span><span class="n">convertPSD</span><span class="p">()</span>
            <span class="n">psdImg1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputFnUncorrected</span><span class="p">)</span>

        <span class="n">data2</span> <span class="o">=</span> <span class="n">psdImg2</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>  <span class="c1"># get the data now, as conversion would change them</span>
        <span class="k">if</span> <span class="n">outputFnCorrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psdImg2</span><span class="o">.</span><span class="n">convertPSD</span><span class="p">()</span>
            <span class="n">psdImg2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputFnCorrected</span><span class="p">)</span>

        <span class="c1"># Compute middle index</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">psdImg1</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="n">data1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[:,</span> <span class="p">:</span><span class="n">m</span><span class="p">]</span>
        <span class="n">psdImg1</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
        <span class="n">psdImg1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.composePSD"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.composePSD">[docs]</a>    <span class="k">def</span> <span class="nf">composePSD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd1</span><span class="p">,</span> <span class="n">psd2</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">,</span>
                   <span class="n">outputFnUncorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use composePSDImages() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot; Compose a single PSD image:</span>
<span class="sd">         left part from psd1 (uncorrected PSD),</span>
<span class="sd">         right-part from psd2 (corrected PSD)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composePSDImages</span><span class="p">(</span><span class="n">ih</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">psd1</span><span class="p">),</span> <span class="n">ih</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">psd2</span><span class="p">),</span> <span class="n">outputFn</span><span class="p">,</span>
                              <span class="n">outputFnUncorrected</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.computePSDImages"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.computePSDImages">[docs]</a>    <span class="k">def</span> <span class="nf">computePSDImages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">fnUncorrected</span><span class="p">,</span> <span class="n">fnCorrected</span><span class="p">,</span>
                         <span class="n">outputFnUncorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composePSDImages</span><span class="p">(</span>
            <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fnUncorrected</span><span class="p">)</span><span class="o">.</span><span class="n">computePSD</span><span class="p">(),</span>
            <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fnCorrected</span><span class="p">)</span><span class="o">.</span><span class="n">computePSD</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_getPsdCorr</span><span class="p">(</span><span class="n">movie</span><span class="p">),</span>
            <span class="n">outputFnUncorrected</span><span class="p">,</span>
            <span class="n">outputFnCorrected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.computePSDs"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.computePSDs">[docs]</a>    <span class="k">def</span> <span class="nf">computePSDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">fnUncorrected</span><span class="p">,</span> <span class="n">fnCorrected</span><span class="p">,</span>
                    <span class="n">outputFnUncorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use computePSDImages() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computePSDImages</span><span class="p">(</span><span class="n">movie</span><span class="p">,</span> <span class="n">fnUncorrected</span><span class="p">,</span> <span class="n">fnCorrected</span><span class="p">,</span>
                              <span class="n">outputFnUncorrected</span><span class="p">,</span> <span class="n">outputFnCorrected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtAlignMovies.computeThumbnail"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.computeThumbnail">[docs]</a>    <span class="k">def</span> <span class="nf">computeThumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputFn</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">outputFn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a thumbnail of the input file&quot;&quot;&quot;</span>
        <span class="n">outputFn</span> <span class="o">=</span> <span class="n">outputFn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getThumbnailFn</span><span class="p">(</span><span class="n">inputFn</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inputFn</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot;--fouriershrink </span><span class="si">%s</span><span class="s2"> --process normalize&quot;</span> <span class="o">%</span> <span class="n">scaleFactor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__runEman2Program</span><span class="p">(</span><span class="s1">&#39;e2proc2d.py&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outputFn</span></div>

<div class="viewcode-block" id="ProtAlignMovies.correctGain"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.correctGain">[docs]</a>    <span class="k">def</span> <span class="nf">correctGain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movieFn</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">,</span> <span class="n">gainFn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">darkFn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;correct a movie with both gain and dark images&quot;&quot;&quot;</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">(</span><span class="n">movieFn</span><span class="p">)</span>
        <span class="n">numberOfFrames</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># in case of wrong mrc stacks as volumes</span>

        <span class="k">def</span> <span class="nf">_readImgFloat</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">img</span><span class="o">.</span><span class="n">convert2DataType</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">DT_FLOAT</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>

        <span class="n">gainImg</span> <span class="o">=</span> <span class="n">_readImgFloat</span><span class="p">(</span><span class="n">gainFn</span><span class="p">)</span>
        <span class="n">darkImg</span> <span class="o">=</span> <span class="n">_readImgFloat</span><span class="p">(</span><span class="n">darkFn</span><span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">createImage</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfFrames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">img</span><span class="o">.</span><span class="n">read</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">movieFn</span><span class="p">))</span>
            <span class="n">img</span><span class="o">.</span><span class="n">convert2DataType</span><span class="p">(</span><span class="n">emlib</span><span class="o">.</span><span class="n">DT_FLOAT</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">darkImg</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">inplaceSubtract</span><span class="p">(</span><span class="n">darkImg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gainImg</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">inplaceMultiply</span><span class="p">(</span><span class="n">gainImg</span><span class="p">)</span>

            <span class="n">img</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">outputFn</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProtAlignMovies.getThumbnailFn"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAlignMovies.getThumbnailFn">[docs]</a>    <span class="k">def</span> <span class="nf">getThumbnailFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputFn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the default name for a thumbnail image&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">replaceExt</span><span class="p">(</span><span class="n">inputFn</span><span class="p">,</span> <span class="s2">&quot;thumb.png&quot;</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">_getPsdCorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This should be implemented in subclasses.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_writeFailedList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movieList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write to a text file the items that have failed. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getAllFailed</span><span class="p">(),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movieList</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_readFailedList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read from a text file the id&#39;s of the items that have failed. &quot;&quot;&quot;</span>
        <span class="n">failedFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getAllFailed</span><span class="p">()</span>
        <span class="n">failedList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">failedFile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">failedFile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">failedList</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">failedList</span></div>


<div class="viewcode-block" id="createAlignmentPlot"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.createAlignmentPlot">[docs]</a><span class="k">def</span> <span class="nf">createAlignmentPlot</span><span class="p">(</span><span class="n">meanX</span><span class="p">,</span> <span class="n">meanY</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a plotter with the cumulative shift per frame. &quot;&quot;&quot;</span>
    <span class="n">figureSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">plotter</span> <span class="o">=</span> <span class="n">Plotter</span><span class="p">(</span><span class="o">*</span><span class="n">figureSize</span><span class="p">)</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">getFigure</span><span class="p">()</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cartesian representation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Drift x (pixels)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drift y (pixels)&#39;</span><span class="p">)</span>
    
    <span class="c1"># Max range of the plot of the two coordinates</span>
    <span class="n">plotRange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">meanX</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">meanX</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">meanY</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">meanY</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> 
    <span class="n">skipLabels</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meanX</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">meanX</span><span class="p">,</span> <span class="n">meanY</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">skipLabels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.02</span><span class="o">*</span><span class="n">plotRange</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mf">0.02</span><span class="o">*</span><span class="n">plotRange</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meanX</span><span class="p">,</span> <span class="n">meanY</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meanX</span><span class="p">,</span> <span class="n">meanY</span><span class="p">,</span> <span class="s1">&#39;yo&#39;</span><span class="p">)</span>

    <span class="c1"># setting the plot windows to properly see the data</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">meanX</span><span class="p">)</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">plotRange</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">meanX</span><span class="p">)</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">plotRange</span><span class="p">,</span> 
             <span class="nb">min</span><span class="p">(</span><span class="n">meanY</span><span class="p">)</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">plotRange</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">meanY</span><span class="p">)</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">plotRange</span><span class="p">])</span>
    
    <span class="n">plotter</span><span class="o">.</span><span class="n">tightLayout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">plotter</span></div>


<div class="viewcode-block" id="ProtAverageFrames"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAverageFrames">[docs]</a><span class="k">class</span> <span class="nc">ProtAverageFrames</span><span class="p">(</span><span class="n">ProtAlignMovies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very simple protocol to align all the frames of a given data collection</span>
<span class="sd">    session. It can be used as a sanity check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;average frames&#39;</span>

    <span class="c1"># -------------------------- DEFINE param functions -----------------------</span>
    <span class="k">def</span> <span class="nf">_defineAlignmentParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_processMovie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="n">allFramesSum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;all_frames_sum.mrc&#39;</span><span class="p">)</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="n">sumImg</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">createImage</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">createImage</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getNumberOfFrames</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>

        <span class="n">sumImg</span><span class="o">.</span><span class="n">read</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">img</span><span class="o">.</span><span class="n">read</span><span class="p">((</span><span class="n">frame</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
            <span class="n">sumImg</span><span class="o">.</span><span class="n">inplaceAdd</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">allFramesSum</span><span class="p">):</span>
            <span class="n">img</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">allFramesSum</span><span class="p">)</span>
            <span class="n">sumImg</span><span class="o">.</span><span class="n">inplaceAdd</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">sumImg</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">allFramesSum</span><span class="p">)</span>

    <span class="c1"># FIXME: Methods will change when using the streaming for the output</span>
<div class="viewcode-block" id="ProtAverageFrames.createOutputStep"><a class="viewcode-back" href="../../../api/pwem/pwem.protocols.protocol_align_movies.html#pwem.protocols.protocol_align_movies.ProtAverageFrames.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Really load the input, since in the streaming case we can not</span>
        <span class="c1"># use the self.inputMovies directly</span>
        <span class="n">allFramesSum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;all_frames_sum.mrc&#39;</span><span class="p">)</span>
        <span class="n">allFramesAvg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s1">&#39;all_frames_avg.mrc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputList</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">)</span>

        <span class="n">ih</span> <span class="o">=</span> <span class="n">emlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageHandler</span><span class="p">()</span>
        <span class="n">sumImg</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">allFramesSum</span><span class="p">)</span>
        <span class="n">sumImg</span><span class="o">.</span><span class="n">inplaceDivide</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">sumImg</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">allFramesAvg</span><span class="p">)</span>

        <span class="n">outputAvg</span> <span class="o">=</span> <span class="n">emobj</span><span class="o">.</span><span class="n">Image</span><span class="p">()</span>
        <span class="n">outputAvg</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">allFramesAvg</span><span class="p">)</span>
        <span class="n">outputAvg</span><span class="o">.</span><span class="n">setSamplingRate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfMovies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputAverage</span><span class="o">=</span><span class="n">outputAvg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputMovies</span><span class="p">,</span> <span class="n">outputAvg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_createOutputMovies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if an output set of movies will be generated.</span>
<span class="sd">        The most common case is to always generate output movies,</span>
<span class="sd">        either with alignment only or the binary aligned movie files.</span>
<span class="sd">        Subclasses can override this function to change this behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_createOutputMicrographs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; By default check if the user have selected &#39;doSaveAveMic&#39;</span>
<span class="sd">        property. Subclasses can override this method to implement different</span>
<span class="sd">        behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_createOutputWeightedMicrographs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../dm_facilitiesUpdate/index.html">dm_facilitiesUpdate</a></dd>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/_modules/pwem/protocols/protocol_align_movies.html">release-3.0.0</a></dd>
            <dd><a href="../../../scipion3_instalation/index.html">scipion3_instalation</a></dd>
            <dd><a href="../../../update_scipion_modes/index.html">update_scipion_modes</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>