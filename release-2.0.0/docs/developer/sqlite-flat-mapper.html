

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SqliteFlatMapper &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>SqliteFlatMapper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/sqlite-flat-mapper.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="sqliteflatmapper">
<span id="sqlite-flat-mapper"></span><h1>SqliteFlatMapper<a class="headerlink" href="#sqliteflatmapper" title="Permalink to this headline">¶</a></h1>
<p>It is a class which main responsibility is to persist/retrieve “sets” or
any homogeneous collection of objects in an optimal manner.</p>
<div class="section" id="objects-to-store">
<h2>Objects to store<a class="headerlink" href="#objects-to-store" title="Permalink to this headline">¶</a></h2>
<p>In general any big list/collection with homogeneous content is a good
candidate to be used with the flat mapper. SetOfParticles, SetOfClasses,
SetOfVolumes, and any class that inherits form Set ( at
pyworkflow.object.py) is a good candidate to be persisted with the flat
mapper.</p>
<p>Any other big, homogeneous list, even if it doesn’t extends Set, will
work for the flat mapper.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with an example and follow the complete process. Let’s take
SetOfParticles which is basically a list of <strong>Particle</strong> objects.</p>
<div class="figure align-center">
<img alt="particles_table" src="../../images/particles_table.png" />
</div>
<p>Each of the particles in the set has the same 14 attributes (creation
attribute is never shown in the viewer):</p>
<ul class="simple">
<li>id</li>
<li>enabled</li>
<li>_index</li>
<li>_filename</li>
<li>label</li>
<li>comment</li>
<li>creation</li>
<li>_samplingRate</li>
<li>_acquisition.</li>
<li>_magnification</li>
</ul>
<p>For the sake of simplicity we will take into account only those
attributes mentioned above, ignoring the rest.</p>
<p>Therefore, let’s assume we have in our code something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">persistSetOfParticles</span><span class="p">(</span><span class="n">mySetOfLegoParticles</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">persistSetOfParticles</span><span class="p">(</span><span class="n">setOfParticles</span><span class="p">):</span>

   <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="persisting-process">
<h2>Persisting process<a class="headerlink" href="#persisting-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mapper-creation">
<h3>Mapper creation<a class="headerlink" href="#mapper-creation" title="Permalink to this headline">¶</a></h3>
<p>First thing to use the flat mapper is to instantiate it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">persistSetOfParticles</span><span class="p">(</span><span class="n">mySetOfLegoParticles</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">persistSetOfParticles</span><span class="p">(</span><span class="n">setOfParticles</span><span class="p">):</span>

   <span class="n">flatMapper</span> <span class="o">=</span> <span class="n">SqliteFlatMapper</span><span class="p">(</span><span class="s1">&#39;legoparticles.sqlite&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
</pre></div>
</div>
<p>The constructor of the SqliteFlatMapper needs a dbName parameter
(‘legoparticles.sqlite’ here) that will be the file name for the sqlite
database. During the creation, a connection is established and the
database is created with an empty schema.</p>
</div>
<div class="section" id="storing-the-set">
<h3>Storing the set<a class="headerlink" href="#storing-the-set" title="Permalink to this headline">¶</a></h3>
<p>Now that we have the mapper and and empty database. We can proceed to
store our lego data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">persistSetOfParticles</span><span class="p">(</span><span class="n">mySetOfLegoParticles</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">persistSetOfParticles</span><span class="p">(</span><span class="n">setOfParticles</span><span class="p">):</span>

   <span class="n">flatMapper</span> <span class="o">=</span> <span class="n">SqliteFlatMapper</span><span class="p">(</span><span class="s1">&#39;legoparticles.sqlite&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

   <span class="c1"># Loop through the lego particles</span>
   <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">setOfParticles</span><span class="o">.</span><span class="n">iterItems</span><span class="p">():</span>

       <span class="c1"># Insert a single lego particle.</span>
       <span class="n">flatMapper</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">particle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="schema-generated-by-the-flat-mapper">
<h3>Schema generated by the flat mapper<a class="headerlink" href="#schema-generated-by-the-flat-mapper" title="Permalink to this headline">¶</a></h3>
<p>The first insert call, will trigger the database schema creation. With
the first insert, the mapper sees for the firstime what to store, and is
then when it can create all the tables and metadata needed.</p>
<div class="section" id="objects-table">
<h4>Objects table<a class="headerlink" href="#objects-table" title="Permalink to this headline">¶</a></h4>
<p>The main table that will hold all the values of the set is the
<strong>Objects</strong> table. Every objects table is composed by 2 type of columns:
* Fixed columns (5): This part is common among all databases created by
this mapper. This columns are used to store common attributes regardless
which object is being stored. <strong>id, enabled, label, comment and
creation</strong>. * Variable columns: These columns are specific for each
object, but theirs names do not matches with the object attribute name.
Instead, are named from c1 to cn, being n the number of attributes of
the object to persist</p>
<p>Going back to our case, since our Lego Particle objects have 14
attributes (5 of them are the fixed ones), the Objects table should have
14 fields: 5 fixed + 9 variables (named from c1 to c9).</p>
<p>Let’s have a look at the table:</p>
<div class="figure align-center">
<img alt="sqlflatmapper_1row" src="../../images/sqlflatmapper_1row.png" />
</div>
<p>If you pay attention, you’ll find there is one more variable field than
expected (we see 10 “c” columns). The reason for this is because our
particle object contains another object (_acquisition) and this
generates an extra column.</p>
<p>After inserting the first particle you will see something like this:</p>
<div class="figure align-center">
<img alt="sqlflatmapper_objects_fields" src="../../images/sqlflatmapper_objects_fields.png" />
</div>
<p>As you can see, the values for the first particle object are stored
there, the “fixed” ones and the variable ones too in thee “c” columns.
We can guess that on “c2” the mapper has stored the _filename
(“Runs/000002_ProtImportParticles/extra/micrograph.xmp”) but it’s not
that obvious for other values. The mapper maps the columns “cx” to the
object properties and stores it in the <em>Classes</em> table.</p>
</div>
<div class="section" id="classes-table">
<h4>Classes table<a class="headerlink" href="#classes-table" title="Permalink to this headline">¶</a></h4>
<p>This table serves as a map between the object attributes and the “c”
columns present in the Objects table.</p>
<div class="figure align-center">
<img alt="sqlflatmapper_objects_fields" src="../../images/flatmapper_classes.png" />
</div>
<p>The “label_property” column corresponds to each of the attributes of
our “Particle” objects, and the “column_name” column with the “c”
column used in the Objects table to store the value of that property.</p>
<p>NOTE: The first row (C00) is not present in the Objects table. This
corresponds to the class of the object to instantiate (Particle)</p>
<p>NOTE1: Also, C06 (in our case), corresponds to another object
(Acquisition) that is contained in our Particle object. This field is
present in the Objects table, but its value will always be empty.</p>
</div>
<div class="section" id="properties-table">
<h4>Properties table<a class="headerlink" href="#properties-table" title="Permalink to this headline">¶</a></h4>
<p>Our SetOfParticle, itself, has some attributes that also need to be
persisted.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_samplingRate</span> <span class="o">=</span> <span class="n">Float</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_hasCtf</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ctf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_alignment</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">ALIGN_NONE</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_isPhaseFlipped</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_isAmplitudeCorrected</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_acquisition</span> <span class="o">=</span> <span class="n">Acquisition</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_firstDim</span> <span class="o">=</span> <span class="n">ImageDim</span><span class="p">()</span> <span class="c1"># Dimensions of the first image</span>
</pre></div>
</div>
<p>For a single SetOfParticles (regardless the number of particles in the
set) we have a few values to persist. For this purpose, the “Properties”
table is created, to store those attributes.</p>
<div class="figure align-center">
<img alt="flatMapper_properties.png" src="../../images/flatMapper_properties.png" />
</div>
<p>With this our SetOfParticles should have been persisted in an sqlLite
file.</p>
</div>
</div>
</div>
<div class="section" id="retrieving-process">
<h2>Retrieving process<a class="headerlink" href="#retrieving-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="retrieving-all">
<h3>Retrieving all<a class="headerlink" href="#retrieving-all" title="Permalink to this headline">¶</a></h3>
<p>Imagine now that you need to retrieve the SetOfParticles. For that we
again need an instance of the mapper and ask it to retrieve the set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">myParticles</span> <span class="o">=</span> <span class="n">retrieveSetOfParticles</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">retrieveSetOfParticles</span><span class="p">():</span>

   <span class="n">flatMapper</span> <span class="o">=</span> <span class="n">SqliteFlatMapper</span><span class="p">(</span><span class="s1">&#39;legoparticles.sqlite&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
   <span class="k">return</span> <span class="n">flatMapper</span><span class="o">.</span><span class="n">selectAll</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieving-one">
<h3>Retrieving one<a class="headerlink" href="#retrieving-one" title="Permalink to this headline">¶</a></h3>
<p>If you only want to retrieve one object you can do so using</p>
<p>myParticle = flatMapper.selectById(1234)</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../gh-pages/docs/developer/sqlite-flat-mapper.html">gh-pages</a></dd>
            <dd><a href="sqlite-flat-mapper.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/sqlite-flat-mapper.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>