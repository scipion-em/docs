

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating a protocol &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Creating a protocol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/creating-a-protocol.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="creating-a-protocol">
<span id="id1"></span><h1><a class="toc-backref" href="#id4">Creating a protocol</a><a class="headerlink" href="#creating-a-protocol" title="Permalink to this headline">¶</a></h1>
<p>In Scipion, we define <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> as a processing task that involves the
execution of several steps. Each step can execute Python code or call
external programs to perform specific sub-tasks. When designing a new
protocol, we should provide a clear definition of the protocol inputs
and outputs. The developer of a protocol also needs to take care of
necessary conversions between Scipion-objects to the program files and
parameters. Moreover, the results of the protocol execution should be
registered back as output in the form of Scipion-objects.</p>
<p>We are going to use a 2D classification protocol (maximum likelihood in
Xmipp) as an example to illustrate the development of a new protocol.
This small guide will cover the basics of creating a new protocol. In each
section we will provide links to more detailed information when needed.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#creating-a-protocol" id="id4">Creating a protocol</a><ul>
<li><a class="reference internal" href="#protocol-definition-overview" id="id5">Protocol Definition: overview</a><ul>
<li><a class="reference internal" href="#name-and-inheritance" id="id6">Name and inheritance</a></li>
<li><a class="reference internal" href="#help-icon-message-customization" id="id7">Help icon message customization</a></li>
<li><a class="reference internal" href="#structure-of-a-protocol-class" id="id8">Structure of a protocol class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parameter-definition" id="id9">Parameter definition</a></li>
<li><a class="reference internal" href="#defining-steps" id="id10">Defining Steps</a></li>
<li><a class="reference internal" href="#steps-execution" id="id11">Steps execution</a><ul>
<li><a class="reference internal" href="#converting-inputs" id="id12">Converting Inputs</a></li>
<li><a class="reference internal" href="#executing-programs" id="id13">Executing Programs</a></li>
<li><a class="reference internal" href="#creating-outputs" id="id14">Creating Outputs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#additional-functions-optional" id="id15">Additional Functions (optional)</a><ul>
<li><a class="reference internal" href="#input-validations-and-warnings-customization" id="id16">Input validations and Warnings customization</a></li>
<li><a class="reference internal" href="#citations-summary-and-methods" id="id17">Citations, Summary and Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extra-actions" id="id18">Extra Actions</a><ul>
<li><a class="reference internal" href="#make-the-protocol-available" id="id19">Make the protocol available</a></li>
<li><a class="reference internal" href="#manage-protocol-location-in-protocol-tree" id="id20">Manage protocol location in protocol tree:</a></li>
<li><a class="reference internal" href="#writing-tests-for-your-protocol" id="id21">Writing Tests for your Protocol</a></li>
<li><a class="reference internal" href="#implement-a-viewer" id="id22">Implement a Viewer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#todo" id="id23">TODO</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="protocol-definition-overview">
<h2><a class="toc-backref" href="#id5">Protocol Definition: overview</a><a class="headerlink" href="#protocol-definition-overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="name-and-inheritance">
<h3><a class="toc-backref" href="#id6">Name and inheritance</a><a class="headerlink" href="#name-and-inheritance" title="Permalink to this headline">¶</a></h3>
<p>The first step when developing a protocol is to select the protocol
class name. In this case it is <code class="docutils literal notranslate"><span class="pre">XmippProtML2D</span></code>, following the
convention that all Xmipp protocol names will start by <code class="docutils literal notranslate"><span class="pre">XmippProt</span></code> (we
recommend a similar approach to name protocols from other EM plugins).
In this case our protocol descends from a base class <code class="docutils literal notranslate"><span class="pre">ProtClassify2D</span></code>
which reflects the operation that this protocol performs. The list of protocols and
how they interact with each other can be observed on the
:doc:<a href="#id2"><span class="problematic" id="id3">`</span></a>Scipion EM classes - fig. general EM protocols hierarchy &lt;scipion-em-classes&gt;. The corresponding files
are located in $SCIPION_HOME/pyworkflow/em/protocol.</p>
</div>
<div class="section" id="help-icon-message-customization">
<h3><a class="toc-backref" href="#id7">Help icon message customization</a><a class="headerlink" href="#help-icon-message-customization" title="Permalink to this headline">¶</a></h3>
<p>The Python documentation string following the protocol class line will
serve as help for users. It is very useful to provide a short but
descriptive help message that will quickly give users a sense of
the protocol’s function. If the protocol defines a <code class="docutils literal notranslate"><span class="pre">_label</span></code> class
property (<code class="docutils literal notranslate"><span class="pre">ml2d</span></code> in this example), it will be used as a label to display the protocol in
menus. If not provided, the protocol class name will be used, but this
name is probably less meaningful to final users.</p>
</div>
<div class="section" id="structure-of-a-protocol-class">
<h3><a class="toc-backref" href="#id8">Structure of a protocol class</a><a class="headerlink" href="#structure-of-a-protocol-class" title="Permalink to this headline">¶</a></h3>
<p>The protocol initialization function should receive the
keyword-arguments ( <code class="docutils literal notranslate"><span class="pre">`*kwargs</span></code> ). The arguments should also be passed
to the base class initialization method. This function is the right
place to make variable initialization or similar things.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">XmippProtML2D</span><span class="p">(</span><span class="n">ProtClassify2D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform (multi-reference) 2D-alignment using</span>
<span class="sd">    a maximum-likelihood ( *ML* ) target function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;ml2d&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#--------------- DEFINE param functions ---------------</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#--------------- INSERT steps functions ----------------</span>

    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#--------------- STEPS functions -----------------------</span>

    <span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">runMLStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#--------------- INFO functions -------------------------</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1">#--------------- UTILS functions -------------------------</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>The code above illustrates the skeleton of a protocol class. There are
five main parts of the code:</p>
<ul class="simple">
<li><strong>Parameter definition</strong>: Defines all the parameters that
will appear in the GUI and that will be attributes of the protocol instance.</li>
<li><strong>Steps list</strong>: Prepares the list of steps that will be executed in
order to complete the protocol.</li>
<li><strong>Steps functions</strong>: Contains the code that wil lbe executed (Python code
or call to external programs)</li>
<li><strong>Validation and info functions</strong>: Decorates the protocol class by providing
parameter validation and some useful information to the user.</li>
<li><strong>Other utils functions</strong>: Varies from protocol to
protocol; it will contain helper functions to be used throughout the
protocol code.</li>
</ul>
<p>In the following sections we are going to more thoroughly explain each of these
parts in order to develop a fully functional protocol.</p>
</div>
</div>
<div class="section" id="parameter-definition">
<h2><a class="toc-backref" href="#id9">Parameter definition</a><a class="headerlink" href="#parameter-definition" title="Permalink to this headline">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">_defineParams(form)</span></code> method, the protocol’s form will be
populated with the input parameters, which also will be rendered
graphically. Regarding the protocol corresponding GUI, Scipion provides a base
protocol graphic interface which corresponds approximately with the upper half of
the image below. Then, the graphical components are dynamically added as
they are defined by the user (explained below).</p>
<p>All these parameters will be available as the protocol’s
attribute that can be used in the protocol steps. Moreover, they should
have a unique name inside the protocol and a type (from among the ones defined in
Scipion framework). There are two groups of parameters:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><strong>Simple parameters</strong>: Basic input parameter types.</dt>
<dd><ul class="first last">
<li><code class="docutils literal notranslate"><span class="pre">__StringParam__</span></code>: A basic string input (a textbox in the GUI)</li>
<li><code class="docutils literal notranslate"><span class="pre">__FloatParam__</span></code>: Floating point input value (a textbox in the GUI, but
should have a floating point format)</li>
<li><code class="docutils literal notranslate"><span class="pre">__IntParam__</span></code>: An integer (a textbox in the GUI, but should have
an integer format)</li>
<li><code class="docutils literal notranslate"><span class="pre">__BooleanParam__</span></code>: A boolean value, or True or False (a Yes/No
question in the GUI)</li>
<li><code class="docutils literal notranslate"><span class="pre">__EnumParam__</span></code>: Also an integer input, but with a small number
of possible choices (a combobox or a list in the GUI)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Complex parameters</strong>:</dt>
<dd><ul class="first last">
<li><code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>: Selects objects from the database
(a text box with a search button in the GUI)</li>
<li><code class="docutils literal notranslate"><span class="pre">__RelationParam__</span></code>: similar to <code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>, but will select
relationships instead of objects (mainly used for CTF browsing)</li>
<li><code class="docutils literal notranslate"><span class="pre">__ProtocolClassParam__</span></code>: similar to <code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>, but will select
protocol classes (used for Workflows, under development)</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Parameters can be added with the
<code class="docutils literal notranslate"><span class="pre">form.addParam(paramName,</span> <span class="pre">paramClass,</span> <span class="pre">**kwargs)</span></code> method. <code class="docutils literal notranslate"><span class="pre">paramClass</span></code>
should be one of the classes listed above and the <code class="docutils literal notranslate"><span class="pre">`*kwargs</span></code> are passed to
the constructor. Valid options in the <code class="docutils literal notranslate"><span class="pre">`*kwargs</span></code> dictionary are:</p>
<ul class="simple">
<li><strong>default</strong> : Default parameter value</li>
<li><strong>condition</strong> : A string representing an expression (whose values are
substituted later) that determines whether the parameter appears.</li>
<li><strong>label</strong> : A label message that will be displayed in the GUI</li>
<li><strong>help</strong> : Usually a more extended help message that will pop up after
clicking on a help icon.</li>
<li><strong>choices</strong> : A list of strings with the display values for the combobox
( Only valid for <code class="docutils literal notranslate"><span class="pre">__EnumParam__</span></code>)</li>
<li><strong>display</strong> : can be <code class="docutils literal notranslate"><span class="pre">_EnumParam.DISPLAY__LIST__</span></code> or
<code class="docutils literal notranslate"><span class="pre">_EnumParam.DISPLAY__COMBO__</span></code>, and defined the preferred display mode for
GUI.( Only valid for`` __EnumParam__``)</li>
<li><strong>pointerClass</strong> : Class of the objects that will be
selected from the database ( Only valid for <code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>)</li>
<li><strong>pointerCondition</strong> : A string expression to filter the
selected objects from the database (such as <code class="docutils literal notranslate"><span class="pre">aligned=True</span></code>, Only valid
for <code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>)</li>
<li><strong>allowsNull</strong> : A boolean. If true, this parameter is not required (
Only valid for <code class="docutils literal notranslate"><span class="pre">__PointerParam__</span></code>)</li>
</ul>
<p>To improve the organization of the input parameters, they can be grouped
into sections, groups, or lines.</p>
<ul class="simple">
<li><strong>Section</strong>: The function <a class="reference internal" href="../../api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.Form.addSection" title="pyworkflow.protocol.params.Form.addSection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addSection</span></code></a> will create
a new section (that will be visualized as a new tab in the GUI), and all
further calls to <code class="docutils literal notranslate"><span class="pre">form.addParam</span></code> will add parameters to that section.</li>
<li><strong>Group</strong>: The function <a class="reference internal" href="../../api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.Form.addGroup" title="pyworkflow.protocol.params.Form.addGroup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addGroup</span></code></a> will return a
<a class="reference internal" href="../../api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.Group" title="pyworkflow.protocol.params.Group"><code class="xref py py-class docutils literal notranslate"><span class="pre">Group</span></code></a> object that can also add parameters to it. The group will be
displayed as a labeled frame in the GUI.</li>
<li><strong>Line</strong>: Another way of grouping is through <a class="reference internal" href="../../api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.Form.addLine" title="pyworkflow.protocol.params.Form.addLine"><code class="xref py py-meth docutils literal notranslate"><span class="pre">addLine(lineLabel)</span></code></a>,
which will return a <a class="reference internal" href="../../api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.Line" title="pyworkflow.protocol.params.Line"><code class="xref py py-class docutils literal notranslate"><span class="pre">Line</span></code></a> object that can
also contain other parameters. It will simply display those parameters in the same row.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Params&#39;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                   <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input particles&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the input images from the project.&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doGenerateReferences&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Generate references?&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If you set to *No*, you should provide references images&#39;</span>
                       <span class="s1">&#39;If *Yes*, the default generation is done by averaging&#39;</span>
                       <span class="s1">&#39;subsets of the input images. (less bias introduced)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfReferences&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                  <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doGenerateReferences&#39;</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of references:&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of references to be generated.&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputReferences&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                  <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doGenerateReferences&#39;</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference image(s)&quot;</span><span class="p">,</span>
                  <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Image(s) that will serve as initial 2D references&#39;</span><span class="p">)</span>

    <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doMlf&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use MLF2D instead of ML2D?&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;ML-Fourier&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doMlf&#39;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>The line <cite>form.addParallelSection(threads=2, mpi=4)</cite> specifies the
number of threads and MPI that will be used by default in this protocol.
If not set, both thread and MPI are equal to 1. Setting thread or MPI
with a 0 value here will mean that it is not possible to use it and
will be hidden in the GUI. More about the parallelization of protocols
can be found in <span class="xref std std-doc">Parallelization&lt;protocol-parallelization</span>.</p>
<p>The above definition will generate a desktop GUI as shown in the
following figure:</p>
<div class="figure">
<img alt="../../images/ml2d_form.png" src="../../images/ml2d_form.png" />
</div>
</div>
<div class="section" id="defining-steps">
<h2><a class="toc-backref" href="#id10">Defining Steps</a><a class="headerlink" href="#defining-steps" title="Permalink to this headline">¶</a></h2>
<p>Another important function is <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code>, in which the steps
that will be executed when the user click on pushbutton <strong>Execute</strong> of the protocol GUI are defined.
This function is only invoked before a protocol starts to run and the following actions take place:</p>
<ul class="simple">
<li>The method <code class="docutils literal notranslate"><span class="pre">protocol.run()</span></code> is called</li>
<li>The <code class="docutils literal notranslate"><span class="pre">protocol._insertAllSteps()</span></code> is called and a list of steps is populated (depending on the current
parameters selection)</li>
<li>The steps list is compared with previous steps lists in the database (if exists a previous execution) and,</li>
<li>If in RESUME mode, it will try to continue from the last step that was completed
successfully. (In RESTART mode it will start from the first step and
output directory is cleaned)</li>
</ul>
<p>It is important to note that no computing tasks should be performed in the <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code>
function this should be done in the steps; see next section). This place is only to <em>DEFINE</em>
what needs to be done, not actually to do it.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Step</span></code> class represents the smallest execution unit that composes a
<code class="docutils literal notranslate"><span class="pre">Protocol</span></code>. The most used sub-classes of <code class="docutils literal notranslate"><span class="pre">Step</span></code> are:</p>
<ul class="simple">
<li><strong>FunctionStep</strong> : Inserted using the function
<code class="docutils literal notranslate"><span class="pre">protocol._insertFunctionStep</span></code>. Any accessible function can be
inserted; it could be a function of the protocol or an external
function. The changes in the parameters passed to the function are used
to detect step changes, so even when it may not be necessary to pass
certain parameters, it is useful to pass them for detecting changes.</li>
<li><strong>RunJobStep</strong> : this step wraps a call to an external program and
builds the necessary command line arguments. It can be inserted using
<code class="docutils literal notranslate"><span class="pre">protocol._insertRunJobStep</span></code></li>
</ul>
<p>In our example protocol, the <code class="docutils literal notranslate"><span class="pre">_insertAllSteps</span></code> function looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertInputStep&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
    <span class="n">program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMLProgram</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getMLParams</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertRunJobStep</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createOutputStep&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a relatively simple case (but also a common one) in which only three
steps are inserted: <code class="docutils literal notranslate"><span class="pre">convertInputStep</span></code>, <code class="docutils literal notranslate"><span class="pre">runJobStep</span></code>,
<code class="docutils literal notranslate"><span class="pre">createOutputStep</span></code>. In this case, the steps run in the same order
in which they were inserted, but it is also possible to define a more complex
dependency graph between steps that can be executed in parallel (through
threads or MPI). You can read more about defining steps to be executed
in parallel in <a class="reference internal" href="parallelization.html"><span class="doc">Parallelization</span></a>.</p>
<p>Even when a protocol runs its steps without parallelization, one
particular step can take advantage of a multiprocessor and use MPI or
threads in a particular program command line.</p>
</div>
<div class="section" id="steps-execution">
<h2><a class="toc-backref" href="#id11">Steps execution</a><a class="headerlink" href="#steps-execution" title="Permalink to this headline">¶</a></h2>
<div class="section" id="converting-inputs">
<h3><a class="toc-backref" href="#id12">Converting Inputs</a><a class="headerlink" href="#converting-inputs" title="Permalink to this headline">¶</a></h3>
<p>It is common that one of the first steps in a protocol is
<code class="docutils literal notranslate"><span class="pre">convertInputStep</span></code>, whose main task is to convert from input Scipion
objects to files with the format that is appropriate for running a
particular program. In our example, we should convert the input
<code class="docutils literal notranslate"><span class="pre">SetOfParticles</span></code> object into the metadata star file that is required
by all Xmipp programs that operates on particles. In this classification
protocol, it is also possible to provide a set of reference images.
This is also taken into account in the <code class="docutils literal notranslate"><span class="pre">convertInputStep</span></code> function and
also writes metadata for the references if needed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convertInputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputId</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write the input images as a Xmipp metadata file. &quot;&quot;&quot;</span>
    <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;input_particles&#39;</span><span class="p">))</span>
    <span class="c1"># If input references, also convert to xmipp metadata</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doGenerateReferences</span><span class="p">:</span>
        <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputReferences</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;input_references&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">writeSetOfParticles</span></code> function iterates over each individual image
in the input <code class="docutils literal notranslate"><span class="pre">SetOfParticles</span></code> and adds a line to a valid STAR file
using the Xmipp MetaData class in Python. By the same logic, any other
file format could be generated when writting a <code class="docutils literal notranslate"><span class="pre">convertInputStep</span></code>
function. Read more about iterating over a <code class="docutils literal notranslate"><span class="pre">SetOfParticles</span></code> and
querying its attributes in <a class="reference internal" href="using-sets.html"><span class="doc">Using Sets</span></a>.</p>
</div>
<div class="section" id="executing-programs">
<h3><a class="toc-backref" href="#id13">Executing Programs</a><a class="headerlink" href="#executing-programs" title="Permalink to this headline">¶</a></h3>
<p>The second step function in this example is a <code class="docutils literal notranslate"><span class="pre">runJobStep</span></code>. In this
case the program is <code class="docutils literal notranslate"><span class="pre">xmipp_ml_align2d</span></code> (or mlf in the Fourier case). The
command line argument for calling the program is prepared in the
<code class="docutils literal notranslate"><span class="pre">_getMLParams</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_getMLParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Mainly prepare the command line for call ml(f)2d program&quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39; -i </span><span class="si">%s</span><span class="s1"> --oroot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;input_particles&#39;</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_getOroot</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doGenerateReferences</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="s1">&#39; --nref </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfReferences</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputReferences</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="s1">&#39; --ref </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;input_references&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfReferences</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputReferences</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">())</span>

    <span class="o">...</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doMirror</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="s1">&#39; --mirror&#39;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doNorm</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="s1">&#39; --norm&#39;</span>

    <span class="k">return</span> <span class="n">params</span>
</pre></div>
</div>
<p>As you can see, this function will concatenate the arguments passed to
the program in the command line. The arguments will vary depending on the
current selection of input parameters in the Scipion GUI. The same
approach can be followed when executing a program from any other
software package.</p>
<p>If we take a look at the output logs files after executing this
protocol, we can see a command line similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpirun -np <span class="m">2</span> -bynode <span class="sb">`</span>which xmipp_mpi_ml_align2d<span class="sb">`</span>
-i Runs/000194_XmippProtML2D/tmp/input_particles.xmd
--oroot Runs/000194_XmippProtML2D/ml2d_ --ref Runs/000194_XmippProtML2D/tmp/input_references.xmd
--fast --thr <span class="m">2</span> --iter <span class="m">3</span> --mirror
</pre></div>
</div>
</div>
<div class="section" id="creating-outputs">
<h3><a class="toc-backref" href="#id14">Creating Outputs</a><a class="headerlink" href="#creating-outputs" title="Permalink to this headline">¶</a></h3>
<p>At the end of a protocol execution, we want to register the results in
the Scipion project. This is the function of the <code class="docutils literal notranslate"><span class="pre">createOutputStep</span></code>
method. It is the inverse operation of the
<code class="docutils literal notranslate"><span class="pre">convertInputStep</span></code>. It should read the files produced by the
protocol and create the Scipion objects that represent the output of the
protocol. It should also define the relationship between the newly created
output objects and the input.</p>
<p>In our case, the result of the protocol is a <code class="docutils literal notranslate"><span class="pre">SetOfClasses2D</span></code>, which
is created by the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">imgSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">classes2DSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfClasses2D</span><span class="p">(</span><span class="n">imgSet</span><span class="p">)</span>
    <span class="n">readSetOfClasses2D</span><span class="p">(</span><span class="n">classes2DSet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;output_classes&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputClasses</span><span class="o">=</span><span class="n">classes2DSet</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="n">imgSet</span><span class="p">,</span> <span class="n">classes2DSet</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doGenerateReferences</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputReferences</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">classes2DSet</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the job is done by the functions <code class="docutils literal notranslate"><span class="pre">_createSetOfClasses2D</span></code> and
<code class="docutils literal notranslate"><span class="pre">readSetOfClasses2D</span></code>. The first one creates an empty set of
classes, while the second is specific to Xmipp and populates the set
reading the classes’ information from the Xmipp metadata outputs (STAR
files). More information about creating Scipion sets objects can be
found in link:UsingSets[Developers - Using Sets].</p>
<p>Although the creating output step is normally specific of each protocol, some common cases
are populating the empty object with data read from the generated output, as explained in the
previous paragraph, or, if the input and output objects are of the same type, use them to fill
the output empty object and update the corresponding attributes, like the image filename, for
example.</p>
<p>A good help for a better understanding of how to define the outputs generated as
Scipion objects are:</p>
<ul class="simple">
<li><a class="reference internal" href="object-model.html"><span class="doc">Object model</span></a>.</li>
<li><a class="reference internal" href="scipion-em-classes.html"><span class="doc">Scipion EM classes - fig. data objects diagram</span></a>.</li>
</ul>
<p>Definitions are located in $SCIPION_HOME/pyworkflow/em/data.py</p>
<p>Once the outputs have been correctly created as Scipion objects, it is necessary to specify them
as outputs, which can be done using method <code class="docutils literal notranslate"><span class="pre">_defineOutputs</span></code>. Finally, the relation or transformation
between the source and the destination objects should be defined. This can be carried out with methods
<code class="docutils literal notranslate"><span class="pre">_defineSourceRelation</span></code>, <code class="docutils literal notranslate"><span class="pre">_defineTransformRelation</span></code> or <code class="docutils literal notranslate"><span class="pre">_defineCtfRelation</span></code>, depending on the
objects implied in the protocol.</p>
</div>
</div>
<div class="section" id="additional-functions-optional">
<h2><a class="toc-backref" href="#id15">Additional Functions (optional)</a><a class="headerlink" href="#additional-functions-optional" title="Permalink to this headline">¶</a></h2>
<p>There are some functions that not are strictly required when
implementing a protocol. Nevertheless, they can provide useful
information to the final user. All these functions will return a list of
strings, whose meaning is different in each case.</p>
<div class="section" id="input-validations-and-warnings-customization">
<h3><a class="toc-backref" href="#id16">Input validations and Warnings customization</a><a class="headerlink" href="#input-validations-and-warnings-customization" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">_validate</span></code> and <code class="docutils literal notranslate"><span class="pre">_warnings</span></code> methods will be called just before a
protocol is executed. Both could return a list of string messages,
meaning that are some errors (or possible errors) in the input
parameters. If the returned list is empty means that everything is fine
and the protocol can run. The <code class="docutils literal notranslate"><span class="pre">_warnings</span></code> will show the messages to
the user but give it the choice to continue or not. If there are errors
from the <em>``_validate``</em>, the protocol will not run. This can save time
to users because prevent simple errors that can be critical for the
protocol to run properly.</p>
<p>In our example, the <code class="docutils literal notranslate"><span class="pre">_validate</span></code> function is very simple. It checks that
the input particles have a CTF estimation if using maximum likelihood
in Fourier space. The <code class="docutils literal notranslate"><span class="pre">_warnings</span></code> method can be implemented in a
similar way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doMlf</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">hasCTF</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Input particles does not have CTF information.</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;This is required when using ML in fourier space.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span>
</pre></div>
</div>
</div>
<div class="section" id="citations-summary-and-methods">
<h3><a class="toc-backref" href="#id17">Citations, Summary and Methods</a><a class="headerlink" href="#citations-summary-and-methods" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">_citations</span></code> function is the way to provide references to the
methods used in the protocols. The returned list should contain the
keys of the citation reference. All the references for a specific
software package are listed in bibtex format in a file called
<strong>bibtex.py</strong>. Read more about this file in this guide to
<a class="reference internal" href="creating-a-plugin.html"><span class="doc">create a plugin</span></a>.</p>
<p>In this case, there is a reference for the whole protocol and some extra
references are added depending on whether some variants are activated. The
citation will be displayed in the GUI as links to each publication. They
can be shown using the <img alt="cite-icon" src="../../images/cite_icon.png" /> from the protocol
header in the form GUI or in the project windows in the <strong>Methods</strong> tab of
the selected protocol.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">cites</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Scheres2005a&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doMlf</span><span class="p">:</span>
        <span class="n">cites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scheres2007b&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">doFast</span><span class="p">:</span>
        <span class="n">cites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scheres2005b&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doNorm</span><span class="p">:</span>
        <span class="n">cites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scheres2009b&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cites</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">_summary</span></code> function should provide a quick overview of a particular
protocol execution. It should check whether the protocol has not
finished its execution yet or, when finished, it has to provide some
brief information about the steps performed, outputs, quality, or any
other relevant information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nParticles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
    <span class="n">nReferences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfReferences</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Number of input images: *</span><span class="si">%d</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="n">nParticles</span><span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Classified into *</span><span class="si">%d</span><span class="s1">* classes&#39;</span> <span class="o">%</span> <span class="n">nReferences</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doMlf</span><span class="p">:</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- Used a ML in _Fourier-space_&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">doFast</span><span class="p">:</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- Used _fast_, reduced search-space approach&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doNorm</span><span class="p">:</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- Refined _normalization_ for each experimental image&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">_methods</span></code> function should be implemented in a way similar to
<code class="docutils literal notranslate"><span class="pre">_summary</span></code> but should provide more descriptive information about the
execution. The text should be thorough enough to be used as a template for
a <code class="docutils literal notranslate"><span class="pre">_Materials</span></code> and <code class="docutils literal notranslate"><span class="pre">methods_</span></code> section of a paper.</p>
</div>
</div>
<div class="section" id="extra-actions">
<h2><a class="toc-backref" href="#id18">Extra Actions</a><a class="headerlink" href="#extra-actions" title="Permalink to this headline">¶</a></h2>
<p>These should be done while developing and testing your protocol, not at the very end of the process.</p>
<div class="section" id="make-the-protocol-available">
<h3><a class="toc-backref" href="#id19">Make the protocol available</a><a class="headerlink" href="#make-the-protocol-available" title="Permalink to this headline">¶</a></h3>
<p>The protocol classes that are available in Scipion are discovered
dynamically using Python reflection tools. So, when a new protocol class
is added, it is automatically available to the whole system.</p>
</div>
<div class="section" id="manage-protocol-location-in-protocol-tree">
<h3><a class="toc-backref" href="#id20">Manage protocol location in protocol tree:</a><a class="headerlink" href="#manage-protocol-location-in-protocol-tree" title="Permalink to this headline">¶</a></h3>
<p>If you want your protocol to appear in an specific position in the protocol tree in the left pane of the
projects GUI, you may need to do some configuration setup.
This is performed with the <a class="reference internal" href="creating-a-plugin.html#protocols-conf"><span class="std std-ref">protocols.conf file</span></a>.</p>
</div>
<div class="section" id="writing-tests-for-your-protocol">
<h3><a class="toc-backref" href="#id21">Writing Tests for your Protocol</a><a class="headerlink" href="#writing-tests-for-your-protocol" title="Permalink to this headline">¶</a></h3>
<p>Writing tests is the best way to develop from the beginning. It will
help to cover different use cases of your functions (or protocols in
this case). It they are run automatically, they will help to detect bugs
introduced in future changes.</p>
<p>Here is the test for this protocol:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestXmippML2D</span><span class="p">(</span><span class="n">TestXmippBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class check if the protocol to classify with ML2D</span>
<span class="sd">       in Xmipp works properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">setupTestProject</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">TestXmippBase</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="s1">&#39;mda&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">protImport</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">runImportParticles</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">particlesFn</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ml2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;Run ML2D&quot;</span>
        <span class="n">protML2D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newProtocol</span><span class="p">(</span><span class="n">XmippProtML2D</span><span class="p">,</span>
                                   <span class="n">numberOfReferences</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxIters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                   <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">protML2D</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protImport</span><span class="o">.</span><span class="n">outputParticles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launchProtocol</span><span class="p">(</span><span class="n">protML2D</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">protML2D</span><span class="o">.</span><span class="n">outputClasses</span><span class="p">,</span> <span class="s2">&quot;There was a problem with ML2D&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="implement-a-viewer">
<h3><a class="toc-backref" href="#id22">Implement a Viewer</a><a class="headerlink" href="#implement-a-viewer" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Viewer</span></code> class is the base for implementing visualization of
different kinds of objects. The same applies for visualizing protocols. The
viewers are also discovered dynamically, like the protocols are. They should
specify a <code class="docutils literal notranslate"><span class="pre">_target</span></code> property with a list of the object classes that the
viewer is able to handle.</p>
<p>The details for developing a new viewer will be described in
<a class="reference internal" href="creating-a-viewer.html"><span class="doc">How to develop Viewers</span></a>.</p>
</div>
</div>
<div class="section" id="todo">
<h2><a class="toc-backref" href="#id23">TODO</a><a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Review all :doc: directives and add content to the empty ones</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../gh-pages/docs/developer/creating-a-protocol.html">gh-pages</a></dd>
            <dd><a href="creating-a-protocol.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/creating-a-protocol.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>