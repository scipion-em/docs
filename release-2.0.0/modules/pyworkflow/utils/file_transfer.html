

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyworkflow.utils.file_transfer &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../static/jquery.js"></script>
        <script type="text/javascript" src="../../../static/underscore.js"></script>
        <script type="text/javascript" src="../../../static/doctools.js"></script>
        <script type="text/javascript" src="../../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyworkflow.utils.file_transfer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyworkflow.utils.file_transfer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Apr 8, 2013</span>

<span class="sd">@author: antonio</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># This file is not really being used, and its tests cannot run because</span>
<span class="c1"># of this. So far we are not really using paramiko, and so all its</span>
<span class="c1"># dependencies are broken.</span>
<span class="c1">#</span>
<span class="c1"># I am commenting out all of them today. If used in the future, please</span>
<span class="c1"># fix. If not, please remove this file (remote.py) and test_remote.py</span>
<span class="c1">#</span>
<span class="c1"># Jordi. June 2014.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="c1"># import paramiko</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="k">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.path</span> <span class="k">import</span> <span class="n">missingPaths</span><span class="p">,</span> <span class="n">makeFilePath</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.log</span> <span class="k">import</span> <span class="n">ScipionLogger</span>

<span class="n">LOCAL_USER_AND_HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">SSH_PORT</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">PAIRS_SEPARATOR</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">ScipionLogger</span><span class="p">()</span>


<div class="viewcode-block" id="FileTransfer"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer">[docs]</a><span class="k">class</span> <span class="nc">FileTransfer</span><span class="p">:</span>
    
    <span class="n">ssh</span> <span class="o">=</span> <span class="kc">None</span>   
    <span class="n">sftp</span> <span class="o">=</span> <span class="kc">None</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No dependence on paramiko yet&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># # Default ssh session options.</span>
        <span class="c1"># self.ssh = paramiko.SSHClient()</span>
        <span class="c1"># self.ssh.load_system_host_keys()</span>
        <span class="c1"># self.ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span>

<div class="viewcode-block" id="FileTransfer.transferFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.transferFiles">[docs]</a>    <span class="k">def</span> <span class="nf">transferFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">filePaths</span><span class="p">,</span> 
                      <span class="n">hostsPasswords</span><span class="p">,</span> 
                      <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filePaths -- Files dictionary with this format: &quot;userName@hostName:absolute_file_path&quot;: [&quot;userName1@hostName1:absolute_file_path1&quot;, &quot;userName2@hostName2:absolute_file_path2&quot;]</span>
<span class="sd">        Key is the source file path and value the target file paths.</span>
<span class="sd">        gatewayHosts -- Gateway hosts dictionary with this format: &quot;{userName1@hostName1:userName2@hostName2&quot;:[&quot;userName3@hostName3&quot;,&quot;userName4@hostName4&quot;]}</span>
<span class="sd">        hostsPasswords -- Passwords needed to connect to involved hosts with this format: &quot;userName@hostName&quot;:&quot;hostPassword&quot;</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.        </span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">classifiedFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__classifyFilePaths</span><span class="p">(</span><span class="n">filePaths</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">userAndHostPairs</span><span class="p">,</span> <span class="n">cursorFilePaths</span> <span class="ow">in</span> <span class="n">classifiedFiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">gatewayHostsCredentials</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">gatewayHosts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">userAndHostPairs</span> <span class="ow">in</span> <span class="n">gatewayHosts</span><span class="p">:</span>
                <span class="n">gatewayHostsCredentials</span> <span class="o">=</span> <span class="n">gatewayHosts</span><span class="p">[</span><span class="n">userAndHostPairs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sendFilesBetweenPairs</span><span class="p">(</span><span class="n">userAndHostPairs</span><span class="p">,</span> 
                                         <span class="n">cursorFilePaths</span><span class="p">,</span>
                                         <span class="n">hostsPasswords</span><span class="p">,</span> 
                                         <span class="n">gatewayHostsCredentials</span><span class="p">,</span> 
                                         <span class="n">numberTrials</span><span class="p">,</span>                        
                                         <span class="n">forceOperation</span><span class="p">,</span>
                                         <span class="n">operationId</span><span class="p">)</span> </div>
    
<div class="viewcode-block" id="FileTransfer.copyFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.copyFiles">[docs]</a>    <span class="k">def</span> <span class="nf">copyFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">filePaths</span><span class="p">,</span>                        
                  <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filePaths -- Files dictionary with this format: &quot;source_file_path&quot;: &quot;target_file_path&quot;</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.        </span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__copyLocalFile</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="FileTransfer.transferFilesTo"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.transferFilesTo">[docs]</a>    <span class="k">def</span> <span class="nf">transferFilesTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">filePaths</span><span class="p">,</span>
                        <span class="n">hostName</span><span class="p">,</span>
                        <span class="n">userName</span><span class="p">,</span>
                        <span class="n">hostPassword</span><span class="p">,</span>
                        <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filePaths -- Files dictionary with this format: &quot;source_file_path&quot;: &quot;target_file_path&quot;</span>
<span class="sd">        hostName -- Remote host to transfer files.</span>
<span class="sd">        username -- User name for remote host.</span>
<span class="sd">        hostsPassword -- Passwords needed to connect to involved host.</span>
<span class="sd">        gatewayHosts -- Gateway hosts List with this format: [&quot;userName1@hostName1&quot;,&quot;userName2@hostName2&quot;]</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.        </span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create ssh session to remote host</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostPassword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sendLocalFile</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">,</span> <span class="n">gatewayHosts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  </div>
            
<div class="viewcode-block" id="FileTransfer.transferFilesFrom"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.transferFilesFrom">[docs]</a>    <span class="k">def</span> <span class="nf">transferFilesFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">filePaths</span><span class="p">,</span>
                          <span class="n">hostName</span><span class="p">,</span>
                          <span class="n">userName</span><span class="p">,</span>
                          <span class="n">hostPassword</span><span class="p">,</span>
                          <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filePaths -- Files dictionary with this format: &quot;source_file_path&quot;: &quot;target_file_path&quot;</span>
<span class="sd">        hostName -- Remote host to transfer files.</span>
<span class="sd">        username -- User name for remote host.</span>
<span class="sd">        hostsPassword -- Passwords needed to connect to involved host.</span>
<span class="sd">        gatewayHosts -- Gateway hosts List with this format: [&quot;userName1@hostName1&quot;,&quot;userName2@hostName2&quot;]</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.        </span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create ssh session to remote host</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostPassword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__getRemoteFile</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">,</span> <span class="n">gatewayHosts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  </div>
                
<div class="viewcode-block" id="FileTransfer.deleteFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.deleteFiles">[docs]</a>    <span class="k">def</span> <span class="nf">deleteFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">filePaths</span><span class="p">,</span>                    
                    <span class="n">hostsPasswords</span><span class="p">,</span> 
                    <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                    <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a list of file paths.</span>
<span class="sd">        filepaths -- List of file paths to remove with this format: &quot;userName@hostName:absolute_file_path&quot;</span>
<span class="sd">        gatewayHosts -- Gateway hosts dictionary with this format: &quot;userName1@hostName1:userName2@hostName2&quot;:&quot;userName@hostName&quot;</span>
<span class="sd">        hostsPasswords -- Passwords needed to connect to involved hosts with this format: &quot;userName@hostName&quot;:&quot;hostPassword&quot;</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.</span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># As we are going to create a session for each target host we must get different target hosts.</span>
        <span class="n">userAndHosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDiferentHostsFromFilePaths</span><span class="p">(</span><span class="n">filePaths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">userAndHost</span> <span class="ow">in</span> <span class="n">userAndHosts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">):</span>
                <span class="n">resultFilePaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getFilePaths</span><span class="p">(</span><span class="n">filePaths</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">)</span>
                <span class="c1"># Recover host credentials to remove files</span>
                <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hostName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">hostPassword</span> <span class="o">=</span> <span class="n">hostsPasswords</span><span class="p">[</span><span class="n">userAndHost</span><span class="p">]</span>
                <span class="c1"># Create ssh session to remote host</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostPassword</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">resultFilePath</span> <span class="ow">in</span> <span class="n">resultFilePaths</span><span class="p">:</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">resultFilePath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting file &quot;</span> <span class="o">+</span> <span class="n">filePath</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span></div>
            
<div class="viewcode-block" id="FileTransfer.deleteDirectories"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.deleteDirectories">[docs]</a>    <span class="k">def</span> <span class="nf">deleteDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">directoryPaths</span><span class="p">,</span>                    
                          <span class="n">hostsPasswords</span><span class="p">,</span> 
                          <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                          <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a list of directory paths.</span>
<span class="sd">        directoryPaths -- List of file paths to remove with this format: &quot;userName@hostName:absolute_directory_path&quot;</span>
<span class="sd">        gatewayHosts -- Gateway hosts dictionary with this format: &quot;userName1@hostName1:userName2@hostName2&quot;:&quot;userName@hostName&quot;</span>
<span class="sd">        hostsPasswords -- Passwords needed to connect to involved hosts with this format: &quot;userName@hostName&quot;:&quot;hostPassword&quot;</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.</span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># As we are going to create a session for each target host we must get different target hosts.</span>
        <span class="n">userAndHosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDiferentHostsFromFilePaths</span><span class="p">(</span><span class="n">directoryPaths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">userAndHost</span> <span class="ow">in</span> <span class="n">userAndHosts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">):</span>
                <span class="n">resultDirectoryPaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getFilePaths</span><span class="p">(</span><span class="n">directoryPaths</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">)</span>
                <span class="c1"># Recover host credentials to remove files</span>
                <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hostName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">hostPassword</span> <span class="o">=</span> <span class="n">hostsPasswords</span><span class="p">[</span><span class="n">userAndHost</span><span class="p">]</span>
                <span class="c1"># Create ssh session to remote host</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostPassword</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">resultDirectoryPath</span> <span class="ow">in</span> <span class="n">resultDirectoryPaths</span><span class="p">:</span>
                    <span class="n">directoryName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">resultDirectoryPath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting directory &quot;</span> <span class="o">+</span> <span class="n">directoryName</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span></div>
        
<div class="viewcode-block" id="FileTransfer.checkFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.checkFiles">[docs]</a>    <span class="k">def</span> <span class="nf">checkFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                   <span class="n">filePaths</span><span class="p">,</span>                   
                   <span class="n">hostsPasswords</span><span class="p">,</span>
                   <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if file paths exists.</span>
<span class="sd">        filepaths -- List of file paths to check with this format: &quot;userName@hostName:absolute_file_path&quot;</span>
<span class="sd">        gatewayHosts -- Gateway hosts dictionary with this format: &quot;userName1@hostName1:userName2@hostName2&quot;:&quot;userName@hostName&quot;</span>
<span class="sd">        hostsPasswords -- Passwords needed to connect to involved hosts with this format: &quot;userName@hostName&quot;:&quot;hostPassword&quot;</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.</span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        returns -- List of not located file paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returnFilePaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># As we are going to create a session for each target host we must get different target hosts.</span>
        <span class="n">userAndHosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDiferentHostsFromFilePaths</span><span class="p">(</span><span class="n">filePaths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">userAndHost</span> <span class="ow">in</span> <span class="n">userAndHosts</span><span class="p">:</span>
            <span class="n">resultFilePaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getFilePaths</span><span class="p">(</span><span class="n">filePaths</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">resultFilePath</span> <span class="ow">in</span> <span class="n">resultFilePaths</span><span class="p">:</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">resultFilePath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking: &quot;</span> <span class="o">+</span> <span class="n">filePath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingPaths</span><span class="p">(</span><span class="n">filePath</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">returnFilePaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check fail!!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1"># Recover host credentials</span>
                <span class="n">userName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hostName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">hostPassword</span> <span class="o">=</span> <span class="n">hostsPasswords</span><span class="p">[</span><span class="n">userAndHost</span><span class="p">]</span>
                <span class="c1"># Create ssh session to remote host</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostPassword</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">resultFilePath</span> <span class="ow">in</span> <span class="n">resultFilePaths</span><span class="p">:</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">resultFilePath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking: &quot;</span> <span class="o">+</span> <span class="n">filePath</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>                    
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                        <span class="n">returnFilePaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultFilePath</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check fail!!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
        <span class="k">return</span> <span class="n">returnFilePaths</span></div>
    
<div class="viewcode-block" id="FileTransfer.checkOneHostFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.FileTransfer.checkOneHostFiles">[docs]</a>    <span class="k">def</span> <span class="nf">checkOneHostFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">filePaths</span><span class="p">,</span>
                          <span class="n">hostName</span><span class="p">,</span>
                          <span class="n">userName</span><span class="p">,</span>
                          <span class="n">hostsPassword</span><span class="p">,</span>
                          <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if file paths exists.</span>
<span class="sd">        filepaths -- List of file paths to check with this format: [&quot;absolute_file_path1&quot;,&quot;absolute_file_path2&quot;]</span>
<span class="sd">        gatewayHosts -- Gateway hosts dictionary with this format: &quot;userName1@hostName1:userName2@hostName2&quot;:&quot;userName@hostName&quot;</span>
<span class="sd">        hostsPasswords -- Passwords needed to connect to involved hosts with this format: &quot;userName@hostName&quot;:&quot;hostPassword&quot;</span>
<span class="sd">        numberTrials -- Number of trials in error cases.</span>
<span class="sd">        forceOperation -- Flag to indicate if, when an error happens and number of trials is exceeded, the operation must continue with the rest of files.</span>
<span class="sd">        operationId -- Operation identifier.</span>
<span class="sd">        returns -- List of not located file paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returnFilePaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**************************************** CHECKING******************************************&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to: &quot;</span> <span class="o">+</span> <span class="n">userName</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">hostName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">SSH_PORT</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">hostsPassword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
        
        <span class="n">isLocalHost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalHost</span><span class="p">(</span><span class="n">hostName</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking: &quot;</span> <span class="o">+</span> <span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isLocalHost</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingPaths</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">returnFilePaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check fail!!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>                    
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="n">returnFilePaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check fail!!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">returnFilePaths</span></div>
    
    <span class="k">def</span> <span class="nf">__classifyFilePaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePaths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify file paths to send depending on the source and target user/host involved credentials.</span>
<span class="sd">        filePaths -- Files dictionary with this format: &quot;userName@hostName:absolute_file_path&quot;: [userName1@hostName1:absolute_file_path1, userName2@hostName2:absolute_file_path2]</span>
<span class="sd">        Key is the source file path and value the target file paths.</span>
<span class="sd">        returns -- Dictionary with file paths ordered by the two user/host credentials that are involved. The dictionary will have this structure:</span>
<span class="sd">        {&quot;userName1@hostName1:userName2@hostName2&quot; : {&quot;filePath1&quot;:&quot;filePath2&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">sourcePath</span><span class="p">,</span> <span class="n">targetPaths</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">targetPath</span> <span class="ow">in</span> <span class="n">targetPaths</span><span class="p">:</span>
                <span class="n">sourceParts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">sourcePath</span><span class="p">)</span>
                <span class="n">targetParts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">targetPath</span><span class="p">)</span> 
                <span class="n">sourceUserAndHost</span> <span class="o">=</span> <span class="n">sourceParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">targetUserAndHost</span> <span class="o">=</span> <span class="n">targetParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sourceFilePath</span> <span class="o">=</span> <span class="n">sourceParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">targetFilePath</span> <span class="o">=</span> <span class="n">targetParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resultKey</span> <span class="o">=</span> <span class="n">sourceUserAndHost</span> <span class="o">+</span> <span class="n">PAIRS_SEPARATOR</span> <span class="o">+</span> <span class="n">targetUserAndHost</span>
                <span class="n">auxDict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">resultKey</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">auxDict</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">resultKey</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sourceFilePath</span> <span class="ow">in</span> <span class="n">auxDict</span><span class="p">:</span>
                        <span class="c1"># This will not happen in Scipion because one source path is not going</span>
                        <span class="c1"># to be sent to different file paths in the same machine.</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;File &#39;</span> <span class="o">+</span> <span class="n">sourcePath</span> <span class="o">+</span> <span class="s1">&#39; can not be sent to &#39;</span> <span class="o">+</span> <span class="n">auxDict</span><span class="p">[</span><span class="n">sourcePath</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; and to &quot;</span> <span class="o">+</span> <span class="n">targetPath</span> <span class="o">+</span> <span class="s1">&#39; because they are in the same machine.&#39;</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">auxDict</span><span class="p">[</span><span class="n">sourceFilePath</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetFilePath</span>
                <span class="n">result</span><span class="p">[</span><span class="n">resultKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxDict</span>
        
        <span class="k">return</span> <span class="n">result</span>
            
    <span class="k">def</span> <span class="nf">__sendFilesBetweenPairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                <span class="n">userAndHostPairs</span><span class="p">,</span> 
                                <span class="n">filePaths</span><span class="p">,</span>
                                <span class="n">hostsPasswords</span><span class="p">,</span> 
                                <span class="n">gatewayHosts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">numberTrials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">forceOperation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">operationId</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filePaths -- Dictionary with this structure: {&quot;filePath1&quot;:&quot;filePath2&quot;}</span>
<span class="sd">        gatewayHosts -- Gateway hosts List with this format: [&quot;userName1@hostName1&quot;,&quot;userName2@hostName2&quot;] </span>
<span class="sd">        TODO: Get the target directories to check it existence and create them only once.</span>
<span class="sd">        &quot;&quot;&quot;</span>     
        <span class="n">pairParts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHosts</span><span class="p">(</span><span class="n">userAndHostPairs</span><span class="p">)</span>
        <span class="n">sourceCredentials</span> <span class="o">=</span> <span class="n">pairParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">targetCredentials</span> <span class="o">=</span> <span class="n">pairParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># We see what type of sending operation is.        </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">sourceCredentials</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">targetCredentials</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copyFiles</span><span class="p">(</span><span class="n">filePaths</span><span class="p">,</span> <span class="n">numberTrials</span><span class="p">,</span> <span class="n">forceOperation</span><span class="p">,</span> <span class="n">operationId</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targetUserAndHost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">targetCredentials</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transferFilesTo</span><span class="p">(</span><span class="n">filePaths</span><span class="p">,</span> <span class="n">targetUserAndHost</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">targetUserAndHost</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hostsPasswords</span><span class="p">[</span><span class="n">targetCredentials</span><span class="p">],</span>
                                     <span class="n">gatewayHosts</span><span class="p">,</span> <span class="n">numberTrials</span><span class="p">,</span> <span class="n">forceOperation</span><span class="p">,</span> <span class="n">operationId</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sourceUserAndHost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">sourceCredentials</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">targetCredentials</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transferFilesFrom</span><span class="p">(</span><span class="n">filePaths</span><span class="p">,</span> <span class="n">sourceUserAndHost</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sourceUserAndHost</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">hostsPasswords</span><span class="p">[</span><span class="n">sourceCredentials</span><span class="p">],</span> <span class="n">gatewayHosts</span><span class="p">,</span>
                                       <span class="n">numberTrials</span><span class="p">,</span> <span class="n">forceOperation</span><span class="p">,</span> <span class="n">operationId</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>            
            
    <span class="k">def</span> <span class="nf">__getUserAndHosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userAndHostPairs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Separate user and host pair in their individuals.</span>
<span class="sd">        userAndHostPairs -- User and host pair: &quot;userName1@hostName1:userName2@hostName2&quot;</span>
<span class="sd">        returns -- Spplited pairs: [&quot;userName1@hostName1&quot;, &quot;userName2@hostName2&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">userAndHostPairs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">PAIRS_SEPARATOR</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__getUserAndHost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get the user and the host name from &#39;userName@hostName&#39; string</span>
<span class="sd">        Returns: Tuple with (&#39;userName&#39;, &#39;hostName&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">userAndHost</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__getLocationAndFilePath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locationAndFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get the user and the userName@hostName and file path from &#39;userName@hostname:filePath&#39; string</span>
<span class="sd">        Returns: Tuple with (&#39;userName@hostName&#39;, &#39;filePath&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">locationAndFile</span><span class="p">:</span>
            <span class="n">auxLocationAndFile</span> <span class="o">=</span> <span class="n">locationAndFile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">auxLocationAndFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">auxLocationAndFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOCAL_USER_AND_HOST</span>  <span class="c1"># Ease classification and other operations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auxLocationAndFile</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">auxLocationAndFile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LOCAL_USER_AND_HOST</span><span class="p">)</span>
            <span class="n">auxLocationAndFile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locationAndFile</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">auxLocationAndFile</span>
    
    <span class="k">def</span> <span class="nf">__isLocalHost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if one host name is local machine name.</span>
<span class="sd">        No name or empty name means local host.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hostName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="n">hostName</span> <span class="o">==</span> <span class="n">LOCAL_USER_AND_HOST</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">==</span> <span class="n">hostName</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__isLocalCredential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if one userName@hostName credential is about local machine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">userAndHost</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">userAndHost</span> <span class="o">==</span> <span class="n">LOCAL_USER_AND_HOST</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hostName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getUserAndHost</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalHost</span><span class="p">(</span><span class="n">hostName</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__getDiferentHostsFromFilePaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePaths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets different userName@hostName credentials of files list.</span>
<span class="sd">        files -- File list with this format: userName1@hostName1:absolute_file_path1</span>
<span class="sd">        returns -- List with different files userName@hostName credentials.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">differentHosts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filePath</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="p">:</span>
            <span class="n">userAndHost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isLocalCredential</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">):</span>
                <span class="n">userAndHost</span> <span class="o">=</span> <span class="n">LOCAL_USER_AND_HOST</span>  <span class="c1"># To simplify code for local credentials.</span>
            <span class="k">if</span> <span class="n">userAndHost</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">differentHosts</span><span class="p">:</span>
                <span class="n">differentHosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userAndHost</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">differentHosts</span>
    
    <span class="k">def</span> <span class="nf">__getFilePaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePaths</span><span class="p">,</span> <span class="n">userAndHost</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a file path from a list of target file paths for the given user and host.</span>
<span class="sd">        filePaths -- List of files with this format: &quot;useName@hostName:/filePath&quot;</span>
<span class="sd">        userAndHost -- String with this format. &quot;userName@hostName&quot; </span>
<span class="sd">        returns -- Target file path list (&quot;useName@hostName:/filePath&quot;) for the given user and host.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="n">resultFilePaths</span> <span class="o">=</span> <span class="p">[]</span>             
        <span class="k">for</span> <span class="n">filePath</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="p">:</span>
            <span class="n">locationAndFilePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocationAndFilePath</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">locationAndFilePath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">userAndHost</span><span class="p">:</span>
                <span class="n">resultFilePaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resultFilePaths</span>
    
    <span class="k">def</span> <span class="nf">__copyLocalFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send local file to remote machine</span>
<span class="sd">        sourceFilePath -- Source file path (/file path/...).</span>
<span class="sd">        targetFilePath -- Target file path (/file path/...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying &quot;</span> <span class="o">+</span> <span class="n">sourceFilePath</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="n">targetFilePath</span><span class="p">)</span>
        <span class="c1"># Check if file already existsFilePath and it is up to date</span>
        <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocalSHA1</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocalSHA1</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">):</span>
                <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">targetFilePath</span> <span class="o">+</span> <span class="s2">&quot; already existed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existsFilePath</span><span class="p">:</span>
            <span class="n">makeFilePath</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__sendLocalFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">,</span> <span class="n">gatewayHosts</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send local file to remote machine</span>
<span class="sd">        sourceFilePath -- Source file path (/file path/...).</span>
<span class="sd">        targetFilePath -- Target file path (/file path/...).</span>
<span class="sd">        sftp -- sftp connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending &quot;</span> <span class="o">+</span> <span class="n">sourceFilePath</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="n">targetFilePath</span><span class="p">)</span>
        <span class="c1"># Check if file already existsFilePath and it is up to date</span>
        <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__existsRemotePath</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocalSHA1</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getRemoteSHA1</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="p">):</span>
                <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">targetFilePath</span> <span class="o">+</span> <span class="s2">&quot; already existed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existsFilePath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__createRemoteFolderForFile</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">,</span> <span class="n">sftp</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Fail sending local file &quot;</span> <span class="o">+</span> <span class="n">sourceFilePath</span> <span class="o">+</span>
                          <span class="s2">&quot; to remote file &quot;</span> <span class="o">+</span> <span class="n">targetFilePath</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">raise</span>
        
    <span class="k">def</span> <span class="nf">__getRemoteFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">,</span> <span class="n">gatewayHosts</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send local file to remote machine</span>
<span class="sd">        sourceFilePath -- Source file path (/file path/...).</span>
<span class="sd">        targetFilePath -- Target file path (/file path/...).</span>
<span class="sd">        sftp -- sftp connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting &quot;</span> <span class="o">+</span> <span class="n">sourceFilePath</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="n">targetFilePath</span><span class="p">)</span>
        <span class="c1"># Check if file already existsFilePath and it is up to date</span>
        <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getRemoteSHA1</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLocalSHA1</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">):</span>
                <span class="n">existsFilePath</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">targetFilePath</span> <span class="o">+</span> <span class="s2">&quot; already existed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existsFilePath</span><span class="p">:</span>
            <span class="n">makeFilePath</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sourceFilePath</span><span class="p">,</span> <span class="n">targetFilePath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Fail getting remote file &quot;</span> <span class="o">+</span> <span class="n">sourceFilePath</span> <span class="o">+</span>
                          <span class="s2">&quot; to local file &quot;</span> <span class="o">+</span> <span class="n">targetFilePath</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">__createRemoteFolderForFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create folder for file in remote host defined by sfpt.</span>
<span class="sd">        filePath -- File path which parent directory we must create (/file path/...).</span>
<span class="sd">        sftp -- Remote sftp session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filePathParentDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mkdirP</span><span class="p">(</span><span class="n">filePathParentDirectory</span><span class="p">,</span> <span class="n">sftp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mkdirP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remoteDirectory</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create remote folder structure creating all non-existent folders.</span>
<span class="sd">        remoteDirectory -- Remote directory to create.</span>
<span class="sd">        sftp -- Remote sftp session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__existsRemotePath</span><span class="p">(</span><span class="n">remoteDirectory</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mkdirP</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">remoteDirectory</span><span class="p">),</span> <span class="n">sftp</span><span class="p">)</span>
            <span class="n">sftp</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">remoteDirectory</span><span class="p">)</span> 
            
    <span class="k">def</span> <span class="nf">__getLocalSHA1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getRemoteSHA1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">ssh</span><span class="p">):</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;sha1sum &#39;&quot;</span> <span class="o">+</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> 
            
    <span class="k">def</span> <span class="nf">__existsRemotePath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">sftp</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sftp</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>            
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1">#                AUXILIARY FUNCTIONS</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="isRemoteDir"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.isRemoteDir">[docs]</a><span class="k">def</span> <span class="nf">isRemoteDir</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if one remote directory exists</span>
<span class="sd">    Params:</span>
<span class="sd">        sftp: Sftp session.</span>
<span class="sd">        path: Path to check.</span>
<span class="sd">    Returns: True if the given path is a directory, false if it is not a directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No dependence on paramiko yet&#39;</span><span class="p">)</span></div>
    <span class="c1">#</span>
    <span class="c1"># try:</span>
    <span class="c1">#     sftp.chdir(path)</span>
    <span class="c1">#     return True</span>
    <span class="c1"># except (IOError, paramiko.SFTPError):</span>
    <span class="c1">#     return False</span>


<div class="viewcode-block" id="getRemoteFolderFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.getRemoteFolderFiles">[docs]</a><span class="k">def</span> <span class="nf">getRemoteFolderFiles</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">folderPath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Recover all files in the given folder.</span>
<span class="sd">    Params:</span>
<span class="sd">        hostName: Remote host name.</span>
<span class="sd">        userName: User name.</span>
<span class="sd">        password: Password.</span>
<span class="sd">        folderPath: Folder to get files.</span>
<span class="sd">        recursive: if True go recursively inside other subfolders.</span>
<span class="sd">    Returns: List of files.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No dependence on paramiko yet&#39;</span><span class="p">)</span></div>
    <span class="c1">#</span>
    <span class="c1"># # Default ssh session options.</span>
    <span class="c1">#</span>
    <span class="c1"># ssh = paramiko.SSHClient()</span>
    <span class="c1"># ssh.load_system_host_keys()</span>
    <span class="c1"># ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span>
    <span class="c1"># ssh.connect(hostName, 22, userName, password)</span>
    <span class="c1"># sftp = ssh.open_sftp()</span>
    <span class="c1"># remoteFiles = getRemoteFiles(sftp, folderPath, recursive)</span>
    <span class="c1"># sftp.close()</span>
    <span class="c1"># ssh.close()</span>
    <span class="c1"># return remoteFiles</span>


<div class="viewcode-block" id="getRemoteFiles"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.getRemoteFiles">[docs]</a><span class="k">def</span> <span class="nf">getRemoteFiles</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">folderPath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Recover all files in the given folder.</span>
<span class="sd">    Params:</span>
<span class="sd">        sftp: Sftp session.</span>
<span class="sd">        folderPath: Folder to get files.</span>
<span class="sd">        recursive: if True go recursively inside other subfolders.</span>
<span class="sd">    Returns: List of files.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">filePathList</span> <span class="o">=</span> <span class="n">sftp</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)</span>
    <span class="n">resultFilePathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filePath</span> <span class="ow">in</span> <span class="n">filePathList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isRemoteDir</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">folderPath</span><span class="p">,</span> <span class="n">filePath</span><span class="p">))</span> <span class="ow">and</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">resultFilePathList</span> <span class="o">+=</span> <span class="n">getRemoteFiles</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">folderPath</span><span class="p">,</span> <span class="n">filePath</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultFilePathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folderPath</span><span class="p">,</span> <span class="n">filePath</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">resultFilePathList</span></div>


<div class="viewcode-block" id="removeRemoteFolder"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.removeRemoteFolder">[docs]</a><span class="k">def</span> <span class="nf">removeRemoteFolder</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">folderPath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes a remote folder and all it content.</span>
<span class="sd">    Params:</span>
<span class="sd">        hostName: Remote host name.</span>
<span class="sd">        userName: User name.</span>
<span class="sd">        password: Password.</span>
<span class="sd">        folderPath: Folder to delete.</span>
<span class="sd">    Returns: </span>
<span class="sd">        Tuple with standard input, standard output and error output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No dependence on paramiko yet&#39;</span><span class="p">)</span></div>
    <span class="c1">#</span>
    <span class="c1"># ssh = paramiko.SSHClient()</span>
    <span class="c1"># ssh.load_system_host_keys()</span>
    <span class="c1"># ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span>
    <span class="c1"># ssh.connect(hostName, 22, userName, password)</span>
    <span class="c1"># return removeTree(ssh, folderPath)</span>


<div class="viewcode-block" id="removeTree"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.removeTree">[docs]</a><span class="k">def</span> <span class="nf">removeTree</span><span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">folderPath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Removes a remote folder and all it content.</span>
<span class="sd">    Params:</span>
<span class="sd">        ssh: Ssh session.</span>
<span class="sd">        folderPath: Folder to delete.</span>
<span class="sd">    Returns: </span>
<span class="sd">        Tuple with standard input, standard output and error output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;rm -dfr &quot;</span> <span class="o">+</span> <span class="n">folderPath</span><span class="p">)</span>
    <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span></div>


<div class="viewcode-block" id="getFilePathList"><a class="viewcode-back" href="../../../api/pyworkflow.utils.file_transfer.html#pyworkflow.utils.file_transfer.getFilePathList">[docs]</a><span class="k">def</span> <span class="nf">getFilePathList</span><span class="p">(</span><span class="n">filePaths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get target file paths list from target file path dictionary.</span>
<span class="sd">    filePaths -- Files dictionary with this format: &quot;userName@hostName:absolute_file_path&quot;: [&quot;userName1@hostName1:absolute_file_path1&quot;, &quot;userName2@hostName2:absolute_file_path2&quot;]</span>
<span class="sd">    returns -- List of target files with this format: &quot;useName@hostName:/filePath&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resultFilePathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filePathList</span> <span class="ow">in</span> <span class="n">filePaths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">filePath</span> <span class="ow">in</span> <span class="n">filePathList</span><span class="p">:</span>
            <span class="n">resultFilePathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resultFilePathList</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="file_transfer.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>