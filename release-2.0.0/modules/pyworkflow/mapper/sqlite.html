

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyworkflow.mapper.sqlite &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../static/jquery.js"></script>
        <script type="text/javascript" src="../../../static/underscore.js"></script>
        <script type="text/javascript" src="../../../static/doctools.js"></script>
        <script type="text/javascript" src="../../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyworkflow.mapper.sqlite</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyworkflow.mapper.sqlite</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se) [1]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] SciLifeLab, Stockholm University</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>



<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="k">import</span> <span class="n">replaceExt</span><span class="p">,</span> <span class="n">joinExt</span>
<span class="kn">from</span> <span class="nn">.mapper</span> <span class="k">import</span> <span class="n">Mapper</span>
<span class="kn">from</span> <span class="nn">.sqlite_db</span> <span class="k">import</span> <span class="n">SqliteDb</span>

<span class="n">ID</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
<span class="n">PARENT_ID</span> <span class="o">=</span> <span class="s1">&#39;parent_id&#39;</span>
<span class="n">CLASSNAME</span> <span class="o">=</span> <span class="s1">&#39;classname&#39;</span>
<span class="n">NAME</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>


<div class="viewcode-block" id="SqliteMapper"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper">[docs]</a><span class="k">class</span> <span class="nc">SqliteMapper</span><span class="p">(</span><span class="n">Mapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specific Mapper implementation using Sqlite database&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbName</span><span class="p">,</span> <span class="n">dictClasses</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Mapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictClasses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initObjDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initUpdateDict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteObjectsDb</span><span class="p">(</span><span class="n">dbName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error creating SqliteMapper, dbName: </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbName</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
    
<div class="viewcode-block" id="SqliteMapper.close"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="SqliteMapper.commit"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
        
    <span class="k">def</span> <span class="nf">__getObjectValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the value of the object to be stored.</span>
<span class="sd">        We need to handle the special case of pointer, where we should</span>
<span class="sd">        store as value the object id of the pointed object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isPointer</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">hasObjId</span><span class="p">():</span>  <span class="c1"># Check the object has been stored previously</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span>  <span class="c1"># For pointers store the id of referenced object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatePendingPointers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Pending update&quot;</span> 
            
        <span class="k">return</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">__insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">namePrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_objDoStore&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAPPER: object &#39;</span><span class="si">%s</span><span class="s2">&#39; doesn&#39;t seem to be an Object subclass,&quot;</span>
                  <span class="s2">&quot;       it does not have attribute &#39;_objDoStore&#39;. &quot;</span>
                  <span class="s2">&quot;Insert skipped.&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insertObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">__getObjectValue</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                                          <span class="n">obj</span><span class="o">.</span><span class="n">_objParentId</span><span class="p">,</span>
                                          <span class="n">obj</span><span class="o">.</span><span class="n">_objLabel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objComment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">namePrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="n">sid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="n">joinExt</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertChilds</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">namePrefix</span><span class="p">)</span>
        
<div class="viewcode-block" id="SqliteMapper.insert"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert a new object into the system, the id will be set&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__insert</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.insertChild"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.insertChild">[docs]</a>    <span class="k">def</span> <span class="nf">insertChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">namePrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;_objDoStore&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAPPER: object &#39;</span><span class="si">%s</span><span class="s2">&#39; doesn&#39;t seem to be an Object subclass,&quot;</span>
                  <span class="s2">&quot;       it does not have attribute &#39;_objDoStore&#39;. </span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;Insert skipped.&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> 

        <span class="k">if</span> <span class="n">namePrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_objName</span> <span class="o">=</span> <span class="n">joinExt</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_objParentId</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__insert</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">namePrefix</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.insertChilds"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.insertChilds">[docs]</a>    <span class="k">def</span> <span class="nf">insertChilds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">namePrefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert childs of an object, if namePrefix is None,</span>
<span class="sd">        the it will be deduced from obj. &quot;&quot;&quot;</span>
        <span class="c1"># This is also done in insertChild, but avoid </span>
        <span class="c1"># doing the same for every child element</span>
        <span class="k">if</span> <span class="n">namePrefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">getAttributesToStore</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insertChild</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">namePrefix</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.deleteChilds"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.deleteChilds">[docs]</a>    <span class="k">def</span> <span class="nf">deleteChilds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">namePrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteChildObjects</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.deleteAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.deleteAll">[docs]</a>    <span class="k">def</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all objects stored &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteAll</span><span class="p">()</span></div>
                
<div class="viewcode-block" id="SqliteMapper.delete"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an object and all its childs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteChilds</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span></div>
    
    <span class="k">def</span> <span class="nf">__getNamePrefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">replaceExt</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">strId</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__printObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obj._objId&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obj._objParentId&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objParentId</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obj._objName&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obj.getObjValue()&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">())</span>

<div class="viewcode-block" id="SqliteMapper.updateTo"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.updateTo">[docs]</a>    <span class="k">def</span> <span class="nf">updateTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initUpdateDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__updateTo</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="c1"># Update pending pointers to objects</span>
        <span class="k">for</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatePendingPointers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">updateObject</span><span class="p">(</span><span class="n">ptr</span><span class="o">.</span><span class="n">_objId</span><span class="p">,</span> <span class="n">ptr</span><span class="o">.</span><span class="n">_objName</span><span class="p">,</span>
                                 <span class="n">Mapper</span><span class="o">.</span><span class="n">getObjectPersistingClassName</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">__getObjectValue</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">ptr</span><span class="o">.</span><span class="n">_objParentId</span><span class="p">,</span>
                                 <span class="n">ptr</span><span class="o">.</span><span class="n">_objLabel</span><span class="p">,</span> <span class="n">ptr</span><span class="o">.</span><span class="n">_objComment</span><span class="p">)</span>

        <span class="c1"># Delete any child objects that have not been found.</span>
        <span class="c1"># This could be the case if some elements (such as inside List)</span>
        <span class="c1"># were stored in the database and were removed from the object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteMissingObjectsByAncestor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">updateDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__updateTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">updateObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objName</span><span class="p">,</span>
                             <span class="n">Mapper</span><span class="o">.</span><span class="n">getObjectPersistingClassName</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">__getObjectValue</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objParentId</span><span class="p">,</span> 
                             <span class="n">obj</span><span class="o">.</span><span class="n">_objLabel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objComment</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateDict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Circular reference, object: </span><span class="si">%s</span><span class="s1"> found twice&#39;</span>
                            <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">getAttributesToStore</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">_objId</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Insert new items from the previous state</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">_objParentId</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_objId</span>
                <span class="n">namePrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">_objName</span> <span class="o">=</span> <span class="n">joinExt</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__insert</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">namePrefix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  
                <span class="bp">self</span><span class="o">.</span><span class="n">__updateTo</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="SqliteMapper.updateFrom"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.updateFrom">[docs]</a>    <span class="k">def</span> <span class="nf">updateFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">objRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectById</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="SqliteMapper.selectById"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.selectById">[docs]</a>    <span class="k">def</span> <span class="nf">selectById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the object which id is objId&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">objId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="p">[</span><span class="n">objId</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectById</span><span class="p">(</span><span class="n">objId</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">objRow</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;classname&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fillObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="SqliteMapper.exists"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doesRowExist</span><span class="p">(</span><span class="n">objId</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteMapper.getParent"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.getParent">[docs]</a>    <span class="k">def</span> <span class="nf">getParent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the parent object of another. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectById</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_objParentId</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.fillObjectWithRow"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.fillObjectWithRow">[docs]</a>    <span class="k">def</span> <span class="nf">fillObjectWithRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fill the object with row data. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_objId&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Entry &#39;</span><span class="si">%s</span><span class="s2">&#39; (id=</span><span class="si">%s</span><span class="s2">) in the database, stored as &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                            <span class="s2">&quot;, is being mapped to </span><span class="si">%s</span><span class="s2"> object. &quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="n">objRow</span><span class="p">[</span><span class="n">ID</span><span class="p">],</span>
                             <span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;classname&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_objId</span> <span class="o">=</span> <span class="n">objRow</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objComment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objCreation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;creation&#39;</span><span class="p">])</span>
        <span class="n">objValue</span> <span class="o">=</span> <span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_objParentId</span> <span class="o">=</span> <span class="n">objRow</span><span class="p">[</span><span class="n">PARENT_ID</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">objValue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">objValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectById</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">objValue</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objValue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">objValue</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteMapper.fillObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.fillObject">[docs]</a>    <span class="k">def</span> <span class="nf">fillObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">,</span> <span class="n">includeChildren</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillObjectWithRow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">)</span>
        <span class="n">namePrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNamePrefix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">includeChildren</span><span class="p">:</span>
            <span class="n">childs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectsByAncestor</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">childRow</span> <span class="ow">in</span> <span class="n">childs</span><span class="p">:</span>
                <span class="n">childParts</span> <span class="o">=</span> <span class="n">childRow</span><span class="p">[</span><span class="n">NAME</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">childName</span> <span class="o">=</span> <span class="n">childParts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">parentId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">childParts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="c1"># Here we are assuming that always the parent have</span>
                <span class="c1"># been processed first, so it will be in the dictionary</span>
                <span class="n">parentObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parentId</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parentObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Something went wrong</span>
                    <span class="k">continue</span>
                <span class="n">childObj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parentObj</span><span class="p">,</span> <span class="n">childName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">childObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">childObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">childRow</span><span class="p">[</span><span class="n">CLASSNAME</span><span class="p">])</span>
                    <span class="c1"># If we have any problem building the object, just ignore it</span>
                    <span class="k">if</span> <span class="n">childObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">parentObj</span><span class="p">,</span> <span class="n">childName</span><span class="p">,</span> <span class="n">childObj</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fillObjectWithRow</span><span class="p">(</span><span class="n">childObj</span><span class="p">,</span> <span class="n">childRow</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__buildObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds and object, either based on the parent attribute, or a new</span>
<span class="sd">        one based on the class. &quot;&quot;&quot;</span>
        <span class="n">parentId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getParentIdFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="c1">#  If there is no parent...</span>
        <span class="k">if</span> <span class="n">parentId</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># It must be a Root object, use the class</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getClassFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to get the instance from the parent</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNameFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">childParts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">childName</span> <span class="o">=</span> <span class="n">childParts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get the parent, we should have it cached</span>
            <span class="n">parentObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parentId</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parentObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Something went wrong</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Parent object (id=</span><span class="si">%d</span><span class="s2">) was not found, &quot;</span>
                      <span class="s2">&quot;object: </span><span class="si">%s</span><span class="s2">. Ignored.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parentId</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">childObj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parentObj</span><span class="p">,</span> <span class="n">childName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># If parent object does not have that attribute</span>
            <span class="k">if</span> <span class="n">childObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">childObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">CLASSNAME</span><span class="p">])</span>
                <span class="c1"># If we have any problem building the object, just ignore it</span>
                <span class="k">if</span> <span class="n">childObj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="n">parentObj</span><span class="p">,</span> <span class="n">childName</span><span class="p">,</span> <span class="n">childObj</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">childObj</span>

    <span class="k">def</span> <span class="nf">__objFromRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRow</span><span class="p">,</span> <span class="n">includeChildren</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">objClassName</span> <span class="o">=</span> <span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;classname&#39;</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">objClassName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">objRow</span><span class="p">,</span> <span class="n">includeChildren</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">__iterObjectsFromRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRows</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">objRow</span> <span class="ow">in</span> <span class="n">objRows</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objFromRow</span><span class="p">(</span><span class="n">objRow</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">objectFilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">objectFilter</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">__objectsFromRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a set of object from a set of rows</span>
<span class="sd">        Params:</span>
<span class="sd">            objRows: rows result from a db select.</span>
<span class="sd">            iterate: if True, iterates over all elements, if False the whole</span>
<span class="sd">                list is returned</span>
<span class="sd">            objectFilter: function to filter some of the objects of the</span>
<span class="sd">                results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__iterObjectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span>
                                                              <span class="n">objectFilter</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__iterObjectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span>
               
    <span class="k">def</span> <span class="nf">__initObjDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the objDict cache &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">__initUpdateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the updateDict cache &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">updateDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># This is used to store pointers that pointed object are not stored yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatePendingPointers</span> <span class="o">=</span> <span class="p">[]</span>
         
<div class="viewcode-block" id="SqliteMapper.selectBy"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.selectBy">[docs]</a>    <span class="k">def</span> <span class="nf">selectBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select object meetings some criteria&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initObjDict</span><span class="p">()</span>
        <span class="n">objRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectsBy</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteMapper.selectByClass"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.selectByClass">[docs]</a>    <span class="k">def</span> <span class="nf">selectByClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">includeSubclasses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initObjDict</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">includeSubclasses</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyworkflow.utils.reflection</span> <span class="k">import</span> <span class="n">getSubclasses</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="s2">&quot;classname=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">className</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictClasses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
            <span class="n">subDict</span> <span class="o">=</span> <span class="n">getSubclasses</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictClasses</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
                    <span class="n">whereStr</span> <span class="o">+=</span> <span class="s2">&quot; OR classname=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">k</span>
            <span class="n">objRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectsWhere</span><span class="p">(</span><span class="n">whereStr</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectBy</span><span class="p">(</span><span class="n">iterate</span><span class="o">=</span><span class="n">iterate</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="n">className</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="SqliteMapper.selectAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.selectAll">[docs]</a>    <span class="k">def</span> <span class="nf">selectAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initObjDict</span><span class="p">()</span>
        <span class="n">objRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectsByParent</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteMapper.selectAllBatch"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.selectAllBatch">[docs]</a>    <span class="k">def</span> <span class="nf">selectAllBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Select all the row at once for all the project</span>

<span class="sd">        Returns:</span>
<span class="sd">            all the protocols populated with the data from the DB</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initObjDict</span><span class="p">()</span>

        <span class="c1"># Get all the data from Objects table sorted by Name</span>
        <span class="n">objAll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectAllObjects</span><span class="p">()</span>

        <span class="c1"># We should have first the protocol lines</span>
        <span class="c1"># then each of the protocol attributes</span>
        <span class="c1"># at then there is the creation time</span>

        <span class="c1"># Dictionary to store objects</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># For each row</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">objAll</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getObjectFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">objectFilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">objectFilter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">objs</span></div>

    <span class="k">def</span> <span class="nf">_getObjectFromRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>

        <span class="c1"># Build the object without children</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__buildObject</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># If an object was created</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Fill object attributes with row values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillObjectWithRow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="c1"># Add it to the obj cache, we might need it latter to assign</span>
            <span class="c1"># attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_objId</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

            <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">_getObjectFromDictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objDict</span><span class="p">[</span><span class="n">objId</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getIdFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SqliteMapper</span><span class="o">.</span><span class="n">_getFieldFromRow</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getParentIdFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SqliteMapper</span><span class="o">.</span><span class="n">_getFieldFromRow</span><span class="p">(</span><span class="n">PARENT_ID</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getClassFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SqliteMapper</span><span class="o">.</span><span class="n">_getFieldFromRow</span><span class="p">(</span><span class="n">CLASSNAME</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getNameFromRow</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SqliteMapper</span><span class="o">.</span><span class="n">_getFieldFromRow</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getFieldFromRow</span><span class="p">(</span><span class="n">fieldName</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">fieldName</span><span class="p">]</span>

<div class="viewcode-block" id="SqliteMapper.insertRelation"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.insertRelation">[docs]</a>    <span class="k">def</span> <span class="nf">insertRelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">creatorObj</span><span class="p">,</span> <span class="n">parentObj</span><span class="p">,</span> <span class="n">childObj</span><span class="p">,</span>
                       <span class="n">parentExt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">childExt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function will add a new relation between two objects.</span>
<span class="sd">        Params:</span>
<span class="sd">            relName: the name of the relation to be added.</span>
<span class="sd">            creatorObj: this object will be the one who register the relation.</span>
<span class="sd">            parentObj: this is &quot;parent&quot; in the relation</span>
<span class="sd">            childObj: this is &quot;child&quot; in the relation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="n">creatorObj</span><span class="p">,</span> <span class="n">parentObj</span><span class="p">,</span> <span class="n">childObj</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">hasObjId</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Before adding a relation, the object should &quot;</span>
                                <span class="s2">&quot;be stored in mapper&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insertRelation</span><span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">creatorObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span>
                               <span class="n">parentObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span> <span class="n">childObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span>
                               <span class="n">parentExt</span><span class="p">,</span> <span class="n">childExt</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">__objectsFromIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objIds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of objects, given a list of id&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selectById</span><span class="p">(</span><span class="n">rowId</span><span class="p">[</span><span class="n">ID</span><span class="p">])</span> <span class="k">for</span> <span class="n">rowId</span> <span class="ow">in</span> <span class="n">objIds</span><span class="p">]</span>
        
<div class="viewcode-block" id="SqliteMapper.getRelationChilds"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.getRelationChilds">[docs]</a>    <span class="k">def</span> <span class="nf">getRelationChilds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">parentObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all &quot;child&quot; objects for a given relation.</span>
<span class="sd">        Params:</span>
<span class="sd">            relName: the name of the relation.</span>
<span class="sd">            parentObj: this is &quot;parent&quot; in the relation</span>
<span class="sd">        Returns: </span>
<span class="sd">            a list of &quot;child&quot; objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">childIds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectRelationChilds</span><span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">parentObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromIds</span><span class="p">(</span><span class="n">childIds</span><span class="p">)</span>  </div>
            
<div class="viewcode-block" id="SqliteMapper.getRelationParents"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.getRelationParents">[docs]</a>    <span class="k">def</span> <span class="nf">getRelationParents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">childObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all &quot;parent&quot; objects for a given relation.</span>
<span class="sd">        Params:</span>
<span class="sd">            relName: the name of the relation.</span>
<span class="sd">            childObj: this is &quot;child&quot; in the relation</span>
<span class="sd">        Returns: </span>
<span class="sd">            a list of &quot;parent&quot; objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parentIds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectRelationParents</span><span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">childObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromIds</span><span class="p">(</span><span class="n">parentIds</span><span class="p">)</span>  </div>

<div class="viewcode-block" id="SqliteMapper.getRelationsByCreator"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.getRelationsByCreator">[docs]</a>    <span class="k">def</span> <span class="nf">getRelationsByCreator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creatorObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all relations created by creatorObj. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectRelationsByCreator</span><span class="p">(</span><span class="n">creatorObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span></div>
    
<div class="viewcode-block" id="SqliteMapper.getRelationsByName"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.getRelationsByName">[docs]</a>    <span class="k">def</span> <span class="nf">getRelationsByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all relations stored of a given type. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectRelationsByName</span><span class="p">(</span><span class="n">relationName</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteMapper.deleteRelations"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.deleteRelations">[docs]</a>    <span class="k">def</span> <span class="nf">deleteRelations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creatorObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all relations created by object creatorObj &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteRelationsByCreator</span><span class="p">(</span><span class="n">creatorObj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span></div>
    
<div class="viewcode-block" id="SqliteMapper.insertRelationData"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteMapper.insertRelationData">[docs]</a>    <span class="k">def</span> <span class="nf">insertRelationData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">creatorId</span><span class="p">,</span> <span class="n">parentId</span><span class="p">,</span> <span class="n">childId</span><span class="p">,</span>
                           <span class="n">parentExtended</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">childExtended</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insertRelation</span><span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">creatorId</span><span class="p">,</span> <span class="n">parentId</span><span class="p">,</span> <span class="n">childId</span><span class="p">,</span>
                               <span class="n">parentExtended</span><span class="p">,</span> <span class="n">childExtended</span><span class="p">)</span></div></div>
    
    
<div class="viewcode-block" id="SqliteObjectsDb"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb">[docs]</a><span class="k">class</span> <span class="nc">SqliteObjectsDb</span><span class="p">(</span><span class="n">SqliteDb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle a Sqlite database.</span>
<span class="sd">    It will create connection, execute queries and commands&quot;&quot;&quot;</span>
    <span class="c1"># Maintain the current version of the DB schema</span>
    <span class="c1"># useful for future updates and backward compatibility</span>
    <span class="c1"># version should be an integer number</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">SELECT</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT id, parent_id, name, classname, value, label, comment, &quot;</span>
              <span class="s2">&quot;datetime(creation, &#39;localtime&#39;) as creation FROM Objects WHERE &quot;</span><span class="p">)</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM Objects WHERE &quot;</span>
    <span class="n">DELETE_SEQUENCE</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM SQLITE_SEQUENCE WHERE name=&#39;Objects&#39;&quot;</span>
    
    <span class="n">SELECT_RELATION</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT object_</span><span class="si">%s</span><span class="s2">_id AS id FROM Relations &quot;</span>
                       <span class="s2">&quot;WHERE name=? AND object_</span><span class="si">%s</span><span class="s2">_id=?&quot;</span><span class="p">)</span>
    <span class="n">SELECT_RELATIONS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Relations WHERE &quot;</span>
    <span class="n">EXISTS</span> <span class="o">=</span> <span class="s2">&quot;SELECT EXISTS(SELECT 1 FROM Objects WHERE </span><span class="si">%s</span><span class="s2">=? LIMIT 1)&quot;</span>
    
<div class="viewcode-block" id="SqliteObjectsDb.selectCmd"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectCmd">[docs]</a>    <span class="k">def</span> <span class="nf">selectCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whereStr</span><span class="p">,</span> <span class="n">orderByStr</span><span class="o">=</span><span class="s1">&#39; ORDER BY id&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">whereStr</span> <span class="o">+</span> <span class="n">orderByStr</span></div>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbName</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">pragmas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">SqliteDb</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="n">pragmas</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createConnection</span><span class="p">(</span><span class="n">dbName</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the required tables if needed. &quot;&quot;&quot;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTables</span><span class="p">()</span>
        <span class="c1"># Check if the tables have been created or not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__createTables</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__updateTables</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__createTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create required tables if don&#39;t exists&quot;&quot;&quot;</span>
        <span class="c1"># Enable foreings keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">[</span><span class="s1">&#39;foreing_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ON&quot;</span>
        <span class="k">for</span> <span class="n">pragma</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;PRAGMA </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pragma</span><span class="p">)</span>
        <span class="c1"># Create the Objects table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS Objects</span>
<span class="s2">                     (id        INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                      parent_id INTEGER REFERENCES Objects(id),</span>
<span class="s2">                      name      TEXT,                -- object name </span>
<span class="s2">                      classname TEXT,                -- object&#39;s class name</span>
<span class="s2">                      value     TEXT DEFAULT NULL,   -- object value, used for Scalars</span>
<span class="s2">                      label     TEXT DEFAULT NULL,   -- object label, text used for display</span>
<span class="s2">                      comment   TEXT DEFAULT NULL,   -- object comment, text used for annotations</span>
<span class="s2">                      creation  DATE                 -- creation date and time of the object</span>
<span class="s2">                      )&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Create the Relations table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS Relations</span>
<span class="s2">                     (id        INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                      parent_id INTEGER REFERENCES Objects(id), -- object that created the relation</span>
<span class="s2">                      name      TEXT,               -- relation name </span>
<span class="s2">                      classname TEXT DEFAULT NULL,  -- relation&#39;s class name</span>
<span class="s2">                      value     TEXT DEFAULT NULL,  -- relation value</span>
<span class="s2">                      label     TEXT DEFAULT NULL,  -- relation label, text used for display</span>
<span class="s2">                      comment   TEXT DEFAULT NULL,  -- relation comment, text used for annotations</span>
<span class="s2">                      object_parent_id  INTEGER REFERENCES Objects(id) ON DELETE CASCADE,</span>
<span class="s2">                      object_child_id  INTEGER REFERENCES Objects(id) ON DELETE CASCADE,</span>
<span class="s2">                      creation  DATE,                 -- creation date and time of the object</span>
<span class="s2">                      object_parent_extended TEXT DEFAULT NULL, -- extended property to consider internal objects</span>
<span class="s2">                      object_child_extended TEXT DEFAULT NULL</span>
<span class="s2">                      )&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__updateTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method is intended to update the table schema</span>
<span class="sd">        in the case of dealing with old database version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span>  <span class="c1"># This applies for version 1</span>
            <span class="c1"># Add the extra column for pointer extended attribute in Relations table</span>
            <span class="c1"># from version 1 on, there is not needed since the table will </span>
            <span class="c1"># already contains this column</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTableColumns</span><span class="p">(</span><span class="s1">&#39;Relations&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s1">&#39;object_parent_extended&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE Relations &quot;</span>
                                    <span class="s2">&quot;ADD COLUMN object_parent_extended  TEXT DEFAULT NULL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;object_child_extended&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE Relations &quot;</span>
                                    <span class="s2">&quot;ADD COLUMN object_child_extended  TEXT DEFAULT NULL&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

<div class="viewcode-block" id="SqliteObjectsDb.insertObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.insertObject">[docs]</a>    <span class="k">def</span> <span class="nf">insertObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute command to insert a new object. Return the inserted object id&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span>
                <span class="s1">&#39;INSERT INTO Objects (parent_id, name, classname, value, label, comment, creation)&#39;</span> <span class="o">+</span>
                <span class="s1">&#39; VALUES (?, ?, ?, ?, ?, ?, datetime(</span><span class="se">\&#39;</span><span class="s1">now</span><span class="se">\&#39;</span><span class="s1">))&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;insertObject: ERROR&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INSERT INTO Objects (parent_id, name, classname, value, label, comment, creation)&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39; VALUES (?, ?, ?, ?, ?, ?, datetime(</span><span class="se">\&#39;</span><span class="s1">now</span><span class="se">\&#39;</span><span class="s1">))&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">((</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ex</span></div>
        
<div class="viewcode-block" id="SqliteObjectsDb.insertRelation"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.insertRelation">[docs]</a>    <span class="k">def</span> <span class="nf">insertRelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">object_parent_id</span><span class="p">,</span> <span class="n">object_child_id</span><span class="p">,</span> 
                       <span class="n">object_parent_extended</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">object_child_extended</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute command to insert a new object. Return the inserted object id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;INSERT INTO Relations &quot;</span>
                            <span class="s2">&quot;(parent_id, name, object_parent_id, object_child_id, creation, &quot;</span>
                            <span class="s2">&quot;object_parent_extended, object_child_extended) &quot;</span>
                            <span class="s2">&quot; VALUES (?, ?, ?, ?, datetime(&#39;now&#39;), ?, ?)&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">object_parent_id</span><span class="p">,</span> <span class="n">object_child_id</span><span class="p">,</span>
                             <span class="n">object_parent_extended</span><span class="p">,</span> <span class="n">object_child_extended</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span></div>
    
<div class="viewcode-block" id="SqliteObjectsDb.updateObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.updateObject">[docs]</a>    <span class="k">def</span> <span class="nf">updateObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update object data &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;UPDATE Objects SET parent_id=?, name=?, &quot;</span>
                            <span class="s2">&quot;classname=?, value=?, label=?, comment=? WHERE id=?&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">objId</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="SqliteObjectsDb.selectObjectById"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectObjectById">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select an object give its id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.doesRowExist"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.doesRowExist">[docs]</a>    <span class="k">def</span> <span class="nf">doesRowExist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if a row with a given id exists&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXISTS</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span>
        <span class="n">one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">one</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.selectAllObjects"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectAllObjects">[docs]</a>    <span class="k">def</span> <span class="nf">selectAllObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select all data at once&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;&gt;0&quot;</span><span class="p">,</span> <span class="s1">&#39; ORDER BY parent_id&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.selectObjectsByParent"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectObjectsByParent">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsByParent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select object with a given parent</span>
<span class="sd">        if the parent_id is None, all object with parent_id NULL</span>
<span class="sd">        will be returned&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">PARENT_ID</span> <span class="o">+</span> <span class="s2">&quot; is NULL&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">PARENT_ID</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span>  </div>
    
<div class="viewcode-block" id="SqliteObjectsDb.selectObjectsByAncestor"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectObjectsByAncestor">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsByAncestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor_namePrefix</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select all objects in the hierarchy of ancestor_id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="s2">&quot;name LIKE &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%%</span><span class="s2">&#39;&quot;</span>
                                           <span class="o">%</span> <span class="n">ancestor_namePrefix</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.selectObjectsBy"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectObjectsBy">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>     
        <span class="sd">&quot;&quot;&quot;More flexible select where the constrains can be passed</span>
<span class="sd">        as a dictionary, the concatenation is done by an AND&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="s1">&#39;1=?&#39;</span>
            <span class="n">whereTuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">whereList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=?&#39;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whereList</span><span class="p">)</span>
            <span class="n">whereTuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">whereStr</span><span class="p">),</span> <span class="n">whereTuple</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteObjectsDb.selectObjectsWhere"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectObjectsWhere">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsWhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whereStr</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">whereStr</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteObjectsDb.deleteObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.deleteObject">[docs]</a>    <span class="k">def</span> <span class="nf">deleteObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an existing object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">+</span> <span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span></div>
        
<div class="viewcode-block" id="SqliteObjectsDb.deleteChildObjects"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.deleteChildObjects">[docs]</a>    <span class="k">def</span> <span class="nf">deleteChildObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor_namePrefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete from db all objects that are childs </span>
<span class="sd">        of an ancestor, now them will have the same starting prefix&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">+</span> <span class="s2">&quot;name LIKE &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%%</span><span class="s2">&#39;&quot;</span>
                            <span class="o">%</span> <span class="n">ancestor_namePrefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.selectMissingObjectsByAncestor"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectMissingObjectsByAncestor">[docs]</a>    <span class="k">def</span> <span class="nf">selectMissingObjectsByAncestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor_namePrefix</span><span class="p">,</span>
                                       <span class="n">idList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select all objects in the hierarchy of ancestor_id&quot;&quot;&quot;</span>
        <span class="n">idStr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="s2">&quot;name LIKE &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%%</span><span class="s2">&#39; AND id NOT IN (</span><span class="si">%s</span><span class="s2">) &quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">ancestor_namePrefix</span><span class="p">,</span> <span class="n">idStr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.deleteMissingObjectsByAncestor"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.deleteMissingObjectsByAncestor">[docs]</a>    <span class="k">def</span> <span class="nf">deleteMissingObjectsByAncestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor_namePrefix</span><span class="p">,</span> <span class="n">idList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select all objects in the hierarchy of ancestor_id&quot;&quot;&quot;</span>
        <span class="n">idStr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> name LIKE &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%%</span><span class="s2">&#39; AND id NOT IN (</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">ancestor_namePrefix</span><span class="p">,</span> <span class="n">idStr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteObjectsDb.deleteAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.deleteAll">[docs]</a>    <span class="k">def</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all objects from the db. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE_SEQUENCE</span><span class="p">)</span>  <span class="c1"># restart the count of ids</span></div>
        
<div class="viewcode-block" id="SqliteObjectsDb.selectRelationChilds"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectRelationChilds">[docs]</a>    <span class="k">def</span> <span class="nf">selectRelationChilds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">object_parent_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_RELATION</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;child&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">),</span> 
                            <span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">object_parent_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="SqliteObjectsDb.selectRelationParents"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectRelationParents">[docs]</a>    <span class="k">def</span> <span class="nf">selectRelationParents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">object_child_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_RELATION</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;child&#39;</span><span class="p">),</span> 
                            <span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="n">object_child_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="SqliteObjectsDb.selectRelationsByCreator"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectRelationsByCreator">[docs]</a>    <span class="k">def</span> <span class="nf">selectRelationsByCreator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_RELATIONS</span> <span class="o">+</span> <span class="n">PARENT_ID</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">()</span></div>
     
<div class="viewcode-block" id="SqliteObjectsDb.selectRelationsByName"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.selectRelationsByName">[docs]</a>    <span class="k">def</span> <span class="nf">selectRelationsByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationName</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_RELATIONS</span> <span class="o">+</span> <span class="s2">&quot;name=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">relationName</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">()</span></div>
       
<div class="viewcode-block" id="SqliteObjectsDb.deleteRelationsByCreator"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteObjectsDb.deleteRelationsByCreator">[docs]</a>    <span class="k">def</span> <span class="nf">deleteRelationsByCreator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;DELETE FROM Relations where parent_id=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">,))</span></div></div>


<div class="viewcode-block" id="SqliteFlatMapper"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper">[docs]</a><span class="k">class</span> <span class="nc">SqliteFlatMapper</span><span class="p">(</span><span class="n">Mapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specific Flat Mapper implementation using Sqlite database&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbName</span><span class="p">,</span> <span class="n">dictClasses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tablePrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Mapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictClasses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We (ROB and JMRT) are playing with different</span>
            <span class="c1"># PRAGMAS (see https://www.sqlite.org/pragma.html)</span>
            <span class="c1"># for the SqliteFlatMapper instances</span>
            <span class="c1"># We have been playing with the following</span>
            <span class="c1"># pragmas: {synchronous, journal_mode, temp_store and</span>
            <span class="c1">#  cache_size} and inside scipion no improvement</span>
            <span class="c1"># has been observed. Outside scipion a careful</span>
            <span class="c1">#  choosing of pragmas may duplicate the speed but</span>
            <span class="c1"># inside scipion, I think that the overhead due</span>
            <span class="c1"># to the manipulation of python classes is more</span>
            <span class="c1"># important that the data access.</span>

            <span class="c1"># uncommenting these pragmas increase the speed</span>
            <span class="c1"># by a factor of two if NO python object is manipulated.</span>
            <span class="c1"># Unfortunately, any interesting operation involve</span>
            <span class="c1"># creation and manipulation of python objects that take</span>
            <span class="c1"># longer than the access time to the database</span>
            <span class="n">pragmas</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># 0 | OFF | 1 | NORMAL | 2 | FULL | 3 | EXTRA;</span>
                <span class="c1"># #&#39;synchronous&#39;: &#39;OFF&#39;, # ON</span>
                <span class="c1"># DELETE | TRUNCATE | PERSIST | MEMORY | WAL | OFF</span>
                <span class="c1"># #&#39;journal_mode&#39;: &#39;OFF&#39;, # DELETE</span>
                <span class="c1"># FILE 0 | DEFAULT | 1 | FILE | 2 | MEMORY;</span>
                <span class="c1"># #&#39;temp_store&#39;: &#39;MEMORY&#39;,</span>
                <span class="c1"># PRAGMA schema.cache_size = pages;</span>
                <span class="c1"># #&#39;cache_size&#39;: &#39;5000&#39; # versus -2000</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteFlatDb</span><span class="p">(</span><span class="n">dbName</span><span class="p">,</span> <span class="n">tablePrefix</span><span class="p">,</span>
                                   <span class="n">pragmas</span><span class="o">=</span><span class="n">pragmas</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">missingTables</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__loadObjDict</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SqliteFlatMapperException</span><span class="p">(</span><span class="s1">&#39;Error creating SqliteFlatMapper, &#39;</span>
                                            <span class="s1">&#39;dbName: </span><span class="si">%s</span><span class="s1">, tablePrefix: </span><span class="si">%s</span><span class="se">\n</span><span class="s1"> error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                            <span class="p">(</span><span class="n">dbName</span><span class="p">,</span> <span class="n">tablePrefix</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
    
<div class="viewcode-block" id="SqliteFlatMapper.commit"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.close"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.insert"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">createTables</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">(</span><span class="n">includeClass</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;Insert a new object into the system, the id will be set&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insertObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjComment</span><span class="p">(),</span> 
                             <span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.enableAppend"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.enableAppend">[docs]</a>    <span class="k">def</span> <span class="nf">enableAppend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This will allow to append items to existing db. </span>
<span class="sd">        This is by default not allow, since most sets are not </span>
<span class="sd">        modified after creation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectFirst</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">setupCommands</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">(</span><span class="n">includeClass</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.clear"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="SqliteFlatMapper.deleteAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.deleteAll">[docs]</a>    <span class="k">def</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all objects stored &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteAll</span><span class="p">()</span></div>
                
<div class="viewcode-block" id="SqliteFlatMapper.delete"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an object and all its childs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span></div>
    
<div class="viewcode-block" id="SqliteFlatMapper.updateTo"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.updateTo">[docs]</a>    <span class="k">def</span> <span class="nf">updateTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update database entry with new object values. &quot;&quot;&quot;</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">INSERT_OBJECT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">setupCommands</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">(</span><span class="n">includeClass</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">updateObject</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjComment</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatMapper.exists"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doesRowExist</span><span class="p">(</span><span class="n">objId</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatMapper.selectById"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.selectById">[docs]</a>    <span class="k">def</span> <span class="nf">selectById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the object which id is objId&quot;&quot;&quot;</span>
        <span class="n">objRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectById</span><span class="p">(</span><span class="n">objId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">objRow</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objFromRow</span><span class="p">(</span><span class="n">objRow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">__loadObjDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load object properties and classes from db. &quot;&quot;&quot;</span>
        <span class="c1"># Create a template object for retrieving stored ones</span>
        <span class="n">columnList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getClassRows</span><span class="p">()</span>
        <span class="n">attrClasses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objBuildList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;label_property&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">SELF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_objClassName</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_objClassName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Lets update the database column mapping</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_columnsMapping</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span>
                <span class="n">columnList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">attrClasses</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
                <span class="n">attrParts</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">attrJoin</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrParts</span><span class="p">:</span>
                    <span class="n">attrJoin</span> <span class="o">+=</span> <span class="n">a</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">className</span> <span class="o">=</span> <span class="n">attrClasses</span><span class="p">[</span><span class="n">attrJoin</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_objBuildList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">className</span><span class="p">,</span> <span class="n">attrJoin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="n">o</span> <span class="o">=</span> <span class="n">attr</span>
                    <span class="n">attrJoin</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">basicRows</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">+</span> <span class="n">basicRows</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objColumns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">basicRows</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">columnList</span><span class="p">))</span>
         
    <span class="k">def</span> <span class="nf">__buildAndFillObj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_objClassName</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">className</span><span class="p">,</span> <span class="n">attrParts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objBuildList</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrParts</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildObjectFromClass</span><span class="p">(</span><span class="n">className</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="k">return</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">__objFromRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRow</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__loadObjDict</span><span class="p">()</span>
            
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span>  <span class="c1"># self.__buildAndFillObj()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">setObjId</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="n">ID</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">setObjLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">setObjComment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setObjCreation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStrValue</span><span class="p">(</span><span class="n">objRow</span><span class="p">[</span><span class="s1">&#39;creation&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># THIS SHOULD NOT HAPPENS</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: &#39;creation&#39; column not found in object: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         db: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getDbName</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         objRow: &quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">objRow</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objColumns</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setAttributeValue</span><span class="p">(</span><span class="n">attrName</span><span class="p">,</span> <span class="n">objRow</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">__iterObjectsFromRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRows</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">objRow</span> <span class="ow">in</span> <span class="n">objRows</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objFromRow</span><span class="p">(</span><span class="n">objRow</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">objectFilter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">objectFilter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">obj</span>
        
    <span class="k">def</span> <span class="nf">__objectsFromRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a set of object from a set of rows</span>
<span class="sd">        Params:</span>
<span class="sd">            objRows: rows result from a db select.</span>
<span class="sd">            iterate: if True, iterates over all elements, if False the whole</span>
<span class="sd">                list is returned</span>
<span class="sd">            objectFilter: function to filter some of the objects of the results. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__iterObjectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__iterObjectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span>
         
<div class="viewcode-block" id="SqliteFlatMapper.selectBy"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.selectBy">[docs]</a>    <span class="k">def</span> <span class="nf">selectBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select object meetings some criteria&quot;&quot;&quot;</span>
        <span class="n">objRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectObjectsBy</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteFlatMapper.selectAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.selectAll">[docs]</a>    <span class="k">def</span> <span class="nf">selectAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">objectFilter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orderBy</span><span class="o">=</span><span class="n">ID</span><span class="p">,</span>
                  <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Just a sanity check for emtpy sets, that doesn&#39;t contains</span>
        <span class="c1"># &#39;Properties&#39; table</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hasTable</span><span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span> <span class="k">if</span> <span class="n">iterate</span> <span class="k">else</span> <span class="p">[]</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objTemplate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__loadObjDict</span><span class="p">()</span>
        <span class="n">objRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">selectAll</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="n">orderBy</span><span class="p">,</span>
                                    <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
                                    <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
                                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__objectsFromRows</span><span class="p">(</span><span class="n">objRows</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span> <span class="n">objectFilter</span><span class="p">)</span> </div>

<div class="viewcode-block" id="SqliteFlatMapper.aggregate"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">operationLabel</span><span class="p">,</span> <span class="n">groupByLabels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">operationLabel</span><span class="p">,</span> <span class="n">groupByLabels</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">groupByLabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">groupByLabels</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="SqliteFlatMapper.count"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqliteFlatMapper.maxId"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.maxId">[docs]</a>    <span class="k">def</span> <span class="nf">maxId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doCreateTables</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">maxId</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__objectsFromIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objIds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of objects, given a list of id&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selectById</span><span class="p">(</span><span class="n">rowId</span><span class="p">[</span><span class="n">ID</span><span class="p">])</span> <span class="k">for</span> <span class="n">rowId</span> <span class="ow">in</span> <span class="n">objIds</span><span class="p">]</span>
    
<div class="viewcode-block" id="SqliteFlatMapper.hasProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.hasProperty">[docs]</a>    <span class="k">def</span> <span class="nf">hasProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.getProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.getProperty">[docs]</a>    <span class="k">def</span> <span class="nf">getProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SqliteFlatMapper.setProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.setProperty">[docs]</a>    <span class="k">def</span> <span class="nf">setProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteFlatMapper.deleteProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.deleteProperty">[docs]</a>    <span class="k">def</span> <span class="nf">deleteProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">deleteProperty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SqliteFlatMapper.getPropertyKeys"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapper.getPropertyKeys">[docs]</a>    <span class="k">def</span> <span class="nf">getPropertyKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">getPropertyKeys</span><span class="p">()</span></div></div>
        

<div class="viewcode-block" id="SqliteFlatMapperException"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatMapperException">[docs]</a><span class="k">class</span> <span class="nc">SqliteFlatMapperException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="n">SELF</span> <span class="o">=</span> <span class="s1">&#39;self&#39;</span>


<div class="viewcode-block" id="SqliteFlatDb"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb">[docs]</a><span class="k">class</span> <span class="nc">SqliteFlatDb</span><span class="p">(</span><span class="n">SqliteDb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle a Sqlite database.</span>
<span class="sd">    It will create connection, execute queries and commands&quot;&quot;&quot;</span>
    <span class="c1"># Maintain the current version of the DB schema</span>
    <span class="c1"># useful for future updates and backward compatibility</span>
    <span class="c1"># version should be an integer number</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">CLASS_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Integer&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Float&#39;</span><span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Boolean&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER&#39;</span>
                 <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbName</span><span class="p">,</span> <span class="n">tablePrefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                 <span class="n">pragmas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">SqliteDb</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span> <span class="o">=</span> <span class="n">pragmas</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span> <span class="o">=</span> <span class="n">indexes</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tablePrefix</span> <span class="o">=</span> <span class="n">tablePrefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Avoid having _ for empty prefix</span>
        <span class="k">if</span> <span class="n">tablePrefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tablePrefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">tablePrefix</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
        <span class="c1"># NOTE (Jose Miguel, 2014/01/02</span>
        <span class="c1"># Reusing connections is a bit dangerous, since it have lead to</span>
        <span class="c1"># unexpected and hard to trace errors due to using an out-of-date</span>
        <span class="c1"># reused connection. That&#39;s why we are changing now the default to False</span>
        <span class="c1"># and only setting to True when the tablePrefix is non-empty, which is</span>
        <span class="c1"># the case for classes that are different tables in the same db and it</span>
        <span class="c1"># logical to reuse the connection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reuseConnections</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">tablePrefix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_TABLES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span>
                             <span class="s2">&quot; AND name=&#39;</span><span class="si">%s</span><span class="s2">Objects&#39;;&quot;</span> <span class="o">%</span> <span class="n">tablePrefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SELECT</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s2">Objects WHERE &quot;</span> <span class="o">%</span> <span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FROM</span> <span class="o">=</span> <span class="s2">&quot;FROM </span><span class="si">%s</span><span class="s2">Objects&quot;</span> <span class="o">%</span> <span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM </span><span class="si">%s</span><span class="s2">Objects WHERE &quot;</span> <span class="o">%</span> <span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_CLASS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2">Classes (label_property, &quot;</span>
                             <span class="s2">&quot;column_name, class_name) VALUES (?, ?, ?)&quot;</span>
                             <span class="o">%</span> <span class="n">tablePrefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SELECT_CLASS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s2">Classes;&quot;</span> <span class="o">%</span> <span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXISTS</span> <span class="o">=</span> <span class="s2">&quot;SELECT EXISTS(SELECT 1 FROM Objects WHERE </span><span class="si">%s</span><span class="s2">=? LIMIT 1)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span> <span class="o">=</span> <span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createConnection</span><span class="p">(</span><span class="n">dbName</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_OBJECT</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_OBJECT</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columnsMapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_PROPERTY</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Properties (key, value) VALUES (?, ?)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DELETE_PROPERTY</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM Properties WHERE key=?&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_PROPERTY</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Properties SET value=? WHERE key=?&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SELECT_PROPERTY</span> <span class="o">=</span> <span class="s2">&quot;SELECT value FROM Properties WHERE key=?&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SELECT_PROPERTY_KEYS</span> <span class="o">=</span> <span class="s2">&quot;SELECT key FROM Properties&quot;</span>

<div class="viewcode-block" id="SqliteFlatDb.hasProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.hasProperty">[docs]</a>    <span class="k">def</span> <span class="nf">hasProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return true if a property with this value is registered. &quot;&quot;&quot;</span>
        <span class="c1"># The database not will not have the &#39;Properties&#39; table when</span>
        <span class="c1"># there is not item inserted (ie an empty set)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasTable</span><span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SqliteFlatDb.getProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.getProperty">[docs]</a>    <span class="k">def</span> <span class="nf">getProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the value of a given property with this key.</span>
<span class="sd">        If not found, the defaultValue will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The database not will not have the &#39;Properties&#39; table when</span>
        <span class="c1"># there is not item inserted (ie an empty set)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasTable</span><span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">defaultValue</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defaultValue</span></div>

<div class="viewcode-block" id="SqliteFlatDb.setProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.setProperty">[docs]</a>    <span class="k">def</span> <span class="nf">setProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert or update the property with a value. &quot;&quot;&quot;</span>
        <span class="c1"># Just ignore the set property for empty sets</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasTable</span><span class="p">(</span><span class="s1">&#39;Properties&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># All properties are stored as string, except for None type</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INSERT_PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div>
            
<div class="viewcode-block" id="SqliteFlatDb.getPropertyKeys"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.getPropertyKeys">[docs]</a>    <span class="k">def</span> <span class="nf">getPropertyKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all properties stored of this object. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_PROPERTY_KEYS</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">keys</span>        </div>

<div class="viewcode-block" id="SqliteFlatDb.deleteProperty"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.deleteProperty">[docs]</a>    <span class="k">def</span> <span class="nf">deleteProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE_PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span></div>

<div class="viewcode-block" id="SqliteFlatDb.selectCmd"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.selectCmd">[docs]</a>    <span class="k">def</span> <span class="nf">selectCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whereStr</span><span class="p">,</span> <span class="n">orderByStr</span><span class="o">=</span><span class="s1">&#39; ORDER BY &#39;</span> <span class="o">+</span> <span class="n">ID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">whereStr</span> <span class="o">+</span> <span class="n">orderByStr</span></div>

<div class="viewcode-block" id="SqliteFlatDb.missingTables"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.missingTables">[docs]</a>    <span class="k">def</span> <span class="nf">missingTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True is the needed Objects and Classes table are not</span>
<span class="sd">        created yet. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_TABLES</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SqliteFlatDb.clear"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS Properties;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">%s</span><span class="s2">Classes;&quot;</span>
                            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">%s</span><span class="s2">Objects;&quot;</span>
                            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.createTables"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.createTables">[docs]</a>    <span class="k">def</span> <span class="nf">createTables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the Classes and Object table to store items of a Set.</span>
<span class="sd">        Each object will be stored in a single row.</span>
<span class="sd">        Each nested property of the object will be stored as a column value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pragma</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;executing pragma&quot;</span><span class="p">,</span> <span class="n">pragma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;PRAGMA </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">pragma</span><span class="p">)</span>
        <span class="c1"># Create a general Properties table to store some needed values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS Properties</span>
<span class="s2">                     (key       TEXT UNIQUE, -- property key                 </span>
<span class="s2">                      value     TEXT  DEFAULT NULL -- property value</span>
<span class="s2">                      )&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Create the Classes table to store each column name and type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS </span><span class="si">%s</span><span class="s2">Classes</span>
<span class="s2">                     (id        INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                      label_property      TEXT UNIQUE, --object label                 </span>
<span class="s2">                      column_name TEXT UNIQUE,</span>
<span class="s2">                      class_name TEXT DEFAULT NULL  -- relation&#39;s class name</span>
<span class="s2">                      )&quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span><span class="p">)</span>
        <span class="n">CREATE_OBJECT_TABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS </span><span class="si">%s</span><span class="s2">Objects</span>
<span class="s2">                     (id        INTEGER PRIMARY KEY,</span>
<span class="s2">                      enabled   INTEGER DEFAULT 1,   -- used to selected/deselect items from a set</span>
<span class="s2">                      label     TEXT DEFAULT NULL,   -- object label, text used for display</span>
<span class="s2">                      comment   TEXT DEFAULT NULL,   -- object comment, text used for annotations</span>
<span class="s2">                      creation  DATE                 -- creation date and time of the object</span>
<span class="s2">                      &quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span>

        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">objDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="s1">&#39;c</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span>
            <span class="n">className</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">colMap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">colName</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INSERT_CLASS</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">colName</span><span class="p">,</span> <span class="n">className</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SELF</span><span class="p">:</span>
                <span class="n">CREATE_OBJECT_TABLE</span> <span class="o">+=</span> <span class="s1">&#39;,</span><span class="si">%s</span><span class="s1">  </span><span class="si">%s</span><span class="s1"> DEFAULT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLASS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">))</span>

        <span class="n">CREATE_OBJECT_TABLE</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="c1"># Create the Objects table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="n">CREATE_OBJECT_TABLE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span><span class="p">:</span>
            <span class="c1"># first check if the attribute to be indexed exists</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">colMap</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX index_</span><span class="si">%s</span><span class="s2"> ON Objects (</span><span class="si">%s</span><span class="s2">);&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">colMap</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># Prepare the INSERT and UPDATE commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupCommands</span><span class="p">(</span><span class="n">objDict</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.setupCommands"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.setupCommands">[docs]</a>    <span class="k">def</span> <span class="nf">setupCommands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the INSERT and UPDATE commands base on the object dictionary. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_OBJECT</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2">Objects (id, enabled, label, comment, creation&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_OBJECT</span> <span class="o">=</span> <span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2">Objects SET enabled=?, label=?, comment=?&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablePrefix</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">objDict</span><span class="p">:</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="s1">&#39;c</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columnsMapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">colName</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SELF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_OBJECT</span> <span class="o">+=</span> <span class="s1">&#39;,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">colName</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_OBJECT</span> <span class="o">+=</span> <span class="s1">&#39;, </span><span class="si">%s</span><span class="s1">=?&#39;</span> <span class="o">%</span> <span class="n">colName</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">INSERT_OBJECT</span> <span class="o">+=</span> <span class="s2">&quot;) VALUES (?,?,?,?, datetime(&#39;now&#39;)&quot;</span> <span class="o">+</span> <span class="s1">&#39;,?&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_OBJECT</span> <span class="o">+=</span> <span class="s1">&#39; WHERE id=?&#39;</span></div>

<div class="viewcode-block" id="SqliteFlatDb.getClassRows"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.getClassRows">[docs]</a>    <span class="k">def</span> <span class="nf">getClassRows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a dictionary with names of the attributes</span>
<span class="sd">        of the colums. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_CLASS</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.getSelfClassName"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.getSelfClassName">[docs]</a>    <span class="k">def</span> <span class="nf">getSelfClassName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the class name of the attribute named &#39;self&#39;.</span>
<span class="sd">        This is the class of the items stored in a Set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELECT_CLASS</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">classRow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterResults</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">classRow</span><span class="p">[</span><span class="s1">&#39;label_property&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">SELF</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">classRow</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Row &#39;</span><span class="si">%s</span><span class="s2">&#39; was not found in Classes table. &quot;</span> <span class="o">%</span> <span class="n">SELF</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.insertObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.insertObject">[docs]</a>    <span class="k">def</span> <span class="nf">insertObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert a new object as a row.</span>
<span class="sd">        *args: id, label, comment, ...</span>
<span class="sd">        where ... is the values of the objDict from which the tables</span>
<span class="sd">        where created.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INSERT_OBJECT</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.updateObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.updateObject">[docs]</a>    <span class="k">def</span> <span class="nf">updateObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update object data &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_OBJECT</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.selectObjectById"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.selectObjectById">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select an object give its id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqliteFlatDb.doesRowExist"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.doesRowExist">[docs]</a>    <span class="k">def</span> <span class="nf">doesRowExist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if a row with a given id exists&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXISTS</span> <span class="o">%</span> <span class="n">ID</span><span class="p">,</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span>
        <span class="n">one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">one</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SqliteFlatDb.selectAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.selectAll">[docs]</a>    <span class="k">def</span> <span class="nf">selectAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">orderBy</span><span class="o">=</span><span class="n">ID</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">,</span>
                  <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Handle the specials orderBy values of &#39;id&#39; and &#39;RANDOM()&#39;</span>
        <span class="c1"># other columns names should be mapped to table column</span>
        <span class="c1"># such as: _micId -&gt; c04</span>

        <span class="k">def</span> <span class="nf">_getRealCol</span><span class="p">(</span><span class="n">colName</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Transform the column name taking into account</span>
<span class="sd">             special columns such as: id or RANDOM(), and</span>
<span class="sd">             getting the mapping translation otherwise.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">colName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;RANDOM()&#39;</span><span class="p">,</span> <span class="s1">&#39;creation&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">colName</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columnsMapping</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orderBy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">orderByCol</span> <span class="o">=</span> <span class="n">_getRealCol</span><span class="p">(</span><span class="n">orderBy</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orderBy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">orderByCol</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_getRealCol</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">orderBy</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid type for orderBy: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">orderBy</span><span class="p">))</span>

        <span class="c1"># Parse the where string to replace the column name with</span>
        <span class="c1"># the real table column name ( for example: _micId -&gt; c01 )</span>
        <span class="c1"># Right now we are assuming a simple where string in the form</span>
        <span class="c1"># colName=VALUE</span>
        <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">where</span><span class="p">:</span>
            <span class="n">whereCol</span> <span class="o">=</span> <span class="n">where</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">whereRealCol</span> <span class="o">=</span> <span class="n">_getRealCol</span><span class="p">(</span><span class="n">whereCol</span><span class="p">)</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="n">where</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whereCol</span><span class="p">,</span> <span class="n">whereRealCol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="n">where</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">whereStr</span><span class="p">,</span>
                             <span class="n">orderByStr</span><span class="o">=</span><span class="s1">&#39; ORDER BY </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">orderByCol</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
        <span class="c1"># If there is a limit</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="c1"># if it is a tuple</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">limit</span><span class="p">,</span> <span class="n">skipRows</span> <span class="o">=</span> <span class="n">limit</span>  <span class="c1"># Extract values from tuple</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">skipRows</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># If we need to skip rows</span>
            <span class="n">skipPart</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">skipRows</span> <span class="k">if</span> <span class="n">skipRows</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot; LIMIT </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skipPart</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.aggregate"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">operationLabel</span><span class="p">,</span> <span class="n">groupByLabels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># let us count for testing</span>
        <span class="n">selectStr</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="c1"># This cannot be like the following line should be expresed in terms</span>
        <span class="c1"># of C1, C2 etc....</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="n">selectStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) AS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_columnsMapping</span><span class="p">[</span><span class="n">operationLabel</span><span class="p">],</span>
                                              <span class="n">operation</span><span class="p">)</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
        <span class="k">if</span> <span class="n">groupByLabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupByStr</span> <span class="o">=</span> <span class="s1">&#39;GROUP BY &#39;</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">for</span> <span class="n">groupByLabel</span> <span class="ow">in</span> <span class="n">groupByLabels</span><span class="p">:</span>
                <span class="n">groupByCol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columnsMapping</span><span class="p">[</span><span class="n">groupByLabel</span><span class="p">]</span>
                <span class="n">selectStr</span> <span class="o">+=</span> <span class="s1">&#39;, </span><span class="si">%(groupByCol)s</span><span class="s1"> as &quot;</span><span class="si">%(groupByLabel)s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
                <span class="n">groupByStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">groupByCol</span><span class="p">)</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groupByStr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="n">sqlCommand</span> <span class="o">=</span> <span class="n">selectStr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">FROM</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">groupByStr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="n">sqlCommand</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.count"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of element in the table. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNT(id)&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="SqliteFlatDb.maxId"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.maxId">[docs]</a>    <span class="k">def</span> <span class="nf">maxId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the maximum id from the Objects table. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;MAX(id)&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="c1"># FIXME: Seems to be duplicated and a subset of selectAll</span>
<div class="viewcode-block" id="SqliteFlatDb.selectObjectsBy"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.selectObjectsBy">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;More flexible select where the constrains can be passed</span>
<span class="sd">        as a dictionary, the concatenation is done by an AND&quot;&quot;&quot;</span>
        <span class="n">whereList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=?&#39;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">whereStr</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whereList</span><span class="p">)</span>
        <span class="n">whereTuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">whereStr</span><span class="p">),</span> <span class="n">whereTuple</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>

    <span class="c1"># FIXME: Seems to be duplicated and a subset of selectAll</span>
    <span class="c1"># Moreover, it does not translate between &quot;user colums&quot; and</span>
    <span class="c1"># &quot;internal&quot; Objects table columns</span>
<div class="viewcode-block" id="SqliteFlatDb.selectObjectsWhere"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.selectObjectsWhere">[docs]</a>    <span class="k">def</span> <span class="nf">selectObjectsWhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whereStr</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCmd</span><span class="p">(</span><span class="n">whereStr</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">(</span><span class="n">iterate</span><span class="p">)</span></div>

<div class="viewcode-block" id="SqliteFlatDb.deleteObject"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.deleteObject">[docs]</a>    <span class="k">def</span> <span class="nf">deleteObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an existing object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">+</span> <span class="s2">&quot;id=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">objId</span><span class="p">,))</span></div>

<div class="viewcode-block" id="SqliteFlatDb.deleteAll"><a class="viewcode-back" href="../../../api/pyworkflow.mapper.sqlite.html#pyworkflow.mapper.sqlite.SqliteFlatDb.deleteAll">[docs]</a>    <span class="k">def</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all objects from the db. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">missingTables</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executeCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="o">+</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="sqlite.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>