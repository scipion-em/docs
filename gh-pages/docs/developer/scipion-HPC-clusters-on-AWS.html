

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scipion HPC clusters on AWS &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Scipion HPC clusters on AWS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/scipion-HPC-clusters-on-AWS.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="scipion-hpc-clusters-on-aws">
<span id="id1"></span><h1>Scipion HPC clusters on AWS<a class="headerlink" href="#scipion-hpc-clusters-on-aws" title="Permalink to this headline">¶</a></h1>
<p>The following diagram shows a basic HPC cluster architecture on AWS:</p>
<div class="figure align-center">
<img alt="HPC Cluster on AWS" src="../../images/Scipion-cluster-deployment-AWS.png" />
</div>
<p>There are two options to deploy elastic HPC clusters on AWS:</p>
<div class="section" id="id2">
<h2><a class="reference external" href="http://star.mit.edu/cluster">StarCluster</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>StarCluster is a utility developed by MIT for creating and managing distributed
computing clusters hosted on Amazon’s Elastic Compute Cloud (EC2).</p>
<p>Detailed information about StarCluster can be found on its web site but the
following step-by-step guide shows how to deploy ScipionCloud on Amazon’s EC2.</p>
<ul class="simple">
<li>First you need to install StarCluster client on your  machine, which is used to create and manage the clusters.
Follow instructions on the StarCluster <a class="reference external" href="http://star.mit.edu/cluster/docs/latest/installation.html">installation page</a></li>
</ul>
<p>The fastest way is to use Python PIP:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo easy_install StarCluster
</pre></div>
</div>
<p>It is recommended to update it to the latest version from git:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/jtriley/StarCluster.git
<span class="nb">cd</span> StarCluster
sudo python setup.py install
</pre></div>
</div>
<p>You might need to install the following packages: <code class="docutils literal notranslate"><span class="pre">python-dev,</span> <span class="pre">libffi-dev,</span> <span class="pre">libssl-dev</span></code>. +
Execute StarCluster help and choose second option to create the configuration file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster <span class="nb">help</span>
StarCluster - <span class="o">(</span>http://star.mit.edu/cluster<span class="o">)</span>
Software Tools <span class="k">for</span> Academics and Researchers <span class="o">(</span>STAR<span class="o">)</span>
Please submit bug reports to starcluster@mit.edu
cli.py:87 - ERROR - config file /home/user/.starcluster/config does not exist<span class="sb">`</span>
Options:
--------
<span class="o">[</span><span class="m">1</span><span class="o">]</span> Show the StarCluster config template
<span class="o">[</span><span class="m">2</span><span class="o">]</span> Write config template to /home/user/.starcluster/config
<span class="o">[</span>q<span class="o">]</span> Quit
Please enter your selection:

*   Then you need to edit StarCluster configuration file and customize it <span class="k">for</span> your needs. StarCluster provides a http://star.mit.edu/cluster/docs/latest/quickstart.html<span class="o">[</span>quick installation guide<span class="o">]</span> that is good enough to start, although extensive documentation can be found at its site. +
    The following example shows how to customize it <span class="k">for</span> a ScipionCloud cluster with two _t2.medium_ nodes <span class="o">(</span>only some parameters are shown, the rest can be left with their default value<span class="o">)</span>. +
    Add a scipioncluster template <span class="o">(</span>or other name you like<span class="o">)</span> that will be used as default template.
    Also, <span class="nb">enable</span> experimental features <span class="o">(</span>load balancer <span class="k">for</span> elastic clusters, explained later<span class="o">)</span>.
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">####################################</span>
<span class="c1">## StarCluster Configuration File ##</span>
<span class="c1">####################################</span>
<span class="o">[</span>global<span class="o">]</span>
<span class="nv">DEFAULT_TEMPLATE</span><span class="o">=</span>scipioncluster
<span class="c1"># enable experimental features for this release</span>
<span class="nv">ENABLE_EXPERIMENTAL</span><span class="o">=</span>True
</pre></div>
</div>
<ul class="simple">
<li>Replace AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY and AWS_USER_ID with yours, managed on Security Credentials/Access keys and Account settings. +</li>
<li>Select AWS region (ScipionCloud AMI currently exists only on AWS EU Ireland region).</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#############################################</span>
<span class="c1">## AWS Credentials and Connection Settings ##</span>
<span class="c1">#############################################</span>
<span class="o">[</span>aws info<span class="o">]</span>
<span class="c1"># replace these with your AWS keys</span>
<span class="nv">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> XXXXXXXXXXXX
<span class="nv">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> XXXXXXXXXXXXXXXXXXXXXX
<span class="c1"># replace this with your account number (found on account settings)</span>
<span class="nv">AWS_USER_ID</span><span class="o">=</span> XXXXXXXXX

<span class="nv">AWS_REGION_NAME</span> <span class="o">=</span> eu-west-1
<span class="nv">AWS_REGION_HOST</span> <span class="o">=</span> ec2.eu-west-1.amazonaws.com
</pre></div>
</div>
<p>Specify the key pair to use (managed on EC2 / Security Groups / Key pairs)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">###########################</span>
<span class="c1">## Defining EC2 Keypairs ##</span>
<span class="c1">###########################</span>
<span class="o">[</span>key scipion-key<span class="o">]</span>
<span class="nv">KEY_LOCATION</span><span class="o">=</span>~/scipion-key.rsa
</pre></div>
</div>
<p>Define the scipioncluster template: +
Set the cluster size and the instance image and type (although starcluster allows different images and types for master and node, current Scipion AMI is unique for both). +
The list of instance types might not be updated on the config file, you can
check them <a class="reference external" href="https://github.com/I2PC/scipion/wiki/AWS-Instance-Types-for-Starcluster">[here]</a>
You might also want to choose a prefix for the machine names. +
Although not necessary it is recommended to attach an external EBS storage.
Just uncomment the VOLUMES parameter and create a volume section as explained
<a class="reference external" href="https://github.com/I2PC/scipion/wiki/ScipionCloud-on-Amazon-Web-Services-EC2#using-external-ebs-volumes.">[here]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>cluster scipioncluster<span class="o">]</span>
<span class="nv">KEYNAME</span> <span class="o">=</span> scipion-key
<span class="c1"># number of ec2 instances to launch</span>
<span class="nv">CLUSTER_SIZE</span> <span class="o">=</span> <span class="m">2</span>
<span class="c1"># Uncomment to prepent the cluster tag to the dns name of all nodes created</span>
<span class="c1"># using this cluster config.  ie: mycluster-master and mycluster-node001</span>
<span class="c1"># If you choose to enable this option, it&#39;s recommended that you enable it in</span>
<span class="c1"># the DEFAULT_TEMPLATE so all nodes will automatically have the prefix</span>
<span class="nv">DNS_PREFIX</span> <span class="o">=</span> True
<span class="c1"># image id correspoding to ScipionCloud-1.2-beta AMI</span>
<span class="nv">NODE_IMAGE_ID</span> <span class="o">=</span> ami-811e79f8
<span class="nv">NODE_INSTANCE_TYPE</span> <span class="o">=</span> t2.medium
<span class="nv">PERMISSIONS</span> <span class="o">=</span> http, https
<span class="c1">#VOLUMES = scipion_data</span>
</pre></div>
</div>
<p>Configure Security Group permissions.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">############################################</span>
<span class="c1">## Configuring Security Group Permissions ##</span>
<span class="c1">############################################</span>
<span class="c1"># open port 80 on the cluster to the world</span>
<span class="o">[</span>permission http<span class="o">]</span>
<span class="nv">IP_PROTOCOL</span> <span class="o">=</span> tcp
<span class="nv">FROM_PORT</span> <span class="o">=</span> <span class="m">80</span>
<span class="nv">TO_PORT</span> <span class="o">=</span> <span class="m">80</span>

<span class="c1"># open https on the cluster to the world</span>
<span class="o">[</span>permission https<span class="o">]</span>
<span class="nv">IP_PROTOCOL</span> <span class="o">=</span> tcp
<span class="nv">FROM_PORT</span> <span class="o">=</span> <span class="m">443</span>
<span class="nv">TO_PORT</span> <span class="o">=</span> <span class="m">443</span>
----
</pre></div>
</div>
<ul class="simple">
<li>Start the cluster:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster start my-scipion-cluster
</pre></div>
</div>
<ul class="simple">
<li>Log in to the cluster using ubuntu account
Your URL and VNC password will be printed on the terminal.</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster sshmaster -u ubuntu my-scipion-cluster
</pre></div>
</div>
<ul class="simple">
<li>As explained for a single Scipion instance, you can now go to your browser and access the virtual machine through a remote desktop:
<a class="reference external" href="https:///master-ip/vnc.html">https:///master-ip/vnc.html</a> where master-ip can be seen either on the EC2 console or executing the following command:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster listclusters
</pre></div>
</div>
<p>Look for your cluster and get the master IP address from the list of cluster nodes (in this example 54-229-188-230).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>my-scipion-cluster <span class="o">(</span>security group: @sc-my-scipion-cluster<span class="o">)</span>
-----------------------------------------------------------
Launch time: <span class="m">2016</span>-06-15 <span class="m">14</span>:16:49
Uptime: <span class="m">0</span> days, <span class="m">00</span>:19:47
VPC: vpc-8f99f4ea
Subnet: subnet-36480d41
Zone: eu-west-1a
Keypair: scipion-key
EBS volumes: N/A
Cluster nodes:
    my-scipion-cluster-master running i-98351812 ec2-54-229-188-230.eu-west-1.compute.amazonaws.com
    my-scipion-cluster-node001 running i-99351813 ec2-54-229-182-132.eu-west-1.compute.amazonaws.com
Total nodes: <span class="m">2</span>
</pre></div>
</div>
<ul class="simple">
<li>To stop the cluster (and stop being charged) use starcluster too (if you do it through the EC2 console you mess up starcluster own record!).</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster stop my-scipion-cluster
</pre></div>
</div>
<ul class="simple">
<li>To restart the cluster you just need to type:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster start -x my-scipion-cluster
</pre></div>
</div>
<ul class="simple">
<li>To terminate the cluster (and delete VMs but not EBS external volumes)</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster terminate my-scipion-cluster
</pre></div>
</div>
</div>
<div class="section" id="using-external-ebs-volumes-on-the-cluster">
<h2>Using external EBS volumes on the cluster<a class="headerlink" href="#using-external-ebs-volumes-on-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>For the cluster approach the use of an external EBS volume has to be defined on the starcluster configuration file since the attached volume should be shared by all nodes on the cluster.</p>
<p>The volume has to exist and be formatted before it can be attached to the
cluster. This can be done through EC2 dashboard or using starcluster client as
explained <a class="reference external" href="http://star.mit.edu/cluster/docs/latest/manual/volumes.html#create-and-format-a-new-ebs-volume">here</a>.</p>
<p>Then it has to be added to the cluster template (if more than one volume is
added separate it by commas):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VOLUMES</span> <span class="o">=</span> scipion_data
</pre></div>
</div>
<p>and also defined:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#############################</span>
<span class="c1">## Configuring EBS Volumes ##</span>
<span class="c1">#############################</span>
<span class="o">[</span>volume scipion_data<span class="o">]</span>
<span class="nv">VOLUME_ID</span> <span class="o">=</span> vol-3be6f5c9
<span class="nv">MOUNT_PATH</span> <span class="o">=</span> /data
</pre></div>
</div>
<p>Then any cluster created will mount that volume on the path selected.
When the cluster is terminated the EBS volume will persist and could be attached to another cluster.</p>
</div>
<div class="section" id="elastic-cluster">
<h2>Elastic cluster<a class="headerlink" href="#elastic-cluster" title="Permalink to this headline">¶</a></h2>
<p>StarCluster provides a experimental feature, called Elastic Load Balancer, that can be used to balance clusters dynamically depending on the batch system workload (Sun Grid Engine).
To use it you need a cluster running as explained above.
Detailed documentation can be found <a class="reference external" href="http://star.mit.edu/cluster/docs/latest/manual/load_balancer.html">[here]</a> but the basic usage is as follows:</p>
<p>To start balancing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster loadbalance my-scipion-cluster
</pre></div>
</div>
<p>This will keep the cluster size between 1 and CLUSTER_SIZE limits depending on the batch system workload.
This limits can be changed by passing them as parameters to the loadbalance command, for instance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster loadbalance -m <span class="m">20</span> -n <span class="m">2</span> my-scipion-cluster
</pre></div>
</div>
<p>This will create up to 20 nodes if the load requires it and will keep a minimum of 2 nodes.</p>
<p>To see a list of all the parameters that can be passed to the loadbalance just type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>starcluster loadbalance --help
</pre></div>
</div>
<p>The following image, extracted from Starcluster documentation, shows the workflow for each loadbalance loop.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="http://star.mit.edu/cluster/docs/latest/_images/balancer_decision_diagram.jpg"><img alt="Starcluster Loadbalance" src="http://star.mit.edu/cluster/docs/latest/_images/balancer_decision_diagram.jpg" style="width: 500px;" /></a>
</div>
<p>Another interesting parameter to tun up is the maximum time to wait until a node is added (-w option). The default value is 900 seconds (15  minutes) which might be too long.</p>
</div>
<div class="section" id="aws-cfncluster">
<h2>AWS CfnCluster<a class="headerlink" href="#aws-cfncluster" title="Permalink to this headline">¶</a></h2>
<p>It is and open-source tool developed by AWS that allows to create and configure an elastic HPC cluster on AWS EC2. +
We have not yet tested it with ScipionCloud but an easy How-to can be
found <a class="reference external" href="https://aws.amazon.com/getting-started/projects/deploy-elastic-hpc-cluster/">here</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: gh-pages
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="scipion-HPC-clusters-on-AWS.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/docs/developer/scipion-HPC-clusters-on-AWS.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/scipion-HPC-clusters-on-AWS.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>