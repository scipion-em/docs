

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scipion installation system for developers &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facilities/acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Scipion installation system for developers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/scipion-installation-system.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="scipion-installation-system-for-developers">
<span id="scipion-installation-system"></span><h1>Scipion installation system for developers<a class="headerlink" href="#scipion-installation-system-for-developers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">install.py</span> <span class="pre">script</span></code>. It is the responsible of downloading, unpacking, and installing SCons under software/install folder. It also takes the responsability of throwing the output to a log file and stdout.</li>
<li><code class="docutils literal notranslate"><span class="pre">scipion</span> <span class="pre">script</span></code>. Everything in Scipion is centralized through this script. This is done to ensure that the environment is controlled and to simplify the user experience by giving him only one file to look in for searching Scipion actions.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="scenarios">
<h2>Scenarios<a class="headerlink" href="#scenarios" title="Permalink to this headline">¶</a></h2>
<p>Let’s think of the typical installation scenarios as exercises:</p>
<blockquote>
<div><ul class="simple">
<li><strong>Exercise 1</strong>: You need Scipion path to have an additional python module in its self-compiled python. How can you add it to Scipion python?</li>
<li><strong>Exercise 2</strong>: To fix the version of an specific external library, you’ve decided to compile it with Scipion, so a shared library will be placed in software/lib folder, using it whenever you use Scipion. How can you do it?</li>
<li><strong>Exercise 3</strong>: A new EM Package, called TRFEMP (The Really Fantastic EM Package) has appeared, and you don’t want to miss the oportunity to test it with Scipion and compare the results with the other EM Packages in the market. How can you add it?</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="solutions">
<h2>Solutions<a class="headerlink" href="#solutions" title="Permalink to this headline">¶</a></h2>
<p>In most cases, it will be enough to take a look at the definitions of packages
currently in use, in the file <code class="docutils literal notranslate"><span class="pre">install/script.py</span></code>. The script is organized to reflect the 3 scenarios (library, python module, EM package)</p>
<p>If you need to add (or modify) low-level features, <code class="docutils literal notranslate"><span class="pre">install/funcs.py</span></code> is your file.</p>
<div class="section" id="solution-to-exercise-1">
<h3>Solution to exercise 1<a class="headerlink" href="#solution-to-exercise-1" title="Permalink to this headline">¶</a></h3>
<p>In Exercise 1, solution would be very simple. Let’s say you’re trying to add the python module paramiko. With every library, every module and every EM Package in Scipion, there is always a parameter called “default” that determines whether the library, module or package has to be built by default with Scipion. That means, if the user doesn’t specify anything, the job will be done. In other case, an option called “–with-name” being name the name of the library, module or package, will be added to the installation parameters, so the user would be able to use, for example, ./scipion install –with-paramiko.  Let’s say we don’t need paramiko by default, but certain installations may need to install it, then default=false.</p>
<p>The __addModule()__ function has the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li><em>name</em>: the name of the module. ‘paramiko’ in this case. It is mandatory.</li>
<li><em>tar</em>: the compressed file to download with the sources. In case you don’t provide it, it will asume name.tgz.</li>
<li><em>buildDir</em>: the name of the decompress folder. The tarfile must contain a folder with the module, and that may not be “name”, so if you don’t provide it, this will remove “tar.gz” or “tgz” from the tarfile and asume the name of the folder is that.</li>
<li><em>targets</em>: SCons builders (or pseudo-builders) need targets to work. That is how it build its dependency tree. A builder generates a list of targets which will be probably sources for the next builders in the dependency tree. An adequate target would be a file/folder that is mandatory generated by the build process. For example, in a python module, usually a folder is generated inside lib/pythonX.Y/site-packages/ with the name of the module. That is the trick used by addModule() function. When you provide a target, it makes the untar process depends on the download one, and the “setup.py install” will depend on untar result, and in the other hand, will generate as target, the folder software/lib/python2.7/site-packages/name being name the target passed as argument. If no target is passed, then name will be asumed.</li>
<li><em>url</em>: the URL used to download the tarfile. By default, it points to the main scipion site</li>
<li><em>flags</em>: the arguments that may be necessary to pass to the python setup.py install call. In any case, –prefix=software will be asumed, so every module will be built in Scipion architecture.</li>
<li><em>deps</em>: the other elements in which this module may depends on. Usuarlly other builders target may be passed here. Every python module (as it may be obvious) depends on python itself.</li>
<li><em>default</em>: the yet explained default mecanism. If nothing is passed, True is asumed (meaning the module will be built by default).</li>
</ul>
</div></blockquote>
<p>So taking everything into account, it seems like adding paramiko module, would only need to write (in SConscript file) the following line.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">addModule</span><span class="p">(</span>
    <span class="s1">&#39;paramiko&#39;</span><span class="p">,</span>
    <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;paramiko-1.14.0.tgz&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>This means that if the user runs <code class="docutils literal notranslate"><span class="pre">./scipion</span> <span class="pre">install</span> <span class="pre">--with-paramiko</span></code>, then a so-called paramiko python module is downloaded from <a class="reference external" href="http://scipion.cnb.csic.es/files/scipion/software/python/paramiko-1.14.0.tgz">http://scipion.cnb.csic.es/files/scipion/software/python/paramiko-1.14.0.tgz</a> URL to the =software/tmp= folder, decompressed as  =software/paramiko/paramiko-1.14.0= and then =software/bin/python setup.py install –prefix=software= will be executed, installing the module under software/lib/python2.7/site-packages/paramiko. The resulting log will be stored at =software/log/paramiko.log=. All those actions will be committed just by adding that simple line.</p>
<p>But… wait a moment… wasn’t it !AddModule() instead of addModule()? Yes, don’t panic. In this case, we’ve also supplied a function called addModule in the SConscript file, just to avoid needing to introduce =deps=[python]= (adding automatically python dependency). But please, note that it is the same as putting the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AddModule</span><span class="p">(</span>
    <span class="s1">&#39;paramiko&#39;</span><span class="p">,</span>
    <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;paramiko-1.14.0.tgz&#39;</span><span class="p">,</span>
    <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="n">python</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="solution-to-exercise-2">
<h3>Solution to exercise 2<a class="headerlink" href="#solution-to-exercise-2" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Exercise 2 is also so simple and is an example of how can we compile a new external library. In this case, developer will only need to add a line in SConscript, but this time it will be a call to ==AddLibrary()==. Let’s say it’s sqlite library. If we see the !AddLibrary() params…</dt>
<dd><ul class="first last simple">
<li><em>name</em>: similar to !AddModule, this will be ‘sqlite’.</li>
<li><em>tar</em>: same as in !AddModule, this time we will use ‘sqlite-3.6.23.tgz’. If we don’t say anything, it would look for ‘sqlite.tgz’</li>
<li><em>buildDir</em>: as in !AddModule, it will be generated automatically as ‘sqlite-3.6.23’ taking it from tar name without the extension.</li>
<li><em>targets</em>: in libraries, we will expect the build process to generate a shared library. Starting from software folder, the targets will be taken here. So in this case we will use ‘lib/libsqlite3.so’ (we know that installation procedure will generate that file).</li>
<li><em>url</em>: as in !AddModule, in this case URL can be also guessed, but this time the guessed address will be <a class="reference external" href="http://.../files/scipion/software/external/name">http://…/files/scipion/software/external/name</a> (being name ‘sqlite’ in our case).</li>
<li><em>flags</em>: as we want to pass, during ./configure process, the line “./configure CPPFLAGS=-w CFLAGS=-DSQLITE_ENABLE_UPDATE_DELETE_LIMIT=1”, we will set flags like flags=[‘CPPFLAGS=-w’, ‘CFLAGS=-DSQLITE_ENABLE_UPDATE_DELETE_LIMIT=1’].</li>
<li><em>autoConfigTarget</em>: this is very specific for !AutoConfig builder. As a result of the ./configure execution, some files will be generated, and those files modification will be used to detect whether or not the make order must be rebuilt. For that purpose, you can pass an specific target. Usually this target is the Makefile itself, so by default, if we don’t say anything, ‘Makefile’ will be used.</li>
<li><em>deps</em>: same behavior as in !AddModule, but in this case, no dep is asumed by default.</li>
<li><em>default</em>: if nothing is passed, True is assumed.</li>
</ul>
</dd>
</dl>
<p>We can then write, to solved the exercise, the following line in SConscript:</p>
<p>That line will cause scons execution to download !http://scipion.cnb.csic.es/files/scipion/software/external/sqlite-3.6.23.tgz to software/tmp folder, then unpacked to software/tmp/sqlite-3.6.23 folder, then configured with the order “./configure ‘CPPFLAGS=-w CFLAGS=-DSQLITE_ENABLE_UPDATE_DELETE_LIMIT=1’” and finally executed ‘make install’ on that folder. The resulting log will be stored at software/log/sqlite_configure.log and software/log/sqlite_make.log</p>
</div>
<div class="section" id="solution-to-exercise-3">
<h3>Solution to exercise 3<a class="headerlink" href="#solution-to-exercise-3" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>The exercise 3 only aims building a new EM Package called ‘TRFEMP’. In this case we will use ==AddPackage()== pseudo-builder. This one has the arguments described below:</dt>
<dd><ul class="first last simple">
<li><em>name</em>: as usually, we need a key to name the package. In this case, we will use ‘TRFEMP’</li>
<li><em>tar</em>: same behavior as in the other pseudo-builders. If we don’t say anything, it will assume file ‘TRFEMP.tgz’.</li>
<li><em>buildDir</em>: imagine that TRFEMP packages a folder named trfemp-1.0, and inside it, there’s a unix folder, where configure script is placed. Then buildDir will be ‘trfemp-1.0/unix’. If we don’t pass any parameter, TRFEMP would be used.</li>
<li><em>url</em>: As we placed this file in <a class="reference external" href="http://scipion.cnb.csic.es/files/scipion/software/em/TRFEMP.tgz">http://scipion.cnb.csic.es/files/scipion/software/em/TRFEMP.tgz</a> address, there’s no need to explicit the URL. It will be automatically generated.</li>
<li><em>extraActions</em>: Packages follow a workflow a little bit different from modules and libraries. They’re not suposed con compile as usual with ./configure &amp;&amp; make &amp;&amp; make install, but they’re suposed to be a little bit complicated. In case the compilation can be driven unattended, then there’s a way to provided the orders to Scipion installer and let it compile. Otherwise, or just because we already have the package compiled in our system, there is a way to automatically link an already present and compiled package, and this is by using the option –with-name=/path/to/package/home (using package name instead of “name” and the proper path). In that case there will be a link created in software/em/name pointing to that installation. Now imagine that TRFEMP can be simply compiled by executing 2 commands. The first one is “./configure –funny-option”, and among others, that command generates a Makefile, which can be executed by using “make –very-funny-option” creating a trfemp binary. The extraActions param expects a list of tuples. Each tuple is built in the form (target, command), so in this case, we would configure extraActions=[(‘Makefile’, ‘./configure –funny-option’), (‘trfemp’, ‘make –very-funny-option’)].</li>
<li><em>deps</em>: deps will behave as usually.</li>
<li><em>default</em>: like the rest of the cases.</li>
</ul>
</dd>
</dl>
<p>To include the TRFEMP Package, add to =install/script.py= something like…</p>
<p>If the TRFEMP package is not installed, executing =./scipion install TRFEMP= will proceed with the download, unpacking, etc.</p>
</div>
<div class="section" id="xmipp">
<h3>Xmipp<a class="headerlink" href="#xmipp" title="Permalink to this headline">¶</a></h3>
<p>Xmipp is installed by default with a similar philosophy: =scipion= uses =install/script.py= to call =install/scons.py=.
=scons.py= runs SCons using scipion environment (python binary, variables, etc).
Actual Xmipp installation steps (following SCons conventions) are defined in =software/em/xmipp/scipion_sconscript=
Most of the configuration of Xmipp compilation is done with environment variables. For example, if you need to specify CUDA settings, you can define the variables =CUDA_SDK_PATH=, =CUDA_LIB_PATH= and =CUDA=. As usual, it is easier to set those variables in the scipion config files. Again, for CUDA it would mean to edit =scipion.conf=, set =CUDA= to True (and change the other variables if needed)</p>
</div>
<div class="section" id="history">
<h3>History<a class="headerlink" href="#history" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://scipion.cnb.csic.es/old-docs/bin/view/TWiki/OldScipionInstallationWithScons">[Learn more about the traditional scons-based installation]</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: gh-pages
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="scipion-installation-system.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/docs/developer/scipion-installation-system.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/scipion-installation-system.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>