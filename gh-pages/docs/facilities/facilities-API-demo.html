

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>API workflows &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing Scipion v2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="facilities.html">Streaming Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="acquisition-simulation.html">Tutorial for Facilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>API workflows</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/facilities/facilities-API-demo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../images/scipion_logo.gif"><img alt="scipion logo" src="../../images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="api-workflows">
<span id="facilities-api-demo"></span><h1>API workflows<a class="headerlink" href="#api-workflows" title="Permalink to this headline">¶</a></h1>
<p>To create Scipion workflows from Python scripts, you only need to do 3 logical
steps:</p>
<ol class="arabic simple">
<li><a class="reference external" href="facilities-API-demo#creating-a-project">Create an empty project</a>.</li>
<li><a class="reference external" href="facilities-API-demo#including-protocols">Create protocols</a>.</li>
<li><a class="reference external" href="facilities-API-demo#registering-protocols">Register that protocols to the project</a>.</li>
</ol>
<p>In addition, we include an special mention in <a class="reference external" href="facilities-API-demo#setting-em-objects-as-protocol-inputs">how to set EM objects as protocol
inputs</a>.</p>
<div class="section" id="getting-config-and-user-parameters">
<h2>0. Getting config and user parameters<a class="headerlink" href="#getting-config-and-user-parameters" title="Permalink to this headline">¶</a></h2>
<p>First of all, we need to get all the <a class="reference external" href="acquisition-simulation#config-file">config</a>
and <a class="reference external" href="acquisition-simulation#wizard-for-user-parameters">user</a>
parameters retrieved in <a class="reference external" href="acquisition-simulation">previous steps</a>.
In this case, we have stored all these parameters in the <cite>configDict</cite> dictionary
that is gotten as argument from the wizard
(<a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/acquisition_workflow.py">form_launcher.py</a>).
In addition, we import the <em>UPPER_CASE</em> constants from <a class="reference external" href="https://github.com/I2PC/em-facilities/blob/master/usingAPI_demo/constants.py">constants.py</a>
to ensure that we use the same that in the wizard
and also to easy get values from the <cite>configDict</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">preprocessWorkflow</span><span class="p">(</span><span class="n">configDict</span><span class="p">):</span>

    <span class="n">numCpus</span> <span class="o">=</span> <span class="p">(</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NUM_CPU</span><span class="p">)</span> <span class="k">if</span> <span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NUM_CPU</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                   <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;nproc&#39;</span><span class="p">,</span><span class="s1">&#39;--all&#39;</span><span class="p">],</span>
                                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</pre></div>
</div>
<p>Note that we are taking the number of CPUs from the <cite>configDict</cite> via the <cite>NUM_CPU</cite>
constant.</p>
</div>
<div class="section" id="creating-a-project">
<h2>1. Creating a project<a class="headerlink" href="#creating-a-project" title="Permalink to this headline">¶</a></h2>
<p>To create an empty project, you only must use the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.project.manager.html#pyworkflow.project.manager.Manager.createProject">Manager.createProject()</a> method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyworkflow.project</span> <span class="kn">import</span> <span class="n">Manager</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">createProject</span><span class="p">(</span><span class="n">configDict</span><span class="p">[</span><span class="n">PROJECT_NAME</span><span class="p">],</span>
                                <span class="n">location</span><span class="o">=</span><span class="n">configDict</span><span class="p">[</span><span class="n">SCIPION_PROJECT</span><span class="p">]</span>
</pre></div>
</div>
<p>where <cite>PROJECT_NAME</cite> and <cite>SCIPION_PROJECT</cite> constants return the project name and
the project path from the <cite>configDict</cite>, respectively.</p>
</div>
<div class="section" id="including-protocols">
<h2>2. Including protocols<a class="headerlink" href="#including-protocols" title="Permalink to this headline">¶</a></h2>
<p>Once a project is created, we must fill it with protocols.</p>
<p>To be able to instance a protocol, it must be imported from the containing plugin
(or from Scipion). Here an example of importing the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.protocol.protocol_import.micrographs.html#pyworkflow.em.protocol.protocol_import.micrographs.ProtImportMovies">Import Movies</a> protocol
from Scipion and the <a class="reference external" href="https://github.com/scipion-em/scipion-em-motioncorr/blob/master/motioncorr/protocols/protocol_motioncorr.py">Motioncor</a> protocol from the
<a class="reference external" href="https://github.com/scipion-em/scipion-em-motioncorr">scipion-em-motioncor</a>
plugin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="kn">as</span> <span class="nn">pwutils</span>

<span class="kn">from</span> <span class="nn">pyworkflow.em.protocol</span> <span class="kn">import</span> <span class="n">ProtImportMovies</span>
<span class="n">ProtMotionCorr</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;motioncorr.protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;ProtMotionCorr&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that we use the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.utils.utils.html#pyworkflow.utils.utils.importFromPlugin">pwutils.importFromPlugin()</a>
method to import classes from plugins in order to avoid uncontrolled errors
if that plugin is not installed in the current Scipion.</p>
<p>To create a protocol, the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.project.project.html#pyworkflow.project.project.Project">Project</a> class has
a method to make new protocols.
For instance, for the <em>Import movies</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">protImport</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newProtocol</span><span class="p">(</span>
                  <span class="n">ProtImportMovies</span><span class="p">,</span>
                  <span class="n">objLabel</span><span class="o">=</span><span class="s1">&#39;import movies&#39;</span><span class="p">,</span>
                  <span class="n">importFrom</span><span class="o">=</span><span class="n">ProtImportMovies</span><span class="o">.</span><span class="n">IMPORT_FROM_FILES</span><span class="p">,</span>
                  <span class="n">filesPath</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">),</span>
                  <span class="n">filesPattern</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PATTERN</span><span class="p">),</span>
                  <span class="n">amplitudeContrast</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">AMP_CONTR</span><span class="p">),</span>
                  <span class="n">sphericalAberration</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SPH_AB</span><span class="p">),</span>
                  <span class="n">voltage</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">VOL_KV</span><span class="p">),</span>
                  <span class="n">samplingRate</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SAMPLING</span><span class="p">),</span>
                  <span class="n">doseInitial</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DOSE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                  <span class="n">dosePerFrame</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DOSEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                  <span class="n">gainFile</span><span class="o">=</span><span class="n">gainFn</span><span class="p">,</span>
                  <span class="n">dataStreaming</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">timeout</span><span class="o">=</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="mi">43200</span><span class="p">)</span>  <span class="c1"># 12h default</span>
                  <span class="p">)</span>
</pre></div>
</div>
<p>Notice that the first argument of the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.project.project.html#pyworkflow.project.project.Project.newProtocol">project.newProtocol()</a> method is an
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol">EM-protocol</a>
subclass, corresponding to that protocol to be created (and imported above).
The following arguments are all those <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.FormElement">form parameters</a>
defined by <a class="reference external" href="https://scipion-em.github.io/docs/modules/pyworkflow/em/protocol/protocol_import/micrographs.html#ProtImportMicBase">the protocol</a> using the
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.protocol.params.html#pyworkflow.protocol.params.ElementGroup.addParam">addParam()</a> method.
If a parameter is not set, the default value is used.</p>
</div>
<div class="section" id="registering-protocols">
<h2>3. Registering protocols<a class="headerlink" href="#registering-protocols" title="Permalink to this headline">¶</a></h2>
<p>Once a protocol is instanced, we should register it, which means writing it in
disk at the data bases. This can be done in two <strong>alternative</strong> ways:</p>
<ul>
<li><p class="first"><strong>Saving the protocol</strong> using the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.project.project.html#pyworkflow.project.project.Project.saveProtocol">project.saveProtocol()</a>
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">project</span><span class="o">.</span><span class="n">saveProtocol</span><span class="p">(</span><span class="n">protImport</span><span class="p">)</span>
</pre></div>
</div>
<p>This option is conceptually similar to create a <em>JSON</em> block when making
<a class="reference external" href="facilities-workflows.html#static-templates">Scipion’s templates</a>.
Therefore, that protocol does not run until the whole workflow will be
launched after including all the rest protocols (see <a class="reference external" href="acquisition-simulation.html#launch-an-open-projects">launch an open workflows</a>).
Thus, the output objects from the saved protocols are not created yet and,
then, no information can be gotten from them. Even though, they
can be used for the next protocols with no inconvenience as we will see below.</p>
</li>
<li><p class="first"><strong>Launching the protocol</strong> using the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.project.project.html#pyworkflow.project.project.Project.launchProtocol">project.launchProtocol()</a>
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">project</span><span class="o">.</span><span class="n">launchProtocol</span><span class="p">(</span><span class="n">protImport</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>This option is to launch the protocol as soon as we register it
(conceptually similar to a manual processing using the GUI).
The drawback here is that we must take into account that all inputs have to
be ready before launching a certain protocol.
In this way, we must monitor the outputs of the protocols to prevent launching
posterior protocols with empty inputs.</p>
<p>Notice that we introduce <cite>wait=False</cite> to continue with the script.
If <cite>wait=True</cite>, the script stops here until that protocol finishes and this
doesn’t make sense for streaming processing.</p>
</li>
</ul>
<p>These two options are noticeable different and we must take a procedure decision,
since we should do the same for all the protocols.</p>
</div>
<div class="section" id="setting-em-objects-as-protocol-inputs">
<h2>4. Setting EM objects as protocol inputs<a class="headerlink" href="#setting-em-objects-as-protocol-inputs" title="Permalink to this headline">¶</a></h2>
<p>We have seen how to set protocol parameters in the initialization arguments.
However, the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.object.html#pyworkflow.object.Object.set">set(value)</a> method sets a value to any protocol parameter.
For instance,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">protMotionCor</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newProtocol</span><span class="p">(</span><span class="n">ProtMotionCorr</span><span class="p">)</span>
<span class="n">protMotionCor</span><span class="o">.</span><span class="n">doApplyDoseFilter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DOSEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>where <a class="reference external" href="https://github.com/scipion-em/scipion-em-motioncorr/blob/d9397a6dd5c9493a67b08d08f8c2af1e8f580c61/motioncorr/protocols/protocol_motioncorr.py#L50-L55">protMotionCor</a> is initialized in the first line whereas the
<a class="reference external" href="https://github.com/scipion-em/scipion-em-motioncorr/blob/d9397a6dd5c9493a67b08d08f8c2af1e8f580c61/motioncorr/protocols/protocol_motioncorr.py#L167-L171">doApplyDoseFilter</a> is set to <cite>True</cite> if
the <em>dose per frame</em> introduced by the user in <a class="reference external" href="acquisition-simulation#wizard-for-user-parameters">the wizard in previous steps</a> is bigger than 0 or
to <cite>False</cite>, instead.</p>
<p>Until here, we only have set <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.object.html#pyworkflow.object.Scalar">Scalar</a> objects or <a class="reference external" href="https://docs.python.org/2.7/library/stdtypes.html">Built-in Python
Types</a>.
However, usually we want to use <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.EMSet">EMSets outputs</a>
(<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.SetOfMicrographsBase">SetOfMicrographs</a>,
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.SetOfCTF">SetOfCtfs</a>,
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.SetOfCoordinates">SetOfCoordinates</a>,
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.SetOfParticles">SetOfParticles</a>,
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.em.data.html#pyworkflow.em.data.SetOfClasses">SetOfClasses</a>…) from previous protocols as input
for next protocols. At this point, we must take into
account that previous protocols may be not running yet (<a class="reference external" href="facilities-API-demo#registering-protocols">it can be just saved</a>). Then, in that cases, the previous
outputs are not created yet. Therefore it cannot be passed as value in the
<a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.object.html#pyworkflow.object.Object.set">set(value)</a> method. To fix this situations,
we set the whole protocol as input parameter, while indicating which
object should be retrieved in the running time from that protocol by means of
the <a class="reference external" href="https://scipion-em.github.io/docs/api/pyworkflow.object.html#pyworkflow.object.Pointer.setExtended">setExtended()</a> method. For instance,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">protMotionCor</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">protImport</span><span class="p">)</span>
<span class="n">protMotionCor</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">setExtended</span><span class="p">(</span><span class="s1">&#39;ouputMovies&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>where the whole <cite>protImport</cite> protocol is attached to the
<cite>protMotionCor.inputMovies</cite> in the first line and the <cite>outputMovies</cite> is set as
an extension for this parameter, indicating that it will be gotten in the
running time.</p>
<p>If you decided to <a class="reference external" href="facilities-API-demo#registering-protocols">launch protocols as soon as they are created</a>, then a direct
assignation is possible as long as the object is ready</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">protMotionCor</span><span class="o">.</span><span class="n">inputMovies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">protImport</span><span class="o">.</span><span class="n">outputMovies</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that to use this, <cite>protImport</cite> must have an attribute
called <cite>outputMovies</cite> if not, this line will break.</p>
<p>In this case, a waiting function to ensure that the <cite>protImport.outputMovies</cite>
is ready to be used becomes crucial. For instance</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">waitOutput</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">outputAttributeName</span><span class="p">,</span> <span class="n">checkNotEmpty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Wait until the output is being generated by the protocol.</span>
<span class="sd">        Returns False if the TimeOut is reached or True, instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeStep</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># checking every 5 second</span>

    <span class="k">def</span> <span class="nf">_loadProt</span><span class="p">():</span>
        <span class="c1"># Load the last version of the protocol from its own database</span>
        <span class="n">prot2</span> <span class="o">=</span> <span class="n">getProtocolFromDb</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                  <span class="n">protocol</span><span class="o">.</span><span class="n">getDbPath</span><span class="p">(),</span>
                                  <span class="n">protocol</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
        <span class="c1"># Close DB connections</span>
        <span class="n">prot2</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">closeMapper</span><span class="p">()</span>
        <span class="n">prot2</span><span class="o">.</span><span class="n">closeMappers</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">prot2</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prot2</span> <span class="o">=</span> <span class="n">_loadProt</span><span class="p">()</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">prot2</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">outputAttributeName</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">timeStep</span><span class="p">)</span>
        <span class="n">prot2</span> <span class="o">=</span> <span class="n">_loadProt</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="o">/</span><span class="n">timeStep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">outputObject</span> <span class="o">=</span> <span class="n">prot2</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">outputAttributeName</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">outputObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">outputObject</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">timeStep</span><span class="p">)</span>
        <span class="n">prot2</span> <span class="o">=</span> <span class="n">_loadProt</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="o">/</span><span class="n">timeStep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Update the protocol instance to get latest changes</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_updateProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">True</span>

<span class="c1"># Waiting for a non empty ouput from MotioCor2 to continue</span>
<span class="n">waitOutput</span><span class="p">(</span><span class="n">protMotionCor</span><span class="p">,</span> <span class="s1">&#39;outputMicrographs&#39;</span><span class="p">)</span>

<span class="c1"># Importing, creating and launching the gCTF protocol</span>
<span class="n">ProtGctf</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">importFromPlugin</span><span class="p">(</span><span class="s1">&#39;gctf.protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;ProtGctf&#39;</span><span class="p">)</span>
<span class="n">protGCTF</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newProtocol</span><span class="p">(</span><span class="n">ProtGctf</span><span class="p">,</span>
                               <span class="n">objLabel</span><span class="o">=</span><span class="s1">&#39;gCTF estimation&#39;</span><span class="p">,</span>
                               <span class="n">gpuList</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">configDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GCTF</span><span class="p">)))</span>
<span class="n">protCTF2</span><span class="o">.</span><span class="n">inputMicrographs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">protMotionCor</span><span class="o">.</span><span class="n">outputMicrographs</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">launchProtocol</span><span class="p">(</span><span class="n">protGCTF</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># Waiting for at least one CTF estimation to continue</span>
<span class="n">waitOutput</span><span class="p">(</span><span class="n">protGCTF</span><span class="p">,</span> <span class="s1">&#39;outputCTF&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: gh-pages
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="facilities-API-demo.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/docs/facilities/facilities-API-demo.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/facilities/facilities-API-demo.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>