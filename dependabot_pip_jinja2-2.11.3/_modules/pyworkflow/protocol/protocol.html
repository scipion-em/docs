

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyworkflow.protocol.protocol &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyworkflow.protocol.protocol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyworkflow.protocol.protocol</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     J.M. De la Rosa Trevin (delarosatrevin@scilifelab.se) [1]</span>
<span class="c1"># *</span>
<span class="c1"># * [1] SciLifeLab, Stockholm University</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This modules contains classes required for the workflow</span>
<span class="sd">execution and tracking like: Step and Protocol</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">pyworkflow</span> <span class="k">as</span> <span class="nn">pw</span>
<span class="kn">from</span> <span class="nn">pyworkflow.exceptions</span> <span class="k">import</span> <span class="n">ValidationException</span><span class="p">,</span> <span class="n">PyworkflowException</span>
<span class="kn">from</span> <span class="nn">pyworkflow.object</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.log</span> <span class="k">import</span> <span class="n">ScipionLogger</span>
<span class="kn">from</span> <span class="nn">.executor</span> <span class="k">import</span> <span class="p">(</span><span class="n">StepExecutor</span><span class="p">,</span> <span class="n">ThreadStepExecutor</span><span class="p">,</span> <span class="n">MPIStepExecutor</span><span class="p">,</span>
                       <span class="n">QueueStepExecutor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.params</span> <span class="k">import</span> <span class="n">Form</span>

<span class="n">SCHEDULE_LOG</span> <span class="o">=</span> <span class="s1">&#39;schedule.log&#39;</span>


<div class="viewcode-block" id="Step"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step">[docs]</a><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Basic execution unit.</span>
<span class="sd">    It should defines its Input, Output</span>
<span class="sd">    and define a run method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prerequisites</span> <span class="o">=</span> <span class="n">CsvList</span><span class="p">()</span>  <span class="c1"># which steps needs to be done first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultFiles</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Step.getIndex"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getIndex">[docs]</a>    <span class="k">def</span> <span class="nf">getIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span></div>

<div class="viewcode-block" id="Step.setIndex"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setIndex">[docs]</a>    <span class="k">def</span> <span class="nf">setIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">newIndex</span></div>

<div class="viewcode-block" id="Step.getPrerequisites"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getPrerequisites">[docs]</a>    <span class="k">def</span> <span class="nf">getPrerequisites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prerequisites</span></div>

<div class="viewcode-block" id="Step.addPrerequisites"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.addPrerequisites">[docs]</a>    <span class="k">def</span> <span class="nf">addPrerequisites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">newPrerequisites</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">newPrerequisites</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prerequisites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.setPrerequisites"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setPrerequisites">[docs]</a>    <span class="k">def</span> <span class="nf">setPrerequisites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">newPrerequisites</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prerequisites</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPrerequisites</span><span class="p">(</span><span class="o">*</span><span class="n">newPrerequisites</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the necessary conditions to</span>
<span class="sd">        step execution are met&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span> <span class="o">==</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the step have done well its task</span>
<span class="sd">        and accomplish its results&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is the function that will do the real job.</span>
<span class="sd">        It should be override by sub-classes.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Step.setRunning"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setRunning">[docs]</a>    <span class="k">def</span> <span class="nf">setRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The the state as STATE_RUNNING and</span>
<span class="sd">        set the init and end times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">STATUS_RUNNING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Clean previous error message</span></div>

<div class="viewcode-block" id="Step.getError"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getError">[docs]</a>    <span class="k">def</span> <span class="nf">getError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span></div>

<div class="viewcode-block" id="Step.getErrorMessage"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getErrorMessage">[docs]</a>    <span class="k">def</span> <span class="nf">getErrorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getError</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.setFailed"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setFailed">[docs]</a>    <span class="k">def</span> <span class="nf">setFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the run failed and store an error message. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizeStep</span><span class="p">(</span><span class="n">STATUS_FAILED</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.setAborted"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setAborted">[docs]</a>    <span class="k">def</span> <span class="nf">setAborted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the status to aborted and updates the endTime. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizeStep</span><span class="p">(</span><span class="n">STATUS_ABORTED</span><span class="p">,</span> <span class="s2">&quot;Aborted by user.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.setFinished"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setFinished">[docs]</a>    <span class="k">def</span> <span class="nf">setFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the status to finish updates the end time &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizeStep</span><span class="p">(</span><span class="n">STATUS_FINISHED</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_finalizeStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Closes the step, setting up the endTime and optionally an error message&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="Step.setSaved"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setSaved">[docs]</a>    <span class="k">def</span> <span class="nf">setSaved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the status to saved and updated the endTime. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">STATUS_SAVED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Clean previous error message</span></div>

<div class="viewcode-block" id="Step.getStatus"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getStatus">[docs]</a>    <span class="k">def</span> <span class="nf">getStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">STATUS_NEW</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.getElapsedTime"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.getElapsedTime">[docs]</a>    <span class="k">def</span> <span class="nf">getElapsedTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot; Return the time that took to run</span>
<span class="sd">        (or the actual running time if still is running )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">default</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">datetime</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">datetime</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>

        <span class="k">return</span> <span class="n">elapsed</span></div>

<div class="viewcode-block" id="Step.setStatus"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setStatus">[docs]</a>    <span class="k">def</span> <span class="nf">setStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.setInteractive"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.setInteractive">[docs]</a>    <span class="k">def</span> <span class="nf">setInteractive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.isActive"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isActive">[docs]</a>    <span class="k">def</span> <span class="nf">isActive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ACTIVE_STATUS</span></div>

<div class="viewcode-block" id="Step.isFinished"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isFinished">[docs]</a>    <span class="k">def</span> <span class="nf">isFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_FINISHED</span></div>

<div class="viewcode-block" id="Step.isRunning"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isRunning">[docs]</a>    <span class="k">def</span> <span class="nf">isRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_RUNNING</span></div>

<div class="viewcode-block" id="Step.isFailed"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isFailed">[docs]</a>    <span class="k">def</span> <span class="nf">isFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_FAILED</span></div>

<div class="viewcode-block" id="Step.isSaved"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isSaved">[docs]</a>    <span class="k">def</span> <span class="nf">isSaved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_SAVED</span></div>

<div class="viewcode-block" id="Step.isScheduled"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isScheduled">[docs]</a>    <span class="k">def</span> <span class="nf">isScheduled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_SCHEDULED</span></div>

<div class="viewcode-block" id="Step.isAborted"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isAborted">[docs]</a>    <span class="k">def</span> <span class="nf">isAborted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_ABORTED</span></div>

<div class="viewcode-block" id="Step.isLaunched"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isLaunched">[docs]</a>    <span class="k">def</span> <span class="nf">isLaunched</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_LAUNCHED</span></div>

<div class="viewcode-block" id="Step.isInteractive"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isInteractive">[docs]</a>    <span class="k">def</span> <span class="nf">isInteractive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Step.isWaiting"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.isWaiting">[docs]</a>    <span class="k">def</span> <span class="nf">isWaiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_WAITING</span></div>

<div class="viewcode-block" id="Step.run"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Step.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do the job of this step&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRunning</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_RUNNING</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInteractive</span><span class="p">():</span>
                    <span class="c1"># If the Step is interactive, after run</span>
                    <span class="c1"># it will be waiting for use to mark it as DONE</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_INTERACTIVE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FINISHED</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">PyworkflowException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">redStr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setFailed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setFailed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div></div>
            <span class="c1"># raise #only in development</span>
            <span class="c1"># finally:</span>
            <span class="c1">#     self.endTime.set(dt.datetime.now())</span>


<div class="viewcode-block" id="FunctionStep"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.FunctionStep">[docs]</a><span class="k">class</span> <span class="nc">FunctionStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is a Step wrapper around a normal function</span>
<span class="sd">    This class will ease the insertion of Protocol function steps</span>
<span class="sd">    through the function _insertFunctionStep&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">funcArgs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Params:</span>
<span class="sd">            func: the function that will be executed.</span>
<span class="sd">            funcName: the name assigned to that function (will be stored)</span>
<span class="sd">            *funcArgs: argument list passed to the function (serialized and stored)</span>
<span class="sd">            **kwargs: extra parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Step</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>  <span class="c1"># Function should be set before run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">funcArgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcName</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">funcName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argsStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">funcArgs</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setInteractive</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">STATUS_WAITING</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_runFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the possible result files after running the function. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run the function and check the result files if any. &quot;&quot;&quot;</span>
        <span class="n">resultFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runFunc</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resultFiles</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">resultFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">resultFiles</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resultFiles</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultFiles</span><span class="p">):</span>
            <span class="n">missingFiles</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">missingPaths</span><span class="p">(</span><span class="o">*</span><span class="n">resultFiles</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingFiles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Missing filePaths: &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missingFiles</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultFiles</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resultFiles</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This type of Step, will simply check</span>
<span class="sd">        as postconditions that the result filePaths exists&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultFiles</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">filePaths</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultFiles</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">missingPaths</span><span class="p">(</span><span class="o">*</span><span class="n">filePaths</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compare with other FunctionStep&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcName</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">funcName</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">argsStr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">argsStr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcName</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>


<div class="viewcode-block" id="RunJobStep"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.RunJobStep">[docs]</a><span class="k">class</span> <span class="nc">RunJobStep</span><span class="p">(</span><span class="n">FunctionStep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This Step will wrapper the commonly used function runJob</span>
<span class="sd">    for launching specific programs with some parameters.</span>
<span class="sd">    The runJob function should be provided by the protocol</span>
<span class="sd">    when inserting a new RunJobStep&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runJobFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">programName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">resultFiles</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">FunctionStep</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runJobFunc</span><span class="p">,</span> <span class="s1">&#39;runJob&#39;</span><span class="p">,</span> <span class="n">programName</span><span class="p">,</span>
                              <span class="n">arguments</span><span class="p">)</span>
        <span class="c1"># Number of mpi and threads used to run the program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__runJob</span> <span class="o">=</span> <span class="n">runJobFunc</span>  <span class="c1"># Store the current function to run the job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_runFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wrap around runJob function&quot;&quot;&quot;</span>
        <span class="c1"># We know that:</span>
        <span class="c1">#  _func: is the runJob function</span>
        <span class="c1">#  _args[0]: is the program name</span>
        <span class="c1">#  _args[1]: is the arguments to the program</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">numberOfMpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
        <span class="c1"># TODO: Add the option to return resultFiles</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># return program name</span></div>


<div class="viewcode-block" id="StepSet"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.StepSet">[docs]</a><span class="k">class</span> <span class="nc">StepSet</span><span class="p">(</span><span class="n">Set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Special type of Set for storing steps. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">mapperClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Set</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">mapperClass</span><span class="p">,</span> <span class="n">classesDict</span><span class="o">=</span><span class="nb">globals</span><span class="p">(),</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Protocol"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol">[docs]</a><span class="k">class</span> <span class="nc">Protocol</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The Protocol is a higher type of Step.</span>
<span class="sd">    It also have the inputs, outputs and other Steps properties,</span>
<span class="sd">    but contains a list of steps that are executed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Version where protocol appeared first time</span>
    <span class="n">_lastUpdateVersion</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">VERSION_1</span>
    <span class="n">_stepsCheckSecs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1"># Protocol develop status: PROD, BETA, NEW</span>
    <span class="n">_devStatus</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">PROD</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Step</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of steps that will be executed</span>
        <span class="c1"># All generated filePaths should be inside workingDir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workingDir&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mapper&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="n">CsvList</span><span class="p">()</span>
        <span class="c1"># This flag will be used to annotate it output are already &quot;migrated&quot;</span>
        <span class="c1">#  and available in the _outputs list. Therefore iterating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_useOutputList</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Expert level needs to be defined before parsing params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expertLevel</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expertLevel&#39;</span><span class="p">,</span> <span class="n">LEVEL_NORMAL</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createVarsFromDefinition</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stdOut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stdErr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fOut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fErr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">class</span> <span class="nc">BasicLog</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">BasicLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># text buffer for reading log files</span>
        <span class="c1"># Project to which the protocol belongs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Filename templates dict that will be used by _getFileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filenamesDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># This will be used at project load time to check if</span>
        <span class="c1"># we need to update the protocol with the data from run.db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastUpdateTimeStamp</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>

        <span class="c1"># For non-parallel protocols mpi=1 and threads=1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowMpi</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;numberOfMpi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowMpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allowThreads</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;numberOfThreads&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowThreads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check if MPI or threads are passed in **kwargs, mainly used in tests</span>
        <span class="k">if</span> <span class="s1">&#39;numberOfMpi&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfMpi&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;numberOfThreads&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfThreads&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hostName&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostName</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hostName&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hostFullName&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostFullName</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>

        <span class="c1"># Maybe this property can be inferred from the</span>
        <span class="c1"># prerequisites of steps, but is easier to keep it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">=</span> <span class="n">STEPS_SERIAL</span>

        <span class="c1"># Run mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runMode&#39;</span><span class="p">,</span> <span class="n">MODE_RESUME</span><span class="p">))</span>
        <span class="c1"># Use queue system?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_useQueue</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Store a json string with queue name</span>
        <span class="c1"># and queue parameters (only meaningful if _useQueue=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueShown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobId</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>  <span class="c1"># Store queue job id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsDone</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numberOfSteps</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># For visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowHeader</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Create an String variable to allow some protocol to precompute</span>
        <span class="c1"># the summary message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methodsVar</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="c1"># Create a variable to know if the protocol has expert params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasExpert</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Store warnings here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Get a lock for threading execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_storeAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrList</span><span class="p">,</span> <span class="n">attrDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store all attributes in attrDict as</span>
<span class="sd">        attributes of self, also store the key in attrList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrList</span><span class="p">:</span>
                <span class="n">attrList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defineInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function should be used to define</span>
<span class="sd">        those attributes considered as Input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defineOutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function should be used to specify</span>
<span class="sd">        expected outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deleteChild</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertChild</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Store attributes in _output (this does not persist them!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeAttributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Persist outputs list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertChild</span><span class="p">(</span><span class="s2">&quot;_outputs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_useOutputList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertChild</span><span class="p">(</span><span class="s2">&quot;_useOutputList&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useOutputList</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputName</span><span class="p">,</span> <span class="n">outputSet</span><span class="p">,</span>
                         <span class="n">state</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">STREAM_OPEN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use this function when updating an Stream output set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tryUpdateOutputSet</span><span class="p">(</span><span class="n">outputName</span><span class="p">,</span> <span class="n">outputSet</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__tryUpdateOutputSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputName</span><span class="p">,</span> <span class="n">outputSet</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">STREAM_OPEN</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update the set with the streamState value (either OPEN or CLOSED)</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">setStreamState</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">outputName</span><span class="p">):</span>
                <span class="n">outputSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>  <span class="c1"># Write to commit changes</span>
                <span class="n">outputAttr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputName</span><span class="p">)</span>
                <span class="c1"># Copy the properties to the object contained in the protocol</span>
                <span class="n">outputAttr</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">outputSet</span><span class="p">,</span> <span class="n">copyId</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Persist changes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">outputAttr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Here the defineOutputs function will call the write() method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">outputName</span><span class="p">:</span> <span class="n">outputSet</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">outputSet</span><span class="p">)</span>
            <span class="c1"># Close set database to avoid locking it</span>
            <span class="n">outputSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error trying to update output of protocol, tries=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tries</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">tries</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tryUpdateOutputSet</span><span class="p">(</span><span class="n">outputName</span><span class="p">,</span> <span class="n">outputSet</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                          <span class="n">tries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Protocol.hasExpert"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.hasExpert">[docs]</a>    <span class="k">def</span> <span class="nf">hasExpert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function checks if the protocol has</span>
<span class="sd">        any expert parameter&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasExpert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hasExpert</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">paraName</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">iterAllParams</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">isExpert</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_hasExpert</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasExpert</span></div>

<div class="viewcode-block" id="Protocol.getProject"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getProject">[docs]</a>    <span class="k">def</span> <span class="nf">getProject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__project</span></div>

<div class="viewcode-block" id="Protocol.setProject"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setProject">[docs]</a>    <span class="k">def</span> <span class="nf">setProject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__project</span> <span class="o">=</span> <span class="n">project</span></div>

<div class="viewcode-block" id="Protocol.hasDefinition"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.hasDefinition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hasDefinition</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the protocol has some definition.</span>
<span class="sd">        This can help to detect &quot;abstract&quot; protocol that</span>
<span class="sd">        only serve as base for other, not to be instantiated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_definition&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.isNew"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isNew">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isNew</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_devStatus</span> <span class="o">==</span> <span class="n">pw</span><span class="o">.</span><span class="n">NEW</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_devStatus</span> <span class="o">==</span> <span class="n">pw</span><span class="o">.</span><span class="n">PROD</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lastUpdateVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pw</span><span class="o">.</span><span class="n">OLD_VERSIONS</span></div>

<div class="viewcode-block" id="Protocol.isBeta"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isBeta">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isBeta</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_devStatus</span> <span class="o">==</span> <span class="n">pw</span><span class="o">.</span><span class="n">BETA</span></div>

<div class="viewcode-block" id="Protocol.getDefinition"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getDefinition">[docs]</a>    <span class="k">def</span> <span class="nf">getDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Access the protocol definition. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span></div>

<div class="viewcode-block" id="Protocol.getParam"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getParam">[docs]</a>    <span class="k">def</span> <span class="nf">getParam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a _definition param give its name. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getEnumText"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getEnumText">[docs]</a>    <span class="k">def</span> <span class="nf">getEnumText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function will retrieve the text value</span>
<span class="sd">        of an enum parameter in the definition, taking the actual value in</span>
<span class="sd">        the protocol.</span>
<span class="sd">        Params:</span>
<span class="sd">            paramName: the name of the enum param.</span>
<span class="sd">        Returns:</span>
<span class="sd">            the string value corresponding to the enum choice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>

<div class="viewcode-block" id="Protocol.evalParamCondition"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.evalParamCondition">[docs]</a>    <span class="k">def</span> <span class="nf">evalParamCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Eval if the condition of paramName in _definition</span>
<span class="sd">        is satisfied with the current values of the protocol attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">evalParamCondition</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.evalExpertLevel"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.evalExpertLevel">[docs]</a>    <span class="k">def</span> <span class="nf">evalExpertLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the expert level evaluation for a param with the given name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalParamExpertLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">))</span></div>

<div class="viewcode-block" id="Protocol.evalParamExpertLevel"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.evalParamExpertLevel">[docs]</a>    <span class="k">def</span> <span class="nf">evalParamExpertLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if the param has an expert level is less than</span>
<span class="sd">        the one for the whole protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">param</span><span class="o">.</span><span class="n">expertLevel</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expertLevel</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.iterDefinitionAttributes"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.iterDefinitionAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">iterDefinitionAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all the attributes from definition. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">iterParams</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">paramName</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getDefinitionDict"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getDefinitionDict">[docs]</a>    <span class="k">def</span> <span class="nf">getDefinitionDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Similar to getObjDict, but only for those</span>
<span class="sd">        params that are in the form.</span>
<span class="sd">        This function is used for export protocols as json text file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;object.className&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;object.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;object.label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;object.comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjComment</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_useQueue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useQueue</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_prerequisites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prerequisites</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_queueParams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="n">od</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">attrName</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">attrName</span><span class="p">]</span> <span class="o">=</span> <span class="n">od</span><span class="p">[</span><span class="n">attrName</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Protocol.processImportDict"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.processImportDict">[docs]</a>    <span class="k">def</span> <span class="nf">processImportDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importDict</span><span class="p">,</span> <span class="n">importDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used when we import a workflow from a json to process or</span>
<span class="sd">        adjust the json data for reproducibility purposes e.g. resolve relative paths</span>
<span class="sd">        Params:</span>
<span class="sd">        importDict: Dict of the protocol that we got from the json</span>
<span class="sd">        importDir: dir of the json we&#39;re importing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">importDict</span></div>

<div class="viewcode-block" id="Protocol.iterDefinitionSections"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.iterDefinitionSections">[docs]</a>    <span class="k">def</span> <span class="nf">iterDefinitionSections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all the section of the definition. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">iterSections</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">section</span></div>

<div class="viewcode-block" id="Protocol.iterInputAttributes"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.iterInputAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">iterInputAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over the main input parameters</span>
<span class="sd">        of this protocol. Now the input are assumed to be these attribute</span>
<span class="sd">        which are pointers and have no condition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> have been overwritten to type </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PointerList</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">:</span>
                    <span class="c1"># the same key is returned for all items inside the</span>
                    <span class="c1"># PointerList, this is used in viewprotocols.py</span>
                    <span class="c1"># to group them inside the same tree element</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">isPointer</span><span class="p">()</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span>

            <span class="c1"># Consider here scalars with pointers inside</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">hasPointer</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">getPointer</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.iterInputPointers"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.iterInputPointers">[docs]</a>    <span class="k">def</span> <span class="nf">iterInputPointers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function is similar to iterInputAttributes, but it yields</span>
<span class="sd">        all input Pointers, independently if they have value or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> have been overwritten to type </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PointerList</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">:</span>
                    <span class="c1"># the same key is returned for all items inside the</span>
                    <span class="c1"># PointerList, this is used in viewprotocols.py</span>
                    <span class="c1"># to group them inside the same tree element</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span></div>

<div class="viewcode-block" id="Protocol.inputProtocolDict"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.inputProtocolDict">[docs]</a>    <span class="k">def</span> <span class="nf">inputProtocolDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function returns a dictionary of protocols that need to update</span>
<span class="sd">        their database to launch this protocol (this method is only used</span>
<span class="sd">        when a WORKFLOW is restarted or continued).</span>
<span class="sd">        Actions done here are:</span>
<span class="sd">        1. Iterate over the main input Pointer of this protocol</span>
<span class="sd">           (here, 3 different cases are analyzed)</span>

<span class="sd">           A) When the pointer points to a protocol</span>

<span class="sd">           B) When the pointer points to another object (INDIRECTLY).</span>
<span class="sd">              - The pointer has an _extended value (new parameters configuration</span>
<span class="sd">                in the protocol)</span>

<span class="sd">           C) When the pointer points to another object (DIRECTLY).</span>
<span class="sd">              - The pointer has not an _extended value (old parameters</span>
<span class="sd">                configuration in the protocol)</span>

<span class="sd">        2. The PROTOCOL to which the pointer points is determined and saved in</span>
<span class="sd">           the dictionary</span>

<span class="sd">        3. If this pointer points to another object (case B and C):</span>
<span class="sd">           - Iterate over the main attributes of this pointer</span>
<span class="sd">           - if any attribute is a pointer, then we move to PROTOCOL and repeat</span>
<span class="sd">             this procedure from step 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protocolDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attrInput</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterInputAttributes</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">attrInput</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">):</span>  <span class="c1"># case A</span>
                <span class="n">protocol</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrInput</span><span class="o">.</span><span class="n">hasExtended</span><span class="p">():</span>  <span class="c1"># case B</span>
                    <span class="n">protocol</span> <span class="o">=</span> <span class="n">attrInput</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># case C</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">getRunsGraph</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getNode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getObjParentId</span><span class="p">()))</span><span class="o">.</span><span class="n">run</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This is a problem, since protocols coming from</span>
                        <span class="c1"># Pointers do not have the __project set.</span>
                        <span class="c1"># We do not have an clear way to get the protocol if</span>
                        <span class="c1"># we do not have the project object associated</span>
                        <span class="c1"># This case implies Direct Pointers to Sets</span>
                        <span class="c1"># (without extended): hopefully this will only be</span>
                        <span class="c1"># created from tests</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t get protocol info from input attribute.&quot;</span>
                              <span class="s2">&quot; This could render unexpected results when &quot;</span>
                              <span class="s2">&quot;scheduling protocols.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Pointer</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">auxDict</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">inputProtocolDict</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">auxKey</span> <span class="ow">in</span> <span class="n">auxDict</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">auxKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protocolDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                        <span class="n">protocolDict</span><span class="p">[</span><span class="n">auxKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxDict</span><span class="p">[</span><span class="n">auxKey</span><span class="p">]</span>
                                <span class="k">break</span>

            <span class="n">protocolDict</span><span class="p">[</span><span class="n">protocol</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">protocol</span>

        <span class="k">return</span> <span class="n">protocolDict</span></div>

<div class="viewcode-block" id="Protocol.hasLinkedInputs"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.hasLinkedInputs">[docs]</a>    <span class="k">def</span> <span class="nf">hasLinkedInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return if True if some of the input pointers are referring to</span>
<span class="sd">        an output that is not ready yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">linkedPointers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">emptyPointers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterInputPointers</span><span class="p">():</span>

            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
            <span class="c1"># Issue #1597: New data loaded with old code.</span>
            <span class="c1"># If the input pointer is not a param:</span>
            <span class="c1"># This could happen in backward incompatibility cases,</span>
            <span class="c1"># Protocol has an attribute (inputPointer) but class does not define</span>
            <span class="c1"># if in the define params.</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> attribute is not defined as parameter. &quot;</span>
                      <span class="s2">&quot;This could happen when loading new code with older &quot;</span>
                      <span class="s2">&quot;scipion versions.&quot;</span> <span class="o">%</span> <span class="n">paramName</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalParamCondition</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>

            <span class="n">obj</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">condition</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">allowsNull</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
                    <span class="n">linkedPointers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">emptyPointers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linkedPointers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">emptyPointers</span></div>

<div class="viewcode-block" id="Protocol.iterOutputAttributes"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.iterOutputAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">iterOutputAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over the outputs produced by this protocol. &quot;&quot;&quot;</span>

        <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterOutputsNew</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useOutputList</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterOutputsOld</span>

        <span class="c1"># Iterate</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">outputClass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">outputClass</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span></div>

    <span class="k">def</span> <span class="nf">_iterOutputsNew</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This methods iterates through a list where outputs have been</span>
<span class="sd">        annotated&quot;&quot;&quot;</span>

        <span class="c1"># Loop through the output list</span>
        <span class="k">for</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>

            <span class="c1"># FIX: When deleting manually an output, specially for interactive protocols.</span>
            <span class="c1"># The _outputs is properly deleted in projects.sqlite, not it&#39;s run.db remains.</span>
            <span class="c1"># When the protocol is updated from run.db it brings the outputs that were deleted</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrName</span><span class="p">):</span>
                <span class="c1"># Get it from the protocol</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrName</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">attrName</span><span class="p">,</span> <span class="n">attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attrName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iterOutputsOld</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method iterates assuming the old model: any EMObject attribute</span>
<span class="sd">        is an output.&quot;&quot;&quot;</span>
        <span class="c1"># Iterate old Style:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassDomain</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Protocol in workingdir &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWorkingDir</span><span class="p">(),</span> <span class="s2">&quot; is of an unknown class&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maybe the class name has changed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">_objectClass</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span>
                <span class="k">return</span>

<div class="viewcode-block" id="Protocol.isInStreaming"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isInStreaming">[docs]</a>    <span class="k">def</span> <span class="nf">isInStreaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For the moment let&#39;s assume a protocol is in streaming</span>
        <span class="c1"># if at least one of the output sets is in STREAM_OPEN state</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">isStreamOpen</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Protocol.worksInStreaming"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.worksInStreaming">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">worksInStreaming</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># A protocol should work in streaming if it implements the stepCheck()</span>
        <span class="c1"># Get the stepCheck method from the Protocol</span>
        <span class="n">baseStepCheck</span> <span class="o">=</span> <span class="n">Protocol</span><span class="o">.</span><span class="n">_stepsCheck</span>
        <span class="n">ownStepCheck</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_stepsCheck</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">isSameFunction</span><span class="p">(</span><span class="n">baseStepCheck</span><span class="p">,</span> <span class="n">ownStepCheck</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.allowsGpu"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.allowsGpu">[docs]</a>    <span class="k">def</span> <span class="nf">allowsGpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if this protocol allows GPU computation. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">GPU_LIST</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.requiresGpu"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.requiresGpu">[docs]</a>    <span class="k">def</span> <span class="nf">requiresGpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if this protocol can only be executed in GPU. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowsGpu</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">USE_GPU</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.usesGpu"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.usesGpu">[docs]</a>    <span class="k">def</span> <span class="nf">usesGpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowsGpu</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributeValue</span><span class="p">(</span><span class="n">USE_GPU</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getGpuList"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getGpuList">[docs]</a>    <span class="k">def</span> <span class="nf">getGpuList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowsGpu</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">getListFromRangeString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpuList</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>

<div class="viewcode-block" id="Protocol.getOutputsSize"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getOutputsSize">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputsSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">())</span></div>

<div class="viewcode-block" id="Protocol.getOutputFiles"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getOutputFiles">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the output files produced by this protocol.</span>
<span class="sd">        This can be used in web to download or in remote</span>
<span class="sd">        executions to copy results back.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># By default return the output file of each output attribute</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">():</span>
            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">getFiles</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="Protocol.copyDefinitionAttributes"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.copyDefinitionAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">copyDefinitionAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copy definition attributes to other protocol. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterDefinitionAttributes</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyAttributes</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_createVarsFromDefinition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function will setup the protocol instance variables</span>
<span class="sd">        from the Protocol Class definition, taking into account</span>
<span class="sd">        the variable type and default values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_definition&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span><span class="o">.</span><span class="n">iterParams</span><span class="p">():</span>
                <span class="c1"># Create the var with value coming from kwargs or from</span>
                <span class="c1"># the default param definition</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">paramClass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span>
                                                        <span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FIXME: Protocol &#39;</span><span class="si">%s</span><span class="s2">&#39; has not DEFINITION&quot;</span>
                  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_getFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function will retrieve filenames given a key and some</span>
<span class="sd">        keywords arguments. The __filenamesDict attribute should be</span>
<span class="sd">        updated with templates that accept the given keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filenamesDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">%</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_updateFilenamesDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the dictionary with templates that will be used</span>
<span class="sd">        by the _getFileName function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filenamesDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnDict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Stores objects of the protocol using the mapper.</span>
<span class="sd">        If not objects are passed, the whole protocol is stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insertChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert a new child not stored previously.</span>
<span class="sd">        If stored previously, _store should be used.</span>
<span class="sd">        The child will be set as self.key attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasObjId</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">insertChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error with child &#39;</span><span class="si">%s</span><span class="s2">&#39;, value=</span><span class="si">%s</span><span class="s2">, type=</span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">child</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="n">ex</span>

    <span class="k">def</span> <span class="nf">_deleteChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete a child from the mapper. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define all the steps that will be executed. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define the input parameters that will be used.</span>
<span class="sd">        Params:</span>
<span class="sd">            form: this is the form to be populated with sections and params.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__insertStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert a new step in the list.</span>
<span class="sd">        Params:</span>
<span class="sd">         **kwargs:</span>
<span class="sd">            prerequisites: a list with the steps index that need to be done</span>
<span class="sd">                           previous than the current one.&quot;&quot;&quot;</span>
        <span class="n">prerequisites</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prerequisites&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prerequisites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">):</span>
                <span class="c1"># By default add the previous step as prerequisite</span>
                <span class="n">step</span><span class="o">.</span><span class="n">addPrerequisites</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">addPrerequisites</span><span class="p">(</span><span class="o">*</span><span class="n">prerequisites</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="c1"># Setup and return step index</span>
        <span class="n">step</span><span class="o">.</span><span class="n">setIndex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">getIndex</span><span class="p">()</span>

<div class="viewcode-block" id="Protocol.setRunning"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setRunning">[docs]</a>    <span class="k">def</span> <span class="nf">setRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do not reset the init time in RESUME_MODE&quot;&quot;&quot;</span>
        <span class="n">previousStart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setRunning</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">MODE_RESUME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">previousStart</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.setAborted"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setAborted">[docs]</a>    <span class="k">def</span> <span class="nf">setAborted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Abort the protocol and finalize the steps&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setAborted</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateSteps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">step</span><span class="p">:</span> <span class="n">step</span><span class="o">.</span><span class="n">setAborted</span><span class="p">(),</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;status=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">STATUS_RUNNING</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_updateSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">updater</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the status of all steps</span>
<span class="sd">        :parameter updater callback/lambda receiving a step and editing it inside</span>
<span class="sd">        :parameter where condition to filter the set with.&quot;&quot;&quot;</span>
        <span class="n">stepsSet</span> <span class="o">=</span> <span class="n">StepSet</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">stepsSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">):</span>
            <span class="n">updater</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">stepsSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">stepsSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="n">stepsSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the connection</span>

    <span class="k">def</span> <span class="nf">_getPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a path inside the workingDir. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getExtraPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a path inside the extra folder. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s2">&quot;extra&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getTmpPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a path inside the tmp folder. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getLogsPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getRelPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a relative path from the workingDir. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_getRelPathExecutionDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a relative path from the projdir. &quot;&quot;&quot;</span>
        <span class="c1"># TODO  must be a bettis</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getBasePath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Take the basename of the path and get the path</span>
<span class="sd">        relative to working dir of the protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_insertFunctionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">funcArgs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Params:</span>
<span class="sd">           func: the function itself or, optionally, the name (string) of the function to be run in the Step.</span>
<span class="sd">           *funcArgs: the variable list of arguments to pass to the function.</span>
<span class="sd">           **kwargs: see __insertStep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Get the function give its name</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Ensure the protocol instance have it and is callable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Protocol._insertFunctionStep: &#39;</span><span class="si">%s</span><span class="s2">&#39; function is &quot;</span>
                            <span class="s2">&quot;not member of the protocol&quot;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Protocol._insertFunctionStep: &#39;</span><span class="si">%s</span><span class="s2">&#39; is not callable&quot;</span>
                            <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">FunctionStep</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">*</span><span class="n">funcArgs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__insertStep</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insertRunJobStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progName</span><span class="p">,</span> <span class="n">progArguments</span><span class="p">,</span> <span class="n">resultFiles</span><span class="o">=</span><span class="p">[],</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert an Step that will simple call runJob function</span>
<span class="sd">        **args: see __insertStep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;runJob&#39;</span><span class="p">,</span> <span class="n">progName</span><span class="p">,</span> <span class="n">progArguments</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insertCopyFileStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceFile</span><span class="p">,</span> <span class="n">targetFile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shortcut function to insert an step for copying a file to a destiny. &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">FunctionStep</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">copyFile</span><span class="p">,</span> <span class="s1">&#39;copyFile&#39;</span><span class="p">,</span> <span class="n">sourceFile</span><span class="p">,</span>
                            <span class="n">targetFile</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__insertStep</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_enterDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Enter into a new directory path and store the current path.</span>
<span class="sd">        The current path will be used in _leaveDir, but nested _enterDir</span>
<span class="sd">        are not allowed since self._currentDir is overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currentDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entered into dir: cd &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_leaveDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method should be called after a call to _enterDir</span>
<span class="sd">        to return to the previous location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_currentDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returned to dir: cd &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currentDir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_enterWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change to the protocol working dir. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enterDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_leaveWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function make sense to use in conjunction</span>
<span class="sd">        with _enterWorkingDir to go back to execution path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaveDir</span><span class="p">()</span>

<div class="viewcode-block" id="Protocol.continueFromInteractive"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.continueFromInteractive">[docs]</a>    <span class="k">def</span> <span class="nf">continueFromInteractive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; TODO: REMOVE this function.</span>
<span class="sd">        Check if there is an interactive step and set</span>
<span class="sd">        as finished, this is used now mainly in picking,</span>
<span class="sd">        but we should remove this since is weird for users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">()):</span>
            <span class="n">stepsSet</span> <span class="o">=</span> <span class="n">StepSet</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">stepsSet</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">STATUS_INTERACTIVE</span><span class="p">:</span>
                    <span class="n">step</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">STATUS_FINISHED</span><span class="p">)</span>
                    <span class="n">stepsSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">stepsSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">stepsSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the connection</span></div>

<div class="viewcode-block" id="Protocol.loadSteps"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.loadSteps">[docs]</a>    <span class="k">def</span> <span class="nf">loadSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load the Steps stored in the steps.sqlite file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prevSteps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">()):</span>
            <span class="n">stepsSet</span> <span class="o">=</span> <span class="n">StepSet</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">stepsSet</span><span class="p">:</span>
                <span class="n">prevSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
            <span class="n">stepsSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the connection</span>
        <span class="k">return</span> <span class="n">prevSteps</span></div>

    <span class="k">def</span> <span class="nf">_insertPreviousSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert steps of previous execution.</span>
<span class="sd">        It can be used to track previous steps done for</span>
<span class="sd">        protocol that allow some kind of continue (such as ctf estimation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadSteps</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__insertStep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__findStartingStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; From a previous run, compare self._steps and self._prevSteps</span>
<span class="sd">        to find which steps we need to start at, skipping successful done</span>
<span class="sd">        and not changed steps. Steps that needs to be done, will be deleted</span>
<span class="sd">        from the previous run storage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span> <span class="o">==</span> <span class="n">MODE_RESTART</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prevSteps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prevSteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadSteps</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prevSteps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;len(steps) </span><span class="si">%s</span><span class="s2"> len(prevSteps) </span><span class="si">%s</span><span class="s2"> &quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prevSteps</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">newStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">oldStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prevSteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">oldStep</span><span class="o">.</span><span class="n">isFinished</span><span class="p">()</span> <span class="ow">or</span> <span class="n">newStep</span> <span class="o">!=</span> <span class="n">oldStep</span>
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">oldStep</span><span class="o">.</span><span class="n">_postconditions</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">pw</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">debugOn</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting at step </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     Old step: </span><span class="si">%s</span><span class="s2">, args: </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">oldStep</span><span class="o">.</span><span class="n">funcName</span><span class="p">,</span> <span class="n">oldStep</span><span class="o">.</span><span class="n">argsStr</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     New step: </span><span class="si">%s</span><span class="s2">, args: </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">newStep</span><span class="o">.</span><span class="n">funcName</span><span class="p">,</span> <span class="n">newStep</span><span class="o">.</span><span class="n">argsStr</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     not oldStep.isFinished(): </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="ow">not</span> <span class="n">oldStep</span><span class="o">.</span><span class="n">isFinished</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     newStep != oldStep: </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">newStep</span> <span class="o">!=</span> <span class="n">oldStep</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     not oldStep._postconditions(): </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="ow">not</span> <span class="n">oldStep</span><span class="o">.</span><span class="n">_postconditions</span><span class="p">()))</span>
                <span class="k">return</span> <span class="n">i</span>
            <span class="n">newStep</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">oldStep</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_storeSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the new steps list that can be retrieved</span>
<span class="sd">        in further execution of this protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stepsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStepsFile</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span> <span class="o">=</span> <span class="n">StepSet</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">stepsFn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">setStore</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">cleanObjId</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setInteractive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isInteractive</span><span class="p">()</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">isInteractive</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__updateStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store a given step and write changes. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stepStarted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will be called whenever an step</span>
<span class="sd">        has started running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">magentaStr</span><span class="p">(</span><span class="s2">&quot;STARTED&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: </span><span class="si">%s</span><span class="s2">, step </span><span class="si">%d</span><span class="s2">, time </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">funcName</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">step</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">initTime</span><span class="o">.</span><span class="n">datetime</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__updateStep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stepFinished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will be called whenever an step</span>
<span class="sd">        has finished its run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doContinue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">isInteractive</span><span class="p">():</span>
            <span class="n">doContinue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">step</span><span class="o">.</span><span class="n">isFailed</span><span class="p">():</span>
            <span class="n">doContinue</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">errorMsg</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">redStr</span><span class="p">(</span>
                <span class="s2">&quot;Protocol failed: &quot;</span> <span class="o">+</span> <span class="n">step</span><span class="o">.</span><span class="n">getErrorMessage</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setFailed</span><span class="p">(</span><span class="n">errorMsg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errorMsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastStatus</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__updateStep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsDone</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="n">step</span><span class="o">.</span><span class="n">getElapsedTime</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsDone</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">magentaStr</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;: </span><span class="si">%s</span><span class="s2">, step </span><span class="si">%d</span><span class="s2">, time </span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">funcName</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">step</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">datetime</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">isFailed</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">==</span> <span class="n">STEPS_PARALLEL</span><span class="p">:</span>
            <span class="c1"># In parallel mode the executor will exit to close</span>
            <span class="c1"># all working threads, so we need to close</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endRun</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">doContinue</span>

    <span class="k">def</span> <span class="nf">_stepsCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_runSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run all steps defined in self._steps. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsDone</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">startIndex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numberOfSteps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRunning</span><span class="p">()</span>
        <span class="c1"># Keep the original value to set in sub-protocols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_originalRunMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="c1"># Always set to resume, even if set to restart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">MODE_RESUME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">startIndex</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastStatus</span> <span class="o">=</span> <span class="n">STATUS_FINISHED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All steps seem to be FINISHED, nothing to be done.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">runSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stepStarted</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stepFinished</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stepsCheck</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_stepsCheckSecs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Last status is </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastStatus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastStatus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deleteOutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function should only be used from RESTART.</span>
<span class="sd">        It will remove output attributes from mapper and object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrName</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span>

<div class="viewcode-block" id="Protocol.findAttributeName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.findAttributeName">[docs]</a>    <span class="k">def</span> <span class="nf">findAttributeName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr2Find</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attrName</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span> <span class="o">==</span> <span class="n">attr2Find</span><span class="o">.</span><span class="n">getObjId</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">attrName</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Protocol.deleteOutput"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.deleteOutput">[docs]</a>    <span class="k">def</span> <span class="nf">deleteOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">attrName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAttributeName</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attrName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__copyRelations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This will copy relations from protocol other to self &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Protocol.copy"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">copyId</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">excludeInputs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Input attributes list</span>
        <span class="n">inputAttributes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If need to exclude input attributes</span>
        <span class="k">if</span> <span class="n">excludeInputs</span><span class="p">:</span>
            <span class="c1"># Get all the input attributes, to be ignored at copy():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterInputAttributes</span><span class="p">():</span>
                <span class="n">inputAttributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">copyDict</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">copyId</span><span class="p">,</span> <span class="n">inputAttributes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">deleteRelations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">getRelations</span><span class="p">():</span>
            <span class="n">rName</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">rCreator</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">]</span>
            <span class="n">rParent</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">OBJECT_PARENT_ID</span><span class="p">]</span>
            <span class="n">rChild</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;object_child_id&#39;</span><span class="p">]</span>
            <span class="n">rParentExt</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;object_parent_extended&#39;</span><span class="p">]</span>
            <span class="n">rChildExt</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;object_child_extended&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">rParent</span> <span class="ow">in</span> <span class="n">copyDict</span><span class="p">:</span>
                <span class="n">rParent</span> <span class="o">=</span> <span class="n">copyDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rParent</span><span class="p">)</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">rChild</span> <span class="ow">in</span> <span class="n">copyDict</span><span class="p">:</span>
                <span class="n">rChild</span> <span class="o">=</span> <span class="n">copyDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rChild</span><span class="p">)</span><span class="o">.</span><span class="n">getObjId</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">insertRelationData</span><span class="p">(</span><span class="n">rName</span><span class="p">,</span> <span class="n">rCreator</span><span class="p">,</span> <span class="n">rParent</span><span class="p">,</span> <span class="n">rChild</span><span class="p">,</span>
                                           <span class="n">rParentExt</span><span class="p">,</span> <span class="n">rChildExt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getRelations"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getRelations">[docs]</a>    <span class="k">def</span> <span class="nf">getRelations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the relations created by this protocol. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">getRelationsByCreator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_defineRelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relName</span><span class="p">,</span> <span class="n">parentObj</span><span class="p">,</span> <span class="n">childObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert a new relation in the mapper using self as creator. &quot;&quot;&quot;</span>
        <span class="n">parentExt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">childExt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">parentObj</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
            <span class="n">parentExt</span> <span class="o">=</span> <span class="n">parentObj</span><span class="o">.</span><span class="n">getExtended</span><span class="p">()</span>
            <span class="n">parentObj</span> <span class="o">=</span> <span class="n">parentObj</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">childObj</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
            <span class="n">childExt</span> <span class="o">=</span> <span class="n">childObj</span><span class="o">.</span><span class="n">getExtended</span><span class="p">()</span>
            <span class="n">childObj</span> <span class="o">=</span> <span class="n">childObj</span><span class="o">.</span><span class="n">getObjValue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">insertRelation</span><span class="p">(</span><span class="n">relName</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parentObj</span><span class="p">,</span> <span class="n">childObj</span><span class="p">,</span>
                                   <span class="n">parentExt</span><span class="p">,</span> <span class="n">childExt</span><span class="p">)</span>

<div class="viewcode-block" id="Protocol.makePathsAndClean"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.makePathsAndClean">[docs]</a>    <span class="k">def</span> <span class="nf">makePathsAndClean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the necessary path or clean</span>
<span class="sd">        if in RESTART mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean working path if in RESTART mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span> <span class="o">==</span> <span class="n">MODE_RESTART</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanWorkingDir</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__deleteOutputs</span><span class="p">()</span>
            <span class="c1"># Delete the relations created by this protocol</span>
            <span class="c1"># (delete this in both project and protocol db)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">deleteRelations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makeWorkingDir</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.cleanWorkingDir"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.cleanWorkingDir">[docs]</a>    <span class="k">def</span> <span class="nf">cleanWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all files and subdirectories related with the protocol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanTmp</span><span class="p">()</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">())</span></div>

<div class="viewcode-block" id="Protocol.makeWorkingDir"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.makeWorkingDir">[docs]</a>    <span class="k">def</span> <span class="nf">makeWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create workingDir, logs and extra paths</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">()]</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makePath</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>
        <span class="c1"># Create scratch if SCIPION_SCRATCH environment variable exist.</span>
        <span class="c1"># In other case, tmp folder is created</span>
        <span class="n">pwutils</span><span class="o">.</span><span class="n">makeTmpPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.cleanTmp"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.cleanTmp">[docs]</a>    <span class="k">def</span> <span class="nf">cleanTmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete all files and subdirectories under Tmp folder. &quot;&quot;&quot;</span>
        <span class="n">tmpFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getTmpPath</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">):</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pwutils</span><span class="o">.</span><span class="n">cleanPath</span><span class="p">(</span><span class="n">tmpFolder</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check that a proper Steps executor have been set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Protocol.run: Steps executor should be set before &#39;</span>
                            <span class="s1">&#39;running protocol&#39;</span><span class="p">)</span>
        <span class="c1"># Check the parameters are correct</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationException</span><span class="p">(</span>
                <span class="s1">&#39;Protocol has validation errors:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insertAllSteps</span><span class="p">()</span>  <span class="c1"># Define steps for execute later</span>
        <span class="c1"># Find at which step we need to start</span>
        <span class="n">startIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findStartingStep</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Starting at step: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeSteps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Running steps &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runSteps</span><span class="p">(</span><span class="n">startIndex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getEnviron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function should return an environ variable</span>
<span class="sd">        that will be used when running new programs.</span>
<span class="sd">        By default, the protocol will use the one defined</span>
<span class="sd">        in the package that it belongs or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getEnviron</span><span class="p">()</span>

<div class="viewcode-block" id="Protocol.runJob"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.runJob">[docs]</a>    <span class="k">def</span> <span class="nf">runJob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">==</span> <span class="n">STEPS_SERIAL</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;numberOfMpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfMpi&#39;</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;numberOfThreads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfThreads&#39;</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;numberOfMpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfMpi&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;numberOfThreads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numberOfThreads&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;env&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;env&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getEnviron</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.run"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Before calling this method, the working dir for the protocol</span>
<span class="sd">        to run should exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initLogs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">greenStr</span><span class="p">(</span><span class="s1">&#39;RUNNING PROTOCOL -----------------&#39;</span><span class="p">))</span>

        <span class="c1"># Store the full machine name where the protocol is running</span>
        <span class="c1"># and also its PID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setHostFullName</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">getHostFullName</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hostname: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHostFullName</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pyworkflow: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plugin: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassPackageName</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">(),</span> <span class="s2">&quot;__version__&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plugin v: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;currentDir: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;workingDir: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;runMode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">MODE_CHOICES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">get</span><span class="p">()])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;          MPI: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;      threads: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  * Cannot get information about MPI/threads (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">Step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFailed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endRun</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_endRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print some ending message and close some files. &quot;&quot;&quot;</span>
        <span class="c1"># self._store()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaryVar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methodsVar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">envVarOn</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">SCIPION_DEBUG_NOCLEAN</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Not cleaning temp folder since &#39;</span>
                         <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is set to True.&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="o">.</span><span class="n">SCIPION_DEBUG_NOCLEAN</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFailed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning temp folder....&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanTmp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pwutils</span><span class="o">.</span><span class="n">greenStr</span><span class="p">(</span><span class="s1">&#39;------------------- PROTOCOL &#39;</span> <span class="o">+</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">getStatusMessage</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closeLogs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__initLogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Open the log file overwriting its content if the protocol is going</span>
<span class="sd">        to be execute from zero.</span>
<span class="sd">        Otherwise append the new content to the old one.</span>
<span class="sd">        Also open logs files and redirect the systems streams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">ScipionLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogPaths</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">MODE_RESTART</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="c1"># Backup the the system streams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stdErr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stdOut</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__openLogsFiles</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="c1"># Redirect the system streams to the protocol files</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fOut</span>
        <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">envVarOn</span><span class="p">(</span><span class="s1">&#39;SCIPION_SEPARATE_STDERR&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fErr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fOut</span>  <span class="c1"># send stderr to wherever stdout appears</span>
            <span class="c1"># TODO: maybe do not show separate &quot;run.stdout&quot; and &quot;run.stderr&quot;</span>
            <span class="c1"># in the &quot;Output Log&quot; section if we put them together.</span>

<div class="viewcode-block" id="Protocol.getLogPaths"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getLogPaths">[docs]</a>    <span class="k">def</span> <span class="nf">getLogPaths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">,</span>
                        <span class="p">[</span><span class="s1">&#39;run.stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;run.stderr&#39;</span><span class="p">,</span> <span class="s1">&#39;run.log&#39;</span><span class="p">,</span> <span class="n">SCHEDULE_LOG</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Protocol.getScheduleLog"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getScheduleLog">[docs]</a>    <span class="k">def</span> <span class="nf">getScheduleLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">(</span><span class="n">SCHEDULE_LOG</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getSteps"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getSteps">[docs]</a>    <span class="k">def</span> <span class="nf">getSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the steps.sqlite file under logs directory. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span></div>

<div class="viewcode-block" id="Protocol.getStepsFile"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getStepsFile">[docs]</a>    <span class="k">def</span> <span class="nf">getStepsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the steps.sqlite file under logs directory. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">(</span><span class="s1">&#39;steps.sqlite&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__openLogsFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fOut</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogPaths</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fErr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogPaths</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__closeLogsFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fOut</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fErr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__closeLogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Restore system streams</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stdErr</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stdOut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__closeLogsFiles</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_addChunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add text txt to self._buffer, with format fmt.</span>
<span class="sd">        fmt can be a color (like &#39;red&#39;) or a link that looks like &#39;link:url&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make the text html-safe first.</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;amp&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">)]:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;&amp;</span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">+=</span> <span class="n">txt</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;link:&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;link:&#39;</span><span class="p">):]</span>
            <span class="c1"># Add the url in the TWiki style</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">+=</span> <span class="s1">&#39;[[</span><span class="si">%s</span><span class="s1">][</span><span class="si">%s</span><span class="s1">]]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
            <span class="c1"># Web does not exist, webtools must find a solution for this case.</span>
            <span class="c1"># else:</span>
            <span class="c1">#     from pyworkflow.web.pages import settings as django_settings</span>
            <span class="c1">#     absolute_url = django_settings.ABSOLUTE_URL</span>
            <span class="c1">#     self._buffer += &#39;[[%s/get_log/?path=%s][%s]]&#39; % (absolute_url,</span>
            <span class="c1">#                                                     url, txt)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">+=</span> <span class="s1">&#39;&lt;font color=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/font&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

<div class="viewcode-block" id="Protocol.getLogsAsStrings"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getLogsAsStrings">[docs]</a>    <span class="k">def</span> <span class="nf">getLogsAsStrings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLogPaths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">pwutils</span><span class="o">.</span><span class="n">renderTextFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addChunk</span><span class="p">)</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;File &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span></div>

<div class="viewcode-block" id="Protocol.getLogsLastLines"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getLogsLastLines">[docs]</a>    <span class="k">def</span> <span class="nf">getLogsLastLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lastLines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the log last(lastLines) lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lastLines</span><span class="p">:</span>
            <span class="n">lastLines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROT_LOGS_LAST_LINES&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

        <span class="c1"># Get stdout</span>
        <span class="n">stdoutFn</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getLogPaths</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stdoutFn</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">with</span>  <span class="nb">open</span><span class="p">(</span><span class="n">stdoutFn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>

            <span class="n">iterlen</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">it</span><span class="p">)</span>
            <span class="n">numLines</span> <span class="o">=</span> <span class="n">iterlen</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

            <span class="n">lastLines</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lastLines</span><span class="p">,</span> <span class="n">numLines</span><span class="p">)</span>
            <span class="n">sk</span> <span class="o">=</span> <span class="n">numLines</span> <span class="o">-</span> <span class="n">lastLines</span>
            <span class="n">sk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">stdout</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">sk</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="Protocol.warning"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.warning">[docs]</a>    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.info"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.error"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">redirectStandard</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.debug"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pw</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">debugOn</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getWorkingDir"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getWorkingDir">[docs]</a>    <span class="k">def</span> <span class="nf">getWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setWorkingDir"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setWorkingDir">[docs]</a>    <span class="k">def</span> <span class="nf">setWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.setMapper"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setMapper">[docs]</a>    <span class="k">def</span> <span class="nf">setMapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set a new mapper for the protocol to persist state. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span></div>

<div class="viewcode-block" id="Protocol.getMapper"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getMapper">[docs]</a>    <span class="k">def</span> <span class="nf">getMapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span></div>

<div class="viewcode-block" id="Protocol.getDbPath"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getDbPath">[docs]</a>    <span class="k">def</span> <span class="nf">getDbPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">(</span><span class="s1">&#39;run.db&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.setStepsExecutor"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setStepsExecutor">[docs]</a>    <span class="k">def</span> <span class="nf">setStepsExecutor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">executor</span> <span class="o">=</span> <span class="n">StepExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getHostConfig</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span> <span class="o">=</span> <span class="n">executor</span></div>

<div class="viewcode-block" id="Protocol.getFiles"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getFiles">[docs]</a>    <span class="k">def</span> <span class="nf">getFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resultFiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefinition</span><span class="p">()</span><span class="o">.</span><span class="n">iterPointerParams</span><span class="p">():</span>
            <span class="c1"># Get all self attribute that are pointers</span>
            <span class="n">attrPointer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">attrPointer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># Get object pointer by the attribute</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;getFiles&#39;</span><span class="p">):</span>
                <span class="n">resultFiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getFiles</span><span class="p">())</span>  <span class="c1"># Add files if any</span>
        <span class="k">return</span> <span class="n">resultFiles</span> <span class="o">|</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">getFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></div>

<div class="viewcode-block" id="Protocol.getHostName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getHostName">[docs]</a>    <span class="k">def</span> <span class="nf">getHostName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the execution host name.</span>
<span class="sd">         This value is only the key of the host in the configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostName</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setHostName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setHostName">[docs]</a>    <span class="k">def</span> <span class="nf">setHostName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the execution host name (the host key in the config file) &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostName</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">hostName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getHostFullName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getHostFullName">[docs]</a>    <span class="k">def</span> <span class="nf">getHostFullName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the full machine name where the protocol is running. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostFullName</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setHostFullName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setHostFullName">[docs]</a>    <span class="k">def</span> <span class="nf">setHostFullName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostFullName</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostFullName</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">hostFullName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getHostConfig"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getHostConfig">[docs]</a>    <span class="k">def</span> <span class="nf">getHostConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the configuration host. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostConfig</span></div>

<div class="viewcode-block" id="Protocol.setHostConfig"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setHostConfig">[docs]</a>    <span class="k">def</span> <span class="nf">setHostConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostConfig</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># Never store the host config as part of the protocol, it is kept</span>
        <span class="c1"># in the configuration information, the hostname is enough</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostConfig</span><span class="o">.</span><span class="n">setStore</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getJobId"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getJobId">[docs]</a>    <span class="k">def</span> <span class="nf">getJobId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the jobId associated to a running protocol. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobId</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setJobId"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setJobId">[docs]</a>    <span class="k">def</span> <span class="nf">setJobId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobId</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getPid"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getPid">[docs]</a>    <span class="k">def</span> <span class="nf">getPid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setPid"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setPid">[docs]</a>    <span class="k">def</span> <span class="nf">setPid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getRunName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getRunName">[docs]</a>    <span class="k">def</span> <span class="nf">getRunName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">runName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">runName</span><span class="p">):</span>
            <span class="n">runName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultRunName</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">runName</span></div>

<div class="viewcode-block" id="Protocol.getDefaultRunName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getDefaultRunName">[docs]</a>    <span class="k">def</span> <span class="nf">getDefaultRunName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">strId</span><span class="p">())</span></div>

<div class="viewcode-block" id="Protocol.getClassPackage"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getClassPackage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassPackage</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the package module to which this protocol belongs.</span>
<span class="sd">        This function will only work, if for the given Domain, the</span>
<span class="sd">        method Domain.getProtocols() has been called once. After calling</span>
<span class="sd">        this method the protocol classes are registered with it Plugin</span>
<span class="sd">        and Domain info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># import pyworkflow.em as em</span>
        <span class="c1"># em.Domain.getProtocols()  # make sure the _package is set for each Protocol class</span>
        <span class="c1"># TODO: Check if we need to return scipion by default anymore</span>
        <span class="c1"># Now the basic EM protocols are defined by scipion-em (pwem)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_package&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getClassPlugin"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getClassPlugin">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassPlugin</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;Plugin&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getClassPackageName"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getClassPackageName">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassPackageName</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;orphan&quot;</span></div>

<div class="viewcode-block" id="Protocol.getClassDomain"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getClassDomain">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassDomain</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the Domain class where this Protocol class is defined. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pw</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.getPluginLogoPath"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getPluginLogoPath">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getPluginLogoPath</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span>
        <span class="n">logo</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;_logo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logo</span><span class="p">:</span>
            <span class="n">logoPath</span> <span class="o">=</span> <span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">findResource</span><span class="p">(</span><span class="n">logo</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">logo</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logoPath</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">logoPath</span></div>

<div class="viewcode-block" id="Protocol.validatePackageVersion"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.validatePackageVersion">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validatePackageVersion</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">varName</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to validate the the package version specified in</span>
<span class="sd">        configuration file ~/.config/scipion/scipion.conf is among the available</span>
<span class="sd">        options and it is properly installed.</span>
<span class="sd">        Params:</span>
<span class="sd">            package: the package object (ej: eman2 or relion). Package should contain the</span>
<span class="sd">                     following methods: getVersion(), getSupportedVersions()</span>
<span class="sd">            varName: the expected environment var containing the path (and version)</span>
<span class="sd">            errors: list to added error if found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span>
        <span class="n">packageName</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackageName</span><span class="p">()</span>
        <span class="n">varValue</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getSupportedVersions</span><span class="p">())</span>

        <span class="n">errorMsg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">package</span><span class="o">.</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getActiveVersion</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;We could not detect *</span><span class="si">%s</span><span class="s2">* version. &quot;</span> <span class="o">%</span> <span class="n">packageName</span><span class="p">)</span>
            <span class="n">errorMsg</span> <span class="o">=</span> <span class="s2">&quot;The path value should contains a valid version (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">versions</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">varValue</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Path of </span><span class="si">%s</span><span class="s2"> does not exists.&quot;</span> <span class="o">%</span> <span class="n">varName</span><span class="p">)</span>
            <span class="n">errorMsg</span> <span class="o">=</span> <span class="s2">&quot;Check installed packages and versions with command:</span><span class="se">\n</span><span class="s2"> &quot;</span>
            <span class="n">errorMsg</span> <span class="o">+=</span> <span class="s2">&quot;*scipion install --help*&quot;</span>

        <span class="k">if</span> <span class="n">errorMsg</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varName</span><span class="p">,</span> <span class="n">varValue</span><span class="p">))</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Please, modify </span><span class="si">%s</span><span class="s2"> value in the configuration file:&quot;</span> <span class="o">%</span> <span class="n">varName</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*~/.config/scipion/scipion.conf*&quot;</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errorMsg</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;After fixed, you NEED TO RESTART THE PROJECT WINDOW&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getClassLabel"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getClassLabel">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassLabel</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prependPackageName</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a more readable string representing the protocol class &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_label&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prependPackageName</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackageName</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span></div>

<div class="viewcode-block" id="Protocol.isDisabled"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isDisabled">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isDisabled</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if this Protocol is disabled.</span>
<span class="sd">        Disabled protocols will not be offered in the available protocols.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Protocol.isBase"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isBase">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isBase</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if this Protocol is a base class.</span>
<span class="sd">        Base classes should be marked with _label = None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Protocol.getSubmitDict"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getSubmitDict">[docs]</a>    <span class="k">def</span> <span class="nf">getSubmitDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dictionary with the necessary keys to</span>
<span class="sd">        launch the job to a queue system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queueName</span><span class="p">,</span> <span class="n">queueParams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQueueParams</span><span class="p">()</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHostConfig</span><span class="p">()</span>

        <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">(</span><span class="n">hc</span><span class="o">.</span><span class="n">getSubmitPrefix</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.job&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;JOB_SCRIPT&#39;</span><span class="p">:</span> <span class="n">script</span><span class="p">,</span>
             <span class="s1">&#39;JOB_LOGS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getLogsPath</span><span class="p">(</span><span class="n">hc</span><span class="o">.</span><span class="n">getSubmitPrefix</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">strId</span><span class="p">()),</span>
             <span class="s1">&#39;JOB_NODEFILE&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.job&#39;</span><span class="p">,</span> <span class="s1">&#39;.nodefile&#39;</span><span class="p">)),</span>
             <span class="s1">&#39;JOB_NAME&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strId</span><span class="p">(),</span>
             <span class="s1">&#39;JOB_QUEUE&#39;</span><span class="p">:</span> <span class="n">queueName</span><span class="p">,</span>
             <span class="s1">&#39;JOB_NODES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
             <span class="s1">&#39;JOB_THREADS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
             <span class="s1">&#39;JOB_CORES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
             <span class="s1">&#39;JOB_HOURS&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span>
             <span class="s1">&#39;GPU_COUNT&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">()),</span>
             <span class="s1">&#39;QUEUE_FOR_JOBS&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span>
             <span class="p">}</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">queueParams</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Protocol.useQueue"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.useQueue">[docs]</a>    <span class="k">def</span> <span class="nf">useQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if the protocol should be launched through a queue. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_useQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.useQueueForSteps"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.useQueueForSteps">[docs]</a>    <span class="k">def</span> <span class="nf">useQueueForSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function will return True if the protocol has been set</span>
<span class="sd">        to be launched through a queue by steps &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">useQueue</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSubmitDict</span><span class="p">()[</span><span class="s2">&quot;QUEUE_FOR_JOBS&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getQueueParams"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getQueueParams">[docs]</a>    <span class="k">def</span> <span class="nf">getQueueParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Protocol.hasQueueParams"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.hasQueueParams">[docs]</a>    <span class="k">def</span> <span class="nf">hasQueueParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="o">.</span><span class="n">hasValue</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.setQueueParams"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.setQueueParams">[docs]</a>    <span class="k">def</span> <span class="nf">setQueueParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queueParams</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queueParams</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">queueParams</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numberOfSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numberOfSteps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stepsDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of steps executed. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stepsDone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cpuTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the sum of all durations of the finished steps&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpuTime</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<div class="viewcode-block" id="Protocol.updateSteps"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.updateSteps">[docs]</a>    <span class="k">def</span> <span class="nf">updateSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; After the steps list is modified, this methods will update steps</span>
<span class="sd">        information. It will save the steps list and also the number of steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storeSteps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numberOfSteps</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numberOfSteps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getStatusMessage"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getStatusMessage">[docs]</a>    <span class="k">def</span> <span class="nf">getStatusMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the status string and if running the steps done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAborted</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFailed</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; (done </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stepsDone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfSteps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="Protocol.getRunMode"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getRunMode">[docs]</a>    <span class="k">def</span> <span class="nf">getRunMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the mode of execution, either:</span>
<span class="sd">        MODE_RESTART or MODE_RESUME. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.hasSummaryWarnings"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.hasSummaryWarnings">[docs]</a>    <span class="k">def</span> <span class="nf">hasSummaryWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Protocol.addSummaryWarning"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.addSummaryWarning">[docs]</a>    <span class="k">def</span> <span class="nf">addSummaryWarning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warningDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends the warningDescription param to the list of summaryWarnings.</span>
<span class="sd">        Will be printed in the protocol summary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warningDescription</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span></div>

<div class="viewcode-block" id="Protocol.checkSummaryWarnings"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.checkSummaryWarnings">[docs]</a>    <span class="k">def</span> <span class="nf">checkSummaryWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks for warnings that we want to tell the user about by adding a</span>
<span class="sd">        warning sign to the run box and a description to the run summary.</span>
<span class="sd">        List of warnings checked:</span>
<span class="sd">        1. If the folder for this protocol run exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSaved</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSummaryWarning</span><span class="p">(</span><span class="s2">&quot;*Missing run data*: The directory for this &quot;</span>
                                   <span class="s2">&quot;run is missing, so it won&#39;t be possible to &quot;</span>
                                   <span class="s2">&quot;use its outputs in other protocols.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.isContinued"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isContinued">[docs]</a>    <span class="k">def</span> <span class="nf">isContinued</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return if running in continue mode (MODE_RESUME). &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRunMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">MODE_RESUME</span></div>

    <span class="c1"># Methods that should be implemented in subclasses</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function can be overwritten by subclasses.</span>
<span class="sd">        Used from the public validate function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="Protocol.getUrl"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getUrl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getUrl</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getClassPlugin</span><span class="p">()</span><span class="o">.</span><span class="n">getUrl</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.isInstalled"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isInstalled">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isInstalled</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># We a consider a protocol installed if there are not errors</span>
        <span class="c1"># from the _validateInstallation function</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validateInstallation</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.validateInstallation"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.validateInstallation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validateInstallation</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the installation of this protocol is correct.</span>
<span class="sd">        By default, we will check if the protocols&#39; package provide a</span>
<span class="sd">        validateInstallation function and use it.</span>
<span class="sd">        Returning an empty list means that the installation is correct</span>
<span class="sd">        and there are not errors. If some errors are found, a list with</span>
<span class="sd">        the error messages will be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validateFunc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">()</span><span class="o">.</span><span class="n">Plugin</span><span class="p">,</span>
                                   <span class="s1">&#39;validateInstallation&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">validateFunc</span><span class="p">()</span> <span class="k">if</span> <span class="n">validateFunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> installation couldn&#39;t be validated. Possible cause &quot;</span>
                    <span class="s2">&quot;could be a configuration issue. Try to run scipion &quot;</span>
                    <span class="s2">&quot;config.&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span></div>

<div class="viewcode-block" id="Protocol.validate"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check that input parameters are correct.</span>
<span class="sd">        Return a list with errors, if the list is empty, all was ok.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Validate that all input pointer parameters have a value</span>
        <span class="k">for</span> <span class="n">paramName</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefinition</span><span class="p">()</span><span class="o">.</span><span class="n">iterParams</span><span class="p">():</span>
            <span class="c1"># Get all self attribute that are pointers</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramName</span><span class="p">)</span>
            <span class="n">paramErrors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalParamCondition</span><span class="p">(</span><span class="n">paramName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">condition</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">allowsNull</span><span class="p">:</span>
                    <span class="n">paramErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cannot be EMPTY.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PointerList</span><span class="p">):</span>
                <span class="c1"># In this case allowsNull refers to not allowing empty items</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">allowsNull</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">paramErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cannot be EMPTY.&#39;</span><span class="p">)</span>
                    <span class="c1"># Consider empty pointers</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pointer</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">pointer</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">):</span>
                            <span class="n">paramErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Can not have EMPTY items.&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
                    <span class="n">paramErrors</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">* </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">paramErrors</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check that all ids specified in the &#39;Wait for&#39; form entry</span>
            <span class="c1"># are valid protocol ids</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">protId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPrerequisites</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prot</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">getProtocol</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">protId</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">prot</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">prot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">* is not a valid protocol id.&#39;</span> <span class="o">%</span> <span class="n">protId</span><span class="p">)</span>

            <span class="c1"># Validate specific for the subclass</span>
            <span class="n">installErrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateInstallation</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">installErrors</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="n">installErrors</span>
            <span class="n">childErrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">childErrors</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="n">childErrors</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">urllib</span>
            <span class="n">exceptionStr</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">formatExceptionInfo</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Protocol validation failed. It usually happens because there are some &quot;</span>
                          <span class="s2">&quot;input missing. Please check if the error message gives you any &quot;</span>
                          <span class="s2">&quot;hint:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exceptionStr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errors</span></div>

    <span class="k">def</span> <span class="nf">_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Should be implemented in subclasses. See warning. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="Protocol.warnings"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.warnings">[docs]</a>    <span class="k">def</span> <span class="nf">warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return some message warnings that can be errors.</span>
<span class="sd">        User should approve to execute a protocol with warnings. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Should be implemented in subclasses. See summary. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;No summary information.&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="Protocol.summary"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a summary message to provide some information to users. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">baseSummary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;No summary information.&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">baseSummary</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)]</span>

        <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjComment</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">baseSummary</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*COMMENTS:* &#39;</span><span class="p">,</span> <span class="n">comments</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getError</span><span class="p">()</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">baseSummary</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*ERROR:*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getError</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span><span class="p">:</span>
            <span class="n">baseSummary</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*WARNINGS:*&#39;</span><span class="p">]</span>
            <span class="n">baseSummary</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaryWarnings</span>

        <span class="k">return</span> <span class="n">baseSummary</span></div>

<div class="viewcode-block" id="Protocol.getFileTag"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getFileTag">[docs]</a>    <span class="k">def</span> <span class="nf">getFileTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[[</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="n">fn</span></div>

<div class="viewcode-block" id="Protocol.getObjectTag"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getObjectTag">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objName</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objName</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objName</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">objName</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;*None*&#39;</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isPointer</span><span class="p">():</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># get the pointed object</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;*None*&#39;</span>

        <span class="k">return</span> <span class="s2">&quot;[[sci-open:</span><span class="si">%s</span><span class="s2">][</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getObjId</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">getNameId</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Should be implemented in subclasses. See citations. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_references&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">__getPluginBibTex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the _bibtex from the package &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">(),</span> <span class="s2">&quot;_bibtex&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">_getCite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citeStr</span><span class="p">):</span>
        <span class="n">bibtex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getPluginBibTex</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">citeStr</span> <span class="ow">in</span> <span class="n">bibtex</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCiteText</span><span class="p">(</span><span class="n">bibtex</span><span class="p">[</span><span class="n">citeStr</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Reference with key *</span><span class="si">%s</span><span class="s2">* not found.&quot;</span> <span class="o">%</span> <span class="n">citeStr</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">_getCiteText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cite</span><span class="p">,</span> <span class="n">useKeyLabel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">journal</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">,</span> <span class="n">cite</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;booktitle&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Get the first author surname</span>
            <span class="k">if</span> <span class="n">useKeyLabel</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">cite</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">cite</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; et al., </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">cite</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;[[</span><span class="si">%s</span><span class="s1">][</span><span class="si">%s</span><span class="s1">]] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doi</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error with citation: &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Error with citation *</span><span class="si">%s</span><span class="s2">*.&quot;</span> <span class="o">%</span> <span class="n">label</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">__getCitations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; From the list of citations keys, obtains the full</span>
<span class="sd">        info from the package _bibtex dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bibtex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getPluginBibTex</span><span class="p">()</span>
        <span class="n">newCitations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bibtex</span><span class="p">:</span>
                <span class="n">newCitations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getCiteText</span><span class="p">(</span><span class="n">bibtex</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newCitations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newCitations</span>

    <span class="k">def</span> <span class="nf">__getCitationsDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citationList</span><span class="p">,</span> <span class="n">bibTexOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dictionary with Cite keys and the citation links. &quot;&quot;&quot;</span>
        <span class="n">bibtex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getPluginBibTex</span><span class="p">()</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citationList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bibtex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bibTexOutput</span><span class="p">:</span>
                    <span class="n">od</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibtex</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">od</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCiteText</span><span class="p">(</span><span class="n">bibtex</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">od</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">return</span> <span class="n">od</span>

<div class="viewcode-block" id="Protocol.getCitations"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getCitations">[docs]</a>    <span class="k">def</span> <span class="nf">getCitations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibTexOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getCitationsDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_citations</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[],</span>
                                       <span class="n">bibTexOutput</span><span class="o">=</span><span class="n">bibTexOutput</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.getPackageCitations"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getPackageCitations">[docs]</a>    <span class="k">def</span> <span class="nf">getPackageCitations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibTexOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassPackage</span><span class="p">(),</span> <span class="s2">&quot;_references&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getCitationsDict</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">bibTexOutput</span><span class="o">=</span><span class="n">bibTexOutput</span><span class="p">)</span></div>

<div class="viewcode-block" id="Protocol.citations"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.citations">[docs]</a>    <span class="k">def</span> <span class="nf">citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a citation message to provide some information to users. &quot;&quot;&quot;</span>
        <span class="n">citations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCitations</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">citations</span><span class="p">:</span>
            <span class="n">citations</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;*References:* &#39;</span><span class="p">)</span>

        <span class="n">packageCitations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPackageCitations</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">packageCitations</span><span class="p">:</span>
            <span class="n">citations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*Package References:*&#39;</span><span class="p">)</span>
            <span class="n">citations</span> <span class="o">+=</span> <span class="n">packageCitations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">citations</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;No references provided&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">citations</span></div>

<div class="viewcode-block" id="Protocol.getHelpText"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getHelpText">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getHelpText</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get help text to show in the protocol help button&quot;&quot;&quot;</span>
        <span class="n">helpText</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getDoc</span><span class="p">()</span>
        <span class="c1"># NOt used since getClassPlugin is always None</span>
        <span class="c1"># plugin = self.getClassPlugin()</span>
        <span class="c1"># if plugin:</span>
        <span class="c1">#     pluginMetadata = plugin.metadata</span>
        <span class="c1">#     helpText += &quot;\n\nPlugin info:\n&quot;</span>
        <span class="c1">#     for key, value in pluginMetadata.iteritems():</span>
        <span class="c1">#         helpText += &quot;%s: \t%s\n&quot; % (key, value)</span>
        <span class="k">return</span> <span class="n">helpText</span></div>

    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Should be implemented in subclasses. See methods. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;No methods information.&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="Protocol.getParsedMethods"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getParsedMethods">[docs]</a>    <span class="k">def</span> <span class="nf">getParsedMethods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the _methods results and parse possible cites. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">baseMethods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">bibtex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getPluginBibTex</span><span class="p">()</span>
            <span class="n">parsedMethods</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">baseMethods</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bibId</span><span class="p">,</span> <span class="n">cite</span> <span class="ow">in</span> <span class="n">bibtex</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">bibId</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCiteText</span><span class="p">(</span><span class="n">cite</span><span class="p">,</span> <span class="n">useKeyLabel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
                <span class="n">parsedMethods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">parsedMethods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ERROR generating methods info: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">parsedMethods</span></div>

<div class="viewcode-block" id="Protocol.methods"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.methods">[docs]</a>    <span class="k">def</span> <span class="nf">methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a description about methods about current protocol</span>
<span class="sd">        execution. &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Maybe store the methods and not computing all times??</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParsedMethods</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.runProtocol"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.runProtocol">[docs]</a>    <span class="k">def</span> <span class="nf">runProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup another protocol to be run from a workflow. &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span> <span class="o">+</span> <span class="n">protocol</span><span class="o">.</span><span class="n">strId</span><span class="p">()</span>
        <span class="c1"># protocol.setName(name)</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">setWorkingDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPath</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">setMapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostConfig</span><span class="o">.</span><span class="n">setStore</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">setHostConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getHostConfig</span><span class="p">())</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">runMode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_originalRunMode</span><span class="p">)</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">makePathsAndClean</span><span class="p">()</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">setStepsExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="p">)</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>  <span class="c1"># TODO: check if this is needed</span></div>

<div class="viewcode-block" id="Protocol.isChild"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.isChild">[docs]</a>    <span class="k">def</span> <span class="nf">isChild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return true if this protocol was invoked from a workflow</span>
<span class="sd">        (another protocol)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasObjParentId</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.getStepsGraph"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.getStepsGraph">[docs]</a>    <span class="k">def</span> <span class="nf">getStepsGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a graph taking into account the dependencies between</span>
<span class="sd">        steps. In streaming we might find first the createOutputStep (e.g 24)</span>
<span class="sd">        depending on 25&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pyworkflow.utils.graph</span> <span class="k">import</span> <span class="n">Graph</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">rootName</span><span class="o">=</span><span class="s1">&#39;PROTOCOL&#39;</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getRoot</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Protocol&#39;</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadSteps</span><span class="p">()</span>
        <span class="n">stepsDict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">))}</span>
        <span class="n">stepsDone</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">addStep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>

            <span class="c1"># Exit if already done</span>
            <span class="c1"># This happens when, in streaming there is a child &quot;before&quot; a parent</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stepsDone</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">getIndex</span><span class="p">()</span> <span class="ow">or</span> <span class="n">i</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">createNode</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
            <span class="n">stepsDone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">getPrerequisites</span><span class="p">()</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                <span class="n">root</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">getPrerequisites</span><span class="p">():</span>
                    <span class="c1"># If prerequisite exists</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stepsDone</span><span class="p">:</span>
                        <span class="n">addStep</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stepsDict</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                    <span class="n">stepsDone</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stepsDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">addStep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="Protocol.closeMappers"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.closeMappers">[docs]</a>    <span class="k">def</span> <span class="nf">closeMappers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close the mappers of all output Sets. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">(</span><span class="n">Set</span><span class="p">):</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.loadMappers"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.loadMappers">[docs]</a>    <span class="k">def</span> <span class="nf">loadMappers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Open mapper connections from previous closed outputs. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterOutputAttributes</span><span class="p">(</span><span class="n">Set</span><span class="p">):</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>

<div class="viewcode-block" id="Protocol.allowsDelete"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.allowsDelete">[docs]</a>    <span class="k">def</span> <span class="nf">allowsDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Protocol.legacyCheck"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.Protocol.legacyCheck">[docs]</a>    <span class="k">def</span> <span class="nf">legacyCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Hook defined to run some compatibility checks</span>
<span class="sd">        before display the protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="LegacyProtocol"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.LegacyProtocol">[docs]</a><span class="k">class</span> <span class="nc">LegacyProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Special subclass of Protocol to be used when a protocol class</span>
<span class="sd">    is not found. It means that have been removed or it is in another</span>
<span class="sd">    development branch. In such, we will use the LegacyProtocol to</span>
<span class="sd">    simply store the parameters and inputs/outputs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObjLabel</span><span class="p">()</span>

    <span class="c1"># overload getClassDomain because legacy protocols</span>
    <span class="c1"># do not have a package associated to it</span>
<div class="viewcode-block" id="LegacyProtocol.getClassDomain"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.LegacyProtocol.getClassDomain">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getClassDomain</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pw</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">()</span></div></div>


<span class="c1"># ---------- Helper functions related to Protocols --------------------</span>

<div class="viewcode-block" id="runProtocolMain"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.runProtocolMain">[docs]</a><span class="k">def</span> <span class="nf">runProtocolMain</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main entry point when a protocol will be executed.</span>
<span class="sd">    This function should be called when:</span>
<span class="sd">    scipion runprotocol ...</span>
<span class="sd">    Params:</span>
<span class="sd">        projectPath: the absolute path to the project directory.</span>
<span class="sd">        protDbPath: path to protocol db relative to projectPath</span>
<span class="sd">        protId: id of the protocol object in db.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Enter to the project directory and load protocol from db</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">getProtocolFromDb</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">,</span> <span class="n">chdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">hostConfig</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getHostConfig</span><span class="p">()</span>

    <span class="c1"># Create the steps executor</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nThreads</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">protocol</span><span class="o">.</span><span class="n">stepsExecutionMode</span> <span class="o">==</span> <span class="n">STEPS_PARALLEL</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">protocol</span><span class="o">.</span><span class="n">numberOfMpi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Handle special case to execute in parallel</span>
            <span class="c1"># We run &quot;scipion run pyworkflow/...mpirun.py blah&quot; instead of</span>
            <span class="c1"># calling directly &quot;$SCIPION_PYTHON ...mpirun.py blah&quot;, so that</span>
            <span class="c1"># when it runs on a MPI node, it *always* has the scipion env.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;scipion&#39;</span><span class="p">,</span> <span class="s1">&#39;runprotocol&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">.</span><span class="n">getPwProtMpiRunScript</span><span class="p">(),</span>
                      <span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">]</span>
            <span class="c1"># &#39;scipion&#39; is treated now as an entry point, but if there is an alias with that name, the alias has higher</span>
            <span class="c1"># priority</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pw</span><span class="o">.</span><span class="n">PYTHON</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                     <span class="n">numberOfMpi</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                     <span class="n">hostConfig</span><span class="o">=</span><span class="n">hostConfig</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">retcode</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">nThreads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">protocol</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">():</span>
                <span class="n">executor</span> <span class="o">=</span> <span class="n">QueueStepExecutor</span><span class="p">(</span><span class="n">hostConfig</span><span class="p">,</span>
                                             <span class="n">protocol</span><span class="o">.</span><span class="n">getSubmitDict</span><span class="p">(),</span>
                                             <span class="n">nThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="n">gpuList</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadStepExecutor</span><span class="p">(</span><span class="n">hostConfig</span><span class="p">,</span> <span class="n">nThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="n">gpuList</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protocol</span><span class="o">.</span><span class="n">useQueueForSteps</span><span class="p">():</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">QueueStepExecutor</span><span class="p">(</span><span class="n">hostConfig</span><span class="p">,</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getSubmitDict</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="n">gpuList</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">StepExecutor</span><span class="p">(</span><span class="n">hostConfig</span><span class="p">,</span>
                                <span class="n">gpuList</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">())</span>

    <span class="n">protocol</span><span class="o">.</span><span class="n">setStepsExecutor</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
    <span class="c1"># Finally run the protocol</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<div class="viewcode-block" id="runProtocolMainMPI"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.runProtocolMainMPI">[docs]</a><span class="k">def</span> <span class="nf">runProtocolMainMPI</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">,</span> <span class="n">mpiComm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function only should be called after enter in runProtocolMain</span>
<span class="sd">    and the proper MPI scripts have been started...so no validations</span>
<span class="sd">    will be made.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">getProtocolFromDb</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">,</span> <span class="n">chdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hostConfig</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">getHostConfig</span><span class="p">()</span>
    <span class="c1"># Create the steps executor</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="n">MPIStepExecutor</span><span class="p">(</span><span class="n">hostConfig</span><span class="p">,</span> <span class="n">protocol</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="n">mpiComm</span><span class="p">,</span> <span class="n">gpuList</span><span class="o">=</span><span class="n">protocol</span><span class="o">.</span><span class="n">getGpuList</span><span class="p">())</span>

    <span class="n">protocol</span><span class="o">.</span><span class="n">setStepsExecutor</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
    <span class="c1"># Finally run the protocol</span>
    <span class="n">protocol</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<div class="viewcode-block" id="getProtocolFromDb"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.getProtocolFromDb">[docs]</a><span class="k">def</span> <span class="nf">getProtocolFromDb</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">,</span> <span class="n">protId</span><span class="p">,</span> <span class="n">chdir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Retrieve the Protocol object from a given .sqlite file</span>
<span class="sd">    and the protocol id.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">projectPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: project path &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist. &quot;</span>
                        <span class="o">%</span> <span class="n">projectPath</span><span class="p">)</span>

    <span class="n">fullDbPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullDbPath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: protocol database &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist. &quot;</span>
                        <span class="o">%</span> <span class="n">fullDbPath</span><span class="p">)</span>

    <span class="c1"># We need this import here because from Project is imported</span>
    <span class="c1"># all from protocol indirectly, so if move this to the top</span>
    <span class="c1"># we get an import error</span>
    <span class="kn">from</span> <span class="nn">pyworkflow.project</span> <span class="k">import</span> <span class="n">Project</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">getDomain</span><span class="p">(),</span> <span class="n">projectPath</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dbPath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">protDbPath</span><span class="p">),</span> <span class="n">chdir</span><span class="o">=</span><span class="n">chdir</span><span class="p">,</span>
                 <span class="n">loadAllConfig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getProtocol</span><span class="p">(</span><span class="n">protId</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">protocol</span></div>


<div class="viewcode-block" id="getUpdatedProtocol"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.getUpdatedProtocol">[docs]</a><span class="k">def</span> <span class="nf">getUpdatedProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Retrieve the updated protocol and close db connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">prot2</span> <span class="o">=</span> <span class="n">getProtocolFromDb</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                              <span class="n">protocol</span><span class="o">.</span><span class="n">getDbPath</span><span class="p">(),</span>
                              <span class="n">protocol</span><span class="o">.</span><span class="n">getObjId</span><span class="p">())</span>
    <span class="c1"># Close DB connections</span>
    <span class="n">prot2</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span><span class="o">.</span><span class="n">closeMapper</span><span class="p">()</span>
    <span class="n">prot2</span><span class="o">.</span><span class="n">closeMappers</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">prot2</span></div>


<div class="viewcode-block" id="isProtocolUpToDate"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.isProtocolUpToDate">[docs]</a><span class="k">def</span> <span class="nf">isProtocolUpToDate</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check timestamps between protocol lastModificationDate and the</span>
<span class="sd">    corresponding runs.db timestamp&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">protocol</span><span class="o">.</span><span class="n">lastUpdateTimeStamp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">protTS</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">lastUpdateTimeStamp</span><span class="o">.</span><span class="n">datetime</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">protTS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">dbTS</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">getFileLastModificationDate</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">getDbPath</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">protTS</span> <span class="ow">and</span> <span class="n">dbTS</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t compare if protocol is up to date: &quot;</span>
              <span class="s2">&quot;Protocol </span><span class="si">%s</span><span class="s2">, protocol time stamp: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> timeStamp: </span><span class="si">%s</span><span class="s2">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">protTS</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">dbTS</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">protTS</span> <span class="o">&gt;=</span> <span class="n">dbTS</span></div>


<div class="viewcode-block" id="ProtImportBase"><a class="viewcode-back" href="../../../api/pyworkflow/pyworkflow.protocol.protocol.html#pyworkflow.protocol.protocol.ProtImportBase">[docs]</a><span class="k">class</span> <span class="nc">ProtImportBase</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base Import protocol&quot;&quot;&quot;</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: dependabot/pip/jinja2-2.11.3
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="protocol.html">dependabot/pip/jinja2-2.11.3</a></dd>
            <dd><a href="../../../../dependabot_pip_pygments-2.7.4/index.html">dependabot/pip/pygments-2.7.4</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>