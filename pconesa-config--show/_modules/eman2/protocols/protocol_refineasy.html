

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>eman2.protocols.protocol_refineasy &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How Toâ€™s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../eman2.html">eman2</a> &raquo;</li>
        
      <li>eman2.protocols.protocol_refineasy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for eman2.protocols.protocol_refineasy</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># *</span>
<span class="c1"># * Authors:     Josue Gomez Blanco (josue.gomez-blanco@mcgill.ca)</span>
<span class="c1"># *</span>
<span class="c1"># * Unidad de  Bioinformatica of Centro Nacional de Biotecnologia , CSIC</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># *</span>
<span class="c1"># **************************************************************************</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>

<span class="kn">import</span> <span class="nn">pwem</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="k">import</span> <span class="n">ProtRefine3D</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.constants</span> <span class="k">import</span> <span class="n">LEVEL_ADVANCED</span>
<span class="kn">from</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">import</span> <span class="p">(</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span>
                                        <span class="n">EnumParam</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils.path</span> <span class="k">import</span> <span class="n">cleanPattern</span><span class="p">,</span> <span class="n">makePath</span><span class="p">,</span> <span class="n">createLink</span>
<span class="kn">from</span> <span class="nn">pwem.objects.data</span> <span class="k">import</span> <span class="n">Volume</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">Plugin</span><span class="p">,</span> <span class="n">SCRATCHDIR</span>
<span class="kn">from</span> <span class="nn">..convert</span> <span class="k">import</span> <span class="n">rowToAlignment</span><span class="p">,</span> <span class="n">writeSetOfParticles</span>
<span class="kn">from</span> <span class="nn">..constants</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="EmanProtRefine"><a class="viewcode-back" href="../../../api/eman2/eman2.protocols.protocol_refineasy.html#eman2.protocols.protocol_refineasy.EmanProtRefine">[docs]</a><span class="k">class</span> <span class="nc">EmanProtRefine</span><span class="p">(</span><span class="n">ProtRefine3D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This protocol wraps *e2refine_easy.py* EMAN2 program.</span>

<span class="sd">This is the primary single particle refinement program in EMAN2.1+.</span>
<span class="sd">It replaces earlier programs such as e2refine.py and e2refine_evenodd.py.</span>

<span class="sd">Major features of this program:</span>

<span class="sd"> * While a range of command-line options still exist. You should not</span>
<span class="sd"> normally specify more than a few basic requirements. The rest will</span>
<span class="sd"> be auto-selected for you.</span>
<span class="sd"> * This program will split your data in half and automatically</span>
<span class="sd"> refine the halves independently to produce a gold standard resolution</span>
<span class="sd"> curve for every step in the refinement.</span>
<span class="sd"> * An HTML report file will be generated as this program runs,</span>
<span class="sd"> telling you exactly what it decided to do and why, as well as giving</span>
<span class="sd"> information about runtime, etc while the job is still running.</span>
<span class="sd"> * The gold standard FSC also permits us to automatically filter the</span>
<span class="sd"> structure at each refinement step. The resolution you specify is</span>
<span class="sd"> a target, NOT the filter resolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;refine easy&#39;</span>

    <span class="k">def</span> <span class="nf">_createFilenameTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Centralize the names of the files. &quot;&quot;&quot;</span>

        <span class="n">myDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;partSet&#39;</span><span class="p">:</span> <span class="s1">&#39;sets/inputSet.lst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;partFlipSet&#39;</span><span class="p">:</span> <span class="s1">&#39;sets/inputSet__ctf_flip.lst&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data_scipion&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;data_scipion_it</span><span class="si">%(iter)02d</span><span class="s1">.sqlite&#39;</span><span class="p">),</span>
            <span class="s1">&#39;projections&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;projections_it</span><span class="si">%(iter)02d</span><span class="s1">_</span><span class="si">%(half)s</span><span class="s1">.sqlite&#39;</span><span class="p">),</span>
            <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/classes_</span><span class="si">%(iter)02d</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;classesEven&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/classes_</span><span class="si">%(iter)02d</span><span class="s1">_even.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;classesOdd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/classes_</span><span class="si">%(iter)02d</span><span class="s1">_odd.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/cls_result_</span><span class="si">%(iter)02d</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;clsEven&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/cls_result_</span><span class="si">%(iter)02d</span><span class="s1">_even.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;clsOdd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/cls_result_</span><span class="si">%(iter)02d</span><span class="s1">_odd.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;angles&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;projectionAngles_it</span><span class="si">%(iter)02d</span><span class="s1">.txt&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mapEven&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/threed_</span><span class="si">%(iter)02d</span><span class="s1">_even.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mapOdd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/threed_</span><span class="si">%(iter)02d</span><span class="s1">_odd.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mapFull&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/threed_</span><span class="si">%(iter)02d</span><span class="s1">.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mapEvenUnmasked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/threed_even_unmasked.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;mapOddUnmasked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/threed_odd_unmasked.hdf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fscUnmasked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/fsc_unmasked_</span><span class="si">%(iter)02d</span><span class="s1">.txt&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fscMasked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/fsc_masked_</span><span class="si">%(iter)02d</span><span class="s1">.txt&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fscMaskedTight&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/fsc_maskedtight_</span><span class="si">%(iter)02d</span><span class="s1">.txt&#39;</span><span class="p">),</span>
            <span class="s1">&#39;reportHtml&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_</span><span class="si">%(run)02d</span><span class="s1">/report/index.html&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateFilenamesDict</span><span class="p">(</span><span class="n">myDict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_createIterTemplates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currRun</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the regex on how to find iterations. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterTemplate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;mapFull&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">currRun</span><span class="p">,</span>
                                               <span class="nb">iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;threed_01&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;threed_??&#39;</span><span class="p">)</span>
        <span class="c1"># Iterations will be identify by threed_XX_ where XX is the iteration</span>
        <span class="c1"># number and is restricted to only 2 digits.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;threed_(\d</span><span class="si">{2}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="c1"># --------------------------- DEFINE param functions ----------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doContinue&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Continue from a previous run?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If you set to *Yes*, you should select a previous &#39;</span>
                           <span class="s1">&#39;run of type *</span><span class="si">%s</span><span class="s1">* class and most of the input parameters &#39;</span>
                           <span class="s1">&#39;will be taken from it.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">())</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;continueRun&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;doContinue&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Select previous run&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select a previous run to continue from.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputParticles&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input particles&quot;</span><span class="p">,</span>
                      <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;SetOfParticles&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doContinue&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the input particles.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;input3DReference&#39;</span><span class="p">,</span> <span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="n">allowsNull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial 3D reference volume&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doContinue&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input 3D reference reconstruction.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;skipctf&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">LEVEL_ADVANCED</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Skip ctf estimation?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use this if you want to skip running e2ctf.py. &#39;</span>
                           <span class="s1">&#39;It is not recommended to skip this step unless CTF &#39;</span>
                           <span class="s1">&#39;estimation was already done with EMAN2.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;numberOfIterations&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of iterations&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The total number of refinement iterations to &#39;</span>
                           <span class="s1">&#39;perform.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;tophat&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">],</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Tophat filter?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">TOPHAT_NONE</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_COMBO</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Instead of imposing a final &#39;</span>
                           <span class="s1">&#39;Wiener filter (tophat = none)), use a tophat &#39;</span>
                           <span class="s1">&#39;filter (global similar to Relion). local &#39;</span>
                           <span class="s1">&#39;determines local resolution and &#39;</span>
                           <span class="s1">&#39;filters. Danger of feature exaggeration.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;not doContinue&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Symmetry group&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the symmetry; if no value is given then the &#39;</span>
                           <span class="s1">&#39;model is assumed to have no symmetry. </span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Choices are: c(n), d(n), tet, icos, or oct.</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;See http://blake.bcm.edu/emanwiki/EMAN2/Symmetry &#39;</span>
                           <span class="s1">&#39;for a detailed description of symmetry in Eman.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doBreaksym&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Break symmetry?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set True, reconstruction will be asymmetric &#39;</span>
                           <span class="s1">&#39;with *Symmetry group* parameter specifying a &#39;</span>
                           <span class="s1">&#39;known pseudosymmetry, not an imposed symmetry.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;resol&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;25.0&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target resolution (A)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Target resolution in A of this refinement run. &#39;</span>
                           <span class="s1">&#39;Usually works best in at least two steps &#39;</span>
                           <span class="s1">&#39;(low/medium) resolution, then final resolution) &#39;</span>
                           <span class="s1">&#39;when starting with a poor starting model. &#39;</span>
                           <span class="s1">&#39;Usually 3-4 iterations is sufficient.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;molMass&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;500.0&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Molecular mass (kDa)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Approximate molecular mass of the particle, in kDa. &#39;</span>
                           <span class="s1">&#39;This is used to run normalize.bymass. Due to &#39;</span>
                           <span class="s1">&#39;resolution effects, not always the true mass.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useE2make3d&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use old e2make3d?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use the traditional e2make3d program instead of &#39;</span>
                           <span class="s1">&#39;the new e2make3dpar program.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;maskExpand&#39;</span><span class="p">,</span> <span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expand mask by (px)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Default=boxsize/20. Specify number of voxels to &#39;</span>
                           <span class="s1">&#39;expand mask before soft edge. Use this if low &#39;</span>
                           <span class="s1">&#39;density peripheral features are cut off by the mask.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;noRandPhase&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Supress phase randomization&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Suppress independent phase randomization &#39;</span>
                           <span class="s1">&#39;of input map. Only appropriate if input &#39;</span>
                           <span class="s1">&#39;map has been preprocessed in some suitable &#39;</span>
                           <span class="s1">&#39;fashion.&#39;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Advanced&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;speed&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">],</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Speed&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SPEED_5</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_COMBO</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Balances speed vs precision. &#39;</span>
                           <span class="s1">&#39;Larger values sacrifice a bit of potential &#39;</span>
                           <span class="s1">&#39;resolution for significant speed increases. Set &#39;</span>
                           <span class="s1">&#39;to 1 when really pushing resolution. Set to 7 for &#39;</span>
                           <span class="s1">&#39;initial refinements.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;classKeep&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0.9&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fraction of particles to use in final average&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The fraction of particles to keep in each class,&#39;</span>
                           <span class="s1">&#39;based on the similarity score.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;m3dKeep&#39;</span><span class="p">,</span> <span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fraction of class-averages to use in 3-D map&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The fraction of slices to keep in reconstruction.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useBispec&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use bispectra? (experimental)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Will use bispectra for orientation &#39;</span>
                           <span class="s1">&#39;determination (EXPERIMENTAL).&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;useSetsfref&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Use the setsfref option in class averaging?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This matches the filtration of the class-averages &#39;</span>
                           <span class="s1">&#39;to the projections for easier comparison. May &#39;</span>
                           <span class="s1">&#39;also improve convergence. &#39;</span>
                           <span class="s1">&#39;Disabled when ampcorrect=flatten is used.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doAutomask&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Do automask to the class-average?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This will apply an automask to the class-average &#39;</span>
                           <span class="s1">&#39;during iterative alignment for better accuracy. &#39;</span>
                           <span class="s1">&#39;The final class averages are unmasked.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;doThreshold&#39;</span><span class="p">,</span> <span class="n">BooleanParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Apply threshold before project the volume?&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Applies a threshold to the volume just before &#39;</span>
                           <span class="s1">&#39;generating projections. A sort of aggressive &#39;</span>
                           <span class="s1">&#39;solvent flattening for the reference.&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;m3dPostProcess&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Postprocess parameters&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&lt;name&gt;:&lt;parm&gt;=&lt;value&gt;:...  An arbitrary processor &quot;</span>
                           <span class="s2">&quot;(e2help.py processors -v2) to apply to the 3-D map &quot;</span>
                           <span class="s2">&quot;after each iteration. Default=none&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;ampCorrect&#39;</span><span class="p">,</span> <span class="n">EnumParam</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;strucfac&#39;</span><span class="p">,</span> <span class="s1">&#39;flatten&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">],</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Amplitude correction:&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">AMP_AUTO</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="n">EnumParam</span><span class="o">.</span><span class="n">DISPLAY_COMBO</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Will perform amplitude correction via the specified &quot;</span>
                           <span class="s2">&quot;method. &#39;flatten&#39; requires a target resolution better &quot;</span>
                           <span class="s2">&quot;than 8 angstroms (experimental). &#39;none&#39; will disable &quot;</span>
                           <span class="s2">&quot;amplitude correction (experimental).&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;extraParams&#39;</span><span class="p">,</span> <span class="n">StringParam</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Additional parameters&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In this box command-line arguments may be &quot;</span>
                           <span class="s2">&quot;provided that are not generated by the GUI. &quot;</span>
                           <span class="s2">&quot;See e2refine_easy.py -h.&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># --------------------------- INSERT steps functions ----------------------</span>
    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createFilenameTemplates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createIterTemplates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getRun</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input3DReference</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createLinkSteps&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepareContinueParams</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;convertImagesStep&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepareParams</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;refineStep&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s1">&#39;createOutputStep&#39;</span><span class="p">)</span>

    <span class="c1"># --------------------------- STEPS functions -----------------------------</span>
<div class="viewcode-block" id="EmanProtRefine.createLinkSteps"><a class="viewcode-back" href="../../../api/eman2/eman2.protocols.protocol_refineasy.html#eman2.protocols.protocol_refineasy.EmanProtRefine.createLinkSteps">[docs]</a>    <span class="k">def</span> <span class="nf">createLinkSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">continueRun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">prevPartDir</span> <span class="o">=</span> <span class="n">continueRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;particles&quot;</span><span class="p">)</span>
        <span class="n">currPartDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;particles&quot;</span><span class="p">)</span>
        <span class="n">runN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRun</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">prevRefDir</span> <span class="o">=</span> <span class="n">continueRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;refine_</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">runN</span><span class="p">)</span>
        <span class="n">currRefDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;refine_</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">runN</span><span class="p">)</span>
        <span class="n">prevSetsDir</span> <span class="o">=</span> <span class="n">continueRun</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;sets&quot;</span><span class="p">)</span>
        <span class="n">currSetsDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;sets&quot;</span><span class="p">)</span>

        <span class="n">createLink</span><span class="p">(</span><span class="n">prevPartDir</span><span class="p">,</span> <span class="n">currPartDir</span><span class="p">)</span>
        <span class="n">createLink</span><span class="p">(</span><span class="n">prevRefDir</span><span class="p">,</span> <span class="n">currRefDir</span><span class="p">)</span>
        <span class="n">createLink</span><span class="p">(</span><span class="n">prevSetsDir</span><span class="p">,</span> <span class="n">currSetsDir</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmanProtRefine.convertImagesStep"><a class="viewcode-back" href="../../../api/eman2/eman2.protocols.protocol_refineasy.html#eman2.protocols.protocol_refineasy.EmanProtRefine.convertImagesStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertImagesStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">partSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span>
        <span class="n">partAlign</span> <span class="o">=</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getAlignment</span><span class="p">()</span>
        <span class="n">storePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;particles&quot;</span><span class="p">)</span>
        <span class="n">makePath</span><span class="p">(</span><span class="n">storePath</span><span class="p">)</span>
        <span class="n">writeSetOfParticles</span><span class="p">(</span><span class="n">partSet</span><span class="p">,</span> <span class="n">storePath</span><span class="p">,</span> <span class="n">alignType</span><span class="o">=</span><span class="n">partAlign</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipctf</span><span class="p">:</span>
            <span class="n">program</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(</span><span class="s1">&#39;e2ctf.py&#39;</span><span class="p">)</span>
            <span class="n">acq</span> <span class="o">=</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getAcquisition</span><span class="p">()</span>

            <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; --voltage </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">acq</span><span class="o">.</span><span class="n">getVoltage</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --cs </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">acq</span><span class="o">.</span><span class="n">getSphericalAberration</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --ac </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">acq</span><span class="o">.</span><span class="n">getAmplitudeContrast</span><span class="p">())</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --threads=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">partSet</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">():</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --phaseflip&quot;</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --computesf --apix </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">partSet</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --allparticles --autofit --curdefocusfix --storeparm -v 8&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                        <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">program</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(</span><span class="s1">&#39;e2buildsets.py&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; --setname=inputSet --allparticles --minhisnr=-1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                    <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmanProtRefine.refineStep"><a class="viewcode-back" href="../../../api/eman2/eman2.protocols.protocol_refineasy.html#eman2.protocols.protocol_refineasy.EmanProtRefine.refineStep">[docs]</a>    <span class="k">def</span> <span class="nf">refineStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run the EMAN program to refine a volume. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span><span class="p">:</span>
            <span class="n">cleanPattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s1">&#39;refine_01&#39;</span><span class="p">))</span>
        <span class="n">program</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(</span><span class="s1">&#39;e2refine_easy.py&#39;</span><span class="p">)</span>
        <span class="c1"># mpi and threads are handled by EMAN itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                    <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmanProtRefine.createOutputStep"><a class="viewcode-back" href="../../../api/eman2/eman2.protocols.protocol_refineasy.html#eman2.protocols.protocol_refineasy.EmanProtRefine.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iterN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">partSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span>
        <span class="n">numRun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRun</span><span class="p">()</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">Volume</span><span class="p">()</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;mapFull&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">))</span>
        <span class="n">halfMap1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;mapEvenUnmasked&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">)</span>
        <span class="n">halfMap2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;mapOddUnmasked&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">)</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">setHalfMaps</span><span class="p">([</span><span class="n">halfMap1</span><span class="p">,</span> <span class="n">halfMap2</span><span class="p">])</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">partSet</span><span class="p">)</span>

        <span class="n">newPartSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfParticles</span><span class="p">()</span>
        <span class="n">newPartSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="n">partSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fillDataFromIter</span><span class="p">(</span><span class="n">newPartSet</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputVolume</span><span class="o">=</span><span class="n">vol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineSourceRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticlesPointer</span><span class="p">(),</span> <span class="n">vol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputParticles</span><span class="o">=</span><span class="n">newPartSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defineTransformRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticlesPointer</span><span class="p">(),</span> <span class="n">newPartSet</span><span class="p">)</span></div>

    <span class="c1"># --------------------------- INFO functions ------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span>
        <span class="n">samplingRate</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">samplingRate</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target resolution is smaller than Nyquist limit.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;outputVolume&#39;</span><span class="p">):</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Output volume is not ready yet.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="n">outputSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParticles</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">inputSize</span> <span class="o">-</span> <span class="n">outputSize</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Warning!!! </span><span class="si">%d</span><span class="s2"> particles &quot;</span>
                               <span class="s2">&quot;were discarded during refinement.&quot;</span> <span class="o">%</span> <span class="n">diff</span><span class="p">)</span>

        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;To see progress report, click &quot;</span>
                       <span class="s2">&quot;*Analyze Results*  and choose *Show &quot;</span>
                       <span class="s2">&quot;HTML report*.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Bell2016&#39;</span><span class="p">]</span>

    <span class="c1"># --------------------------- UTILS functions -----------------------------</span>
    <span class="k">def</span> <span class="nf">_prepareParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="s2">&quot; --input=</span><span class="si">%(imgsFn)s</span><span class="s2"> --model=</span><span class="si">%(volume)s</span><span class="s2">&quot;</span>
        <span class="n">args2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commonParams</span><span class="p">()</span>

        <span class="n">refVolFn</span> <span class="o">=</span> <span class="s2">&quot;ref_vol.hdf&quot;</span>
        <span class="n">origVol</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input3DReference</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:mrc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> --apix=</span><span class="si">%0.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">origVol</span><span class="p">,</span> <span class="n">refVolFn</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">input3DReference</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getProgram</span><span class="p">(</span><span class="s1">&#39;e2proc3d.py&#39;</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span>
                    <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(),</span>
                    <span class="n">numberOfMpi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numberOfThreads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;imgsFn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getParticlesStack</span><span class="p">(),</span>
                  <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">refVolFn</span><span class="p">}</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">args1</span> <span class="o">%</span> <span class="n">params</span> <span class="o">+</span> <span class="n">args2</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_prepareContinueParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args1</span> <span class="o">=</span> <span class="s2">&quot;--startfrom=refine_</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getRun</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">args2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commonParams</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args1</span> <span class="o">+</span> <span class="n">args2</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_commonParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; --targetres=</span><span class="si">%(resol)f</span><span class="s2"> --speed=</span><span class="si">%(speed)d</span><span class="s2"> --sym=</span><span class="si">%(sym)s</span><span class="s2"> &quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --iter=</span><span class="si">%(numberOfIterations)d</span><span class="s2"> --mass=</span><span class="si">%(molMass)f</span><span class="s2"> &quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --apix=</span><span class="si">%(samplingRate)f</span><span class="s2"> --classkeep=</span><span class="si">%(classKeep)f</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --m3dkeep=</span><span class="si">%(m3dKeep)f</span><span class="s2"> --parallel=mpi:</span><span class="si">%(mpis)d</span><span class="s2">:</span><span class="si">%(scratch)s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --m3dkeep=</span><span class="si">%(m3dKeep)f</span><span class="s2"> --parallel=thread:</span><span class="si">%(threads)d</span><span class="s2">&quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --threads=</span><span class="si">%(threads)d</span><span class="s2">&quot;</span>

        <span class="n">samplingRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resol</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getEnumText</span><span class="p">(</span><span class="s1">&#39;speed&#39;</span><span class="p">)),</span>
                  <span class="s1">&#39;numberOfIterations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfIterations</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;sym&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;molMass&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">molMass</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;samplingRate&#39;</span><span class="p">:</span> <span class="n">samplingRate</span><span class="p">,</span>
                  <span class="s1">&#39;classKeep&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">classKeep</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;m3dKeep&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m3dKeep</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;threads&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;mpis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                  <span class="s1">&#39;scratch&#39;</span><span class="p">:</span> <span class="n">SCRATCHDIR</span>
                  <span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">%</span> <span class="n">params</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doBreaksym</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --breaksym&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useE2make3d</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --m3dold&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskExpand</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --automaskexpand=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskExpand</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useSetsfref</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --classrefsf&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doAutomask</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --classautomask&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doThreshold</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --prethreshold&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m3dPostProcess</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --m3dpostprocess=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">m3dPostProcess</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --ampcorrect=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnumText</span><span class="p">(</span><span class="s1">&#39;ampCorrect&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tophat</span> <span class="o">!=</span> <span class="n">TOPHAT_NONE</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --tophat=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnumText</span><span class="p">(</span><span class="s1">&#39;tophat&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useBispec</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --invar&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noRandPhase</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s2">&quot; --norandomaphase&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraParams</span><span class="o">.</span><span class="n">hasValue</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraParams</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_getRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;refine*&quot;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">refineNumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">refineNumber</span>

    <span class="k">def</span> <span class="nf">_getBaseName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove the folders and return the file from the filename. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_getParticlesStack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">isPhaseFlipped</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipctf</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;partFlipSet&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;partSet&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iterTextFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;angles&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_createItemMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">rowList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rowList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setTransform</span><span class="p">(</span><span class="n">rowToAlignment</span><span class="p">(</span><span class="n">rowList</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
                                             <span class="n">alignType</span><span class="o">=</span><span class="n">pwem</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">ALIGN_PROJ</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;_appendItem&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getIterNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of iteration files, give the iterTemplate. &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterTemplate</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterRegex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># group 1 is 3 digits iteration number</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_lastIter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getIterNumber</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_firstIter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getIterNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_getIterData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="n">data_sqlite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;data_scipion&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">it</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_sqlite</span><span class="p">):</span>
            <span class="n">iterImgSet</span> <span class="o">=</span> <span class="n">pwem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">SetOfParticles</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">data_sqlite</span><span class="p">)</span>
            <span class="n">iterImgSet</span><span class="o">.</span><span class="n">copyInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fillDataFromIter</span><span class="p">(</span><span class="n">iterImgSet</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
            <span class="n">iterImgSet</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">iterImgSet</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data_sqlite</span>

    <span class="k">def</span> <span class="nf">_getInputParticlesPointer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doContinue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continueRun</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">inputParticles</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputParticles</span>

    <span class="k">def</span> <span class="nf">_getInputParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticlesPointer</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fillDataFromIter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgSet</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="n">numRun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getRun</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execEmanProcess</span><span class="p">(</span><span class="n">numRun</span><span class="p">,</span> <span class="n">iterN</span><span class="p">)</span>
        <span class="n">initPartSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getInputParticles</span><span class="p">()</span>
        <span class="n">imgSet</span><span class="o">.</span><span class="n">setAlignmentProj</span><span class="p">()</span>
        <span class="n">partIter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">initPartSet</span><span class="o">.</span><span class="n">iterItems</span><span class="p">(</span><span class="n">orderBy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_micId&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                              <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASC&#39;</span><span class="p">))</span>

        <span class="n">imgSet</span><span class="o">.</span><span class="n">copyItems</span><span class="p">(</span><span class="n">partIter</span><span class="p">,</span>
                         <span class="n">updateItemCallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_createItemMatrix</span><span class="p">,</span>
                         <span class="n">itemDataIterator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterTextFile</span><span class="p">(</span><span class="n">iterN</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_execEmanProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numRun</span><span class="p">,</span> <span class="n">iterN</span><span class="p">):</span>
        <span class="n">clsFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;cls&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)</span>
        <span class="n">classesFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s2">&quot;classes&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;angles&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getFileName</span><span class="p">(</span><span class="s1">&#39;clsEven&#39;</span><span class="p">,</span>
                                                                           <span class="n">run</span><span class="o">=</span><span class="n">numRun</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">Plugin</span><span class="o">.</span><span class="n">createEmanProcess</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;read </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> 3d&#39;</span>
                                                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getParticlesStack</span><span class="p">(),</span> <span class="n">clsFn</span><span class="p">,</span> <span class="n">classesFn</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_getBaseName</span><span class="p">(</span><span class="s1">&#39;angles&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">iterN</span><span class="p">)),</span>
                                            <span class="n">direc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">())</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: pconesa-config--show
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../dependabot_pip_jinja2-2.10.1/index.html">dependabot/pip/jinja2-2.10.1</a></dd>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="protocol_refineasy.html">pconesa-config--show</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="../../../../rsanchezgarc-patch-1/index.html">rsanchezgarc-patch-1</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>