

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>continuousflex.protocols.protocol_genesis &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/user/license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../continuousflex.html">continuousflex</a> &raquo;</li>
        
      <li>continuousflex.protocols.protocol_genesis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for continuousflex.protocols.protocol_genesis</h1><div class="highlight"><pre>
<span></span><span class="c1"># **************************************************************************</span>
<span class="c1"># * Authors: Rémi Vuillemot             (remi.vuillemot@upmc.fr)</span>
<span class="c1"># *</span>
<span class="c1"># * IMPMC, UPMC Sorbonne University</span>
<span class="c1"># *</span>
<span class="c1"># * This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># * it under the terms of the GNU General Public License as published by</span>
<span class="c1"># * the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># * (at your option) any later version.</span>
<span class="c1"># *</span>
<span class="c1"># * This program is distributed in the hope that it will be useful,</span>
<span class="c1"># * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># * GNU General Public License for more details.</span>
<span class="c1"># *</span>
<span class="c1"># * You should have received a copy of the GNU General Public License</span>
<span class="c1"># * along with this program; if not, write to the Free Software</span>
<span class="c1"># * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="c1"># * 02111-1307  USA</span>
<span class="c1"># *</span>
<span class="c1"># *  All comments concerning this program package may be sent to the</span>
<span class="c1"># *  e-mail address &#39;scipion@cnb.csic.es&#39;</span>
<span class="c1"># **************************************************************************</span>


<span class="kn">import</span> <span class="nn">pyworkflow.protocol.params</span> <span class="k">as</span> <span class="nn">params</span>
<span class="kn">from</span> <span class="nn">pwem.protocols</span> <span class="kn">import</span> <span class="n">EMProtocol</span>
<span class="kn">from</span> <span class="nn">pwem.objects.data</span> <span class="kn">import</span> <span class="n">AtomStruct</span><span class="p">,</span> <span class="n">SetOfAtomStructs</span><span class="p">,</span> <span class="n">SetOfPDBs</span><span class="p">,</span> <span class="n">SetOfVolumes</span><span class="p">,</span><span class="n">SetOfParticles</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mrcfile</span>
<span class="kn">from</span> <span class="nn">pwem.utils</span> <span class="kn">import</span> <span class="n">runProgram</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="kn">import</span> <span class="n">getListFromRangeString</span>


<span class="kn">from</span> <span class="nn">.utilities.genesis_utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">xmipp3</span> <span class="kn">import</span> <span class="n">Plugin</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="k">as</span> <span class="nn">pwutils</span>
<span class="kn">from</span> <span class="nn">pyworkflow.utils</span> <span class="kn">import</span> <span class="n">runCommand</span>

<div class="viewcode-block" id="ProtGenesis"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis">[docs]</a><span class="k">class</span> <span class="nc">ProtGenesis</span><span class="p">(</span><span class="n">EMProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Protocol to perform MD simulation using GENESIS. &quot;&quot;&quot;</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="s1">&#39;Genesis&#39;</span>

    <span class="c1"># --------------------------- DEFINE param functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_defineParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>

        <span class="c1"># Inputs ============================================================================================</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Inputs&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;md_program&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MD program&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">PROGRAM_ATDYN</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ATDYN&#39;</span><span class="p">,</span> <span class="s1">&#39;SPDYN&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SPDYN (Spatial decomposition dynamics) and ATDYN (Atomic decomposition dynamics)&quot;</span>
                    <span class="s2">&quot; share almost the same data structures, subroutines, and modules, but differ in&quot;</span>
                    <span class="s2">&quot; their parallelization schemes. In SPDYN, the spatial decomposition scheme is implemented with new&quot;</span>
                    <span class="s2">&quot; parallel algorithms and GPGPU calculation. In ATDYN, the atomic decomposition scheme&quot;</span>
                    <span class="s2">&quot; is introduced for simplicity. The performance of ATDYN is not comparable to SPDYN due to the&quot;</span>
                    <span class="s2">&quot; simple parallelization scheme but contains new methods and features. NMMD is available only for ATDYN.&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;restartChoice&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Restart GENESIS protocol ?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Restart a previous GENESIS simulation. &quot;</span><span class="p">)</span>


        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;restartProt&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input GENESIS protocol&quot;</span><span class="p">,</span><span class="n">pointerClass</span><span class="o">=</span><span class="s2">&quot;ProtGenesis&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Provide a GENESIS protocol to restart.&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;restartChoice&quot;</span> <span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputPDB&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span>
                      <span class="n">pointerClass</span><span class="o">=</span><span class="s1">&#39;AtomStruct&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input PDB&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the input PDB.&#39;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Forcefield Inputs&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;not restartChoice&quot;</span> <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;forcefield&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Forcefield type&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CHARMM&#39;</span><span class="p">,</span> <span class="s1">&#39;AAGO&#39;</span><span class="p">,</span> <span class="s1">&#39;CAGO&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of the force field used for energy and force calculation&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;generateTop&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Generate topology files ?&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use the GUI to generate topology files for you (PSF file for CHARMM and TOP file for AAGO/CAGO).&quot;</span>
                                          <span class="s2">&quot; Requires VMD psfgen for CHARMM forcefields &quot;</span>
                                          <span class="s2">&quot; and SMOG2 for GO models. Note that the generated topology files will not include&quot;</span>
                                          <span class="s2">&quot; solvent.&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nucleicChoice&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Contains nucleic acids ?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO&#39;</span><span class="p">,</span> <span class="s1">&#39;RNA&#39;</span><span class="p">,</span> <span class="s1">&#39;DNA&#39;</span><span class="p">],</span> <span class="n">condition</span> <span class="o">=</span><span class="s2">&quot;generateTop&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify if the generator should consider nucleic residues as DNA or RNA&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;smog_dir&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Path to SMOG2 install directory (For SMOG2 installation, see &quot;</span>
                                                           <span class="s2">&quot;https://smog-server.org/smog2/ , otherwise use the web GUI &quot;</span>
                                                           <span class="s2">&quot;https://smog-server.org/cgi-bin/GenTopGro.pl )&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to SMOG2 directory&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;(forcefield==1 or forcefield==2) and generateTop&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputTOP&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GROMACS Topology File (top)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;(forcefield==1 or forcefield==2) and not generateTop&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Gromacs ‘top’ file containing information of the system such as atomic masses, charges,&#39;</span>
                           <span class="s1">&#39; atom connectivities. To generate this file for your system, you can either use the option&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> generate topology files</span><span class="se">\&quot;</span><span class="s1"> (SMOG 2 installation is required, https://smog-server.org/smog2/ ),&#39;</span>
                           <span class="s1">&#39; or using SMOG sever (https://smog-server.org/cgi-bin/GenTopGro.pl )&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputPRM&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CHARMM parameter file (prm)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;forcefield==0&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CHARMM parameter file containing force field parameters, e.g. force constants and librium&#39;</span>
                            <span class="s1">&#39; geometries. Latest forcefields can be founded at http://mackerell.umaryland.edu/charmm_ff.shtml &#39;</span> <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputRTF&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CHARMM topology file (rtf)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;forcefield==0 or ((forcefield==1 or forcefield==2) and generateTop)&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CHARMM topology file containing information about atom connectivity of residues and&#39;</span>
                           <span class="s1">&#39; other molecules. Latest forcefields can be founded at http://mackerell.umaryland.edu/charmm_ff.shtml &#39;</span>
                           <span class="s1">&#39; Note: In the case of generating topology files for GO models (SMOG2), &#39;</span>
                           <span class="s1">&#39; the CHARMM topology file and VMD psfgen are used to fill missing atoms/residues.&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputPSF&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CHARMM Structure File (psf)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;forcefield==0 and not generateTop&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CHARMM/X-PLOR psf file containing information of the system such as atomic masses,&#39;</span>
                            <span class="s1">&#39; charges, and atom connectivities. To generate this file for your system, you can either use the option&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> generate topology files</span><span class="se">\&quot;</span><span class="s1">, VMD psfgen, or online CHARMM GUI ( https://www.charmm-gui.org/ ).&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputSTR&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CHARMM stream file (str)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;forcefield==0&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CHARMM stream file containing both topology information and parameters. &#39;</span>
                           <span class="s1">&#39;Latest forcefields can be founded at http://mackerell.umaryland.edu/charmm_ff.shtml &#39;</span><span class="p">,</span>
                       <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>



        <span class="c1"># Simulation =================================================================================================</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simulation&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;simulationType&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simulation type&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Minimization&#39;</span><span class="p">,</span> <span class="s1">&#39;Molecular Dynamics (MD)&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal Mode Molecular Dynamics (NMMD)&#39;</span><span class="p">,</span> <span class="s1">&#39;Replica-Exchange MD&#39;</span><span class="p">,</span> <span class="s1">&#39;Replica-Exchange NMMD&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of simulation to be performed by GENESIS&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Simulation parameters&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;integrator&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Integrator&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Velocity Verlet&#39;</span><span class="p">,</span> <span class="s1">&#39;Leapfrog&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of integrator for the simulation&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType!=0&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;time_step&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Time step (ps)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time step in the MD run&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType!=0&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;n_steps&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of steps&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Total number of steps in one MD run&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;eneout_period&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Energy output period&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output frequency for the energy data&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;crdout_period&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Coordinate output period&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output frequency for the coordinates data&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nbupdate_period&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Non-bonded update period&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Update frequency of the non-bonded pairlist&quot;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;NMMD parameters&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nm_number&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of normal modes&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of normal modes for NMMD. 10 should work in most cases. Avoid &quot;</span>
                           <span class="s2">&quot; using too much NM (&gt;50).&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nm_mass&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NM mass&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mass value of Normal modes for NMMD&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nm_limit&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NM amplitude threshold&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Threshold of normal mode amplitude above which the normal modes are updated&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;elnemo_cutoff&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NMA cutoff (A)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cutoff distance for elastic network model&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">,</span>
                      <span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;elnemo_rtb_block&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NMA Number of residue RTB&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of residue per RTB block in the NMA computation&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==2 or simulationType==4&quot;</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;REMD parameters&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==3 or simulationType==4&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;exchange_period&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Exchange Period&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of MD steps between replica exchanges&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==3 or simulationType==4&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;nreplica&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of replicas&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of replicas for REMD&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==3 or simulationType==4&quot;</span><span class="p">)</span>

        <span class="c1"># MD params =================================================================================================</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;MD parameters&#39;</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;implicitSolvent&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Implicit Solvent&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GBSA&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn on Generalized Born/Solvent accessible surface area model (Implicit Solvent). Boundary condition must be NO.&quot;</span>
                           <span class="s2">&quot; ATDYN only.&quot;</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;boundary&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Boundary&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No boundary&#39;</span><span class="p">,</span> <span class="s1">&#39;Periodic Boundary Condition&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of boundary condition. In case of implicit solvent, &quot;</span>
                           <span class="s2">&quot; GO models or vaccum simulation, choose No boundary&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;box_size_x&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Box size X&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Box size along the x dimension&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;boundary==1&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;box_size_y&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Box size Y&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Box size along the y dimension&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;boundary==1&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;box_size_z&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Box size Z&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Box size along the z dimension&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;boundary==1&quot;</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;electrostatics&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-bonded interactions&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PME&#39;</span><span class="p">,</span> <span class="s1">&#39;Cutoff&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of Non-bonded interactions. &quot;</span>
                           <span class="s2">&quot; CUTOFF: Non-bonded interactions including the van der Waals interaction are just&quot;</span>
                           <span class="s2">&quot; truncated at cutoffdist; &quot;</span>
                           <span class="s2">&quot; PME : Particle mesh Ewald (PME) method is employed for long-range interactions.&quot;</span>
                            <span class="s2">&quot; This option is only availabe in the periodic boundary condition&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;vdw_force_switch&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Switch function Van der Waals&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This paramter determines whether the force switch function for van der Waals interactions is&quot;</span>
                        <span class="s2">&quot; employed or not. The users must take care about this parameter, when the CHARMM&quot;</span>
                        <span class="s2">&quot; force field is used. Typically, vdw_force_switch=YES should be specified in the case of&quot;</span>
                        <span class="s2">&quot; CHARMM36&quot;</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;switch_dist&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Switch Distance&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Switch-on distance for nonbonded interaction energy/force quenching&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;cutoff_dist&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cutoff Distance&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cut-off distance for the non-bonded interactions. This distance must be larger than&quot;</span>
                            <span class="s2">&quot; switchdist, while smaller than pairlistdist&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;pairlist_dist&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pairlist Distance&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Distance used to make a Verlet pair list for non-bonded interactions . This distance&quot;</span>
                            <span class="s2">&quot; must be larger than cutoffdist&quot;</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType!=0&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;ensemble&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NVT&#39;</span><span class="p">,</span> <span class="s1">&#39;NVE&#39;</span><span class="p">,</span> <span class="s1">&#39;NPT&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of ensemble, NVE: Microcanonical ensemble, NVT: Canonical ensemble,&quot;</span>
                           <span class="s2">&quot; NPT: Isothermal-isobaric ensemble&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;tpcontrol&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Thermostat/Barostat&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO&#39;</span><span class="p">,</span> <span class="s1">&#39;LANGEVIN&#39;</span><span class="p">,</span> <span class="s1">&#39;BERENDSEN&#39;</span><span class="p">,</span> <span class="s1">&#39;BUSSI&#39;</span><span class="p">],</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of thermostat and barostat. The availabe algorithm depends on the integrator :&quot;</span>
                           <span class="s2">&quot; Leapfrog : BERENDSEN, LANGEVIN;  Velocity Verlet : BERENDSEN (NVT only), LANGEVIN, BUSSI; &quot;</span>
                           <span class="s2">&quot; NMMD : LANGEVIN (NVT only)&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Temperature (K)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial and target temperature&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pressure (atm)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target pressure in the NPT ensemble&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;ensemble==2&quot;</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Contraints&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;simulationType==1 or simulationType==3&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;rigid_bond&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rigid bonds (SHAKE/RATTLE)&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn on or off the SHAKE/RATTLE algorithms for covalent bonds involving hydrogen. &quot;</span>
                           <span class="s2">&quot;Must be False for NMMD.&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;fast_water&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fast water (SETTLE)&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn on or off the SETTLE algorithm for the constraints of the water molecules&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;water_model&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Water model&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;TIP3&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Residue name of the water molecule to be rigidified in the SETTLE algorithm&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;fast_water&quot;</span><span class="p">)</span>

        <span class="c1"># Experiments =================================================================================================</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addSection</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM data&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;EMfitChoice&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cryo-EM Flexible Fitting&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of cryo-EM data to be processed&quot;</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Fitting parameters&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice!=0&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;constantK&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">StringParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10000&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Force constant (kcal/mol)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force constant in Eem = k*(1 - c.c.). Note that in the case of REUS, the number of &quot;</span>
                           <span class="s2">&quot; force constant value must be equal to the number of replicas, for example for 4 replicas,&quot;</span>
                           <span class="s2">&quot; a valid force constant is </span><span class="se">\&quot;</span><span class="s2">1000 2000 3000 4000</span><span class="se">\&quot;</span><span class="s2">, otherwise you can specify a range of &quot;</span>
                           <span class="s2">&quot; values (for example </span><span class="se">\&quot;</span><span class="s2">1000-4000</span><span class="se">\&quot;</span><span class="s2">) and the force constant values will be linearly distributed &quot;</span>
                           <span class="s2">&quot; to each replica.&quot;</span>
                      <span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice!=0&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;centerPDB&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Center PDB ?&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Center the input PDBs with the center of mass&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice!=0&quot;</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;emfit_sigma&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;EM Fit Sigma&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Resolution parameter of the simulated map. This is usually set to the half of the resolution&quot;</span>
                        <span class="s2">&quot; of the target map. For example, if the target map resolution is 5 Å, emfit_sigma=2.5&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice!=0&quot;</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;emfit_tolerance&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM Fit Tolerance&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This variable determines the tail length of the Gaussian function. For example, if em-&quot;</span>
                        <span class="s2">&quot; fit_tolerance=0.001 is specified, the Gaussian function is truncated to zero when it is less&quot;</span>
                        <span class="s2">&quot; than 0.1</span><span class="si">% o</span><span class="s2">f the maximum value. Smaller value requires large computational cost&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice!=0&quot;</span><span class="p">,</span><span class="n">expertLevel</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">LEVEL_ADVANCED</span><span class="p">)</span>

        <span class="c1"># Volumes</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Volume Parameters&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputVolume&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input volume&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the target EM density volume&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;voxel_size&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Voxel size (A)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Voxel size in ANgstrom of the target volume&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;centerOrigin&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Center Origin&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Center the volume to the origin&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;origin_x&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin X&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Origin of the first voxel in X direction (in Angstrom) &quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1 and not centerOrigin&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;origin_y&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin Y&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Origin of the first voxel in Y direction (in Angstrom) &quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1 and not centerOrigin&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;origin_z&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin Z&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Origin of the first voxel in Z direction (in Angstrom) &quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==1 and not centerOrigin&quot;</span><span class="p">)</span>

        <span class="c1"># Images</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="s1">&#39;Image Parameters&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;inputImage&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">PointerParam</span><span class="p">,</span> <span class="n">pointerClass</span><span class="o">=</span><span class="s2">&quot;Particle, SetOfParticles&quot;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input image (s)&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select the target EM density map&#39;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2&quot;</span><span class="p">,</span> <span class="n">important</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;image_size&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Image Size&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TODO&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;estimateAngleShift&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">BooleanParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Estimate rigid body ?&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, the GUI will perform rigid body alignement. &quot;</span>
                            <span class="s2">&quot;Otherwise, you must provide a set of alignement parameters for each image&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;rb_n_iter&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">IntParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of iterations for rigid body fitting&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of rigid body alignement during the simulation. If 1 is set, the rigid body alignement &quot;</span>
                           <span class="s2">&quot;will be performed once at the begining of the simulation&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2 and estimateAngleShift&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;rb_method&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">EnumParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rigid body alignement method&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Projection Matching&#39;</span><span class="p">,</span> <span class="s1">&#39;Wavelet&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of rigid body alignement. &quot;</span>
                                                                       <span class="s2">&quot;Wavelet method is recommended&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2 and estimateAngleShift&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;imageAngleShift&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FileParam</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rigid body parameters (.xmd)&quot;</span><span class="p">,</span>
                      <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2 and not estimateAngleShift&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Xmipp metadata file of rigid body parameters for each image (3 euler angles, 2 shift)&#39;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">addParam</span><span class="p">(</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">FloatParam</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel size (A)&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Pixel size of the EM data in Angstrom&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;EMfitChoice==2&quot;</span><span class="p">)</span>

        <span class="n">form</span><span class="o">.</span><span class="n">addParallelSection</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># --------------------------- INSERT steps functions --------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_insertAllSteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;convertInputPDBStep&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">EMFIT_NONE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;convertInputEMStep&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;runGenesisStep&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertFunctionStep</span><span class="p">(</span><span class="s2">&quot;createOutputStep&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------- Convert Input PDBs --------------------------------------------</span>

<div class="viewcode-block" id="ProtGenesis.convertInputPDBStep"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.convertInputPDBStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputPDBStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert input PDB step. Generate topology files and copy input PDB files</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># COPY PDBS -------------------------------------------------------------</span>
        <span class="n">inputPDBfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBfn</span><span class="p">()</span>
        <span class="n">n_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputPDB</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
            <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.pdb&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">inputPDBfn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">)</span>



        <span class="c1"># TOPOLOGY FILES -------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CHARMM</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
                    <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2">.psf </span><span class="si">%s</span><span class="s2">.psf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_AAGO</span>  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
                    <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2">.top </span><span class="si">%s</span><span class="s2">.top&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generateTop</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="c1">#CHARMM</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CHARMM</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
                        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">generatePSF</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;.pdb&quot;</span><span class="p">,</span><span class="n">inputTopo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputRTF</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                            <span class="n">outputPrefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">nucleicChoice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nucleicChoice</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="c1"># GO MODELS</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_AAGO</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
                        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">generatePSF</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;.pdb&quot;</span><span class="p">,</span> <span class="n">inputTopo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputRTF</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                    <span class="n">outputPrefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;_AA&quot;</span><span class="p">,</span> <span class="n">nucleicChoice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nucleicChoice</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                        <span class="n">generateGROTOP</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;_AA.pdb&quot;</span><span class="p">,</span> <span class="n">outputPrefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                                       <span class="n">forcefield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">(),</span> <span class="n">smog_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smog_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                        <span class="n">nucleicChoice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nucleicChoice</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># CHARMM</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CHARMM</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pdb</span><span class="p">):</span>
                        <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.psf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPSF</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>

                <span class="c1"># GO MODELS</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_AAGO</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
                    <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.top&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputTOP</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>

        <span class="c1"># Center PDBs -----------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centerPDB</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputPDB</span><span class="p">()):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;xmipp_pdb_center -i </span><span class="si">%s</span><span class="s2">.pdb -o </span><span class="si">%s</span><span class="s2">.pdb&quot;</span> <span class="o">%</span>\
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">runCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>


    <span class="c1"># --------------------------- Convert Input EM data --------------------------------------------</span>

<div class="viewcode-block" id="ProtGenesis.convertInputEMStep"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.convertInputEMStep">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputEMStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert EM data step</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">inputEMfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMfn</span><span class="p">()</span>
        <span class="n">n_em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputEM</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_VOLUMES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_em</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convertInputVol</span><span class="p">(</span><span class="n">fnInput</span><span class="o">=</span><span class="n">inputEMfn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">volPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMprefix</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_IMAGES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_em</span><span class="p">):</span>
                <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.spi&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">inputEMfn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimateAngleShift</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="n">currentAngles</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_IMAGE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMprefix</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">currentAngles</span><span class="o">.</span><span class="n">addObject</span><span class="p">())</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_ROT</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_TILT</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_PSI</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">currentAngles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_current_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span></div>

<div class="viewcode-block" id="ProtGenesis.convertInputVol"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.convertInputVol">[docs]</a>    <span class="k">def</span> <span class="nf">convertInputVol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fnInput</span><span class="p">,</span><span class="n">volPrefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert input volume data</span>
<span class="sd">        :param str fnInput: input volume file name</span>
<span class="sd">        :param str volPrefix: ouput volume prefix</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert data to mrc</span>
        <span class="n">pre</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fnInput</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s2">&quot;.mrc&quot;</span><span class="p">:</span>
            <span class="n">runProgram</span><span class="p">(</span><span class="s2">&quot;xmipp_image_convert&quot;</span><span class="p">,</span> <span class="s2">&quot;-i </span><span class="si">%s</span><span class="s2"> --oext mrc -o </span><span class="si">%s</span><span class="s2">.mrc&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">fnInput</span><span class="p">,</span><span class="n">volPrefix</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runProgram</span><span class="p">(</span><span class="s2">&quot;cp&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.mrc&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">fnInput</span><span class="p">,</span><span class="n">volPrefix</span><span class="p">))</span>

        <span class="c1"># Update mrc header</span>
        <span class="k">with</span> <span class="n">mrcfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.mrc&quot;</span> <span class="o">%</span> <span class="n">volPrefix</span><span class="p">)</span> <span class="k">as</span> <span class="n">old_mrc</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mrcfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.mrc&quot;</span> <span class="o">%</span> <span class="n">volPrefix</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_mrc</span><span class="p">:</span>
                <span class="n">new_mrc</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">old_mrc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">new_mrc</span><span class="o">.</span><span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centerOrigin</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">old_mrc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">new_mrc</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_z</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">new_mrc</span><span class="o">.</span><span class="n">update_header_from_data</span><span class="p">()</span>
                <span class="n">new_mrc</span><span class="o">.</span><span class="n">update_header_stats</span><span class="p">()</span></div>

    <span class="c1"># --------------------------- GENESIS step --------------------------------------------</span>

<div class="viewcode-block" id="ProtGenesis.runGenesisStep"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.runGenesisStep">[docs]</a>    <span class="k">def</span> <span class="nf">runGenesisStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run GENESIS simulations step</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rb_condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_IMAGES</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimateAngleShift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Parallel Genesis simulation</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">rb_condition</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runParallelGenesis</span><span class="p">()</span>

        <span class="c1"># Parallel rigid body fitting for EMFIT images</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runParallelGenesisRBFitting</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtGenesis.runParallelGenesis"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.runParallelGenesis">[docs]</a>    <span class="k">def</span> <span class="nf">runParallelGenesis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run multiple GENESIS simulations in parallel</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># SETUP MPI parameters</span>
        <span class="n">numMpiPerFit</span><span class="p">,</span> <span class="n">numLinearFit</span><span class="p">,</span> <span class="n">numParallelFit</span><span class="p">,</span> <span class="n">numLastIter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMPIParams</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLinearFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_parallel</span> <span class="o">=</span> <span class="n">numParallelFit</span> <span class="k">if</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">numLinearFit</span> <span class="k">else</span> <span class="n">numLastIter</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>

                <span class="c1"># Create INP file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createGenesisInputFile</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">,</span>
                               <span class="n">outputPrefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">indexFit</span><span class="o">=</span><span class="n">indexFit</span><span class="p">)</span>

                <span class="c1"># Create Genesis command</span>
                <span class="n">genesis_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGenesisCmd</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genesis_cmd</span><span class="p">)</span>

            <span class="c1"># Run Genesis</span>
            <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="n">numMpiPerFit</span><span class="p">,</span>
                            <span class="n">numberOfThreads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtGenesis.runParallelGenesisRBFitting"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.runParallelGenesisRBFitting">[docs]</a>    <span class="k">def</span> <span class="nf">runParallelGenesisRBFitting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># SETUP MPI parameters</span>
        <span class="n">numMpiPerFit</span><span class="p">,</span> <span class="n">numLinearFit</span><span class="p">,</span> <span class="n">numParallelFit</span><span class="p">,</span> <span class="n">numLastIter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMPIParams</span><span class="p">()</span>

        <span class="c1">#TODO initrst = str(self.inputRST.get())</span>

        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLinearFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n_parallel</span> <span class="o">=</span> <span class="n">numParallelFit</span> <span class="k">if</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">numLinearFit</span> <span class="k">else</span> <span class="n">numLastIter</span>

            <span class="c1"># Loop rigidbody align / GENESIS fitting</span>
            <span class="k">for</span> <span class="n">iterFit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rb_n_iter</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>

                <span class="c1"># ------   ALIGN PDBs---------</span>
                <span class="c1"># Transform PDBs to volume</span>
                <span class="n">cmds_pdb2vol</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                    <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                    <span class="n">inputPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span> <span class="k">if</span> <span class="n">iterFit</span> <span class="o">==</span> <span class="mi">0</span> \
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>

                    <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                    <span class="n">cmds_pdb2vol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb2vol</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="n">inputPDB</span><span class="p">,</span> <span class="n">outputVol</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span>
                                                <span class="n">sampling_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                                <span class="n">image_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
                <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds_pdb2vol</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span>

                <span class="c1"># Loop 4 times to refine the angles</span>
                <span class="c1"># sampling_rate = [10.0, 5.0, 3.0, 2.0]</span>
                <span class="c1"># angular_distance = [-1, 20, 10, 5]</span>
                <span class="n">sampling_rate</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">]</span>
                <span class="n">angular_distance</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i_align</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampling_rate</span><span class="p">)):</span>
                    <span class="n">cmds_projectVol</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">cmds_alignement</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                        <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                        <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">inputImage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.spi&quot;</span>
                        <span class="n">tmpMeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">currentAngles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_current_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

                        <span class="c1"># get commands</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_method</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">RB_PROJMATCH</span><span class="p">:</span>
                            <span class="n">cmds_projectVol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projectVol</span><span class="p">(</span><span class="n">inputVol</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span>
                                                              <span class="n">outputProj</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">expImage</span><span class="o">=</span><span class="n">inputImage</span><span class="p">,</span>
                                                              <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">[</span><span class="n">i_align</span><span class="p">],</span>
                                                              <span class="n">angular_distance</span><span class="o">=</span><span class="n">angular_distance</span><span class="p">[</span><span class="n">i_align</span><span class="p">]))</span>
                            <span class="n">cmds_alignement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projectMatch</span><span class="p">(</span><span class="n">inputImage</span><span class="o">=</span><span class="n">inputImage</span><span class="p">,</span>
                                                                <span class="n">inputProj</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">outputMeta</span><span class="o">=</span><span class="n">tmpMeta</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cmds_projectVol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">projectVol</span><span class="p">(</span><span class="n">inputVol</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span>
                                                              <span class="n">outputProj</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">expImage</span><span class="o">=</span><span class="n">inputImage</span><span class="p">,</span>
                                                              <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">[</span><span class="n">i_align</span><span class="p">],</span>
                                                              <span class="n">angular_distance</span><span class="o">=</span><span class="n">angular_distance</span><span class="p">[</span><span class="n">i_align</span><span class="p">],</span>
                                                              <span class="n">compute_neighbors</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                            <span class="n">cmds_alignement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waveletAssignement</span><span class="p">(</span><span class="n">inputImage</span><span class="o">=</span><span class="n">inputImage</span><span class="p">,</span>
                                                                      <span class="n">inputProj</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">outputMeta</span><span class="o">=</span><span class="n">tmpMeta</span><span class="p">))</span>
                    <span class="c1"># run parallel jobs</span>
                    <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds_projectVol</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span>
                    <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds_alignement</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span>

                    <span class="n">cmds_continuousAssign</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                        <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                        <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">tmpMeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">currentAngles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_current_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_method</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">RB_PROJMATCH</span><span class="p">:</span>
                            <span class="n">flipAngles</span><span class="p">(</span><span class="n">inputMeta</span><span class="o">=</span><span class="n">tmpMeta</span><span class="p">,</span> <span class="n">outputMeta</span><span class="o">=</span><span class="n">tmpMeta</span><span class="p">)</span>
                        <span class="n">cmds_continuousAssign</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">continuousAssign</span><span class="p">(</span><span class="n">inputMeta</span><span class="o">=</span><span class="n">tmpMeta</span><span class="p">,</span>
                                                                      <span class="n">inputVol</span><span class="o">=</span><span class="n">tmpPrefix</span><span class="p">,</span>
                                                                      <span class="n">outputMeta</span><span class="o">=</span><span class="n">currentAngles</span><span class="p">))</span>
                    <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds_continuousAssign</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span>


                <span class="c1"># Cleaning volumes and projections</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                    <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                    <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                    <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">%s</span><span class="s2">*&quot;</span> <span class="o">%</span> <span class="n">tmpPrefix</span><span class="p">)</span>

                <span class="c1"># ------   Run Genesis ---------</span>
                <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                    <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                    <span class="k">if</span> <span class="n">iterFit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>
                        <span class="n">inputPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">inputPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>

                    <span class="c1"># Create INP file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">createGenesisInputFile</span><span class="p">(</span><span class="n">inputPDB</span><span class="o">=</span><span class="n">inputPDB</span><span class="p">,</span>
                                   <span class="n">outputPrefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">indexFit</span><span class="o">=</span><span class="n">indexFit</span><span class="p">)</span>

                    <span class="c1"># run GENESIS</span>
                    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisCmd</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">))</span>
                <span class="n">runParallelJobs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">(),</span> <span class="n">numberOfMpi</span><span class="o">=</span><span class="n">numMpiPerFit</span><span class="p">,</span>
                                <span class="n">numberOfThreads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfThreads</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">hostConfig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stepsExecutor</span><span class="o">.</span><span class="n">hostConfig</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_n_iter</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation REMD not allowed for Rigid body fitting iteration &gt; 1&quot;</span><span class="p">)</span>

                    <span class="c1"># append files</span>
                    <span class="k">if</span> <span class="n">iterFit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                            <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                            <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                            <span class="n">newPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>

                            <span class="n">cat_cmd</span> <span class="o">=</span> <span class="s2">&quot;cat </span><span class="si">%s</span><span class="s2">.log &gt;&gt; </span><span class="si">%s</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">newPrefix</span><span class="p">)</span>
                            <span class="n">tcl_cmd</span> <span class="o">=</span> <span class="s2">&quot;animate read dcd </span><span class="si">%s</span><span class="s2">.dcd waitfor all</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newPrefix</span><span class="p">)</span>
                            <span class="n">tcl_cmd</span> <span class="o">+=</span> <span class="s2">&quot;animate read dcd </span><span class="si">%s</span><span class="s2">.dcd waitfor all</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpPrefix</span><span class="p">)</span>
                            <span class="n">tcl_cmd</span> <span class="o">+=</span> <span class="s2">&quot;animate write dcd </span><span class="si">%s</span><span class="s2">.dcd </span><span class="se">\n</span><span class="s2">exit </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newPrefix</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.tcl&quot;</span> <span class="o">%</span> <span class="n">tmpPrefix</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tcl_cmd</span><span class="p">)</span>
                            <span class="n">cp_cmd</span> <span class="o">=</span> <span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2">.pdb </span><span class="si">%s</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpPrefix</span><span class="p">,</span> <span class="n">newPrefix</span><span class="p">)</span>
                            <span class="n">runCommand</span><span class="p">(</span><span class="n">cat_cmd</span><span class="p">)</span>
                            <span class="n">runCommand</span><span class="p">(</span><span class="n">cp_cmd</span><span class="p">)</span>
                            <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;vmd -dispdev text -e </span><span class="si">%s</span><span class="s2">.tcl&quot;</span> <span class="o">%</span> <span class="n">tmpPrefix</span><span class="p">)</span>

                    <span class="c1"># rstfile = &quot;&quot;</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">):</span>
                        <span class="n">indexFit</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i1</span> <span class="o">*</span> <span class="n">numParallelFit</span>
                        <span class="n">newPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">iterFit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>

                        <span class="c1"># runCommand(&quot;cp %s.rst %s.tmp.rst&quot; % (tmpPrefix, newPrefix))</span>
                        <span class="c1"># rstfile += &quot;%s.tmp.rst &quot;%newPrefix</span>
                        <span class="c1">#save angles</span>
                        <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_current_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                        <span class="n">saved_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_iter</span><span class="si">%i</span><span class="s2">_angles.xmd&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">iterFit</span><span class="p">))</span>
                        <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;cp </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">saved_angles</span><span class="p">))</span>

                        <span class="c1">#cleaning</span>
                        <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">indexFit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span></div>
            <span class="c1">#         self.inputRST.set(rstfile)</span>
            <span class="c1"># self.inputRST.set(initrst)</span>

<div class="viewcode-block" id="ProtGenesis.createGenesisInputFile"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.createGenesisInputFile">[docs]</a>    <span class="k">def</span> <span class="nf">createGenesisInputFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputPDB</span><span class="p">,</span> <span class="n">outputPrefix</span><span class="p">,</span> <span class="n">indexFit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create INP input file for GENESIS</span>
<span class="sd">        :param str inputPDB: input PDB file name</span>
<span class="sd">        :param str outputPrefix: output prefix</span>
<span class="sd">        :param int indexFit: index of the simulation</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputPDBprefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>
        <span class="n">inputEMprefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputEMprefix</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>
        <span class="n">inp_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_INP&quot;</span><span class="o">%</span> <span class="n">outputPrefix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">inputProt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputProt</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[INPUT] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pdbfile = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputPDB</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CHARMM</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;topfile = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputProt</span><span class="o">.</span><span class="n">inputRTF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;parfile = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputProt</span><span class="o">.</span><span class="n">inputPRM</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;psffile = </span><span class="si">%s</span><span class="s2">.psf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputPDBprefix</span>
            <span class="k">if</span> <span class="n">inputProt</span><span class="o">.</span><span class="n">inputSTR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">inputProt</span><span class="o">.</span><span class="n">inputSTR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;strfile = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputProt</span><span class="o">.</span><span class="n">inputSTR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_AAGO</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;grotopfile = </span><span class="si">%s</span><span class="s2">.top</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputPDBprefix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rstfile = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRestartFile</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[OUTPUT] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;remfile = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2">.rem</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;logfile = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2">.log</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;dcdfile = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2">.dcd</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rstfile = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2">.rst</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pdbfile = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2">.pdb</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;dcdfile = </span><span class="si">%s</span><span class="s2">.dcd</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rstfile = </span><span class="si">%s</span><span class="s2">.rst</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pdbfile = </span><span class="si">%s</span><span class="s2">.pdb</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">outputPrefix</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ENERGY] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CHARMM</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;forcefield = CHARMM </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_AAGO</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;forcefield = AAGO  </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;forcefield = CAGO  </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrostatics</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">ELECTROSTATICS_CUTOFF</span> <span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;electrostatic = CUTOFF  </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;electrostatic = PME  </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;switchdist   = </span><span class="si">%.2f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_dist</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;cutoffdist   = </span><span class="si">%.2f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_dist</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pairlistdist = </span><span class="si">%.2f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairlist_dist</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw_force_switch</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;vdw_force_switch = YES </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicitSolvent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">IMPLICIT_SOLVENT_GBSA</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;implicit_solvent = GBSA </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;gbsa_eps_solvent = 78.5 </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;gbsa_eps_solute  = 1.0 </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;gbsa_salt_cons   = 0.2 </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;gbsa_surf_tens   = 0.005 </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_MIN</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[MINIMIZE]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;method = SD</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DYNAMICS] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_NMMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;integrator = NMMD  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">INTEGRATOR_VVERLET</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;integrator = VVER  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">INTEGRATOR_LEAPFROG</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;integrator = LEAP  </span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;timestep = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;nsteps = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_steps</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;eneout_period = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eneout_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;crdout_period = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdout_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rstout_period = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_steps</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;nbupdate_period = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbupdate_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_NMMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[NMMD] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;nm_number = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm_number</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;nm_mass = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm_mass</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;nm_limit = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm_limit</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;elnemo_cutoff = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">elnemo_cutoff</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;elnemo_rtb_block = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">elnemo_rtb_block</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;elnemo_path = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="n">Plugin</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="s2">&quot;NMA_HOME&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span> <span class="p">:</span>
                <span class="n">s</span><span class="o">+=</span> <span class="s2">&quot;nm_prefix = </span><span class="si">%s</span><span class="s2">_remd</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outputPrefix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;nm_prefix = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outputPrefix</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SIMULATION_MIN</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CONSTRAINTS] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_bond</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>        <span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rigid_bond = YES </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span>                            <span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rigid_bond = NO </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_water</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>      <span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;fast_water = YES </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;water_model = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">water_model</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">else</span>                            <span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;fast_water = NO </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[BOUNDARY] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">BOUNDARY_PBC</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;type = PBC </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;box_size_x = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size_x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;box_size_y = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size_y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;box_size_z = </span><span class="si">%f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size_z</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;type = NOBC </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SIMULATION_MIN</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ENSEMBLE] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">ENSEMBLE_NVE</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;ensemble = NVE  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">ENSEMBLE_NPT</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;ensemble = NPT  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;ensemble = NVT  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpcontrol</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">TPCONTROL_LANGEVIN</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;tpcontrol = LANGEVIN  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpcontrol</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">TPCONTROL_BERENDSEN</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;tpcontrol = BERENDSEN  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpcontrol</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">TPCONTROL_BUSSI</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;tpcontrol = BUSSI  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;tpcontrol = NO  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;temperature = </span><span class="si">%.2f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">ENSEMBLE_NPT</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pressure = </span><span class="si">%.2f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">EMFIT_VOLUMES</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">EMFIT_IMAGES</span><span class="p">)</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SIMULATION_MIN</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SELECTION] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;group1 = all and not hydrogen</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[RESTRAINTS] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;nfunctions = 1 </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;function1 = EM </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">constStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constantK</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">constStr</span> <span class="p">:</span>
                <span class="n">splt</span> <span class="o">=</span> <span class="n">constStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="n">constStr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">())])</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;constant1 = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">constStr</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;select_index1 = 1 </span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[EXPERIMENTS] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit = YES  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_sigma = </span><span class="si">%.4f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">emfit_sigma</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_tolerance = </span><span class="si">%.6f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">emfit_tolerance</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_period = 1  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_VOLUMES</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_target = </span><span class="si">%s</span><span class="s2">.mrc </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputEMprefix</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">EMFIT_IMAGES</span> <span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_type = IMAGE </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_target = </span><span class="si">%s</span><span class="s2">.spi </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inputEMprefix</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_pixel_size =  </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">rigid_body_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRigidBodyParams</span><span class="p">(</span><span class="n">indexFit</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_roll_angle = </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rigid_body_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_tilt_angle = </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rigid_body_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_yaw_angle =  </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rigid_body_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_shift_x = </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rigid_body_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;emfit_shift_y =  </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rigid_body_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[REMD] </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#-----------------------------------------------------------</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;dimension = 1 </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;exchange_period = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;type1 = RESTRAINT </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;nreplica1 = </span><span class="si">%i</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;rest_function1 = 1 </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

    <span class="c1"># --------------------------- Create output step --------------------------------------------</span>

<div class="viewcode-block" id="ProtGenesis.createOutputStep"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.createOutputStep">[docs]</a>    <span class="k">def</span> <span class="nf">createOutputStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create output PDB or set of PDBs</span>
<span class="sd">        :return None:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convertReusOutputDcd</span><span class="p">()</span>

        <span class="c1"># Convert Output</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
            <span class="n">outputPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefixAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">outputPrefix</span><span class="p">:</span>
                <span class="c1"># Extract the pdb from the DCD file in case of SPDYN</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_program</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">PROGRAM_SPDYN</span><span class="p">:</span>
                    <span class="n">lastPDBFromDCD</span><span class="p">(</span>
                        <span class="n">inputDCD</span><span class="o">=</span><span class="n">j</span> <span class="o">+</span> <span class="s2">&quot;.dcd&quot;</span><span class="p">,</span>
                        <span class="n">outputPDB</span><span class="o">=</span><span class="n">j</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">,</span>
                        <span class="n">inputPDB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span> <span class="o">==</span> <span class="n">FORCEFIELD_CAGO</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">PDBMol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">PDBMol</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">coords</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">)</span>

        <span class="c1"># CREATE a output PDB</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SIMULATION_REMD</span>  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SIMULATION_RENMMD</span> <span class="p">)</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputPDB</span><span class="o">=</span><span class="n">AtomStruct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefix</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>

        <span class="c1"># CREATE SET OF output PDBs</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">pdbset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createSetOfPDBs</span><span class="p">(</span><span class="s2">&quot;outputPDBs&quot;</span><span class="p">)</span>
            <span class="c1"># Add each output PDB to the Set</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
                <span class="n">outputPrefix</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOutputPrefixAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">outputPrefix</span><span class="p">:</span>
                    <span class="n">pdbset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtomStruct</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defineOutputs</span><span class="p">(</span><span class="n">outputPDBs</span><span class="o">=</span><span class="n">pdbset</span><span class="p">)</span></div>

    <span class="c1"># --------------------------- INFO functions --------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Genesis in a software for Molecular Dynamics Simulation, &quot;</span>
                   <span class="s2">&quot;Normal Mode Molecular Dynamics (NMMD), Replica Exchange Umbrela &quot;</span>
                   <span class="s2">&quot;Sampling (REUS) and Energy Minimization&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">()[</span><span class="s2">&quot;PATH&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Plugin</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="s2">&quot;GENESIS_HOME&quot;</span><span class="p">),</span> <span class="s1">&#39;bin/atdyn&#39;</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing GENESIS program : atdyn &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">Plugin</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="s2">&quot;GENESIS_HOME&quot;</span><span class="p">),</span> <span class="s1">&#39;bin/spdyn&#39;</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing GENESIS program : spdyn &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;kobayashi2017genesis&quot;</span><span class="p">,</span><span class="s2">&quot;vuillemot2022NMMD&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># --------------------------- UTILS functions --------------------------------------------</span>

<div class="viewcode-block" id="ProtGenesis.getNumberOfInputPDB"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getNumberOfInputPDB">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberOfInputPDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of input PDBs</span>
<span class="sd">        :return int: number of input PDBs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">allOutPrx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
                <span class="n">allOutPrx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getOutputPrefixAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">allOutPrx</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfAtomStructs</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfPDBs</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ProtGenesis.getNumberOfInputEM"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getNumberOfInputEM">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberOfInputEM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of input EM data to analyze</span>
<span class="sd">        :return int : number of input EM data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_VOLUMES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolume</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfVolumes</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolume</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_IMAGES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputImage</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfParticles</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputImage</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="ProtGenesis.getNumberOfSimulation"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getNumberOfSimulation">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberOfSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of simulations to perform</span>
<span class="sd">        :return int: Number of simulations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numberOfInputPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputPDB</span><span class="p">()</span>
        <span class="n">numberOfInputEM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputEM</span><span class="p">()</span>

        <span class="c1"># Check input volumes/images correspond to input PDBs</span>
        <span class="k">if</span> <span class="n">numberOfInputPDB</span> <span class="o">!=</span> <span class="n">numberOfInputEM</span> <span class="ow">and</span> \
                <span class="n">numberOfInputEM</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">numberOfInputPDB</span> <span class="o">!=</span> <span class="mi">1</span> \
                <span class="ow">and</span> <span class="n">numberOfInputEM</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Number of input volumes and PDBs must be the same.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">numberOfInputEM</span><span class="p">,</span> <span class="n">numberOfInputPDB</span><span class="p">])</span></div>

<div class="viewcode-block" id="ProtGenesis.getInputPDBfn"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getInputPDBfn">[docs]</a>    <span class="k">def</span> <span class="nf">getInputPDBfn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the input PDB file names</span>
<span class="sd">        :return list : list of input PDB file names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initFn</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
                <span class="n">initFn</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getOutputPrefixAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">initFn</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="s2">&quot;.pdb&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">initFn</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfAtomStructs</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfPDBs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getSize</span><span class="p">()):</span>
                    <span class="n">initFn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">initFn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputPDB</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">initFn</span></div>

<div class="viewcode-block" id="ProtGenesis.getInputEMfn"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getInputEMfn">[docs]</a>    <span class="k">def</span> <span class="nf">getInputEMfn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the input EM data file names</span>
<span class="sd">        :return list: list of input EM data file names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputEMfn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_VOLUMES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolume</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfVolumes</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputVolume</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="n">inputEMfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inputEMfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputVolume</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">EMfitChoice</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">EMFIT_IMAGES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputImage</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">SetOfParticles</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputImage</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="n">inputEMfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inputEMfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputImage</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getFileName</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">inputEMfn</span></div>

<div class="viewcode-block" id="ProtGenesis.getInputPDBprefix"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getInputPDBprefix">[docs]</a>    <span class="k">def</span> <span class="nf">getInputPDBprefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the input PDB prefix of the specified index</span>
<span class="sd">        :param int index: index of input PDB</span>
<span class="sd">        :return str: Input PDB prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_inputPDB&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputPDB</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prefix</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prefix</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtGenesis.getInputEMprefix"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getInputEMprefix">[docs]</a>    <span class="k">def</span> <span class="nf">getInputEMprefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the input EM data prefix of the specified index</span>
<span class="sd">        :param int index: index of the EM data</span>
<span class="sd">        :return str: Input EM data prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_inputEM&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputEM</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfInputEM</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prefix</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prefix</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProtGenesis.getOutputPrefix"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getOutputPrefix">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputPrefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output prefix of the specified index</span>
<span class="sd">        :param int index: index of the simulation to get</span>
<span class="sd">        :return string : Output prefix of the specified index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span></div>

<div class="viewcode-block" id="ProtGenesis.getOutputPrefixAll"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getOutputPrefixAll">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputPrefixAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All output prefix of the specified index including multiple replicas in case of REUS</span>
<span class="sd">        :param int index: index of the simulation to get</span>
<span class="sd">        :return list: list of all output prefix of the specified index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputPrefix</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
                <span class="n">outputPrefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output_remd</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputPrefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">outputPrefix</span></div>

<div class="viewcode-block" id="ProtGenesis.getMPIParams"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getMPIParams">[docs]</a>    <span class="k">def</span> <span class="nf">getMPIParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get mpi parameters for the simulation</span>
<span class="sd">        :return tuple: numberOfMpiPerFit, numberOfLinearFit, numberOfParallelFit, numberOflastIter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_REMD</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationType</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">SIMULATION_RENMMD</span><span class="p">:</span>
            <span class="n">nreplica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nreplica</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Number of MPI cores should be larger than the number of replicas.&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">nreplica</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()</span> <span class="o">*</span> <span class="n">nreplica</span>

        <span class="k">if</span> <span class="n">n_fit</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">numberOfMpiPerFit</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()</span>
            <span class="n">numberOfLinearFit</span>   <span class="o">=</span> <span class="mi">1</span>
            <span class="n">numberOfParallelFit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()</span>
            <span class="n">numberOflastIter</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numberOfMpiPerFit</span>   <span class="o">=</span> <span class="n">nreplica</span>
            <span class="n">numberOfLinearFit</span>   <span class="o">=</span> <span class="n">n_fit</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">numberOfParallelFit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">//</span><span class="n">nreplica</span>
            <span class="n">numberOflastIter</span>    <span class="o">=</span> <span class="n">n_fit</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfMpi</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">numberOfMpiPerFit</span><span class="p">,</span> <span class="n">numberOfLinearFit</span><span class="p">,</span> <span class="n">numberOfParallelFit</span><span class="p">,</span> <span class="n">numberOflastIter</span></div>

<div class="viewcode-block" id="ProtGenesis.getRigidBodyParams"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getRigidBodyParams">[docs]</a>    <span class="k">def</span> <span class="nf">getRigidBodyParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current rigid body parameters for the specified index in case of EMFIT with iamges</span>
<span class="sd">        :param int index: Index of the simulation</span>
<span class="sd">        :return list: angle_rot, angle_tilt, angle_psi, shift_x, shift_y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimateAngleShift</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">mdImg</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageAngleShift</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdImg</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_current_angles.xmd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
            <span class="n">idx</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">mdImg</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_ROT</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
            <span class="n">mdImg</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_TILT</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
            <span class="n">mdImg</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_ANGLE_PSI</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
            <span class="n">mdImg</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_SHIFT_X</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
            <span class="n">mdImg</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">MDL_SHIFT_Y</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="ProtGenesis.getGenesisEnv"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getGenesisEnv">[docs]</a>    <span class="k">def</span> <span class="nf">getGenesisEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get environnement for running GENESIS</span>
<span class="sd">        :return Environ: environnement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">Environ</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">environ</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Plugin</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="s2">&quot;GENESIS_HOME&quot;</span><span class="p">),</span> <span class="s1">&#39;bin&#39;</span><span class="p">),</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Environ</span><span class="o">.</span><span class="n">BEGIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">environ</span></div>

<div class="viewcode-block" id="ProtGenesis.getGenesisCmd"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getGenesisCmd">[docs]</a>    <span class="k">def</span> <span class="nf">getGenesisCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get GENESIS cmd to run</span>
<span class="sd">        :param str prefix: prefix of the simulation</span>
<span class="sd">        :return str : GENESIS commadn to run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_program</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">PROGRAM_ATDYN</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span>  <span class="s2">&quot;atdyn </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_INP&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;spdyn </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_INP&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;  &gt; </span><span class="si">%s</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

<div class="viewcode-block" id="ProtGenesis.getRestartFile"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getRestartFile">[docs]</a>    <span class="k">def</span> <span class="nf">getRestartFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get input restart file</span>
<span class="sd">        :param int index: Index of the simulation</span>
<span class="sd">        :return str: restart file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allOutPrx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
            <span class="n">allOutPrx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getOutputPrefixAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">allOut</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;.rst&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allOutPrx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">allOut</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>

<div class="viewcode-block" id="ProtGenesis.getForceField"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.getForceField">[docs]</a>    <span class="k">def</span> <span class="nf">getForceField</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get simulation forcefield</span>
<span class="sd">        :return int: forcefield</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartChoice</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restartProt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">getForceField</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtGenesis.convertReusOutputDcd"><a class="viewcode-back" href="../../../api/continuousflex/continuousflex.protocols.protocol_genesis.html#continuousflex.protocols.protocol_genesis.ProtGenesis.convertReusOutputDcd">[docs]</a>    <span class="k">def</span> <span class="nf">convertReusOutputDcd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumberOfSimulation</span><span class="p">()):</span>
            <span class="n">remdPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output_remd&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">tmpPrefix</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output_tmp&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">inp_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;tmp_INP&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[INPUT]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;reffile = </span><span class="si">%s</span><span class="s2">.pdb # PDB file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInputPDBprefix</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;remfile = </span><span class="si">%s{}</span><span class="s2">.rem  # REMD parameter ID file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">remdPrefix</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dcdfile = </span><span class="si">%s{}</span><span class="s2">.dcd  # DCD file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">remdPrefix</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;logfile = </span><span class="si">%s{}</span><span class="s2">.log  # REMD energy log file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">remdPrefix</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[OUTPUT]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;trjfile = </span><span class="si">%s{}</span><span class="s2">.dcd  # coordinates sorted by temperature</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">tmpPrefix</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;logfile = </span><span class="si">%s{}</span><span class="s2">.log  # energy log sorted by temperature</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">tmpPrefix</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SELECTION]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;group1 = all  # selection group 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FITTING]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fitting_method = NO  # [NO,TR,TR+ROT,TR+ZROT,XYTR,XYTR+ZROT]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mass_weight = NO  # mass-weight is not applied</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[OPTION]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;check_only = NO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;convert_type = PARAMETER  # (REPLICA/PARAMETER)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;num_replicas = </span><span class="si">%i</span><span class="s2">  # total number of replicas used in the simulation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;convert_ids =  # selected index (empty = all)(example: 1 2 5-10)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nsteps = </span><span class="si">%i</span><span class="s2">  # nsteps in [DYNAMICS]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_steps</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;exchange_period = </span><span class="si">%i</span><span class="s2">  # exchange_period in [REMD]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_period</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;crdout_period = </span><span class="si">%i</span><span class="s2">  # crdout_period in [DYNAMICS]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eneout_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;eneout_period = </span><span class="si">%i</span><span class="s2">  # eneout_period in [DYNAMICS]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdout_period</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;trjout_format = DCD  # (PDB/DCD)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;trjout_type = COOR+BOX  # (COOR/COOR+BOX)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;trjout_atom = 1  # atom group</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;centering = NO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pbc_correct = NO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;remd_convert </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">inp_file</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGenesisEnv</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nreplica</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
                <span class="n">repPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output_remd</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">reptmpPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExtraPath</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_output_tmp</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">%s</span><span class="s2">.dcd </span><span class="si">%s</span><span class="s2">.dcd&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reptmpPrefix</span><span class="p">,</span><span class="n">repPrefix</span><span class="p">))</span>
                <span class="n">runCommand</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">%s</span><span class="s2">.log </span><span class="si">%s</span><span class="s2">.log&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reptmpPrefix</span><span class="p">,</span><span class="n">repPrefix</span><span class="p">))</span></div></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: rm_model_building
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../../release-3.0.0/index.html">release-3.0.0</a></dd>
            <dd><a href="protocol_genesis.html">rm_model_building</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>