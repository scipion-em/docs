

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating a plugin &mdash; Scipion 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
        <script type="text/javascript" src="../../static/jquery.js"></script>
        <script type="text/javascript" src="../../static/underscore.js"></script>
        <script type="text/javascript" src="../../static/doctools.js"></script>
        <script type="text/javascript" src="../../static/language_data.js"></script>
    
    <script type="text/javascript" src="../../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Creating a protocol" href="creating-a-protocol.html" />
    <link rel="prev" title="Architecture" href="architecture.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/install-from-sources.html">Installing from sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipion-modes/host-configuration.html">Host configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#graphical-interface-manuals">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="developers.html">General Information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developers.html#extending-scipion">Extending Scipion</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Creating a plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#naming-conventions">Naming Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plugin-overview">Plugin Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#file-tree">File tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#standard-submodules">Standard submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pypi-related-files">PyPI-related files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-as-python-module">Testing as python module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-the-plugin-to-pypi">Publishing the Plugin to PyPI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#add-pypi-files">Add PyPI files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-via-pip-locally">Installing via pip locally</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-as-pip-package">Testing as pip package</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-and-upload-distribution">Create and upload distribution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-from-pip">Install from pip</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="creating-a-protocol.html">Creating a protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-scipion-docs.html">Building Scipion docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="creating-a-monitor.html">Creating a monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-customize-the-html-report">TODO: Customize the HTML report</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-developing-output-viewers">TODO - Developing output Viewers</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-integrating-parameter-wizards">TODO - Integrating parameter Wizards</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#todo-writing-tests-tests-and-more-tests">TODO - Writing Tests, Tests, and more Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developers.html#development-tools">Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html#advanced-development-topics">Advanced Development Topics</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyworkflow.html">pyworkflow package</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developers.html">General Information</a> &raquo;</li>
        
      <li>Creating a plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../sources/docs/developer/creating-a-plugin.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-a-plugin">
<span id="id1"></span><h1>Creating a plugin<a class="headerlink" href="#creating-a-plugin" title="Permalink to this headline">¶</a></h1>
<p>A <strong>Plugin</strong> for Scipion is a Python module that meets some extra requirements.
Each Plugin contains classes for  protocols, viewers, wizards, etc…allowing to use the functionality of a given EM
package within the Scipion framework. Prior to version 2.0.0 Diocletian, the plugins’ code was not completely isolated,
it was under the <code class="docutils literal notranslate"><span class="pre">scipion/pyworkflow/em/packages</span></code> folder and hosted in the same central repository.</p>
<p>For release 2.0.0 (“the pluginized version”), we worked hard to make the entire system more de-centralized
and more standard. For that we re-factored the plugins to make them standard Python modules so that their
code can be hosted in independent repositories and therefore, updated in different release cycles.</p>
<p>This document is organized in two main parts:</p>
<ol class="arabic simple">
<li>Explanation of the structure of a plugin as a Python module and the required submodules and functionality for Scipion.</li>
<li>Necessary files structure and the process for distributing a Plugin in the Python de-facto repository PyPI.</li>
</ol>
<p>We will use Relion as an example, so we recommend to clone and take a look at
<a class="reference external" href="https://github.com/scipion-em/scipion-em-relion">Relion’s repository</a>.</p>
<div class="section" id="naming-conventions">
<h2>Naming Conventions<a class="headerlink" href="#naming-conventions" title="Permalink to this headline">¶</a></h2>
<p>Similar to style guides, conventions are about consistency. Consistency is crucial for a project such as
Scipion and its distributed nature. Despite the final decision is up to the developer of a package, we STRONGLY
recommend the following conventions:</p>
<ul class="simple">
<li>Repository name: <strong>scipion-em-packagename</strong></li>
<li>Python package name: <strong>scipion-em-packagename</strong></li>
<li>Python module with package code: <strong>packagename</strong></li>
</ul>
<p>This means that it will be a folder named <strong>scipion-em-package</strong> with the structure of a standard Python package
(explained below in the second part) and it will contain a folder <strong>package</strong> that is a Python module
with functions and classes required by Scipion (explained below).</p>
</div>
<div class="section" id="plugin-overview">
<h2>Plugin Overview<a class="headerlink" href="#plugin-overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="file-tree">
<h3>File tree<a class="headerlink" href="#file-tree" title="Permalink to this headline">¶</a></h3>
<p>The file and folder structure follows the convention established for Python modules.
For example, the Relion plugin has the following structure:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/work/development/scipion-em-plugins/scipion-em-relion
$ tree
.
├── LICENSE
├── .gitignore
├── CHANGES.txt
├── README.rst
├── MANIFEST.in
├── setup.py
└── relion
    ├── __init__.py
    ├── bibtex.py
    ├── constants.py
    ├── convert
    │   ├── __init__.py
    │   ├── convert.py
    │   └── dataimport.py
    ├── protocols
    │   ├── __init__.py
    │   ├── protocol_autopick.py
    │   ├── protocol_autopick_v2.py
    │   ├── protocol_base.py
    │   ├── protocol_center_averages.py
    │   ├── protocol_classify2d.py
    │   ├── protocol_classify3d.py
    │   ├── protocol_create_mask3d.py
    │   ├── ...
    ├── tests
    │   ├── __init__.py
    │   ├── test_convert_relion.py
    │   ├── test_protocols_relion.py
    │   └── test_workflow_relion.py
    ├── viewers.py
    ├── wizards.py
    └── protocols.conf
</pre></div>
</div>
</div>
<div class="section" id="standard-submodules">
<span id="id2"></span><h3>Standard submodules<a class="headerlink" href="#standard-submodules" title="Permalink to this headline">¶</a></h3>
<p>Scipion plugins are usually composed by the following submodules:</p>
<div class="section" id="init-py">
<h4>__init__.py<a class="headerlink" href="#init-py" title="Permalink to this headline">¶</a></h4>
<p>This file is required in Python modules and it is executed when the module is imported. It is common to add here imports
related with Scipion’s pyworkflow, and to import values from the <code class="docutils literal notranslate"><span class="pre">constants.py</span></code> file. We also define the logo and
plugin-level references:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pyworkflow.em</span>
<span class="kn">import</span> <span class="nn">pyworkflow.utils</span> <span class="kn">as</span> <span class="nn">pwutils</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">RELION_HOME</span><span class="p">,</span> <span class="n">V2_0</span><span class="p">,</span> <span class="n">V2_1</span><span class="p">,</span> <span class="n">RELION_CUDA_LIB</span>

<span class="n">_logo</span> <span class="o">=</span> <span class="s2">&quot;relion_logo.png&quot;</span>
<span class="n">_references</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Scheres2012a&#39;</span><span class="p">,</span> <span class="s1">&#39;Scheres2012b&#39;</span><span class="p">,</span> <span class="s1">&#39;Kimanius2016&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="define-the-plugin-class">
<h5>Define the Plugin class<a class="headerlink" href="#define-the-plugin-class" title="Permalink to this headline">¶</a></h5>
<p>Additionally, it is necessary to add a Plugin class (subclass from <a class="reference internal" href="../../api/pyworkflow.plugin.html#pyworkflow.plugin.Plugin" title="pyworkflow.plugin.Plugin"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyworkflow.plugin.Plugin</span></code></a>), which contains much of the
logic related with the plugin’s variables, environment, associated binaries and paths.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">pyworkflow</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="n">_homeVar</span> <span class="o">=</span> <span class="n">RELION_HOME</span>
    <span class="n">_supportedVersions</span> <span class="o">=</span> <span class="p">[</span><span class="n">V2_0</span><span class="p">,</span> <span class="n">V2_1</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="homevar">
<h6>_homeVar<a class="headerlink" href="#homevar" title="Permalink to this headline">¶</a></h6>
<p>In the case of scipion-em-relion, the plugin is associated to some binaries. In <code class="docutils literal notranslate"><span class="pre">_homeVar</span></code>, we point to the variable that
has the path to the binaries. It is a good practice to define this in <code class="docutils literal notranslate"><span class="pre">constants.py</span></code>, as it is done here.
As we will see later, this has a default value, but it can also be overwritten by the user.</p>
</div>
<div class="section" id="supportedversions">
<h6>_supportedVersions<a class="headerlink" href="#supportedversions" title="Permalink to this headline">¶</a></h6>
<p>Here we store which versions of the binaries are supported by this plugin.</p>
</div>
<div class="section" id="definevariables">
<h6>_defineVariables<a class="headerlink" href="#definevariables" title="Permalink to this headline">¶</a></h6>
<p>Here is where we give the Plugin’s environment variables a default value. In the case of Relion, we only have the
<code class="docutils literal notranslate"><span class="pre">RELION_HOME</span></code>, which points to the binaries of the plugin and by default would be <code class="docutils literal notranslate"><span class="pre">relion-2.1</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">_defineVariables</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_defineEmVar</span><span class="p">(</span><span class="n">RELION_HOME</span><span class="p">,</span> <span class="s1">&#39;relion-2.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>There are two functions defined in the <a class="reference internal" href="../../api/pyworkflow.plugin.html"><span class="doc">plugin class</span></a> that may be useful here:
<code class="docutils literal notranslate"><span class="pre">_defineEmVar</span></code> and <code class="docutils literal notranslate"><span class="pre">_defineVar</span></code>. The first one will add the path to <code class="docutils literal notranslate"><span class="pre">software/em</span></code> to the variable
(which is the default place to install binaries). The second will store the value as is.
We only need <code class="docutils literal notranslate"><span class="pre">defineEmVar</span></code> in Relion, since the binary location is the only variable we’ll declare.</p>
</div>
<div class="section" id="getenviron">
<h6>getEnviron<a class="headerlink" href="#getenviron" title="Permalink to this headline">¶</a></h6>
<p>We can also overwrite the function <code class="docutils literal notranslate"><span class="pre">getEnviron</span></code> if there are any modifications we need to do in the environment
variables in order to run the plugin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">getEnviron</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Setup the environment variables needed to launch Relion. &quot;&quot;&quot;</span>

    <span class="n">environ</span> <span class="o">=</span> <span class="n">pwutils</span><span class="o">.</span><span class="n">Environ</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">binPath</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getHome</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>
    <span class="n">libPath</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getHome</span><span class="p">(</span><span class="s1">&#39;lib&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getHome</span><span class="p">(</span><span class="s1">&#39;lib64&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binPath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]:</span>
        <span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">binPath</span><span class="p">,</span>
                        <span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">:</span> <span class="n">libPath</span><span class="p">,</span>
                        <span class="s1">&#39;SCIPION_MPI_FLAGS&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RELION_MPI_FLAGS&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="p">},</span> <span class="n">position</span><span class="o">=</span><span class="n">pwutils</span><span class="o">.</span><span class="n">Environ</span><span class="o">.</span><span class="n">BEGIN</span><span class="p">)</span>

    <span class="c1"># Take Scipion CUDA library path</span>
    <span class="n">cudaLib</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">getFirst</span><span class="p">((</span><span class="n">RELION_CUDA_LIB</span><span class="p">,</span> <span class="s1">&#39;CUDA_LIB&#39;</span><span class="p">))</span>
    <span class="n">environ</span><span class="o">.</span><span class="n">addLibrary</span><span class="p">(</span><span class="n">cudaLib</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">environ</span>
</pre></div>
</div>
</div>
<div class="section" id="implement-validateinstallation-optional">
<h6>Implement validateInstallation() (Optional)<a class="headerlink" href="#implement-validateinstallation-optional" title="Permalink to this headline">¶</a></h6>
<p>In the plugin class, we can overwrite the validateInstallation function. In the case of Relion this is not overwritten,
so this plugin will use Scipion’s default validate installation. You can check the current implementation in
<code class="docutils literal notranslate"><span class="pre">pyworkflow/plugin.py</span></code>.</p>
</div>
<div class="section" id="defining-the-plugin-binaries-optional">
<h6>Defining the plugin binaries (Optional)<a class="headerlink" href="#defining-the-plugin-binaries-optional" title="Permalink to this headline">¶</a></h6>
<p>The next step is to add the code responsible for the installation of the binaries.
We redefine <code class="docutils literal notranslate"><span class="pre">defineBinaries</span></code> in our <code class="docutils literal notranslate"><span class="pre">RelionPlugin</span></code> class in the <strong>`__init__.py`</strong>.
Please note how we have added <code class="docutils literal notranslate"><span class="pre">default=True</span></code> to the latest relion binaries. - this means that
this binary will be installed automatically when we get this plugin (unless specified otherwise).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># this goes inside class RelionPlugin(Plugin):</span>
<span class="k">def</span> <span class="nf">defineBinaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">relion_commands</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;./INSTALL.sh -j </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">getProcessors</span><span class="p">(),</span>
                              <span class="p">[</span><span class="s1">&#39;relion_build.log&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;bin/relion_refine&#39;</span><span class="p">])]</span>

    <span class="n">env</span><span class="o">.</span><span class="n">addPackage</span><span class="p">(</span><span class="s1">&#39;relion&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.4&#39;</span><span class="p">,</span>
                   <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;relion-1.4.tgz&#39;</span><span class="p">,</span>
                   <span class="n">commands</span><span class="o">=</span><span class="n">relion_commands</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">addPackage</span><span class="p">(</span><span class="s1">&#39;relion&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.4f&#39;</span><span class="p">,</span>
                   <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;relion-1.4_float.tgz&#39;</span><span class="p">,</span>
                   <span class="n">commands</span><span class="o">=</span><span class="n">relion_commands</span><span class="p">)</span>

    <span class="c1"># Define FFTW3 path variables</span>
    <span class="n">relion_vars</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;FFTW_LIB&#39;</span><span class="p">,</span> <span class="n">SW_LIB</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;FFTW_INCLUDE&#39;</span><span class="p">,</span> <span class="n">SW_INC</span><span class="p">)]</span>

    <span class="n">relion2_commands</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;cmake -DGUI=OFF -DCMAKE_INSTALL_PREFIX=./ .&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="p">(</span><span class="s1">&#39;make -j </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">getProcessors</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;bin/relion_refine&#39;</span><span class="p">])]</span>

    <span class="n">env</span><span class="o">.</span><span class="n">addPackage</span><span class="p">(</span><span class="s1">&#39;relion&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
                   <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;relion-2.0.4.tgz&#39;</span><span class="p">,</span>
                   <span class="n">commands</span><span class="o">=</span><span class="n">relion2_commands</span><span class="p">,</span>
                   <span class="n">updateCuda</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="nb">vars</span><span class="o">=</span><span class="n">relion_vars</span><span class="p">)</span>

    <span class="n">env</span><span class="o">.</span><span class="n">addPackage</span><span class="p">(</span><span class="s1">&#39;relion&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;2.1&#39;</span><span class="p">,</span>
                  <span class="n">tar</span><span class="o">=</span><span class="s1">&#39;relion-2.1.tgz&#39;</span><span class="p">,</span>
                  <span class="n">commands</span><span class="o">=</span><span class="n">relion2_commands</span><span class="p">,</span>
                  <span class="n">updateCuda</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="nb">vars</span><span class="o">=</span><span class="n">relion_vars</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="register-plugin">
<h5>Register plugin<a class="headerlink" href="#register-plugin" title="Permalink to this headline">¶</a></h5>
<p>To finish, we must register the plugin with the following line. This is very important so that Scipion distinguishes
this from other python modules as a plugin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pyworkflow</span><span class="o">.</span><span class="n">em</span><span class="o">.</span><span class="n">Domain</span><span class="o">.</span><span class="n">registerPlugin</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="bibtex-py">
<h4>bibtex.py<a class="headerlink" href="#bibtex-py" title="Permalink to this headline">¶</a></h4>
<p>This submodule is not supposed to be imported directly, it should contain the bibtex string
literal as the Python doc string. Scipion will take care of parse the bibtex reference and
incorporate into the plugin module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@article{Scheres2012a,</span>
<span class="s2">title = &quot;A Bayesian View on Cryo-EM Structure Determination &quot;,</span>
<span class="s2">journal = &quot;JMB&quot;,</span>
<span class="s2">volume = &quot;415&quot;,</span>
<span class="s2">number = &quot;2&quot;,</span>
<span class="s2">pages = &quot;406 - 418&quot;,</span>
<span class="s2">year = &quot;2012&quot;,</span>
<span class="s2">issn = &quot;0022-2836&quot;,</span>
<span class="s2">doi = &quot;http://dx.doi.org/10.1016/j.jmb.2011.11.010&quot;,</span>
<span class="s2">url = &quot;http://www.sciencedirect.com/science/article/pii/S0022283611012290&quot;,</span>
<span class="s2">author = &quot;Scheres, Sjors H.W.&quot;,</span>
<span class="s2">keywords = &quot;cryo-electron microscopy, three-dimensional reconstruction, maximum a posteriori estimation &quot;</span>
<span class="s2">}</span>

<span class="s2">@article{Scheres2012b,</span>
<span class="s2">title = &quot;RELION: Implementation of a Bayesian approach to cryo-EM structure determination &quot;,</span>
<span class="s2">journal = &quot;JSB&quot;,</span>
<span class="s2">volume = &quot;180&quot;,</span>
<span class="s2">number = &quot;3&quot;,</span>
<span class="s2">pages = &quot;519 - 530&quot;,</span>
<span class="s2">year = &quot;2012&quot;,</span>
<span class="s2">issn = &quot;1047-8477&quot;,</span>
<span class="s2">doi = &quot;http://dx.doi.org/10.1016/j.jsb.2012.09.006&quot;,</span>
<span class="s2">url = &quot;http://www.sciencedirect.com/science/article/pii/S1047847712002481&quot;,</span>
<span class="s2">author = &quot;Scheres, Sjors H.W.&quot;,</span>
<span class="s2">keywords = &quot;Electron microscopy, Single-particle analysis, Maximum likelihood, Image processing, Software development &quot;</span>
<span class="s2">}</span>
<span class="s2">[. . .]</span>
</pre></div>
</div>
</div>
<div class="section" id="constants-py">
<h4>constants.py<a class="headerlink" href="#constants-py" title="Permalink to this headline">¶</a></h4>
<p>This submodule should contain all the constants that can be later imported in protocols etc. If there are only few of them, there is no need for a separate constants.py file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">pyworkflow.em.metadata</span> <span class="kn">as</span> <span class="nn">md</span>

<span class="n">RELION_HOME</span> <span class="o">=</span> <span class="s1">&#39;RELION_HOME&#39;</span>
<span class="n">RELION_CUDA_LIB</span> <span class="o">=</span> <span class="s1">&#39;RELION_CUDA_LIB&#39;</span>

<span class="c1"># Supported versions:</span>
<span class="n">V2_0</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>
<span class="n">V2_1</span> <span class="o">=</span> <span class="s1">&#39;2.1&#39;</span>

<span class="n">MASK_FILL_ZERO</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MASK_FILL_NOISE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">[</span><span class="o">.</span> <span class="o">.</span> <span class="o">.</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="convert">
<h4>Convert<a class="headerlink" href="#convert" title="Permalink to this headline">¶</a></h4>
<p>This submodule might contain two files: <code class="docutils literal notranslate"><span class="pre">convert.py</span></code> with all functions used for conversion between
base classes and programs inside the plugin; <code class="docutils literal notranslate"><span class="pre">dataimport.py</span></code> with import classes that are used in
<code class="docutils literal notranslate"><span class="pre">pyworkflow/em/protocol/protocol_import/</span></code>. In cases when there are only few conversion functions, the
submodule folder can be replaced by a single <code class="docutils literal notranslate"><span class="pre">convert.py</span></code> file.</p>
</div>
<div class="section" id="protocols">
<h4>Protocols<a class="headerlink" href="#protocols" title="Permalink to this headline">¶</a></h4>
<p>In this submodule all the protocols of the plugin should be implemented.
Usually a plugin provides many protocols, so the most common case is to have a
submodule folder with its own <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and one .py file per each protocol class.
You can read more detailed information on the <a class="reference internal" href="creating-a-protocol.html"><span class="doc">implementation of
protocol</span></a>.</p>
</div>
<div class="section" id="viewers">
<h4>Viewers<a class="headerlink" href="#viewers" title="Permalink to this headline">¶</a></h4>
<p>A plugin can also define viewers for existing objects or new protocols.
Since many built-in viewers are provided by Scipion, plugins do not define many viewers,
so a <code class="docutils literal notranslate"><span class="pre">viewers.py</span></code> will serve as submodule.</p>
</div>
<div class="section" id="wizards">
<h4>Wizards<a class="headerlink" href="#wizards" title="Permalink to this headline">¶</a></h4>
<p>Wizards need to be defined for protocols/parameters, but many base classes are already provided.
Here again the <code class="docutils literal notranslate"><span class="pre">wizards.py</span></code> submodule is usually enough.</p>
</div>
<div class="section" id="tests">
<h4>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h4>
<p>We strongly recommend to follow Test-Driven-Development, so this is the place where all plugin tests should go.
It is important to create different test cases from the beginning of the plugin development.</p>
</div>
<div class="section" id="protocols-conf">
<span id="id3"></span><h4>protocols.conf<a class="headerlink" href="#protocols-conf" title="Permalink to this headline">¶</a></h4>
<p>This submodule contains the location of all protocols in the Scipion Protocols Tree View.
This file is optional in Python modules and it is loaded when the module is imported if it exists.
If the file does not exist, the protocols will be loaded in the All view. Scipion will take care of
parsing the file and incorporating its contents into Scipion’s Tree View. For example, the Relion <code class="docutils literal notranslate"><span class="pre">protocol.conf</span></code> has
the following structure:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span>    <span class="k">[PROTOCOLS]</span>
<span class="na">Protocols SPA</span> <span class="o">=</span> <span class="s">[</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;Imports&quot;, &quot;icon&quot;: &quot;bookmark.png&quot;, &quot;children&quot;: []},</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;Movies&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []},</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;Micrographs&quot;, &quot;children&quot;: [</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;CTF estimation&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionExportCtf&quot;, &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]}</span>
<span class="s">    ]},</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;Particles&quot;, &quot;children&quot;: [</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Picking&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelion2Autopick&quot;,   &quot;text&quot;: &quot;default&quot;},</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionAutopickLoG&quot;,   &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Extract&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionExtractParticles&quot;,   &quot;text&quot;: &quot;default&quot;},</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionExportParticles&quot;, &quot;text&quot;: &quot;default&quot;},</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionSortParticles&quot;, &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Preprocess&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionPreprocessParticles&quot;,  &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Filter&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Mask&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []}</span>
<span class="s">    ]},</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;2D&quot;, &quot;children&quot;: [</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Align&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Classify&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionClassify2D&quot;,   &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]}</span>
<span class="s">    ]},</span>
<span class="s">    {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;3D&quot;, &quot;children&quot;: [</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Initial volume&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionInitialModel&quot;,  &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Preprocess&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Classify&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionClassify3D&quot;,   &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Refine&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionRefine3D&quot;,   &quot;text&quot;: &quot;default&quot;},</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionCtfRefinement&quot;,   &quot;text&quot;: &quot;default&quot;},</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionPolish&quot;, &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]},</span>
<span class="s">        {&quot;tag&quot;: &quot;section&quot;, &quot;text&quot;: &quot;Resolution&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: []},</span>
<span class="s">        {&quot;tag&quot;: &quot;protocol_group&quot;, &quot;text&quot;: &quot;Reconstruct&quot;, &quot;openItem&quot;: &quot;False&quot;, &quot;children&quot;: [</span>
<span class="s">            {&quot;tag&quot;: &quot;protocol&quot;, &quot;value&quot;: &quot;ProtRelionReconstruct&quot;,   &quot;text&quot;: &quot;default&quot;}</span>
<span class="s">        ]}</span>
<span class="s">    ]}]</span>
</pre></div>
</div>
</div>
<div class="section" id="logo-png">
<h4>logo.png<a class="headerlink" href="#logo-png" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="gitignore">
<h4>.gitignore<a class="headerlink" href="#gitignore" title="Permalink to this headline">¶</a></h4>
<p>This file is required for Git. Here is an example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#### Eclipse and so on
.project
.cproject
.pydevproject
.classpath
.idea

#### Python
build/
dist/
*.egg-info/
*.egg
*.py[cod]
__pycache__/
*.so
*~
</pre></div>
</div>
</div>
</div>
<div class="section" id="pypi-related-files">
<h3>PyPI-related files<a class="headerlink" href="#pypi-related-files" title="Permalink to this headline">¶</a></h3>
<p>These files are required for PyPI distribution. More information about this can be found on the
<a class="reference external" href="https://packaging.python.org/tutorials/packaging-projects/#setup-cfg">pip packaging guide</a> .</p>
<ul class="simple">
<li><strong>LICENSE</strong>: license file for plugin code</li>
<li><strong>CHANGES.txt</strong>: version history</li>
<li><strong>README.rst</strong>: long description of your plugin (for PyPI catalog)</li>
<li><strong>MANIFEST.in</strong>: includes links to <code class="docutils literal notranslate"><span class="pre">README</span></code> and <code class="docutils literal notranslate"><span class="pre">LICENSE</span></code> files</li>
<li><strong>setup.py</strong>: this is a build script for PyPI distribution, containing important information about your plugin.</li>
</ul>
<p>Read the <a class="reference internal" href="#publishing-to-pypi"><span class="std std-ref">Publishing the plugin to PyPI</span></a> section below for more details on these files.</p>
</div>
</div>
<div class="section" id="testing-as-python-module">
<h2>Testing as python module<a class="headerlink" href="#testing-as-python-module" title="Permalink to this headline">¶</a></h2>
<p>Once you think your <a class="reference internal" href="#standard-submodules"><span class="std std-ref">standard submodules</span></a> have some basic functionality, you’re ready to test
how your code behaves within Scipion. For example, you may want to run some of your unit tests before you convert
your plugin into a pip package.</p>
<ul class="simple">
<li>In your terminal, add the plugin directory to <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>. This will make our plugin available as a python module
when we launch Scipion. While we develop and change our code, every time we launch Scipion we will have
our changes available.</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>/path/to/scipion-em-relion
</pre></div>
</div>
<ul class="simple">
<li>Check if all submodules are imported correctly</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion run python scripts/inspect_plugins.py relion
</pre></div>
</div>
<ul class="simple">
<li>List your tests and copy the one you want to run:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion <span class="nb">test</span> --show --grep relion
</pre></div>
</div>
</div>
<div class="section" id="publishing-the-plugin-to-pypi">
<span id="publishing-to-pypi"></span><h2>Publishing the Plugin to PyPI<a class="headerlink" href="#publishing-the-plugin-to-pypi" title="Permalink to this headline">¶</a></h2>
<p>We’ll explain below the steps followed to convert the package into a pip module that we can
upload to pypi. Most of these steps are not scipion-specific, so it is recommended to check an external source if you
have doubts about pip packaging (like <a class="reference external" href="https://python-packaging.readthedocs.io/en/latest/index.html">https://python-packaging.readthedocs.io/en/latest/index.html</a> or
<a class="reference external" href="https://packaging.python.org/tutorials/distributing-packages">https://packaging.python.org/tutorials/distributing-packages</a> ).</p>
<div class="section" id="add-pypi-files">
<h3>Add PyPI files<a class="headerlink" href="#add-pypi-files" title="Permalink to this headline">¶</a></h3>
<p>First we’ll add four files to the folder <code class="docutils literal notranslate"><span class="pre">scipion-em-relion</span></code>: <code class="docutils literal notranslate"><span class="pre">CHANGES.txt</span></code>, <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, <code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code>,
<code class="docutils literal notranslate"><span class="pre">README.rst</span></code>.</p>
<div class="section" id="setup-py">
<h4>setup.py<a class="headerlink" href="#setup-py" title="Permalink to this headline">¶</a></h4>
<p>This is the most important one. It needs to call the setup function with, at least, the required arguments.
Here we present a synthesized version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="n">here</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="c1"># Get the long description from the README file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="s1">&#39;README.rst&#39;</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">long_description</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;scipion-em-relion&#39;</span><span class="p">,</span>  <span class="c1"># Required</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0.0a&#39;</span><span class="p">,</span>  <span class="c1"># Required</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A python wrapper to use relion within Scipion&#39;</span><span class="p">,</span>  <span class="c1"># Required</span>
    <span class="n">long_description</span><span class="o">=</span><span class="n">long_description</span><span class="p">,</span>  <span class="c1"># Optional</span>
    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://github.com/scipion-em/scipion-em-relion&#39;</span><span class="p">,</span>  <span class="c1"># Optional, but very important</span>
    <span class="n">author</span><span class="o">=</span><span class="s1">&#39;Relion authors&#39;</span><span class="p">,</span>  <span class="c1"># Optional</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s1">&#39;some@human.com&#39;</span><span class="p">,</span>  <span class="c1"># Optional</span>
    <span class="n">keywords</span><span class="o">=</span><span class="s1">&#39;scipion cryoem imageprocessing scipion-1.2&#39;</span><span class="p">,</span>  <span class="c1"># Optional</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(),</span>
    <span class="n">package_data</span><span class="o">=</span><span class="p">{</span>  <span class="c1">#!!!!!! Required if we have a logo!!!!!</span>
       <span class="s1">&#39;relion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;logo.png&#39;</span><span class="p">],</span>
    <span class="p">}</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="changes-txt-optional">
<h4>CHANGES.txt (optional)<a class="headerlink" href="#changes-txt-optional" title="Permalink to this headline">¶</a></h4>
<p>This file records a short description of the modifications made with each release of the pip package.
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span><span class="o">.</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">23</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">2018</span> <span class="o">--</span> <span class="n">First</span> <span class="n">commit</span>
</pre></div>
</div>
</div>
<div class="section" id="manifest-in-optional">
<h4>MANIFEST.in (optional)<a class="headerlink" href="#manifest-in-optional" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> is needed so that our <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file is included when we do the distribution
(or many other non <code class="docutils literal notranslate"><span class="pre">*.py</span></code> extensions, please check these
<a class="reference external" href="https://python-packaging.readthedocs.io/en/latest/non-code-files.html">docs on non-code-files</a>
if you need to include such files).</p>
<p><strong>IMPORTANT</strong>: if you have non-python files like images (except the logo), docs, scripts, you have to specify them here,
otherwise they will be excluded from PyPi distribution! An example below recursively includes all files in
spider/scripts folder.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>include *.txt
recursive-include spider/scripts *
</pre></div>
</div>
<p>Also, you will need to add/uncomment the following line into <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:
<code class="docutils literal notranslate"><span class="pre">include_package_data=True</span></code></p>
</div>
</div>
<div class="section" id="installing-via-pip-locally">
<h3>Installing via pip locally<a class="headerlink" href="#installing-via-pip-locally" title="Permalink to this headline">¶</a></h3>
<div class="section" id="remove-previous-installation-from-scipion">
<h4>Remove previous installation from Scipion<a class="headerlink" href="#remove-previous-installation-from-scipion" title="Permalink to this headline">¶</a></h4>
<p>Remove binaries - if it applies. If you didn’t have a prior binary installation (i.e. you’re building this plugin new
from scratch), go to next step.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm -rf <span class="nv">$SCIPION_HOME</span>/software/em/relion*
</pre></div>
</div>
</div>
<div class="section" id="working-in-devel-mode">
<span id="devel-mode"></span><h4>Working in devel mode<a class="headerlink" href="#working-in-devel-mode" title="Permalink to this headline">¶</a></h4>
<p>If you want to use the sources of a plugin in a “live” way (meaning that changes in the plugin code will be reflected),
you can use the <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> as described above. Additionally, if you want to test the whole plugin as a pip package
(not only a python module) you can alternatively follow these two steps:</p>
<ol class="arabic simple">
<li>git clone the plugin repository to any local folder, in case of a third party plugin</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone git@github.com:scipion-em/scipion-em-myplugin.git /home/me/myplugin
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Install it in “devel” mode:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installp -p /home/me/myplugin --devel
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> approach will provide you with all execution features (protocols, wizzards, all should work).
The only additional thing you are getting with this is testing the installation of the plugin as a pip package,
or for convenience, to forget about the <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> and, still have a live code reacting to latest git pulls
or branch changes.</p>
</div>
<div class="section" id="get-plugins-json">
<h4>Get plugins.json<a class="headerlink" href="#get-plugins-json" title="Permalink to this headline">¶</a></h4>
<p>Scipion requests a json list of available plugins from <a class="reference external" href="http://scipion.i2pc.es/getplugins">http://scipion.i2pc.es/getplugins</a> and uses metadata from
pypi to filter which packages are available for the current Scipion version. Since we want to test our pip
plugin before we upload it to pypi, we will read locally a file like the one provided in the website,
with our plugin added.</p>
<div class="section" id="download-json-file">
<h5>Download json file<a class="headerlink" href="#download-json-file" title="Permalink to this headline">¶</a></h5>
<p>In a directory of your choice, add a <code class="docutils literal notranslate"><span class="pre">plugins.json</span></code> file with the appropriate info for your plugin - you can save
<a class="reference external" href="http://scipion.i2pc.es/getplugins">Scipion’s plugins.json</a> and add your plugin’s data.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;scipion-em-relion&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;relion&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pipName&quot;</span><span class="p">:</span> <span class="s2">&quot;scipion-em-relion&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pluginSourceUrl&quot;</span><span class="p">:</span><span class="s2">&quot;/path/to/your/scipion-em-relion&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that when you add the key <code class="docutils literal notranslate"><span class="pre">pluginSourceUrl</span></code>, Scipion will use pip to install the plugin from that directory
(i.e. pip will copy the <code class="docutils literal notranslate"><span class="pre">relion</span></code> folder to python’s <code class="docutils literal notranslate"><span class="pre">site-packages</span></code> folder). If this key is missing, Scipion will
try to install from <a class="reference external" href="https://pypi.org/">https://pypi.org/</a>. Once you do this installation, changes made in your development folder
will <strong>NOT</strong> be present in the copy used by Scipion. You would have to uninstall and go back to development mode
using the variable <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> or installing with the <code class="docutils literal notranslate"><span class="pre">--devel</span></code> flag as stated in the
<a class="reference internal" href="#devel-mode"><span class="std std-ref">working in devel mode section</span></a>.</p>
</div>
<div class="section" id="add-scipion-plugin-json-variable">
<h5>Add SCIPION_PLUGIN_JSON variable<a class="headerlink" href="#add-scipion-plugin-json-variable" title="Permalink to this headline">¶</a></h5>
<p>In the <code class="docutils literal notranslate"><span class="pre">VARIABLES</span></code> section of your <code class="docutils literal notranslate"><span class="pre">~/.config/scipion/scipion.conf</span></code>, add variable <code class="docutils literal notranslate"><span class="pre">SCIPION_PLUGIN_JSON</span></code>. If
you don’t add this variable, Scipion will read the json from <a class="reference external" href="http://scipion.i2pc.es/getplugins">http://scipion.i2pc.es/getplugins</a> instead of reading
your local json copy. If you use pycharm to run Scipion, you can also add it as environment variable in your run
configuration. Remember to replace the example provided with the right path:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[VARIABLES]</span>
<span class="na">SCIPION_NOTES_PROGRAM</span> <span class="o">=</span>
<span class="na">SCIPION_NOTES_ARGS</span> <span class="o">=</span>
<span class="na">SCIPION_NOTES_FILE</span> <span class="o">=</span> <span class="s">notes.txt</span>
<span class="na">SCIPION_NOTIFY</span> <span class="o">=</span> <span class="s">False</span>
<span class="na">SCIPION_PLUGIN_JSON</span><span class="o">=</span><span class="s">/home/desktop/yaiza/plugins.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="installation-script">
<h4>Installation script<a class="headerlink" href="#installation-script" title="Permalink to this headline">¶</a></h4>
<p>Scipion has a script to handle plugin installation / uninstallation. Use this script in a new
terminal or reset the <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> variable that we defined at the beginning. We have a few (un)installation
choices:</p>
<ul class="simple">
<li>Installing plugin and default binaries:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installp -p scipion_grigoriefflab
</pre></div>
</div>
<p>This command does two things:
1. Gets the package from pypi
2. Installs the default binaries (those that had <code class="docutils literal notranslate"><span class="pre">default=True</span></code> in the <code class="docutils literal notranslate"><span class="pre">registerPluginBinaries</span></code> function).</p>
<p>If no errors happen, we get an output similar to this one:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/home/yaiza/git/scipion/software/bin/python /home/yaiza/git/scipion/scipion installp -p scipion-em-relion

Scipion  pluginization_install_config <span class="o">(</span><span class="m">2018</span>-04-11<span class="o">)</span> 0ee533a

python  /home/yaiza/git/scipion/install/install-plugin.py /home/yaiza/git/scipion/scipion installp -p scipion-em-relion
Building scipion-em-relion ...
python /home/yaiza/git/scipion/software/lib/python2.7/site-packages/pip install /home/yaiza/git/scipion-em-relion
Processing /home/yaiza/git/scipion-em-relion
Installing collected packages: scipion-em-relion
  Running setup.py install <span class="k">for</span> scipion-em-relion: started
    Running setup.py install <span class="k">for</span> scipion-em-relion: finished with status <span class="s1">&#39;done&#39;</span>
Successfully installed scipion-em-relion-1.0a0
Done <span class="o">(</span><span class="m">1</span>.01 seconds<span class="o">)</span>
<span class="o">[</span>. . .<span class="o">]</span>
Building relion-2.1 ...
...Relion binaries installation log goes here
...
Done <span class="o">(</span><span class="m">0</span>.20 seconds<span class="o">)</span>

Process finished with <span class="nb">exit</span> code <span class="m">0</span>
</pre></div>
</div>
<ul class="simple">
<li>Uninstalling plugin and all binaries installed</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installp -p scipion-em-relion
</pre></div>
</div>
<ul class="simple">
<li>We can use the flag –noBin to both install and uninstall without binaries:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installp -p scipion-em-relion --noBin
</pre></div>
</div>
<ul class="simple">
<li>Install specific plugin binaries (only works if we have done <cite>installp</cite> first).</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installb relion-2.1
</pre></div>
</div>
<ul class="simple">
<li>Uninstall specific plugin binaries</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion uninstallb relion-2.0
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing-as-pip-package">
<h3>Testing as pip package<a class="headerlink" href="#testing-as-pip-package" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">With your plugin and binaries installed, it is recommended to run some of your plugin’s tests to check
everything is in order:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion <span class="nb">test</span> em.packages.relion.tests.test_***
</pre></div>
</div>
</li>
<li><p class="first">Open the test project:</p>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion last
</pre></div>
</div>
<p>First, inspect the protocol output to make sure there’s nothing weird; then, open the
protocol box to see if our logo and references are there. It’s important to do this step because
if we don’t open the GUI we won’t be able to detect logo related issues.</p>
<div class="section" id="add-your-own-dataset">
<h4>Add your own DataSet<a class="headerlink" href="#add-your-own-dataset" title="Permalink to this headline">¶</a></h4>
<p>If you need an additional dataset you can do this and host it where ever you want/can.
Let’s assume you need a new dataset…</p>
<ul class="simple">
<li>usually you work first locally until you are happy with your data set.</li>
<li>Decide where to host it and upload it. For that scipion will:</li>
<li>Generate a <code class="docutils literal notranslate"><span class="pre">MANIFEST</span></code> file</li>
<li>rsync it to your server, you will need to provide a login info (like <a class="reference external" href="mailto:user&#37;&#52;&#48;server&#46;com">user<span>&#64;</span>server<span>&#46;</span>com</a>, and a remote folder location.</li>
<li>type something like:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion testdata --upload myplugin123_testdata -l user@server.com -rf /path/at/the/server/for/your/datasets
</pre></div>
</div>
<p>Please note that the dataset name must be unique, so better prefix it with the plugin name. <code class="docutils literal notranslate"><span class="pre">-l</span></code> is the login for your
server and <code class="docutils literal notranslate"><span class="pre">-rf</span></code> is the remote folder where to rsync your files.</p>
<blockquote>
<div><ul class="simple">
<li>Refer to it in your tests, at you tests <code class="docutils literal notranslate"><span class="pre">folder/__init__.py</span></code>:</li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DataSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;myplugin123_testdata&#39;</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;myplugin123_testdata&#39;</span><span class="p">,</span>
        <span class="n">files</span><span class="o">=</span><span class="p">{</span>
               <span class="s1">&#39;file1&#39;</span><span class="p">:</span> <span class="s1">&#39;file1.txt&#39;</span>
               <span class="o">...</span><span class="p">},</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://wwww.server.com/datasets&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>NOTE: url parameter should be a valid url where your dataset is being published.
TIP: I haven’t tried, but doing the upload yourself, to generate the MANIFEST and then adding your datasets + MANIFEST
to github might also work if you later point to the gitraw url?? (disclaimer…has not been tested.)</p>
</div>
</div>
<div class="section" id="create-and-upload-distribution">
<h3>Create and upload distribution<a class="headerlink" href="#create-and-upload-distribution" title="Permalink to this headline">¶</a></h3>
<p>To upload your distribution to pypi, you’ll need to <a class="reference external" href="https://packaging.python.org/tutorials/distributing-packages/#create-an-account">create an account</a>.</p>
<ul class="simple">
<li>Install twine if you don’t have it</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install twine
</pre></div>
</div>
<ul class="simple">
<li>Create the source distribution (at least! You can also create a Built distribution. Read more in the official
<a class="reference external" href="https://packaging.python.org/tutorials/packaging-projects/#generating-distribution-archives">packaging guide</a>)</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$PLUGIN_HOME</span>
rm -rf dist/*    <span class="c1"># To clean the already uploaded modules</span>
python setup.py sdist
</pre></div>
</div>
<p>It is convenient to check your <code class="docutils literal notranslate"><span class="pre">*egg-info/SOURCES.TXT</span></code> and see if you miss any file (pay special attention to
non-python files that you might have forgot to include in <code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> or in your <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, like the logo).</p>
<ul class="simple">
<li>Upload the distribution <strong>WITH EARLIEST COMPATIBLE SCIPION VERSION IN THE COMMENTS</strong>.</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$PLUGIN_HOME</span> <span class="o">&amp;&amp;</span> twine upload dist/* -c <span class="s2">&quot;scipion-2.0&quot;</span>
</pre></div>
</div>
<p>This means that this release we’re uploading will be available for Scipion version 2.0 or higher.
The scipion version must follow the pattern used above (scipion-X.Y(.Z))
Now our plugin is on <a class="reference external" href="https://pypi.org/project/scipion-em-relion">PyPI</a>.</p>
</div>
<div class="section" id="install-from-pip">
<h3>Install from pip<a class="headerlink" href="#install-from-pip" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Uninstall plugin:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion uninstallp -p scipion-em-relion
</pre></div>
</div>
<ul class="simple">
<li>Remove <code class="docutils literal notranslate"><span class="pre">SCIPION_PLUGIN_JSON</span></code> from <code class="docutils literal notranslate"><span class="pre">~/.config/scipion/scipion.conf</span></code>  IF YOUR PLUGIN IS IN ALREADY IN
<a class="reference external" href="http://scipion.i2pc.es/getplugins">http://scipion.i2pc.es/getplugins</a>. IF NOT DON’T DO THIS. Just remove <code class="docutils literal notranslate"><span class="pre">pluginSourceUrl</span></code> from your plugin’s dict.</li>
<li>Install</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SCIPION_HOME</span>/scipion installp -p scipion-em-relion
</pre></div>
</div>
<ul>
<li><p class="first">Test again (yes, again)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scipion <span class="nb">test</span> em.packages.relion.tests.test_***
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="creating-a-protocol.html" class="btn btn-neutral float-right" title="Creating a protocol" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="architecture.html" class="btn btn-neutral float-left" title="Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-2.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../release-2.0.0/docs/developer/creating-a-plugin.html">release-2.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>