

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Understanding the Plugin class &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/how-to-install.html">Installing Scipion v3.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/contact-us.html">Contact Us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Understanding the Plugin class</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/docs/developer/tutorials/understanding-plugin-class.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="understanding-the-plugin-class">
<span id="understanding-plugin-class"></span><h1><a class="toc-backref" href="#id1">Understanding the Plugin class</a><a class="headerlink" href="#understanding-the-plugin-class" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#understanding-the-plugin-class" id="id1">Understanding the Plugin class</a><ul>
<li><a class="reference internal" href="#associated-resources" id="id2">Associated resources</a></li>
<li><a class="reference internal" href="#starting-with-scipion-em-template" id="id3">Starting with scipion-em-template</a><ul>
<li><a class="reference internal" href="#exercise-1-easy" id="id4">Exercise 1 (easy)</a></li>
<li><a class="reference internal" href="#exercise-2-easy" id="id5">Exercise 2 (easy)</a></li>
<li><a class="reference internal" href="#exercise-3-easy" id="id6">Exercise 3 (easy)</a></li>
<li><a class="reference internal" href="#exercise-4-intermediate" id="id7">Exercise 4 (intermediate)</a></li>
<li><a class="reference internal" href="#exercise-5-hard" id="id8">Exercise 5 (hard)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary" id="id9">Summary</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="associated-resources">
<h2><a class="toc-backref" href="#id2">Associated resources</a><a class="headerlink" href="#associated-resources" title="Permalink to this headline">¶</a></h2>
<p>Here you can find resources associated with this content, like videos or presentations used in courses:</p>
<p><a class="reference external" href="https://docs.google.com/presentation/d/1coUcXLkDZrNAWtRbcDO-JsPCxsOSrHh8gjMngoLK7WE/edit?usp=sharing">Course presentation</a></p>
<p><a class="reference external" href="https://scipion-em.github.io/docs/docs/developer/creating-a-plugin#creating-init-py">Detailed documentation</a></p>
</div>
<div class="section" id="starting-with-scipion-em-template">
<h2><a class="toc-backref" href="#id3">Starting with scipion-em-template</a><a class="headerlink" href="#starting-with-scipion-em-template" title="Permalink to this headline">¶</a></h2>
<p>Let’s go to our template plugin folder and setup everything ready for the practice session:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion-em-template
git checkout course5_exBase
</pre></div>
</div>
<p>You might notice a new file <cite>protocol_run_myprogram.py</cite>. Have a look inside.
You will see that this simple protocol only has one step function <strong>runStep</strong> that executes a program via <strong>runJob</strong>.
If you are using PyCharm you will see that <strong>Plugin.getProgram()</strong> function is undefined.</p>
<div class="figure">
<img alt="getProgram is undefined" src="../../../_images/practice5_undefined_func.png" />
</div>
<p>Open Scipion and create a new project. Open it and search for <strong>my program</strong> protocol (use <em>Ctrl+F</em> to search for the protocols).
As it does not have any input variables, just execute it. It should fail with the following error message:</p>
<div class="figure">
<img alt="Failed protocol message" src="../../../_images/practice5_failed_protocol.png" />
</div>
<p>Let’s start working on the Plugin class from scratch.</p>
<div class="section" id="exercise-1-easy">
<h3><a class="toc-backref" href="#id4">Exercise 1 (easy)</a><a class="headerlink" href="#exercise-1-easy" title="Permalink to this headline">¶</a></h3>
<p>First, create <strong>myplugin/constants.py</strong> file and define the following constants:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">MYPROGRAM_HOME</span> <span class="o">=</span> <span class="s1">&#39;MYPROGRAM_HOME&#39;</span>
<span class="nv">MYPROGRAM</span> <span class="o">=</span> <span class="s1">&#39;MYPROGRAM&#39;</span>
<span class="nv">V1_0</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
</pre></div>
</div>
<p>Pay attention that for the first two vars we defined the “name” of the constant (as a string) and not it’s value.
Usually it’s a good idea if you want to re-use the constant names throughout the plugin code.</p>
<p>Now switch to <strong>__init__.py</strong> file and start populating the Plugin class with homeVar, pathVars, list of supported versions and url (you can put any web address you like).
Don’t forget that you need to import constants from the <strong>constants.py</strong> file!
Then add <strong>_defineVariables</strong> class method and define <strong>MYPROGRAM_HOME</strong> as <strong>myprogram-1.0</strong> and <strong>MYPROGRAM</strong> as <strong>example_script.sh</strong>.
Make sure <strong>MYPROGRAM_HOME</strong> points to the path inside software/em folder (where usually all packages are installed).</p>
</div>
<hr class="docutils" />
<div class="section" id="exercise-2-easy">
<h3><a class="toc-backref" href="#id5">Exercise 2 (easy)</a><a class="headerlink" href="#exercise-2-easy" title="Permalink to this headline">¶</a></h3>
<p>We still need to define plugin binaries (and actually create them), so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion3/software/em
mkdir myprogram-1.0
<span class="nb">cd</span> myprogram-1.0
touch example_script.sh
chmod a+x example_script.sh
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It’s good to follow the <em>name-version</em> (myprogram-1.0) convention when defining the software folder names. This way Scipion can easily detect the version number.</p>
</div>
<p>Open <strong>example_script.sh</strong> in any editor and paste the following code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">&quot;Starting myprogram...&quot;</span>
sleep <span class="m">5</span>
<span class="nb">echo</span> <span class="s2">&quot;This script has finished running!&quot;</span>
</pre></div>
</div>
<p>Save the script. As you can see it will simply print some text after waiting for 5 seconds.
Add <strong>defineBinaries</strong> class method to the Plugin class.
You can provide any value for tar argument (e.g. <strong>tar=’myprogram_v1.0.tgz’</strong>) as we have already “installed” the binaries.</p>
<p>Now, remember that we are still missing <strong>getProgram</strong> function for our protocol?
Create it inside the Plugin class and make it return the full path to <strong>MYPROGRAM</strong> (<em>Hint: you will need to use cls.getHome()</em>)</p>
</div>
<hr class="docutils" />
<div class="section" id="exercise-3-easy">
<h3><a class="toc-backref" href="#id6">Exercise 3 (easy)</a><a class="headerlink" href="#exercise-3-easy" title="Permalink to this headline">¶</a></h3>
<p>Now let’s test the plugin binaries.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion3
./scipion3 installb -h
</pre></div>
</div>
<p>If you see something like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>myprogram                <span class="m">1</span>.0     <span class="o">[</span>X<span class="o">]</span>
</pre></div>
</div>
<p>congratulations! You’ve got the binaries properly defined and installed.
Reopen your Scipion project and restart our protocol.
Once it is finished, check the output log. You should see something similar to:</p>
<div class="figure">
<img alt="Run finished" src="../../../_images/practice5_ex3_finished.png" />
</div>
<p>Now, imagine a user who wants to use a different binary version.
At the moment we have the default version defined in <strong>_defineVariables</strong> as <strong>1.0</strong>.
For simplicity, let’s close the Scipion project and rename our package folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion3/software/em
mv myprogram-1.0 myprogram-1.1
</pre></div>
</div>
<p>Reopen the project (run <cite>scipion last</cite>) and try to restart the finished protocol. You should see an error message that is raised by <strong>validateInstallation</strong> function from <em>pyworkflow/plugin.py</em>:</p>
<div class="figure">
<img alt="Installation validation has failed" src="../../../_images/practice5_ex3_missing_var.png" />
</div>
<p>This means that the user have to redefine <strong>MYPROGRAM_HOME</strong> to point to version 1.1.
So, redefine it in your <strong>scipion3/config/scipion.conf</strong> file (if you do not have it, execute <cite>./scipion3 config</cite> first to generate the file) and then re-run the protocol:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">MYPROGRAM_HOME</span> <span class="o">=</span> software/em/myprogram-1.1
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can also define such variables in your shell environment if you like. The priority goes as following: environment &gt; config &gt; default value.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="exercise-4-intermediate">
<h3><a class="toc-backref" href="#id7">Exercise 4 (intermediate)</a><a class="headerlink" href="#exercise-4-intermediate" title="Permalink to this headline">¶</a></h3>
<p>You might have noticed that right now we are using the full path to the binary (<strong>example_script.sh</strong>) in <strong>getProgram</strong> function.
Another possibility would be to use <strong>getEnviron</strong> function to add the package folder to the <em>PATH</em>.
Have a look at the presentation slides and find an example of this function. You can also look at the <strong>Environ</strong> class inside <em>pyworkflow/utils.py</em>.
Can you now define <strong>getEnviron</strong> function inside the Plugin class so that the myprogram-1.1 path is added to the beginning of the PATH var?</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You would need to use <strong>update</strong> function of the <strong>Environ</strong> class and <strong>position=BEGIN</strong>.</p>
</div>
<p>If you have given up, checkout the resulting code in the following branch (exercises 1-4 completed):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> scipion-em-template
git checkout course5_ex1-4
</pre></div>
</div>
<p>Once the PATH contains the path to our myprogram-1.1, we don’t need anymore to define the full path in the <strong>getProgram</strong> function.
Change the function and re-run the protocol. In the output log you should see now only the binary name instead of the full path to the executable.
This was a very simple case, but in principle <strong>getEnviron</strong> function can be used to modify things like <em>LD_LIBRARY_PATH</em> or define specific CUDA libraries / MPI versions etc.</p>
<div class="figure">
<img alt="The binary is now in the PATH" src="../../../_images/practice5_ex4_using_env.png" />
</div>
<p>The <strong>getEnviron</strong> function gets automatically recognised by <em>pyworklow/protocol.py</em> when executing the plugin protocols,
however you can also explicitly define the environment inside <strong>runJob</strong> function:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>self.runJob<span class="o">(</span>program, params, <span class="nv">env</span><span class="o">=</span>Plugin.getEnviron<span class="o">())</span>
</pre></div>
</div>
</div>
<div class="section" id="exercise-5-hard">
<h3><a class="toc-backref" href="#id8">Exercise 5 (hard)</a><a class="headerlink" href="#exercise-5-hard" title="Permalink to this headline">¶</a></h3>
<p>Let’s explore conda-based installation. A lot of new cryo-em software comes with its own conda environment so this seems like an appropriate use case.</p>
<p>First, you need to make sure that you have conda installed (we recommend <em>miniconda3</em>). If you have used conda for Scipion installation then there should be no problem.
You also need to know how to activate it, this depends on the system and the SHELL you are using. Below is an example for bash:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>. /path/to/miniconda3/etc/profile.d/conda.sh
</pre></div>
</div>
<p>We need to define the following constants in your <strong>scipion3/config/scipion.conf</strong> file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CONDA_ACTIVATION_CMD</span> <span class="o">=</span> . /path/to/miniconda3/etc/profile.d/conda.sh
<span class="nv">MYPROG_ENV_ACTIVATION</span> <span class="o">=</span> conda activate myprogenv-1.0
</pre></div>
</div>
<p>Add the following functions to the Plugin class:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>@classmethod
def getDependencies<span class="o">(</span>cls<span class="o">)</span>:
    <span class="c1"># try to get CONDA activation command</span>
    <span class="nv">condaActivationCmd</span> <span class="o">=</span> cls.getCondaActivationCmd<span class="o">()</span>
    <span class="nv">neededProgs</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">if</span> not condaActivationCmd:
        neededProgs.append<span class="o">(</span><span class="s1">&#39;conda&#39;</span><span class="o">)</span>

    <span class="k">return</span> neededProgs

@classmethod
def getMyProgEnvActivation<span class="o">(</span>cls<span class="o">)</span>:
    <span class="s2">&quot;&quot;&quot; Remove the scipion home and activate the conda environment. &quot;&quot;&quot;</span>
    <span class="nv">activation</span> <span class="o">=</span> cls.getVar<span class="o">(</span>MYPROG_ENV_ACTIVATION<span class="o">)</span>
    <span class="nv">scipionHome</span> <span class="o">=</span> Config.SCIPION_HOME + os.path.sep

    <span class="k">return</span> activation.replace<span class="o">(</span>scipionHome, <span class="s2">&quot;&quot;</span>, <span class="m">1</span><span class="o">)</span>
</pre></div>
</div>
<p>The first one is used to make sure the “conda” command is available (either after activation or from PATH),
while the second one is required to activate the specific conda environment.</p>
<p>You also need to import <strong>Config</strong> from <em>pyworkflow.utils</em> at the top of the file and define <strong>MYPROG_ENV_ACTIVATION</strong> both in <strong>defineVariables</strong> and also the <strong>constants.py</strong> file.</p>
<p>Modify the <strong>getProgram</strong> function so that it concatenates 3 commands:
cls.getCondaActivationCmd(), cls.getMyProgEnvActivation() and the program variable (<strong>example_script.py</strong>).</p>
<p>Now change <strong>addPackage</strong> function inside <strong>defineBinaries</strong>: you need to set <strong>tar=void.tgz</strong> add <strong>commands</strong> argument that will
create and activate a new conda environment. e.g:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda create -y -n myprogenv-1.0 <span class="nv">python</span><span class="o">=</span><span class="m">3</span><span class="p">;</span>
conda activate myprogenv-1.0<span class="p">;</span>
touch IS_INSTALLED<span class="p">;</span>
</pre></div>
</div>
<p>Here we did not install any packages inside the new conda env since our simple script is not a python package.</p>
<p>Last, let’s modify <strong>getEnviron</strong> function and remove <strong>PYTHONPATH</strong> key from Environ dict - this is required for the virtual environment to work properly within Scipion.</p>
<p>Now we are ready to install myprogram-1.0 with conda environment (remember, we have renamed to myprogram-1.1, so now our binaries are missing if you run <cite>./scipion3 installb -h</cite>)
Execute the following:</p>
<p>Here we did not provide the version, so the version with <strong>default=True</strong> flag is installed.
If the installation have completed successfully, you are in luck!
Look into <strong>software/em/myprogram-1.0</strong>, you should see IS_INSTALLED empty file.
Remove MYPROGRAM_HOME from the <strong>scipion.conf</strong> file and move our little script back:</p>
<p>We are finally ready to run our protocol. If everything went well, you should see something like this:</p>
<div class="figure">
<img alt="The binary works within new conda environment" src="../../../_images/practice5_ex5.png" />
</div>
<p>Results for this exercise can be found in the following git branch:</p>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id9">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we have explored the Plugin class and its main methods.
Once you get familiar with them you should be able to create <strong>__init__.py</strong> file for your plugin easily.
If you are brave enough, you can have a look at the Sphire plugin code that provides a more complex conda-based installation, use of void.tgz among other things:</p>
<p><a class="reference external" href="https://github.com/scipion-em/scipion-em-sphire/blob/master/sphire/__init__.py">https://github.com/scipion-em/scipion-em-sphire/blob/master/sphire/__init__.py</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/developer/tutorials/understanding-plugin-class.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>