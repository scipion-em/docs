

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial - Denoising, Membrane Segmentation and Annotation and Directional Picking &mdash; Scipion 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Scipion
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Set up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/how-to-install.html">Installing Scipion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/scipion-configuration.html">Scipion configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scipion-modes/host-configuration.html">Host configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user-documentation.html">Graphical interface manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-documentation.html#tutorials">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-documentation.html#processing-how-to-s">Processing How To’s</a></li>
</ul>
<p class="caption"><span class="caption-text">Facilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities.html">On-the-fly processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/facilities-workflows.html">Streaming workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../facilities/customize-report.html">Summary Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developer/developers.html">Developers Page</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/scipion-API.html">Scipion API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins-API.html">Plugins API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/xmipp-API.html">Xmipp API</a></li>
</ul>
<p class="caption"><span class="caption-text">Get in touch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/contact-us.html">Contact Us</a></li>
</ul>
<p class="caption"><span class="caption-text">Licences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Scipion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial - Denoising, Membrane Segmentation and Annotation and Directional Picking</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/docs/user/denoising_mbSegmentation_pysegDirPicking/tomosegmemTV-pySeg-workflow.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="figure">
<a class="reference internal image-reference" href="../../../_images/scipion_logo.gif"><img alt="scipion logo" src="../../../_images/scipion_logo.gif" style="width: 250px;" /></a>
</div>
<div class="section" id="tutorial-denoising-membrane-segmentation-and-annotation-and-directional-picking">
<span id="tomosegmemtv-pyseg-workflow"></span><h1><a class="toc-backref" href="#id5">Tutorial - Denoising, Membrane Segmentation and Annotation and Directional Picking</a><a class="headerlink" href="#tutorial-denoising-membrane-segmentation-and-annotation-and-directional-picking" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#tutorial-denoising-membrane-segmentation-and-annotation-and-directional-picking" id="id5">Tutorial - Denoising, Membrane Segmentation and Annotation and Directional Picking</a><ul>
<li><a class="reference internal" href="#introduction" id="id6">Introduction</a><ul>
<li><a class="reference internal" href="#objective" id="id7">Objective</a></li>
<li><a class="reference internal" href="#associated-resources" id="id8">Associated resources</a></li>
<li><a class="reference internal" href="#the-dataset" id="id9">The dataset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preparing-the-project" id="id10">Preparing the project</a></li>
<li><a class="reference internal" href="#importing-the-tomogram" id="id11">Importing the tomogram</a></li>
<li><a class="reference internal" href="#tomogram-normalization" id="id12">Tomogram normalization</a></li>
<li><a class="reference internal" href="#tomogram-denoising" id="id13">Tomogram denoising</a></li>
<li><a class="reference internal" href="#membrane-segmentation" id="id14">Membrane segmentation</a></li>
<li><a class="reference internal" href="#membrane-annotation" id="id15">Membrane annotation</a><ul>
<li><a class="reference internal" href="#membrane-annotator-overview" id="id16">Membrane Annotator overview</a></li>
<li><a class="reference internal" href="#target-vesicles" id="id17">Target vesicles</a></li>
<li><a class="reference internal" href="#density-thresholding" id="id18">Density thresholding</a></li>
<li><a class="reference internal" href="#manual-annotation-of-the-target-1" id="id19">Manual annotation of the target 1</a></li>
<li><a class="reference internal" href="#manual-annotation-of-the-target-2" id="id20">Manual annotation of the target 2</a></li>
<li><a class="reference internal" href="#manual-annotation-of-the-target-3" id="id21">Manual annotation of the target 3</a></li>
<li><a class="reference internal" href="#save-the-annotated-vesicles-and-finish-the-interactive-annotation-protocol" id="id22">Save the annotated vesicles and finish the interactive annotation protocol</a></li>
<li><a class="reference internal" href="#analyze-the-annotated-membranes" id="id23">Analyze the annotated membranes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resize-the-tomomasks-segmentations" id="id24">Resize the tomomasks (segmentations)</a></li>
<li><a class="reference internal" href="#directional-picking-with-pyseg" id="id25">Directional picking with PySeg</a><ul>
<li><a class="reference internal" href="#preseg" id="id26">Preseg</a></li>
<li><a class="reference internal" href="#graphs" id="id27">Graphs</a></li>
<li><a class="reference internal" href="#fils" id="id28">Fils</a></li>
<li><a class="reference internal" href="#picking" id="id29">Picking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#picking-post-processing" id="id30">Picking post processing</a><ul>
<li><a class="reference internal" href="#remove-duplicates" id="id31">Remove duplicates</a></li>
<li><a class="reference internal" href="#filter-by-normal" id="id32">Filter by normal</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subtomogram-extraction" id="id33">Subtomogram extraction</a></li>
<li><a class="reference internal" href="#d-classification" id="id34">2D classification</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id6">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorial covers a part of the full data processing pipeline in cryo electron tomography, concretely from the
tomogram to the initial model generation after having picked the particles. All the data processing has been carried
out in <a class="reference external" href="http://scipion.i2pc.es/">Scipion</a>, using the plugins listed below for each step:</p>
<ol class="arabic simple">
<li>Import tomograms - <a class="reference external" href="https://github.com/scipion-em/scipion-em-tomo">scipion-em-tomo</a></li>
<li>Tomogram normalization - <a class="reference external" href="https://github.com/scipion-em/scipion-em-imod">scipion-em-imod</a></li>
<li>Tomogram denoising - <a class="reference external" href="https://github.com/scipion-em/scipion-em-tomo3d">scipion-em-tomo3d</a></li>
<li>Tomogram segmentation, annotation and tomomask (segmemtation) resizing - <a class="reference external" href="https://github.com/scipion-em/scipion-em-tomosegmemtv">scipion-em-tomosegmemtv</a></li>
<li>Directional picking (preseg, graphs, filaments and picking) - <a class="reference external" href="https://github.com/scipion-em/scipion-em-pyseg">scipion-em-pyseg</a></li>
<li>Fit vesicles - <a class="reference external" href="https://github.com/I2PC/scipion-em-xmipptomo">scipion-em-xmipptomo</a></li>
<li>Remove duplicates (filter picked particles by distance) and filter by normal - <a class="reference external" href="https://github.com/scipion-em/scipion-em-tomo3d">scipion-em-tomo3d</a></li>
<li>Extract particles - <a class="reference external" href="https://github.com/scipion-em/scipion-em-emantomo">scipion-em-emantomo</a></li>
<li>Create 3d mask - <a class="reference external" href="https://github.com/I2PC/scipion-em-xmipp">scipion-em-xmipp</a></li>
<li>2D classification - <a class="reference external" href="https://github.com/scipion-em/scipion-em-pyseg">scipion-em-pyseg</a></li>
<li>Visualization tools - <a class="reference external" href="https://github.com/I2PC/scipion-em-xmipp">scipion-em-xmipp</a>, <a class="reference external" href="https://github.com/scipion-em/scipion-em-imod">scipion-em-imod</a> and <a class="reference external" href="https://github.com/scipion-em/scipion-em-pyseg">scipion-em-pyseg</a></li>
</ol>
<p>Thus, 9 different plugins will be used in this tutorial, highlighting the power of Scipion in terms of interoperability.
Figure below shows and scheme of the main workflow steps proposed for this tutorials and the plugins used to carry them
out.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/00_workflow_scheme.png"><img alt="Workflow scheme" src="../../../_images/00_workflow_scheme.png" style="width: 400px;" /></a>
</div>
<p>The figure below is a capture of the final aspect of the project we’re going to generate during this tutorial. Each
box represents a protocol and a different color has been chosen for the different plugins which the protocols used
belong to.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/00_project_overview_colored.png"><img alt="Project overview" src="../../../_images/00_project_overview_colored.png" style="width: 300px;" /></a>
</div>
<div class="section" id="objective">
<h3><a class="toc-backref" href="#id7">Objective</a><a class="headerlink" href="#objective" title="Permalink to this headline">¶</a></h3>
<p>The aim of this tutorial is to pick the membrane ribosomes of an in situ tomogram using segmentation, annotation and
directional picking protocols inside Scipion framework.</p>
</div>
<div class="section" id="associated-resources">
<h3><a class="toc-backref" href="#id8">Associated resources</a><a class="headerlink" href="#associated-resources" title="Permalink to this headline">¶</a></h3>
<p>Here you can find resources associated with this content, like videos or presentations used in courses and other
documentation pages:</p>
<p><a class="reference external" href="https://docs.google.com/presentation/d/1u8v4F7ca3EgzpvOCZ7DteiIB42iQ_4FD1EP6KH2g0Yk/edit?usp=sharing">Denoising tomograms and membrane segmentation</a></p>
<p><a class="reference external" href="https://docs.google.com/presentation/d/1zFArx9GuIN20EZ_uK2OsIzDpae61ryn9x3eColO5n3k/edit?usp=sharing">PySeg presentation</a></p>
<p><a class="reference external" href="https://scipion-em.github.io/docs/docs/user/scipion-gui.html#scipion-gui">Basic actions with Scipion</a></p>
</div>
<div class="section" id="the-dataset">
<h3><a class="toc-backref" href="#id9">The dataset</a><a class="headerlink" href="#the-dataset" title="Permalink to this headline">¶</a></h3>
<p>The dataset reference used in this tutorial is <a class="reference external" href="https://www.ebi.ac.uk/emdb/EMD-10439?tab=overview">EMD-10439</a>, which consists of an in situ tomogram of intact P19 cells
acquired with phase-plate, with a sampling rate of 13.68 Å/voxel and dimensions (X, Y, Z) = (928, 928, 500) pixels.</p>
</div>
</div>
<div class="section" id="preparing-the-project">
<h2><a class="toc-backref" href="#id10">Preparing the project</a><a class="headerlink" href="#preparing-the-project" title="Permalink to this headline">¶</a></h2>
<p>First of all, open a terminal and execute the command scipion3 to run Scipion. After that:</p>
<ol class="arabic simple">
<li>Click on button “Create Project”.</li>
<li>Write a name for it. We’ll name it <em>Day_2_memb_seg_and_pyseg_dir_picking</em>.</li>
<li>Click on button “Create”.</li>
</ol>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/00_createProject.png"><img alt="Create Project" src="../../../_images/00_createProject.png" style="width: 400px;" /></a>
</div>
<p>Note: the protocols can be located on the left panel of the project interface or directly search via ctrl + f and typing
the keywords that may represent what it is desired to be found, like a plugin name, a protocol name, an action, etc.</p>
</div>
<div class="section" id="importing-the-tomogram">
<span id="id1"></span><h2><a class="toc-backref" href="#id11">Importing the tomogram</a><a class="headerlink" href="#importing-the-tomogram" title="Permalink to this headline">¶</a></h2>
<p>Let’s begin importing the tomogram. This is the entry point to Scipion, in which external data files are represented as
Scipion objects, which is a common representation of the data used to make all the different packages speak to each
other. To do that, simply look for a protocol named “import tomograms” and click on it. On tab “Import”, introduce the
directory in which the tomogram file is located, then the full name or a pattern in the second field and finally the
sampling rate, which is, as mentioned before, 13.68 Å/voxel. Leave the other two tabs with the default values and click
on “Execute” button.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/01_ImportTomo.png"><img alt="Import tomogram" src="../../../_images/01_ImportTomo.png" style="width: 500px;" /></a>
</div>
<p>The imported data can be now visualized by clinking on button “Analyze”, located on the top right corner of the bottom
panel. This will generate an auxiliary window which will lists the tomograms contained in the set imported. In our case,
there is only one tomogram. To open it with IMOD’s viewer 3dmod (integrated as part of plugin scipion-em-imod), simply
double click on it.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/01_res_ImportTomo.png"><img alt="Import tomogram result" src="../../../_images/01_res_ImportTomo.png" style="width: 700px;" /></a>
</div>
</div>
<div class="section" id="tomogram-normalization">
<span id="id2"></span><h2><a class="toc-backref" href="#id12">Tomogram normalization</a><a class="headerlink" href="#tomogram-normalization" title="Permalink to this headline">¶</a></h2>
<p>In this step, we are going to divide by two the size of the tomogram in order to make the denoising, segmentation and
annotation steps faster and, in the case of the membranes segmentation and annotation, making it easier to the
algorithm to detect them, because of the enhanced contrast as the binning gets higher. To do that, we are going to use
the protocol called “tomo normalization” from plugin scipion-em-imod. Once the protocol form is on the screen, follow
the steps listed below:</p>
<p>1. To get the pointer to the tomogram previously imported, click on the magnifier icon. This action will open an
auxiliary window which will lists the existing objects of the same type as expected.</p>
<ol class="arabic simple" start="2">
<li>At this point of the wokflow, we only have the tomogram imported before. Hence, select it.</li>
<li>Click on “Select” button.</li>
</ol>
<p>4. Introduce vale 2 in “Binning” field, to indicate that the resulting tomogram must be half of the size of the input
tomogram. Consequently, the sampling rate of the output tomogram will be the double, as can be observed in the summary
panel at the bottom of the project interface.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/02_NormalizeTomo.png"><img alt="Normalize tomogram" src="../../../_images/02_NormalizeTomo.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="tomogram-denoising">
<h2><a class="toc-backref" href="#id13">Tomogram denoising</a><a class="headerlink" href="#tomogram-denoising" title="Permalink to this headline">¶</a></h2>
<p>This step is recommended to be carried out before the membrane segmentation, considering that the higher contrast our
data has, the better the membranes will be segmented. To do that, open the protocol “denoise tomogram” from plugin
scipion-em-jjsoft. Once there, click on the magnifier icon and select, on the pop-up window the pointer to the
normalized tomogram (it should be the first on the list, because the objects generated are sorted from newest to
oldest by default). Leave the rest of parameters with the default values and click execute the protocol.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/03_DenoiseTomo.png"><img alt="Denoise tomogram" src="../../../_images/03_DenoiseTomo.png" style="width: 500px;" /></a>
</div>
<p>The denoised tomogram can be displayed proceeding the same as explain in section <a class="reference internal" href="#importing-the-tomogram">Importing the Tomogram</a>. It can be observed
how the contrast has been considerably increased, being the figure on the left the tomogram before the denoising and
the one on the right after the denoising.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/03_res_DenoiseTomo.png"><img alt="Denoise tomogram result" src="../../../_images/03_res_DenoiseTomo.png" style="width: 1000px;" /></a>
</div>
</div>
<div class="section" id="membrane-segmentation">
<h2><a class="toc-backref" href="#id14">Membrane segmentation</a><a class="headerlink" href="#membrane-segmentation" title="Permalink to this headline">¶</a></h2>
<p>Membrane segmentation and annotation constitute the pre-processing steps for the membrane particles picking with PySeg.
The first step will be carried out with protocol “tomogram segmentation” from plugin scipion-em-tomosegmemtv. Open the
protocol mentioned and follow the steps listed and illustrated below:</p>
<p>1. Click on Advanced radio button. This action is present in all the protocols that offer advanced parameters and its
used to show them.</p>
<ol class="arabic simple" start="2">
<li>Select the denoised tomogram pointer in field “Input tomograms”.</li>
</ol>
<p>3. Set the “Membrane thickness” parameter to <em>1</em> voxel. This is a good and recommended strategy to get the membranes closer
to an over-detection scenario than the opposite, which would be the resulting scenario with higher values. In our case,
this is the best way to proceed, due to the fact that we’re going to annotate the membranes in the next step with the
Membrane Annotator tool, which provides residual structures cleaning tools. Hence, with a low value of this parameter,
we’ll obtain less discontinuities in the membranes, but more false positives. The first condition takes to a simpler
annotation step in one or two steps per vesicle instead of having to annotate part by part in case of many
discontinuities. On the other side, the false positives can be easily removed with the annotation tool.</p>
<p>4. Set the parameter “Membrane scale factor” to <em>8</em> voxels. This parameter is used to define the effective neighbourhood
of the membranes considered in the calculations (voting process). Hence, this value is recommended to be low for thin
membranes and high for thick membranes, and considering the sampling rate of the tomograms whose vesicles are going to
be segmented.</p>
<p>5. Set the parameter “Membrane strength threshold” to <em>0.01</em>. This parameter is used to tune the amount of output
membrane points and remove false positives. Lower values will provide more membrane points, at the risk of generating
false positives. Thus, this is a critical value when an annotation step is going to be carried out, because a very low
value will make most of the structures found in the tomogram to be connected, so it won’t be possible to annotate them
separately. On the other hand, higher values will provide a higher probability of the structures to be disconnected,
but if the value is too high more discontinuities may be present in the structures detected.</p>
<p>6. Set the parameter “Sigma for the initial gaussian processing” to <em>0.5</em>. The input tomogram is subjected to an
initial Gaussian filtering aiming at reducing the noise so as to determine the derivatives more robustly. By default,
a standard deviation of 1.0 voxel is considered. If the membranes are very thin or are very close to each other,
use lower values (e.g. 0.5).</p>
<p>7. Set the parameter “Keep all the generated files” to <em>Yes</em> to save all the intermediate results obtained in the
different steps carried out internally by tomosegmemTV.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/04_MembranesSegmentation.png"><img alt="Vesicles segmentation" src="../../../_images/04_MembranesSegmentation.png" style="width: 500px;" /></a>
</div>
<p>Note: in this example all the parameter values provided have been tuned previously, but in the normal scenario consists
of some executions until getting the desired result. Even more, sometimes it is necessary to go back from the membrane
annotator to tune some parameter to, for example, get the membranes less connected. On the other hand, it is
recommended to keep all the files when you are not familiarized with the algorithm so, if the membranes get lost in the
final result, the intermediate results can be analyzed to determine when they got lost and, as a consequence, know
know which parameter should be tuned. For a more detailed explanation, review the presentation:
<a class="reference external" href="https://docs.google.com/presentation/d/1u8v4F7ca3EgzpvOCZ7DteiIB42iQ_4FD1EP6KH2g0Yk/edit?usp=sharing">Denoising tomograms and membrane segmentation</a></p>
<p>The result obtained should look like the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/04_res_MembranesSegmentation.png"><img alt="Vesicles segmentation result" src="../../../_images/04_res_MembranesSegmentation.png" style="width: 500px;" /></a>
</div>
<p>Hint: the recommended procedure is to work with one or two tomograms of the set to tune the parameters and then use
that configuration with all the set.</p>
</div>
<div class="section" id="membrane-annotation">
<h2><a class="toc-backref" href="#id15">Membrane annotation</a><a class="headerlink" href="#membrane-annotation" title="Permalink to this headline">¶</a></h2>
<p>Once the membranes have been successfully segmented, they need to be annotated, which means to manually add a numerical
label to each to indicate the software that they represent different entities. This step will be carried out with the
protocol “annotate segmented membranes” from plugin scipion-em-tomosegmemTV. This is an interactive protocol which
generate an auxiliary window that lists the tomograms to be annotated and allow the user to execute the membrane
annotator tool by double clicking on it. It also indicates which of them have been annotated and which are still
pending to be processed. The only parameter present in this protocol is the pointer to the tomomasks (segmentations).</p>
<p>Note: It may take a few seconds to be displayed after double clicking on one tomogram from the list shown in the
auxiliary window.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotation.png"><img alt="Vesicles annotation" src="../../../_images/05_MembranesAnnotation.png" style="width: 1000px;" /></a>
</div>
<div class="section" id="membrane-annotator-overview">
<h3><a class="toc-backref" href="#id16">Membrane Annotator overview</a><a class="headerlink" href="#membrane-annotator-overview" title="Permalink to this headline">¶</a></h3>
<p>The following subsections will describe how to use the membrane annotation tool. But before that, let’s have a quick
look at its interface and components:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_overview.png"><img alt="Membrane Annotator overview" src="../../../_images/05_MembranesAnnotator_overview.png" style="width: 650px;" /></a>
</div>
<p>Here is a brief explanation of each of the component enumerated in the figure above:</p>
<p>1. Tools shortcuts: it offers useful functionalities to work with the structures found in the loaded tomogram, like the
zoom in/out or the click and drag.</p>
<p>2. Density thresholding tools: the thresholding is the starting point of every labelling procedure. It’s value can be
updated using the slider or introducing a value in the corresponding textbox.</p>
<p>3. Z slice navigation tools: another textbox and another slider are provided to navigate through the Z slices of the
tomogram and locate all vesicles desired to be annotated.</p>
<ol class="arabic" start="4">
<li><p class="first">View panel: it allows to visualize different representations of the loaded data:</p>
<blockquote>
<div><p>4.1 Original - current tomogram data</p>
<p>4.2 Filter - input of the density thresholding operations.</p>
<p>4.3 Threshold - output of the density thresholding operations.</p>
<p>4.4 Label - Result of “Update Labels” operation (assign to each structure a label which is its size in voxels.</p>
<p>4.5 Material - Result of the manual labelling. It shows the annotated membranes with the assigned value.</p>
</div></blockquote>
</li>
<li><p class="first">Crop panel: it can be used to crop the tomogram oroviding the X, Y and Z ranges and clicking in button “Update”.</p>
</li>
<li><p class="first">Size Threshold panel: it can be used to perform three different operations:</p>
<blockquote>
<div><dl class="docutils">
<dt>6.1 Update Labels: automatic labelling of the structures found depending in the density threshold value. It assigns,</dt>
<dd><p class="first last">by default, the size of each structure as label. It will update the view to the view “Label”.</p>
</dd>
<dt>6.2 Display Cursor: it’s used to check the size of each structure. One click on it will activate the cursor mode,</dt>
<dd><p class="first last">which will display the value of the pixel selected. To finish this cursor mode, click again on the previous
button, whose name will be now “Stop Cursor”. This functionality is very useful to determine if, for example,
the different parts of a discontinuous structure have been detected as parts of the same structure of not and
manually annotate them coherently.</p>
</dd>
<dt>6.3 Size Thresholding: it can be used to remove undesired sizes of structures, like the ones which are too small.</dt>
<dd><p class="first last">To do that, simply introduce a size value in the textbox and click on the button “S. Th.”.</p>
</dd>
</dl>
</div></blockquote>
</li>
</ol>
<p>7. Set Material panel: it works like the “Display Cursor” functionality explained in 6.2, but to annotate the desired
structures. To do that, click on button “Display Cursor” to activate the cursor mode. Then select a structure by
clicking on it (until here it’s the same as before) and finally introduce a value in the corresponding textbox before
clicking again on the cursor button (renamed to “Change Lbl.”) to stop it and automatically execute the labelling of
the selected structure, shown in view “Material”.</p>
<p>8. Results panel: it has two buttons, one to save the automatic size labels calculated when clicking on button “Update
Labels” and the other to save the manually annotated structures. IMPORTANT: working from Scipion, this step is required
to be carried out once all the desired vesicles have been annotated.</p>
<ol class="arabic simple" start="9">
<li>Log panel: it registers the main actions that have been carried out by the user.</li>
<li>Tomogram file name: informative.</li>
<li>Data visualization panel.</li>
</ol>
</div>
<div class="section" id="target-vesicles">
<span id="id3"></span><h3><a class="toc-backref" href="#id17">Target vesicles</a><a class="headerlink" href="#target-vesicles" title="Permalink to this headline">¶</a></h3>
<p>It can be observed that three of the vesicles (squared in the figure below) contain most of the membrane ribosomes.
These are the ones we’re going to annotate.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_targets.png"><img alt="Membrane Annotator targets" src="../../../_images/05_MembranesAnnotator_targets.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="density-thresholding">
<h3><a class="toc-backref" href="#id18">Density thresholding</a><a class="headerlink" href="#density-thresholding" title="Permalink to this headline">¶</a></h3>
<p>First of all, let’s set the density threshold value [2] to <em>0.05</em>. This value offers a clean and continuous view of the
different structures present in the loaded tomogram.</p>
<p>Hint: to get an intuition of how the variations in the density threshold value affects the data, it’s very recommendable
to test different values until a promising visualization is obtained.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_thresholding.png"><img alt="Membrane Annotator thresholding" src="../../../_images/05_MembranesAnnotator_thresholding.png" style="width: 650px;" /></a>
</div>
<p>To check the results, click on button “Update Labels” [6]. The result of this operation should look like as the figure
below. It can be observed that the segmentation and density thresholding values were correctly determined because all
the target structures present different colors, which means different sizes. In some cases, like in target 1, there are
two or more different colors (sizes) for the same vesicle, but this is more than normal in the case of our data (in
situ tomogram). This can be solved annotating the different parts with the same label.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_autoLabel.png"><img alt="Membrane Annotator update labels" src="../../../_images/05_MembranesAnnotator_autoLabel.png" style="width: 650px;" /></a>
</div>
<p>On the other hand, it’s recommendable to check that both parts of target 2 are of the same size. It can be easily done
with the button “Display Cursor” from panel “Size Thresholding” [6]. The result is that in this case both parts are of
the same size, which means that most of the whole changing shape through the slices was very well segmented.</p>
</div>
<div class="section" id="manual-annotation-of-the-target-1">
<span id="id4"></span><h3><a class="toc-backref" href="#id19">Manual annotation of the target 1</a><a class="headerlink" href="#manual-annotation-of-the-target-1" title="Permalink to this headline">¶</a></h3>
<p>The first target membrane has been detected in two unconnected parts of different sizes (colors), as shown below (the
size is shown in the index label of the tooltip. The background size will be always 0). It can be observed that target
3 has different size, so it’s not connected to the orange part of target 1 and that the blue part of target one can be
annotated with the same label as the orange one to get the full membrane annotated.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target1_1.png"><img alt="Membrane Annotator target 1 sizes" src="../../../_images/05_MembranesAnnotator_target1_1.png" style="width: 650px;" /></a>
</div>
<p>The procedure followed to check the sizes was:</p>
<ol class="arabic simple">
<li>Click on the magnifier with a cross icon from “Tools shortcuts” [1].</li>
</ol>
<p>2. Create a zoom window clicking and dragging around the target 1 vesicle to zoom in. When the zoom mode is active, it
can be smoothly controlled with the mouse wheel.</p>
<p>3. Click on button “Display Cursor” from panel “Size Threshold” [6] and click on the structure whose size is desired to
be displayed. To fine tune the position of the cursor, use the arrow keys from the keyboard.
Note: to generate multiple tooltips, right click on the current tooltip and select option “Create New Data Tip” or
directly press shift + left click.</p>
<ol class="arabic simple" start="4">
<li>To finish the cursor mode, click on the same button pressed to activate it, but now called “Stop Cursor”.</li>
</ol>
<p>Let’s annotate now the orange part of target one with label 1 (Use the zoom in tool if necessary, as explained before):</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target1_2.png"><img alt="Membrane Annotator target 1 annotation" src="../../../_images/05_MembranesAnnotator_target1_2.png" style="width: 650px;" /></a>
</div>
<ol class="arabic simple">
<li>Click on button “Display Cursor” from panel “Set Material” [7].</li>
</ol>
<p>2. Click on the membrane and, before clicking on the same button (now named “Change Lbl.”), be sure that the clicked
pixel belongs to a structure (index must be grater than 0).</p>
<p>3. Leave the textbox “Label” value as 1. If we we annotating the target 2 o target 3 vesicles, this value should have
to be set to 2 or 3, respectively.</p>
<p>4. Finally, click on the button “Change Lbl.” to annotate that part of target 1 vesicle with label 1. This action will
display automatically the view “Material” from the panel “View” [4], as can be observed in the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target1_3.png"><img alt="Membrane Annotator target 1 material view part" src="../../../_images/05_MembranesAnnotator_target1_3.png" style="width: 650px;" /></a>
</div>
<p>If we repeat this procedure with the blue part of target 1 vesicle (annotatin it with label 1), the result should look
like as shown in the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target1_4.png"><img alt="Membrane Annotator target 1 material view full" src="../../../_images/05_MembranesAnnotator_target1_4.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="manual-annotation-of-the-target-2">
<h3><a class="toc-backref" href="#id20">Manual annotation of the target 2</a><a class="headerlink" href="#manual-annotation-of-the-target-2" title="Permalink to this headline">¶</a></h3>
<p>Proceeding the same as explain in section <a class="reference internal" href="#manual-annotation-of-the-target-1">Manual annotation of the target 1</a>, it can be observed that the target has
been detected in two different parts (upper part, with a size of 111171 voxels and lower part, of size 10330 voxels),
just the same as what happened with target 1. Moreover, the inner small vesicle and the top left structure are
disconnected from target 2, because they have different sizes (see figure below).</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target2_1.png"><img alt="Membrane Annotator target 2 sizes" src="../../../_images/05_MembranesAnnotator_target2_1.png" style="width: 650px;" /></a>
</div>
<p>Hence, we can proceed to the manual annotation, this time with label 2. The final result of the target 2 vesicle
annotation is shown in the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target2_2.png"><img alt="Membrane Annotator target 2 material view full" src="../../../_images/05_MembranesAnnotator_target2_2.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="manual-annotation-of-the-target-3">
<h3><a class="toc-backref" href="#id21">Manual annotation of the target 3</a><a class="headerlink" href="#manual-annotation-of-the-target-3" title="Permalink to this headline">¶</a></h3>
<p>This is the easiest one, identified as a continuous structure. So we can directly annotate it with label 3. The result
of the three membranes annotated can be observed in the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_target3.png"><img alt="Membrane Annotator target 3 material view full" src="../../../_images/05_MembranesAnnotator_target3.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="save-the-annotated-vesicles-and-finish-the-interactive-annotation-protocol">
<h3><a class="toc-backref" href="#id22">Save the annotated vesicles and finish the interactive annotation protocol</a><a class="headerlink" href="#save-the-annotated-vesicles-and-finish-the-interactive-annotation-protocol" title="Permalink to this headline">¶</a></h3>
<p>To successfully save the results of the annotation, follow the steps enumerated below:</p>
<ol class="arabic simple">
<li>Click on button “Save Materials” from panel Results [8].</li>
<li>If everything goes fine, the first line of the “Log Panel” [9], should be “Materials were correctly saved”.</li>
</ol>
<p>3. Close Membrane Annotator and check that the status of the tomogram listed in the auxiliary window has been updated
to “DONE”. Finally, close the auxiliary window.</p>
<p>4. The protocol box should have now update its state to inactive. If not, refresh the project interface (refresh icon
is located at the top right corner of the project panel).</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_saveResults.png"><img alt="Membrane Annotator save results and exit" src="../../../_images/05_MembranesAnnotator_saveResults.png" style="width: 400px;" /></a>
</div>
</div>
<div class="section" id="analyze-the-annotated-membranes">
<h3><a class="toc-backref" href="#id23">Analyze the annotated membranes</a><a class="headerlink" href="#analyze-the-annotated-membranes" title="Permalink to this headline">¶</a></h3>
<p>If we click on button “Analyze Results” in the lower panel of the project interface, the 3D visualization tool from
plugin scipion-em-tomoviz is launched. It allows the user to observe the membranes annotated placed on the full tomogram
or by slices, as shown in the figure below.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/05_MembranesAnnotator_tomo3dviewer.png"><img alt="Membrane Annotator results with tomoviz" src="../../../_images/05_MembranesAnnotator_tomo3dviewer.png" style="width: 1000px;" /></a>
</div>
</div>
</div>
<div class="section" id="resize-the-tomomasks-segmentations">
<h2><a class="toc-backref" href="#id24">Resize the tomomasks (segmentations)</a><a class="headerlink" href="#resize-the-tomomasks-segmentations" title="Permalink to this headline">¶</a></h2>
<p>After having carried out the segmentation and annotation of the vesicles in a smaller size to improve both performance
and contrast (explained in section <a class="reference internal" href="#tomogram-normalization">Tomogram normalization</a>), the segmented and annotated data must be resied to its
previous size for the picking of the membrane particles (smaller sampling rate will make the picking algorithms easier
and even possible to find the desired densities). This operation will be carried out with protocol “Resize segmented or
annotated volume” from plugin scipion-em-tomosegmemtv. The tomomasks desired to be resized and the tomograms to which
they have to be referred and resized to their size are the arguments required to be filled. Select the pointer to the
annotation protocol output for the first and the pointer to the imported tomogram for the second.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/06_resize_tomoMasks.png"><img alt="Resize tomomasks protocol" src="../../../_images/06_resize_tomoMasks.png" style="width: 500px;" /></a>
</div>
<p>We’re referring the tomomasks to the imported tomograms and not to the denoised ones to carry out the picking procedure
with the less processed data as possible, for two main reasons:</p>
<p>1. PySeg graphs calculations expect the data not to be filtered, so it will provide the best result with unfiltered
(e. g. not denoised) data.</p>
<p>2. Avoid all the interpolations and mathematical treatment of the data at the pint of identifying small structures,
increasing the probabilities of the picked objects to be a physical entity instead of a mathematical artifact,</p>
<p><em>SUMMARY:</em></p>
<p>At this point we have the membranes segmented, annotated, at the correct size and referred to the imported tomograms.
Thus, we’re ready for the picking.</p>
</div>
<div class="section" id="directional-picking-with-pyseg">
<h2><a class="toc-backref" href="#id25">Directional picking with PySeg</a><a class="headerlink" href="#directional-picking-with-pyseg" title="Permalink to this headline">¶</a></h2>
<p>As it was explained in <a class="reference external" href="https://docs.google.com/presentation/d/1zFArx9GuIN20EZ_uK2OsIzDpae61ryn9x3eColO5n3k/edit?usp=sharing">PySeg presentation</a>, the directional picking is composed by four main steps (assuming that the
segmentation and annotation of the membranes have been performed before):</p>
<ol class="arabic simple">
<li>Preseg: segment membranes into membranes, inner surroundings and outer surroundings</li>
<li>Graphs: analyze a GraphMCF (Mean Cumulative Function) from a segmented membrane. A graph is a set of connected nodes.</li>
</ol>
<p>3. Fils: filter a MbGraphMCF object by extracting a filament network. A filament represent to nodes connected (only the
first and last nodes, without intermediate elements).</p>
<ol class="arabic simple" start="4">
<li>Picking: extract particles from a filament network of a oriented single membrane graph.</li>
</ol>
<p>Each of these steps is represented with a different protocol inside Scipion, and they will be explained in the following
subsections.</p>
<div class="section" id="preseg">
<span id="preseg-protocol"></span><h3><a class="toc-backref" href="#id26">Preseg</a><a class="headerlink" href="#preseg" title="Permalink to this headline">¶</a></h3>
<p>Look for pyseg protocol and open it. At first sight, it’s remarkable that this protocol allows the user to get the
previous segmented and annotated data from Scipion (Scipion Protocol) or from outside (e. g., using the standalone
version of the membrane annotation tool and preparing a star file with the data as expected by the preseg.) Said that,
let’s replace the following parameter default values by the ones required for this tutorial:</p>
<p>1. On parameter “Segmented and annotated tomograms”, select the pointer which corresponds to the output of the resizing
protocol applied before.</p>
<p>2. Update value of parameter “Offset volxels” to <em>44</em> voxels. This parameter represents the width of a margin considered
when cropping the vesicles. It’s necessary to provide a value which ensures that the desired biological entities, e. g.
membrane proteins, are included in the cropped area.</p>
<p>3. Update “Segmented membrane thickness” to <em>60</em> angstroms. Value introduced will be divided by 2 internally to get the
semi-width of the membrane, which which will be considered at both sides of the membrane central line.</p>
<p>4. On parameter “Segmented membrane neighbours”, type value <em>330</em> angstroms. This parameter represents the thickness
around the membrane to represent the in-membrane and out-membrane surroundings desired to be included in the analysis.
The value chose was 330 angstroms because the size of a ribosome varies from 200 to 300 angstroms in diameter, and a
margin of the 10% of error is considered for the biggest size (that additional 30 angstroms).</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/07_preseg.png"><img alt="Preseg protocol" src="../../../_images/07_preseg.png" style="width: 500px;" /></a>
</div>
<p>If the results are displayed with the viewer DataViewer from xmipp (right click in the output element shown in the
object lower panel, in tab “Summary”.), they should look like as can be observed in the left side of the figure below,
which represents the area segmentation of the central slice of each vesicle. The right side and the numbers are used to
visually relate each segmentation to the <a class="reference internal" href="#target-vesicles">target vesicles</a> they represent.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/07_res_preseg_01.png"><img alt="Preseg results" src="../../../_images/07_res_preseg_01.png" style="width: 800px;" /></a>
</div>
<p>For a better understanding of the parameters introduced in this protocol, the figure below shows the thickness of the
membrane, the inner surroundings and the outer surroundings and their conversion to angstroms considering the sampling
rate, which is 13.68 Å/voxel. The graph shown is the result of tracing a profile on one of the slices of target vesicle
3. This was done also inside Scipion, using the tools included in the viewer DataViewer from xmipp.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/07_res_preseg_02.png"><img alt="Preseg profiling" src="../../../_images/07_res_preseg_02.png" style="width: 800px;" /></a>
</div>
</div>
<div class="section" id="graphs">
<span id="graphs-protocol"></span><h3><a class="toc-backref" href="#id27">Graphs</a><a class="headerlink" href="#graphs" title="Permalink to this headline">¶</a></h3>
<p>At this point, it’s time to calculate the graphs: look for the protocol, open it and update the parameter values as
enumerated below:</p>
<ol class="arabic simple">
<li>Set parameter “Threads” to <em>3</em>.</li>
<li>Set parameter “Pre-segmentation” pointer to the preseg protocol executed before.</li>
</ol>
<p>3. Update parameter “Sigma for gaussian filtering” to <em>2</em>. It allows to smooth small and irrelevant features and
increases the signal noise ratio (SNR). Higher values will provide less dense graphs (lower execution time), so they
should be used when picking large particles, like ribosomes.</p>
<p>4. Parameter “Maximum distance to membrane” can be set in two different ways, which are introducing manually the desired
value or clicking on the wizard (wand) icon. This action will read the value of parameter parameter “Segmented membrane
neighbours” from the preseg protocol selected in parameter “Pre-segmentation”. That value should be <em>330</em> angstroms.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/08_graphs.png"><img alt="Graphs protocol" src="../../../_images/08_graphs.png" style="width: 500px;" /></a>
</div>
<p>Results can be displayed by clicking on button “Analyze Results”. That action will allow us to select which vesicle is
desired to be represented with 3D viewer from plugin scipion-em-tomoviz setting the coloring option “Color Graph By”,
located on the top left corner, to value “mb_eu_dst”, which colors the graphs considering the euclidean distance to the
membrane. Results should look like shown in the figure below. Observe that the numbers correspond to the
<a class="reference internal" href="#target-vesicles">target vesicles</a> which is being used in this tutorial from the
annotation step.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/08_res_graphs.png"><img alt="Graphs results" src="../../../_images/08_res_graphs.png" style="width: 1000px;" /></a>
</div>
</div>
<div class="section" id="fils">
<span id="fils-protocol"></span><h3><a class="toc-backref" href="#id28">Fils</a><a class="headerlink" href="#fils" title="Permalink to this headline">¶</a></h3>
<p>Once the graphs have been calculated, it’s time to refine them. This is the aim of the fils protocol. This is a good
moment to go back to the <a class="reference external" href="https://docs.google.com/presentation/d/1zFArx9GuIN20EZ_uK2OsIzDpae61ryn9x3eColO5n3k/edit?usp=sharing">PySeg presentation</a> and refresh the concepts of euclidean and geodesic distances and
sinuosity. Apart from that, the protocol labels were written with the objetive of providing an approximate idea of what
these concepts means.</p>
<p>Now, let’s open the fils protocol and set the following parameters as explained below:</p>
<ol class="arabic simple">
<li>Input tab: set the parameter “Graphs” pointer to the graphs protocol executed before.</li>
</ol>
<p>2. Sources tab: used to define geometrically how the filaments should be in the area selected as source area. Observe
that the source filament area is the membrane. Because the ribosomes doesn’t go through the membrane, the geometrical
descriptors on this area won’t make a difference in the obtained result. Hence, let all the parameter with the default
values. Targets tab: it’s the same as the sources tab, but for the area chosen as target area:</p>
<blockquote>
<div><p>2.1 Set the parameter “Filament area” to “Outer Surroundings”. This is the area of interest for picking the membrane
ribosomes.</p>
<p>2.2 For the euclidean distance, set the minimum value to <em>0</em> nm and the maximum to <em>30</em> nm, which is the largest size
expected for the ribosomes we’re trying to pick.</p>
<p>2.3 For the geodesic distance, set the minimum value to <em>0</em> nm and the maximum value to <em>60</em> nm. That way, we’re
considering some flexibility in the filaments.</p>
<p>2.4 For the sinuosity, set the minimum value to <em>0</em> and the maximum to <em>2</em>. The recommended value for this parameter is
the ratio geodesicLength/euclideanLength, but it doesn’t have to. Sinuosity specified in a value of distances or
lengths contained in the intervals set before for euclidean distance and geodesic length, respectively.</p>
</div></blockquote>
<p>3. Refinement tab: it’s used to apply a geometric filter to refine the calculated filaments. They must be introduced in
ranges [min max]. In our case, considering the type and and features of the target particles, set them as follows:</p>
<blockquote>
<div><p>3.1 Euclidean distance range: from <em>20</em> to <em>30</em> nm, which is the expected range of a ribosome size variation,
approximately.</p>
<p>3.2 Geodesic distance range: from <em>20</em> to <em>60</em> nm, which goes from the shortest straight length to a maximum value
considering some flexibility.</p>
<p>3.3 Sinuosity range: from <em>0</em> to <em>2</em>. Thus, we’re considering all the flexibility values present considering the
euclidean and geodesic values provided before.</p>
</div></blockquote>
<p><em>Note:</em> the lengths are delimited by the thickness of each area generated in the <a class="reference internal" href="#preseg-protocol">preseg protocol</a>.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/09_fils.png"><img alt="Fils protocol" src="../../../_images/09_fils.png" style="width: 1000px;" /></a>
</div>
<p>The resulting filaments should look like in the figure below. The same considerations as in the <a class="reference internal" href="#graphs-protocol">graphs protocol</a>
results have been followed.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/09_res_fils.png"><img alt="Fils results" src="../../../_images/09_res_fils.png" style="width: 1000px;" /></a>
</div>
</div>
<div class="section" id="picking">
<span id="picking-protocol"></span><h3><a class="toc-backref" href="#id29">Picking</a><a class="headerlink" href="#picking" title="Permalink to this headline">¶</a></h3>
<p>Finally, to get the particles picked, let’s open the picking protocol and set the following parameters as follows:</p>
<p>1. Input tab: we have to select which filaments protocols to use and which set of tomograms must be the coordinates
referred to. In our case, we only have the previous fils protocol execution, and the coordinates should be picked on
the original tomogram, following the same as raw data as possible reasoning as before to avoid possible mathematical
artifacts.</p>
<ol class="arabic" start="2">
<li><p class="first">Picking tab:</p>
<blockquote>
<div><p>2.1 Set the parameter “Segmentation area for picking” to “Outer surroundings”, where the ribosomes are located.</p>
<p>2.2 Set parameter “Find on two surfaces” to “Projected local minima”. This parameter is used to indicate if we want
to keep the coordinates of the cutting point of the filament with the membrane or the cutting point and the
projections of the filament over the membrane, respectively. The second option will result in an over-picking. This
can be a good strategy in order to ensure that no particles are lost when picking, but some kind of distance or
angular filtering should be applied later to remove the duplicates.</p>
</div></blockquote>
</li>
</ol>
<p>3. Refinement tab: this tab allows the user to refine the picking results by specifying the density level or the minimum
distance between the picked coordinates. Let this tab with the default values. We’ll deal with the over-picking later.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/10_picking.png"><img alt="Picking protocol" src="../../../_images/10_picking.png" style="width: 1000px;" /></a>
</div>
<p>It can be observed in the summary tab of the lower panel on the project interface that <em>2339</em> particles were picked.
For the moment, let’s ignore the box size displayed there, which is a default value required for some viewers to be
different from zero.</p>
<p>Results can be displayed with multiple viewers, like the one from plugin scipion-em-emantomo but, following the same
structure considered to show the results on the <a class="reference internal" href="#graphs-protocol">graphs protocol</a> and <a class="reference internal" href="#fils-protocol">fils protocol</a>, we’ll use the viewer from
plugin scipion-em-tomoviz:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/10_res_picking.png"><img alt="Picking results" src="../../../_images/10_res_picking.png" style="width: 1000px;" /></a>
</div>
</div>
</div>
<div class="section" id="picking-post-processing">
<h2><a class="toc-backref" href="#id30">Picking post processing</a><a class="headerlink" href="#picking-post-processing" title="Permalink to this headline">¶</a></h2>
<p>This section contains the steps suggested to resolve the over-picking scenario described in <a class="reference internal" href="#picking-protocol">picking protocol</a> and also
to get rid of bad picked elements. For the first one, we’ll use the protocol “remove duplicates” and for the second, the
protocol “filter by normal”, both from plugin scipion-em-tomoviz.</p>
<div class="section" id="remove-duplicates">
<h3><a class="toc-backref" href="#id31">Remove duplicates</a><a class="headerlink" href="#remove-duplicates" title="Permalink to this headline">¶</a></h3>
<p>Using this protocol, the over-picked particles will be replaced by the mean position and orientation of them. Hence,
let’s open the protocol, select the pointer to the coordinates picked before and let the radius value with the default
value of <em>10</em> voxels. This is only a coincidence, considering half of the size of the biggest ribosome and the sampling
rate of our data (150Å / 13.60 Å/voxel ~ 11 voxel).</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/11_remove_duplicates.png"><img alt="Remove duplicates protocol" src="../../../_images/11_remove_duplicates.png" style="width: 500px;" /></a>
</div>
<p>Again, on the summary tab of the lower panel on the project interface, it can be observed that we have now <em>641</em>
particles after having removed the duplicates. As before, using the viewer from plugin scipion-em-protocol, the result
should look like this:</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/11_res_remove_duplicates.png"><img alt="Remove duplicates results" src="../../../_images/11_res_remove_duplicates.png" style="width: 750px;" /></a>
</div>
</div>
<div class="section" id="filter-by-normal">
<h3><a class="toc-backref" href="#id32">Filter by normal</a><a class="headerlink" href="#filter-by-normal" title="Permalink to this headline">¶</a></h3>
<p>Let’s continue cleaning the data. Protocol “filter by normal” takes the vesicles and the particles and filters them by
different criteria related with the normal direction. If the user has a set of coordinates with orientation but not the
surfaces or meshes corresponding to the membranes or vesicles which are the reference for the orientation, these
surfaces can be created from the orientated coordinates by using the protocol “fit vesicles” from plugin
scipion-em-xmipptomo plugin. Hence, let’s generate the meshes required to use to use the filter by normal.</p>
<p>Protocol “fit vesicles” only requires two inputs, which are the pointers to the resulting set of coordinates after
having removed the duplicates and the tomograms from which the input coordinates come. Finally, click on button
“Execute” and the set of meshes will be generated.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/12_fit_vesicles.png"><img alt="Fit vesicles protocol" src="../../../_images/12_fit_vesicles.png" style="width: 500px;" /></a>
</div>
<p>At this point, we are ready to use the filter by normal, so let’s open it and follow these steps:</p>
<ol class="arabic simple">
<li>Set the input coordinates pointer to the coordinates obtained after having removed the duplicates.</li>
<li>Set the vesicles pointer to the set of meshes generated before with the protocol “fit vesicles”.</li>
<li>Update the parameter “Tolerance in degrees” to “30”.</li>
</ol>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/12_filter_by_normal.png"><img alt="Filter by normal protocol" src="../../../_images/12_filter_by_normal.png" style="width: 500px;" /></a>
</div>
<p>After executing it, we should have <em>285</em> items.</p>
</div>
</div>
<div class="section" id="subtomogram-extraction">
<h2><a class="toc-backref" href="#id33">Subtomogram extraction</a><a class="headerlink" href="#subtomogram-extraction" title="Permalink to this headline">¶</a></h2>
<p>This operation consists on cropping out particles with a specified box size in order to get them separately and with
the surroundings to perform the subtomogram averaging. We’ll carry it out using the protocol “extraction from tomogram”
from plugin scipion-em-emantomo. Let’s open it and set the parameters as listed below:</p>
<ol class="arabic">
<li><p class="first">Input tab:</p>
<blockquote>
<div><p>1.1 Set the input coordinates pointer to the coordinates generated after having filtered by normal.</p>
<p>1.2 Set the parameter “Tomogram source” to “other” to manually specify the tomogram from where the particles were
picked.</p>
<p>1.3 Set the pointer of the input tomograms to the imported tomograms (remember, as raw data as possible).</p>
<p>1.4 The box size is quite critical. Let’s ignore the wizard considering that PySeg considers the coordinates from the
membrane, so the box size introduced to ensure that the whole particle is contained in the cropped subvolume must be
approximately the double of the particle largest expected size, which is 300 Å. Thus, in voxels it should be around
600Å / 13.68Å/voxel ~ <em>44</em> voxel.</p>
</div></blockquote>
</li>
<li><p class="first">Preprocess tab:</p>
<blockquote>
<div><p>2.1 Set tha parameter “Invert contrast” to “Yes” to get, on our case a white over black representation.</p>
</div></blockquote>
</li>
</ol>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/13_extract_particles.png"><img alt="Extract particles protocol" src="../../../_images/13_extract_particles.png" style="width: 800px;" /></a>
</div>
</div>
<div class="section" id="d-classification">
<h2><a class="toc-backref" href="#id34">2D classification</a><a class="headerlink" href="#d-classification" title="Permalink to this headline">¶</a></h2>
<p>With the particles extracted, we’re almost ready to carry out a 2D classification with a protocol of the same name from
plugin scipion-em-pyseg. This 2D classification is performed using a clustering algorithm of the rotational average of
each particle around the normal axis. But, before that, let’s deal with that ‘almost ready’. We’re not ready yet because
the classification protocol needs a mask which is applied to work on the regions of interest of the subtomograms. In
our case, the region of interest is the membrane and the ribosome.</p>
<p>We’ll generate the mask with protocol “create 3d mask” from plugin scipion-em-xmipp. Our mask will be a cylinder of
radius approximately half of the size of the biggest ribosome considered and with a height enough to cover the whole
ribosome, the membrane and a small amount of the inner surroundings. All these requirements together and the fact that
the mask will be referred to the center of the box (which means the vesicle), also suggest the need of some shifting
of the cylinder center.</p>
<p>Now, let’s open the protocol and set the following values in the parameters listed below:</p>
<ol class="arabic simple">
<li>Set the parameter “Mask source” to “Geometry”.</li>
<li>Set “Sampling rate” to <em>13.68</em> Å/px to make the mask be at the same sampling rate of our data.</li>
</ol>
<p>3. Set “Mask size” to <em>44</em> px, because it has to be of the same box size as our subtomograms (44 is the value we
introduced as box size ehrn extracting the particles with scipion-em-emantomo).</p>
<ol class="arabic simple" start="4">
<li>Select “Cylinder” from “Mask type”.</li>
</ol>
<p>5. Set “Radius” to 150Å / 13.68Å/px ~ 11 (+ 1 leaving some margin to ensure the particle is completely contained in the
mask). Thus, the radius will be set to <em>12</em> px.</p>
<ol class="arabic simple" start="6">
<li>Set the parameter “Shift center of the mask” to “Yes”.</li>
</ol>
<p>7. Set the Z component of the parameter “Shit Center” to <em>6</em> px, which is about 6px * 13.68Å/px ~ 82Å, which is
approximately 60Å (remember <a class="reference internal" href="#preseg-protocol">preseg protocol</a>) of the membrane thickness and 20Å of the inner surroundings.</p>
<p>8. Set the parameter “Height” to <em>30</em> px. This value was estimated as 300Å (ribosome largest size) + 60Å (membrane
thickness considered) + 20Å (inner surrounding considered), which is 380Å / 13.68Å/px ~ 28px which will be considered
30 to leave a small margin.</p>
<p>9. In the tab “Postprocessing” with the default values, set the parameter “Smooth borders” to “Yes” and “Gaussian sigma”
to <em>2</em> px. This smoothing is very useful to minimize border effects.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/14_create_3d_mask.png"><img alt="Create 3D mask protocol" src="../../../_images/14_create_3d_mask.png" style="width: 800px;" /></a>
</div>
<p>The obtained mask, displayed in Y positive view with viewer DataViewer from xmipp, should look like shown in the figure
below. To change the view, click on the colored cube ico on the top toolbar.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/14_res_create_3d_mask.png"><img alt="Create 3D mask result" src="../../../_images/14_res_create_3d_mask.png" style="width: 650px;" /></a>
</div>
<p>Finally, we have all the elements required to perform the 2D classification. So let’s open the protocol and set the
values enumerated below:</p>
<ol class="arabic simple">
<li>Set the input subtomograms pointer to the ones extracted with scipion-em-emantomo after having filtered by normal.</li>
<li>Set the mask pointer to the mask generated before.</li>
<li>Set the Filter size to <em>2</em> voxels.</li>
</ol>
<p>Let all the rest of parameters with the default values. It’s remarkable that this protocol offers three different
clustering algorithm, each with its own parameter, which will be shown in the protocol form when a different algorithm
is selected. We’ve chosen Affinity Propagation (AP) for this tutorial due to its simplicity (number of clusters doesn’t
have to be specified like in other clustering algorithms), general applicability and performance.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/15_2d_classification.png"><img alt="2D classification protocol" src="../../../_images/15_2d_classification.png" style="width: 550px;" /></a>
</div>
<p>Once the protocol execution is finished, let’s right click on the outputClasses object located in the lower panel of the
project interface, in the tab “Summary”. Then select the option “Open with TomoDataViewer” and the classes obtained will
be displayed with xmipp’s viewer. On the top toolbar, set the size (besides the magnifier icon) to 650 and press Intro.
The 2 classes obtained are represented as the rotational average around the normal axis, as can be observed on the left
side of the figure below. It seems quite clear that our ribosome is on class 1, and it’s composed of 99 particles,
while the other class only shows the membrane. Thus, will use the subset functionality provided by this viewer to create
a subset only composed of the particles which belong to class 1:</p>
<ol class="arabic simple">
<li>Select the row corresponding to class 1.</li>
<li>Click on the button “+ Particles”.</li>
<li>On the auxiliary window generated, choose a name for the subset. In our case it will be <em>class1</em>.:align:</li>
<li>Click on the button “Ok” and the subset will be automatically generated.</li>
</ol>
<p>At this point, the viewer can be closed.</p>
<div class="figure">
<a class="reference internal image-reference" href="../../../_images/15_res_2d_classification.png"><img alt="2D classification results" src="../../../_images/15_res_2d_classification.png" style="width: 1000px;" /></a>
</div>
<p><em>SUMMARY:</em></p>
<p>That was the last point of this tutorial. If we perform some subtomogram averaging (STA) steps membrane alignment,
particle alignment and subtomogram reconstruction), we can obtain a structure for our ribosomes.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Scipion team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: release-3.0.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../gh-pages/index.html">gh-pages</a></dd>
            <dd><a href="../../../release-2.0.0/index.html">release-2.0.0</a></dd>
            <dd><a href="../../../release-3.0.0/docs/user/denoising_mbSegmentation_pysegDirPicking/tomosegmemTV-pySeg-workflow.html">release-3.0.0</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>